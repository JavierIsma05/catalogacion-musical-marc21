{% extends 'catalogo_publico/base_publico.html' %}
{% load static %}

{% block title %}{{ obra }} - Catálogo Musical MARC21{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'catalogo_publico/css/resumen_obra.css' %}">

<style>
@font-face {
  font-family: 'Maestro';
  src: url("{% static 'catalogacion/fonts/Maestro.ttf' %}") format('truetype');
  font-weight: normal;
  font-style: normal;
}

.incipit-canvas-wrap {
  width: 100%;
  display: flex;
  justify-content: center;
  margin-top: 0rem;
  background: #fff;
  padding: 0.125rem;
  border-radius: 4px;
  border: 1px solid #e0e0e0;
}

.incipit-view-canvas {
  width: 100%;
  max-width: 500px;
  height: 150px;
  display: block;
  background: transparent;
  pointer-events: none;
  cursor: default;
}

.obra-incipit-card {
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 6px;
  padding: 0.375rem;
}

.obra-incipit-card .obra-card-label {
  font-weight: 600;
  color: #495057;
  margin-bottom: 0;

}
</style>
{% endblock %}

{% block content %}
<div class="container py-3">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-2">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{% url 'catalogo_publico:home' %}">
                    <i class="bi bi-house-door"></i>
                    Inicio
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'catalogo_publico:lista_obras' %}">
                    <i class="bi bi-collection"></i>
                    Catálogo
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">{{ obra.signatura_publica_display }}</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="detalle-header">
        <div class="detalle-header-left">
            <h1 class="detalle-main-title">Resumen de la obra</h1>
            <div class="detalle-actions">
                <a href="{% url 'catalogo_publico:lista_obras' %}" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-arrow-left"></i> Volver a la lista
                </a>
            </div>
        </div>
        <div class="detalle-header-right">
            <div class="detalle-meta-tag">
                <small>Signatura</small>
                <span>{{ obra.signatura_publica_display }}</span>
            </div>
            {% if obra.coleccion_publica_display %}
            <div class="detalle-meta-tag">
                <small>Colección</small>
                <span>{{ obra.coleccion_publica_display }}</span>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="row g-3 align-items-start">
        <div class="col-lg-9">
            <div class="resumen-unified-card">
                <!-- Lista simple de campos sin secciones -->

                <!-- Compositor -->
                {% if obra.compositor %}
                <div class="resumen-field">
                    <span class="resumen-field-label">Compositor</span>
                    <span class="resumen-field-value">
                        {{ obra.compositor.apellidos_nombres }}{% if obra.compositor.coordenadas_biograficas %} ({{ obra.compositor.coordenadas_biograficas }}){% endif %}{% if obra.autoria %} <em class="text-muted">[{{ obra.get_autoria_display|lower }}]</em>{% endif %}
                    </span>
                </div>
                {% endif %}

                <!-- Títulos -->
                {% if obra.titulo_uniforme %}
                    <!-- Si hay 130, solo se muestra este -->
                    <div class="resumen-field">
                        <span class="resumen-field-label">Título uniforme (punto de acceso principal)</span>
                        <span class="resumen-field-value">
                            {{ obra.titulo_uniforme }}{% if obra.medio_interpretacion_130 %}, {{ obra.get_medio_interpretacion_130_display }}{% endif %}{% if obra.tonalidad_130 %}, {{ obra.get_tonalidad_130_display }}{% endif %}{% if obra.nombre_parte_130 %}, {{ obra.nombre_parte_130 }}{% endif %}{% if obra.numero_parte_130 %}, {{ obra.numero_parte_130 }}{% endif %}{% if obra.forma_130 %}, {{ obra.forma_130 }}{% endif %}{% if obra.arreglo_130 %}, {{ obra.get_arreglo_130_display }}{% endif %}
                        </span>
                    </div>
                {% else %}
                    {% if obra.titulo_240 %}
                    <div class="resumen-field">
                        <span class="resumen-field-label">Título uniforme</span>
                        <span class="resumen-field-value">
                            {{ obra.titulo_240 }}{% if obra.medio_interpretacion_240 %}, {{ obra.get_medio_interpretacion_240_display }}{% endif %}{% if obra.tonalidad_240 %}, {{ obra.get_tonalidad_240_display }}{% endif %}{% if obra.nombre_parte_240 %}, {{ obra.nombre_parte_240 }}{% endif %}{% if obra.numero_parte_240 %}, {{ obra.numero_parte_240 }}{% endif %}{% if obra.forma_240 %}, {{ obra.forma_240 }}{% endif %}{% if obra.arreglo_240 %}, {{ obra.get_arreglo_240_display }}{% endif %}
                        </span>
                    </div>
                    {% endif %}
                    {% if obra.titulo_principal %}
                    <div class="resumen-field">
                        <span class="resumen-field-label">Título en fuente</span>
                        <span class="resumen-field-value">
                            {{ obra.titulo_principal }}{% if obra.subtitulo %} : {{ obra.subtitulo }}{% endif %}{% if obra.mencion_responsabilidad %} / {{ obra.mencion_responsabilidad }}{% endif %}
                        </span>
                    </div>
                    {% endif %}
                {% endif %}

                <!-- Producción -->
                <div class="resumen-field">
                    <span class="resumen-field-label">Manuscrito/Impreso</span>
                    <span class="resumen-field-value">{{ obra.tecnica_340_publica_display }}</span>
                </div>

                {% if obra.publicacion_publica_display != "Sin datos de publicación" %}
                <div class="resumen-field">
                    <span class="resumen-field-label">Producción de la obra</span>
                    <span class="resumen-field-value">{{ obra.publicacion_publica_display }}</span>
                </div>
                {% endif %}

                {% if obra.descripcion_fisica_publica_display != "Sin descripción física" %}
                <div class="resumen-field">
                    <span class="resumen-field-label">Descripción física</span>
                    <span class="resumen-field-value">{{ obra.descripcion_fisica_publica_display }}</span>
                </div>
                {% endif %}

                <!-- Datos musicales -->
                {% if obra.temas_publico_display != "Sin materias registradas" %}
                <div class="resumen-field">
                    <span class="resumen-field-label">Materia (Género/Forma)</span>
                    <span class="resumen-field-value">{{ obra.temas_publico_display }}</span>
                </div>
                {% endif %}

                {% with medios=obra.medios_interpretacion_resumen %}
                {% if medios.0 != "Sin medios registrados" %}
                <div class="resumen-field">
                    <span class="resumen-field-label">Medio de interpretación</span>
                    <span class="resumen-field-value">
                        {{ medios.0 }}{% if medios.1 %} <span class="text-muted">| Solista: {{ medios.1 }}</span>{% endif %}
                    </span>
                </div>
                {% endif %}
                {% endwith %}

                {% if obra.tonalidad_publica_display %}
                <div class="resumen-field">
                    <span class="resumen-field-label">Tonalidad</span>
                    <span class="resumen-field-value">{{ obra.tonalidad_publica_display }}</span>
                </div>
                {% endif %}

                <!-- Íncipit musical -->
                {% with primer_incipit=obra.incipits_musicales.first %}
                {% if primer_incipit and primer_incipit.paec_full %}
                <div class="resumen-field resumen-field-incipit">
                    <span class="resumen-field-label">Íncipit musical</span>
                    <div class="resumen-field-value">
                        <div class="incipit-info text-muted" style="font-size: 0.9em; margin-bottom: 0.5rem;">
                            {{ primer_incipit.numero_obra }}.{{ primer_incipit.numero_movimiento }}.{{ primer_incipit.numero_pasaje }}{% if primer_incipit.titulo_encabezamiento %}; {{ primer_incipit.titulo_encabezamiento }}{% endif %}{% if primer_incipit.voz_instrumento %}; {{ primer_incipit.voz_instrumento }}{% endif %}{% if primer_incipit.clave or primer_incipit.armadura or primer_incipit.tiempo %}; {% if primer_incipit.clave %}{{ primer_incipit.clave }}{% endif %}{% if primer_incipit.armadura %} {{ primer_incipit.armadura }}{% endif %}{% if primer_incipit.tiempo %} {{ primer_incipit.tiempo }}{% endif %}{% endif %}
                        </div>
                        <div class="incipit-canvas-container">
                            <script id="paec_json_{{ primer_incipit.pk }}" type="application/json">{{ primer_incipit.paec_full|safe }}</script>
                            <canvas
                                id="incipit_view_canvas_{{ primer_incipit.pk }}"
                                class="incipit-view-canvas"
                                width="500"
                                height="180"
                                data-paec-json-id="paec_json_{{ primer_incipit.pk }}">
                            </canvas>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endwith %}

                <!-- Nota general -->
                {% if obra.nota_general_resumen %}
                <div class="resumen-field">
                    <span class="resumen-field-label">Nota general</span>
                    <span class="resumen-field-value">{{ obra.nota_general_resumen }}</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-3">
            <div class="detalle-sidebar-card sticky-sidebar">
                <h5 class="detalle-sidebar-title">
                    <i class="bi bi-gear-fill"></i>
                    Acciones
                </h5>
                <div class="detalle-actions-grid mb-3">
                    <a href="{% url 'catalogo_publico:formato_marc21' pk=obra.pk %}" class="btn btn-outline-secondary btn-sm w-100">
                        <i class="bi bi-code-square"></i>
                        Ver formato MARC21
                    </a>
                    {% if has_pdf %}
                    <a href="{% url 'catalogo_publico:descargar_pdf' pk=obra.pk %}" class="btn btn-outline-secondary btn-sm w-100">
                        <i class="bi bi-download"></i>
                        Descargar documento
                    </a>
                    {% else %}
                    <button class="btn btn-outline-secondary btn-sm w-100" type="button" disabled title="Sin documento disponible">
                        <i class="bi bi-download"></i>
                        Descargar documento
                    </button>
                    {% endif %}
                    <a href="{% url 'catalogo_publico:detalle_obra' pk=obra.pk %}" class="btn btn-primary btn-sm w-100">
                        <i class="bi bi-eye"></i>
                        Ver más detalles
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
{{ block.super }}
<!-- Motor del canvas (legacy) -->
<script src="{% static 'catalogacion/js/incipitManager.js' %}"></script>

<!-- Inicializador global (nuevo) -->
<script src="{% static 'catalogacion/js/incipitInit.js' %}"></script>
{% endblock %}

{% endblock %}
