{% extends 'catalogo_publico/base_publico.html' %}
{% load static %}

{% block title %}Formato MARC21 - {{ obra.titulo_principal }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'catalogo_publico/css/resumen_obra.css' %}">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
    .marc-raw-container {
        background: var(--pro-white);
        border: 1px solid var(--pro-border);
        box-shadow: var(--pro-shadow);
        overflow: hidden;
    }
    
    .marc-raw-header {
        padding: 0.75rem 1rem;
        background: var(--pro-surface);
        border-bottom: 1px solid var(--pro-border-light);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .marc-raw-header h5 {
        margin: 0;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--pro-text-secondary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .marc-raw-header h5 i {
        color: var(--pro-accent);
        font-size: 0.875rem;
    }
    
    .marc-record-count {
        font-size: 0.6875rem;
        color: var(--pro-text-muted);
        background: var(--pro-white);
        padding: 0.25rem 0.5rem;
        border: 1px solid var(--pro-border);
        border-radius: 3px;
    }
    
    .marc-raw-body {
        padding: 1rem 1.25rem;
        font-family: 'IBM Plex Mono', 'JetBrains Mono', monospace;
        font-size: 0.8125rem;
        line-height: 1.75;
        color: var(--pro-text);
        background: var(--pro-white);
        overflow-x: auto;
    }
    
    .marc-line {
        white-space: pre-wrap;
        word-break: break-word;
        padding: 0.1875rem 0.5rem;
        margin: 0 -0.5rem;
        border-radius: 3px;
        transition: background-color 0.15s ease;
    }
    
    .marc-line:hover {
        background: var(--pro-surface);
    }
    
    /* === COLORES MARC21 === */
    .marc-tag {
        color: #0066cc;
        font-weight: 600;
        letter-spacing: 0.02em;
    }
    
    .marc-ind {
        color: #718096;
        font-weight: 400;
    }
    
    .marc-sf {
        color: #d35400;
        font-weight: 500;
    }
    
    .marc-val {
        color: #1a1d29;
        font-weight: 400;
    }
    
    .marc-fixed {
        color: #6c757d;
        letter-spacing: 0.05em;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-3">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-2">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{% url 'catalogo_publico:home' %}">
                    <i class="bi bi-house-door"></i>
                    Inicio
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'catalogo_publico:lista_obras' %}">
                    <i class="bi bi-collection"></i>
                    Catálogo
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'catalogo_publico:detalle' pk=obra.pk %}">
                    {{ obra.signatura_publica_display }}
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">Formato MARC21</li>
        </ol>
    </nav>

    <!-- Encabezado compacto -->
    <div class="resumen-header d-flex flex-column flex-lg-row align-items-lg-start justify-content-between gap-2 mb-3">
        <div>
            <h1 class="mt-2 mb-1" style="font-size: 1rem; text-transform: none;">Formato MARC21</h1>
            <div class="d-flex gap-2 mt-2">
                <a href="{% url 'catalogo_publico:detalle' pk=obra.pk %}" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-arrow-left"></i> Volver al resumen
                </a>
                <a href="{% url 'catalogo_publico:detalle_obra' pk=obra.pk %}" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-eye"></i> Vista detallada
                </a>
            </div>
        </div>
        <div class="resumen-top-tags">
            <div class="detalle-top-tag">
                <small>Signatura</small>
                <span>{{ obra.signatura_publica_display }}</span>
            </div>
            <div class="detalle-top-tag">
                <small>Número de control</small>
                <span>{{ obra.num_control }}</span>
            </div>
        </div>
    </div>

    <!-- Contenedor MARC crudo -->
    <div class="marc-raw-container">
        <div class="marc-raw-header">
            <h5><i class="bi bi-code-slash"></i> Registro MARC21</h5>
            <span class="marc-record-count">{{ obra.titulo_principal|truncatechars:50 }}</span>
        </div>
        <div class="marc-raw-body">
{# === LEADER Y CAMPOS DE CONTROL (00X) === #}
<div class="marc-line"><span class="marc-tag">=001</span>  <span class="marc-val">{{ obra.num_control }}</span></div>
<div class="marc-line"><span class="marc-tag">=003</span>  <span class="marc-val">{{ obra.centro_catalogador }}</span></div>
<div class="marc-line"><span class="marc-tag">=005</span>  <span class="marc-fixed">{{ obra.campo_005_marc }}</span></div>
<div class="marc-line"><span class="marc-tag">=008</span>  <span class="marc-fixed">{{ obra.campo_008_marc }}</span></div>

{# === CAMPOS DE IDENTIFICACIÓN (02X) === #}
{% if obra.isbn %}<div class="marc-line"><span class="marc-tag">=020</span>  <span class="marc-ind">##</span><span class="marc-sf">$a</span><span class="marc-val">{{ obra.isbn }}</span></div>{% endif %}
{% if obra.ismn %}<div class="marc-line"><span class="marc-tag">=024</span>  <span class="marc-ind">2#</span><span class="marc-sf">$a</span><span class="marc-val">{{ obra.ismn }}</span></div>{% endif %}
{% if obra.numero_editor %}<div class="marc-line"><span class="marc-tag">=028</span>  <span class="marc-ind">{{ obra.tipo_numero_028|default:"2" }}{{ obra.control_nota_028|default:"0" }}</span><span class="marc-sf">$a</span><span class="marc-val">{{ obra.numero_editor }}</span></div>{% endif %}

{# === CAMPO 031 - ÍNCIPIT MUSICAL === #}
{% for incipit in obra.incipits_musicales.all %}<div class="marc-line"><span class="marc-tag">=031</span>  <span class="marc-ind">##</span><span class="marc-sf">$a</span><span class="marc-val">{{ incipit.numero_obra }}</span><span class="marc-sf">$b</span><span class="marc-val">{{ incipit.numero_movimiento }}</span><span class="marc-sf">$c</span><span class="marc-val">{{ incipit.numero_pasaje }}</span>{% if incipit.titulo_encabezamiento %}<span class="marc-sf">$d</span><span class="marc-val">{{ incipit.titulo_encabezamiento }}</span>{% endif %}{% if incipit.personaje %}<span class="marc-sf">$e</span><span class="marc-val">{{ incipit.personaje }}</span>{% endif %}{% if incipit.clave %}<span class="marc-sf">$g</span><span class="marc-val">{{ incipit.clave }}</span>{% endif %}{% if incipit.voz_instrumento %}<span class="marc-sf">$m</span><span class="marc-val">{{ incipit.voz_instrumento }}</span>{% endif %}{% if incipit.armadura %}<span class="marc-sf">$n</span><span class="marc-val">{{ incipit.armadura }}</span>{% endif %}{% if incipit.tiempo %}<span class="marc-sf">$o</span><span class="marc-val">{{ incipit.tiempo }}</span>{% endif %}{% if incipit.notacion_musical %}<span class="marc-sf">$p</span><span class="marc-val">{{ incipit.notacion_musical }}</span>{% endif %}<span class="marc-sf">$2</span><span class="marc-val">pe</span></div>{% endfor %}

{# === CAMPOS DE CÓDIGO (04X) === #}
<div class="marc-line"><span class="marc-tag">=040</span>  <span class="marc-ind">##</span><span class="marc-sf">$a</span><span class="marc-val">{{ obra.centro_catalogador }}</span><span class="marc-sf">$b</span><span class="marc-val">spa</span><span class="marc-sf">$c</span><span class="marc-val">{{ obra.centro_catalogador }}</span></div>
{% for codigo in obra.codigos_lengua.all %}<div class="marc-line"><span class="marc-tag">=041</span>  <span class="marc-ind">{{ codigo.indicacion_traduccion }}{{ codigo.fuente_codigo }}</span>{% for idioma in codigo.idiomas.all %}<span class="marc-sf">$a</span><span class="marc-val">{{ idioma.codigo_idioma }}</span>{% endfor %}</div>{% endfor %}
{% if obra.codigos_pais_entidad.exists %}<div class="marc-line"><span class="marc-tag">=044</span>  <span class="marc-ind">##</span>{% for pais in obra.codigos_pais_entidad.all %}<span class="marc-sf">$a</span><span class="marc-val">{{ pais.codigo_pais }}</span>{% endfor %}</div>{% endif %}

{# === SIGNATURA LOCAL 092 === #}
{% if obra.signatura_completa %}<div class="marc-line"><span class="marc-tag">=092</span>  <span class="marc-ind">##</span><span class="marc-sf">$a</span><span class="marc-val">{{ obra.centro_catalogador }}</span><span class="marc-sf">$b</span><span class="marc-val">BLMP</span><span class="marc-sf">$c</span><span class="marc-val">{% with obra.codigos_pais_entidad.first as pais %}{{ pais.codigo_pais|default:"ec"|upper }}{% endwith %}</span><span class="marc-sf">$d</span><span class="marc-val">{% if obra.tipo_registro == 'd' %}Ms{% else %}Imp{% endif %}</span><span class="marc-sf">$0</span><span class="marc-val">{{ obra.num_control }}</span></div>{% endif %}

{# === CAMPOS 1XX - PUNTOS DE ACCESO PRINCIPALES === #}
{% if obra.compositor %}<div class="marc-line"><span class="marc-tag">=100</span>  <span class="marc-ind">1#</span><span class="marc-sf">$a</span><span class="marc-val">{{ obra.compositor.apellidos_nombres }}</span>{% if obra.compositor.coordenadas_biograficas %}<span class="marc-sf">$d</span><span class="marc-val">{{ obra.compositor.coordenadas_biograficas }}</span>{% endif %}{% if obra.termino_asociado %}<span class="marc-sf">$c</span><span class="marc-val">{{ obra.termino_asociado }}</span>{% endif %}{% for funcion in obra.funciones_compositor.all %}<span class="marc-sf">$e</span><span class="marc-val">{{ funcion.get_funcion_display }}</span>{% endfor %}{% if obra.autoria %}<span class="marc-sf">$j</span><span class="marc-val">{{ obra.get_autoria_display }}</span>{% endif %}</div>{% endif %}
{% if obra.titulo_uniforme and not obra.compositor %}<div class="marc-line"><span class="marc-tag">=130</span>  <span class="marc-ind">0#</span><span class="marc-sf">$a</span><span class="marc-val">{{ obra.titulo_uniforme }}</span>{% if obra.forma_130 %}<span class="marc-sf">$k</span><span class="marc-val">{{ obra.forma_130 }}</span>{% endif %}{% if obra.medio_interpretacion_130 %}<span class="marc-sf">$m</span><span class="marc-val">{{ obra.get_medio_interpretacion_130_display }}</span>{% endif %}{% if obra.numero_parte_130 %}<span class="marc-sf">$n</span><span class="marc-val">{{ obra.numero_parte_130 }}</span>{% endif %}{% if obra.arreglo_130 %}<span class="marc-sf">$o</span><span class="marc-val">{{ obra.get_arreglo_130_display }}</span>{% endif %}{% if obra.nombre_parte_130 %}<span class="marc-sf">$p</span><span class="marc-val">{{ obra.nombre_parte_130 }}</span>{% endif %}{% if obra.tonalidad_130 %}<span class="marc-sf">$r</span><span class="marc-val">{{ obra.get_tonalidad_130_display }}</span>{% endif %}</div>{% endif %}

{# === CAMPOS 2XX - TÍTULOS Y PUBLICACIÓN === #}
{% if obra.titulo_240 and obra.compositor %}<div class="marc-line"><span class="marc-tag">=240</span>  <span class="marc-ind">10</span><span class="marc-sf">$a</span><span class="marc-val">{{ obra.titulo_240 }}</span>{% if obra.forma_240 %}<span class="marc-sf">$k</span><span class="marc-val">{{ obra.forma_240 }}</span>{% endif %}{% if obra.medio_interpretacion_240 %}<span class="marc-sf">$m</span><span class="marc-val">{{ obra.get_medio_interpretacion_240_display }}</span>{% endif %}{% if obra.numero_parte_240 %}<span class="marc-sf">$n</span><span class="marc-val">{{ obra.numero_parte_240 }}</span>{% endif %}{% if obra.arreglo_240 %}<span class="marc-sf">$o</span><span class="marc-val">{{ obra.get_arreglo_240_display }}</span>{% endif %}{% if obra.nombre_parte_240 %}<span class="marc-sf">$p</span><span class="marc-val">{{ obra.nombre_parte_240 }}</span>{% endif %}{% if obra.tonalidad_240 %}<span class="marc-sf">$r</span><span class="marc-val">{{ obra.get_tonalidad_240_display }}</span>{% endif %}</div>{% endif %}
<div class="marc-line"><span class="marc-tag">=245</span>  <span class="marc-ind">{% if obra.compositor %}1{% else %}0{% endif %}0</span><span class="marc-sf">$a</span><span class="marc-val">{{ obra.titulo_principal }}</span>{% if obra.subtitulo %}<span class="marc-sf">$b</span><span class="marc-val">{{ obra.subtitulo }}</span>{% endif %}{% if obra.mencion_responsabilidad %}<span class="marc-sf">$c</span><span class="marc-val">{{ obra.mencion_responsabilidad }}</span>{% endif %}{% if obra.tipo_registro == 'd' %}<span class="marc-sf">$h</span><span class="marc-val">[música manuscrita]</span>{% elif obra.tipo_registro == 'c' %}<span class="marc-sf">$h</span><span class="marc-val">[música impresa]</span>{% endif %}</div>
{% for titulo_alt in obra.titulos_alternativos.all %}<div class="marc-line"><span class="marc-tag">=246</span>  <span class="marc-ind">1#</span>{% if titulo_alt.texto_visualizacion %}<span class="marc-sf">$i</span><span class="marc-val">{{ titulo_alt.texto_visualizacion }}</span>{% endif %}<span class="marc-sf">$a</span><span class="marc-val">{{ titulo_alt.titulo }}</span>{% if titulo_alt.resto_titulo %}<span class="marc-sf">$b</span><span class="marc-val">{{ titulo_alt.resto_titulo }}</span>{% endif %}</div>{% endfor %}
{% for edicion in obra.ediciones.all %}<div class="marc-line"><span class="marc-tag">=250</span>  <span class="marc-ind">##</span><span class="marc-sf">$a</span><span class="marc-val">{{ edicion.edicion }}</span></div>{% endfor %}
{% for prod in obra.producciones_publicaciones.all %}<div class="marc-line"><span class="marc-tag">=264</span>  <span class="marc-ind">#{{ prod.funcion }}</span>{% for lugar in prod.lugares.all %}<span class="marc-sf">$a</span><span class="marc-val">{{ lugar.lugar }}</span>{% endfor %}{% for entidad in prod.entidades.all %}<span class="marc-sf">$b</span><span class="marc-val">{{ entidad.nombre }}</span>{% endfor %}{% for fecha in prod.fechas.all %}<span class="marc-sf">$c</span><span class="marc-val">{{ fecha.fecha }}</span>{% endfor %}</div>{% endfor %}

{# === CAMPO 300 - DESCRIPCIÓN FÍSICA === #}
{% if obra.extension or obra.otras_caracteristicas or obra.dimension or obra.material_acompanante %}<div class="marc-line"><span class="marc-tag">=300</span>  <span class="marc-ind">##</span>{% if obra.extension %}<span class="marc-sf">$a</span><span class="marc-val">{{ obra.extension }}</span>{% endif %}{% if obra.otras_caracteristicas %}<span class="marc-sf">$b</span><span class="marc-val">{{ obra.otras_caracteristicas }}</span>{% endif %}{% if obra.dimension %}<span class="marc-sf">$c</span><span class="marc-val">{{ obra.dimension }}</span>{% endif %}{% if obra.material_acompanante %}<span class="marc-sf">$e</span><span class="marc-val">{{ obra.material_acompanante }}</span>{% endif %}</div>{% endif %}

{# === CAMPOS 3XX - CARACTERÍSTICAS TÉCNICAS === #}
{% if obra.ms_imp %}<div class="marc-line"><span class="marc-tag">=340</span>  <span class="marc-ind">##</span><span class="marc-sf">$d</span><span class="marc-val">{{ obra.get_ms_imp_display }}</span></div>{% endif %}
{% if obra.formato %}<div class="marc-line"><span class="marc-tag">=348</span>  <span class="marc-ind">##</span><span class="marc-sf">$a</span><span class="marc-val">{{ obra.get_formato_display }}</span></div>{% endif %}
{% for medio382 in obra.medios_interpretacion_382.all %}<div class="marc-line"><span class="marc-tag">=382</span>  <span class="marc-ind">##</span>{% for medio_a in medio382.medios.all %}<span class="marc-sf">$a</span><span class="marc-val">{{ medio_a.get_medio_display }}</span>{% endfor %}{% if medio382.solista %}<span class="marc-sf">$b</span><span class="marc-val">{{ medio382.solista }}</span>{% endif %}</div>{% endfor %}
{% if obra.numero_obra or obra.opus %}<div class="marc-line"><span class="marc-tag">=383</span>  <span class="marc-ind">##</span>{% if obra.numero_obra %}<span class="marc-sf">$a</span><span class="marc-val">{{ obra.numero_obra }}</span>{% endif %}{% if obra.opus %}<span class="marc-sf">$b</span><span class="marc-val">{{ obra.opus }}</span>{% endif %}</div>{% endif %}
{% if obra.tonalidad_384 %}<div class="marc-line"><span class="marc-tag">=384</span>  <span class="marc-ind">0#</span><span class="marc-sf">$a</span><span class="marc-val">{{ obra.get_tonalidad_384_display }}</span></div>{% endif %}

{# === CAMPOS 4XX - SERIES === #}
{% for serie in obra.menciones_serie.all %}<div class="marc-line"><span class="marc-tag">=490</span>  <span class="marc-ind">0#</span>{% for titulo in serie.titulos.all %}<span class="marc-sf">$a</span><span class="marc-val">{{ titulo.titulo_serie }}</span>{% endfor %}{% for volumen in serie.volumenes.all %}<span class="marc-sf">$v</span><span class="marc-val">{{ volumen.volumen }}</span>{% endfor %}</div>{% endfor %}

{# === CAMPOS 5XX - NOTAS === #}
{% for nota in obra.notas_generales_500.all %}<div class="marc-line"><span class="marc-tag">=500</span>  <span class="marc-ind">##</span><span class="marc-sf">$a</span><span class="marc-val">{{ nota.nota_general }}</span></div>{% endfor %}
{% for contenido in obra.contenidos_505.all %}<div class="marc-line"><span class="marc-tag">=505</span>  <span class="marc-ind">00</span><span class="marc-sf">$a</span><span class="marc-val">{{ contenido.contenido }}</span></div>{% endfor %}
{% for sumario in obra.sumarios_520.all %}<div class="marc-line"><span class="marc-tag">=520</span>  <span class="marc-ind">##</span><span class="marc-sf">$a</span><span class="marc-val">{{ sumario.sumario }}</span></div>{% endfor %}
{% with obra.datos_biograficos_545 as datos_bio %}{% if datos_bio %}<div class="marc-line"><span class="marc-tag">=545</span>  <span class="marc-ind">0#</span>{% if datos_bio.texto_biografico %}<span class="marc-sf">$a</span><span class="marc-val">{{ datos_bio.texto_biografico }}</span>{% endif %}{% if datos_bio.uri %}<span class="marc-sf">$u</span><span class="marc-val">{{ datos_bio.uri }}</span>{% endif %}</div>{% endif %}{% endwith %}

{# === CAMPOS 6XX - MATERIAS === #}
{% for materia in obra.materias_650.all %}<div class="marc-line"><span class="marc-tag">=650</span>  <span class="marc-ind">04</span><span class="marc-sf">$a</span><span class="marc-val">{{ materia.materia }}</span>{% for subdiv in materia.subdivisiones.all %}<span class="marc-sf">$x</span><span class="marc-val">{{ subdiv.subdivision }}</span>{% endfor %}</div>{% endfor %}
{% for genero in obra.materias_655.all %}<div class="marc-line"><span class="marc-tag">=655</span>  <span class="marc-ind">#4</span><span class="marc-sf">$a</span><span class="marc-val">{{ genero.materia }}</span>{% for subdiv in genero.subdivisiones.all %}<span class="marc-sf">$x</span><span class="marc-val">{{ subdiv.subdivision }}</span>{% endfor %}</div>{% endfor %}

{# === CAMPOS 7XX - PUNTOS DE ACCESO ADICIONALES === #}
{% for nombre in obra.nombres_relacionados_700.all %}<div class="marc-line"><span class="marc-tag">=700</span>  <span class="marc-ind">1#</span>{% if nombre.persona %}<span class="marc-sf">$a</span><span class="marc-val">{{ nombre.persona.apellidos_nombres }}</span>{% if nombre.persona.coordenadas_biograficas %}<span class="marc-sf">$d</span><span class="marc-val">{{ nombre.persona.coordenadas_biograficas }}</span>{% endif %}{% endif %}{% for termino in nombre.terminos_asociados.all %}<span class="marc-sf">$c</span><span class="marc-val">{{ termino.termino }}</span>{% endfor %}{% for funcion in nombre.funciones.all %}<span class="marc-sf">$e</span><span class="marc-val">{{ funcion.get_funcion_display }}</span>{% endfor %}{% if nombre.relacion %}<span class="marc-sf">$i</span><span class="marc-val">{{ nombre.relacion }}</span>{% endif %}{% if nombre.autoria %}<span class="marc-sf">$j</span><span class="marc-val">{{ nombre.get_autoria_display }}</span>{% endif %}{% if nombre.titulo_obra %}<span class="marc-sf">$t</span><span class="marc-val">{{ nombre.titulo_obra }}</span>{% endif %}</div>{% endfor %}
{% for entidad in obra.entidades_relacionadas_710.all %}<div class="marc-line"><span class="marc-tag">=710</span>  <span class="marc-ind">2#</span>{% if entidad.entidad %}<span class="marc-sf">$a</span><span class="marc-val">{{ entidad.entidad }}</span>{% endif %}{% if entidad.funcion %}<span class="marc-sf">$e</span><span class="marc-val">{{ entidad.get_funcion_display }}</span>{% endif %}</div>{% endfor %}
{% for enlace773 in obra.enlaces_documento_fuente_773.all %}<div class="marc-line"><span class="marc-tag">=773</span>  <span class="marc-ind">1#</span>{% if enlace773.encabezamiento_principal %}<span class="marc-sf">$a</span><span class="marc-val">{{ enlace773.encabezamiento_principal }}</span>{% endif %}{% if enlace773.titulo %}<span class="marc-sf">$t</span><span class="marc-val">{{ enlace773.titulo }}</span>{% endif %}{% for numctrl in enlace773.numeros_control.all %}<span class="marc-sf">$w</span><span class="marc-val">{{ numctrl }}</span>{% endfor %}</div>{% endfor %}
{% for enlace774 in obra.enlaces_unidades_774.all %}<div class="marc-line"><span class="marc-tag">=774</span>  <span class="marc-ind">1#</span>{% if enlace774.encabezamiento_principal %}<span class="marc-sf">$a</span><span class="marc-val">{{ enlace774.encabezamiento_principal }}</span>{% endif %}{% if enlace774.titulo %}<span class="marc-sf">$t</span><span class="marc-val">{{ enlace774.titulo }}</span>{% endif %}{% for numctrl in enlace774.numeros_control.all %}<span class="marc-sf">$w</span><span class="marc-val">{{ numctrl }}</span>{% endfor %}</div>{% endfor %}
{% for otra787 in obra.otras_relaciones_787.all %}<div class="marc-line"><span class="marc-tag">=787</span>  <span class="marc-ind">1#</span>{% if otra787.encabezamiento_principal %}<span class="marc-sf">$a</span><span class="marc-val">{{ otra787.encabezamiento_principal }}</span>{% endif %}{% if otra787.titulo %}<span class="marc-sf">$t</span><span class="marc-val">{{ otra787.titulo }}</span>{% endif %}{% for numctrl in otra787.numeros_control.all %}<span class="marc-sf">$w</span><span class="marc-val">{{ numctrl }}</span>{% endfor %}</div>{% endfor %}

{# === CAMPOS 8XX - UBICACIÓN Y DISPONIBILIDAD === #}
{% for ubicacion in obra.ubicaciones_852.all %}<div class="marc-line"><span class="marc-tag">=852</span>  <span class="marc-ind">##</span>{% if ubicacion.autoridad %}<span class="marc-sf">$a</span><span class="marc-val">{{ ubicacion.autoridad }}</span>{% elif ubicacion.codigo_o_nombre %}<span class="marc-sf">$a</span><span class="marc-val">{{ ubicacion.codigo_o_nombre }}</span>{% endif %}{% if ubicacion.signatura_original %}<span class="marc-sf">$h</span><span class="marc-val">{{ ubicacion.signatura_original }}</span>{% endif %}{% for estanteria in ubicacion.estanterias.all %}<span class="marc-sf">$c</span><span class="marc-val">{{ estanteria.estanteria }}</span>{% endfor %}</div>{% endfor %}
{% for disponible in obra.disponibles_856.all %}<div class="marc-line"><span class="marc-tag">=856</span>  <span class="marc-ind">4#</span>{% for url856 in disponible.urls_856.all %}<span class="marc-sf">$u</span><span class="marc-val">{{ url856.url }}</span>{% endfor %}{% for texto in disponible.textos_enlace_856.all %}<span class="marc-sf">$y</span><span class="marc-val">{{ texto.texto_enlace }}</span>{% endfor %}</div>{% endfor %}
        </div>
    </div>
</div>
{% endblock %}
