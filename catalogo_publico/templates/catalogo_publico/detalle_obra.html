{% extends 'catalogo_publico/base_publico.html' %}
{% load static %}

{% block title %}{{ obra }} - Vista Detallada - Catálogo Musical MARC21{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'catalogo_publico/css/detalle_obra.css' %}">

<style>
@font-face {
  font-family: 'Maestro';
  src: url("{% static 'catalogacion/fonts/Maestro.ttf' %}") format('truetype');
  font-weight: normal;
  font-style: normal;
}

.incipit-view-canvas {
  width: 100%;
  max-width: 500px;
  height: 150px;      /* balance entre compacto y legible */
  display: block;
  background: transparent;
  pointer-events: none;
  cursor: default;
}
</style>
{% endblock %}

{% block content %}
<div class="container py-3">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-2">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{% url 'catalogo_publico:home' %}">
                    <i class="bi bi-house-door"></i> Inicio
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'catalogo_publico:lista_obras' %}">
                    <i class="bi bi-collection"></i> Catálogo
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'catalogo_publico:detalle' obra.pk %}">

                    {{ obra.signatura_publica_display }}
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">Vista detallada</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="detalle-header">
        <div class="detalle-header-left">
            <h1 class="detalle-main-title">Vista detallada</h1>
            <div class="detalle-actions">
                <a href="{% url 'catalogo_publico:detalle' pk=obra.pk %}" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-arrow-left"></i> Volver al resumen
                </a>
                <a href="{% url 'catalogo_publico:formato_marc21' pk=obra.pk %}" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-code-square"></i> Ver MARC21
                </a>
                <button class="btn btn-outline-primary btn-sm" disabled>
                    <i class="bi bi-download"></i> Descargar
                </button>
            </div>
        </div>
        <div class="detalle-header-right">
            <div class="detalle-meta-tag">
                <small>Signatura</small>
                <span>{{ obra.signatura_publica_display }}</span>
            </div>
            {% for ubicacion in obra.ubicaciones_852.all %}
            <div class="detalle-meta-tag">
                <small>Ubicación</small>
                <span>
                    {% if ubicacion.institucion_persona %}{{ ubicacion.institucion_persona }}{% endif %}
                    {% if ubicacion.signatura_original %}.{{ ubicacion.signatura_original }}{% endif %}
                </span>
            </div>
            {% empty %}
            <div class="detalle-meta-tag">
                <small>Ubicación</small>
                <span class="text-muted">Sin ubicación</span>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Contenido en 2 columnas -->
    <div class="detalle-content">
        <!-- Columna 1: Nombres y títulos -->
        <section class="detalle-section">
            <h2 class="detalle-section-title">
                <i class="bi bi-person-badge"></i> Nombres y títulos
            </h2>
            <div class="detalle-section-body">
                <div class="detalle-field">
                    <span class="detalle-field-label">Compositor</span>
                    <span class="detalle-field-value">
                        {{ obra.autor_publico_principal }}
                        {% if obra.autor_publico_nota %}<span class="detalle-field-note">({{ obra.autor_publico_nota }})</span>{% endif %}
                    </span>
                </div>

                {% if obra.titulo_uniforme_130_display %}
                <div class="detalle-field">
                    <span class="detalle-field-label">Título uniforme</span>
                    <span class="detalle-field-value">{{ obra.titulo_uniforme_130_display }}</span>
                </div>
                {% endif %}

                {% if obra.titulo_uniforme_240_display %}
                <div class="detalle-field">
                    <span class="detalle-field-label">Título uniforme</span>
                    <span class="detalle-field-value">{{ obra.titulo_uniforme_240_display }}</span>
                </div>
                {% endif %}

                <div class="detalle-field">
                    <span class="detalle-field-label">Título en fuente</span>
                    <span class="detalle-field-value">{{ obra.titulo_245_display }}</span>
                </div>

                {% for titulo_alt in obra.titulos_alternativos.all %}
                <div class="detalle-field">
                    <span class="detalle-field-label">Título alternativo</span>
                    <span class="detalle-field-value">
                        {% if titulo_alt.texto_visualizacion %}{{ titulo_alt.texto_visualizacion }}: {% endif %}
                        {{ titulo_alt.titulo }}
                        {% if titulo_alt.resto_titulo %} : {{ titulo_alt.resto_titulo }}{% endif %}
                    </span>
                </div>
                {% endfor %}

                {% if obra.nombres_relacionados_700.exists or obra.entidades_relacionadas_710.exists %}
                <div class="detalle-subheader">Colaboradores</div>

                {% for nombre in obra.nombres_relacionados_700.all %}
                <div class="detalle-field">
                    <span class="detalle-field-label">Nombre</span>
                    <span class="detalle-field-value">
                        {{ nombre.persona }}
                        {% if nombre.coordenadas_biograficas %} ({{ nombre.coordenadas_biograficas }}){% endif %}
                        {% for funcion in nombre.funciones.all %}, {{ funcion.get_funcion_display }}{% endfor %}
                    </span>
                </div>
                {% endfor %}

                {% for entidad in obra.entidades_relacionadas_710.all %}
                <div class="detalle-field">
                    <span class="detalle-field-label">Entidad</span>
                    <span class="detalle-field-value">
                        {{ entidad.entidad }}
                        {% if entidad.funcion %}, {{ entidad.get_funcion_display }}{% endif %}
                    </span>
                </div>
                {% endfor %}
                {% endif %}
            </div>
        </section>

        <!-- Columna 2: Datos musicales -->
        <section class="detalle-section">
            <h2 class="detalle-section-title">
                <i class="bi bi-music-note-beamed"></i> Datos musicales
            </h2>
            <div class="detalle-section-body">
                {% if obra.formato %}
                <div class="detalle-field">
                    <span class="detalle-field-label">Formato</span>
                    <span class="detalle-field-value">{{ obra.get_formato_display }}</span>
                </div>
                {% endif %}

                <div class="detalle-field">
                    <span class="detalle-field-label">Medio de interpretación</span>
                    <span class="detalle-field-value">
                        {% with medios=obra.medios_interpretacion_resumen %}
                            {{ medios.0 }}
                            {% if medios.1 %}<span class="detalle-solista">Solista: {{ medios.1 }}</span>{% endif %}
                        {% endwith %}
                    </span>
                </div>

                {% if obra.numero_obra or obra.opus %}
                <div class="detalle-field">
                    <span class="detalle-field-label">Designación numérica</span>
                    <span class="detalle-field-value">
                        {% if obra.numero_obra %}{{ obra.numero_obra }}{% endif %}
                        {% if obra.numero_obra and obra.opus %} / {% endif %}
                        {% if obra.opus %}{{ obra.opus }}{% endif %}
                    </span>
                </div>
                {% endif %}

                <div class="detalle-field">
                    <span class="detalle-field-label">Tonalidad</span>
                    <span class="detalle-field-value">
                        {% if obra.tonalidad_publica_display %}
                            {{ obra.tonalidad_publica_display }}
                        {% else %}
                            <span class="text-muted">Sin tonalidad</span>
                        {% endif %}
                    </span>
                </div>

                <div class="detalle-field detalle-field-incipit">
                    <span class="detalle-field-label">Íncipit musical</span>
                    <div class="obra-card-body">
                            {% with primer_incipit=obra.incipits_musicales.first %}
                                {% if primer_incipit and primer_incipit.paec_full %}
                                    {# Mostrar canvas del primer íncipit #}
                                    <script id="paec_json_{{ primer_incipit.pk }}" type="application/json">{{ primer_incipit.paec_full|safe }}</script>
                                        <canvas
                                            id="incipit_view_canvas_{{ primer_incipit.pk }}"
                                            class="incipit-view-canvas"
                                            width="500"
                                            height="180"
                                            data-paec-json-id="paec_json_{{ primer_incipit.pk }}">
                                        </canvas>


                                    {# Información textual del íncipit #}
                                    {% if primer_incipit.titulo_encabezamiento %}
                                        <p class="obra-inline-line" style="margin-top: 0.125rem; font-size: 0.9em; color: #666;">
                                            {{ primer_incipit.titulo_encabezamiento }}
                                        </p>
                                    {% endif %}
                                {% else %}
                                    <p class="meta-empty">Sin íncipit registrado</p>
                                {% endif %}
                            {% endwith %}
                        </div>
                </div>
            </div>
        </section>

        <!-- Columna 1: Producción/edición -->
        <section class="detalle-section">
            <h2 class="detalle-section-title">
                <i class="bi bi-file-earmark-text"></i> Producción / edición
            </h2>
            <div class="detalle-section-body">
                <div class="detalle-field">
                    <span class="detalle-field-label">Tipo</span>
                    <span class="detalle-field-value">{{ obra.tecnica_340_publica_display }}</span>
                </div>

                <div class="detalle-field">
                    <span class="detalle-field-label">Producción</span>
                    <span class="detalle-field-value">{{ obra.publicacion_publica_display }}</span>
                </div>

                {% for edicion in obra.ediciones.all %}
                <div class="detalle-field">
                    <span class="detalle-field-label">Edición</span>
                    <span class="detalle-field-value">{{ edicion.edicion }}</span>
                </div>
                {% empty %}
                <div class="detalle-field">
                    <span class="detalle-field-label">Edición</span>
                    <span class="detalle-field-value text-muted">Sin edición</span>
                </div>
                {% endfor %}

                <div class="detalle-field">
                    <span class="detalle-field-label">Descripción física</span>
                    <span class="detalle-field-value">{{ obra.descripcion_fisica_publica_display }}</span>
                </div>

                {% if obra.isbn or obra.ismn or obra.numero_editor %}
                <div class="detalle-subheader">Identificadores</div>

                {% if obra.isbn %}
                <div class="detalle-field">
                    <span class="detalle-field-label">ISBN</span>
                    <span class="detalle-field-value">{{ obra.isbn }}</span>
                </div>
                {% endif %}

                {% if obra.ismn %}
                <div class="detalle-field">
                    <span class="detalle-field-label">ISMN</span>
                    <span class="detalle-field-value">{{ obra.ismn }}</span>
                </div>
                {% endif %}

                {% if obra.numero_editor %}
                <div class="detalle-field">
                    <span class="detalle-field-label">Número de editor</span>
                    <span class="detalle-field-value">{{ obra.numero_editor }}</span>
                </div>
                {% endif %}
                {% endif %}
            </div>
        </section>

        <!-- Columna 2: Materias/serie -->
        <section class="detalle-section">
            <h2 class="detalle-section-title">
                <i class="bi bi-tags"></i> Materias / serie
            </h2>
            <div class="detalle-section-body">
                <div class="detalle-field">
                    <span class="detalle-field-label">Materia</span>
                    <span class="detalle-field-value">{{ obra.materia_publica_display }}</span>
                </div>

                <div class="detalle-field">
                    <span class="detalle-field-label">Género/Forma</span>
                    <span class="detalle-field-value">{{ obra.temas_publico_display }}</span>
                </div>

                {% for mencion in obra.menciones_serie.all %}
                <div class="detalle-field">
                    <span class="detalle-field-label">Serie</span>
                    <span class="detalle-field-value">
                        {% for titulo in mencion.titulos.all %}{{ titulo.titulo_serie }}{% if not forloop.last %}, {% endif %}{% endfor %}
                        {% if mencion.volumenes.exists %} ; {% for vol in mencion.volumenes.all %}{{ vol.volumen }}{% if not forloop.last %}, {% endif %}{% endfor %}{% endif %}
                    </span>
                </div>
                {% empty %}
                <div class="detalle-field">
                    <span class="detalle-field-label">Serie</span>
                    <span class="detalle-field-value text-muted">Sin serie</span>
                </div>
                {% endfor %}
            </div>
        </section>

        <!-- Columna 1: Relaciones -->
        <section class="detalle-section">
            <h2 class="detalle-section-title">
                <i class="bi bi-diagram-3"></i> Relaciones
            </h2>
            <div class="detalle-section-body">
                {% for enlace in obra.enlaces_documento_fuente_773.all %}
                <div class="detalle-field">
                    <span class="detalle-field-label">Colección</span>
                    <span class="detalle-field-value">{{ enlace.titulo }}</span>
                </div>
                {% empty %}
                <div class="detalle-field">
                    <span class="detalle-field-label">Colección</span>
                    <span class="detalle-field-value text-muted">Sin colección</span>
                </div>
                {% endfor %}

                {% for enlace in obra.enlaces_unidades_774.all %}
                <div class="detalle-field">
                    <span class="detalle-field-label">Obra en colección</span>
                    <span class="detalle-field-value">
                        {% if enlace.encabezamiento_principal %}{{ enlace.encabezamiento_principal }}. {% endif %}{{ enlace.titulo }}
                    </span>
                </div>
                {% endfor %}

                {% for relacion in obra.otras_relaciones_787.all %}
                <div class="detalle-field">
                    <span class="detalle-field-label">Otras relaciones</span>
                    <span class="detalle-field-value">
                        {% if relacion.encabezamiento_principal %}{{ relacion.encabezamiento_principal }}. {% endif %}{{ relacion.titulo }}
                    </span>
                </div>
                {% endfor %}
            </div>
        </section>

        <!-- Columna 2: Notas -->
        <section class="detalle-section">
            <h2 class="detalle-section-title">
                <i class="bi bi-journal-text"></i> Notas
            </h2>
            <div class="detalle-section-body">
                {% for nota in obra.notas_generales_500.all %}
                <div class="detalle-field">
                    <span class="detalle-field-label">Nota general</span>
                    <span class="detalle-field-value">{{ nota.nota_general }}</span>
                </div>
                {% empty %}
                <div class="detalle-field">
                    <span class="detalle-field-label">Nota general</span>
                    <span class="detalle-field-value text-muted">Sin notas</span>
                </div>
                {% endfor %}

                {% for contenido in obra.contenidos_505.all %}
                <div class="detalle-field">
                    <span class="detalle-field-label">Contenido</span>
                    <span class="detalle-field-value">{{ contenido.contenido }}</span>
                </div>
                {% endfor %}

                {% for sumario in obra.sumarios_520.all %}
                <div class="detalle-field">
                    <span class="detalle-field-label">Sumario</span>
                    <span class="detalle-field-value">{{ sumario.sumario }}</span>
                </div>
                {% endfor %}

                {% if obra.datos_biograficos_545 %}
                <div class="detalle-field">
                    <span class="detalle-field-label">Datos biográficos</span>
                    <span class="detalle-field-value">
                        {{ obra.datos_biograficos_545.texto_biografico }}
                        {% if obra.datos_biograficos_545.uri %}
                            <br><a href="{{ obra.datos_biograficos_545.uri }}" target="_blank" rel="noopener">{{ obra.datos_biograficos_545.uri }}</a>
                        {% endif %}
                    </span>
                </div>
                {% endif %}
            </div>
        </section>

    </div>

    <!-- Visor de PDF -->
    <section class="pdf-viewer-section">
        <div class="pdf-viewer-header">
            <h3 class="pdf-viewer-title">
                <i class="bi bi-file-pdf"></i> Documento
            </h3>
        </div>
        {% if pdf_url %}
            <div class="ratio ratio-16x9 pdf-viewer-container">
                <iframe
                    src="{{ pdf_url }}#&page={{ pdf_start_page|default:1 }}"
                    title="Visor PDF"
                    style="border:0;"
                    allowfullscreen>
                </iframe>
            </div>
            <div class="small text-muted mt-2">
                {% if pdf_start_page == 1 %}
                    Documento completo
                {% else %}
                    Mostrando desde página {{ pdf_start_page }}
                {% endif %}
            </div>
        {% else %}
            <div class="pdf-viewer-container">
                <div class="pdf-viewer-empty">
                    <i class="bi bi-file-earmark-x"></i>
                    <p>No hay documento disponible para esta obra</p>
                </div>
            </div>
        {% endif %}
    </section>
</div>

<script src="{% static 'catalogacion/js/incipitManager.js' %}"></script>
<script src="{% static 'catalogacion/js/incipitInit.js' %}"></script>
{% endblock %}