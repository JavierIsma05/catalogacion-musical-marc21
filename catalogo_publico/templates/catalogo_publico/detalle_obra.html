{% extends 'catalogo_publico/base_publico.html' %}
{% load static %}

{% block title %}{{ obra }} - Vista Detallada - Sistema de Catalogación para la Biblioteca Latinoamericana de Música para Piano{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'catalogo_publico/css/detalle_obra.css' %}">

<style>
@font-face {
  font-family: 'Maestro';
  src: url("{% static 'catalogacion/fonts/Maestro.ttf' %}") format('truetype');
  font-weight: normal;
  font-style: normal;
}

.incipit-view-canvas {
  width: 100%;
  max-width: 500px;
  display: block;
  background: transparent;
  pointer-events: none;
  cursor: default;
}

.detalle-field-autoria {
    display: block;
    font-size: 0.85em;
    color: #666;
    font-style: italic;
    margin-top: 2px;
}

.detalle-field-note {
    font-size: 0.9em;
    color: #666;
}

.detalle-incipit-item {
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #eee;
}

.detalle-incipit-item:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}

.detalle-incipit-info {
    font-size: 0.9em;
    color: #555;
    margin-bottom: 0.5rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container py-3">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-2">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{% url 'catalogo_publico:home' %}">
                    <i class="bi bi-house-door"></i> Inicio
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'catalogo_publico:lista_obras' %}">
                    <i class="bi bi-collection"></i> Catálogo
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'catalogo_publico:detalle' obra.pk %}">
                    {{ obra.signatura_publica_display }}
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">Vista detallada</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="detalle-header">
        <div class="detalle-header-left">
            <h1 class="detalle-main-title">Vista detallada</h1>
            <div class="detalle-actions">
                <a href="{% url 'catalogo_publico:detalle' pk=obra.pk %}" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-arrow-left"></i> Volver al resumen
                </a>
                <a href="{% url 'catalogo_publico:formato_marc21' pk=obra.pk %}" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-code-square"></i> Ver MARC21
                </a>
                {% if has_pdf %}
                <a href="{% url 'catalogo_publico:descargar_pdf' pk=obra.pk %}" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-download"></i> Descargar
                </a>
                {% else %}
                <button class="btn btn-outline-primary btn-sm" disabled title="Sin documento disponible">
                    <i class="bi bi-download"></i> Descargar
                </button>
                {% endif %}
            </div>
        </div>
        <div class="detalle-header-right">
            <!-- Signatura -->
            <div class="detalle-meta-tag">
                <small>Signatura</small>
                <span>{{ obra.signatura_publica_display }}</span>
            </div>
            <!-- Ubicación -->
            {% for ubicacion in obra.ubicaciones_852.all %}
            <div class="detalle-meta-tag">
                <small>Ubicación</small>
                <span>
                    {% if ubicacion.codigo_o_nombre %}{{ ubicacion.codigo_o_nombre }}{% endif %}{% if ubicacion.signatura_original %}.{{ ubicacion.signatura_original }}{% endif %}{% for estanteria in ubicacion.estanterias.all %}.{{ estanteria.estanteria }}{% endfor %}
                </span>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Contenido en 1 columna -->
    <div class="detalle-content">

        <!-- ==================== NOMBRES Y TÍTULOS ==================== -->
        <section class="detalle-section">
            <h2 class="detalle-section-title">
                <i class="bi bi-person-badge"></i> Nombres y títulos
            </h2>
            <div class="detalle-section-body">

                <!-- Compositor -->
                {% if obra.compositor %}
                <div class="detalle-field">
                    <span class="detalle-field-label">Compositor</span>
                    <span class="detalle-field-value">
                        {{ obra.compositor.apellidos_nombres }}{% if obra.compositor.coordenadas_biograficas %} ({{ obra.compositor.coordenadas_biograficas }}){% endif %}
                        {% if obra.termino_asociado %}, {{ obra.termino_asociado }}{% endif %}
                        {% if obra.autoria %}
                            <span class="detalle-field-autoria">[{{ obra.get_autoria_display|lower }}]</span>
                        {% endif %}
                    </span>
                </div>
                {% endif %}

                {% if obra.titulo_uniforme %}
                <!-- Título uniforme (punto de acceso principal) -->
                <div class="detalle-field">
                    <span class="detalle-field-label">Título uniforme (punto de acceso principal)</span>
                    <span class="detalle-field-value">
                        {{ obra.titulo_uniforme }}{% if obra.medio_interpretacion_130 %}, {{ obra.get_medio_interpretacion_130_display }}{% endif %}{% if obra.tonalidad_130 %}, {{ obra.get_tonalidad_130_display }}{% endif %}{% if obra.nombre_parte_130 %}, {{ obra.nombre_parte_130 }}{% endif %}{% if obra.numero_parte_130 %}, {{ obra.numero_parte_130 }}{% endif %}{% if obra.forma_130 %}, {{ obra.forma_130 }}{% endif %}{% if obra.arreglo_130 %}, {{ obra.get_arreglo_130_display }}{% endif %}
                    </span>
                </div>
                {% else %}
                    {% if obra.titulo_240 %}
                    <!-- Título uniforme (240) -->
                    <div class="detalle-field">
                        <span class="detalle-field-label">Título uniforme</span>
                        <span class="detalle-field-value">
                            {{ obra.titulo_240 }}{% if obra.medio_interpretacion_240 %}, {{ obra.get_medio_interpretacion_240_display }}{% endif %}{% if obra.tonalidad_240 %}, {{ obra.get_tonalidad_240_display }}{% endif %}{% if obra.nombre_parte_240 %}, {{ obra.nombre_parte_240 }}{% endif %}{% if obra.numero_parte_240 %}, {{ obra.numero_parte_240 }}{% endif %}{% if obra.forma_240 %}, {{ obra.forma_240 }}{% endif %}{% if obra.arreglo_240 %}, {{ obra.get_arreglo_240_display }}{% endif %}
                        </span>
                    </div>
                    {% endif %}
                    <!-- Título en fuente (245) -->
                    {% if obra.titulo_principal %}
                    <div class="detalle-field">
                        <span class="detalle-field-label">Título en fuente</span>
                        <span class="detalle-field-value">
                            {{ obra.titulo_principal }}{% if obra.subtitulo %} : {{ obra.subtitulo }}{% endif %}{% if obra.mencion_responsabilidad %} / {{ obra.mencion_responsabilidad }}{% endif %}
                        </span>
                    </div>
                    {% endif %}
                {% endif %}

                <!-- Títulos alternativos -->
                {% for titulo_alt in obra.titulos_alternativos.all %}
                <div class="detalle-field">
                    <span class="detalle-field-label">Título alternativo</span>
                    <span class="detalle-field-value">
                        {% if titulo_alt.texto_visualizacion %}{{ titulo_alt.texto_visualizacion }}: {% endif %}{{ titulo_alt.titulo }}{% if titulo_alt.subtitulo %} : {{ titulo_alt.subtitulo }}{% endif %}
                    </span>
                </div>
                {% endfor %}

                <!-- Autores/colaboradores -->
                {% if obra.nombres_relacionados_700.exists or obra.entidades_relacionadas_710.exists %}
                <div class="detalle-subheader">Autores/colaboradores</div>

                {% for nombre in obra.nombres_relacionados_700.all %}
                <div class="detalle-field">
                    <span class="detalle-field-label">Nombre relacionado</span>
                    <span class="detalle-field-value">
                        {% if nombre.persona %}{{ nombre.persona }}{% endif %}{% if nombre.coordenadas_biograficas %} ({{ nombre.coordenadas_biograficas }}){% endif %}{% for funcion in nombre.funciones.all %}, {{ funcion.get_funcion_display }}{% endfor %}{% for termino in nombre.terminos_asociados.all %}, {{ termino.termino }}{% endfor %}
                        {% if nombre.autoria %}
                            <span class="detalle-field-autoria">[{{ nombre.get_autoria_display|lower }}]</span>
                        {% endif %}
                    </span>
                </div>
                {% endfor %}

                {% for entidad in obra.entidades_relacionadas_710.all %}
                <div class="detalle-field">
                    <span class="detalle-field-label">Entidad relacionada</span>
                    <span class="detalle-field-value">
                        {% if entidad.entidad %}{{ entidad.entidad }}{% endif %}{% if entidad.funcion %}, {{ entidad.get_funcion_display }}{% endif %}
                    </span>
                </div>
                {% endfor %}
                {% endif %}
            </div>
        </section>

        <!-- ==================== PRODUCCIÓN/EDICIÓN ==================== -->
        <section class="detalle-section">
            <h2 class="detalle-section-title">
                <i class="bi bi-file-earmark-text"></i> Producción/edición
            </h2>
            <div class="detalle-section-body">

                <!-- Manuscrito/Impreso -->
                <div class="detalle-field">
                    <span class="detalle-field-label">Manuscrito/Impreso</span>
                    <span class="detalle-field-value">
                        {% if obra.ms_imp %}
                            {{ obra.get_ms_imp_display }}
                        {% else %}
                            {{ obra.tipo_soporte_publico_display }}
                        {% endif %}
                    </span>
                </div>

                <!-- Producción de la obra -->
                {% for produccion in obra.producciones_publicaciones.all %}
                <div class="detalle-field">
                    <span class="detalle-field-label">{{ produccion.get_funcion_display }} de la obra</span>
                    <span class="detalle-field-value">
                        {% for lugar in produccion.lugares.all %}{{ lugar.lugar }}{% if not forloop.last %}, {% endif %}{% endfor %}{% if produccion.entidades.exists %} : {% for entidad in produccion.entidades.all %}{{ entidad.nombre }}{% if not forloop.last %}, {% endif %}{% endfor %}{% endif %}{% if produccion.fechas.exists %}, {% for fecha in produccion.fechas.all %}{{ fecha.fecha }}{% if not forloop.last %}, {% endif %}{% endfor %}{% endif %}
                    </span>
                </div>
                {% endfor %}

                <!-- Edición -->
                {% for edicion in obra.ediciones.all %}
                <div class="detalle-field">
                    <span class="detalle-field-label">Edición</span>
                    <span class="detalle-field-value">{{ edicion.edicion }}</span>
                </div>
                {% endfor %}

                <!-- Descripción física -->
                {% if obra.extension or obra.otras_caracteristicas or obra.dimension or obra.material_acompanante %}
                <div class="detalle-field">
                    <span class="detalle-field-label">Descripción física</span>
                    <span class="detalle-field-value">
                        {% if obra.extension %}{{ obra.extension }}{% endif %}{% if obra.otras_caracteristicas %}{% if obra.extension %} : {% endif %}{{ obra.otras_caracteristicas }}{% endif %}{% if obra.dimension %}{% if obra.extension or obra.otras_caracteristicas %} ; {% endif %}{{ obra.dimension }}{% endif %}{% if obra.material_acompanante %}{% if obra.extension or obra.otras_caracteristicas or obra.dimension %} + {% endif %}{{ obra.material_acompanante }}{% endif %}
                    </span>
                </div>
                {% endif %}

                <!-- Identificadores -->
                {% if obra.isbn or obra.ismn or obra.numero_editor %}
                <div class="detalle-subheader">Identificadores</div>

                {% if obra.isbn %}
                <div class="detalle-field">
                    <span class="detalle-field-label">ISBN</span>
                    <span class="detalle-field-value">{{ obra.isbn }}</span>
                </div>
                {% endif %}

                {% if obra.ismn %}
                <div class="detalle-field">
                    <span class="detalle-field-label">ISMN</span>
                    <span class="detalle-field-value">{{ obra.ismn }}</span>
                </div>
                {% endif %}

                {% if obra.numero_editor %}
                <div class="detalle-field">
                    <span class="detalle-field-label">Número de editor</span>
                    <span class="detalle-field-value">{{ obra.numero_editor }}</span>
                </div>
                {% endif %}
                {% endif %}
            </div>
        </section>

        <!-- ==================== MATERIAS/SERIE ==================== -->
        {% if obra.materias_650.exists or obra.materias_655.exists or obra.menciones_serie.exists %}
        <section class="detalle-section">
            <h2 class="detalle-section-title">
                <i class="bi bi-tags"></i> Materias/serie
            </h2>
            <div class="detalle-section-body">

                <!-- Materia -->
                {% for materia in obra.materias_650.all %}
                {% if materia.materia %}
                <div class="detalle-field">
                    <span class="detalle-field-label">Materia</span>
                    <span class="detalle-field-value">
                        {{ materia.materia }}{% for sub in materia.subdivisiones.all %} – {{ sub.subdivision }}{% endfor %}{% for sub in materia.subdivisiones_geograficas.all %} – {{ sub.subdivision }}{% endfor %}
                    </span>
                </div>
                {% endif %}
                {% endfor %}

                <!-- Materia (Género/Forma) -->
                {% for genero in obra.materias_655.all %}
                <div class="detalle-field">
                    <span class="detalle-field-label">Materia (Género/Forma)</span>
                    <span class="detalle-field-value">
                        {{ genero.materia }}{% for sub in genero.subdivisiones.all %} – {{ sub.subdivision }}{% endfor %}
                    </span>
                </div>
                {% endfor %}

                <!-- Serie -->
                {% for mencion in obra.menciones_serie.all %}
                <div class="detalle-field">
                    <span class="detalle-field-label">Serie</span>
                    <span class="detalle-field-value">
                        {% for titulo in mencion.titulos.all %}{{ titulo.titulo_serie }}{% if not forloop.last %}, {% endif %}{% endfor %}{% if mencion.volumenes.exists %} ; {% for vol in mencion.volumenes.all %}{{ vol.volumen }}{% if not forloop.last %}, {% endif %}{% endfor %}{% endif %}
                    </span>
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}

        <!-- ==================== DATOS MUSICALES ==================== -->
        <section class="detalle-section">
            <h2 class="detalle-section-title">
                <i class="bi bi-music-note-beamed"></i> Datos musicales
            </h2>
            <div class="detalle-section-body">

                <!-- Formato de presentación musical -->
                {% if obra.formato %}
                <div class="detalle-field">
                    <span class="detalle-field-label">Formato de presentación musical</span>
                    <span class="detalle-field-value">{{ obra.get_formato_display }}</span>
                </div>
                {% endif %}

                <!-- Medio de interpretación -->
                {% with medios=obra.medios_interpretacion_resumen %}
                {% if medios.0 != "Sin medios registrados" %}
                <div class="detalle-field">
                    <span class="detalle-field-label">Medio de interpretación</span>
                    <span class="detalle-field-value">
                        {{ medios.0 }}
                        {% if medios.1 %}<br>{{ medios.1 }}{% endif %}
                    </span>
                </div>
                {% endif %}
                {% endwith %}

                <!-- Designación numérica de obra musical -->
                {% if obra.numero_obra or obra.opus %}
                <div class="detalle-field">
                    <span class="detalle-field-label">Designación numérica de obra musical</span>
                    <span class="detalle-field-value">
                        {% if obra.numero_obra %}{{ obra.numero_obra }}{% endif %}{% if obra.numero_obra and obra.opus %} / {% endif %}{% if obra.opus %}{{ obra.opus }}{% endif %}
                    </span>
                </div>
                {% endif %}

                <!-- Tonalidad -->
                {% if obra.tonalidad_384 %}
                <div class="detalle-field">
                    <span class="detalle-field-label">Tonalidad</span>
                    <span class="detalle-field-value">{{ obra.get_tonalidad_384_display }}</span>
                </div>
                {% endif %}

                <!-- Íncipit musical -->
                {% if obra.incipits_musicales.exists %}
                <div class="detalle-field detalle-field-incipit">
                    <span class="detalle-field-label">Íncipit musical</span>
                    <div class="detalle-field-value">
                        {% for incipit in obra.incipits_musicales.all %}
                            <div class="detalle-incipit-item">
                                <!-- Información del íncipit -->
                                <div class="detalle-incipit-info">
                                    {{ incipit.numero_obra }}.{{ incipit.numero_movimiento }}.{{ incipit.numero_pasaje }}{% if incipit.titulo_encabezamiento %}; {{ incipit.titulo_encabezamiento }}{% endif %}{% if incipit.voz_instrumento %}; {{ incipit.voz_instrumento }}{% endif %}{% if incipit.clave or incipit.armadura or incipit.tiempo %}; {% if incipit.clave %}{{ incipit.clave }}{% endif %}{% if incipit.armadura %} {{ incipit.armadura }}{% endif %}{% if incipit.tiempo %} {{ incipit.tiempo }}{% endif %}{% endif %}
                                </div>
                                <!-- Canvas del íncipit -->
                                {% if incipit.paec_full %}
                                    <script id="paec_json_{{ incipit.pk }}" type="application/json">{{ incipit.paec_full|safe }}</script>
                                    <canvas
                                        id="incipit_view_canvas_{{ incipit.pk }}"
                                        class="incipit-view-canvas"
                                        width="600"
                                        height="190"
                                        data-paec-json-id="paec_json_{{ incipit.pk }}">
                                    </canvas>
                                {% endif %}
                                <!-- Notación musical $p -->
                                {% if incipit.notacion_musical %}
                                    <div class="small text-muted mt-1">
                                        <code>{{ incipit.notacion_musical }}</code>
                                    </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </section>

        <!-- ==================== NOTAS ==================== -->
        {% if obra.notas_generales_500.exists or obra.contenidos_505.exists or obra.sumarios_520.exists or obra.datos_biograficos_545 %}
        <section class="detalle-section">
            <h2 class="detalle-section-title">
                <i class="bi bi-journal-text"></i> Notas
            </h2>
            <div class="detalle-section-body">

                <!-- Nota general -->
                {% with primera_nota=obra.notas_generales_500.first %}
                {% if primera_nota %}
                <div class="detalle-field">
                    <span class="detalle-field-label">Nota general</span>
                    <span class="detalle-field-value">{{ primera_nota.nota_general }}</span>
                </div>
                {% endif %}
                {% endwith %}

                <!-- Contenido -->
                {% for contenido in obra.contenidos_505.all %}
                <div class="detalle-field">
                    <span class="detalle-field-label">Contenido</span>
                    <span class="detalle-field-value">{{ contenido.contenido }}</span>
                </div>
                {% endfor %}

                <!-- Sumario -->
                {% for sumario in obra.sumarios_520.all %}
                <div class="detalle-field">
                    <span class="detalle-field-label">Sumario</span>
                    <span class="detalle-field-value">{{ sumario.sumario }}</span>
                </div>
                {% endfor %}

                <!-- Datos biográficos del compositor -->
                {% if obra.datos_biograficos_545 %}
                <div class="detalle-field">
                    <span class="detalle-field-label">Datos biográficos del compositor</span>
                    <span class="detalle-field-value">
                        {{ obra.datos_biograficos_545.texto_biografico }}
                        {% if obra.datos_biograficos_545.uri %}
                            <br><br><strong>Fuente:</strong> <a href="{{ obra.datos_biograficos_545.uri }}" target="_blank" rel="noopener">{{ obra.datos_biograficos_545.uri }}</a>
                        {% endif %}
                    </span>
                </div>
                {% endif %}
            </div>
        </section>
        {% endif %}

        <!-- ==================== RELACIONES ==================== -->
        {% if obra.enlaces_documento_fuente_773.exists or obra.enlaces_unidades_774.exists or obra.otras_relaciones_787.exists %}
        <section class="detalle-section">
            <h2 class="detalle-section-title">
                <i class="bi bi-diagram-3"></i> Relaciones
            </h2>
            <div class="detalle-section-body">

                <!-- Colección -->
                {% for enlace in obra.enlaces_documento_fuente_773.all %}
                <div class="detalle-field">
                    <span class="detalle-field-label">Colección</span>
                    <span class="detalle-field-value">
                        {% if enlace.encabezamiento_principal %}{{ enlace.encabezamiento_principal }}. {% endif %}{{ enlace.titulo }}
                    </span>
                </div>
                {% endfor %}

                <!-- Obra en esta colección -->
                {% for enlace in obra.enlaces_unidades_774.all %}
                <div class="detalle-field">
                    <span class="detalle-field-label">Obra en esta colección</span>
                    <span class="detalle-field-value">
                        {% if enlace.encabezamiento_principal %}{{ enlace.encabezamiento_principal }}. {% endif %}{{ enlace.titulo }}
                    </span>
                </div>
                {% endfor %}

                <!-- Otras relaciones -->
                {% for relacion in obra.otras_relaciones_787.all %}
                <div class="detalle-field">
                    <span class="detalle-field-label">Otras relaciones</span>
                    <span class="detalle-field-value">
                        {% if relacion.encabezamiento_principal %}{{ relacion.encabezamiento_principal }}. {% endif %}{{ relacion.titulo }}
                    </span>
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}

    </div>

    <!-- Visor de PDF -->
    <section class="pdf-viewer-section">
        <div class="pdf-viewer-header">
            <h3 class="pdf-viewer-title">
                <i class="bi bi-file-pdf"></i> Documento
            </h3>
        </div>
        {% if pdf_url %}
            <div class="ratio ratio-16x9 pdf-viewer-container">
                <iframe
                    src="{{ pdf_url }}#&page={{ pdf_start_page|default:1 }}"
                    title="Visor PDF"
                    style="border:0;"
                    allowfullscreen>
                </iframe>
            </div>
            <div class="small text-muted mt-2">
                {% if pdf_start_page == 1 %}
                    Documento completo
                {% else %}
                    Mostrando desde página {{ pdf_start_page }}
                {% endif %}
            </div>
        {% else %}
            <div class="pdf-viewer-container">
                <div class="pdf-viewer-empty">
                    <i class="bi bi-file-earmark-x"></i>
                    <p>No hay documento disponible para esta obra</p>
                </div>
            </div>
        {% endif %}
    </section>
</div>

<script src="{% static 'catalogacion/js/incipitManager.js' %}"></script>
<script src="{% static 'catalogacion/js/incipitInit.js' %}"></script>
{% endblock %}
