{% extends "usuarios/catalogador/base_catalogador.html" %}
{% load static %}
{% block title %}Asignar segmentos{% endblock %}
{% block page_title %}Asignar segmentos{% endblock %}

{% block content %}

<div class="card mb-3">
  <div class="card-body">
    <h5 class="mb-1">{{ coleccion.titulo_principal }}</h5>
    <div class="text-muted small">Colección (signatura): <strong>{{ coleccion.signatura_publica_display }}</strong></div>
  </div>
</div>



{% if not digital_set %}
  <div class="alert alert-warning">
    Primero debes <a href="{% url 'digitalizacion:importar' coleccion.id %}">importar el escaneo</a>.
  </div>
{% else %}


<div class="row g-3">


  <div class="col-lg-5">
    <div class="card mb-3">
      <div class="card-body">
        <h6 class="mb-1">Crear segmento</h6>
        <p class="text-muted small mb-3">Objetivo: ver el documento y decir “de aquí a aquí es esta obra”.</p>

        <form method="post" class="mt-2" id="segmentForm">
          {% csrf_token %}

          <div class="mb-2">
            <label class="form-label">Buscar obra</label>

            <input id="obraSearch" class="form-control" placeholder="Escribe título, número de control o signatura..." autocomplete="off">
            <input type="hidden" name="obra_id" id="obraIdHidden" required>

            <div class="list-group mt-2" id="obraResults" style="display:none;"></div>

            <div class="form-text">Selecciona una obra de la lista para completar el ID.</div>
          </div>

          <div class="row">
            <div class="col">
              <label class="form-label">Inicio</label>
              <input class="form-control" id="startPage" name="start_page" type="number" min="1" max="{{ max_pages }}" required>
            </div>
            <div class="col">
              <label class="form-label">Fin</label>
              <input class="form-control" id="endPage" name="end_page" type="number" min="1" max="{{ max_pages }}" required>
            </div>
          </div>

          <div class="mt-2">
            <label class="form-label">Tipo</label>
            <select class="form-select" name="tipo">
              <option value="OBRA">Obra</option>
              <option value="NOTAS">Notas</option>
              <option value="ANEXO">Anexo</option>
              <option value="EXCLUIDO">Excluido</option>
            </select>
          </div>

          <div class="d-flex gap-2 mt-3 flex-wrap">
            <button class="btn btn-primary" type="submit">Guardar segmento</button>
            <a class="btn btn-outline-secondary" href="{% url 'digitalizacion:coleccion_home' coleccion.id %}">Volver a la guía</a>
          </div>
        </form>
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <h6 class="mb-2">Segmentos existentes</h6>

        {% if segments %}
          <ul class="list-group">
            {% for s in segments %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div class="me-3">
                  <a class="fw-semibold text-decoration-none" href="{% url 'digitalizacion:visor_obra' s.obra_id %}">
                    {{ s.obra.signatura_publica_display }} — {{ s.obra.titulo_principal }}
                  </a>
                  <div class="small text-muted">
                    {% if s.obra.autor_publico_principal %}{{ s.obra.autor_publico_principal }} · {% endif %}Págs. {{ s.start_page }}–{{ s.end_page }} · {{ s.tipo }}
                  </div>
                </div>
                <form method="post" action="{% url 'digitalizacion:segmento_eliminar' s.id %}">
                  {% csrf_token %}
                  <button class="btn btn-sm btn-outline-danger">Eliminar</button>
                </form>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-muted mb-0">Aún no hay segmentos.</p>
        {% endif %}
      </div>
    </div>
  </div>


  <div class="col-lg-7">
    <div class="card" data-has-pdf="{% if digital_set.pdf_path %}1{% else %}0{% endif %}">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
          <div>
            <h6 class="mb-1">Visor</h6>
            <div class="text-muted small">Feedback: <span id="rangeLabel">Selecciona un rango</span></div>
          </div>
          <div class="small text-muted">
            {% if digital_set.pdf_path %}
              Fuente: PDF
            {% else %}
              Fuente: JPG derivados
            {% endif %}
          </div>
        </div>

        {% if digital_set.pdf_path %}
          <iframe
            id="pdfViewer"
            src="/media/{{ digital_set.pdf_path }}"
            style="width:100%;height:80vh;border:1px solid #ddd;"
            loading="lazy"></iframe>
        {% else %}
          <div class="alert alert-info mt-3 mb-0">
            No hay PDF asociado. Aquí se mostrarán miniaturas JPG del rango seleccionado.
          </div>
          <div id="thumbContainer" class="mt-3"></div>
        {% endif %}
      </div>
    </div>
  </div>

</div>


<script>
  (function () {
    const start = document.getElementById('startPage');
    const end = document.getElementById('endPage');
    const label = document.getElementById('rangeLabel');
    const iframe = document.getElementById('pdfViewer');

    function clamp(n, min, max) {
      n = parseInt(n, 10);
      if (Number.isNaN(n)) return null;
      return Math.max(min, Math.min(max, n));
    }

    function update() {
      const min = 1;
      const max = parseInt('{{ max_pages|default:"999999" }}', 10);
      const s = clamp(start?.value, min, max);
      const e = clamp(end?.value, min, max);

      if (s && e) label.textContent = `Viendo páginas ${s}–${e}`;
      else if (s) label.textContent = `Viendo página ${s}`;
      else label.textContent = 'Selecciona un rango';

      if (iframe && s) {
        // PDF.js / visor nativo: usar ancla de página
        const base = iframe.getAttribute('src').split('#')[0];
        iframe.setAttribute('src', `${base}#page=${s}`);
      }
    }

    start?.addEventListener('input', update);
    end?.addEventListener('input', update);
    update();
  })();
</script>

{% endif %}
<script src="{% static 'digitalizacion/js/segmentar.js' %}"></script>

{% endblock %}

