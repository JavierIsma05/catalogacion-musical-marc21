{% extends "usuarios/catalogador/base_catalogador.html" %}
{% block title %}Visor obra{% endblock %}
{% block page_title %}Visor obra{% endblock %}

{% block content %}

<div class="card mb-3">
  <div class="card-body">
    <h5 class="mb-1">{{ obra.titulo_principal }}</h5>
    <div class="text-muted small">
      <strong>{{ obra.signatura_publica_display }}</strong>
      {% if obra.autor_publico_principal %} · {{ obra.autor_publico_principal }}{% endif %}
    </div>
    {% if start_page and end_page %}
      <small class="text-muted">Segmento: páginas {{ start_page }}–{{ end_page }}</small>
    {% endif %}
  </div>
</div>

{% if not digital_set %}
  <div class="alert alert-warning">
    Esta obra no tiene segmentos asignados todavía.
  </div>

{% else %}


  {% if digital_set.pdf_path %}
    <div class="card mb-3">
      <div class="card-body">
        <h6 class="mb-2">PDF</h6>
        <div class="mb-2">
          <small class="text-muted">
            Segmento: página {{ start_page }} a {{ end_page }}
            <button class="btn btn-sm btn-link p-0" onclick="goToPage()">Ir a página {{ start_page }}</button>
          </small>
        </div>
        <iframe
          id="pdfViewer"
          src="/media/{{ digital_set.pdf_path }}#page={{ start_page }}"
          style="width:100%;height:80vh;border:1px solid #ddd;">
        </iframe>
        <div class="form-text">
          MVP: abre en la página inicial del segmento. (No restringe navegación fuera del rango.)
        </div>
      </div>
    </div>

    <script>
      (function() {
        const iframe = document.getElementById('pdfViewer');
        const pdfPath = '{{ digital_set.pdf_path }}';
        const startPage = {{ start_page }};

        function setPageWithoutFragment() {
          if (iframe && startPage) {
            const basePath = pdfPath.split('#')[0];
            iframe.src = '/media/' + basePath + '#page=' + startPage;
          }
        }

        window.goToPage = function() {
          setPageWithoutFragment();
        };

        // Intentar establecer la página cuando se carga el DOM
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', setPageWithoutFragment);
        } else {
          setPageWithoutFragment();
        }

        // Reintento después de un tiempo para navegadores que cargan más lentamente
        setTimeout(setPageWithoutFragment, 500);
      })();
    </script>

  {% else %}

    <div class="card">
      <div class="card-body">
        <h6 class="mb-3">Imágenes (segmento)</h6>

        {% for p in pages %}
          <div class="mb-3">
            <div class="small text-muted mb-1">p{{ p.page_number|stringformat:"03d" }}</div>
            <img src="/media/{{ p.derivative_path }}" class="img-fluid border rounded">
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}

{% endif %}
<div class="d-flex gap-2 mb-3">
  {% if coleccion_padre %}
    <a class="btn btn-outline-secondary" href="{% url 'digitalizacion:obra_home' coleccion_padre.id %}">Volver a la guía</a>
    <a class="btn btn-outline-secondary" href="{% url 'digitalizacion:segmentar' coleccion_padre.id %}">Segmentación</a>
    <a class="btn btn-outline-secondary" href="{% url 'digitalizacion:visor_digital' coleccion_padre.id %}">Visor colección</a>
  {% else %}
    <a class="btn btn-outline-secondary" href="{% url 'digitalizacion:dashboard' %}">Digitalización</a>
  {% endif %}
</div>
{% endblock %}
