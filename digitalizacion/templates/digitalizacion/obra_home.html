{% extends "usuarios/catalogador/base_catalogador.html" %}

{% block title %}Importar Im√°genes ‚Äì {% if es_coleccion %}Colecci√≥n{% else %}Obra{% endif %}{% endblock %}
{% block page_title %}Importar Im√°genes ‚Äì {% if es_coleccion %}Colecci√≥n{% else %}Obra{% endif %}{% endblock %}

{% block content %}
<div class="card mb-3">
  <div class="card-body">
    <h5 class="mb-1">{{ obra.titulo_principal }}</h5>
    <div class="text-muted small">
      <strong>{{ obra.signatura_publica_display }}</strong>
      {% if obra.autor_publico_principal %} ¬∑ {{ obra.autor_publico_principal }}{% endif %}
    </div>
    <div class="mt-2">
      {% if es_coleccion %}
        <span class="badge bg-primary">Colecci√≥n</span>
      {% else %}
        <span class="badge bg-info">Obra suelta</span>
      {% endif %}
    </div>
  </div>
</div>

<div class="card">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
      <div>
        <h6 class="mb-1">Gu√≠a de trabajo</h6>
        <div class="text-muted small">Sigue los pasos en orden.</div>
      </div>
      <div class="text-end">
        {% if digital_set %}
          <span class="badge bg-info">Estado: {{ digital_set.estado }}</span>
        {% else %}
          <span class="badge bg-secondary">Sin importaci√≥n</span>
        {% endif %}
      </div>
    </div>

    <div class="list-group mt-3">

      {# Paso 1: Importar #}
      <div class="list-group-item d-flex justify-content-between align-items-start">
        <div class="me-3">
          <div class="fw-semibold">üì• Paso 1 ¬∑ Importar TIFF / PDF</div>
          <div class="text-muted small">
            TIFF: importar desde INBOX. PDF: subir archivo.
          </div>
        </div>
        <div class="text-end">
          <div class="mb-2">
            {% with total_pages=digital_set.total_pages|default:0 %}
              {% if digital_set and total_pages > 0 or digital_set.pdf_path %}
                <span class="badge bg-success">Listo</span>
              {% else %}
                <span class="badge bg-warning text-dark">Pendiente</span>
              {% endif %}
            {% endwith %}
          </div>
          <div class="d-flex gap-2 justify-content-end flex-wrap">
            <a class="btn btn-sm btn-primary" href="{% url 'digitalizacion:importar' obra.id %}">Importar TIFF</a>
            <a class="btn btn-sm btn-outline-primary" href="{% url 'digitalizacion:subir_pdf' obra.id %}">Subir PDF</a>
            {% if digital_set %}
              <div class="dropdown d-inline-block">
                <button class="btn btn-sm btn-outline-danger dropdown-toggle" type="button" data-bs-toggle="dropdown">
                  Eliminar
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  {% if digital_set.pdf_path %}
                  <li>
                    <form method="post" action="{% url 'digitalizacion:eliminar_pdf' obra.id %}"
                          onsubmit="return confirm('¬øEliminar el PDF? Las im√°genes TIFF/JPG se mantendr√°n.');">
                      {% csrf_token %}
                      <button type="submit" class="dropdown-item text-danger">Solo PDF</button>
                    </form>
                  </li>
                  {% endif %}
                  <li>
                    <form method="post" action="{% url 'digitalizacion:eliminar_digitalset' obra.id %}"
                          onsubmit="return confirm('¬øEliminar TODA la digitalizaci√≥n (PDF + im√°genes)? Esta acci√≥n no se puede deshacer.');">
                      {% csrf_token %}
                      <button type="submit" class="dropdown-item text-danger">Todo (PDF + im√°genes)</button>
                    </form>
                  </li>
                </ul>
              </div>
            {% endif %}
          </div>
        </div>
      </div>

      {# Paso 2: Revisar #}
      <div class="list-group-item d-flex justify-content-between align-items-start">
        <div class="me-3">
          <div class="fw-semibold">‚úÖ Paso 2 ¬∑ Revisar importaci√≥n</div>
          <div class="text-muted small">
            {% if digital_set %}
              TIFF: {{ digital_set.total_pages|default:0 }} p√°ginas.
              {% if digital_set.pdf_path %} ¬∑ PDF: cargado{% else %} ¬∑ PDF: no cargado{% endif %}
            {% else %}
              Importa TIFF o sube PDF para continuar.
            {% endif %}
          </div>
        </div>
        <div class="text-end">
          {% with total_pages=digital_set.total_pages|default:0 %}
            {% if digital_set and total_pages > 0 or digital_set.pdf_path %}
              <span class="badge bg-success">Listo</span>
            {% else %}
              <span class="badge bg-secondary">Bloqueado</span>
            {% endif %}
          {% endwith %}
        </div>
      </div>

      {% if es_coleccion %}
      {# Paso 3: Segmentar (solo para colecciones) #}
      <div class="list-group-item d-flex justify-content-between align-items-start">
        <div class="me-3">
          <div class="fw-semibold">‚úÇÔ∏è Paso 3 ¬∑ Segmentar obras</div>
          <div class="text-muted small">Define rangos: "de aqu√≠ a aqu√≠ es esta obra".</div>
        </div>
        <div class="text-end">
          <div class="mb-2">
            {% if digital_set and digital_set.segments.all|length %}
              <span class="badge bg-success">{{ digital_set.segments.all|length }} segmento(s)</span>
            {% elif digital_set %}
              <span class="badge bg-warning text-dark">Pendiente</span>
            {% else %}
              <span class="badge bg-secondary">Bloqueado</span>
            {% endif %}
          </div>
          {% if digital_set and digital_set.total_pages|default:0 > 0 or digital_set.pdf_path %}
            <a class="btn btn-sm btn-primary" href="{% url 'digitalizacion:segmentar' obra.id %}">
              Asignar segmentos
            </a>
          {% else %}
            <span class="btn btn-sm btn-primary disabled" style="opacity: 0.5; cursor: not-allowed;">
              Asignar segmentos
            </span>
          {% endif %}
        </div>
      </div>
      {% endif %}

      {# Paso final: Visualizar #}
      <div class="list-group-item d-flex justify-content-between align-items-start">
        <div class="me-3">
          <div class="fw-semibold">üëÅÔ∏è {% if es_coleccion %}Paso 4{% else %}Paso 3{% endif %} ¬∑ Visualizar</div>
          <div class="text-muted small">
            {% if es_coleccion %}
              Colecci√≥n completa y navegaci√≥n por segmentos.
            {% else %}
              Ver documento digitalizado.
            {% endif %}
          </div>
        </div>
        <div class="text-end">
          {% if digital_set and digital_set.total_pages|default:0 > 0 or digital_set.pdf_path %}
            <a class="btn btn-sm btn-outline-primary" href="{% url 'digitalizacion:visor_digital' obra.id %}">
              Ver documento
            </a>
          {% else %}
            <span class="btn btn-sm btn-outline-primary" style="opacity: 0.5; cursor: not-allowed;">Ver documento</span>
          {% endif %}

          {% if es_coleccion %}
            {% with segments=digital_set.segments.all %}
              {% if segments|length == 1 %}
                <a class="btn btn-sm btn-outline-secondary ms-2"
                   href="{% url 'digitalizacion:visor_obra' segments.0.obra_id %}">
                  Ver obra: {{ segments.0.obra.signatura_publica_display }}
                </a>
              {% elif segments|length > 1 %}
                <div class="dropdown d-inline-block ms-2">
                  <button class="btn btn-sm btn-outline-secondary dropdown-toggle"
                          type="button" data-bs-toggle="dropdown">
                    Ver obra
                  </button>
                  <ul class="dropdown-menu">
                    {% for seg in segments %}
                      <li>
                        <a class="dropdown-item" href="{% url 'digitalizacion:visor_obra' seg.obra_id %}">
                          {{ seg.obra.signatura_publica_display }} ‚Äî {{ seg.obra.titulo_principal }} (p√°gs. {{ seg.start_page }}‚Äì{{ seg.end_page }})
                        </a>
                      </li>
                    {% endfor %}
                  </ul>
                </div>
              {% endif %}
            {% endwith %}
          {% endif %}
        </div>
      </div>

    </div>
  </div>
</div>

<div class="mt-3">
  <a class="btn btn-outline-secondary" href="{% url 'digitalizacion:dashboard' %}">Seleccionar otra obra</a>
</div>
{% endblock %}
