{% extends "usuarios/catalogador/base_catalogador.html" %}

{% block title %}Importar Im√°genes ‚Äì Colecci√≥n{% endblock %}
{% block page_title %}Importar Im√°genes ‚Äì Colecci√≥n{% endblock %}

{% block content %}
<div class="card mb-3">
  <div class="card-body">
    <h5 class="mb-1">{{ coleccion.titulo_principal }}</h5>
      <div class="text-muted small">
        <strong>{{ coleccion.signatura_publica_display }}</strong>
        {% if coleccion.autor_publico_principal %} ¬∑ {{ coleccion.autor_publico_principal }}{% endif %}
      </div>
  </div>

</div>

<div class="card">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
      <div>
        <h6 class="mb-1">Gu√≠a de trabajo</h6>
        <div class="text-muted small">Sigue los pasos en orden. La interfaz te dice qu√© sigue.</div>
      </div>
      <div class="text-end">
        {% if coleccion.digital_set %}
          <span class="badge bg-info">Estado: {{ coleccion.digital_set.estado }}</span>
        {% else %}
          <span class="badge bg-secondary">Sin importaci√≥n</span>
        {% endif %}
      </div>
    </div>

    <div class="list-group mt-3">

      {# Paso 1 #}
      <div class="list-group-item d-flex justify-content-between align-items-start">
        <div class="me-3">
          <div class="fw-semibold">üì• Paso 1 ¬∑ Importar JPG / PDF</div>
          <div class="text-muted small">
            JPG: importar desde INBOX (temporal). PDF: subir archivo.
          </div>
        </div>
        <div class="text-end">
          <div class="mb-2">
            {% with total_pages=coleccion.digital_set.total_pages|default:0 %}
              {% if coleccion.digital_set and total_pages > 0 or coleccion.digital_set.pdf_path %}
                <span class="badge bg-success">Listo</span>
              {% else %}
                <span class="badge bg-warning text-dark">Pendiente</span>
              {% endif %}
            {% endwith %}
          </div>
          <div class="d-flex gap-2 justify-content-end flex-wrap">
            <a class="btn btn-sm btn-primary" href="{% url 'digitalizacion:importar' coleccion.id %}">Importar JPG (INBOX)</a>
            <a class="btn btn-sm btn-outline-primary" href="{% url 'digitalizacion:subir_pdf' coleccion.id %}">Subir PDF</a>
          </div>
        </div>
      </div>

      {# Paso 2 #}
      <div class="list-group-item d-flex justify-content-between align-items-start">
        <div class="me-3">
          <div class="fw-semibold">‚úÖ Paso 2 ¬∑ Revisar importaci√≥n</div>
          <div class="text-muted small">
            {% if coleccion.digital_set %}
              JPG: {{ coleccion.digital_set.total_pages|default:0 }} p√°ginas.
              {% if coleccion.digital_set.pdf_path %} ¬∑ PDF: cargado{% else %} ¬∑ PDF: no cargado{% endif %}
            {% else %}
              Importa JPG o sube PDF para continuar.
            {% endif %}
          </div>
        </div>
        <div class="text-end">
          {% with total_pages=coleccion.digital_set.total_pages|default:0 %}
            {% if coleccion.digital_set and total_pages > 0 or coleccion.digital_set.pdf_path %}
              <span class="badge bg-success">Listo</span>
            {% else %}
              <span class="badge bg-secondary">Bloqueado</span>
            {% endif %}
          {% endwith %}
        </div>
      </div>

      {# Paso 3 #}
      <div class="list-group-item d-flex justify-content-between align-items-start">
        <div class="me-3">
          <div class="fw-semibold">‚úÇÔ∏è Paso 3 ¬∑ Segmentar obras</div>
          <div class="text-muted small">Define rangos: ‚Äúde aqu√≠ a aqu√≠ es esta obra‚Äù.</div>
        </div>
        <div class="text-end">
          <div class="mb-2">
            {% if coleccion.digital_set and coleccion.digital_set.segments.all|length %}
              <span class="badge bg-success">Listo</span>
            {% elif coleccion.digital_set %}
              <span class="badge bg-warning text-dark">Pendiente</span>
            {% else %}
              <span class="badge bg-secondary">Bloqueado</span>
            {% endif %}
          </div>
          {% if coleccion.digital_set and coleccion.digital_set.total_pages|default:0 > 0 or coleccion.digital_set.pdf_path %}
            <a
              class="btn btn-sm btn-primary"
              href="{% url 'digitalizacion:segmentar' coleccion.id %}">
              Asignar segmentos
            </a>
          {% else %}
            <a
              class="btn btn-sm btn-primary disabled"
              aria-disabled="true" tabindex="-1"
              href="{% url 'digitalizacion:segmentar' coleccion.id %}">
              Asignar segmentos
            </a>
          {% endif %}
        </div>
      </div>

      {# Paso 4 #}
      <div class="list-group-item d-flex justify-content-between align-items-start">
        <div class="me-3">
          <div class="fw-semibold">üëÅÔ∏è Paso 4 ¬∑ Visualizar</div>
          <div class="text-muted small">Colecci√≥n completa y navegaci√≥n por segmentos.</div>
        </div>
        <div class="text-end">
          {% if coleccion.digital_set %}
            <div class="mb-2">
              <span class="badge bg-secondary">Segmentos: {{ coleccion.digital_set.segments.all|length }}</span>
            </div>
          {% else %}
            <div class="mb-2"><span class="badge bg-secondary">Bloqueado</span></div>
          {% endif %}

          <div class="d-flex gap-2 justify-content-end flex-wrap align-items-center">
            {% if coleccion.digital_set and coleccion.digital_set.total_pages|default:0 > 0 or coleccion.digital_set.pdf_path %}
              <a
                class="btn btn-sm btn-outline-primary"
                href="{% url 'digitalizacion:visor_coleccion' coleccion.id %}">
                Ver colecci√≥n
              </a>
            {% else %}
              <span class="btn btn-sm btn-outline-primary" style="opacity: 0.5; cursor: not-allowed;">Ver colecci√≥n</span>
            {% endif %}

            {% with segments=coleccion.digital_set.segments.all %}
              {% if segments|length == 1 %}
                {# Si hay solo un segmento, ir directo #}
                <a
                  class="btn btn-sm btn-outline-secondary"
                  href="{% url 'digitalizacion:visor_obra' segments.0.obra_id %}">
                  Ver obra: {{ segments.0.obra.signatura_publica_display }} ‚Äî {{ segments.0.obra.titulo_principal }}{% if segments.0.obra.autor_publico_principal %} ¬∑ {{ segments.0.obra.autor_publico_principal }}{% endif %}
                </a>
              {% elif segments|length > 1 %}
                {# Si hay varios segmentos, mostrar dropdown #}
                <div class="dropdown">
                  <button
                    class="btn btn-sm btn-outline-secondary dropdown-toggle"
                    type="button"
                    id="dropdownSegmentos"
                    data-bs-toggle="dropdown"
                    aria-expanded="false">
                    Ver obra
                  </button>
                  <ul class="dropdown-menu" aria-labelledby="dropdownSegmentos">
                    {% for seg in segments %}
                      <li>
                        <a class="dropdown-item" href="{% url 'digitalizacion:visor_obra' seg.obra_id %}">
                          {{ seg.obra.signatura_publica_display }} ‚Äî {{ seg.obra.titulo_principal }}{% if seg.obra.autor_publico_principal %} ¬∑ {{ seg.obra.autor_publico_principal }}{% endif %} (p√°gs. {{ seg.start_page }}‚Äì{{ seg.end_page }})
                        </a>
                      </li>
                    {% endfor %}
                  </ul>
                </div>
              {% else %}
                {# Si no hay segmentos, deshabilitado #}
                <span class="btn btn-sm btn-outline-secondary" style="opacity: 0.5; cursor: not-allowed;">Ver obra</span>
              {% endif %}
            {% endwith %}
          </div>
        </div>
      </div>

    </div>
  </div>
</div>
  <a class="btn btn-outline-secondary" href="{% url 'digitalizacion:dashboard' %}">Sleccionar otra Coleccion</a>
{% endblock %}
