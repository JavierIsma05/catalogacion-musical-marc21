{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'catalogacion/css/obra-general.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="page-container">
        <!-- Contenido del formulario -->
        <div class="form-content">
            <div class="obra-container">
                <!-- Header -->
                <div class="mb-4">
                    <h1 class="h3 mb-1">Registrar Obra General</h1>
                    <p class="text-muted mb-0">Catalogación MARC21 - Formato bibliográfico</p>
                </div>

                <form method="post" id="obraForm">
                    {% csrf_token %}

                    <!-- Cabecera -->
                    <div class="card border-0 shadow-sm mb-4" id="cabecera">
                        <div class="card-body">
                            <h2 class="section-title">Cabecera</h2>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label small">Tipo de Registro <span class="text-muted">(Líder/06)</span></label>
                                    <select name="tipo_registro" class="form-select" required>
                                        <option value="">Seleccionar...</option>
                                        <option value="c">c - Música notada manuscrita</option>
                                        <option value="d">d - Música notada impresa</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small">Nivel Bibliográfico <span class="text-muted">(Líder/07)</span></label>
                                    <select name="nivel_bibliografico" class="form-select" required>
                                        <option value="">Seleccionar...</option>
                                        <option value="m">m - Monografía</option>
                                        <option value="c">c - Colección</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small">Número de Control <span class="text-muted">(001)</span></label>
                                    <input type="text" name="num_control" class="form-control" placeholder="Ej: 001234">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 020 - ISBN (Repetible) -->
                    <div class="card border-0 shadow-sm mb-4" id="bloque-0xx">
                        <div class="card-body">
                            <h2 class="section-title">020 - ISBN</h2>
                            <div id="isbn-container">
                                <div class="campo-repetible" data-campo="isbn-0">
                                    <div class="campo-header">
                                        <span class="campo-label">ISBN #1</span>
                                        <button type="button" class="btn btn-outline-danger btn-remove" onclick="eliminarCampo('isbn-0')">
                                            <i class="bi bi-trash"></i> Eliminar
                                        </button>
                                    </div>
                                    <div class="row g-2">
                                        <div class="col-md-6">
                                            <label class="subcampo-label">$a ISBN</label>
                                            <input type="text" name="isbn_a_0" class="form-control" placeholder="978-0-123456-78-9">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="subcampo-label">$q Calificador</label>
                                            <input type="text" name="isbn_q_0" class="form-control" placeholder="Ej: rústica">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-add-field" onclick="agregarISBN()">
                                <i class="bi bi-plus-circle"></i> Agregar ISBN
                            </button>
                        </div>
                    </div>

                    <!-- 024 - ISMN (Repetible) -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-body">
                            <h2 class="section-title">024 - ISMN (Número Internacional Normalizado de Música)</h2>
                            <div id="ismn-container">
                                <div class="campo-repetible" data-campo="ismn-0">
                                    <div class="campo-header">
                                        <span class="campo-label">ISMN #1</span>
                                        <button type="button" class="btn btn-outline-danger btn-remove" onclick="eliminarCampo('ismn-0')">
                                            <i class="bi bi-trash"></i> Eliminar
                                        </button>
                                    </div>
                                    <div class="row g-2">
                                        <div class="col-md-12">
                                            <label class="subcampo-label">$a ISMN</label>
                                            <input type="text" name="ismn_a_0" class="form-control" placeholder="M-001-12345-6-7">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-add-field" onclick="agregarISMN()">
                                <i class="bi bi-plus-circle"></i> Agregar ISMN
                            </button>
                        </div>
                    </div>

                    <!-- 028 - Número de Editor (Repetible) -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-body">
                            <h2 class="section-title">028 - Número de Editor de Música</h2>
                            <div id="numero-editor-container">
                                <div class="campo-repetible" data-campo="numero-editor-0">
                                    <div class="campo-header">
                                        <span class="campo-label">Número de Editor #1</span>
                                        <button type="button" class="btn btn-outline-danger btn-remove" onclick="eliminarCampo('numero-editor-0')">
                                            <i class="bi bi-trash"></i> Eliminar
                                        </button>
                                    </div>
                                    <div class="row g-2 mb-2">
                                        <div class="col-md-12">
                                            <label class="subcampo-label">$a Número de Editor</label>
                                            <input type="text" name="numero_editor_a_0" class="form-control" placeholder="Ej: B. & H. 8797">
                                        </div>
                                    </div>
                                    <div class="row g-2">
                                        <div class="col-md-6">
                                            <label class="subcampo-label">Indicador 1 - Tipo de Número</label>
                                            <select name="numero_editor_tipo_0" class="form-select">
                                                <option value="0">0 - Número de publicación</option>
                                                <option value="1">1 - Número de matriz</option>
                                                <option value="2" selected>2 - Número de plancha</option>
                                                <option value="3">3 - Otro número de música</option>
                                                <option value="4">4 - Número de videograbación</option>
                                                <option value="5">5 - Otro número de editor</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="subcampo-label">Indicador 2 - Control de Nota</label>
                                            <select name="numero_editor_control_0" class="form-select">
                                                <option value="0" selected>0 - No hay nota ni punto de acceso adicional</option>
                                                <option value="1">1 - Nota, hay punto de acceso adicional</option>
                                                <option value="2">2 - Nota, no hay punto de acceso adicional</option>
                                                <option value="3">3 - No hay nota, hay punto de acceso adicional</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-add-field" onclick="agregarNumeroEditor()">
                                <i class="bi bi-plus-circle"></i> Agregar Número de Editor
                            </button>
                        </div>
                    </div>

                    <!-- 031 - Incipit Musical (Repetible con URLs repetibles) -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-body">
                            <h2 class="section-title">031 - Incipit Musical</h2>
                            <div id="incipit-container">
                                <div class="campo-repetible" data-campo="incipit-0">
                                    <div class="campo-header">
                                        <span class="campo-label">Incipit #1</span>
                                        <button type="button" class="btn btn-outline-danger btn-remove" onclick="eliminarCampo('incipit-0')">
                                            <i class="bi bi-trash"></i> Eliminar
                                        </button>
                                    </div>

                                    <div class="row g-2 mb-2">
                                        <div class="col-md-4">
                                            <label class="subcampo-label">$a Número de Obra</label>
                                            <input type="number" name="incipit_a_0" class="form-control" placeholder="1" value="1" min="1">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="subcampo-label">$b Número de Movimiento</label>
                                            <input type="number" name="incipit_b_0" class="form-control" placeholder="1" value="1" min="1">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="subcampo-label">$c Número de Pasaje</label>
                                            <input type="number" name="incipit_c_0" class="form-control" placeholder="1" value="1" min="1">
                                        </div>
                                    </div>

                                    <div class="row g-2 mb-2">
                                        <div class="col-md-6">
                                            <label class="subcampo-label">$d Título o Encabezamiento (opcional)</label>
                                            <input type="text" name="incipit_d_0" class="form-control" placeholder="Ej: Aria, Allegro, Andante">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="subcampo-label">$m Voz/Instrumento (opcional)</label>
                                            <input type="text" name="incipit_m_0" class="form-control" placeholder="Ej: V (solo si NO es piano)">
                                        </div>
                                    </div>

                                    <div class="row g-2 mb-3">
                                        <div class="col-md-12">
                                            <label class="subcampo-label">$p Notación Musical (opcional)</label>
                                            <textarea name="incipit_p_0" class="form-control" rows="2" placeholder="Código de incipit musical (Plaine & Easie, MusicXML, ABC)"></textarea>
                                        </div>
                                    </div>

                                    <!-- URLs repetibles para este incipit -->
                                    <div class="subcampo-group">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <label class="subcampo-label mb-0">$u URL Uniforme de Recursos</label>
                                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="agregarURLIncipit(0)">
                                                <i class="bi bi-plus"></i> URL
                                            </button>
                                        </div>
                                        <div id="incipit-0-urls">
                                            <div class="mb-2" data-subcampo="url-0-0">
                                                <div class="input-group input-group-sm">
                                                    <input type="url" name="incipit_u_0_0" class="form-control" placeholder="https://...">
                                                    <button type="button" class="btn btn-outline-danger" onclick="eliminarSubcampo('url-0-0')">
                                                        <i class="bi bi-x"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-add-field" onclick="agregarIncipit()">
                                <i class="bi bi-plus-circle"></i> Agregar Incipit
                            </button>
                        </div>
                    </div>

                    <!-- 040 - Fuente de Catalogación -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-body">
                            <h2 class="section-title">040 - Fuente de Catalogación</h2>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label small">$a Centro Catalogador</label>
                                    <input type="text" name="centro_catalogador" class="form-control" value="UNL" placeholder="UNL" maxlength="10">
                                    <small class="text-muted">Predeterminado: UNL</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 041 - Código de Lengua (Repetible con idiomas repetibles) -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-body">
                            <h2 class="section-title">041 - Código de Lengua</h2>
                            <div id="codigo-lengua-container">
                                <div class="campo-repetible" data-campo="codigo-lengua-0">
                                    <div class="campo-header">
                                        <span class="campo-label">Código de Lengua #1</span>
                                        <button type="button" class="btn btn-outline-danger btn-remove" onclick="eliminarCampo('codigo-lengua-0')">
                                            <i class="bi bi-trash"></i> Eliminar
                                        </button>
                                    </div>

                                    <div class="row g-2 mb-3">
                                        <div class="col-md-6">
                                            <label class="subcampo-label">Indicador 1 - Código de Traducción</label>
                                            <select name="codigo_lengua_ind1_0" class="form-select">
                                                <option value="#"># - No se proporciona información</option>
                                                <option value="0" selected>0 - No es traducción</option>
                                                <option value="1">1 - Es traducción</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="subcampo-label">Indicador 2 - Código de Fuente</label>
                                            <select name="codigo_lengua_ind2_0" class="form-select">
                                                <option value="#" selected># - Código MARC de lengua</option>
                                                <option value="7">7 - Fuente especificada en $2</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Idiomas repetibles -->
                                    <div class="subcampo-group">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <label class="subcampo-label mb-0">$a Código de Lengua del Texto/Banda Sonora</label>
                                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="agregarIdiomaObra(0)">
                                                <i class="bi bi-plus"></i> Idioma
                                            </button>
                                        </div>
                                        <div id="codigo-lengua-0-idiomas">
                                            <div class="mb-2" data-subcampo="idioma-0-0">
                                                <div class="input-group input-group-sm">
                                                    <select name="codigo_lengua_a_0_0" class="form-select form-select-sm">
                                                        <option value="ger">Alemán</option>
                                                        <option value="spa" selected>Español</option>
                                                        <option value="fre">Francés</option>
                                                        <option value="eng">Inglés</option>
                                                        <option value="ita">Italiano</option>
                                                        <option value="por">Portugués</option>
                                                    </select>
                                                    <button type="button" class="btn btn-outline-danger" onclick="eliminarSubcampo('idioma-0-0')">
                                                        <i class="bi bi-x"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-add-field" onclick="agregarCodigoLengua()">
                                <i class="bi bi-plus-circle"></i> Agregar Código de Lengua
                            </button>
                        </div>
                    </div>

                    <!-- 044 - Código de País (Repetible) -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-body">
                            <h2 class="section-title">044 - Código de País de Entidad Productora/Editora</h2>
                            <div id="codigo-pais-container">
                                <div class="campo-repetible" data-campo="codigo-pais-0">
                                    <div class="campo-header">
                                        <span class="campo-label">Código de País #1</span>
                                        <button type="button" class="btn btn-outline-danger btn-remove" onclick="eliminarCampo('codigo-pais-0')">
                                            <i class="bi bi-trash"></i> Eliminar
                                        </button>
                                    </div>
                                    <div class="row g-2">
                                        <div class="col-md-12">
                                            <label class="subcampo-label">$a Código de País</label>
                                            <select name="codigo_pais_a_0" class="form-select">
                                                <option value="ar">Argentina</option>
                                                <option value="bo">Bolivia</option>
                                                <option value="br">Brasil</option>
                                                <option value="cl">Chile</option>
                                                <option value="co">Colombia</option>
                                                <option value="cr">Costa Rica</option>
                                                <option value="cu">Cuba</option>
                                                <option value="ec" selected>Ecuador</option>
                                                <option value="sv">El Salvador</option>
                                                <option value="gt">Guatemala</option>
                                                <option value="ho">Honduras</option>
                                                <option value="mx">México</option>
                                                <option value="nq">Nicaragua</option>
                                                <option value="pa">Panamá</option>
                                                <option value="pe">Perú</option>
                                                <option value="pr">Puerto Rico</option>
                                                <option value="dr">República Dominicana</option>
                                                <option value="uy">Uruguay</option>
                                                <option value="ve">Venezuela</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-add-field" onclick="agregarCodigoPais()">
                                <i class="bi bi-plus-circle"></i> Agregar Código de País
                            </button>
                        </div>
                    </div>

                    <!-- 092 - Clasificación Local -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-body">
                            <h2 class="section-title">092 - Clasificación Local</h2>
                            <div class="alert alert-info" role="alert">
                                <i class="bi bi-info-circle"></i>
                                <small>Los campos de este bloque se generan automáticamente a partir de otros campos. Se completan al guardar la obra.</small>
                            </div>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label small">$a Institución</label>
                                    <input type="text" name="clasif_institucion" class="form-control" value="UNL" readonly disabled>
                                    <small class="text-muted">Copia del campo 040 $a</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small">$b Proyecto</label>
                                    <input type="text" name="clasif_proyecto" class="form-control" value="BLMP" readonly disabled>
                                    <small class="text-muted">Predeterminado: BLMP</small>
                                </div>
                            </div>
                            <div class="row g-3 mt-2">
                                <div class="col-md-4">
                                    <label class="form-label small">$c País</label>
                                    <input type="text" name="clasif_pais" class="form-control" readonly disabled placeholder="Del campo 044 $a">
                                    <small class="text-muted">Copia del primer país (044 $a)</small>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small">$d Ms/Imp</label>
                                    <input type="text" name="clasif_ms_imp" class="form-control" readonly disabled placeholder="Ms o Imp">
                                    <small class="text-muted">Según tipo de registro (Líder/06)</small>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small">$0 Número de Control</label>
                                    <input type="text" name="clasif_num_control" class="form-control" readonly disabled placeholder="Del campo 001">
                                    <small class="text-muted">Copia del campo 001</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Botones -->
                    <div class="d-flex gap-2 justify-content-end">
                        <a href="{% url 'index' %}" class="btn btn-outline-secondary">Cancelar</a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> Guardar Obra
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Sidebar de navegación -->
        <div class="sidebar-nav">
            <nav>
                <div class="nav-section">
                    <div class="nav-section-title">Navegación</div>
                    <a href="#cabecera" class="nav-link active">Cabecera</a>
                    <a href="#bloque-0xx" class="nav-link">0XX - Campos de Control</a>
                </div>
            </nav>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- SOLO cargar campos-repetibles.js - contiene todas las funciones necesarias -->
<script src="{% static 'catalogacion/js/campos-repetibles.js' %}"></script>
<script src="{% static 'catalogacion/js/obra-general.js' %}"></script>
{% endblock %}