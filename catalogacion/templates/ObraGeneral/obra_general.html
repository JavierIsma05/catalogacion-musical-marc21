{% extends 'base.html' %} {% load static %} {% block title %}Registrar Obra
MARC21 Musical{% endblock %} {% block extra_css %}
<link
    href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
    rel="stylesheet"
/>
<link
    href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css"
    rel="stylesheet"
/>
<link rel="stylesheet" href="{% static 'css/styles.css' %}" />
{% endblock %} {% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <!-- üî∏ COLUMNA IZQUIERDA -->
        <div class="col-md-9">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">üìÑ Registro MARC21 Musical</h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        {% csrf_token %}

                        <!-- Errores generales -->
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ form.non_field_errors }}
                        </div>
                        {% endif %}

                        <!-- üü© CABECERA O L√çDER -->
                        <h5 class="text-primary" id="cabecera">
                            üü© Cabecera o L√≠der
                        </h5>
                        <div class="marc-block mb-4">
                            <div class="row mb-2">
                                <div class="col-md-6">
                                    <label
                                        ><strong>06</strong> ‚Äì Tipo de
                                        registro</label
                                    >
                                    {{ form.tipo_registro }}
                                </div>
                                <div class="col-md-6">
                                    <label
                                        ><strong>07</strong> ‚Äì Nivel
                                        bibliogr√°fico</label
                                    >
                                    {{ form.nivel_bibliografico }}
                                </div>
                            </div>
                        </div>

                        <!-- üü® BLOQUE 0XX -->
                        <h5 class="text-primary mt-4" id="bloque-0xx">
                            üü® Bloque 0XX ‚Äì Campos de longitud variable
                        </h5>

                        <!-- 020 ## ISBN -->
                        <div class="marc-block mb-4">
                            <h6>
                                <strong>020 ##</strong> ‚Äî N√∫mero Internacional
                                Normalizado para Libros (ISBN)
                            </h6>
                            <div class="row align-items-center mb-2">
                                <div class="col-md-4">
                                    <label>$a ISBN</label>
                                </div>
                                <div class="col-md-8">{{ form.isbn }}</div>
                            </div>
                        </div>

                        <!-- 024 2# ISMN -->
                        <div class="marc-block mb-4">
                            <h6>
                                <strong>024 2#</strong> ‚Äî Otros identificadores
                                normalizados (ISMN)
                            </h6>
                            <div class="row align-items-center mb-2">
                                <div class="col-md-4">
                                    <label>$a ISMN</label>
                                </div>
                                <div class="col-md-8">{{ form.ismn }}</div>
                            </div>
                        </div>

                        <!-- 028 20 N√∫mero de editor -->
                        <div class="marc-block mb-4">
                            <h6>
                                <strong>028 20</strong> ‚Äî N√∫mero de editor o
                                distribuidor
                            </h6>
                            <div class="row mb-2">
                                <div class="col-md-4">
                                    <label>$a N√∫mero de editor</label>
                                </div>
                                <div class="col-md-8">
                                    {{ form.numero_editor }}
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <label>Indicador</label>
                                </div>
                                <div class="col-md-8">
                                    {{ form.indicador_028 }}
                                </div>
                            </div>
                        </div>

                        <!-- 031 ## √çncipit musical -->
                        <div class="marc-block mb-4">
                            <h6>
                                <strong>031 ##</strong> ‚Äî Informaci√≥n del
                                √≠ncipit musical
                            </h6>
                            <div class="row mb-2">
                                <div class="col-md-4">
                                    <label>$a N¬∫ de obra</label>
                                </div>
                                <div class="col-md-8">
                                    {{ form.incipit_num_obra }}
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-4">
                                    <label>$b N¬∫ de movimiento</label>
                                </div>
                                <div class="col-md-8">
                                    {{ form.incipit_num_movimiento }}
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-4">
                                    <label>$c N¬∫ de pasaje</label>
                                </div>
                                <div class="col-md-8">
                                    {{ form.incipit_num_pasaje }}
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-4">
                                    <label>$d T√≠tulo o encabezamiento</label>
                                </div>
                                <div class="col-md-8">
                                    {{ form.incipit_titulo }}
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-4">
                                    <label>$m Voz/instrumento</label>
                                </div>
                                <div class="col-md-8">
                                    {{ form.incipit_voz_instrumento }}
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-4">
                                    <label>$p Notaci√≥n musical</label>
                                </div>
                                <div class="col-md-8">
                                    {{ form.incipit_notacion }}
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <label>$u URL (√≠ncipit externo)</label>
                                </div>
                                <div class="col-md-8">
                                    {{ form.incipit_url }}
                                </div>
                            </div>
                        </div>

                        <!-- 040 ## Fuente de catalogaci√≥n -->
                        <div class="marc-block mb-4">
                            <h6>
                                <strong>040 ##</strong> ‚Äî Fuente de catalogaci√≥n
                            </h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <label>$a Centro catalogador</label>
                                </div>
                                <div class="col-md-8">
                                    {{ form.centro_catalogador }}
                                </div>
                            </div>
                        </div>

                        <!-- 041 0# C√≥digo de lengua -->
                        <div class="marc-block mb-4">
                            <h6><strong>041 0#</strong> ‚Äî C√≥digo de lengua</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <label>$a Idioma</label>
                                </div>
                                <div class="col-md-8">
                                    {{ form.codigo_lengua }}
                                </div>
                            </div>
                        </div>

                        <!-- 044 ## C√≥digo del pa√≠s -->
                        <div class="marc-block mb-4">
                            <h6>
                                <strong>044 ##</strong> ‚Äî Pa√≠s de la entidad
                                editora/productora
                            </h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <label>$a Pa√≠s</label>
                                </div>
                                <div class="col-md-8">
                                    {{ form.codigo_pais }}
                                </div>
                            </div>
                        </div>

                        <!-- 092 ## Clasificaci√≥n local -->
                        <div class="marc-block mb-4">
                            <h6>
                                <strong>092 ##</strong> ‚Äî Clasificaci√≥n local
                            </h6>
                            <div class="row mb-2">
                                <div class="col-md-4">
                                    <label>$a Instituci√≥n</label>
                                </div>
                                <div class="col-md-8">
                                    {{ form.clasif_institucion }}
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-4">
                                    <label>$b Proyecto</label>
                                </div>
                                <div class="col-md-8">
                                    {{ form.clasif_proyecto }}
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-4">
                                    <label>$c Pa√≠s</label>
                                </div>
                                <div class="col-md-8">
                                    {{ form.clasif_pais }}
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <label>$d Ms/Imp</label>
                                </div>
                                <div class="col-md-8">
                                    {{ form.clasif_ms_imp }}
                                </div>
                            </div>
                        </div>

                        <!-- üü¶ BLOQUE 1XX -->
                        <h5 class="text-primary mt-4" id="bloque-1xx">
                            üü¶ Bloque 1XX ‚Äì Asientos principales (punto de
                            acceso)
                        </h5>

                        <!-- 100 1# Compositor -->
<div class="marc-block mb-4">
    <h6><strong>100 1#</strong> ‚Äî Compositor (NR)</h6>
    <div class="row mb-2">
        <div class="col-md-4"><label for="id_compositor_select">$a Apellidos, Nombres</label></div>
        <div class="col-md-8">
            {{ form.compositor_select }}
            {% if form.compositor_select.errors %}
            <div class="text-danger">{{ form.compositor_select.errors }}</div>
            {% endif %}
        </div>
    </div>
    <div class="row mb-2">
        <div class="col-md-4"><label for="id_compositor_fechas">$d Coordenadas biogr√°ficas</label></div>
        <div class="col-md-8">
            {{ form.compositor_fechas }}
            {% if form.compositor_fechas.errors %}
            <div class="text-danger">{{ form.compositor_fechas.errors }}</div>
            {% endif %}
        </div>
    </div>
    <div class="row mb-2">
        <div class="col-md-4"><label for="id_compositor_funcion">$e Funci√≥n</label></div>
        <div class="col-md-8">{{ form.compositor_funcion }}</div>
    </div>
    <div class="row">
        <div class="col-md-4"><label for="id_compositor_autoria">$j Autor√≠a</label></div>
        <div class="col-md-8">{{ form.compositor_autoria }}</div>
    </div>
</div>

                        <!-- 130 0# T√≠tulo uniforme -->
<div class="marc-block mb-4">
    <h6><strong>130 0#</strong> ‚Äî T√≠tulo uniforme (punto de acceso principal) (NR)</h6>
    <div class="row mb-2">
        <div class="col-md-4"><label for="id_titulo_uniforme_130">$a T√≠tulo uniforme</label></div>
        <div class="col-md-8">
            {{ form.titulo_uniforme_130 }}
            {% if form.titulo_uniforme_130.errors %}
            <div class="text-danger">{{ form.titulo_uniforme_130.errors }}</div>
            {% endif %}
        </div>
    </div>
    <div class="row mb-2">
        <div class="col-md-4"><label for="id_titulo_uniforme_130_forma">$k Subencabezamiento de forma</label></div>
        <div class="col-md-8">
            {{ form.titulo_uniforme_130_forma }}
            {% if form.titulo_uniforme_130_forma.errors %}
            <div class="text-danger">{{ form.titulo_uniforme_130_forma.errors }}</div>
            {% endif %}
        </div>
    </div>
    <div class="row mb-2">
        <div class="col-md-4"><label for="id_titulo_uniforme_medio_interpretacion">$m Medio de interpretaci√≥n</label></div>
        <div class="col-md-8">{{ form.titulo_uniforme_medio_interpretacion }}</div>
    </div>
    <div class="row mb-2">
        <div class="col-md-4"><label for="id_titulo_uniforme_num_parte">$n N√∫mero de parte/secci√≥n</label></div>
        <div class="col-md-8">{{ form.titulo_uniforme_num_parte }}</div>
    </div>
    <div class="row mb-2">
        <div class="col-md-4"><label for="id_titulo_uniforme_arreglo">$o Arreglo</label></div>
        <div class="col-md-8">{{ form.titulo_uniforme_arreglo }}</div>
    </div>
    <div class="row mb-2">
        <div class="col-md-4"><label for="id_titulo_uniforme_nombre_parte">$p Nombre de parte/secci√≥n</label></div>
        <div class="col-md-8">{{ form.titulo_uniforme_nombre_parte }}</div>
    </div>
    <div class="row">
        <div class="col-md-4"><label for="id_titulo_uniforme_tonalidad">$r Tonalidad</label></div>
        <div class="col-md-8">{{ form.titulo_uniforme_tonalidad }}</div>
    </div>
</div>

                        <!-- üü© BLOQUE 2XX -->
                        <h5 class="text-primary mt-4" id="bloque-2xx">
                            üü© Bloque 2XX ‚Äì T√≠tulos y menci√≥n de responsabilidad
                        </h5>

                        <!-- 240 10 T√≠tulo uniforme -->
<div class="marc-block mb-4">
    <h6><strong>240 10</strong> ‚Äî T√≠tulo uniforme (NR)</h6>
    <div class="row mb-2">
        <div class="col-md-4"><label for="id_titulo_240_select">$a T√≠tulo uniforme</label></div>
        <div class="col-md-8">
            {{ form.titulo_240_select }}
            {% if form.titulo_240_select.errors %}
            <div class="text-danger">{{ form.titulo_240_select.errors }}</div>
            {% endif %}
        </div>
    </div>
    <div class="row mb-2">
        <div class="col-md-4"><label for="id_titulo_240_forma_select">$k Subencabezamiento de forma</label></div>
        <div class="col-md-8">
            {{ form.titulo_240_forma_select }}
            {% if form.titulo_240_forma_select.errors %}
            <div class="text-danger">{{ form.titulo_240_forma_select.errors }}</div>
            {% endif %}
        </div>
    </div>
    <div class="row mb-2">
        <div class="col-md-4"><label for="id_titulo_240_medio_interpretacion">$m Medio de interpretaci√≥n</label></div>
        <div class="col-md-8">{{ form.titulo_240_medio_interpretacion }}</div>
    </div>
    <div class="row mb-2">
        <div class="col-md-4"><label for="id_titulo_240_num_parte">$n N√∫mero de parte/secci√≥n</label></div>
        <div class="col-md-8">{{ form.titulo_240_num_parte }}</div>
    </div>
    <div class="row mb-2">
        <div class="col-md-4"><label for="id_titulo_240_arreglo">$o Arreglo</label></div>
        <div class="col-md-8">{{ form.titulo_240_arreglo }}</div>
    </div>
    <div class="row mb-2">
        <div class="col-md-4"><label for="id_titulo_240_nombre_parte">$p Nombre de parte/secci√≥n</label></div>
        <div class="col-md-8">{{ form.titulo_240_nombre_parte }}</div>
    </div>
    <div class="row">
        <div class="col-md-4"><label for="id_titulo_240_tonalidad">$r Tonalidad</label></div>
        <div class="col-md-8">{{ form.titulo_240_tonalidad }}</div>
    </div>
</div>

                        <!-- 245 10 T√≠tulo principal -->
                        <div class="marc-block mb-4">
                            <h6>
                                <strong>245 10</strong> ‚Äî Menci√≥n de t√≠tulo (NR)
                            </h6>
                            <div class="row mb-2">
                                <div class="col-md-4">
                                    <label>$a T√≠tulo principal *</label>
                                </div>
                                <div class="col-md-8">
                                    {{ form.titulo_principal }}
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-4">
                                    <label>$b Resto del t√≠tulo</label>
                                </div>
                                <div class="col-md-8">
                                    {{ form.resto_titulo }}
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-4">
                                    <label>$c Menci√≥n de responsabilidad</label>
                                </div>
                                <div class="col-md-8">
                                    {{ form.mencion_responsabilidad }}
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-4">
                                    <label>$n N√∫mero de parte/secci√≥n</label>
                                </div>
                                <div class="col-md-8">
                                    {{ form.numero_parte_245 }}
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <label>$p Nombre de parte/secci√≥n</label>
                                </div>
                                <div class="col-md-8">
                                    {{ form.nombre_parte_245 }}
                                </div>
                            </div>
                        </div>

                        <!-- 246 ## Variante de t√≠tulo -->
                        <div class="marc-block mb-4">
                            <h6>
                                <strong>246 ##</strong> ‚Äî Forma variante del
                                t√≠tulo (R)
                            </h6>
                            <div class="row mb-2">
                                <div class="col-md-4">
                                    <label>$a T√≠tulo variante</label>
                                </div>
                                <div class="col-md-8">
                                    {{ form.titulo_variante }}
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <label>$b Resto del t√≠tulo variante</label>
                                </div>
                                <div class="col-md-8">
                                    {{ form.resto_titulo_variante }}
                                </div>
                            </div>
                        </div>

                        <!-- 254 ## Presentaci√≥n musical -->
                        <div class="marc-block mb-4">
                            <h6>
                                <strong>254 ##</strong> ‚Äî Presentaci√≥n musical
                                (NR)
                            </h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <label>$a Presentaci√≥n musical</label>
                                </div>
                                <div class="col-md-8">
                                    {{ form.presentacion_musical }}
                                </div>
                            </div>
                        </div>

                        <div class="marc-block mb-4">
                            <h6>
                                <strong>260 ##</strong> ‚Äî Publicaci√≥n,
                                distribuci√≥n, etc. (R)
                                <!-- <span class="badge bg-warning text-dark"
                                    >DEPRECATED</span
                                > -->
                            </h6>
                            <!-- <div class="alert alert-warning">
                                <strong>‚ö†Ô∏è Nota:</strong> Este campo est√°
                                obsoleto. Se recomienda usar el campo 264 en su
                                lugar.
                            </div> -->
                            <div class="row mb-2">
                                <div class="col-md-4">
                                    <label>$a Lugar de publicaci√≥n</label>
                                </div>
                                <div class="col-md-8">
                                    {{ form.lugar_publicacion }}
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-4">
                                    <label>$b Nombre del editor</label>
                                </div>
                                <div class="col-md-8">
                                    {{ form.nombre_editor }}
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <label>$c Fecha de publicaci√≥n</label>
                                </div>
                                <div class="col-md-8">
                                    {{ form.fecha_publicacion }}
                                </div>
                            </div>
                        </div>

                        <!-- 300 ## Descripci√≥n f√≠sica -->
                        <div class="marc-block mb-4">
                            <h6>
                                <strong>300 ##</strong> ‚Äî Descripci√≥n f√≠sica (R)
                            </h6>
                            <div class="row mb-2">
                                <div class="col-md-4">
                                    <label>$a Extensi√≥n</label>
                                </div>
                                <div class="col-md-8">{{ form.extension }}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-4">
                                    <label>$b Otros detalles f√≠sicos</label>
                                </div>
                                <div class="col-md-8">
                                    {{ form.otros_detalles_fisicos }}
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-4">
                                    <label>$c Dimensiones</label>
                                </div>
                                <div class="col-md-8">
                                    {{ form.dimensiones }}
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <label>$e Material acompa√±ante</label>
                                </div>
                                <div class="col-md-8">
                                    {{ form.material_acompanante }}
                                </div>
                            </div>
                        </div>

                        <!-- Botones -->
                        <div class="d-flex gap-3 mt-4">
                            <button
                                type="submit"
                                name="guardar_continuar"
                                class="btn btn-success"
                            >
                                üíæ Guardar y continuar editando
                            </button>
                            <button
                                type="submit"
                                name="guardar_cerrar"
                                class="btn btn-primary"
                            >
                                ‚úÖ Guardar y cerrar
                            </button>
                            <a
                                href"#"
                                class="btn btn-secondary"
                            >
                                ‚ùå Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- üü¶ TABLA DE OBRAS -->
            <div class="card shadow-sm mt-3">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0">üìã Obras registradas</h6>
                </div>
                <div class="card-body">
                    <table class="table table-bordered table-striped mt-2">
                        <thead class="table-success">
                            <tr>
                                <th>001 N¬∫ Control</th>
                                <th>100 Compositor</th>
                                <th>130 T√≠tulo uniforme</th>
                                <th>020 ISBN</th>
                                <th>024 ISMN</th>
                                <th>044 Pa√≠s</th>
                                <th>041 Idioma</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for obra in obras %}
                            <tr>
                                <td>{{ obra.num_control }}</td>
                                <td>
                                    {{
                                    obra.compositor.apellidos_nombres|default:"-"
                                    }}
                                </td>
                                <td>
                                    {{ obra.titulo_uniforme.titulo|default:"-"
                                    }}
                                </td>
                                <td>{{ obra.isbn|default:"-" }}</td>
                                <td>{{ obra.ismn|default:"-" }}</td>
                                <td>{{ obra.get_codigo_pais_display }}</td>
                                <td>{{ obra.get_codigo_lengua_display }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center">
                                    No hay registros a√∫n.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- üîπ COLUMNA DERECHA -->
        <div class="col-md-3">
            <div class="sidebar rounded shadow-sm p-3 bg-white">
                <h6 class="fw-bold mb-3">üìã Navegaci√≥n MARC21</h6>
                <a href="#cabecera" class="d-block mb-2 text-decoration-none"
                    >üü© Cabecera o L√≠der</a
                >
                <a href="#bloque-0xx" class="d-block mb-2 text-decoration-none"
                    >üü® Bloque 0XX - Campos variables</a
                >
                <a href="#bloque-1xx" class="d-block mb-2 text-decoration-none"
                    >üü¶ Bloque 1XX - Asientos principales</a
                >
                <a href="#bloque-2xx" class="d-block mb-2 text-decoration-none"
                    >üü© Bloque 2XX - T√≠tulos</a
                >
                <hr />
                <h6 class="fw-bold mb-3">üéØ Acciones</h6>
                <a
                    href="#"
                    class="d-block mb-2 text-decoration-none"
                    onclick="document.querySelector('form').submit(); return false;"
                    >üíæ Guardar borrador</a
                >
                <a href="#" class="d-block mb-2 text-decoration-none"
                    >üîç Vista preliminar</a
                >
            </div>
        </div>
    </div>
</div>
{% endblock %} {% block extra_js %}
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- Tabs.js (tu archivo personalizado) -->
<script src="{% static 'js/tabs.js' %}"></script>

<!-- Configuraci√≥n Select2 con Autoridades -->
<script>
    $(document).ready(function () {
        // Cargar todas las autoridades al inicio
        var autoridadesCache = {
            compositor: [],
            titulo_uniforme: [],
            forma_musical: [],
        };

        // Precargar autoridades
        function preloadAutoridades(modelType) {
            $.ajax({
                url: '{% url "get_autoridades_json" %}',
                data: { model: modelType, q: "" },
                dataType: "json",
                async: false,
                success: function (data) {
                    autoridadesCache[modelType] = data.results;
                },
            });
        }

        // Precargar todas las autoridades
        preloadAutoridades("compositor");
        preloadAutoridades("titulo_uniforme");
        preloadAutoridades("forma_musical");

        // Configuraci√≥n para cada campo con Select2
        function initializeSelect2Tagging(fieldId, modelType) {
            var $field = $("#" + fieldId);
            var initialValue = $field.val();

            // Construir opciones iniciales
            var data = autoridadesCache[modelType].map(function (item) {
                return {
                    id: item.id,
                    text: item.text,
                    fechas: item.fechas,
                };
            });

            $field.select2({
                theme: "bootstrap-5",
                tags: true,
                data: data,
                placeholder: $field.attr("placeholder"),
                allowClear: true,
                width: "100%",
                createTag: function (params) {
                    var term = $.trim(params.term);

                    if (term === "") {
                        return null;
                    }

                    // Verificar si ya existe
                    var exists = false;
                    data.forEach(function (item) {
                        if (item.id.toLowerCase() === term.toLowerCase()) {
                            exists = true;
                        }
                    });

                    if (exists) {
                        return null;
                    }

                    return {
                        id: term,
                        text: term,
                        newTag: true,
                    };
                },
                templateResult: function (data) {
                    if (data.loading) {
                        return "Buscando...";
                    }

                    var $result = $("<span></span>");

                    if (data.newTag) {
                        $result.html(
                            '<strong style="color: #198754;">‚ú® Crear nuevo:</strong> ' +
                                data.text
                        );
                    } else {
                        $result.text(data.text);
                    }

                    return $result;
                },
                templateSelection: function (data) {
                    return data.text || data.id;
                },
            });

            // Si hay valor inicial, seleccionarlo
            if (initialValue && initialValue.trim() !== "") {
                var found = false;
                data.forEach(function (item) {
                    if (item.id === initialValue) {
                        $field.val(item.id).trigger("change");
                        found = true;
                    }
                });

                if (!found) {
                    var newOption = new Option(
                        initialValue,
                        initialValue,
                        true,
                        true
                    );
                    $field.append(newOption).trigger("change");
                }
            }

            // Manejar el evento de selecci√≥n para forzar actualizaci√≥n
            $field.on("select2:select", function (e) {
                var data = e.params.data;

                if (data.newTag) {
                    $field.find("option").each(function () {
                        if ($(this).val() === data.id && $(this).data("temp")) {
                            $(this).remove();
                        }
                    });

                    var newOption = new Option(data.id, data.id, true, true);
                    $field.append(newOption);
                    $field.val(data.id).trigger("change.select2");
                    $field.select2("close");
                }
            });
        }

        // Inicializar todos los campos
        initializeSelect2Tagging("id_compositor_select", "compositor");
        initializeSelect2Tagging("id_titulo_uniforme_130", "titulo_uniforme");
        initializeSelect2Tagging(
            "id_titulo_uniforme_130_forma",
            "forma_musical"
        );
        initializeSelect2Tagging("id_titulo_240_select", "titulo_uniforme");
        initializeSelect2Tagging("id_titulo_240_forma_select", "forma_musical");

        // Sincronizar fechas del compositor
        $("#id_compositor_select").on("select2:select", function (e) {
            var data = e.params.data;
            console.log("Compositor seleccionado:", data);

            if (data.fechas) {
                $("#id_compositor_fechas").val(data.fechas);
            } else if (data.newTag) {
                $("#id_compositor_fechas").val("").focus();
            }
        });

        $("#id_compositor_select").on(
            "select2:unselect select2:clear",
            function (e) {
                console.log("Compositor removido");
                $(this).val(null).trigger("change");
                $("#id_compositor_fechas").val("");
            }
        );

        $(".form-control[data-model]").on("select2:clear", function (e) {
            console.log("Campo limpiado:", this.id);
            $(this).val(null).trigger("change");
        });
    });
</script>
{% endblock %}
