{% load static %}
<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Prueba Campo 300 - MARC21</title>

        <!-- Bootstrap 5.3 -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <!-- Bootstrap Icons -->
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
        />

        <style>
            :root {
                --primary-color: #2563eb;
                --secondary-color: #64748b;
                --success-color: #16a34a;
                --danger-color: #dc2626;
                --border-color: #e2e8f0;
            }

            body {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                padding: 2rem 0;
            }

            .main-card {
                background: white;
                border-radius: 1rem;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            }

            .header-section {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 2rem;
                border-radius: 1rem 1rem 0 0;
            }

            .campo-300 {
                border: 2px solid var(--border-color);
                border-radius: 0.75rem;
                padding: 1.5rem;
                margin-bottom: 1.5rem;
                background: #f8fafc;
                transition: all 0.3s ease;
            }

            .campo-300:hover {
                border-color: var(--primary-color);
                box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
            }

            .campo-300-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1rem;
                padding-bottom: 0.75rem;
                border-bottom: 2px solid var(--border-color);
            }

            .subcampo-repetible {
                background: white;
                border: 1px solid #e2e8f0;
                border-radius: 0.5rem;
                padding: 1rem;
                margin-bottom: 0.75rem;
                transition: all 0.2s ease;
            }

            .subcampo-repetible:hover {
                border-color: var(--primary-color);
                box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
            }

            .subcampo-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 1rem;
            }

            .badge-marc {
                font-family: "Courier New", monospace;
                font-weight: bold;
                font-size: 0.85rem;
                padding: 0.35rem 0.75rem;
            }

            .btn-action {
                transition: all 0.2s ease;
            }

            .btn-action:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            }

            .marc-preview {
                background: #1e293b;
                color: #10b981;
                font-family: "Courier New", monospace;
                padding: 1rem;
                border-radius: 0.5rem;
                margin-top: 1rem;
                white-space: pre-wrap;
                word-break: break-all;
            }

            .empty-state {
                text-align: center;
                padding: 3rem 2rem;
                color: var(--secondary-color);
            }

            .empty-state i {
                font-size: 4rem;
                margin-bottom: 1rem;
                opacity: 0.5;
            }

            .form-label {
                font-weight: 600;
                color: #334155;
                margin-bottom: 0.5rem;
            }

            .form-control,
            .form-select {
                border-radius: 0.5rem;
                border: 1px solid #cbd5e1;
            }

            .form-control:focus,
            .form-select:focus {
                border-color: var(--primary-color);
                box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="main-card">
                <!-- Header -->
                <div class="header-section">
                    <div
                        class="d-flex justify-content-between align-items-start"
                    >
                        <div>
                            <h1 class="mb-2">
                                <i class="bi bi-file-earmark-text"></i>
                                Prueba Campo 300 - Descripción Física
                            </h1>
                            <p class="mb-0 opacity-75">
                                Campos repetibles con subcampos repetibles
                                anidados
                            </p>
                            <small class="d-block mt-2">
                                <strong>Obra:</strong> {{ obra.titulo_principal
                                }}
                                <span class="badge bg-light text-dark ms-2"
                                    >ID: {{ obra.id }}</span
                                >
                            </small>
                        </div>
                        <a
                            href="{% url 'index' %}"
                            class="btn btn-light btn-sm"
                        >
                            <i class="bi bi-house"></i> Inicio
                        </a>
                    </div>
                </div>

                <!-- Messages -->
                {% if messages %}
                <div class="p-3">
                    {% for message in messages %}
                    <div
                        class="alert alert-{{ message.tags }} alert-dismissible fade show"
                        role="alert"
                    >
                        {{ message }}
                        <button
                            type="button"
                            class="btn-close"
                            data-bs-dismiss="alert"
                        ></button>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Form -->
                <form method="post" id="form-campo-300" class="p-4">
                    {% csrf_token %}

                    <!-- Hidden management form fields -->
                    <input
                        type="hidden"
                        name="descripcion_fisica_TOTAL_FORMS"
                        id="id_descripcion_fisica_TOTAL_FORMS"
                        value="{{ total_descripciones }}"
                    />

                    <!-- Descripciones Físicas (300) -->
                    <div id="descripciones-container">
                        {% if descripciones %} {% for desc in descripciones %}
                        {% include 'catalogacion/partials/_campo_300_item.html'
                        with descripcion=desc forloop_counter=forloop.counter0
                        %} {% endfor %} {% else %}
                        <div class="empty-state">
                            <i class="bi bi-inbox"></i>
                            <h4>No hay campos 300 registrados</h4>
                            <p>Haz clic en "Agregar Campo 300" para comenzar</p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Botones de acción -->
                    <div
                        class="d-flex gap-2 justify-content-between align-items-center mt-4 pt-3 border-top"
                    >
                        <button
                            type="button"
                            class="btn btn-primary btn-action"
                            onclick="agregarCampo300()"
                        >
                            <i class="bi bi-plus-circle"></i> Agregar Campo 300
                        </button>

                        <div class="d-flex gap-2">
                            <button
                                type="submit"
                                class="btn btn-success btn-action"
                            >
                                <i class="bi bi-save"></i> Guardar Todo
                            </button>
                            <a
                                href="{% url 'limpiar_prueba_300' %}"
                                class="btn btn-danger btn-action"
                                onclick="return confirm('¿Estás seguro de eliminar todas las obras de prueba?')"
                            >
                                <i class="bi bi-trash"></i> Limpiar Pruebas
                            </a>
                        </div>
                    </div>
                </form>

                <!-- Vista previa MARC -->
                {% if descripciones %}
                <div class="p-4 border-top">
                    <h5 class="mb-3">
                        <i class="bi bi-code-square"></i> Vista Previa Formato
                        MARC21
                    </h5>
                    {% for desc in descripciones %}
                    <div class="marc-preview">{{ desc.marc_format }}</div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Template para nuevo campo 300 -->
        <template id="template-campo-300">
            {% include 'catalogacion/partials/_campo_300_template.html' %}
        </template>

        <!-- Bootstrap JS -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

        <script>
            let contadorDescripciones = {{ total_descripciones }};

            /**
             * Agrega un nuevo campo 300 completo
             */
            function agregarCampo300() {
                const template = document.getElementById('template-campo-300');
                const clone = template.content.cloneNode(true);

                // Reemplazar __prefix__ con el índice actual
                const html = clone.firstElementChild.outerHTML.replace(/__prefix__/g, contadorDescripciones);

                // Insertar antes del empty-state o al final
                const container = document.getElementById('descripciones-container');
                const emptyState = container.querySelector('.empty-state');

                if (emptyState) {
                    emptyState.remove();
                }

                container.insertAdjacentHTML('beforeend', html);

                // Actualizar contador
                contadorDescripciones++;
                document.getElementById('id_descripcion_fisica_TOTAL_FORMS').value = contadorDescripciones;

                // Scroll suave al nuevo elemento
                const nuevoElemento = container.lastElementChild;
                nuevoElemento.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            /**
             * Elimina un campo 300 completo
             */
            function eliminarCampo300(index) {
                if (!confirm('¿Eliminar este campo 300 y todos sus subcampos?')) {
                    return;
                }

                const campo = document.getElementById(`campo-300-${index}`);
                const deleteInput = campo.querySelector(`input[name="descripcion_fisica_${index}_DELETE"]`);

                if (deleteInput) {
                    // Si existe el campo DELETE, marcarlo
                    deleteInput.value = 'on';
                    campo.style.display = 'none';
                } else {
                    // Si es nuevo (sin ID), simplemente remover del DOM
                    campo.remove();
                }

                // Verificar si quedan campos
                const container = document.getElementById('descripciones-container');
                const camposVisibles = container.querySelectorAll('.campo-300:not([style*="display: none"])');

                if (camposVisibles.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="bi bi-inbox"></i>
                            <h4>No hay campos 300 registrados</h4>
                            <p>Haz clic en "Agregar Campo 300" para comenzar</p>
                        </div>
                    `;
                }
            }

            /**
             * Agrega una extensión ($a) a un campo 300 específico
             */
            function agregarExtension(descripcionIndex) {
                const container = document.getElementById(`extensiones-container-${descripcionIndex}`);
                const totalInput = document.getElementById(`id_extension_${descripcionIndex}_TOTAL_FORMS`);
                const totalExtensiones = parseInt(totalInput.value);

                const html = `
                    <div class="subcampo-repetible" id="extension-${descripcionIndex}-${totalExtensiones}">
                        <div class="subcampo-header">
                            <div class="flex-grow-1">
                                <label class="form-label">
                                    <span class="badge bg-info badge-marc">$a</span> Extensión
                                </label>
                                <input type="text"
                                       name="extension_${descripcionIndex}_${totalExtensiones}_extension"
                                       class="form-control"
                                       placeholder="Ej: 1 partitura (24 p.)">
                                <input type="hidden"
                                       name="extension_${descripcionIndex}_${totalExtensiones}_id"
                                       value="">
                            </div>
                            <button type="button"
                                    class="btn btn-sm btn-outline-danger"
                                    onclick="eliminarExtension(${descripcionIndex}, ${totalExtensiones})"
                                    title="Eliminar extensión">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                `;

                container.insertAdjacentHTML('beforeend', html);
                totalInput.value = totalExtensiones + 1;
            }

            /**
             * Elimina una extensión ($a)
             */
            function eliminarExtension(descripcionIndex, extensionIndex) {
                const elemento = document.getElementById(`extension-${descripcionIndex}-${extensionIndex}`);
                const deleteInput = elemento.querySelector(`input[name="extension_${descripcionIndex}_${extensionIndex}_DELETE"]`);

                if (deleteInput) {
                    deleteInput.value = 'on';
                    elemento.style.display = 'none';
                } else {
                    // Agregar campo DELETE si tiene ID
                    const idInput = elemento.querySelector(`input[name="extension_${descripcionIndex}_${extensionIndex}_id"]`);
                    if (idInput && idInput.value) {
                        const deleteField = document.createElement('input');
                        deleteField.type = 'hidden';
                        deleteField.name = `extension_${descripcionIndex}_${extensionIndex}_DELETE`;
                        deleteField.value = 'on';
                        elemento.appendChild(deleteField);
                        elemento.style.display = 'none';
                    } else {
                        elemento.remove();
                    }
                }
            }

            /**
             * Agrega una dimensión ($c) a un campo 300 específico
             */
            function agregarDimension(descripcionIndex) {
                const container = document.getElementById(`dimensiones-container-${descripcionIndex}`);
                const totalInput = document.getElementById(`id_dimension_${descripcionIndex}_TOTAL_FORMS`);
                const totalDimensiones = parseInt(totalInput.value);

                const html = `
                    <div class="subcampo-repetible" id="dimension-${descripcionIndex}-${totalDimensiones}">
                        <div class="subcampo-header">
                            <div class="flex-grow-1">
                                <label class="form-label">
                                    <span class="badge bg-warning badge-marc">$c</span> Dimensión
                                </label>
                                <input type="text"
                                       name="dimension_${descripcionIndex}_${totalDimensiones}_dimension"
                                       class="form-control"
                                       placeholder="Ej: 30 cm">
                                <input type="hidden"
                                       name="dimension_${descripcionIndex}_${totalDimensiones}_id"
                                       value="">
                            </div>
                            <button type="button"
                                    class="btn btn-sm btn-outline-danger"
                                    onclick="eliminarDimension(${descripcionIndex}, ${totalDimensiones})"
                                    title="Eliminar dimensión">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                `;

                container.insertAdjacentHTML('beforeend', html);
                totalInput.value = totalDimensiones + 1;
            }

            /**
             * Elimina una dimensión ($c)
             */
            function eliminarDimension(descripcionIndex, dimensionIndex) {
                const elemento = document.getElementById(`dimension-${descripcionIndex}-${dimensionIndex}`);
                const deleteInput = elemento.querySelector(`input[name="dimension_${descripcionIndex}_${dimensionIndex}_DELETE"]`);

                if (deleteInput) {
                    deleteInput.value = 'on';
                    elemento.style.display = 'none';
                } else {
                    const idInput = elemento.querySelector(`input[name="dimension_${descripcionIndex}_${dimensionIndex}_id"]`);
                    if (idInput && idInput.value) {
                        const deleteField = document.createElement('input');
                        deleteField.type = 'hidden';
                        deleteField.name = `dimension_${descripcionIndex}_${dimensionIndex}_DELETE`;
                        deleteField.value = 'on';
                        elemento.appendChild(deleteField);
                        elemento.style.display = 'none';
                    } else {
                        elemento.remove();
                    }
                }
            }

            // Confirmación antes de salir si hay cambios
            let formModificado = false;
            document.getElementById('form-campo-300').addEventListener('input', () => {
                formModificado = true;
            });

            window.addEventListener('beforeunload', (e) => {
                if (formModificado) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });

            document.getElementById('form-campo-300').addEventListener('submit', () => {
                formModificado = false;
            });
        </script>
    </body>
</html>
