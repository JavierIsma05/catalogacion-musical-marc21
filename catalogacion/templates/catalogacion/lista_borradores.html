{% extends 'catalogacion/base_catalogacion.html' %}
{% load static %}
{% load catalogacion_tags %}

{% block title %}Borradores Guardados - MARC21{% endblock %}
{% block page_title %}Borradores Guardados{% endblock %}

{% block catalogacion_css %}
<link rel="stylesheet" href="{% static 'usuarios/css/admin.css' %}">
<link rel="stylesheet" href="{% static 'usuarios/css/autoridades.css' %}">
<style>
    .tipo-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        background: var(--admin-bg);
        color: var(--admin-text-light);
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }
    .tipo-badge.manuscrito {
        background: #e8f4f8;
        color: #0369a1;
    }
    .tipo-badge.impreso {
        background: #fef3c7;
        color: #92400e;
    }
    .borrador-titulo {
        font-weight: 600;
        color: var(--admin-text);
        margin-bottom: 0.125rem;
    }
    .borrador-subtitulo {
        font-size: 0.8125rem;
        color: var(--admin-text-light);
    }
    .action-btn.continuar {
        background: var(--admin-primary);
        color: white;
    }
    .action-btn.continuar:hover {
        background: var(--admin-primary-hover);
    }
    
    /* Colores por tipo de obra */
    .tipo-badge.coleccion_manuscrita {
        background: #e8f5e8;
        color: #2d6a2d;
        border: 1px solid #b8e6b8;
    }
    .tipo-badge.obra_en_coleccion_manuscrita {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }
    .tipo-badge.obra_manuscrita_individual {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    .tipo-badge.coleccion_impresa {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }
    .tipo-badge.obra_en_coleccion_impresa {
        background: #e2e3e5;
        color: #383d41;
        border: 1px solid #d6d8db;
    }
    .tipo-badge.obra_impresa_individual {
        background: #f4ebff;
        color: #4c1d95;
        border: 1px solid #e9d5ff;
    }
    .tipo-badge.edicion {
        background: #fef3c7;
        color: #92400e;
        border: 1px solid #fde68a;
    }
    
    /* Estados de publicación */
    .estado-badge {
        font-size: 0.7rem;
        padding: 0.2rem 0.4rem;
        border-radius: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .estado-badge.activo {
        background: #dc3545;
        color: white;
    }
    .estado-badge.convertido {
        background: #198754;
        color: white;
    }
    .estado-badge.descartado {
        background: #6c757d;
        color: white;
    }
</style>
{% endblock catalogacion_css %}

{% block catalogacion_content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'catalogacion:index' %}">Inicio</a></li>
        <li class="breadcrumb-item active">Borradores</li>
    </ol>
</nav>

<div class="admin-card autoridad-card">
    <div class="admin-card-header">
        <h2 class="admin-card-title">
            <i class="bi bi-file-earmark-text"></i>
            Borradores
        </h2>
        <a href="{% url 'catalogacion:seleccionar_tipo' %}" class="admin-btn admin-btn-primary admin-btn-sm">
            <i class="bi bi-plus"></i> Nueva obra
        </a>
    </div>

    <div class="admin-card-body">
        <div class="row g-3 align-items-center mb-3">
            <div class="col-lg-8">
                <form method="get" class="autoridad-search" role="search">
                    <input type="text" name="q" class="form-control" placeholder="Buscar por título" value="{{ request.GET.q }}">
                    <button type="submit" class="admin-btn admin-btn-secondary admin-btn-sm" aria-label="Buscar">
                        <i class="bi bi-search"></i>
                    </button>
                    {% if request.GET.q %}
                    <a href="{% url 'catalogacion:lista_borradores' %}" class="admin-btn admin-btn-light admin-btn-sm" aria-label="Limpiar búsqueda">
                        <i class="bi bi-x"></i>
                    </a>
                    {% endif %}
                </form>
            </div>
            <div class="col-lg-4 text-lg-end">
                <span class="autoridad-meta">Total: {{ total_borradores }} borrador{{ total_borradores|pluralize:"es" }}</span>
            </div>
        </div>

        {% if borradores %}
        <div class="admin-table-wrapper autoridad-table">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Título / Tipo</th>
                        <th>Tipo de obra</th>
                        <th>Pestaña actual</th>
                        <th>Última modificación</th>
                        <th class="text-end">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for borrador in borradores %}
                    <tr>
                        <td>
                            <div class="borrador-titulo">
                                {{ borrador.titulo_temporal|default:"Sin título"|truncatewords:8 }}
                            </div>
                            <div class="borrador-subtitulo">
                                {% if borrador.obra_objetivo_id %}
                                    <i class="bi bi-pencil-square"></i> Edición de obra #{{ borrador.obra_objetivo_id }}
                                {% else %}
                                    <i class="bi bi-file-earmark-plus"></i> Creación nueva
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            <span class="tipo-badge {{ borrador.tipo_obra }}">
                                {% if borrador.tipo_registro == 'd' %}
                                    <i class="bi bi-pen"></i> 
                                {% elif borrador.tipo_registro == 'c' %}
                                    <i class="bi bi-printer"></i> 
                                {% endif %}
                                {% if borrador.tipo_obra == 'coleccion_manuscrita' %}
                                    Colección Manuscrita
                                {% elif borrador.tipo_obra == 'obra_en_coleccion_manuscrita' %}
                                    Obra en Colección Manuscrita
                                {% elif borrador.tipo_obra == 'obra_manuscrita_individual' %}
                                    Obra Manuscrita Individual
                                {% elif borrador.tipo_obra == 'coleccion_impresa' %}
                                    Colección Impresa
                                {% elif borrador.tipo_obra == 'obra_en_coleccion_impresa' %}
                                    Obra en Colección Impresa
                                {% elif borrador.tipo_obra == 'obra_impresa_individual' %}
                                    Obra Impresa Individual
                                {% else %}
                                    {{ borrador.get_descripcion_tipo|default:borrador.tipo_obra }}
                                {% endif %}
                            </span>
                            {% if borrador.nivel_bibliografico %}
                                <br>
                                <small class="text-muted">
                                    {% if borrador.nivel_bibliografico == 'c' %}
                                        <i class="bi bi-collection"></i> Colección
                                    {% elif borrador.nivel_bibliografico == 'm' %}
                                        <i class="bi bi-book"></i> Monografía
                                    {% elif borrador.nivel_bibliografico == 'a' %}
                                        <i class="bi bi-layers"></i> Parte
                                    {% endif %}
                                </small>
                            {% endif %}
                        </td>
                        
                        <td class="muted">
                            {% with tab=tab_labels|get_item:borrador.pestana_actual %}
                                {{ tab|default:"—" }}
                            {% endwith %}
                        </td>
                        <td class="muted">
                            <div>{{ borrador.fecha_modificacion|date:"d/m/Y H:i" }}</div>
                            <small>
                                {% if borrador.dias_desde_modificacion == 0 %}
                                    Hoy
                                {% elif borrador.dias_desde_modificacion == 1 %}
                                    Ayer
                                {% else %}
                                    Hace {{ borrador.dias_desde_modificacion }} días
                                {% endif %}
                            </small>
                        </td>
                        <td class="text-end">
                            <div class="autoridad-actions">
                                {% if borrador.obra_objetivo_id %}
                                    <a href="{% url 'catalogacion:editar_obra' borrador.obra_objetivo_id %}?borrador={{ borrador.id }}" 
                                       class="action-btn continuar" title="Continuar edición">
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </a>
                                {% else %}
                                    <a href="{% url 'catalogacion:recuperar_borrador' borrador.id %}" 
                                       class="action-btn continuar" title="Continuar">
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </a>
                                {% endif %}
                                <button type="button" 
                                        class="action-btn delete" 
                                        title="Descartar"
                                        onclick="confirmarDescarte({{ borrador.id }}, '{{ borrador.titulo_temporal|escapejs|default:"Sin título" }}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if is_paginated %}
        <div class="admin-pagination">
            {% if page_obj.has_previous %}
            <a class="admin-pagination-btn" href="?page=1{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" title="Primera página">
                <i class="bi bi-chevron-double-left"></i>
            </a>
            <a class="admin-pagination-btn" href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" title="Página anterior">
                <i class="bi bi-chevron-left"></i>
            </a>
            {% endif %}
            <span class="admin-pagination-info">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
            {% if page_obj.has_next %}
            <a class="admin-pagination-btn" href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" title="Página siguiente">
                <i class="bi bi-chevron-right"></i>
            </a>
            <a class="admin-pagination-btn" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" title="Última página">
                <i class="bi bi-chevron-double-right"></i>
            </a>
            {% endif %}
        </div>
        {% endif %}

        {% else %}
        <!-- Estado vacío -->
        <div class="autoridad-empty">
            <div class="icon"><i class="bi bi-inbox"></i></div>
            <p>No hay borradores guardados{% if request.GET.q %} para "{{ request.GET.q }}"{% endif %}.</p>
            <p class="text-muted">Los borradores se guardan automáticamente mientras trabajas en una obra.</p>
            <a href="{% url 'catalogacion:seleccionar_tipo' %}" class="admin-btn admin-btn-primary admin-btn-sm">
                <i class="bi bi-plus"></i> Crear nueva obra
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal de confirmación -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> Confirmar descarte</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <p>¿Descartar el borrador <strong id="borrador-titulo"></strong>?</p>
                <p class="text-muted mb-0">Esta acción no se puede deshacer.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form id="delete-form" method="post" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash"></i> Descartar
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock catalogacion_content %}

{% block catalogacion_js %}
<script>
function confirmarDescarte(borradorId, titulo) {
    document.getElementById('borrador-titulo').textContent = titulo || 'Sin título';
    const deleteBase = "{% url 'catalogacion:descartar_borrador' pk=0 %}".replace('/0/', `/${borradorId}/`);
    document.getElementById('delete-form').action = deleteBase;
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}
</script>
{% endblock catalogacion_js %}