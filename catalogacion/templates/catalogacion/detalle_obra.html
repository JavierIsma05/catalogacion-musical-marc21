{% extends 'catalogacion/base_catalogacion.html' %}
{% load static %}

{% block title %}{{ obra.titulo_principal }} - Detalle de Obra{% endblock %}
{% block page_title %}Detalle de Obra{% endblock %}

{% block catalogacion_css %}
<link rel="stylesheet" href="{% static 'catalogacion/css/detalle-obra.css' %}">
{% endblock %}

{% block catalogacion_content %}

<div class="detalle-container detalle-layout">

    <!-- ================= ENCABEZADO ================= -->
    <div class="detalle-header">
        <div class="header-content">

            <div class="header-breadcrumb">
                <a href="{% url 'usuarios:catalogador_dashboard' %}">Inicio</a>
                <span class="separator">›</span>
                <a href="{% url 'catalogacion:lista_obras' %}">Catálogo</a>
                <span class="separator">›</span>
                <span class="current">{{ obra.titulo_principal|truncatewords:5 }}</span>
            </div>

            <div class="header-main">
                {% if obra.signatura_completa %}
                <div class="signatura-badge">
                    <i class="bi bi-bookmark-fill"></i>
                    {{ obra.signatura_completa }}
                </div>
                {% endif %}

                <a href="{% url 'catalogacion:editar_obra' pk=obra.pk %}" class="btn-action">
                    <i class="bi bi-pencil"></i> Editar
                </a>
            </div>

        </div>
    </div>

    <!-- ================= BODY ================= -->
    <div class="detalle-body">

        <!-- ========== SIDEBAR ========== -->
        <aside class="detalle-sidebar">
            <nav class="sidebar-nav">
                <div class="nav-header"><h6>Contenido</h6></div>
                <ul class="nav-list">
                    <li><a href="#nombres" class="nav-link">Nombres y Títulos</a></li>
                    <li><a href="#produccion" class="nav-link">Producción / Edición</a></li>
                    <li><a href="#musical" class="nav-link">Datos Musicales</a></li>
                    <li><a href="#materias" class="nav-link">Materias y Serie</a></li>
                    <li><a href="#notas" class="nav-link">Notas</a></li>
                    <li><a href="#relaciones" class="nav-link">Relaciones</a></li>
                    <li><a href="#existencias" class="nav-link">Existencias</a></li>
                    <li><a href="#admin" class="nav-link">Administración</a></li>
                </ul>
            </nav>
        </aside>

        <!-- ========== CONTENIDO ========== -->
        <main class="detalle-main">

            <!-- ================= NOMBRES Y TÍTULOS ================= -->
            <section id="nombres" class="detalle-section">
                <h3>Nombres y Títulos</h3>

                {% if obra.compositor %}
                <div class="data-row"><span class="campo-tag">100</span>{{ obra.compositor }}</div>
                {% endif %}

                {% if obra.titulo_uniforme %}
                <div class="data-row"><span class="campo-tag">130</span>{{ obra.titulo_uniforme }}</div>
                {% endif %}

                {% if obra.titulo_240 %}
                <div class="data-row"><span class="campo-tag">240</span>{{ obra.titulo_240 }}</div>
                {% endif %}

                {% if obra.titulo_principal %}
                <div class="data-row">
                    <span class="campo-tag">245</span>
                    {{ obra.titulo_principal }}{% if obra.subtitulo %} : {{ obra.subtitulo }}{% endif %}
                </div>
                {% endif %}

                {% if obra.titulos_alternativos.exists %}
                    {% for alt in obra.titulos_alternativos.all %}
                        {% if alt.titulo %}
                        <div class="data-row"><span class="campo-tag">246</span>{{ alt.titulo }}</div>
                        {% endif %}
                    {% endfor %}
                {% endif %}

                {% if obra.nombres_relacionados_700.exists %}
                    {% for n in obra.nombres_relacionados_700.all %}
                        {% if n.persona %}
                        <div class="data-row">
                            <span class="campo-tag">700</span>
                            {{ n.persona }}
                            {% if n.funciones.exists %}
                                — {{ n.funciones.first.get_funcion_display }}
                            {% endif %}
                        </div>
                        {% endif %}
                    {% endfor %}
                {% endif %}

                {% if obra.entidades_relacionadas_710.exists %}
                    {% for e in obra.entidades_relacionadas_710.all %}
                        {% if e.entidad %}
                        <div class="data-row"><span class="campo-tag">710</span>{{ e.entidad }}</div>
                        {% endif %}
                    {% endfor %}
                {% endif %}
            </section>

            <!-- ================= PRODUCCIÓN / EDICIÓN ================= -->
            <section id="produccion" class="detalle-section">
                <h3>Producción / Edición</h3>

                {% if obra.ms_imp %}
                <div class="data-row"><span class="campo-tag">340</span>{{ obra.get_ms_imp_display }}</div>
                {% endif %}

                {% if obra.producciones_publicaciones.exists %}
                    {% for prod in obra.producciones_publicaciones.all %}
                    <div class="data-row"><span class="campo-tag">264</span>{{ prod.get_funcion_display }}</div>
                    {% endfor %}
                {% endif %}

                {% if obra.ediciones.exists %}
                    {% for ed in obra.ediciones.all %}
                    <div class="data-row"><span class="campo-tag">250</span>{{ ed.edicion }}</div>
                    {% endfor %}
                {% endif %}

                {% if obra.extension or obra.dimension %}
                <div class="data-row">
                    <span class="campo-tag">300</span>
                    {{ obra.extension }}{% if obra.dimension %} ; {{ obra.dimension }}{% endif %}
                </div>
                {% endif %}
            </section>

            <!-- ================= DATOS MUSICALES ================= -->
            <section id="musical" class="detalle-section">
                <h3>Datos Musicales</h3>

                {% if obra.formato %}
                <div class="data-row"><span class="campo-tag">348</span>{{ obra.get_formato_display }}</div>
                {% endif %}

                {% if obra.medios_interpretacion_382.exists %}
                    {% for m in obra.medios_interpretacion_382.all %}
                    <div class="data-row"><span class="campo-tag">382</span>{{ m }}</div>
                    {% endfor %}
                {% endif %}

                {% if obra.numero_obra or obra.opus %}
                <div class="data-row">
                    <span class="campo-tag">383</span>
                    {{ obra.numero_obra }}{% if obra.opus %} Op. {{ obra.opus }}{% endif %}
                </div>
                {% endif %}

                {% if obra.tonalidad_384 %}
                <div class="data-row"><span class="campo-tag">384</span>{{ obra.tonalidad_384 }}</div>
                {% endif %}
            </section>

            <!-- ================= MATERIAS Y SERIE ================= -->
            <section id="materias" class="detalle-section">
                <h3>Materias y Serie</h3>

                {% if obra.materias_650.exists %}
                    {% for m in obra.materias_650.all %}
                    <div class="data-row"><span class="campo-tag">650</span>{{ m.materia }}</div>
                    {% endfor %}
                {% endif %}

                {% if obra.materias_655.exists %}
                    {% for g in obra.materias_655.all %}
                    <div class="data-row"><span class="campo-tag">655</span>{{ g.materia }}</div>
                    {% endfor %}
                {% endif %}

                {# 440 – Series (cuando esté modelado) #}
            </section>

            <!-- ================= NOTAS ================= -->
            <section id="notas" class="detalle-section">
                <h3>Notas</h3>

                {% for n in obra.notas_generales_500.all %}
                    {% if n.nota_general %}
                    <div class="data-row"><span class="campo-tag">500</span>{{ n.nota_general }}</div>
                    {% endif %}
                {% endfor %}

                {% for c in obra.contenidos_505.all %}
                    {% if c.contenido %}
                    <div class="data-row"><span class="campo-tag">505</span>{{ c.contenido }}</div>
                    {% endif %}
                {% endfor %}

                {% for s in obra.sumarios_520.all %}
                    {% if s.sumario %}
                    <div class="data-row"><span class="campo-tag">510</span>{{ s.sumario }}</div>
                    {% endif %}
                {% endfor %}

                {% if obra.datos_biograficos_545 %}
                <div class="data-row"><span class="campo-tag">545</span>{{ obra.datos_biograficos_545.texto_biografico }}</div>
                {% endif %}
            </section>

            <!-- ================= RELACIONES ================= -->
            <section id="relaciones" class="detalle-section">
                <h3>Relaciones</h3>

                {# ================= 773 ================= #}
                {% for r in obra.enlaces_documento_fuente_773.all %}
                <div class="data-row">
                    <span class="campo-tag">773</span>
                    <span>
                        {% if r.encabezamiento_principal %}
                            {{ r.encabezamiento_principal }}.
                        {% endif %}
                        {% if r.titulo %}
                            <em>{{ r.titulo }}</em>
                        {% endif %}

                        {% for w in r.numeros_control.all %}
                            ({{ w.obra_relacionada.num_control }})
                        {% endfor %}
                    </span>
                </div>
                {% empty %}
                <p class="text-muted">No hay relaciones 773 registradas.</p>
                {% endfor %}

                {# ================= 774 ================= #}
                {% for r in obra.enlaces_unidades_774.all %}
                <div class="data-row">
                    <span class="campo-tag">774</span>
                    <span>
                        {% if r.encabezamiento_principal %}
                            {{ r.encabezamiento_principal }}.
                        {% endif %}
                        {% if r.titulo %}
                            <em>{{ r.titulo }}</em>
                        {% endif %}

                        {% for w in r.numeros_control.all %}
                            ({{ w.obra_relacionada.num_control }})
                        {% endfor %}
                    </span>
                </div>
                {% empty %}
                <p class="text-muted">No hay relaciones 774 registradas.</p>
                {% endfor %}

                {# ================= 787 ================= #}
                {% for r in obra.otras_relaciones_787.all %}
                <div class="data-row">
                    <span class="campo-tag">787</span>
                    <span>
                        {% if r.encabezamiento_principal %}
                            {{ r.encabezamiento_principal }}.
                        {% endif %}
                        {% if r.titulo %}
                            <em>{{ r.titulo }}</em>
                        {% endif %}

                        {% for w in r.numeros_control.all %}
                            ({{ w.obra_relacionada.num_control }})
                        {% endfor %}
                    </span>
                </div>
                {% empty %}
                <p class="text-muted">No hay relaciones 787 registradas.</p>
                {% endfor %}
            </section>


            <!-- ================= EXISTENCIAS ================= -->
            <section id="existencias" class="detalle-section">
                <h3>Existencias</h3>


                    {# 852 #}
                    {% for u in obra.ubicaciones_852.all %}
                        {% if u.signatura_original %}
                        <div class="data-row">
                            <span class="campo-tag">852</span>
                            {{ u.signatura_original }}
                        </div>
                        {% endif %}
                    {% endfor %}

                    {# 856 #}

                    {% for d in obra.disponibles_856.all %}
                        <div>
                            <strong>856</strong><br>

                            {% for u in d.urls_856.all %}
                                $u <a href="{{ u.url }}">{{ u.url }}</a><br>
                            {% endfor %}

                            {% for y in d.textos_enlace_856.all %}
                                $y {{ y.texto_enlace }}<br>
                            {% endfor %}
                        </div>
                    {% empty %}
                        <p>No existen recursos electrónicos disponibles.</p>
                    {% endfor %}



            <!-- ================= ADMINISTRACIÓN ================= -->
            <section id="admin" class="detalle-section">
                <h3>Administración</h3>

                {% if obra.centro_catalogador %}
                <div class="data-row"><span class="campo-tag">040</span>{{ obra.centro_catalogador }}</div>
                {% endif %}
            </section>

        </main>
    </div>
</div>

<!-- ================= JS ================= -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    const links = document.querySelectorAll('.nav-link');
    const sections = document.querySelectorAll('.detalle-section');
    if (!links.length || !sections.length) return;

    links.forEach(link => {
        link.addEventListener('click', e => {
            e.preventDefault();
            const target = document.querySelector(link.getAttribute('href'));
            if (!target) return;
            window.scrollTo({ top: target.offsetTop - 90, behavior: 'smooth' });
        });
    });

    const observer = new IntersectionObserver(entries => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                links.forEach(l =>
                    l.classList.toggle('active', l.getAttribute('href') === `#${entry.target.id}`)
                );
            }
        });
    }, { rootMargin: '-40% 0px -40% 0px' });

    sections.forEach(s => observer.observe(s));
});
</script>

{% endblock %}
