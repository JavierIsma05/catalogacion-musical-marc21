{% extends 'catalogacion/base_catalogacion.html' %}
{% load static %}

{% block title %}{{ obra.titulo_principal }} - Detalle de Obra{% endblock %}
{% block page_title %}Detalle de Obra{% endblock %}

{% block catalogacion_css %}
<link rel="stylesheet" href="{% static 'catalogacion/css/detalle-obra.css' %}">
{% endblock %}

{% block catalogacion_content %}
<div class="detalle-container">
    
    <!-- ENCABEZADO -->
    <div class="detalle-header">
        <div class="header-content">
            <div class="header-breadcrumb">
                <a href="{% url 'usuarios:catalogador_dashboard' %}">Inicio</a>
                <span class="separator">‚Ä∫</span>
                <a href="{% url 'catalogacion:lista_obras' %}">Cat√°logo</a>
                <span class="separator">‚Ä∫</span>
                <span class="current">{{ obra.titulo_principal|truncatewords:5 }}</span>
            </div>
            
            <div class="header-main">
                <div class="header-info">

                    {% if obra.signatura_completa %}
                    <div class="signatura-badge">
                        <i class="bi bi-bookmark-fill"></i>
                        <span>{{ obra.signatura_completa }}</span>
                    </div>
                    {% endif %}

                    <!-- METADATOS R√ÅPIDOS -->
                    {% if obra.coleccion %}
                    <div class="metadata-item">
                        <span class="metadata-label">Colecci√≥n (773):</span>
                        <span class="metadata-value">{{ obra.coleccion.nombre_completo }}</span>
                    </div>
                    {% endif %}

                    {% if obra.compositor %}
                    <div class="metadata-item compositor">
                        <span class="metadata-label">Compositor (100):</span>
                        <span class="metadata-value">
                            {{ obra.compositor.nombre_completo }}
                            {% if obra.compositor.coordenadas_biograficas %}
                                ({{ obra.compositor.coordenadas_biograficas }})
                            {% endif %}
                        </span>
                    </div>
                    {% endif %}

                    <!-- ORDEN MARC PARA TITULACI√ìN -->
                    {% if obra.titulo_uniforme %}
                    <h1 class="obra-titulo titulo-130">
                        {{ obra.titulo_uniforme.nombre_completo }}
                        {% if obra.medio_interpretacion_130 %}, {{ obra.medio_interpretacion_130 }}{% endif %}
                        {% if obra.tonalidad_130 %}, {{ obra.tonalidad_130 }}{% endif %}
                    </h1>
                    <div class="titulo-referencia">(130)</div>
                    {% endif %}

                    {% if obra.titulo_240 %}
                    <h1 class="obra-titulo titulo-240">
                        {{ obra.titulo_240.nombre_completo }}
                        {% if obra.medio_interpretacion_240 %}, {{ obra.medio_interpretacion_240 }}{% endif %}
                        {% if obra.tonalidad_240 %}, {{ obra.tonalidad_240 }}{% endif %}
                    </h1>
                    <div class="titulo-referencia">(240)</div>
                    {% endif %}

                    {% if obra.titulo_principal %}
                    <h2 class="obra-titulo-fuente">
                        {{ obra.titulo_principal }}{% if obra.subtitulo %} : {{ obra.subtitulo }}{% endif %}
                    </h2>
                    <div class="titulo-referencia">(245)</div>
                    {% endif %}

                    {% if obra.mencion_responsabilidad %}
                    <div class="mencion-responsabilidad">/ {{ obra.mencion_responsabilidad }}</div>
                    {% endif %}

                    {% if obra.ms_imp %}
                    <div class="tipo-material-badge">
                        <span class="badge-label">Tipo de material (340):</span>
                        <span class="badge-value">{{ obra.get_ms_imp_display }}</span>
                    </div>
                    {% endif %}
                    
                </div>

                <div class="header-actions">
                    <a href="{% url 'catalogacion:editar_obra' pk=obra.pk %}" class="btn-action">
                        <i class="bi bi-pencil"></i>
                        Editar
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- BODY CON SIDEBAR -->
    <div class="detalle-body">

        <!-- üîπ SIDEBAR ACTUALIZADO -->
        <aside class="detalle-sidebar">
            <nav class="sidebar-nav">
                <div class="nav-header"><h6>Contenido</h6></div>
                <ul class="nav-list">
                    <li><a href="#seccion-info" class="nav-link active"><i class="bi bi-info-circle"></i> Informaci√≥n General</a></li>
                    <li><a href="#seccion-titulos" class="nav-link"><i class="bi bi-music-note-beamed"></i> T√≠tulos & Puntos de acceso</a></li>
                    <li><a href="#seccion-colaboradores" class="nav-link"><i class="bi bi-people"></i> Colaboradores</a></li>
                    <li><a href="#seccion-produccion" class="nav-link"><i class="bi bi-building"></i> Producci√≥n</a></li>
                    <li><a href="#seccion-musical" class="nav-link"><i class="bi bi-music-note-list"></i> Datos musicales</a></li>
                    <li><a href="#seccion-materias" class="nav-link"><i class="bi bi-tags"></i> Materias / G√©neros</a></li>
                    <li><a href="#seccion-notas" class="nav-link"><i class="bi bi-journal-text"></i> Notas</a></li>
                    <li><a href="#seccion-ubicacion" class="nav-link"><i class="bi bi-geo-alt"></i> Ubicaci√≥n y Acceso</a></li>
                </ul>
            </nav>
        </aside>

        <!-- CONTENIDO PRINCIPAL -->
        <main class="detalle-main">

            <!-- üü¶ SECCI√ìN 1: Informaci√≥n general -->
            <section id="seccion-info" class="detalle-section">
                <div class="section-header">
                    <h3 class="section-title"><i class="bi bi-info-circle"></i> Informaci√≥n General</h3>
                </div>

                <div class="data-grid-compact">
                    {% if obra.centro_catalogador %}
                    <div class="data-row">
                        <span class="campo-tag">040</span>
                        <span>Centro catalogador:</span>
                        <strong>{{ obra.centro_catalogador }}</strong>
                    </div>
                    {% endif %}
                    
                    {% if obra.ms_imp %}
                    <div class="data-row">
                        <span class="campo-tag">340</span>
                        <span>Tipo de material:</span>
                        <span>{{ obra.get_ms_imp_display }}</span>
                    </div>
                    {% endif %}
                </div>
            </section>

            <!-- üü© SECCI√ìN 2: T√≠tulos & puntos de acceso -->
            <section id="seccion-titulos" class="detalle-section">
                <div class="section-header">
                    <h3 class="section-title"><i class="bi bi-bookmark"></i> T√≠tulos y Puntos de Acceso</h3>
                </div>

                {% if obra.titulo_uniforme %}
                <div class="data-row-alt">
                    <span class="campo-tag">130</span>
                    {{ obra.titulo_uniforme.nombre_completo }}
                </div>
                {% endif %}

                <div class="data-row-alt">
                    <span class="campo-tag">245</span>
                    <strong>{{ obra.titulo_principal }}</strong>
                    {% if obra.subtitulo %}: {{ obra.subtitulo }}{% endif %}
                </div>

                {% if obra.titulos_alternativos.all %}
                {% for alt in obra.titulos_alternativos.all %}
                <div class="data-row-alt">
                    <span class="campo-tag">246</span>
                    {{ alt.titulo_alternativo }}
                </div>
                {% endfor %}
                {% endif %}
                            <!-- üüß SECCI√ìN 3: Colaboradores -->
            {% if obra.nombres_relacionados_700.all or obra.entidades_relacionadas_710.all %}
            <section id="seccion-colaboradores" class="detalle-section">
                <div class="section-header">
                    <h3 class="section-title"><i class="bi bi-people"></i> Colaboradores</h3>
                </div>

                <div class="colaboradores-list">
                    {% for nombre in obra.nombres_relacionados_700.all %}
                    <div class="data-row">
                        <span class="campo-tag">700</span>
                        <span class="data-label">{{ nombre.persona.nombre_completo }}</span>
                        {% if nombre.funciones.all %}
                        ‚Äî <span class="detalle">{{ nombre.funciones.all.0.get_funcion_display }}</span>
                        {% endif %}
                    </div>
                    {% endfor %}

                    {% for entidad in obra.entidades_relacionadas_710.all %}
                    <div class="data-row">
                        <span class="campo-tag">710</span>
                        <span class="data-label">{{ entidad.entidad.nombre_completo }}</span>
                    </div>
                    {% endfor %}
                </div>
            </section>
            {% endif %}

            <!-- üü® SECCI√ìN 4: Producci√≥n y Edici√≥n -->
            <section id="seccion-produccion" class="detalle-section">
                <div class="section-header">
                    <h3 class="section-title"><i class="bi bi-building"></i> Producci√≥n / Edici√≥n</h3>
                </div>

                <div class="data-grid-compact">
                    {% for prod in obra.producciones_publicacion.all %}
                    <div class="data-row">
                        <span class="campo-tag">264</span>
                        <span>{{ prod.lugar_produccion }} ‚Äî {{ prod.editor }} ‚Äî {{ prod.fecha_produccion }}</span>
                    </div>
                    {% endfor %}

                    {% for edicion in obra.ediciones.all %}
                    <div class="data-row">
                        <span class="campo-tag">250</span>
                        <span>{{ edicion.mencion_edicion }}</span>
                    </div>
                    {% endfor %}
                </div>
            </section>

            <!-- üü¶ SECCI√ìN 5: Datos Musicales -->
            <section id="seccion-musical" class="detalle-section">
                <div class="section-header">
                    <h3 class="section-title"><i class="bi bi-music-note-list"></i> Datos Musicales</h3>
                </div>

                <div class="data-grid-compact">

                    {% if obra.formato %}
                    <div class="data-row">
                        <span class="campo-tag">348</span>
                        <span>Formato: {{ obra.get_formato_display }}</span>
                    </div>
                    {% endif %}

                    {% if obra.medios_interpretacion.exists %}
                    <div class="data-row full">
                        <span class="campo-tag">382</span>
                        {% for medio in obra.medios_interpretacion.all %}
                        <span class="medio-item">{{ medio.medio }}{% if medio.solista %} ({{ medio.solista }}){% endif %}{% if not forloop.last %}; {% endif %}</span>
                        {% endfor %}
                    </div>
                    {% endif %}

                    {% if obra.numero_obra or obra.opus %}
                    <div class="data-row">
                        <span class="campo-tag">383</span>
                        <span>{{ obra.numero_obra }}{% if obra.opus %} / Op. {{ obra.opus }}{% endif %}</span>
                    </div>
                    {% endif %}

                    {% if obra.tonalidad_384 %}
                    <div class="data-row">
                        <span class="campo-tag">384</span>
                        <span>{{ obra.tonalidad_384 }}</span>
                    </div>
                    {% endif %}
                </div>

                {% if obra.incipits_musicales.all %}
                <div class="incipit-section">
                    <h4 class="subsection-title">√çncipit Musical (031)</h4>
                    {% for incipit in obra.incipits_musicales.all %}
                    <div class="incipit-card">
                        <strong>{{ incipit.titulo_movimiento }}</strong>
                        <code>{{ incipit.codigo_notacion }}</code>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </section>

            <!-- üü© SECCI√ìN 6: Materias y G√©neros -->
            <section id="seccion-materias" class="detalle-section">
                <div class="section-header">
                    <h3 class="section-title"><i class="bi bi-tags"></i> Materias / G√©neros</h3>
                </div>

                <div class="materias-container">
                    {% for materia in obra.materias_650.all %}
                    <div class="materia-tag">
                        <span class="campo-tag">650</span> {{ materia.materia }}
                    </div>
                    {% endfor %}
                    {% for materia in obra.materias_655.all %}
                    <div class="materia-tag">
                        <span class="campo-tag">655</span> {{ materia.materia }}
                    </div>
                    {% endfor %}
                </div>

                {% if obra.series_490.all %}
                <h4 class="subsection-title">Series</h4>
                {% for serie in obra.series_490.all %}
                <div class="data-row">
                    <span class="campo-tag">490</span>
                    {{ serie.titulo_serie }}{% if serie.numero_serie %} ‚Äî {{ serie.numero_serie }}{% endif %}
                </div>
                {% endfor %}
                {% endif %}
            </section>

            <!-- üü• SECCI√ìN 7: Notas -->
            <section id="seccion-notas" class="detalle-section">
                <div class="section-header">
                    <h3 class="section-title"><i class="bi bi-journal-text"></i> Notas</h3>
                </div>

                <div class="notas-list">
                    {% for nota in obra.notas_generales_500.all %}
                    <div class="nota-item">
                        <span class="campo-tag">500</span> {{ nota.nota_general }}
                    </div>
                    {% endfor %}

                    {% for conte in obra.contenidos_505.all %}
                    <div class="nota-item">
                        <span class="campo-tag">505</span> {{ conte.contenido }}
                    </div>
                    {% endfor %}

                    {% for sumario in obra.sumarios_520.all %}
                    <div class="nota-item">
                        <span class="campo-tag">520</span> {{ sumario.sumario }}
                    </div>
                    {% endfor %}

                    {% if obra.datos_biograficos_545 and obra.datos_biograficos_545.texto_biografico %}
                    <div class="nota-item">
                        <span class="campo-tag">545</span> {{ obra.datos_biograficos_545.texto_biografico }}
                    </div>
                    {% endif %}
                </div>
            </section>
                        <!-- üü™ SECCI√ìN 8: Ubicaci√≥n y Acceso -->
            <section id="seccion-ubicacion" class="detalle-section">
                <div class="section-header">
                    <h3 class="section-title"><i class="bi bi-geo-alt"></i> Ubicaci√≥n y acceso</h3>
                </div>

                {% if obra.ubicaciones_852.all %}
                <div class="ubicaciones-list">
                    {% for ubicacion in obra.ubicaciones_852.all %}
                    <div class="ubicacion-item">
                        <span class="campo-tag">852</span>
                        <span class="ubicacion-parte">
                            {% if ubicacion.signatura_original %}
                            {{ ubicacion.signatura_original }}
                            {% endif %}
                            {% if ubicacion.estanterias.all %}
                            ‚Äî Estanter√≠a:
                            {% for estanteria in ubicacion.estanterias.all %}
                                {{ estanteria.estanteria }}{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                            {% endif %}
                        </span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted">No hay ubicaci√≥n registrada</p>
                {% endif %}

                {% if obra.disponibles_856.all %}
                <h4 class="subsection-title mt-4">Disponible en l√≠nea</h4>
                {% for disponible in obra.disponibles_856.all %}
                    {% for url in disponible.urls_856.all %}
                    <div class="acceso-item">
                        <span class="campo-tag">856</span>
                        <a href="{{ url.url }}" class="acceso-link" target="_blank">
                            {% if disponible.textos_enlace_856.first %}
                                {{ disponible.textos_enlace_856.first.texto_enlace }}
                            {% else %}
                                {{ url.url }}
                            {% endif %}
                            <i class="bi bi-box-arrow-up-right"></i>
                        </a>
                    </div>
                    {% endfor %}
                {% endfor %}
                {% endif %}

            </section>

        </main>
    </div>
</div>

<!-- üîó Script para navegaci√≥n lateral y scroll suave -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const navLinks = document.querySelectorAll('.nav-link');
    const sections = document.querySelectorAll('.detalle-section');

    navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href');
            const targetSection = document.querySelector(targetId);
            if (!targetSection) return;

            const offset = 80;
            const position = targetSection.offsetTop - offset;

            window.scrollTo({ top: position, behavior: 'smooth' });

            navLinks.forEach(l => l.classList.remove('active'));
            this.classList.add('active');
        });
    });

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const id = entry.target.getAttribute('id');
                navLinks.forEach(link => {
                    link.classList.toggle('active', link.getAttribute('href') === `#${id}`);
                });
            }
        });
    }, {
        root: null,
        rootMargin: '-40% 0px -40% 0px',
        threshold: 0
    });

    sections.forEach(section => observer.observe(section));
});
</script>

{% endblock catalogacion_content %}


