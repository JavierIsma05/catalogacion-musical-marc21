{% extends 'catalogacion/base_catalogacion.html' %}
{% load static %}

{% block title %}{{ obra.titulo_principal }} - Detalle de Obra{% endblock %}
{% block page_title %}Detalle de Obra{% endblock %}

{% block catalogacion_css %}
<link rel="stylesheet" href="{% static 'catalogacion/css/detalle-obra.css' %}">

<style>
@font-face {
  font-family: 'Maestro';
  src: url("{% static 'catalogacion/fonts/Maestro.ttf' %}") format('truetype');
  font-weight: normal;
  font-style: normal;
}

.incipit-canvas-wrap{
  width: 100%;
  display: flex;
  justify-content: center;
  margin-top: .5rem;
}

.incipit-view-canvas{
  width: 100%;
  max-width: 700px;
  height: 250px;      /* tama√±o visual */
  display: block;
  background: #ffffffdc;
}


</style>
{% endblock %}

{% block catalogacion_content %}
<div class="detalle-container">

    <!-- ============= ENCABEZADO ============= -->
    <div class="detalle-header">
        <div class="header-content">

            <div class="header-breadcrumb">
                <a href="{% url 'usuarios:catalogador_dashboard' %}">Inicio</a>
                <span class="separator">‚Ä∫</span>
                <a href="{% url 'catalogacion:lista_obras' %}">Cat√°logo</a>
                <span class="separator">‚Ä∫</span>
                <span class="current">{{ obra.titulo_principal|truncatewords:5 }}</span>
            </div>

            <div class="header-main">
                <div class="header-info">

                    {% if obra.signatura_completa %}
                    <div class="signatura-badge">
                        <i class="bi bi-bookmark-fill"></i>
                        <span>{{ obra.signatura_completa }}</span>
                    </div>
                    {% endif %}

                </div>

                <a href="{% url 'catalogacion:editar_obra' pk=obra.pk %}" class="btn-action">
                    <i class="bi bi-pencil"></i> Editar
                </a>
            </div>

        </div>
    </div>

    <!-- ================= BODY ================= -->
    <div class="detalle-body">

        <!-- ========== SIDEBAR ========== -->
        <aside class="detalle-sidebar">
            <nav class="sidebar-nav">
                <div class="nav-header"><h6>Contenido</h6></div>
                <ul class="nav-list">
                    <li><a href="#admin" class="nav-link">Administraci√≥n</a></li>
                    <li><a href="#nombres_titulos" class="nav-link">Nombres y T√≠tulos</a></li>
                    <li><a href="#edicion_produccion" class="nav-link">Producci√≥n / Edici√≥n</a></li>
                    <li><a href="#datomusical" class="nav-link">Datos Musicales</a></li>
                    <li><a href="#materias_serie" class="nav-link">Materias y Serie</a></li>
                    <li><a href="#nuevas_notas" class="nav-link">Notas</a></li>
                    <li><a href="#relaciones" class="nav-link">Relaciones</a></li>
                    <li><a href="#existencias" class="nav-link">Existencias</a></li>
                </ul>
            </nav>
        </aside>

        <!-- ========== CONTENIDO ========== -->
        <main class="detalle-main">
            <!-- ================= ADMINISTRACI√ìN ================= -->
            <section id="admin" class="detalle-section">
                <h3>Administraci√≥n</h3>
                {% if obra.centro_catalogador %}
                <div class="data-row">
                    <span class="campo-tag">040</span>
                    <span>Centro catalogador:</span>
                    <strong>{{ obra.centro_catalogador }}</strong>
                </div>
                {% endif %}
            </section>
            <!-- ================= NOMBRES Y T√çTULOS ================= -->
            <section id="nombres_titulos" class="detalle-section">
                <h3>Nombres y T√≠tulos</h3>

                <div class="data-grid-compact">
                    {% if obra.compositor %}
                    <div class="data-row">
                        <span class="campo-tag">100</span>
                        <div class="data-cell">
                            <div class="linea-principal">
                                <strong>$a {{ obra.compositor }}</strong>
                                {% if obra.compositor.coordenadas_biograficas %} $d ({{ obra.compositor.coordenadas_biograficas }}){% endif %}
                            </div>
                            {% if obra.termino_asociado %}
                                <div class="linea-secundaria">
                                    <em>$e {{ obra.termino_asociado }}</em>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    {% if obra.titulo_uniforme %}
                    <div class="data-row">
                        <span class="campo-tag">130</span>
                        <div class="data-cell">
                            <div class="linea-principal">
                                <strong>$a {{ obra.titulo_uniforme }}</strong>
                            </div>
                            <div class="linea-secundaria">
                                {% if obra.forma_130 %}$a {{ obra.forma_130 }}{% endif %}
                                {% if obra.medio_interpretacion_130 %}{% if obra.forma_130 %} $b {% else %}$a {% endif %}{{ obra.medio_interpretacion_130 }}{% endif %}
                                {% if obra.numero_parte_130 %} $n {{ obra.numero_parte_130 }}{% endif %}
                                {% if obra.nombre_parte_130 %} $p {{ obra.nombre_parte_130 }}{% endif %}
                                {% if obra.tonalidad_130 %} $r {{ obra.tonalidad_130 }}{% endif %}
                                {% if obra.arreglo_130 %} $m {{ obra.get_arreglo_130_display|default:obra.arreglo_130 }}{% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {% if obra.titulo_240 %}
                    <div class="data-row">
                        <span class="campo-tag">240</span>
                        <div class="data-cell">
                            <div class="linea-principal">
                                <strong>$a {{ obra.titulo_240 }}</strong>
                            </div>
                            <div class="linea-secundaria">
                                {% if obra.forma_240 %}$a {{ obra.forma_240 }}{% endif %}
                                {% if obra.medio_interpretacion_240 %}{% if obra.forma_240 %} $b {% else %}$a {% endif %}{{ obra.medio_interpretacion_240 }}{% endif %}
                                {% if obra.numero_parte_240 %} $n {{ obra.numero_parte_240 }}{% endif %}
                                {% if obra.nombre_parte_240 %} $p {{ obra.nombre_parte_240 }}{% endif %}
                                {% if obra.tonalidad_240 %} $r {{ obra.tonalidad_240 }}{% endif %}
                                {% if obra.arreglo_240 %} $m {{ obra.get_arreglo_240_display|default:obra.arreglo_240 }}{% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {% if obra.titulo_principal %}
                    <div class="data-row">
                        <span class="campo-tag">245</span>
                        <div class="data-cell">
                            <div class="linea-principal">
                                <strong>$a {{ obra.titulo_principal }}</strong>{% if obra.subtitulo %} $b {{ obra.subtitulo }}{% endif %}
                            </div>
                            {% if obra.mencion_responsabilidad %}
                            <div class="linea-secundaria">
                                $c {{ obra.mencion_responsabilidad }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    {% if obra.titulos_alternativos.all %}
                        {% for alt in obra.titulos_alternativos.all %}
                        <div class="data-row">
                            <span class="campo-tag">246</span>
                            <div class="data-cell">
                                <div class="linea-principal">
                                    $a {{ alt.titulo }}
                                    {% if alt.resto_titulo %}$b {{ alt.resto_titulo }}{% endif %}
                                </div>
                                {% if alt.texto_visualizacion %}
                                <div class="linea-secundaria">
                                    $n [{{ alt.texto_visualizacion }}]
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}

                    {% if obra.nombres_relacionados_700.exists %}
                        {% for nombre in obra.nombres_relacionados_700.all %}
                        <div class="data-row">
                            <span class="campo-tag">700</span>
                            <div class="data-cell">
                                <div class="linea-principal">
                                    <strong>$a {{ nombre.persona }}</strong>
                                    {% if nombre.coordenadas_biograficas %} $d ({{ nombre.coordenadas_biograficas }}){% endif %}
                                </div>
                                {% if nombre.funciones.exists %}
                                <div class="linea-secundaria">
                                    {% for funcion in nombre.funciones.all %}$e {{ funcion.get_funcion_display }}{% if not forloop.last %} ; {% endif %}{% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}

                    {% if obra.entidades_relacionadas_710.exists %}
                        {% for entidad in obra.entidades_relacionadas_710.all %}
                        <div class="data-row">
                            <span class="campo-tag">710</span>
                            <div class="data-cell">
                                <div class="linea-principal">
                                    <strong>$a {{ entidad.entidad }}</strong>
                                </div>
                                {% if entidad.funcion %}
                                <div class="linea-secundaria">
                                    $e {{ entidad.get_funcion_display }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </section>

            <!-- ================= PRODUCCI√ìN / EDICI√ìN ================= -->
            <section id="edicion_produccion" class="detalle-section">
                <h3>Producci√≥n / Edici√≥n</h3>

                <div class="data-grid-compact">
                    {% if obra.ms_imp %}
                    <div class="data-row">
                        <span class="campo-tag">340</span>
                        <span>$a {{ obra.get_ms_imp_display }}</span>
                    </div>
                    {% endif %}

                    {% if obra.producciones_publicaciones.exists %}
                        {% for prod in obra.producciones_publicaciones.all %}
                        <div class="data-row">
                            <span class="campo-tag">264</span>
                            <span>$a {{ prod.get_funcion_display }}</span>
                        </div>
                        {% endfor %}
                    {% endif %}

                    {% if obra.ediciones.exists %}
                        {% for ed in obra.ediciones.all %}
                        <div class="data-row">
                            <span class="campo-tag">250</span>
                            <span>$a {{ ed.edicion }}</span>
                        </div>
                        {% endfor %}
                    {% endif %}

                    {% if obra.extension or obra.dimension %}
                    <div class="data-row">
                        <span class="campo-tag">300</span>
                        <span>$a {{ obra.extension }}{% if obra.dimension %} $c {{ obra.dimension }}{% endif %}</span>
                    </div>
                    {% endif %}
                </div>
            </section>

            <!-- ================= DATOS MUSICALES ================= -->
            <section id="datomusical" class="detalle-section">
                <h3>Datos Musicales</h3>
                <div class="data-grid-compact">
                    {% if obra.formato %}
                    <div class="data-row">
                        <span class="campo-tag">348</span>
                        <span>$a {{ obra.get_formato_display }}</span>
                    </div>
                    {% endif %}

                    {% if obra.medios_interpretacion_382.all %}
                    <div class="data-row full">
                        <span class="campo-tag">382</span>
                        <div class="data-cell">
                            <span>$a </span>
                            {% for medio in obra.medios_interpretacion_382.all %}
                                <div class="medio-item">
                                    {% if medio.medios.all %}
                                        {% for m in medio.medios.all %}$a {{ m.get_medio_display }}{% if not forloop.last %} $b {% endif %}{% endfor %}
                                    {% endif %}
                                    {% if medio.solista %}$n Solista: {{ medio.solista }}{% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    {% if obra.numero_obra or obra.opus %}
                    <div class="data-row">
                        <span class="campo-tag">383</span>
                        <span>$n {% if obra.numero_obra %}{{ obra.numero_obra }}{% endif %}{% if obra.opus %}{% if obra.numero_obra %} $o {% endif %}Op. {{ obra.opus }}{% endif %}</span>
                    </div>
                    {% endif %}

                    {% if obra.tonalidad_384 %}
                    <div class="data-row">
                        <span class="campo-tag">384</span>
                        <span>$a {{ obra.tonalidad_384 }}</span>
                    </div>
                    {% endif %}
                </div>

                {% if obra.incipits_musicales.all %}
                <div class="incipit-section">
                    <h4 class="subsection-title">√çncipit Musical (031)</h4>

                    {% for incipit in obra.incipits_musicales.all %}
                    <div class="incipit-card">
                        <div class="incipit-header">
                            <strong>Obra {{ incipit.numero_obra }}, mov. {{ incipit.numero_movimiento }}, pas. {{ incipit.numero_pasaje }}</strong>
                        </div>

                        {% if incipit.titulo_encabezamiento %}
                        <div class="incipit-subtitle">
                            {{ incipit.titulo_encabezamiento }}
                        </div>
                        {% endif %}

                        <div class="incipit-meta">
                            {% if incipit.voz_instrumento %}{{ incipit.voz_instrumento }}{% endif %}
                            {% if incipit.clave %} ¬∑ Clave: {{ incipit.clave }}{% endif %}
                            {% if incipit.armadura %} ¬∑ Armadura: {{ incipit.armadura }}{% endif %}
                            {% if incipit.tiempo %} ¬∑ Tiempo: {{ incipit.tiempo }}{% endif %}
                        </div>


                        {% if incipit.paec_full %}
                            {# ========== M√âTODO CORRECTO: json_script con ID fijo ========== #}
                            <script id="paec_json_{{ incipit.pk }}" type="application/json">{{ incipit.paec_full|safe }}</script>

                            <div class="incipit-canvas-wrap">
                                <canvas
                                    id="incipit_view_canvas_{{ incipit.pk }}"
                                    class="incipit-view-canvas"
                                    widtzzzh="800"
                                    height="320"
                                    data-paec-json-id="paec_json_{{ incipit.pk }}">
                                </canvas>
                            </div>

                            {# ========== PANEL DE DEBUG (quitar en producci√≥n) ========== #}
                            <div class="debug-panel" style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 6px; border: 1px solid #dee2e6;">
                                <div style="font-size: 12px; font-family: monospace;">
                                    <div style="margin-bottom: 0.5rem;">
                                        <strong style="color: #0066cc;">üîç DEBUG INCIPIT {{ incipit.pk }}</strong>
                                    </div>
                                    <table style="width: 100%; font-size: 11px;">
                                        <tr style="background: #fff;">
                                            <td style="padding: 4px; width: 120px;"><strong>Clave (DB):</strong></td>
                                            <td style="padding: 4px; color: #666;">"{{ incipit.clave|default:"vac√≠o" }}"</td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 4px;"><strong>Armadura (DB):</strong></td>
                                            <td style="padding: 4px; color: #666;">"{{ incipit.armadura|default:"vac√≠o" }}"</td>
                                        </tr>
                                        <tr style="background: #fff;">
                                            <td style="padding: 4px;"><strong>Tiempo (DB):</strong></td>
                                            <td style="padding: 4px; color: #666;">"{{ incipit.tiempo|default:"vac√≠o" }}"</td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 4px;"><strong>Body (DB):</strong></td>
                                            <td style="padding: 4px; color: #666;">"{{ incipit.notacion_musical|truncatechars:60 }}"</td>
                                        </tr>
                                        <tr style="background: #e7f3ff;">
                                            <td style="padding: 4px; vertical-align: top;"><strong>PAEC FULL:</strong></td>
                                            <td style="padding: 4px;">
                                                <code style="color: #d63384; word-break: break-all;">{{ incipit.paec_full }}</code>
                                            </td>
                                        </tr>
                                        <tr style="background: #fff;">
                                            <td style="padding: 4px;"><strong>JSON ID:</strong></td>
                                            <td style="padding: 4px; color: #28a745;">paec_json_{{ incipit.pk }}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>

                            {% elif incipit.notacion_musical %}
                            {# ========== FALLBACK: si paec_full est√° vac√≠o pero hay body ========== #}
                            <div class="alert alert-warning" style="padding: 1rem; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px;">
                                <strong>‚ö†Ô∏è Advertencia:</strong> Este √≠ncipit tiene <code>notacion_musical</code> pero no <code>paec_full</code>.
                                <br>Ejecuta la migraci√≥n o actualiza el registro para regenerar el PAEC completo.
                                <br><small>Body: <code>{{ incipit.notacion_musical|truncatechars:80 }}</code></small>
                            </div>

                            {% else %}
                            {# ========== Sin notaci√≥n musical ========== #}
                            <div class="text-muted" style="font-style: italic; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
                                No hay notaci√≥n musical disponible para este √≠ncipit.
                            </div>
                            {% endif %}

                            {% if incipit.urls.all %}
                            <div class="incipit-urls" style="margin-top: 1rem;">
                                {% for u in incipit.urls.all %}
                                <a href="{{ u.url }}" target="_blank" class="acceso-link">
                                    Ver √≠ncipit en l√≠nea <i class="bi bi-box-arrow-up-right"></i>
                                </a>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    {% if obra.ediciones.all %}
                        {% for edicion in obra.ediciones.all %}
                        <div class="data-row">
                            <span class="campo-tag">250</span>
                            <span>{{ edicion.edicion }}</span>
                        </div>
                        {% endfor %}
                    {% endif %}

                {% if obra.tonalidad_384 %}
                <div class="data-row"><span class="campo-tag">384</span>{{ obra.tonalidad_384 }}</div>
                {% endif %}
            </section>

            <!-- ================= MATERIAS Y SERIE ================= -->
            <section id="materias_serie" class="detalle-section">
                <h3>Materias y Serie</h3>

                {% if obra.materias_650.exists or obra.materias_655.exists %}
                <div class="data-grid-compact">
                    {% for mat in obra.materias_650.all %}
                    <div class="data-row">
                        <span class="campo-tag">650</span>
                        <span>
                            {% if mat.materia %}$a {{ mat.materia }}{% else %}‚Äî{% endif %}
                            {% if mat.subdivisiones.all %}
                                {% for sub in mat.subdivisiones.all %}$x {{ sub.subdivision }}{% if not forloop.last %} $v {% endif %}{% endfor %}
                            {% endif %}
                        </span>
                    </div>
                    {% endfor %}

                    {% for mat in obra.materias_655.all %}
                    <div class="data-row">
                        <span class="campo-tag">655</span>
                        <span>
                            {% if mat.materia %}$a {{ mat.materia }}{% else %}‚Äî{% endif %}
                            {% if mat.subdivisiones.all %}
                                {% for sub in mat.subdivisiones.all %}$x {{ sub.subdivision }}{% if not forloop.last %} $v {% endif %}{% endfor %}
                            {% endif %}
                        </span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted">No hay materias registradas.</p>
                {% endif %}


            </section>
            <!-- ================= NOTAS ================= -->
            <section id="nuevas_notas" class="detalle-section">
                <h3>Notas</h3>

                <!-- ===== 500 ‚Äì Nota general (R) ===== -->
                {% if obra.notas_generales_500.all %}
                    {% for nota in obra.notas_generales_500.all %}
                    <div class="data-row">
                        <span class="campo-tag">500</span>
                        <span>$a {{ nota.nota_general }}</span>
                    </div>
                    {% empty %}
                    <p class="text-muted">No hay notas generales registradas.</p>
                    {% endfor %}
                {% endif %}

                <!-- ===== 505 ‚Äì Contenido (R) ===== -->
                {% if obra.contenidos_505.all %}
                    {% for contenido in obra.contenidos_505.all %}
                    <div class="data-row">
                        <span class="campo-tag">505</span>
                        <span>$a {{ contenido.contenido }}</span>
                    </div>
                    {% empty %}
                    <p class="text-muted">No hay contenidos registrados.</p>
                    {% endfor %}
                {% endif %}

                <!-- ===== 520 ‚Äì Sumario (R) ===== -->
                {% if obra.sumarios_520.all %}
                    {% for sumario in obra.sumarios_520.all %}
                    <div class="data-row">
                        <span class="campo-tag">520</span>
                        <span>$a {{ sumario.sumario }}</span>
                    </div>
                    {% empty %}
                    <p class="text-muted">No hay sumarios registrados.</p>
                    {% endfor %}
                {% endif %}

                <!-- ===== 545 ‚Äì Datos biogr√°ficos del compositor (NR) ===== -->
                {% if obra.datos_biograficos_545 %}

                    <div class="data-row">
                        <span class="campo-tag">545</span>
                        <span>
                            {% if obra.datos_biograficos_545.texto_biografico %}
                                $a {{ obra.datos_biograficos_545.texto_biografico }}
                            {% endif %}

                            {% if obra.datos_biograficos_545.uri %}
                                $u <a href="{{ obra.datos_biograficos_545.uri }}" target="_blank">
                                    {{ obra.datos_biograficos_545.uri }}
                                </a>
                            {% endif %}
                        </span>
                    </div>
                {% endif %}
            </section>

            <!-- ================= RELACIONES ================= -->
            <section id="relaciones" class="detalle-section">
                <h3>Relaciones</h3>

                <!-- ===== 773 ‚Äì Enlace a documento fuente (R) ===== -->
                {% if obra.enlaces_documento_fuente_773.all %}
                    <h4 class="subsection-title mt-3">Documento fuente</h4>
                    {% for enlace in obra.enlaces_documento_fuente_773.all %}
                    <div class="data-row">
                        <span class="campo-tag">773</span>
                        <span>
                            {% if enlace.encabezamiento_principal %}
                                $a {{ enlace.encabezamiento_principal }}.
                            {% endif %}

                            {% if enlace.titulo %}
                                $t <em>{{ enlace.titulo }}</em>.
                            {% endif %}

                            {% if enlace.numeros_control.all %}
                                {% for w in enlace.numeros_control.all %}
                                    $w ({{ w.obra_relacionada.num_control }})
                                {% endfor %}
                            {% endif %}
                        </span>
                    </div>
                    {% empty %}
                    <p class="text-muted">No hay enlaces 773 registrados.</p>
                    {% endfor %}
                {% endif %}

                <!-- ===== 774 ‚Äì Unidad constituyente (R) ===== -->
                {% if obra.enlaces_unidades_774.all %}
                    {% for enlace in obra.enlaces_unidades_774.all %}
                    <div class="data-row">
                        <span class="campo-tag">774</span>
                        <span>
                            {% if enlace.encabezamiento_principal %}
                                $a {{ enlace.encabezamiento_principal }}.
                            {% endif %}

                            {% if enlace.titulo %}
                                $t <em>{{ enlace.titulo }}</em>.
                            {% endif %}

                            {% if enlace.numeros_control.all %}
                                {% for w in enlace.numeros_control.all %}
                                    $w ({{ w.obra_relacionada.num_control }})
                                {% endfor %}
                            {% endif %}
                        </span>
                    </div>
                    {% empty %}
                    <p class="text-muted">No hay unidades constituyentes 774 registradas.</p>
                    {% endfor %}
                {% endif %}

                <!-- ===== 787 ‚Äì Otras relaciones (R) ===== -->
                {% if obra.otras_relaciones_787.all %}
                    <h4 class="subsection-title mt-3">Otras relaciones</h4>
                    {% for enlace in obra.otras_relaciones_787.all %}
                    <div class="data-row">
                        <span class="campo-tag">787</span>
                        <span>
                            {% if enlace.encabezamiento_principal %}
                                $a {{ enlace.encabezamiento_principal }}.
                            {% endif %}

                            {% if enlace.titulo %}
                                $t <em>{{ enlace.titulo }}</em>.
                            {% endif %}

                            {% if enlace.numeros_control.all %}
                                {% for w in enlace.numeros_control.all %}
                                    $w ({{ w.obra_relacionada.num_control }})
                                {% endfor %}
                            {% endif %}
                        </span>
                    </div>
                    {% empty %}
                    <p class="text-muted">No hay relaciones 787 registradas.</p>
                    {% endfor %}
                {% endif %}
            </section>
            <!-- ================= EXISTENCIAS ================= -->
            <section id="existencias" class="detalle-section">
                <h3>Existencias</h3>
                {% if obra.ubicaciones_852.all %}
                <div class="data-grid-compact">
                    {% for ubicacion in obra.ubicaciones_852.all %}
                    <div class="data-row">
                        <span class="campo-tag">852</span>
                        <span>
                            {% if ubicacion.signatura_original %}
                                $a {{ ubicacion.signatura_original }}
                            {% endif %}
                            {% if ubicacion.estanterias.all %}
                                $b {% for estanteria in ubicacion.estanterias.all %}{{ estanteria.estanteria }}{% if not forloop.last %}, {% endif %}{% endfor %}
                            {% endif %}
                            {% if ubicacion.codigo_o_nombre %}
                                $c {{ ubicacion.codigo_o_nombre }}
                            {% endif %}
                        </span>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                {% if obra.disponibles_856.exists %}

                {% for disponible in obra.disponibles_856.all %}
                    {% for url in disponible.urls_856.all %}
                    <div class="data-row">
                        <span class="campo-tag">856</span>
                        <a href="{{ url.url }}" class="acceso-link" target="_blank">
                            {% if disponible.textos_enlace_856.first %}
                                $a {{ disponible.textos_enlace_856.first.texto_enlace }}
                            {% else %}
                                $u {{ url.url }}
                            {% endif %}
                            <i class="bi bi-box-arrow-up-right"></i>
                        </a>
                    </div>
                    {% endfor %}
                {% endfor %}
                {% endif %}
            </section>

        </main>
    </div>
</div>

<!-- ================= JS ================= -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    console.log('üîç Inicializando navegaci√≥n del sidebar de detalle...');

    const links = document.querySelectorAll('.detalle-sidebar .nav-link');
    const sections = document.querySelectorAll('.detalle-section');

    console.log('üìä Links encontrados:', links.length);
    console.log('üìä Secciones encontradas:', sections.length);

    if (!links.length || !sections.length) {
        console.warn('‚ö†Ô∏è No se encontraron links o secciones para la navegaci√≥n');
        return;
    }

    // Funci√≥n para actualizar link activo
    function updateActiveLink(targetId) {
        links.forEach(link => {
            const isActive = link.getAttribute('href') === `#${targetId}`;
            link.classList.toggle('active', isActive);
            console.log(`üîÑ Link ${link.getAttribute('href')} -> ${isActive ? 'activo' : 'inactivo'}`);
        });
    }

    links.forEach(link => {
        link.addEventListener('click', e => {
            e.preventDefault();
            const targetId = link.getAttribute('href').substring(1); // quitar el #
            const target = document.getElementById(targetId);

            console.log(`üéØ Click en link: ${targetId}`);

            if (!target) {
                console.error(`‚ùå No se encontr√≥ la secci√≥n con ID: ${targetId}`);
                return;
            }

            // Actualizar link activo inmediatamente
            updateActiveLink(targetId);

            // Hacer scroll suave
            const offsetTop = target.offsetTop - 90;
            console.log(`üìç Haciendo scroll a: ${offsetTop}px`);

            window.scrollTo({
                top: offsetTop,
                behavior: 'smooth'
            });
        });
    });

    // Observer para detectar secci√≥n visible al hacer scroll
    const observer = new IntersectionObserver(entries => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                console.log(`üëÅÔ∏è Secci√≥n visible: ${entry.target.id}`);
                updateActiveLink(entry.target.id);
            }
        });
    }, {
        rootMargin: '-40% 0px -40% 0px',
        threshold: 0.1
    });

    sections.forEach(section => {
        console.log(`üîç Observando secci√≥n: ${section.id}`);
        observer.observe(section);
    });

    // Activar primer link por defecto
    const firstLink = links[0];
    if (firstLink) {
        const firstId = firstLink.getAttribute('href').substring(1);
        console.log(`üöÄ Activando primer link: ${firstId}`);
        updateActiveLink(firstId);
    }
});
</script>

<!-- Motor del canvas -->
<script src="{% static 'catalogacion/js/incipitManager.js' %}"></script>
<script src="{% static 'catalogacion/js/incipitInit.js' %}"></script>


<style>
  .incipit-view-canvas { pointer-events: none; }
</style>


{% endblock catalogacion_content %}
