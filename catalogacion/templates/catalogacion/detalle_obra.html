{% extends 'catalogacion/base_catalogacion.html' %}
{% load static %}

{% block title %}{{ obra.titulo_principal }} - Detalle de Obra{% endblock %}
{% block page_title %}Detalle de Obra{% endblock %}

{% block catalogacion_css %}
<link rel="stylesheet" href="{% static 'catalogacion/css/detalle-obra.css' %}">
{% endblock %}

{% block catalogacion_content %}
<div class="detalle-container">
    
    <!-- ============= ENCABEZADO ============= -->
    <div class="detalle-header">
        <div class="header-content">

            <!-- Migas -->
            <div class="header-breadcrumb">
                <a href="{% url 'usuarios:catalogador_dashboard' %}">Inicio</a>
                <span class="separator">‚Ä∫</span>
                <a href="{% url 'catalogacion:lista_obras' %}">Cat√°logo</a>
                <span class="separator">‚Ä∫</span>
                <span class="current">{{ obra.titulo_principal|truncatewords:5 }}</span>
            </div>
            
            <div class="header-main">
                <div class="header-info">

                    <!-- SOLO SIGNATURA ARRIBA -->
                    {% if obra.signatura_completa %}
                    <div class="signatura-badge">
                        <i class="bi bi-bookmark-fill"></i>
                        <span>{{ obra.signatura_completa }}</span>
                    </div>
                    {% endif %}

                </div>

                <div class="header-actions">
                    <a href="{% url 'catalogacion:editar_obra' pk=obra.pk %}" class="btn-action">
                        <i class="bi bi-pencil"></i>
                        Editar
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- ============= BODY CON SIDEBAR ============= -->
    <div class="detalle-body">

        <!-- üîπ SIDEBAR -->
        <aside class="detalle-sidebar">
            <nav class="sidebar-nav">
                <div class="nav-header"><h6>Contenido</h6></div>
                <ul class="nav-list">
                    <li><a href="#seccion-info" class="nav-link active"><i class="bi bi-info-circle"></i> Informaci√≥n General</a></li>
                    <li><a href="#seccion-titulos" class="nav-link"><i class="bi bi-music-note-beamed"></i> T√≠tulos & Puntos de acceso</a></li>
                    <li><a href="#seccion-colaboradores" class="nav-link"><i class="bi bi-people"></i> Colaboradores</a></li>
                    <li><a href="#seccion-produccion" class="nav-link"><i class="bi bi-building"></i> Producci√≥n</a></li>
                    <li><a href="#seccion-musical" class="nav-link"><i class="bi bi-music-note-list"></i> Datos musicales</a></li>
                    <li><a href="#seccion-materias" class="nav-link"><i class="bi bi-tags"></i> Materias / G√©neros</a></li>
                    <li><a href="#seccion-notas" class="nav-link"><i class="bi bi-journal-text"></i> Notas</a></li>
                    <li><a href="#seccion-ubicacion" class="nav-link"><i class="bi bi-geo-alt"></i> Ubicaci√≥n y Acceso</a></li>
                </ul>
            </nav>
        </aside>

        <!-- ============= CONTENIDO PRINCIPAL ============= -->
        <main class="detalle-main">

            <!-- üü¶ SECCI√ìN 1: Informaci√≥n general -->
            <section id="seccion-info" class="detalle-section">
                <div class="section-header">
                    <h3 class="section-title"><i class="bi bi-info-circle"></i> Informaci√≥n General</h3>
                </div>

                <div class="data-grid-compact">
                    {% if obra.centro_catalogador %}
                    <div class="data-row">
                        <span class="campo-tag">040</span>
                        <span>Centro catalogador:</span>
                        <strong>{{ obra.centro_catalogador }}</strong>
                    </div>
                    {% endif %}
                    
                    {% if obra.ms_imp %}
                    <div class="data-row">
                        <span class="campo-tag">340</span>
                        <span>Tipo de material:</span>
                        <span>{{ obra.get_ms_imp_display }}</span>
                    </div>
                    {% endif %}

                    {% if obra.extension or obra.otras_caracteristicas or obra.dimension or obra.material_acompanante %}
                    <div class="data-row">
                        <span class="campo-tag">300</span>
                        <span>
                            {% if obra.extension %}{{ obra.extension }}{% endif %}
                            {% if obra.otras_caracteristicas %} ; {{ obra.otras_caracteristicas }}{% endif %}
                            {% if obra.dimension %} ; {{ obra.dimension }}{% endif %}
                            {% if obra.material_acompanante %} ; {{ obra.material_acompanante }}{% endif %}
                        </span>
                    </div>
                    {% endif %}
                </div>
            </section>

            <!-- üü© SECCI√ìN 2: T√≠tulos & puntos de acceso -->
            <section id="seccion-titulos" class="detalle-section">
                <div class="section-header">
                    <h3 class="section-title"><i class="bi bi-bookmark"></i> T√≠tulos y Puntos de Acceso</h3>
                </div>

                <div class="titulos-bloque">

                    {# 100 ‚Äì Compositor principal #}
                    {% if obra.compositor %}
                    <div class="data-row-alt">
                        <span class="campo-tag">100</span>
                        <div class="data-cell">
                            <div class="linea-principal">
                                <strong>{{ obra.compositor }}</strong>
                                {% if obra.compositor.coordenadas_biograficas %}
                                    ({{ obra.compositor.coordenadas_biograficas }})
                                {% endif %}
                            </div>
                            {% if obra.termino_asociado %}
                                <div class="linea-secundaria">
                                    <em>{{ obra.termino_asociado }}</em>
                                </div>
                            {% endif %}
                            {% if obra.autoria %}
                                <div class="linea-secundaria">
                                    Autor√≠a: {{ obra.get_autoria_display }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    {# 130 ‚Äì T√≠tulo uniforme principal (sin compositor) #}
                    {% if obra.titulo_uniforme %}
                    <div class="data-row-alt">
                        <span class="campo-tag">130</span>
                        <div class="data-cell">
                            <div class="linea-principal">
                                <strong>{{ obra.titulo_uniforme }}</strong>
                            </div>
                            <div class="linea-secundaria">
                                {% if obra.forma_130 %}{{ obra.forma_130 }}{% endif %}
                                {% if obra.medio_interpretacion_130 %}{% if obra.forma_130 %} , {% endif %}{{ obra.medio_interpretacion_130 }}{% endif %}
                                {% if obra.numero_parte_130 %} ; {{ obra.numero_parte_130 }}{% endif %}
                                {% if obra.nombre_parte_130 %} ; {{ obra.nombre_parte_130 }}{% endif %}
                                {% if obra.tonalidad_130 %} ; {{ obra.tonalidad_130 }}{% endif %}
                                {% if obra.arreglo_130 %} ; {{ obra.get_arreglo_130_display|default:obra.arreglo_130 }}{% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {# 240 ‚Äì T√≠tulo uniforme secundario (con compositor) #}
                    {% if obra.titulo_240 %}
                    <div class="data-row-alt">
                        <span class="campo-tag">240</span>
                        <div class="data-cell">
                            <div class="linea-principal">
                                <strong>{{ obra.titulo_240 }}</strong>
                            </div>
                            <div class="linea-secundaria">
                                {% if obra.forma_240 %}{{ obra.forma_240 }}{% endif %}
                                {% if obra.medio_interpretacion_240 %}{% if obra.forma_240 %} , {% endif %}{{ obra.medio_interpretacion_240 }}{% endif %}
                                {% if obra.numero_parte_240 %} ; {{ obra.numero_parte_240 }}{% endif %}
                                {% if obra.nombre_parte_240 %} ; {{ obra.nombre_parte_240 }}{% endif %}
                                {% if obra.tonalidad_240 %} ; {{ obra.tonalidad_240 }}{% endif %}
                                {% if obra.arreglo_240 %} ; {{ obra.get_arreglo_240_display|default:obra.arreglo_240 }}{% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {# 245 ‚Äì T√≠tulo principal #}
                    {% if obra.titulo_principal %}
                    <div class="data-row-alt">
                        <span class="campo-tag">245</span>
                        <div class="data-cell">
                            <div class="linea-principal">
                                <strong>{{ obra.titulo_principal }}</strong>{% if obra.subtitulo %} : {{ obra.subtitulo }}{% endif %}
                            </div>
                            {% if obra.mencion_responsabilidad %}
                            <div class="linea-secundaria">
                                / {{ obra.mencion_responsabilidad }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    {# 246 ‚Äì T√≠tulos alternativos #}
                    {% if obra.titulos_alternativos.all %}
                        {% for alt in obra.titulos_alternativos.all %}
                        <div class="data-row-alt">
                            <span class="campo-tag">246</span>
                            <div class="data-cell">
                                <div class="linea-principal">
                                    {{ alt.titulo }}
                                    {% if alt.resto_titulo %}: {{ alt.resto_titulo }}{% endif %}
                                </div>
                                {% if alt.texto_visualizacion %}
                                <div class="linea-secundaria">
                                    [{{ alt.texto_visualizacion }}]
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </section>

            <!-- üüß SECCI√ìN 3: Colaboradores (700 / 710) -->
            <section id="seccion-colaboradores" class="detalle-section">
                <div class="section-header">
                    <h3 class="section-title"><i class="bi bi-people"></i> Colaboradores</h3>
                </div>

                {% if obra.nombres_relacionados_700.all or obra.entidades_relacionadas_710.all %}
                <div class="colaboradores-list">

                    {% for nombre in obra.nombres_relacionados_700.all %}
                    <div class="data-row">
                        <span class="campo-tag">700</span>
                        <span class="data-label">
                            {% if nombre.persona %}{{ nombre.persona }}{% else %}‚Äî{% endif %}
                        </span>
                        <span class="data-extra">
                            {% if nombre.coordenadas_biograficas %}
                                ({{ nombre.coordenadas_biograficas }})
                            {% endif %}
                            {% if nombre.funciones.all %}
                                ‚Äî {{ nombre.funciones.all.0.get_funcion_display }}
                            {% endif %}
                            {% if nombre.autoria %}
                                ‚Äî {{ nombre.get_autoria_display }}
                            {% endif %}
                            {% if nombre.titulo_obra %}
                                ‚Äî ¬´{{ nombre.titulo_obra }}¬ª
                            {% endif %}
                        </span>
                    </div>
                    {% endfor %}

                    {% for entidad in obra.entidades_relacionadas_710.all %}
                    <div class="data-row">
                        <span class="campo-tag">710</span>
                        <span class="data-label">
                            {% if entidad.entidad %}{{ entidad.entidad }}{% else %}‚Äî{% endif %}
                        </span>
                        {% if entidad.funcion %}
                        <span class="data-extra">({{ entidad.get_funcion_display }})</span>
                        {% endif %}
                    </div>
                    {% endfor %}

                </div>
                {% else %}
                    <p class="text-muted">No hay colaboradores registrados.</p>
                {% endif %}
            </section>

            <!-- üü® SECCI√ìN 4: Producci√≥n y Edici√≥n (250 / 264) -->
            <section id="seccion-produccion" class="detalle-section">
                <div class="section-header">
                    <h3 class="section-title"><i class="bi bi-building"></i> Producci√≥n / Edici√≥n</h3>
                </div>

                <div class="data-grid-compact">

                    {# 264 ‚Äì Producci√≥n / Publicaci√≥n #}
                    {% if obra.producciones_publicaciones.all %}
                        {% for prod in obra.producciones_publicaciones.all %}
                        <div class="data-row">
                            <span class="campo-tag">264</span>
                            <span>
                                [{{ prod.get_funcion_display }}]
                                {% if prod.lugares.all %}
                                    {% for lugar in prod.lugares.all %}
                                        {{ lugar.lugar }}{% if not forloop.last %} ; {% endif %}
                                    {% endfor %}
                                {% endif %}
                                {% if prod.entidades.all %}
                                    ‚Äî 
                                    {% for ent in prod.entidades.all %}
                                        {{ ent.nombre }}{% if not forloop.last %} ; {% endif %}
                                    {% endfor %}
                                {% endif %}
                                {% if prod.fechas.all %}
                                    ‚Äî 
                                    {% for f in prod.fechas.all %}
                                        {{ f.fecha }}{% if not forloop.last %} ; {% endif %}
                                    {% endfor %}
                                {% endif %}
                            </span>
                        </div>
                        {% endfor %}
                    {% endif %}

                    {# 250 ‚Äì Edici√≥n #}
                    {% if obra.ediciones.all %}
                        {% for edicion in obra.ediciones.all %}
                        <div class="data-row">
                            <span class="campo-tag">250</span>
                            <span>{{ edicion.edicion }}</span>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </section>

            <!-- üü¶ SECCI√ìN 5: Datos Musicales (348 / 382 / 383 / 384 / 031) -->
            <section id="seccion-musical" class="detalle-section">
                <div class="section-header">
                    <h3 class="section-title"><i class="bi bi-music-note-list"></i> Datos Musicales</h3>
                </div>

                <div class="data-grid-compact">

                    {# 348 ‚Äì Formato #}
                    {% if obra.formato %}
                    <div class="data-row">
                        <span class="campo-tag">348</span>
                        <span>Formato: {{ obra.get_formato_display }}</span>
                    </div>
                    {% endif %}

                    {# 382 ‚Äì Medios de interpretaci√≥n #}
                    {% if obra.medios_interpretacion_382.all %}
                    <div class="data-row full">
                        <span class="campo-tag">382</span>
                        <div class="data-cell">
                            {% for medio in obra.medios_interpretacion_382.all %}
                                <div class="medio-item">
                                    {% if medio.medios.all %}
                                        {% for m in medio.medios.all %}
                                            {{ m.get_medio_display }}{% if not forloop.last %}, {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                    {% if medio.solista %}
                                        ‚Äî Solista: {{ medio.solista }}
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    {# 383 ‚Äì N√∫mero de obra / Opus #}
                    {% if obra.numero_obra or obra.opus %}
                    <div class="data-row">
                        <span class="campo-tag">383</span>
                        <span>
                            {% if obra.numero_obra %}{{ obra.numero_obra }}{% endif %}
                            {% if obra.opus %}{% if obra.numero_obra %} / {% endif %}Op. {{ obra.opus }}{% endif %}
                        </span>
                    </div>
                    {% endif %}

                    {# 384 ‚Äì Tonalidad #}
                    {% if obra.tonalidad_384 %}
                    <div class="data-row">
                        <span class="campo-tag">384</span>
                        <span>{{ obra.tonalidad_384 }}</span>
                    </div>
                    {% endif %}
                </div>

                {# 031 ‚Äì √çncipits musicales #}
                {% if obra.incipits_musicales.all %}
                <div class="incipit-section">
                    <h4 class="subsection-title">√çncipit Musical (031)</h4>
                    {% for incipit in obra.incipits_musicales.all %}
                    <div class="incipit-card">
                        <div class="incipit-header">
                            <strong>Obra {{ incipit.numero_obra }}, mov. {{ incipit.numero_movimiento }}, pas. {{ incipit.numero_pasaje }}</strong>
                        </div>
                        {% if incipit.titulo_encabezamiento %}
                        <div class="incipit-subtitle">
                            {{ incipit.titulo_encabezamiento }}
                        </div>
                        {% endif %}
                        <div class="incipit-meta">
                            {% if incipit.voz_instrumento %}{{ incipit.voz_instrumento }}{% endif %}
                            {% if incipit.clave %} ¬∑ Clave: {{ incipit.clave }}{% endif %}
                            {% if incipit.armadura %} ¬∑ Armadura: {{ incipit.armadura }}{% endif %}
                            {% if incipit.tiempo %} ¬∑ Tiempo: {{ incipit.tiempo }}{% endif %}
                        </div>
                        {% if incipit.notacion_musical %}
                        <code class="incipit-code">{{ incipit.notacion_musical|truncatechars:120 }}</code>
                        {% endif %}
                        {% if incipit.urls.all %}
                        <div class="incipit-urls">
                            {% for u in incipit.urls.all %}
                            <a href="{{ u.url }}" target="_blank" class="acceso-link">
                                Ver √≠ncipit en l√≠nea <i class="bi bi-box-arrow-up-right"></i>
                            </a>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </section>

            <!-- üü© SECCI√ìN 6: Materias y G√©neros (650 / 655 / 490) -->
            <section id="seccion-materias" class="detalle-section">
                <div class="section-header">
                    <h3 class="section-title"><i class="bi bi-tags"></i> Materias / G√©neros</h3>
                </div>

                <div class="materias-container">

                    {# 650 ‚Äì Materias #}
                    {% for mat in obra.materias_650.all %}
                    <div class="materia-tag">
                        <span class="campo-tag">650</span>
                        <span>
                            {% if mat.materia %}{{ mat.materia }}{% else %}‚Äî{% endif %}
                            {% if mat.subdivisiones.all %}
                                ‚Äî 
                                {% for sub in mat.subdivisiones.all %}
                                    {{ sub.subdivision }}{% if not forloop.last %} ; {% endif %}
                                {% endfor %}
                            {% endif %}
                        </span>
                    </div>
                    {% endfor %}

                    {# 655 ‚Äì G√©nero / forma #}
                    {% for mat in obra.materias_655.all %}
                    <div class="materia-tag">
                        <span class="campo-tag">655</span>
                        <span>
                            {% if mat.materia %}{{ mat.materia }}{% else %}‚Äî{% endif %}
                            {% if mat.subdivisiones.all %}
                                ‚Äî 
                                {% for sub in mat.subdivisiones.all %}
                                    {{ sub.subdivision }}{% if not forloop.last %} ; {% endif %}
                                {% endfor %}
                            {% endif %}
                        </span>
                    </div>
                    {% endfor %}
                </div>

                {# 490 ‚Äì Series #}
                {% if obra.menciones_serie.all %}
                <h4 class="subsection-title mt-3">Series</h4>
                {% for mencion in obra.menciones_serie.all %}
                <div class="data-row">
                    <span class="campo-tag">490</span>
                    <span>
                        {% if mencion.titulos.all %}
                            {% for t in mencion.titulos.all %}
                                {{ t.titulo_serie }}{% if not forloop.last %} ; {% endif %}
                            {% endfor %}
                        {% endif %}
                        {% if mencion.volumenes.all %}
                            ‚Äî 
                            {% for v in mencion.volumenes.all %}
                                {{ v.volumen }}{% if not forloop.last %} ; {% endif %}
                            {% endfor %}
                        {% endif %}
                    </span>
                </div>
                {% endfor %}
                {% endif %}
            </section>

            <!-- üü• SECCI√ìN 7: Notas (500 / 505 / 520 / 545) -->
            <section id="seccion-notas" class="detalle-section">
                <div class="section-header">
                    <h3 class="section-title"><i class="bi bi-journal-text"></i> Notas</h3>
                </div>

                <div class="notas-list">
                    {% for nota in obra.notas_generales_500.all %}
                    {% if nota.nota_general %}
                    <div class="nota-item">
                        <span class="campo-tag">500</span> {{ nota.nota_general }}
                    </div>
                    {% endif %}
                    {% endfor %}

                    {% for conte in obra.contenidos_505.all %}
                    {% if conte.contenido %}
                    <div class="nota-item">
                        <span class="campo-tag">505</span> {{ conte.contenido }}
                    </div>
                    {% endif %}
                    {% endfor %}

                    {% for sumario in obra.sumarios_520.all %}
                    {% if sumario.sumario %}
                    <div class="nota-item">
                        <span class="campo-tag">520</span> {{ sumario.sumario }}
                    </div>
                    {% endif %}
                    {% endfor %}

                    {% if obra.datos_biograficos_545 and obra.datos_biograficos_545.texto_biografico %}
                    <div class="nota-item">
                        <span class="campo-tag">545</span> {{ obra.datos_biograficos_545.texto_biografico }}
                    </div>
                    {% endif %}
                </div>
            </section>

            <!-- üü™ SECCI√ìN 8: Ubicaci√≥n y Acceso (852 / 856) -->
            <section id="seccion-ubicacion" class="detalle-section">
                <div class="section-header">
                    <h3 class="section-title"><i class="bi bi-geo-alt"></i> Ubicaci√≥n y acceso</h3>
                </div>

                {# 852 ‚Äì Ubicaci√≥n f√≠sica #}
                {% if obra.ubicaciones_852.all %}
                <div class="ubicaciones-list">
                    {% for ubicacion in obra.ubicaciones_852.all %}
                    <div class="ubicacion-item">
                        <span class="campo-tag">852</span>
                        <span class="ubicacion-parte">
                            {% if ubicacion.signatura_original %}
                                {{ ubicacion.signatura_original }}
                            {% endif %}
                            {% if ubicacion.estanterias.all %}
                                ‚Äî Estanter√≠a:
                                {% for estanteria in ubicacion.estanterias.all %}
                                    {{ estanteria.estanteria }}{% if not forloop.last %}, {% endif %}
                                {% endfor %}
                            {% endif %}
                            {% if ubicacion.codigo_o_nombre %}
                                ‚Äî {{ ubicacion.codigo_o_nombre }}
                            {% endif %}
                        </span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted">No hay ubicaci√≥n registrada.</p>
                {% endif %}

                {# 856 ‚Äì Recursos en l√≠nea #}
                {% if obra.disponibles_856.all %}
                <h4 class="subsection-title mt-4">Disponible en l√≠nea</h4>
                {% for disponible in obra.disponibles_856.all %}
                    {% for url in disponible.urls_856.all %}
                    <div class="acceso-item">
                        <span class="campo-tag">856</span>
                        <a href="{{ url.url }}" class="acceso-link" target="_blank">
                            {% if disponible.textos_enlace_856.first %}
                                {{ disponible.textos_enlace_856.first.texto_enlace }}
                            {% else %}
                                {{ url.url }}
                            {% endif %}
                            <i class="bi bi-box-arrow-up-right"></i>
                        </a>
                    </div>
                    {% endfor %}
                {% endfor %}
                {% endif %}

            </section>

        </main>
    </div>
</div>

<!-- üîó Script para navegaci√≥n lateral y scroll suave -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const navLinks = document.querySelectorAll('.nav-link');
    const sections = document.querySelectorAll('.detalle-section');

    navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href');
            const targetSection = document.querySelector(targetId);
            if (!targetSection) return;

            const offset = 80;
            const position = targetSection.offsetTop - offset;

            window.scrollTo({ top: position, behavior: 'smooth' });

            navLinks.forEach(l => l.classList.remove('active'));
            this.classList.add('active');
        });
    });

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const id = entry.target.getAttribute('id');
                navLinks.forEach(link => {
                    link.classList.toggle('active', link.getAttribute('href') === `#${id}`);
                });
            }
        });
    }, {
        root: null,
        rootMargin: '-40% 0px -40% 0px',
        threshold: 0
    });

    sections.forEach(section => observer.observe(section));
});
</script>

{% endblock catalogacion_content %}
