{% extends 'catalogacion/base_catalogacion.html' %}
{% load static %}

{% block title %}{{ obra.titulo_principal }} - Detalle de Obra{% endblock %}
{% block page_title %}Detalle de Obra{% endblock %}

{% block catalogacion_css %}
<link rel="stylesheet" href="{% static 'catalogacion/css/detalle-obra.css' %}">

<style>
@font-face {
  font-family: 'Maestro';
  src: url("{% static 'catalogacion/fonts/Maestro.ttf' %}") format('truetype');
  font-weight: normal;
  font-style: normal;
}

.incipit-view-canvas {
  width: 100%;
  max-width: 500px;
  display: block;
  background: transparent;
  pointer-events: none;
  cursor: default;
}

/* Badges de tipo de obra con colores espec√≠ficos */
.tipo-badge.manuscrito.coleccion {
    background: #007bff;
    color: white;
    border-color: #0056b3;
}

.tipo-badge.manuscrito.obra-coleccion {
    background: #6f42c1;
    color: white;
    border-color: #5a32a3;
}

.tipo-badge.manuscrito.obra-individual {
    background: #17a2b8;
    color: white;
    border-color: #138496;
}

.tipo-badge.impreso.coleccion {
    background: #28a745;
    color: white;
    border-color: #1e7e34;
}

.tipo-badge.impreso.obra-coleccion {
    background: #fd7e14;
    color: #212529;
    border-color: #d63384;
}

.tipo-badge.impreso.obra-individual {
    background: #6c757d;
    color: white;
    border-color: #5c636a;
}

.tipo-badge.obra {
    background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
    color: #4527a0;
    border-color: #ce93d8;
}

/* Estados de publicaci√≥n con mismos estilos que tipo-badge */
.tipo-badge.publicada {
    background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
    color: #2e7d32;
    border-color: #a5d6a7;
}

.tipo-badge.no-publicada {
    background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
    color: #6c757d;
    border-color: #adb5bd;
}

</style>
{% endblock %}

{% block catalogacion_content %}
<div class="detalle-container">

    <!-- ============= ENCABEZADO ============= -->
    <div class="detalle-header">
        <div class="header-content">

            <div class="header-breadcrumb">
                <a href="{% url 'usuarios:catalogador_dashboard' %}">Inicio</a>
                <span class="separator">‚Ä∫</span>
                <a href="{% url 'catalogacion:lista_obras' %}">Cat√°logo</a>
                <span class="separator">‚Ä∫</span>
                <span class="current">{{ obra.titulo_principal|truncatewords:5 }}</span>
            </div>

            <div class="header-main">
                <div class="header-info">

                    {% if obra.signatura_completa %}
                    <div class="signatura-badge">
                        <i class="bi bi-bookmark-fill"></i>
                        <span>{{ obra.signatura_completa }}</span>
                    </div>
                    {% endif %}

                    {# Badges de tipo y publicaci√≥n #}
                    <div class="d-flex align-items-center gap-2 ms-3">
                        {% if obra.tipo_registro == 'd' %}
                            {% if obra.nivel_bibliografico == 'c' %}
                                <span class="badge bg-info">Colecci√≥n Manuscrita</span>
                            {% elif obra.nivel_bibliografico == 'a' %}
                                <span class="badge bg-info">Obra en Colecci√≥n Manuscrita</span>
                            {% else %}
                                <span class="badge bg-info">Obra Individual Manuscrita</span>
                            {% endif %}
                        {% else %}
                            {% if obra.nivel_bibliografico == 'c' %}
                                <span class="badge bg-primary">Colecci√≥n Impresa</span>
                            {% elif obra.nivel_bibliografico == 'a' %}
                                <span class="badge bg-primary">Obra en Colecci√≥n Impresa</span>
                            {% else %}
                                <span class="badge bg-primary">Obra Individual Impresa</span>
                            {% endif %}
                        {% endif %}
                        {% if obra.publicada %}
                            <span class="badge bg-success" title="Visible en cat√°logo p√∫blico">
                                <i class="bi bi-globe"></i> Publicada
                            </span>
                        {% else %}
                            <span class="badge bg-secondary" title="No visible en cat√°logo p√∫blico">
                                <i class="bi bi-eye-slash"></i> Sin publicar
                            </span>
                        {% endif %}
                    </div>

                </div>

                <div class="d-flex gap-2">
                    <a href="{% url 'catalogacion:editar_obra' pk=obra.pk %}" class="btn-action">
                        <i class="bi bi-pencil"></i> Editar
                    </a>
                    {% if obra.publicada %}
                        <form method="post" action="{% url 'catalogacion:despublicar_obra' pk=obra.pk %}" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-outline-warning btn-sm" title="Retirar del cat√°logo p√∫blico">
                                <i class="bi bi-eye-slash"></i> Despublicar
                            </button>
                        </form>
                    {% else %}
                        <form method="post" action="{% url 'catalogacion:publicar_obra' pk=obra.pk %}" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-success btn-sm" title="Hacer visible en cat√°logo p√∫blico">
                                <i class="bi bi-globe"></i> Publicar
                            </button>
                        </form>
                    {% endif %}
                </div>
            </div>

        </div>
    </div>

    <!-- ================= BODY ================= -->
    <div class="detalle-body">

        <!-- ========== SIDEBAR ========== -->
        <aside class="detalle-sidebar">
            <nav class="sidebar-nav">
                <div class="nav-header"><h6>Contenido</h6></div>
                <ul class="nav-list">
                    <li><a href="#admin" class="nav-link">Administraci√≥n</a></li>
                    <li><a href="#nombres_titulos" class="nav-link">Nombres y T√≠tulos</a></li>
                    <li><a href="#edicion_produccion" class="nav-link">Producci√≥n / Edici√≥n</a></li>
                    <li><a href="#datomusical" class="nav-link">Datos Musicales</a></li>
                    <li><a href="#materias_serie" class="nav-link">Materias y Serie</a></li>
                    <li><a href="#nuevas_notas" class="nav-link">Notas</a></li>
                    <li><a href="#relaciones" class="nav-link">Relaciones</a></li>
                    <li><a href="#existencias" class="nav-link">Existencias</a></li>
                </ul>
            </nav>
        </aside>

        <!-- ========== CONTENIDO ========== -->
        <main class="detalle-main">
            <!-- ================= ADMINISTRACI√ìN ================= -->
            <section id="admin" class="detalle-section">
                <h3>Administraci√≥n</h3>
                <div class="data-grid-compact">
                    {% if obra.num_control %}
                    <div class="data-row">
                        <span class="campo-tag">001</span>
                        <div class="data-cell">
                            <span class="campo-label">N√∫mero de control</span>
                            <div class="linea-principal"><strong>{{ obra.num_control }}</strong></div>
                        </div>
                    </div>
                    {% endif %}

                    {% if obra.centro_catalogador %}
                    <div class="data-row">
                        <span class="campo-tag">040</span>
                        <div class="data-cell">
                            <span class="campo-label">Centro catalogador</span>
                            <div class="linea-principal"><strong>{{ obra.centro_catalogador }}</strong></div>
                        </div>
                    </div>
                    {% endif %}

                    {% if obra.codigos_lengua.exists %}
                        {% for lengua in obra.codigos_lengua.all %}
                        <div class="data-row">
                            <span class="campo-tag">041</span>
                            <div class="data-cell">
                                <span class="campo-label">C√≥digo de lengua</span>
                                <div class="linea-principal">
                                    {% for idioma in lengua.idiomas.all %}$a <strong>{{ idioma.get_codigo_idioma_display }}</strong>{% if not forloop.last %}, {% endif %}{% endfor %}
                                    {% if lengua.es_traduccion %} <em>(incluye traducci√≥n)</em>{% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}

                    {% if obra.codigos_pais_entidad.exists %}
                        {% for pais in obra.codigos_pais_entidad.all %}
                        <div class="data-row">
                            <span class="campo-tag">044</span>
                            <div class="data-cell">
                                <span class="campo-label">Pa√≠s de publicaci√≥n</span>
                                <div class="linea-principal">$a <strong>{{ pais.get_codigo_pais_display }}</strong></div>
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}

                    {% if obra.catalogador %}
                    <div class="data-row">
                        <span class="campo-tag"><i class="bi bi-person-badge"></i></span>
                        <div class="data-cell">
                            <span class="campo-label">Catalogador</span>
                            <div class="linea-principal"><strong>{{ obra.catalogador.get_full_name|default:obra.catalogador.username }}</strong></div>
                        </div>
                    </div>
                    {% endif %}

                    {% if obra.modificado_por %}
                    <div class="data-row">
                        <span class="campo-tag"><i class="bi bi-pencil-square"></i></span>
                        <div class="data-cell">
                            <span class="campo-label">Modificado por</span>
                            <div class="linea-principal"><strong>{{ obra.modificado_por.get_full_name|default:obra.modificado_por.username }}</strong></div>
                        </div>
                    </div>
                    {% endif %}

                    {% if obra.fecha_creacion_sistema %}
                    <div class="data-row">
                        <span class="campo-tag"><i class="bi bi-calendar-plus"></i></span>
                        <div class="data-cell">
                            <span class="campo-label">Fecha de creaci√≥n</span>
                            <div class="linea-principal"><strong>{{ obra.fecha_creacion_sistema|date:"d/m/Y H:i" }}</strong></div>
                        </div>
                    </div>
                    {% endif %}

                    {% if obra.fecha_modificacion_sistema %}
                    <div class="data-row">
                        <span class="campo-tag"><i class="bi bi-calendar-check"></i></span>
                        <div class="data-cell">
                            <span class="campo-label">√öltima modificaci√≥n</span>
                            <div class="linea-principal"><strong>{{ obra.fecha_modificacion_sistema|date:"d/m/Y H:i" }}</strong></div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </section>
            <!-- ================= NOMBRES Y T√çTULOS ================= -->
            <section id="nombres_titulos" class="detalle-section">
                <h3>Nombres y T√≠tulos</h3>

                <div class="data-grid-compact">
                    {% if obra.compositor %}
                    <div class="data-row">
                        <span class="campo-tag">100</span>
                        <div class="data-cell">
                            <span class="campo-label">Compositor</span>
                            <div class="linea-principal">
                                $a - Nombre: <strong>{{ obra.compositor }}</strong>
                            </div>
                            {% if obra.compositor.coordenadas_biograficas %}
                                <div class="linea-secundaria">
                                    $d - Coordenadas biogr√°ficas: <strong>{{ obra.compositor.coordenadas_biograficas }}</strong>
                                </div>
                            {% endif %}
                            {% if obra.termino_asociado %}
                                <div class="linea-secundaria">
                                    $c - T√©rmino asociado: <strong>{{ obra.termino_asociado }}</strong>
                                </div>
                            {% endif %}
                            {% if obra.funciones_compositor.exists %}
                                <div class="linea-secundaria">
                                    $e - Funci√≥n: <strong>{% for func in obra.funciones_compositor.all %}{{ func.get_funcion_display }}{% if not forloop.last %}, {% endif %}{% endfor %}</strong>
                                </div>
                            {% endif %}
                            {% if obra.autoria %}
                                <div class="linea-secundaria">
                                    $j - Autor√≠a: <strong>{{ obra.get_autoria_display }}</strong>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    {% if obra.titulo_uniforme %}
                    <div class="data-row">
                        <span class="campo-tag">130</span>
                        <div class="data-cell">
                            <span class="campo-label">T√≠tulo uniforme - Punto de acceso principal</span>
                            <div class="linea-principal">
                                $a <strong>{{ obra.titulo_uniforme }}</strong>
                            </div>
                            {% if obra.forma_130 %}
                                <div class="linea-secundaria">$k - Subencabezamiento de forma: <strong>{{ obra.forma_130 }}</strong></div>
                            {% endif %}
                            {% if obra.medio_interpretacion_130 %}
                                <div class="linea-secundaria">$m - Medio de interpretaci√≥n: <strong>{{ obra.medio_interpretacion_130 }}</strong></div>
                            {% endif %}
                            {% if obra.numero_parte_130 %}
                                <div class="linea-secundaria">$n - N√∫mero de parte: <strong>{{ obra.numero_parte_130 }}</strong></div>
                            {% endif %}
                            {% if obra.nombre_parte_130 %}
                                <div class="linea-secundaria">$p - Nombre de parte: <strong>{{ obra.nombre_parte_130 }}</strong></div>
                            {% endif %}
                            {% if obra.tonalidad_130 %}
                                <div class="linea-secundaria">$r - Tonalidad: <strong>{{ obra.tonalidad_130 }}</strong></div>
                            {% endif %}
                            {% if obra.arreglo_130 %}
                                <div class="linea-secundaria">$o - Arreglo: <strong>{{ obra.get_arreglo_130_display|default:obra.arreglo_130 }}</strong></div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    {% if obra.titulo_240 %}
                    <div class="data-row">
                        <span class="campo-tag">240</span>
                        <div class="data-cell">
                            <span class="campo-label">T√≠tulo uniforme</span>
                            <div class="linea-principal">
                                $a <strong>{{ obra.titulo_240 }}</strong>
                            </div>
                            {% if obra.forma_240 %}
                                <div class="linea-secundaria">$k - Subencabezamiento de forma: <strong>{{ obra.forma_240 }}</strong></div>
                            {% endif %}
                            {% if obra.medio_interpretacion_240 %}
                                <div class="linea-secundaria">$m - Medio de interpretaci√≥n: <strong>{{ obra.medio_interpretacion_240 }}</strong></div>
                            {% endif %}
                            {% if obra.numero_parte_240 %}
                                <div class="linea-secundaria">$n - N√∫mero de parte: <strong>{{ obra.numero_parte_240 }}</strong></div>
                            {% endif %}
                            {% if obra.nombre_parte_240 %}
                                <div class="linea-secundaria">$p - Nombre de parte: <strong>{{ obra.nombre_parte_240 }}</strong></div>
                            {% endif %}
                            {% if obra.tonalidad_240 %}
                                <div class="linea-secundaria">$r - Tonalidad: <strong>{{ obra.tonalidad_240 }}</strong></div>
                            {% endif %}
                            {% if obra.arreglo_240 %}
                                <div class="linea-secundaria">$o - Arreglo: <strong>{{ obra.get_arreglo_240_display|default:obra.arreglo_240 }}</strong></div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    {% if obra.titulo_principal %}
                    <div class="data-row">
                        <span class="campo-tag">245</span>
                        <div class="data-cell">
                            <span class="campo-label">T√≠tulo en fuente</span>
                            <div class="linea-principal">
                                $a - T√≠tulo: <strong>{{ obra.titulo_principal }}</strong>
                            </div>
                            {% if obra.subtitulo %}
                            <div class="linea-secundaria">
                                $b - Subt√≠tulo: <strong>{{ obra.subtitulo }}</strong>
                            </div>
                            {% endif %}
                            {% if obra.mencion_responsabilidad %}
                            <div class="linea-secundaria">
                                $c - Menci√≥n de responsabilidad: <strong>{{ obra.mencion_responsabilidad }}</strong>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    {% if obra.titulos_alternativos.all %}
                        {% for alt in obra.titulos_alternativos.all %}
                        <div class="data-row">
                            <span class="campo-tag">246</span>
                            <div class="data-cell">
                                <span class="campo-label">T√≠tulo alternativo</span>
                                <div class="linea-principal">
                                    $a - T√≠tulo: <strong>{{ alt.titulo }}</strong>
                                </div>
                                {% if alt.subtitulo %}
                                <div class="linea-secundaria">
                                    $b - Subt√≠tulo: <strong>{{ alt.subtitulo }}</strong>
                                </div>
                                {% endif %}
                                {% if alt.texto_visualizacion %}
                                <div class="linea-secundaria">
                                    $i - Texto de visualizaci√≥n: <strong>{{ alt.texto_visualizacion }}</strong>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}

                    {% if obra.nombres_relacionados_700.exists %}
                        {% for nombre in obra.nombres_relacionados_700.all %}
                        <div class="data-row">
                            <span class="campo-tag">700</span>
                            <div class="data-cell">
                                <span class="campo-label">Nombre relacionado</span>
                                <div class="linea-principal">
                                    $a - Nombre: <strong>{% if nombre.persona %}{{ nombre.persona.apellidos_nombres }}{% endif %}</strong>
                                </div>
                                {% if nombre.coordenadas_biograficas %}
                                <div class="linea-secundaria">$d - Coordenadas biogr√°ficas: <strong>{{ nombre.coordenadas_biograficas }}</strong></div>
                                {% endif %}
                                {% if nombre.funciones.exists %}
                                <div class="linea-secundaria">$e - Funci√≥n: <strong>{% for funcion in nombre.funciones.all %}{{ funcion.get_funcion_display }}{% if not forloop.last %}, {% endif %}{% endfor %}</strong></div>
                                {% endif %}
                                {% if nombre.terminos_asociados.exists %}
                                <div class="linea-secundaria">$c - T√©rmino asociado: <strong>{% for termino in nombre.terminos_asociados.all %}{{ termino.termino }}{% if not forloop.last %}, {% endif %}{% endfor %}</strong></div>
                                {% endif %}
                                {% if nombre.autoria %}
                                <div class="linea-secundaria">$j - Autor√≠a: <strong>{{ nombre.get_autoria_display }}</strong></div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}

                    {% if obra.entidades_relacionadas_710.exists %}
                        {% for entidad in obra.entidades_relacionadas_710.all %}
                        <div class="data-row">
                            <span class="campo-tag">710</span>
                            <div class="data-cell">
                                <span class="campo-label">Entidad relacionada</span>
                                <div class="linea-principal">
                                    $a <strong>{{ entidad.entidad }}</strong>
                                </div>
                                {% if entidad.funciones_institucionales.exists %}
                                <div class="linea-secundaria">
                                    $e <strong>{% for fi in entidad.funciones_institucionales.all %}{{ fi.get_funcion_display }}{% if not forloop.last %}, {% endif %}{% endfor %}</strong>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </section>

            <!-- ================= PRODUCCI√ìN / EDICI√ìN ================= -->
            <section id="edicion_produccion" class="detalle-section">
                <h3>Producci√≥n / Edici√≥n</h3>

                <div class="data-grid-compact">
                    {% if obra.ms_imp %}
                    <div class="data-row">
                        <span class="campo-tag">340</span>
                        <div class="data-cell">
                            <span class="campo-label">T√©cnica de producci√≥n</span>
                            <div class="linea-principal">$a <strong>{{ obra.get_ms_imp_display }}</strong></div>
                        </div>
                    </div>
                    {% endif %}

                    {% if obra.producciones_publicaciones.exists %}
                        {% for prod in obra.producciones_publicaciones.all %}
                        <div class="data-row">
                            <span class="campo-tag">264</span>
                            <div class="data-cell">
                                <span class="campo-label">Producci√≥n de la obra [{{ prod.get_funcion_display }}]</span>
                                <div class="linea-principal">
                                    {% for lugar in prod.lugares.all %}$a <strong>{{ lugar.lugar }}</strong>{% if not forloop.last %}, {% endif %}{% endfor %}
                                </div>
                                {% if prod.entidades.exists %}
                                <div class="linea-secundaria">
                                    {% for entidad in prod.entidades.all %}$b <strong>{{ entidad.nombre }}</strong>{% if not forloop.last %}, {% endif %}{% endfor %}
                                </div>
                                {% endif %}
                                {% if prod.fechas.exists %}
                                <div class="linea-secundaria">
                                    {% for fecha in prod.fechas.all %}$c <strong>{{ fecha.fecha }}</strong>{% if not forloop.last %}, {% endif %}{% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}

                    {% if obra.ediciones.exists %}
                        {% for ed in obra.ediciones.all %}
                        <div class="data-row">
                            <span class="campo-tag">250</span>
                            <div class="data-cell">
                                <span class="campo-label">Edici√≥n</span>
                                <div class="linea-principal">$a <strong>{{ ed.edicion }}</strong></div>
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}

                    {% if obra.extension or obra.otras_caracteristicas or obra.dimension or obra.material_acompanante %}
                    <div class="data-row">
                        <span class="campo-tag">300</span>
                        <div class="data-cell">
                            <span class="campo-label">Descripci√≥n f√≠sica</span>
                            <div class="linea-principal">
                                {% if obra.extension %}$a <strong>{{ obra.extension }}</strong>{% endif %}
                                {% if obra.otras_caracteristicas %}{% if obra.extension %} : {% endif %}$b <strong>{{ obra.otras_caracteristicas }}</strong>{% endif %}
                                {% if obra.dimension %} $c <strong>{{ obra.dimension }}</strong>{% endif %}
                                {% if obra.material_acompanante %} $+ <strong>{{ obra.material_acompanante }}</strong>{% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Identificadores (020, 024, 028) -->
                    {% if obra.isbn %}
                    <div class="data-row">
                        <span class="campo-tag">020</span>
                        <div class="data-cell">
                            <span class="campo-label">ISBN</span>
                            <div class="linea-principal">$a <strong>{{ obra.isbn }}</strong></div>
                        </div>
                    </div>
                    {% endif %}

                    {% if obra.ismn %}
                    <div class="data-row">
                        <span class="campo-tag">024</span>
                        <div class="data-cell">
                            <span class="campo-label">ISMN</span>
                            <div class="linea-principal">$a <strong>{{ obra.ismn }}</strong></div>
                        </div>
                    </div>
                    {% endif %}

                    {% if obra.numero_editor %}
                    <div class="data-row">
                        <span class="campo-tag">028</span>
                        <div class="data-cell">
                            <span class="campo-label">N√∫mero de editor</span>
                            <div class="linea-principal">$a <strong>{{ obra.numero_editor }}</strong></div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Disponible (856) -->
                    {% if obra.disponibles_856.exists %}
                    {% for disponible in obra.disponibles_856.all %}
                        {% for url in disponible.urls_856.all %}
                        <div class="data-row">
                            <span class="campo-tag">856</span>
                            <div class="data-cell">
                                <span class="campo-label">Recurso electr√≥nico</span>
                                <div class="linea-principal">
                                    $u <strong><a href="{{ url.url }}" class="acceso-link" target="_blank">
                                        {{ url.url }} <i class="bi bi-box-arrow-up-right"></i>
                                    </a></strong>
                                </div>
                                {% if disponible.textos_enlace_856.first %}
                                <div class="linea-secundaria">
                                    $y <strong>{{ disponible.textos_enlace_856.first.texto_enlace }}</strong>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% endfor %}
                    {% endif %}
                </div>
            </section>

            <!-- ================= DATOS MUSICALES ================= -->
            <section id="datomusical" class="detalle-section">
                <h3>Datos Musicales</h3>
                <div class="data-grid-compact">
                    {% if obra.formato %}
                    <div class="data-row">
                        <span class="campo-tag">348</span>
                        <div class="data-cell">
                            <span class="campo-label">Formato</span>
                            <div class="linea-principal">$a <strong>{{ obra.get_formato_display }}</strong></div>
                        </div>
                    </div>
                    {% endif %}

                    {% if obra.medios_interpretacion_382.all %}
                    <div class="data-row">
                        <span class="campo-tag">382</span>
                        <div class="data-cell">
                            <span class="campo-label">Medio de interpretaci√≥n</span>
                            {% for medio in obra.medios_interpretacion_382.all %}
                                <div class="linea-{% if forloop.first %}principal{% else %}secundaria{% endif %}">
                                    {% if medio.medios.all %}
                                        {% for m in medio.medios.all %}$a <strong>{{ m.get_medio_display }}</strong>{% if not forloop.last %}, {% endif %}{% endfor %}
                                    {% endif %}
                                    {% if medio.solista %} $n Solista: <strong>{{ medio.solista }}</strong>{% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    {% if obra.numero_obra or obra.opus %}
                    <div class="data-row">
                        <span class="campo-tag">383</span>
                        <div class="data-cell">
                            <span class="campo-label">Designaci√≥n num√©rica de obra musical</span>
                            <div class="linea-principal">
                                {% if obra.numero_obra %}$a <strong>{{ obra.numero_obra }}</strong>{% endif %}
                                {% if obra.opus %}{% if obra.numero_obra %} {% endif %}$b <strong>Op. {{ obra.opus }}</strong>{% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {% if obra.tonalidad_384 %}
                    <div class="data-row">
                        <span class="campo-tag">384</span>
                        <div class="data-cell">
                            <span class="campo-label">Tonalidad</span>
                            <div class="linea-principal">$a <strong>{{ obra.tonalidad_384 }}</strong></div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                {% if obra.incipits_musicales.all %}
                <div class="incipit-section">
                    <h4 class="subsection-title">√çncipit Musical (031)</h4>

                    {% for incipit in obra.incipits_musicales.all %}
                    <div class="incipit-card">
                        <div class="incipit-header">
                            <strong>Obra {{ incipit.numero_obra }}, mov. {{ incipit.numero_movimiento }}, pas. {{ incipit.numero_pasaje }}</strong>
                        </div>

                        {% if incipit.titulo_encabezamiento %}
                        <div class="incipit-subtitle">
                            {{ incipit.titulo_encabezamiento }}
                        </div>
                        {% endif %}

                        <div class="incipit-meta">
                            {% if incipit.voz_instrumento %}{{ incipit.voz_instrumento }}{% endif %}
                            {% if incipit.clave %} ¬∑ Clave: {{ incipit.clave }}{% endif %}
                            {% if incipit.armadura %} ¬∑ Armadura: {{ incipit.armadura }}{% endif %}
                            {% if incipit.tiempo %} ¬∑ Comp√°s: {{ incipit.tiempo }}{% endif %}
                        </div>


                        {% if incipit.paec_full %}
                            {# ========== M√âTODO CORRECTO: json_script con ID fijo ========== #}
                            <script id="paec_json_{{ incipit.pk }}" type="application/json">{{ incipit.paec_full|safe }}</script>

                            <div class="obra-card-body">
                            {% with primer_incipit=obra.incipits_musicales.first %}
                                {% if primer_incipit and primer_incipit.paec_full %}
                                    {# Mostrar canvas del primer √≠ncipit #}
                                    <script id="paec_json_{{ primer_incipit.pk }}" type="application/json">{{ primer_incipit.paec_full|safe }}</script>
                                        <canvas
                                            id="incipit_view_canvas_{{ primer_incipit.pk }}"
                                            class="incipit-view-canvas"
                                            width="700"
                                            height="205"
                                            data-paec-json-id="paec_json_{{ primer_incipit.pk }}">
                                        </canvas>


                                    {# Informaci√≥n textual del √≠ncipit #}
                                    {% if primer_incipit.titulo_encabezamiento %}
                                        <p class="obra-inline-line" style="margin-top: 0.125rem; font-size: 0.9em; color: #666;">
                                            {{ primer_incipit.titulo_encabezamiento }}
                                        </p>
                                    {% endif %}
                                {% else %}
                                    <p class="meta-empty">Sin √≠ncipit registrado</p>
                                {% endif %}
                            {% endwith %}
                        </div>

                            {# ========== PANEL DE DEBUG (quitar en producci√≥n) ========== #}
                            <!-- <div class="debug-panel" style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 6px; border: 1px solid #dee2e6;">
                                <div style="font-size: 12px; font-family: monospace;">
                                    <div style="margin-bottom: 0.5rem;">
                                        <strong style="color: #0066cc;">üîç DEBUG INCIPIT {{ incipit.pk }}</strong>
                                    </div>
                                    <table style="width: 100%; font-size: 11px;">
                                        <tr style="background: #fff;">
                                            <td style="padding: 4px; width: 120px;"><strong>Clave (DB):</strong></td>
                                            <td style="padding: 4px; color: #666;">"{{ incipit.clave|default:"vac√≠o" }}"</td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 4px;"><strong>Armadura (DB):</strong></td>
                                            <td style="padding: 4px; color: #666;">"{{ incipit.armadura|default:"vac√≠o" }}"</td>
                                        </tr>
                                        <tr style="background: #fff;">
                                            <td style="padding: 4px;"><strong>Comp√°s (DB):</strong></td>
                                            <td style="padding: 4px; color: #666;">"{{ incipit.tiempo|default:"vac√≠o" }}"</td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 4px;"><strong>Body (DB):</strong></td>
                                            <td style="padding: 4px; color: #666;">"{{ incipit.notacion_musical|truncatechars:60 }}"</td>
                                        </tr>
                                        <tr style="background: #e7f3ff;">
                                            <td style="padding: 4px; vertical-align: top;"><strong>PAEC FULL:</strong></td>
                                            <td style="padding: 4px;">
                                                <code style="color: #d63384; word-break: break-all;">{{ incipit.paec_full }}</code>
                                            </td>
                                        </tr>
                                        <tr style="background: #fff;">
                                            <td style="padding: 4px;"><strong>JSON ID:</strong></td>
                                            <td style="padding: 4px; color: #28a745;">paec_json_{{ incipit.pk }}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div> -->

                            {% elif incipit.notacion_musical %}
                            {# ========== FALLBACK: si paec_full est√° vac√≠o pero hay body ========== #}
                            <div class="alert alert-warning" style="padding: 1rem; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px;">
                                <strong>‚ö†Ô∏è Advertencia:</strong> Este √≠ncipit tiene <code>notacion_musical</code> pero no <code>paec_full</code>.
                                <br>Ejecuta la migraci√≥n o actualiza el registro para regenerar el PAEC completo.
                                <br><small>Body: <code>{{ incipit.notacion_musical|truncatechars:80 }}</code></small>
                            </div>

                            {% else %}
                            {# ========== Sin notaci√≥n musical ========== #}
                            <div class="text-muted" style="font-style: italic; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
                                No hay notaci√≥n musical disponible para este √≠ncipit.
                            </div>
                            {% endif %}

                            {% if incipit.urls.all %}
                            <div class="incipit-urls" style="margin-top: 1rem;">
                                {% for u in incipit.urls.all %}
                                <a href="{{ u.url }}" target="_blank" class="acceso-link">
                                    Ver √≠ncipit en l√≠nea <i class="bi bi-box-arrow-up-right"></i>
                                </a>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

            </section>

            <!-- ================= MATERIAS Y SERIE ================= -->
            <section id="materias_serie" class="detalle-section">
                <h3>Materias y Serie</h3>

                {% if obra.materias_650.exists or obra.materias_655.exists %}
                <div class="data-grid-compact">
                    {% for mat in obra.materias_650.all %}
                    <div class="data-row">
                        <span class="campo-tag">650</span>
                        <div class="data-cell">
                            <span class="campo-label">Materia - Temas</span>
                            <div class="linea-principal">
                                {% if mat.materia %}$a <strong>{{ mat.materia }}</strong>{% else %}‚Äî{% endif %}
                                {% if mat.subdivisiones.all %}
                                    {% for sub in mat.subdivisiones.all %} $y <strong>{{ sub.subdivision }}</strong>{% endfor %}
                                {% endif %}
                                {% if mat.subdivisiones_geograficas.all %}
                                    $z {% for sub_geo in mat.subdivisiones_geograficas.all %}<strong>{{ sub_geo.subdivision }}</strong>{% if not forloop.last %} - {% endif %}{% endfor %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}

                    <!-- {% for mat in obra.materias_655.all %}
                    <div class="data-row">
                        <span class="campo-tag">655</span>
                        <div class="data-cell">
                            <span class="campo-label">G√©nero - Forma</span>
                            <div class="linea-principal">
                                {% if mat.materia %}$a <strong>{{ mat.materia }}</strong>{% else %}‚Äî{% endif %}
                                {% if mat.subdivisiones.all %}
                                    {% for sub in mat.subdivisiones.all %} $x <strong>{{ sub.subdivision }}</strong>{% endfor %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted">No hay materias registradas.</p>
                {% endif %} -->

                <!-- Serie (490) -->
                {% if obra.menciones_serie.exists %}
                <div class="data-grid-compact mt-3">
                    {% for mencion in obra.menciones_serie.all %}
                    <div class="data-row">
                        <span class="campo-tag">490</span>
                        <div class="data-cell">
                            <span class="campo-label">Serie</span>
                            <div class="linea-principal">
                                {% for titulo in mencion.titulos.all %}$a <strong>{{ titulo.titulo_serie }}</strong>{% if not forloop.last %}, {% endif %}{% endfor %}
                                {% if mencion.volumenes.exists %} ; {% for vol in mencion.volumenes.all %}$v <strong>{{ vol.volumen }}</strong>{% if not forloop.last %}, {% endif %}{% endfor %}{% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

            </section>
            <!-- ================= NOTAS ================= -->
            <section id="nuevas_notas" class="detalle-section">
                <h3>Notas</h3>

                <!-- ===== 500 ‚Äì Nota general (R) ===== -->
                {% if obra.notas_generales_500.all %}
                    {% for nota in obra.notas_generales_500.all %}
                    <div class="data-row">
                        <span class="campo-tag">500</span>
                        <div class="data-cell">
                            <span class="campo-label">Nota general</span>
                            <div class="linea-principal">$a {{ nota.nota_general }}</div>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted">No hay notas generales registradas.</p>
                    {% endfor %}
                {% endif %}

                <!-- ===== 505 ‚Äì Contenido (R) ===== -->
                {% if obra.contenidos_505.all %}
                    {% for contenido in obra.contenidos_505.all %}
                    <div class="data-row">
                        <span class="campo-tag">505</span>
                        <div class="data-cell">
                            <span class="campo-label">Nota de contenido</span>
                            <div class="linea-principal">$a {{ contenido.contenido }}</div>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted">No hay contenidos registrados.</p>
                    {% endfor %}
                {% endif %}

                <!-- ===== 520 ‚Äì Sumario (R) ===== -->
                {% if obra.sumarios_520.all %}
                    {% for sumario in obra.sumarios_520.all %}
                    <div class="data-row">
                        <span class="campo-tag">520</span>
                        <div class="data-cell">
                            <span class="campo-label">Sumario</span>
                            <div class="linea-principal">$a {{ sumario.sumario }}</div>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted">No hay sumarios registrados.</p>
                    {% endfor %}
                {% endif %}

                <!-- ===== 545 ‚Äì Datos biogr√°ficos del compositor (NR) ===== -->
                {% if obra.datos_biograficos_545 %}
                    <div class="data-row">
                        <span class="campo-tag">545</span>
                        <div class="data-cell">
                            <span class="campo-label">Datos biogr√°ficos del compositor</span>
                            {% if obra.datos_biograficos_545.texto_biografico %}
                            <div class="linea-principal">$a {{ obra.datos_biograficos_545.texto_biografico }}</div>
                            {% endif %}
                            {% if obra.datos_biograficos_545.uri %}
                            <div class="linea-secundaria">
                                $u <a href="{{ obra.datos_biograficos_545.uri }}" target="_blank">
                                    {{ obra.datos_biograficos_545.uri }}
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            </section>

            <!-- ================= RELACIONES ================= -->
            <section id="relaciones" class="detalle-section">
                <h3>Relaciones</h3>

                <!-- ===== 773 ‚Äì Enlace a documento fuente (R) ===== -->
                {% if obra.enlaces_documento_fuente_773.all %}
                    <h4 class="subsection-title mt-3">Colecci√≥n (773)</h4>
                    {% for enlace in obra.enlaces_documento_fuente_773.all %}
                    <div class="data-row">
                        <span class="campo-tag">773</span>
                        <div class="data-cell">
                            <span class="campo-label">Colecci√≥n</span>
                            <div class="linea-principal">
                                {% if enlace.encabezamiento_principal %}$a <strong>{{ enlace.encabezamiento_principal }}</strong>.{% endif %}
                                {% if enlace.titulo %} $t <strong><em>{{ enlace.titulo }}</em></strong>.{% endif %}
                            </div>
                            {% if enlace.numeros_control.all %}
                            <div class="linea-secundaria">
                                {% for w in enlace.numeros_control.all %}$w (<strong>{{ w.obra_relacionada.num_control }}</strong>){% if not forloop.last %} {% endif %}{% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted">No hay enlaces 773 registrados.</p>
                    {% endfor %}
                {% endif %}

                <!-- ===== 774 ‚Äì Unidad constituyente (R) ===== -->
                {% if obra.enlaces_unidades_774.all %}
                    <h4 class="subsection-title mt-3">Obras en esta colecci√≥n (774)</h4>
                    {% for enlace in obra.enlaces_unidades_774.all %}
                    <div class="data-row">
                        <span class="campo-tag">774</span>
                        <div class="data-cell">
                            <span class="campo-label">Obras en esta colecci√≥n</span>
                            <div class="linea-principal">
                                {% if enlace.encabezamiento_principal %}$a <strong>{{ enlace.encabezamiento_principal }}</strong>.{% endif %}
                                {% if enlace.titulo %} $t <strong><em>{{ enlace.titulo }}</em></strong>.{% endif %}
                            </div>
                            {% if enlace.numeros_control.all %}
                            <div class="linea-secundaria">
                                {% for w in enlace.numeros_control.all %}$w (<strong>{{ w.obra_relacionada.num_control }}</strong>){% if not forloop.last %} {% endif %}{% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted">No hay unidades constituyentes 774 registradas.</p>
                    {% endfor %}
                {% endif %}

                <!-- ===== 787 ‚Äì Otras relaciones (R) ===== -->
                {% if obra.otras_relaciones_787.all %}
                    <h4 class="subsection-title mt-3">Otras relaciones (787)</h4>
                    {% for enlace in obra.otras_relaciones_787.all %}
                    <div class="data-row">
                        <span class="campo-tag">787</span>
                        <div class="data-cell">
                            <span class="campo-label">Otras relaciones</span>
                            <div class="linea-principal">
                                {% if enlace.encabezamiento_principal %}$a <strong>{{ enlace.encabezamiento_principal }}</strong>.{% endif %}
                                {% if enlace.titulo %} $t <strong><em>{{ enlace.titulo }}</em></strong>.{% endif %}
                            </div>
                            {% if enlace.numeros_control.all %}
                            <div class="linea-secundaria">
                                {% for w in enlace.numeros_control.all %}$w (<strong>{{ w.obra_relacionada.num_control }}</strong>){% if not forloop.last %} {% endif %}{% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted">No hay relaciones 787 registradas.</p>
                    {% endfor %}
                {% endif %}
            </section>
            <!-- ================= EXISTENCIAS ================= -->
            <section id="existencias" class="detalle-section">
                <h3>Existencias</h3>
                {% if obra.ubicaciones_852.all %}
                <div class="data-grid-compact">
                    {% for ubicacion in obra.ubicaciones_852.all %}
                    <div class="data-row">
                        <span class="campo-tag">852</span>
                        <div class="data-cell">
                            <span class="campo-label">Ubicaci√≥n</span>
                            <div class="linea-principal">
                                {% if ubicacion.autoridad %}$a <strong>{{ ubicacion.autoridad }}</strong>{% elif ubicacion.codigo_o_nombre %}$a <strong>{{ ubicacion.codigo_o_nombre }}</strong>{% endif %}
                                {% if ubicacion.signatura_original %} $h <strong>{{ ubicacion.signatura_original }}</strong>{% endif %}
                            </div>
                            {% if ubicacion.estanterias.all %}
                            <div class="linea-secundaria">
                                {% for estanteria in ubicacion.estanterias.all %}$c <strong>{{ estanteria.estanteria }}</strong>{% if not forloop.last %} {% endif %}{% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                {% if obra.disponibles_856.exists %}
                <div class="data-grid-compact{% if obra.ubicaciones_852.all %} mt-3{% endif %}">
                {% for disponible in obra.disponibles_856.all %}
                    {% for url in disponible.urls_856.all %}
                    <div class="data-row">
                        <span class="campo-tag">856</span>
                        <div class="data-cell">
                            <span class="campo-label">Recurso electr√≥nico</span>
                            <div class="linea-principal">
                                $u <strong><a href="{{ url.url }}" class="acceso-link" target="_blank">
                                    {{ url.url }} <i class="bi bi-box-arrow-up-right"></i>
                                </a></strong>
                            </div>
                            {% if disponible.textos_enlace_856.first %}
                            <div class="linea-secundaria">$y <strong>{{ disponible.textos_enlace_856.first.texto_enlace }}</strong></div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% endfor %}
                </div>
                {% endif %}
            </section>

        </main>
    </div>
</div>

<!-- ================= JS ================= -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    console.log('üîç Inicializando navegaci√≥n del sidebar de detalle...');

    const links = document.querySelectorAll('.detalle-sidebar .nav-link');
    const sections = document.querySelectorAll('.detalle-section');

    console.log('üìä Links encontrados:', links.length);
    console.log('üìä Secciones encontradas:', sections.length);

    if (!links.length || !sections.length) {
        console.warn('‚ö†Ô∏è No se encontraron links o secciones para la navegaci√≥n');
        return;
    }

    // Funci√≥n para actualizar link activo
    function updateActiveLink(targetId) {
        links.forEach(link => {
            const isActive = link.getAttribute('href') === `#${targetId}`;
            link.classList.toggle('active', isActive);
            console.log(`üîÑ Link ${link.getAttribute('href')} -> ${isActive ? 'activo' : 'inactivo'}`);
        });
    }

    links.forEach(link => {
        link.addEventListener('click', e => {
            e.preventDefault();
            const targetId = link.getAttribute('href').substring(1); // quitar el #
            const target = document.getElementById(targetId);

            console.log(`üéØ Click en link: ${targetId}`);

            if (!target) {
                console.error(`‚ùå No se encontr√≥ la secci√≥n con ID: ${targetId}`);
                return;
            }

            // Actualizar link activo inmediatamente
            updateActiveLink(targetId);

            // Hacer scroll suave
            const offsetTop = target.offsetTop - 90;
            console.log(`üìç Haciendo scroll a: ${offsetTop}px`);

            window.scrollTo({
                top: offsetTop,
                behavior: 'smooth'
            });
        });
    });

    // Observer para detectar secci√≥n visible al hacer scroll
    const observer = new IntersectionObserver(entries => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                console.log(`üëÅÔ∏è Secci√≥n visible: ${entry.target.id}`);
                updateActiveLink(entry.target.id);
            }
        });
    }, {
        rootMargin: '-40% 0px -40% 0px',
        threshold: 0.1
    });

    sections.forEach(section => {
        console.log(`üîç Observando secci√≥n: ${section.id}`);
        observer.observe(section);
    });

    // Activar primer link por defecto
    const firstLink = links[0];
    if (firstLink) {
        const firstId = firstLink.getAttribute('href').substring(1);
        console.log(`üöÄ Activando primer link: ${firstId}`);
        updateActiveLink(firstId);
    }
});
</script>

<!-- Motor del canvas -->
<script src="{% static 'catalogacion/js/incipitManager.js' %}"></script>
<script src="{% static 'catalogacion/js/incipitInit.js' %}"></script>


<style>
  .incipit-view-canvas { pointer-events: none; }
</style>


{% endblock catalogacion_content %}
