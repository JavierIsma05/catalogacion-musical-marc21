{% extends 'catalogacion/base_catalogacion.html' %}
{% load static %}

{% block title %}{{ obra.titulo_principal }} - Detalle de Obra{% endblock %}
{% block page_title %}Detalle de Obra{% endblock %}

{% block catalogacion_css %}
<link rel="stylesheet" href="{% static 'catalogacion/css/detalle-obra.css' %}">

<style>
@font-face {
  font-family: 'Maestro';
  src: url("{% static 'catalogacion/fonts/Maestro.ttf' %}") format('truetype');
  font-weight: normal;
  font-style: normal;
}

.incipit-canvas-wrap{
  width: 100%;
  display: flex;
  justify-content: center;
  margin-top: .5rem;
}

.incipit-view-canvas{
  width: 100%;
  max-width: 700px;
  height: 250px;      /* tama√±o visual */
  display: block;
  background: #ffffffdc;
}


</style>
{% endblock %}

{% block catalogacion_content %}
<div class="detalle-container">

    <!-- ============= ENCABEZADO ============= -->
    <div class="detalle-header">
        <div class="header-content">

            <div class="header-breadcrumb">
                <a href="{% url 'usuarios:catalogador_dashboard' %}">Inicio</a>
                <span class="separator">‚Ä∫</span>
                <a href="{% url 'catalogacion:lista_obras' %}">Cat√°logo</a>
                <span class="separator">‚Ä∫</span>
                <span class="current">{{ obra.titulo_principal|truncatewords:5 }}</span>
            </div>

            <div class="header-main">
                <div class="header-info">

                    {% if obra.signatura_completa %}
                    <div class="signatura-badge">
                        <i class="bi bi-bookmark-fill"></i>
                        <span>{{ obra.signatura_completa }}</span>
                    </div>
                    {% endif %}

                </div>

                <a href="{% url 'catalogacion:editar_obra' pk=obra.pk %}" class="btn-action">
                    <i class="bi bi-pencil"></i> Editar
                </a>
            </div>

        </div>
    </div>

    <!-- ================= BODY ================= -->
    <div class="detalle-body">

        <!-- ========== SIDEBAR ========== -->
        <aside class="detalle-sidebar">
            <nav class="sidebar-nav">
                <div class="nav-header"><h6>Contenido</h6></div>
                <ul class="nav-list">
                    <li><a href="#nombres" class="nav-link">Nombres y T√≠tulos</a></li>
                    <li><a href="#produccion" class="nav-link">Producci√≥n / Edici√≥n</a></li>
                    <li><a href="#musical" class="nav-link">Datos Musicales</a></li>
                    <li><a href="#materias" class="nav-link">Materias y Serie</a></li>
                    <li><a href="#notas" class="nav-link">Notas</a></li>
                    <li><a href="#relaciones" class="nav-link">Relaciones</a></li>
                    <li><a href="#existencias" class="nav-link">Existencias</a></li>
                    <li><a href="#admin" class="nav-link">Administraci√≥n</a></li>
                </ul>
            </nav>
        </aside>

        <!-- ========== CONTENIDO ========== -->
        <main class="detalle-main">

            <!-- ================= NOMBRES Y T√çTULOS ================= -->
            <section id="nombres" class="detalle-section">
                <h3>Nombres y T√≠tulos</h3>

                <div class="data-grid-compact">
                    {% if obra.centro_catalogador %}
                    <div class="data-row">
                        <span class="campo-tag">040</span>
                        <span>Centro catalogador:</span>
                        <strong>{{ obra.centro_catalogador }}</strong>
                    </div>
                    {% endif %}

                    {% if obra.ms_imp %}
                    <div class="data-row">
                        <span class="campo-tag">340</span>
                        <span>Tipo de material:</span>
                        <span>{{ obra.get_ms_imp_display }}</span>
                    </div>
                    {% endif %}

                {% if obra.titulo_uniforme %}
                <div class="data-row"><span class="campo-tag">130</span>{{ obra.titulo_uniforme }}</div>
                {% endif %}

                {% if obra.titulo_240 %}
                <div class="data-row"><span class="campo-tag">240</span>{{ obra.titulo_240 }}</div>
                {% endif %}

                {% if obra.titulo_principal %}
                <div class="data-row">
                    <span class="campo-tag">245</span>
                    {{ obra.titulo_principal }}{% if obra.subtitulo %} : {{ obra.subtitulo }}{% endif %}
                </div>
                {% endif %}

                {% if obra.titulos_alternativos.exists %}
                    {% for alt in obra.titulos_alternativos.all %}
                        {% if alt.titulo %}
                        <div class="data-row"><span class="campo-tag">246</span>{{ alt.titulo }}</div>
                        {% endif %}
                    {% endfor %}
                {% endif %}

                {% if obra.compositor %}
                <div class="data-row-alt">
                    <span class="campo-tag">100</span>
                    <div class="data-cell">
                        <div class="linea-principal">
                            <strong>{{ obra.compositor }}</strong>
                            {% if obra.compositor.coordenadas_biograficas %}
                                ({{ obra.compositor.coordenadas_biograficas }})
                            {% endif %}
                        </div>
                        {% if obra.termino_asociado %}
                            <div class="linea-secundaria">
                                <em>{{ obra.termino_asociado }}</em>
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                    {% if obra.titulo_uniforme %}
                    <div class="data-row-alt">
                        <span class="campo-tag">130</span>
                        <div class="data-cell">
                            <div class="linea-principal">
                                <strong>{{ obra.titulo_uniforme }}</strong>
                            </div>
                            <div class="linea-secundaria">
                                {% if obra.forma_130 %}{{ obra.forma_130 }}{% endif %}
                                {% if obra.medio_interpretacion_130 %}{% if obra.forma_130 %} , {% endif %}{{ obra.medio_interpretacion_130 }}{% endif %}
                                {% if obra.numero_parte_130 %} ; {{ obra.numero_parte_130 }}{% endif %}
                                {% if obra.nombre_parte_130 %} ; {{ obra.nombre_parte_130 }}{% endif %}
                                {% if obra.tonalidad_130 %} ; {{ obra.tonalidad_130 }}{% endif %}
                                {% if obra.arreglo_130 %} ; {{ obra.get_arreglo_130_display|default:obra.arreglo_130 }}{% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {% if obra.titulo_240 %}
                    <div class="data-row-alt">
                        <span class="campo-tag">240</span>
                        <div class="data-cell">
                            <div class="linea-principal">
                                <strong>{{ obra.titulo_240 }}</strong>
                            </div>
                            <div class="linea-secundaria">
                                {% if obra.forma_240 %}{{ obra.forma_240 }}{% endif %}
                                {% if obra.medio_interpretacion_240 %}{% if obra.forma_240 %} , {% endif %}{{ obra.medio_interpretacion_240 }}{% endif %}
                                {% if obra.numero_parte_240 %} ; {{ obra.numero_parte_240 }}{% endif %}
                                {% if obra.nombre_parte_240 %} ; {{ obra.nombre_parte_240 }}{% endif %}
                                {% if obra.tonalidad_240 %} ; {{ obra.tonalidad_240 }}{% endif %}
                                {% if obra.arreglo_240 %} ; {{ obra.get_arreglo_240_display|default:obra.arreglo_240 }}{% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {% if obra.titulo_principal %}
                    <div class="data-row-alt">
                        <span class="campo-tag">245</span>
                        <div class="data-cell">
                            <div class="linea-principal">
                                <strong>{{ obra.titulo_principal }}</strong>{% if obra.subtitulo %} : {{ obra.subtitulo }}{% endif %}
                            </div>
                            {% if obra.mencion_responsabilidad %}
                            <div class="linea-secundaria">
                                / {{ obra.mencion_responsabilidad }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    {% if obra.titulos_alternativos.all %}
                        {% for alt in obra.titulos_alternativos.all %}
                        <div class="data-row-alt">
                            <span class="campo-tag">246</span>
                            <div class="data-cell">
                                <div class="linea-principal">
                                    {{ alt.titulo }}
                                    {% if alt.resto_titulo %}: {{ alt.resto_titulo }}{% endif %}
                                </div>
                                {% if alt.texto_visualizacion %}
                                <div class="linea-secundaria">
                                    [{{ alt.texto_visualizacion }}]
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </section>

            <!-- ================= PRODUCCI√ìN / EDICI√ìN ================= -->
            <section id="produccion" class="detalle-section">
                <h3>Producci√≥n / Edici√≥n</h3>

                {% if obra.ms_imp %}
                <div class="data-row"><span class="campo-tag">340</span>{{ obra.get_ms_imp_display }}</div>
                {% endif %}

                {% if obra.producciones_publicaciones.exists %}
                    {% for prod in obra.producciones_publicaciones.all %}
                    <div class="data-row"><span class="campo-tag">264</span>{{ prod.get_funcion_display }}</div>
                    {% endfor %}
                {% endif %}

                {% if obra.ediciones.exists %}
                    {% for ed in obra.ediciones.all %}
                    <div class="data-row"><span class="campo-tag">250</span>{{ ed.edicion }}</div>
                    {% endfor %}
                {% endif %}

                {% if obra.extension or obra.dimension %}
                <div class="data-row">
                    <span class="campo-tag">300</span>
                    {{ obra.extension }}{% if obra.dimension %} ; {{ obra.dimension }}{% endif %}
                </div>
                {% endif %}
            </section>

            <!-- ================= DATOS MUSICALES ================= -->
            <section id="musical" class="detalle-section">
                <h3>Datos Musicales</h3>

                {% if obra.formato %}
                <div class="data-row"><span class="campo-tag">348</span>{{ obra.get_formato_display }}</div>
                {% endif %}

                    {% if obra.producciones_publicaciones.all %}
                        {% for prod in obra.producciones_publicaciones.all %}
                        <div class="data-row">
                            <span class="campo-tag">264</span>
                            <span>
                                [{{ prod.get_funcion_display }}]
                                {% if prod.lugares.all %}
                                    {% for lugar in prod.lugares.all %}
                                        {{ lugar.lugar }}{% if not forloop.last %} ; {% endif %}
                                    {% endfor %}
                                {% endif %}
                                {% if prod.entidades.all %}
                                    ‚Äî
                                    {% for ent in prod.entidades.all %}
                                        {{ ent.nombre }}{% if not forloop.last %} ; {% endif %}
                                    {% endfor %}
                                {% endif %}
                                {% if prod.fechas.all %}
                                    ‚Äî
                                    {% for f in prod.fechas.all %}
                                        {{ f.fecha }}{% if not forloop.last %} ; {% endif %}
                                    {% endfor %}
                                {% endif %}
                            </span>
                        </div>
                        {% endfor %}
                    {% endif %}

                    {% if obra.ediciones.all %}
                        {% for edicion in obra.ediciones.all %}
                        <div class="data-row">
                            <span class="campo-tag">250</span>
                            <span>{{ edicion.edicion }}</span>
                        </div>
                        {% endfor %}
                    {% endif %}

                {% if obra.tonalidad_384 %}
                <div class="data-row"><span class="campo-tag">384</span>{{ obra.tonalidad_384 }}</div>
                {% endif %}
            </section>

            <!-- ================= MATERIAS Y SERIE ================= -->
            <section id="materias" class="detalle-section">
                <h3>Materias y Serie</h3>

                {% if obra.materias_650.exists %}
                    {% for m in obra.materias_650.all %}
                    <div class="data-row"><span class="campo-tag">650</span>{{ m.materia }}</div>
                    {% endfor %}
                {% endif %}

                    {% if obra.formato %}
                    <div class="data-row">
                        <span class="campo-tag">348</span>
                        <span>Formato: {{ obra.get_formato_display }}</span>
                    </div>
                    {% endif %}

                    {% if obra.medios_interpretacion_382.all %}
                    <div class="data-row full">
                        <span class="campo-tag">382</span>
                        <div class="data-cell">
                            {% for medio in obra.medios_interpretacion_382.all %}
                                <div class="medio-item">
                                    {% if medio.medios.all %}
                                        {% for m in medio.medios.all %}
                                            {{ m.get_medio_display }}{% if not forloop.last %}, {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                    {% if medio.solista %}
                                        ‚Äî Solista: {{ medio.solista }}
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    {% if obra.numero_obra or obra.opus %}
                    <div class="data-row">
                        <span class="campo-tag">383</span>
                        <span>
                            {% if obra.numero_obra %}{{ obra.numero_obra }}{% endif %}
                            {% if obra.opus %}{% if obra.numero_obra %} / {% endif %}Op. {{ obra.opus }}{% endif %}
                        </span>
                    </div>
                    {% endif %}

                    {% if obra.tonalidad_384 %}
                    <div class="data-row">
                        <span class="campo-tag">384</span>
                        <span>{{ obra.tonalidad_384 }}</span>
                    </div>
                    {% endif %}

                {% if obra.incipits_musicales.all %}
                <div class="incipit-section">
                    <h4 class="subsection-title">√çncipit Musical (031)</h4>

                    {% for incipit in obra.incipits_musicales.all %}
                    <div class="incipit-card">
                        <div class="incipit-header">
                            <strong>Obra {{ incipit.numero_obra }}, mov. {{ incipit.numero_movimiento }}, pas. {{ incipit.numero_pasaje }}</strong>
                        </div>

                        {% if incipit.titulo_encabezamiento %}
                        <div class="incipit-subtitle">
                            {{ incipit.titulo_encabezamiento }}
                        </div>
                        {% endif %}

                        <div class="incipit-meta">
                            {% if incipit.voz_instrumento %}{{ incipit.voz_instrumento }}{% endif %}
                            {% if incipit.clave %} ¬∑ Clave: {{ incipit.clave }}{% endif %}
                            {% if incipit.armadura %} ¬∑ Armadura: {{ incipit.armadura }}{% endif %}
                            {% if incipit.tiempo %} ¬∑ Tiempo: {{ incipit.tiempo }}{% endif %}
                        </div>


                        {% if incipit.paec_full %}
                            {# ========== M√âTODO CORRECTO: json_script con ID fijo ========== #}
                            <script id="paec_json_{{ incipit.pk }}" type="application/json">{{ incipit.paec_full|safe }}</script>

                            <div class="incipit-canvas-wrap">
                                <canvas
                                    id="incipit_view_canvas_{{ incipit.pk }}"
                                    class="incipit-view-canvas"
                                    width="800"
                                    height="320"
                                    data-paec-json-id="paec_json_{{ incipit.pk }}">
                                </canvas>
                            </div>

                            {# ========== PANEL DE DEBUG (quitar en producci√≥n) ========== #}
                            <div class="debug-panel" style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 6px; border: 1px solid #dee2e6;">
                                <div style="font-size: 12px; font-family: monospace;">
                                    <div style="margin-bottom: 0.5rem;">
                                        <strong style="color: #0066cc;">üîç DEBUG INCIPIT {{ incipit.pk }}</strong>
                                    </div>
                                    <table style="width: 100%; font-size: 11px;">
                                        <tr style="background: #fff;">
                                            <td style="padding: 4px; width: 120px;"><strong>Clave (DB):</strong></td>
                                            <td style="padding: 4px; color: #666;">"{{ incipit.clave|default:"vac√≠o" }}"</td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 4px;"><strong>Armadura (DB):</strong></td>
                                            <td style="padding: 4px; color: #666;">"{{ incipit.armadura|default:"vac√≠o" }}"</td>
                                        </tr>
                                        <tr style="background: #fff;">
                                            <td style="padding: 4px;"><strong>Tiempo (DB):</strong></td>
                                            <td style="padding: 4px; color: #666;">"{{ incipit.tiempo|default:"vac√≠o" }}"</td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 4px;"><strong>Body (DB):</strong></td>
                                            <td style="padding: 4px; color: #666;">"{{ incipit.notacion_musical|truncatechars:60 }}"</td>
                                        </tr>
                                        <tr style="background: #e7f3ff;">
                                            <td style="padding: 4px; vertical-align: top;"><strong>PAEC FULL:</strong></td>
                                            <td style="padding: 4px;">
                                                <code style="color: #d63384; word-break: break-all;">{{ incipit.paec_full }}</code>
                                            </td>
                                        </tr>
                                        <tr style="background: #fff;">
                                            <td style="padding: 4px;"><strong>JSON ID:</strong></td>
                                            <td style="padding: 4px; color: #28a745;">paec_json_{{ incipit.pk }}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>

                            {% elif incipit.notacion_musical %}
                            {# ========== FALLBACK: si paec_full est√° vac√≠o pero hay body ========== #}
                            <div class="alert alert-warning" style="padding: 1rem; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px;">
                                <strong>‚ö†Ô∏è Advertencia:</strong> Este √≠ncipit tiene <code>notacion_musical</code> pero no <code>paec_full</code>.
                                <br>Ejecuta la migraci√≥n o actualiza el registro para regenerar el PAEC completo.
                                <br><small>Body: <code>{{ incipit.notacion_musical|truncatechars:80 }}</code></small>
                            </div>

                            {% else %}
                            {# ========== Sin notaci√≥n musical ========== #}
                            <div class="text-muted" style="font-style: italic; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
                                No hay notaci√≥n musical disponible para este √≠ncipit.
                            </div>
                            {% endif %}

                            {% if incipit.urls.all %}
                            <div class="incipit-urls" style="margin-top: 1rem;">
                                {% for u in incipit.urls.all %}
                                <a href="{{ u.url }}" target="_blank" class="acceso-link">
                                    Ver √≠ncipit en l√≠nea <i class="bi bi-box-arrow-up-right"></i>
                                </a>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    </section>

            <!-- ================= RELACIONES ================= -->
            <section id="relaciones" class="detalle-section">
                <h3>Relaciones</h3>

                {% if obra.materias_650.exists or obra.materias_655.exists %}
                <div class="materias-container">
                    {% for mat in obra.materias_650.all %}
                    <div class="materia-tag">
                        <span class="campo-tag">650</span>
                        <span>
                            {% if mat.materia %}{{ mat.materia }}{% else %}‚Äî{% endif %}
                            {% if mat.subdivisiones.all %}
                                ‚Äî
                                {% for sub in mat.subdivisiones.all %}
                                    {{ sub.subdivision }}{% if not forloop.last %} ; {% endif %}
                                {% endfor %}
                            {% endif %}
                        </span>
                    </div>
                    {% endfor %}

                    {% for mat in obra.materias_655.all %}
                    <div class="materia-tag">
                        <span class="campo-tag">655</span>
                        <span>
                            {% if mat.materia %}{{ mat.materia }}{% else %}‚Äî{% endif %}
                            {% if mat.subdivisiones.all %}
                                ‚Äî
                                {% for sub in mat.subdivisiones.all %}
                                    {{ sub.subdivision }}{% if not forloop.last %} ; {% endif %}
                                {% endfor %}
                            {% endif %}
                        </span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted">No hay relaciones registradas.</p>
                {% endif %}

                {% if obra.menciones_serie.all %}
                <h4 class="subsection-title mt-3">Series</h4>
                {% for mencion in obra.menciones_serie.all %}
                <div class="data-row">
                    <span class="campo-tag">787</span>
                    <span>
                        {% if r.encabezamiento_principal %}
                            {{ r.encabezamiento_principal }}.
                        {% endif %}
                        {% if mencion.volumenes.all %}
                            ‚Äî
                            {% for v in mencion.volumenes.all %}
                                {{ v.volumen }}{% if not forloop.last %} ; {% endif %}
                            {% endfor %}
                        {% endif %}

                        {% for w in r.numeros_control.all %}
                            ({{ w.obra_relacionada.num_control }})
                        {% endfor %}
                    </span>
                </div>
                {% empty %}
                <p class="text-muted">No hay relaciones 787 registradas.</p>
                {% endfor %}
                {% endif %}
            </section>


            <!-- ================= EXISTENCIAS ================= -->
            <section id="existencias" class="detalle-section">
                <h3>Existencias</h3>


                    {# 852 #}
                    {% for u in obra.ubicaciones_852.all %}
                        {% if u.signatura_original %}
                        <div class="data-row">
                            <span class="campo-tag">852</span>
                            {{ u.signatura_original }}
                        </div>
                        {% endif %}
                    {% endfor %}

                    {# 856 #}

                {% if obra.ubicaciones_852.all %}
                <div class="ubicaciones-list">
                    {% for ubicacion in obra.ubicaciones_852.all %}
                    <div class="ubicacion-item">
                        <span class="campo-tag">852</span>
                        <span class="ubicacion-parte">
                            {% if ubicacion.signatura_original %}
                                {{ ubicacion.signatura_original }}
                            {% endif %}
                            {% if ubicacion.estanterias.all %}
                                ‚Äî Estanter√≠a:
                                {% for estanteria in ubicacion.estanterias.all %}
                                    {{ estanteria.estanteria }}{% if not forloop.last %}, {% endif %}
                                {% endfor %}
                            {% endif %}
                            {% if ubicacion.codigo_o_nombre %}
                                ‚Äî {{ ubicacion.codigo_o_nombre }}
                            {% endif %}
                        </span>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                {% if obra.disponibles_856.exists %}
                <h4 class="subsection-title mt-4">Disponible en l√≠nea</h4>

                {% for disponible in obra.disponibles_856.all %}
                    {% for url in disponible.urls_856.all %}
                    <div class="acceso-item">
                        <span class="campo-tag">856</span>
                        <a href="{{ url.url }}" class="acceso-link" target="_blank">
                            {% if disponible.textos_enlace_856.first %}
                                {{ disponible.textos_enlace_856.first.texto_enlace }}
                            {% else %}
                                {{ url.url }}
                            {% endif %}
                            <i class="bi bi-box-arrow-up-right"></i>
                        </a>
                    </div>
                    {% endfor %}
                {% endfor %}
                {% endif %}
            </section>

        </main>
    </div>
</div>

<!-- ================= JS ================= -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    const links = document.querySelectorAll('.nav-link');
    const sections = document.querySelectorAll('.detalle-section');
    if (!links.length || !sections.length) return;

    links.forEach(link => {
        link.addEventListener('click', e => {
            e.preventDefault();
            const target = document.querySelector(link.getAttribute('href'));
            if (!target) return;
            window.scrollTo({ top: target.offsetTop - 90, behavior: 'smooth' });
        });
    });

    const observer = new IntersectionObserver(entries => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                links.forEach(l =>
                    l.classList.toggle('active', l.getAttribute('href') === `#${entry.target.id}`)
                );
            }
        });
    }, { rootMargin: '-40% 0px -40% 0px' });

    sections.forEach(s => observer.observe(s));
});
</script>

<!-- Motor del canvas -->
<script src="{% static 'catalogacion/js/incipitManager.js' %}"></script>
<script src="{% static 'catalogacion/js/incipitInit.js' %}"></script>

<!-- <script>
    document.addEventListener('DOMContentLoaded', async function () {
  console.log('üéµ [INCIPIT] Iniciando carga de incipits musicales...');

  // ===== PASO 1: ESPERAR FUENTE MAESTRO =====
  try {
    if (document.fonts && document.fonts.load) {
      console.log('‚è≥ [INCIPIT] Cargando fuente Maestro...');
      await document.fonts.load('16px "Maestro"');
      await document.fonts.ready;
      console.log('‚úÖ [INCIPIT] Fuente Maestro cargada');
    }
  } catch (e) {
    console.warn('‚ö†Ô∏è [INCIPIT] Error al cargar fuente:', e);
  }

  // ===== PASO 2: VERIFICAR QUE CANVASINCIPIT EXISTE =====
  if (typeof CanvasIncipit === 'undefined') {
    console.error('‚ùå [INCIPIT] CanvasIncipit no est√° definido. Verifica que incipitManager.js est√© cargado.');
    return;
  }

  console.log('‚úÖ [INCIPIT] CanvasIncipit disponible');

  // ===== PASO 3: BUSCAR TODOS LOS CANVAS =====
  const canvases = document.querySelectorAll('canvas.incipit-view-canvas[data-paec-json-id]');
  console.log(`üìä [INCIPIT] Canvas encontrados: ${canvases.length}`);

  if (canvases.length === 0) {
    console.warn('‚ö†Ô∏è [INCIPIT] No se encontraron canvas para renderizar');
    return;
  }

  // ===== PASO 4: RENDERIZAR CADA CANVAS =====
  let successCount = 0;
  let errorCount = 0;

  canvases.forEach((cv, index) => {
    const canvasId = cv.id;
    const jsonId = cv.dataset.paecJsonId;

    console.log(`\n--- [INCIPIT ${index + 1}/${canvases.length}] ---`);
    console.log('üìå Canvas ID:', canvasId);
    console.log('üìå JSON ID:', jsonId);

    try {
      // Buscar el elemento script con el JSON
      const scriptElement = document.getElementById(jsonId);

      if (!scriptElement) {
        console.error(`‚ùå [${canvasId}] No se encontr√≥ script con id="${jsonId}"`);
        console.log('üí° Verifica que el template tenga: <script id="' + jsonId + '" type="application/json">');
        errorCount++;
        return;
      }

      // Leer el contenido del script
      const rawContent = scriptElement.textContent || scriptElement.innerText || "";
      console.log('üìÑ Contenido raw:', rawContent.substring(0, 100) + (rawContent.length > 100 ? '...' : ''));

      if (!rawContent || rawContent.trim() === '') {
        console.error(`‚ùå [${canvasId}] El script "${jsonId}" est√° vac√≠o`);
        errorCount++;
        return;
      }

      // Parsear el JSON (o usar como string directo)
      let paecFull;
      try {
        paecFull = JSON.parse(rawContent);
      } catch (e) {
        // Si no es JSON v√°lido, usar como string directo
        paecFull = rawContent.trim();
      }

      if (!paecFull) {
        console.error(`‚ùå [${canvasId}] PAEC vac√≠o despu√©s del parsing`);
        errorCount++;
        return;
      }

      console.log('üìù PAEC completo:', paecFull);

      // Validar formato PAEC b√°sico
      if (!paecFull.includes('%')) {
        console.warn(`‚ö†Ô∏è [${canvasId}] PAEC no contiene clave (%). Esto puede causar errores.`);
      }

      // Inicializar el canvas
      console.log('üé® Inicializando canvas...');
      CanvasIncipit.initializeCanvas(canvasId, 'list', paecFull);

      console.log(`‚úÖ [${canvasId}] Canvas renderizado correctamente`);
      successCount++;

    } catch (error) {
      console.error(`‚ùå [${canvasId}] Error al renderizar:`, error);
      console.error('Stack:', error.stack);
      errorCount++;

      // Mostrar error en el canvas
      try {
        const ctx = cv.getContext('2d');
        ctx.fillStyle = '#dc3545';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Error al renderizar √≠ncipit', cv.width / 2, cv.height / 2 - 10);
        ctx.font = '12px Arial';
        ctx.fillStyle = '#666';
        ctx.fillText(error.message, cv.width / 2, cv.height / 2 + 10);
      } catch (e) {
        console.error('No se pudo mostrar error en canvas:', e);
      }
    }
  });

  // ===== RESUMEN FINAL =====
  console.log('\n=================================');
  console.log('üèÅ [INCIPIT] Proceso completado');
  console.log(`‚úÖ Exitosos: ${successCount}`);
  console.log(`‚ùå Errores: ${errorCount}`);
  console.log('=================================\n');
});


// ============================================
// FUNCI√ìN DE DEPURACI√ìN
// Ejecutar en consola: debugIncipits()
// ============================================
window.debugIncipits = function() {
  console.log('\n========== DEBUG INCIPITS ==========');

  // Verificar CanvasIncipit
  console.log('1. CanvasIncipit definido:', typeof CanvasIncipit !== 'undefined');

  // Verificar fuente Maestro
  if (document.fonts && document.fonts.check) {
    const maestroLoaded = document.fonts.check('16px Maestro');
    console.log('2. Fuente Maestro cargada:', maestroLoaded);
  }

  // Listar canvas
  const canvases = document.querySelectorAll('canvas.incipit-view-canvas');
  console.log('3. Canvas encontrados:', canvases.length);

  canvases.forEach((cv, i) => {
    const jsonId = cv.dataset.paecJsonId;
    const scriptEl = jsonId ? document.getElementById(jsonId) : null;
    const paecContent = scriptEl ? scriptEl.textContent.substring(0, 80) : 'NO SCRIPT';

    console.log(`\n   Canvas ${i + 1}:`);
    console.log(`   - ID: ${cv.id}`);
    console.log(`   - JSON ID: ${jsonId || 'NO DATA-PAEC-JSON-ID'}`);
    console.log(`   - Script existe: ${!!scriptEl}`);
    console.log(`   - PAEC: ${paecContent}...`);
  });

  console.log('\n====================================\n');
};


// ============================================
// FUNCI√ìN PARA REFRESCAR UN CANVAS
// Uso: refreshCanvas('incipit_view_canvas_123')
// ============================================
window.refreshCanvas = function(canvasId) {
  console.log(`\nüîÑ Refrescando canvas: ${canvasId}`);

  const cv = document.getElementById(canvasId);
  if (!cv) {
    console.error(`‚ùå No se encontr√≥ canvas con id="${canvasId}"`);
    return;
  }

  const jsonId = cv.dataset.paecJsonId;
  if (!jsonId) {
    console.error('‚ùå Canvas no tiene data-paec-json-id');
    return;
  }

  const scriptEl = document.getElementById(jsonId);
  if (!scriptEl) {
    console.error(`‚ùå No se encontr√≥ script con id="${jsonId}"`);
    return;
  }

  let paecFull;
  try {
    paecFull = JSON.parse(scriptEl.textContent);
  } catch (e) {
    paecFull = scriptEl.textContent.trim();
  }

  if (!paecFull) {
    console.error('‚ùå PAEC vac√≠o');
    return;
  }

  console.log('üìù PAEC:', paecFull);

  try {
    CanvasIncipit.initializeCanvas(canvasId, 'list', paecFull);
    console.log('‚úÖ Canvas refrescado correctamente');
  } catch (error) {
    console.error('‚ùå Error al refrescar:', error);
  }
};
</script> -->


<style>
  .incipit-view-canvas { pointer-events: none; }
</style>


{% endblock catalogacion_content %}
