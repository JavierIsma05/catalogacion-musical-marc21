{% comment %}
FORMSET 773 â€“ Enlace a Documento Fuente
Plantilla UNIFICADA, optimizada y estable
Incluye:
âœ” Autocomplete usable
âœ” DiseÃ±o estable
âœ” Clonado correcto
âœ” Subcampo $w funcionando
{% endcomment %}

<div class="formset-container" data-formset-prefix="{{ formset.prefix }}">
    {{ formset.management_form }}

    <!-- BotÃ³n agregar 773 -->
    <button type="button" class="add-form-row btn btn-outline-primary mb-3">
        <i class="bi bi-plus-circle"></i> Agregar Enlace 773
    </button>

    <div class="formset-forms">

        {% for form in formset %}
        <div class="formset-row {% if form.instance.pk %}existing-form{% endif %} mb-3">

            {% if formset.can_delete %}
            <div class="d-none">{{ form.DELETE }}</div>
            {% endif %}

            <!-- BotÃ³n eliminar -->
            <button type="button" class="delete-row-btn btn btn-sm btn-outline-danger float-end" aria-label="Eliminar enlace">
                <i class="bi bi-x-lg"></i>
            </button>

            <div class="card mt-4">
                <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">{{ form.primer_indicador.label }}</label>
                                {{ form.primer_indicador }}
                                {% if form.primer_indicador.errors %}
                                <div class="invalid-feedback d-block">{{ form.primer_indicador.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ form.segundo_indicador.label }}</label>
                                {{ form.segundo_indicador }}
                                {% if form.segundo_indicador.errors %}
                                <div class="invalid-feedback d-block">{{ form.segundo_indicador.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                    <div class="mb-3">

                        <!-- Etiqueta -->
                        <label class="form-label">{{ form.encabezamiento_principal_texto.label }}</label>

                        <div class="autocomplete-wrapper">
                            <!-- INPUT visible donde el usuario escribe -->
                            <input type="text" class="form-control autocomplete-773"
                                placeholder="Escriba para buscar o agregarâ€¦"
                                value="{{ form.encabezamiento_principal_texto.value|default:'' }}"
                                data-hidden-input="{{ form.encabezamiento_principal.id_for_label }}">

                            <!-- Contenedor donde aparecen las sugerencias -->
                            <div class="autocomplete-suggestions" data-autocomplete-target></div>
                        </div>

                        <!-- INPUT oculto que guarda el ID real del compositor -->
                        {{ form.encabezamiento_principal }}
                    </div>


                    <!-- TÃ­tulo -->
                    <div class="mb-3">
                        <label>{{ form.titulo.label }}</label>
                        {{ form.titulo }}
                            {% if form.titulo.errors %}
                            <div class="invalid-feedback d-block">{{ form.titulo.errors }}</div>
                            {% endif %}
                    </div>

                    <!-- BotÃ³n agregar nÃºmero $w -->
                    <div class="mb-3">
                        <button type="button" class="btn btn-sm btn-outline-secondary add-numero-btn w-100"
                            data-index="{{ forloop.counter0 }}">
                            <i class="bi bi-plus-circle"></i> Agregar NÃºmero de Obra ($w)
                        </button>
                    </div>

                    <!-- Contenedor de nÃºmeros -->
                    <div class="numeros-container" data-numeros-container="{{ forloop.counter0 }}">
                        {% for numero in form.instance.numeros_obra.all %}
                        <div class="numero-form-row d-flex gap-2 mb-2">
                            <input type="text" class="form-control"
                                name="numero_773_{{ forloop.parentloop.counter0 }}_{{ numero.pk }}"
                                value="{{ numero.numero }}" placeholder="Ej: 000123456">

                            <button type="button" class="btn btn-outline-danger delete-numero-btn" aria-label="Eliminar nÃºmero">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                        {% endfor %}
                    </div>

                </div>
            </div>
        </div>
        {% endfor %}

        <!-- âœ¨ TEMPLATE VACÃO PARA CLONAR -->
        <div class="formset-row empty-form d-none">

            <button type="button" class="delete-row-btn btn btn-sm btn-outline-danger float-end" aria-label="Eliminar enlace">
                <i class="bi bi-x-lg"></i>
            </button>

            <div class="card mt-4">
                <div class="card-body">

                    {{ formset.empty_form.encabezamiento_principal }}

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">{{ formset.empty_form.primer_indicador.label }}</label>
                            {{ formset.empty_form.primer_indicador }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">{{ formset.empty_form.segundo_indicador.label }}</label>
                            {{ formset.empty_form.segundo_indicador }}
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="autocomplete-wrapper">
                            {{ formset.empty_form.encabezamiento_principal_texto }}
                            <div class="autocomplete-suggestions" data-autocomplete-target></div>
                        </div>
                    </div>

                    <div class="mb-3">
                        {{ formset.empty_form.titulo }}
                    </div>

                    <div class="mb-3">
                        <button type="button" class="btn btn-sm btn-outline-secondary add-numero-btn w-100"
                            data-index="__prefix__">
                            <i class="bi bi-plus-circle"></i> Agregar NÃºmero de Obra ($w)
                        </button>
                    </div>

                    <div class="numeros-container" data-numeros-container="__prefix__"></div>

                </div>
            </div>
        </div>

    </div>
</div>

<!-- TEMPLATE NÃšMERO DE OBRA ($w) -->
<div class="numero-form-row numero-template d-none">
    <div class="d-flex gap-2 mb-2">
        <input type="text" class="form-control numero-w-input" placeholder="Ej: 000123456">
        <button type="button" class="btn btn-outline-danger delete-numero-btn" aria-label="Eliminar nÃºmero">
            <i class="bi bi-trash"></i>
        </button>
    </div>
</div>
<script>
// AUTOCOMPLETE DEL 773 $a â€” igual al del 700
document.addEventListener("input", async function(e) {

    const input = e.target.closest(".autocomplete-773");
    if (!input) return;

    const hiddenId = input.dataset.hiddenInput;
    const hiddenField = document.getElementById(hiddenId);
    const target = input.parentElement.querySelector("[data-autocomplete-target]");

    const query = input.value.trim();

    if (query.length < 2) {
        target.innerHTML = "";
        hiddenField.value = "";
        return;
    }

    // PeticiÃ³n AJAX para buscar personas
    const response = await fetch(`/catalogacion/api/autocompletar/persona/?q=${query}`);
    const data = await response.json();

    target.innerHTML = "";

    // Sugerencias encontradas
    data.results.forEach(item => {
        const opt = document.createElement("div");
        opt.classList.add("autocomplete-item");
        opt.style.padding = "6px 10px";
        opt.style.cursor = "pointer";
        opt.style.borderBottom = "1px solid #efefef";
        opt.textContent = item.text;

        opt.onclick = () => {
            input.value = item.apellidos_nombres;
            hiddenField.value = item.id;
            target.innerHTML = "";
        };

        target.appendChild(opt);
    });

    // OpciÃ³n "crear nuevo"
    const crear = document.createElement("div");
    crear.classList.add("autocomplete-item");
    crear.style.padding = "6px 10px";
    crear.style.cursor = "pointer";
    crear.innerHTML = `<strong>âž• Crear nuevo:</strong> â€œ${query}â€`;

    crear.onclick = () => {
        input.value = query;
        hiddenField.value = "";  // Sin ID â†’ se crea al guardar
        target.innerHTML = "";
    };

    target.appendChild(crear);
});
</script>

<!-- ===========================
       JAVASCRIPT FORMSET 773
=========================== -->
<script>
    (function () {
        const prefix = '{{ formset.prefix }}';
        const container = document.querySelector(`[data-formset-prefix="${prefix}"]`);

        if (!container) return;

        const totalFormsInput = container.querySelector(`#id_${prefix}-TOTAL_FORMS`);
        const addButton = container.querySelector('.add-form-row');
        const formsContainer = container.querySelector('.formset-forms');
        const numeroTemplate = document.querySelector('.numero-template');

        /* =========================================
           âž• 1. AGREGAR NUEVO FORMULARIO 773
        ========================================= */
        addButton.addEventListener('click', function () {
            const total = parseInt(totalFormsInput.value);
            const template = formsContainer.querySelector('.empty-form');

            const newForm = template.cloneNode(true);
            newForm.classList.remove('empty-form', 'd-none');

            newForm.innerHTML = newForm.innerHTML.replace(/__prefix__/g, total);

            formsContainer.appendChild(newForm);

            totalFormsInput.value = total + 1;
        });

        /* =========================================
           ðŸ—‘ 2. ELIMINAR FORM 773
        ========================================= */
        container.addEventListener('click', function (event) {
            const btn = event.target.closest('.delete-row-btn');
            if (!btn) return;

            const row = btn.closest('.formset-row');
            if (!row || row.classList.contains('empty-form')) return;

            const deleteField = row.querySelector('input[name*="DELETE"]');

            if (deleteField) {
                deleteField.checked = !deleteField.checked;
                row.style.opacity = deleteField.checked ? "0.5" : "1";
            } else {
                row.remove();
                totalFormsInput.value = parseInt(totalFormsInput.value) - 1;
            }
        });

        /* =========================================
           âž• 3. AGREGAR NÃšMERO $w
        ========================================= */
        container.addEventListener('click', function (event) {
            const addBtn = event.target.closest('.add-numero-btn');
            if (!addBtn) return;

            const index = addBtn.dataset.index;
            const target = container.querySelector(`[data-numeros-container="${index}"]`);

            if (!target) return;

            const newW = numeroTemplate.cloneNode(true);
            newW.classList.remove('numero-template', 'd-none');

            const input = newW.querySelector('.numero-w-input');
            input.name = `numero_773_${index}_${Date.now()}`;

            target.appendChild(newW);
        });

        /* =========================================
           ðŸ—‘ 4. ELIMINAR NÃšMERO $w
        ========================================= */
        container.addEventListener('click', function (event) {
            const btn = event.target.closest('.delete-numero-btn');
            if (!btn) return;

            const row = btn.closest('.numero-form-row');
            if (!row.classList.contains('numero-template')) {
                row.remove();
            }
        });

    })();
</script>