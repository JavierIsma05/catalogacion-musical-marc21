{% comment %}
FORMSET 773 ‚Äì Documento Fuente (R)
‚úî Sin bot√≥n interno
‚úî Controlado por bot√≥n global 7XX
‚úî Autocomplete estable
‚úî Clonado correcto
{% endcomment %}

<div class="formset-container"
     data-formset-prefix="{{ formset.prefix }}">

    <!-- Management form -->
    <div class="d-none">
        {% for hidden in formset.management_form %}
            {{ hidden }}
        {% endfor %}
    </div>

    <div class="formset-forms">

        {% for form in formset %}
        <div class="formset-row {% if form.instance.pk %}existing-form{% endif %} mb-3">

            {% for hidden in form.hidden_fields %}
                {{ hidden }}
            {% endfor %}

            {% if formset.can_delete %}
                <div class="d-none">{{ form.DELETE }}</div>
            {% endif %}

            <!-- ‚ùå eliminar fila -->
            <button type="button"
                    class="delete-row-btn"
                    title="Eliminar documento fuente">
                <i class="bi bi-x-lg"></i>
            </button>

            <div class="card mt-3">
                
                <div class="card-body">

                    <!-- indicadores ocultos -->
                    <div class="d-none">
                        {{ form.primer_indicador }}
                        {{ form.segundo_indicador }}
                    </div>

                    <!-- ================= 773 $a ================= -->
                    <div class="mb-3">
                        <label class="form-label small">
                            773 $a ‚Äì Compositor
                        </label>

                        <div class="autocomplete-wrapper"
                             data-autocomplete="persona">
                            {{ form.encabezamiento_principal_texto }}
                            <div class="autocomplete-suggestions"></div>
                        </div>

                        <small class="form-text text-muted">
                            Seleccione una autoridad o escriba para crearla.
                        </small>
                    </div>

                    <!-- ================= 773 $t ================= -->
                    <div class="mb-3">
                        <label class="form-label small">
                            773 $t ‚Äì T√≠tulo
                        </label>

                        <div class="autocomplete-wrapper"
                             data-autocomplete="titulo">
                            {{ form.titulo_texto }}
                            <div class="autocomplete-suggestions"></div>
                        </div>

                        <small class="form-text text-muted">
                            Usa autoridades de t√≠tulos uniformes.
                        </small>
                    </div>

                    <!-- ================= 773 $w ================= -->
                    <div class="mt-4">
                        <label class="form-label small fw-semibold">
                            773 $w ‚Äì N√∫mero de de documento fuente
                        </label>

                        <div class="input-group">
                            <!-- Visible (solo muestra el 001) -->
                            <input type="text"
                                class="form-control numero-w-input"
                                placeholder="Seleccione una obra"
                                readonly>

                            <!-- Bot√≥n lupa -->
                            <button type="button"
                                    class="btn btn-outline-secondary btn-buscar-obra"
                                    data-enlace-id="{{ enlace.pk }}"
                                    data-campo="773"
                                    title="Buscar obra">
                                <i class="bi bi-search"></i>
                            </button>

                            <!-- üî• ESTE ES EL IMPORTANTE -->
                            <input type="hidden"
                                class="obra-relacionada-id-input"
                                name="w_773_{{ enlace.pk }}">

                            <!-- Bot√≥n Auto eliminado: autocompletado ahora ocurre autom√°ticamente
                                 al seleccionar una obra del 774 desde el modal de b√∫squeda -->
                        </div>
                    </div>


                </div>
            </div>
        </div>
        {% endfor %}

        <!-- ================= EMPTY FORM ================= -->
        <div class="formset-row empty-form d-none">

            {% for hidden in formset.empty_form.hidden_fields %}
                {{ hidden }}
            {% endfor %}

            <button type="button" class="delete-row-btn">
                <i class="bi bi-x-lg"></i>
            </button>

            <div class="card mt-3">
                <div class="card-body">

                    <div class="d-none">
                        {{ formset.empty_form.primer_indicador }}
                        {{ formset.empty_form.segundo_indicador }}
                    </div>

                    <div class="mb-3">
                        <label class="form-label small">
                            773 $a ‚Äì Compositor
                        </label>
                        <div class="autocomplete-wrapper"
                             data-autocomplete="persona">
                            {{ formset.empty_form.encabezamiento_principal_texto }}
                            <div class="autocomplete-suggestions"></div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small">
                            773 $t ‚Äì T√≠tulo
                        </label>
                        <div class="autocomplete-wrapper"
                             data-autocomplete="titulo">
                            {{ formset.empty_form.titulo_texto }}
                            <div class="autocomplete-suggestions"></div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <label class="form-label small">
                            773 $w ‚Äì N√∫mero de de documento fuente
                        </label>
                        <input type="text"
                               class="form-control"
                               placeholder="Ej: 000123456">
                    </div>

                </div>
            </div>
        </div>

    </div>
</div>
<script>
(function () {

    /* =====================================================
       AUTOCOMPLETE GEN√âRICO (persona / t√≠tulo)
       ===================================================== */
    function initAutocomplete(wrapper) {

        // üî• CLAVE: permitir reinicializar
        wrapper.removeAttribute("data-autocomplete-init");

        if (!wrapper || wrapper.dataset.autocompleteInit === "1") return;
        wrapper.dataset.autocompleteInit = "1";

        const type  = wrapper.dataset.autocomplete;
        const input = wrapper.querySelector("input");
        const box   = wrapper.querySelector(".autocomplete-suggestions");

        if (!type || !input || !box) return;

        let endpoint = null;

        if (type === "persona") {
            endpoint = "/catalogacion/api/autocompletar/persona/";
        }
        if (type === "titulo") {
            endpoint = "/catalogacion/api/autocompletar/titulo/";
        }
        if (!endpoint) return;

        let timer = null;

        function hide() {
            box.classList.remove("show");
            box.innerHTML = "";
        }

        input.addEventListener("input", () => {
            const q = input.value.trim();
            if (q.length < 2) {
                hide();
                return;
            }

            clearTimeout(timer);
            timer = setTimeout(() => {
                fetch(`${endpoint}?q=${encodeURIComponent(q)}`)
                    .then(r => r.json())
                    .then(data => {
                        box.innerHTML = "";
                        const results = data.results || [];

                        if (!results.length) {
                            box.innerHTML = `
                                <div class="autocomplete-item autocomplete-item-new">
                                    <i class="bi bi-plus-circle me-2"></i>
                                    Crear: "${q}"
                                </div>`;
                        } else {
                            results.forEach(item => {
                                const div = document.createElement("div");
                                div.className = "autocomplete-item";
                                div.textContent = item.text;
                                div.onclick = () => {
                                    input.value = item.text;
                                    hide();
                                };
                                box.appendChild(div);
                            });

                            const crear = document.createElement("div");
                            crear.className = "autocomplete-item autocomplete-item-new";
                            crear.innerHTML = `<i class="bi bi-plus-circle me-2"></i> Crear: "${q}"`;
                            crear.onclick = () => {
                                input.value = q;
                                hide();
                            };
                            box.appendChild(crear);
                        }

                        box.classList.add("show");
                    });
            }, 300);
        });

        document.addEventListener("click", e => {
            if (!wrapper.contains(e.target)) hide();
        });
    }

    /* =====================================================
       HOOK: reinicializar autocomplete al agregar fila
       (evita duplicar filas por handlers globales)
       ===================================================== */
    const THIS_FORMSET_PREFIX = "{{ formset.prefix|escapejs }}";

    // Si existe el gestor central (FormsetManager), √©l es el √∫nico que agrega filas.
    // Aqu√≠ solo reinicializamos autocompletes cuando se agrega una nueva fila.
    document.addEventListener("formset:added", function (ev) {
        const detail = ev && ev.detail ? ev.detail : null;
        if (!detail || detail.prefix !== THIS_FORMSET_PREFIX) return;

        const root = detail.newForm;
        if (!root || !root.querySelectorAll) return;

        root
            .querySelectorAll(".autocomplete-wrapper[data-autocomplete]")
            .forEach((w) => {
                w.removeAttribute("data-autocomplete-init");
                initAutocomplete(w);
            });
    });

    /* =====================================================
       INIT INICIAL
       ===================================================== */
    document
        .querySelectorAll(".autocomplete-wrapper[data-autocomplete]")
        .forEach(initAutocomplete);

})();
</script>

<script>
(function() {
    'use strict';

    // =====================================================
    // üî• AUTOCOMPLETADO 773 - CAMPOS HEREDABLES
    // =====================================================

    class Autocompletado773 {
        constructor() {
            this.isProcessing = false;  // Bandera para prevenir ejecuciones m√∫ltiples
            this.activeIntervals = new Map();  // Almacenar intervals activos por enlaceId
            this.boundInputs = new WeakSet();  // Rastrear inputs con listeners ya agregados
            this.init();
        }

        init() {
            this.bindEvents();
        }

        bindEvents() {
            // Evento para botones de buscar obra
            document.addEventListener('click', (e) => {
                if (e.target.closest('.btn-buscar-obra')) {
                    this.handleBuscarObra(e.target.closest('.btn-buscar-obra'));
                }

                // Bot√≥n Auto eliminado - autocompletado ocurre autom√°ticamente desde modal
            });

            // Evento cuando cambia el input de obra relacionada
            document.addEventListener('change', (e) => {
                if (e.target.classList.contains('obra-relacionada-id-input')) {
                    this.handleObraSeleccionada(e.target);
                }
            });
        }

        handleBuscarObra(btn) {
            const enlaceId = btn.dataset.enlaceId || 'default';
            const input = document.querySelector(`input[name="w_773_${enlaceId}"]`) ||
                          btn.parentElement.querySelector('.obra-relacionada-id-input');
            const visibleInput = btn.parentElement.querySelector('.numero-w-input');

            if (!input) {
                console.warn('‚ö†Ô∏è No se encontr√≥ input para enlaceId:', enlaceId);
                return;
            }

            console.log('üîç handleBuscarObra iniciado para enlaceId:', enlaceId);

            // Limpiar interval anterior si existe para este enlaceId
            if (this.activeIntervals.has(enlaceId)) {
                clearInterval(this.activeIntervals.get(enlaceId));
                this.activeIntervals.delete(enlaceId);
                console.log('üßπ Interval anterior limpiado para:', enlaceId);
            }

            let ultimoValor = input.value;
            let autocompletadoRealizado = false;

            // Monitorear cambios en el input cada 500ms
            const monitorInterval = setInterval(() => {
                // Si ya se realiz√≥ el autocompletado, detener el monitoreo
                if (autocompletadoRealizado) {
                    clearInterval(monitorInterval);
                    this.activeIntervals.delete(enlaceId);
                    console.log('‚úÖ Monitoreo detenido - autocompletado ya realizado');
                    return;
                }

                const valorActual = input.value;

                if (valorActual && valorActual !== ultimoValor && valorActual !== '') {
                    console.log('üîÑ ¬°CAMBIO DETECTADO! Valor anterior:', ultimoValor, 'Nuevo valor:', valorActual);

                    // Actualizar input visible
                    if (visibleInput) {
                        visibleInput.value = valorActual;
                    }

                    // Autocompletado ahora ocurre autom√°ticamente desde el modal
                    // al seleccionar una obra del 774. Marcar como realizado.
                    autocompletadoRealizado = true;
                    clearInterval(monitorInterval);
                    this.activeIntervals.delete(enlaceId);
                    console.log('‚úÖ Obra seleccionada desde modal');

                    ultimoValor = valorActual;
                }
            }, 500);

            // Guardar referencia al interval
            this.activeIntervals.set(enlaceId, monitorInterval);

            // Limpiar despu√©s de 30 segundos (reducido de 60)
            setTimeout(() => {
                if (this.activeIntervals.has(enlaceId)) {
                    clearInterval(this.activeIntervals.get(enlaceId));
                    this.activeIntervals.delete(enlaceId);
                    console.log('‚è∞ Monitoreo detenido por timeout para:', enlaceId);
                }
            }, 30000);

            // Agregar event listener solo si no existe ya
            if (!this.boundInputs.has(input)) {
                this.boundInputs.add(input);

                input.addEventListener('change', (e) => {
                    console.log('üìù Evento change detectado:', e.target.value);
                    // Autocompletado ahora ocurre desde el modal al seleccionar obra 774
                    if (e.target.value && e.target.value !== '' && !autocompletadoRealizado) {
                        autocompletadoRealizado = true;
                        // Limpiar interval si existe
                        if (this.activeIntervals.has(enlaceId)) {
                            clearInterval(this.activeIntervals.get(enlaceId));
                            this.activeIntervals.delete(enlaceId);
                        }
                    }
                });
            }
        }

        handleObraSeleccionada(input) {
            // Bot√≥n Auto eliminado - autocompletado ahora ocurre desde el modal
            // Esta funci√≥n se mantiene por si se necesita l√≥gica adicional al seleccionar obra
            const obraId = input.value;
            const enlaceId = input.name.replace('w_773_', '');
            console.log('Obra seleccionada:', { obraId, enlaceId });
        }

        async handleAutocompletar(btn) {
            const obraId = btn.dataset.obraId;

            if (!obraId) {
                this.mostrarMensaje('Seleccione primero una obra padre', 'warning');
                return;
            }

            // Prevenir ejecuciones m√∫ltiples
            if (this.isProcessing) {
                console.log('‚è∏Ô∏è Autocompletado ya en proceso, ignorando llamada duplicada');
                return;
            }

            this.isProcessing = true;

            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Cargando...';

                console.log('üöÄ Iniciando autocompletado para obraId:', obraId);

                const response = await fetch('/catalogacion/api/obras/autocomplete/773/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCSRFToken()
                    },
                    body: JSON.stringify({ obra_id: obraId })
                });

                console.log('üì° Respuesta recibida:', response.status);

                const data = await response.json();
                console.log('üì¶ Datos recibidos:', data);

                if (data.success) {
                    console.log('üîç CAMPOS RECIBIDOS DE LA API:');
                    console.log('  - Campo 100:', data.campos_heredables['100']);
                    console.log('  - Campo 245:', data.campos_heredables['245']);
                    console.log('  - Campo 264:', data.campos_heredables['264']);
                    console.log('  - Campo 382:', data.campos_heredables['382']);
                    console.log('  - Campo 545:', data.campos_heredables['545']);
                    console.log('  - Campo 852:', data.campos_heredables['852']);
                    console.log('  - Campo 856:', data.campos_heredables['856']);

                    await this.poblarCamposHeredables(data.campos_heredables);
                    this.mostrarMensaje(
                        `Campos heredados de "${data.obra.titulo}" (${data.obra.num_control})`,
                        'success'
                    );
                } else {
                    this.mostrarMensaje(data.error || 'Error al obtener campos', 'error');
                }

            } catch (error) {
                console.error('‚ùå Error en autocompletado:', error);
                this.mostrarMensaje('Error de conexi√≥n', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-magic"></i> Auto';
                // Liberar la bandera despu√©s de un peque√±o delay para evitar re-disparos inmediatos
                setTimeout(() => {
                    this.isProcessing = false;
                    console.log('‚úÖ Autocompletado finalizado, listo para nuevo proceso');
                }, 1000);
            }
        }

        async poblarCamposHeredables(campos) {
            console.log('üöÄ INICIANDO PROCESO DE AUTOCOMPLETADO DE CAMPOS HEREDABLES');
            console.log('================================================================');
            
            // Validar que tenemos datos
            if (!campos || typeof campos !== 'object') {
                console.error('‚ùå Datos de campos inv√°lidos:', campos);
                this.mostrarMensaje('Error: Datos inv√°lidos recibidos', 'error');
                return;
            }
            
            // üî• DIAGN√ìSTICO COMPLETO - MOSTRAR TODOS LOS INPUTS
            console.log('üîç DIAGN√ìSTICO COMPLETO DEL FORMULARIO:');
            console.log('=====================================');
            
            // Mostrar todos los inputs del formulario
            const allInputs = document.querySelectorAll('input, textarea, select');
            console.log(`üìã TOTAL DE ELEMENTOS ENCONTRADOS: ${allInputs.length}`);
            
            allInputs.forEach((input, index) => {
                const tagName = input.tagName.toLowerCase();
                const inputType = input.type || 'N/A';
                const inputName = input.name || 'SIN_NOMBRE';
                const inputValue = input.value || 'VAC√çO';
                const inputId = input.id || 'SIN_ID';
                const inputClass = input.className || 'SIN_CLASE';
                
                console.log(`${index + 1}. [${tagName}] name="${inputName}" type="${inputType}" value="${inputValue}" id="${inputId}" class="${inputClass}"`);
            });
            
            console.log('=====================================');
            console.log('üîç CAMPOS RECIBIDOS DE LA API:');
            
            // Lista de campos esperados
            const camposEsperados = ['100', '245', '264', '382', '545', '852', '856'];
            let camposProcesados = 0;
            let camposExitosos = 0;
            
            camposEsperados.forEach(campoCodigo => {
                const campoData = campos[campoCodigo];
                console.log(`  - Campo ${campoCodigo}:`, campoData ? '‚úÖ RECIBIDO' : '‚ùå AUSENTE', campoData || '');
                
                if (campoData) {
                    camposProcesados++;
                    try {
                        switch (campoCodigo) {
                            case '100':
                                this.poblarCampo100(campoData);
                                break;
                            case '245':
                                this.poblarCampo245(campoData);
                                break;
                            case '264':
                                this.poblarCampo264(campoData);
                                break;
                            case '382':
                                this.poblarCampo382(campoData);
                                break;
                            case '545':
                                this.poblarCampo545(campoData);
                                break;
                            case '852':
                                this.poblarCampo852(campoData);
                                break;
                            case '856':
                                this.poblarCampo856(campoData);
                                break;
                            default:
                                console.warn(`‚ö†Ô∏è Campo ${campoCodigo} no tiene implementaci√≥n`);
                                break;
                        }
                        camposExitosos++;
                        console.log(`‚úÖ Campo ${campoCodigo} procesado exitosamente`);
                    } catch (error) {
                        console.error(`‚ùå Error procesando campo ${campoCodigo}:`, error);
                    }
                }
            });
            
            console.log('=====================================');
            console.log('üìä RESUMEN DEL PROCESAMIENTO:');
            console.log(`  - Campos esperados: ${camposEsperados.length}`);
            console.log(`  - Campos recibidos: ${camposProcesados}`);
            console.log(`  - Campos procesados exitosamente: ${camposExitosos}`);
            console.log(`  - Tasa de √©xito: ${((camposExitosos / camposEsperados.length) * 100).toFixed(1)}%`);
            console.log('=====================================');
            
            // Mostrar mensaje de √©xito si se proces√≥ al menos un campo
            if (camposExitosos > 0) {
                this.mostrarMensaje(
                    `Se autocompletaron ${camposExitosos} de ${camposEsperados.length} campos exitosamente`,
                    'success'
                );
            } else {
                this.mostrarMensaje('No se pudo autocompletar ning√∫n campo', 'warning');
            }

            // NOTA: Se elimin√≥ la cascada de eventos que causaba el loop
            console.log('‚úÖ Proceso de autocompletado finalizado');
        }

        poblarCampo100(campo) {
        console.log('üé® Poblando campo 100 con:', campo);
        
        // üî• SELECTORES EXACTOS seg√∫n los nombres reales del formulario
        const compositorHidden = document.querySelector('input[name="compositor"]'); // hidden ID
        const compositorTexto = document.querySelector('input[name="compositor_texto"]'); // texto visible
        const compositorCoordenadas = document.querySelector('input[name="compositor_coordenadas"]'); // coordenadas
        
        console.log('üìç Inputs 100 encontrados:');
        console.log('  - compositorHidden:', compositorHidden);
        console.log('  - compositorTexto:', compositorTexto);
        console.log('  - compositorCoordenadas:', compositorCoordenadas);
        
        // Mostrar todos los inputs relacionados con 100 para diagn√≥stico
        const all100Inputs = document.querySelectorAll('input[name*="compositor"], input[name*="100"]');
        console.log('üîç TODOS los inputs relacionados con 100:');
        all100Inputs.forEach((input, index) => {
            console.log(`  ${index + 1}. name="${input.name}" type="${input.type}" value="${input.value}" id="${input.id}"`);
        });
        
        // Poblar ID del compositor (campo hidden)
        if (compositorHidden && campo.compositor_id) {
            compositorHidden.value = campo.compositor_id;
            console.log('‚úÖ Compositor ID actualizado:', campo.compositor_id);
            
            setTimeout(() => {
                compositorHidden.dispatchEvent(new Event('change', { bubbles: true }));
            }, 100);
        } else {
            console.log('‚ùå No se encontr√≥ input hidden de compositor o no hay datos');
        }
        
        // Poblar texto del compositor (campo visible)
        if (compositorTexto && campo.compositor_texto && !compositorTexto.value.trim()) {
            compositorTexto.value = campo.compositor_texto;
            console.log('‚úÖ Compositor texto actualizado:', campo.compositor_texto);
            
            setTimeout(() => {
                compositorTexto.dispatchEvent(new Event('change', { bubbles: true }));
                compositorTexto.dispatchEvent(new Event('input', { bubbles: true }));
                compositorTexto.dispatchEvent(new Event('blur', { bubbles: true }));
            }, 100);
        } else {
            console.log('‚ùå No se encontr√≥ input de texto o ya tiene valor');
        }
        
        // Poblar coordenadas biogr√°ficas ($c)
        if (compositorCoordenadas && campo.coordenadas_biograficas && !compositorCoordenadas.value.trim()) {
            compositorCoordenadas.value = campo.coordenadas_biograficas;
            console.log('‚úÖ Coordenadas biogr√°ficas actualizadas:', campo.coordenadas_biograficas);
            
            setTimeout(() => {
                compositorCoordenadas.dispatchEvent(new Event('change', { bubbles: true }));
                compositorCoordenadas.dispatchEvent(new Event('input', { bubbles: true }));
            }, 100);
        } else {
            console.log('‚ùå No se encontr√≥ input de coordenadas o ya tiene valor');
        }
        
        // Poblar funciones del compositor ($e - repetible)
        if (campo.funciones && campo.funciones.length > 0) {
            console.log('üé≠ Funciones del compositor ($e):', campo.funciones);
            
            // Buscar formset de funciones 100e
            const formsetFunciones = document.querySelector('[data-formset-prefix*="funciones_compositor"]');
            if (formsetFunciones) {
                console.log('üìã Formset de funciones encontrado');
                
                // Agregar filas si es necesario y poblar
                campo.funciones.forEach((funcion, index) => {
                    const existingRows = formsetFunciones.querySelectorAll('.formset-row:not(.empty-form)').length;
                    if (existingRows <= index) {
                        this.agregarFilaFormset(formsetFunciones);
                        console.log('‚ûï Agregando nueva fila de funci√≥n para √≠ndice:', index);
                    }
                    
                    const rows = formsetFunciones.querySelectorAll('.formset-row:not(.empty-form)');
                    const row = rows[index];
                    
                    if (row) {
                        const funcionSelect = row.querySelector('select[name*="funcion"]');
                        if (funcionSelect && !funcionSelect.value) {
                            funcionSelect.value = funcion.funcion;
                            console.log('‚úÖ Funci√≥n ($e) actualizada:', funcion.funcion_display);
                            
                            setTimeout(() => {
                                funcionSelect.dispatchEvent(new Event('change', { bubbles: true }));
                            }, 100);
                        }
                    }
                });
            } else {
                console.log('‚ùå No se encontr√≥ formset de funciones 100e');
            }
        } else {
            console.log('‚ùå No hay datos de funciones');
        }
    }

    poblarCampo245(campo) {
        console.log('üé® Poblando campo 245 (T√≠tulo Principal) con:', campo);
        
        // Buscar los 3 campos REALES del formulario 245
        const tituloPrincipal = document.querySelector('input[name="titulo_principal"], #id_titulo_principal');
        const subtitulo = document.querySelector('input[name="subtitulo"], #id_subtitulo');
        const mencionResponsabilidad = document.querySelector('input[name="mencion_responsabilidad"], #id_mencion_responsabilidad');
        
        console.log('üìç Inputs 245 encontrados:');
        console.log('  - tituloPrincipal:', tituloPrincipal);
        console.log('  - subtitulo:', subtitulo);
        console.log('  - mencionResponsabilidad:', mencionResponsabilidad);
        
        // Poblar t√≠tulo principal
        if (tituloPrincipal && campo.titulo_principal && !tituloPrincipal.value.trim()) {
            tituloPrincipal.value = campo.titulo_principal;
            console.log('‚úÖ T√≠tulo principal actualizado:', campo.titulo_principal);
            setTimeout(() => {
                tituloPrincipal.dispatchEvent(new Event('change', { bubbles: true }));
            }, 100);
        }
        
        // Poblar subt√≠tulo
        if (subtitulo && campo.subtitulo && !subtitulo.value.trim()) {
            subtitulo.value = campo.subtitulo;
            console.log('‚úÖ Subt√≠tulo actualizado:', campo.subtitulo);
            setTimeout(() => {
                subtitulo.dispatchEvent(new Event('change', { bubbles: true }));
            }, 100);
        }
        
        // Poblar menci√≥n de responsabilidad
        if (mencionResponsabilidad && campo.mencion_responsabilidad && !mencionResponsabilidad.value.trim()) {
            mencionResponsabilidad.value = campo.mencion_responsabilidad;
            console.log('‚úÖ Menci√≥n de responsabilidad actualizada:', campo.mencion_responsabilidad);
            setTimeout(() => {
                mencionResponsabilidad.dispatchEvent(new Event('change', { bubbles: true }));
            }, 100);
        }
    }

    poblarCampo264(campo) {
        console.log('üè¢ Poblar campo 264 (Publicaci√≥n) con:', campo);
        console.log('üîç DEBUG 264: Datos recibidos:', JSON.stringify(campo, null, 2));
        
        // Buscar el formset de 264
        const formset264 = document.querySelector('[data-formset-prefix*="producciones_publicaciones"]');
        console.log('üîç DEBUG 264: Buscando formset con selector [data-formset-prefix*="producciones_publicaciones"]');
        console.log('üîç DEBUG 264: Formset encontrado:', formset264);
        
        if (!formset264) {
            console.log('‚ùå No se encontr√≥ formset de 264');
            // Intentar otros selectores posibles
            const alternatives = [
                '[data-formset-prefix*="264"]',
                '.formset-container[data-formset-prefix*="produccion"]',
                '#formset-producciones_publicaciones'
            ];
            for (const alt of alternatives) {
                const altFormset = document.querySelector(alt);
                if (altFormset) {
                    console.log(`üîç DEBUG 264: Encontrado con selector alternativo: ${alt}`);
                    break;
                }
            }
            return;
        }
        
        console.log('‚úÖ Formset 264 encontrado:', formset264);
        
        // Buscar la primera fila del formset (o crear una si no existe)
        let primeraFila = formset264.querySelector('.formset-row:not(.empty-form)');
        console.log('üîç DEBUG 264: Primera fila encontrada:', primeraFila);
        
        if (!primeraFila) {
            console.log('üîÑ No hay filas en 264, agregando una...');
            const addBtn = formset264.querySelector('.add-row-btn, [data-formset-add]');
            console.log('üîç DEBUG 264: Bot√≥n agregar encontrado:', addBtn);
            
            if (addBtn) {
                addBtn.click();
                console.log('üîç DEBUG 264: Click en bot√≥n agregar');
                // Esperar un poco a que se cree la fila
                setTimeout(() => {
                    primeraFila = formset264.querySelector('.formset-row:not(.empty-form)');
                    console.log('üîç DEBUG 264: Despu√©s de timeout, fila encontrada:', primeraFila);
                    if (primeraFila) {
                        this.poblarCampos264Fila(primeraFila, campo);
                    }
                }, 300);
            } else {
                console.log('‚ùå No se encontr√≥ bot√≥n para agregar fila 264');
            }
        } else {
            this.poblarCampos264Fila(primeraFila, campo);
        }
    }
    
    poblarCampos264Fila(fila, campo) {
        console.log('üè¢ Poblando campos 264 en fila:', fila);
        console.log('üì¶ Datos recibidos:', JSON.stringify(campo, null, 2));
        
        // Buscar inputs de lugar (264$a)
        const lugarInput = fila.querySelector('input[name*="lugar_produccion_264"]');
        console.log('üîç DEBUG 264: Buscando input[name*="lugar_produccion_264"]');
        console.log('üîç DEBUG 264: Lugar input encontrado:', lugarInput);
        console.log('üîç DEBUG 264: Valor actual lugar:', lugarInput?.value);
        console.log('üîç DEBUG 264: Valor a asignar lugar:', campo.lugar_produccion_264);
        
        if (lugarInput && campo.lugar_produccion_264 && !lugarInput.value.trim()) {
            lugarInput.value = campo.lugar_produccion_264;
            console.log('‚úÖ Lugar de publicaci√≥n actualizado:', campo.lugar_produccion_264);
            setTimeout(() => {
                lugarInput.dispatchEvent(new Event('change', { bubbles: true }));
            }, 100);
        } else {
            console.log('üîç DEBUG 264: No se actualiz√≥ lugar - condiciones:', {
                lugarInput: !!lugarInput,
                tieneValor: !!campo.lugar_produccion_264,
                vacio: !lugarInput?.value?.trim()
            });
        }
        
        // Buscar inputs de entidad (264$b)
        const entidadInput = fila.querySelector('input[name*="entidad_produccion_264"]');
        console.log('üîç DEBUG 264: Buscando input[name*="entidad_produccion_264"]');
        console.log('üîç DEBUG 264: Entidad input encontrado:', entidadInput);
        console.log('üîç DEBUG 264: Valor actual entidad:', entidadInput?.value);
        console.log('üîç DEBUG 264: Valor a asignar entidad:', campo.entidad_produccion_264);
        
        if (entidadInput && campo.entidad_produccion_264 && !entidadInput.value.trim()) {
            entidadInput.value = campo.entidad_produccion_264;
            console.log('‚úÖ Editorial actualizada:', campo.entidad_produccion_264);
            setTimeout(() => {
                entidadInput.dispatchEvent(new Event('change', { bubbles: true }));
            }, 100);
        } else {
            console.log('üîç DEBUG 264: No se actualiz√≥ entidad - condiciones:', {
                entidadInput: !!entidadInput,
                tieneValor: !!campo.entidad_produccion_264,
                vacio: !entidadInput?.value?.trim()
            });
        }
        
        // Buscar inputs de fecha (264$c)
        const fechaInput = fila.querySelector('input[name*="fecha_produccion_264"]');
        console.log('üîç DEBUG 264: Buscando input[name*="fecha_produccion_264"]');
        console.log('üîç DEBUG 264: Fecha input encontrado:', fechaInput);
        console.log('üîç DEBUG 264: Valor actual fecha:', fechaInput?.value);
        console.log('üîç DEBUG 264: Valor a asignar fecha:', campo.fecha_produccion_264);
        
        if (fechaInput && campo.fecha_produccion_264 && !fechaInput.value.trim()) {
            fechaInput.value = campo.fecha_produccion_264;
            console.log('‚úÖ Fecha de publicaci√≥n actualizada:', campo.fecha_produccion_264);
            setTimeout(() => {
                fechaInput.dispatchEvent(new Event('change', { bubbles: true }));
            }, 100);
        } else {
            console.log('üîç DEBUG 264: No se actualiz√≥ fecha - condiciones:', {
                fechaInput: !!fechaInput,
                tieneValor: !!campo.fecha_produccion_264,
                vacio: !fechaInput?.value?.trim()
            });
        }
        
        console.log('üìç Inputs 264 procesados:');
        console.log('  - lugarInput:', lugarInput);
        console.log('  - entidadInput:', entidadInput);
        console.log('  - fechaInput:', fechaInput);
    }

    poblarCampo382(campo) {
        console.log('üéº Poblar campo 382 (Medium de interpretaci√≥n) con:', campo);
        console.log('üîç DEBUG 382: Datos recibidos:', JSON.stringify(campo, null, 2));
        
        // Buscar el formset de 382
        const formset382 = document.querySelector('[data-formset-prefix*="medios_interpretacion_382"]');
        console.log('üîç DEBUG 382: Buscando formset con selector [data-formset-prefix*="medios_interpretacion_382"]');
        console.log('üîç DEBUG 382: Formset encontrado:', formset382);
        
        if (!formset382) {
            console.log('‚ùå No se encontr√≥ formset de 382');
            // Intentar otros selectores posibles
            const alternatives = [
                '[data-formset-prefix*="382"]',
                '.formset-container[data-formset-prefix*="medios"]',
                '#formset-medios_interpretacion_382'
            ];
            for (const alt of alternatives) {
                const altFormset = document.querySelector(alt);
                if (altFormset) {
                    console.log(`üîç DEBUG 382: Encontrado con selector alternativo: ${alt}`);
                    break;
                }
            }
            return;
        }
        
        console.log('‚úÖ Formset 382 encontrado:', formset382);
        
        // Buscar la primera fila del formset (o crear una si no existe)
        let primeraFila = formset382.querySelector('.formset-row:not(.empty-form)');
        console.log('üîç DEBUG 382: Primera fila encontrada:', primeraFila);
        
        if (!primeraFila) {
            console.log('üîÑ No hay filas en 382, agregando una...');
            const addBtn = formset382.querySelector('.add-row-btn, [data-formset-add]');
            console.log('üîç DEBUG 382: Bot√≥n agregar encontrado:', addBtn);
            
            if (addBtn) {
                addBtn.click();
                console.log('üîç DEBUG 382: Click en bot√≥n agregar');
                // Esperar un poco a que se cree la fila
                setTimeout(() => {
                    primeraFila = formset382.querySelector('.formset-row:not(.empty-form)');
                    console.log('üîç DEBUG 382: Despu√©s de timeout, fila encontrada:', primeraFila);
                    if (primeraFila) {
                        this.poblarCampos382Fila(primeraFila, campo);
                    }
                }, 300);
            } else {
                console.log('‚ùå No se encontr√≥ bot√≥n para agregar fila 382');
            }
        } else {
            this.poblarCampos382Fila(primeraFila, campo);
        }
    }
    
    poblarCampos382Fila(fila, campo) {
        console.log('üéº Poblando campos 382 en fila:', fila);
        console.log('üì¶ Datos recibidos:', JSON.stringify(campo, null, 2));
        
        // Buscar input de solista (382$b)
        const solistaInput = fila.querySelector('input[name*="solista"]');
        console.log('üîç DEBUG 382: Buscando input[name*="solista"]');
        console.log('üîç DEBUG 382: Solista input encontrado:', solistaInput);
        console.log('üîç DEBUG 382: Valor actual solista:', solistaInput?.value);
        console.log('üîç DEBUG 382: Valor a asignar solista:', campo.solista);
        
        if (solistaInput && campo.solista !== undefined && !solistaInput.value.trim()) {
            solistaInput.value = campo.solista;
            console.log('‚úÖ Solista actualizado:', campo.solista);
            setTimeout(() => {
                solistaInput.dispatchEvent(new Event('change', { bubbles: true }));
            }, 100);
        } else {
            console.log('üîç DEBUG 382: No se actualiz√≥ solista - condiciones:', {
                solistaInput: !!solistaInput,
                tieneValor: campo.solista !== undefined,
                vacio: !solistaInput?.value?.trim()
            });
        }
        
        // Buscar select de medio (382$a)
        if (campo.medio_interpretacion_382) {
            const medioSelect = fila.querySelector('select[name*="medio_interpretacion_382"]');
            console.log('üîç DEBUG 382: Buscando select[name*="medio_interpretacion_382"]');
            console.log('üîç DEBUG 382: Medio select encontrado:', medioSelect);
            console.log('üîç DEBUG 382: Valor actual medio:', medioSelect?.value);
            console.log('üîç DEBUG 382: Valor a asignar medio:', campo.medio_interpretacion_382);
            
            if (medioSelect && !medioSelect.value) {
                medioSelect.value = campo.medio_interpretacion_382;
                console.log('‚úÖ Medium de interpretaci√≥n actualizado:', campo.medio_display);
                setTimeout(() => {
                    medioSelect.dispatchEvent(new Event('change', { bubbles: true }));
                }, 100);
            } else {
                console.log('üîç DEBUG 382: No se actualiz√≥ medio - condiciones:', {
                    medioSelect: !!medioSelect,
                    vacio: !medioSelect?.value?.trim()
                });
            }
        } else {
            console.log('üîç DEBUG 382: No hay medio_interpretacion_382 en los datos');
        }
        
        console.log('üìç Inputs 382 procesados:');
        console.log('  - solistaInput:', solistaInput);
        console.log('  - medioSelect:', fila.querySelector('select[name*="medio_interpretacion_382"]'));
    }

    poblarCampo545(campo) {
        console.log('üìù Poblar campo 545 (Nota biogr√°fica) con:', campo);
        console.log('üîç DEBUG 545: Datos recibidos:', JSON.stringify(campo, null, 2));
        
        // Buscar el campo REAL de nota biogr√°fica - EL FORMSET USA PREFIJO "biograficos_545"
        const notaBiografica = document.querySelector('textarea[name*="texto_biografico"][name*="biograficos_545"], input[name*="texto_biografico"][name*="biograficos_545"]');
        console.log('üîç DEBUG 545: Buscando textarea/input con name*="texto_biografico"[name*="biograficos_545"]');
        console.log('üîç DEBUG 545: Input encontrado:', notaBiografica);
        console.log('üîç DEBUG 545: Valor actual:', notaBiografica?.value);
        console.log('üîç DEBUG 545: Valor a asignar:', campo.datos_biograficos_545);
        
        // Buscar tambi√©n el campo URI
        const uriField = document.querySelector('input[name*="uri"][name*="biograficos_545"]');
        console.log('üîç DEBUG 545: Buscando input[name*="uri"][name*="biograficos_545"]');
        console.log('üîç DEBUG 545: URI field encontrado:', uriField);
        console.log('üîç DEBUG 545: Valor actual URI:', uriField?.value);
        console.log('üîç DEBUG 545: Valor a asignar URI:', campo.uri_545);
        
        // Intentar otros selectores posibles
        if (!notaBiografica || !uriField) {
            console.log('üîç DEBUG 545: Intentando selectores alternativos...');
            const alternatives = [
                'textarea[name*="texto_biografico"]',
                'input[name*="texto_biografico"]',
                'textarea[name*="biograficos_545"]',
                'input[name*="biograficos_545"]',
                'textarea[id*="texto_biografico"]',
                'input[id*="texto_biografico"]',
                '[name*="545"]',
                '[data-formset-prefix*="biograficos_545"] textarea',
                '[data-formset-prefix*="biograficos_545"] input'
            ];
            for (const alt of alternatives) {
                const altElement = document.querySelector(alt);
                if (altElement) {
                    console.log(`üîç DEBUG 545: Encontrado con selector alternativo: ${alt}`);
                    console.log(`üîç DEBUG 545: Elemento encontrado:`, altElement);
                    break;
                }
            }
        }
        
        // Poblar nota biogr√°fica
        if (notaBiografica && campo.datos_biograficos_545 && !notaBiografica.value.trim()) {
            notaBiografica.value = campo.datos_biograficos_545;
            console.log('‚úÖ Nota biogr√°fica actualizada:', campo.datos_biograficos_545);
            setTimeout(() => {
                notaBiografica.dispatchEvent(new Event('change', { bubbles: true }));
            }, 100);
        } else {
            console.log('üîç DEBUG 545: No se actualiz√≥ nota biogr√°fica - condiciones:', {
                notaBiografica: !!notaBiografica,
                tieneValor: !!campo.datos_biograficos_545,
                vacio: !notaBiografica?.value?.trim(),
                valorActual: notaBiografica?.value?.substring(0, 50)
            });
        }
        
        // Poblar URI
        if (uriField && campo.uri_545 && !uriField.value.trim()) {
            uriField.value = campo.uri_545;
            console.log('‚úÖ URI actualizada:', campo.uri_545);
            setTimeout(() => {
                uriField.dispatchEvent(new Event('change', { bubbles: true }));
            }, 100);
        } else {
            console.log('üîç DEBUG 545: No se actualiz√≥ URI - condiciones:', {
                uriField: !!uriField,
                tieneValor: !!campo.uri_545,
                vacio: !uriField?.value?.trim(),
                valorActual: uriField?.value?.substring(0, 50)
            });
        }
    }

    poblarCampo852(campo) {
        console.log('üìç Poblar campo 852 (Localizaci√≥n) con:', campo);
        console.log('üîç DEBUG 852: Datos recibidos:', JSON.stringify(campo, null, 2));
        
        // Buscar el formset de 852
        const formset852 = document.querySelector('[data-formset-prefix*="ubicaciones_852"]');
        console.log('üîç DEBUG 852: Buscando formset con selector [data-formset-prefix*="ubicaciones_852"]');
        console.log('üîç DEBUG 852: Formset encontrado:', formset852);
        
        if (!formset852) {
            console.log('‚ùå No se encontr√≥ formset de 852');
            return;
        }
        
        console.log('‚úÖ Formset 852 encontrado:', formset852);
        
        // Buscar la primera fila del formset (o crear una si no existe)
        let primeraFila = formset852.querySelector('.formset-row:not(.empty-form)');
        console.log('üîç DEBUG 852: Primera fila encontrada:', primeraFila);
        
        if (!primeraFila) {
            console.log('üîÑ No hay filas en 852, agregando una...');
            const addBtn = formset852.querySelector('.add-row-btn, [data-formset-add]');
            console.log('üîç DEBUG 852: Bot√≥n agregar encontrado:', addBtn);
            
            if (addBtn) {
                addBtn.click();
                setTimeout(() => {
                    primeraFila = formset852.querySelector('.formset-row:not(.empty-form)');
                    console.log('üîç DEBUG 852: Despu√©s de timeout, fila encontrada:', primeraFila);
                    if (primeraFila) {
                        this.poblarCampos852Fila(primeraFila, campo);
                    }
                }, 300);
            }
        } else {
            this.poblarCampos852Fila(primeraFila, campo);
        }
    }
    
    poblarCampos852Fila(fila, campo) {
        console.log('üìç Poblando campos 852 en fila:', fila);
        console.log('üì¶ Datos recibidos:', JSON.stringify(campo, null, 2));
        
        // Buscar inputs de localizaci√≥n con los nombres reales del formset
        const codigoInput = fila.querySelector('input[name*="codigo_o_nombre"]');
        const signaturaInput = fila.querySelector('input[name*="signatura_original"]');
        const estanteriaInput = fila.querySelector('input[name*="estanteria"]');
        
        console.log('üîç DEBUG 852: Inputs encontrados:');
        console.log('  - codigoInput:', codigoInput);
        console.log('  - signaturaInput:', signaturaInput);
        console.log('  - estanteriaInput:', estanteriaInput);
        
        // Poblar c√≥digo o nombre (852 $a)
        if (codigoInput && campo.codigo_o_nombre && !codigoInput.value.trim()) {
            codigoInput.value = campo.codigo_o_nombre;
            console.log('‚úÖ C√≥digo/Nombre actualizado:', campo.codigo_o_nombre);
            setTimeout(() => {
                codigoInput.dispatchEvent(new Event('change', { bubbles: true }));
            }, 100);
        } else {
            console.log('üîç DEBUG 852: No se actualiz√≥ c√≥digo - condiciones:', {
                codigoInput: !!codigoInput,
                tieneValor: !!campo.codigo_o_nombre,
                vacio: !codigoInput?.value?.trim()
            });
        }
        
        // Poblar signatura (852 $h)
        if (signaturaInput && campo.signatura_original && !signaturaInput.value.trim()) {
            signaturaInput.value = campo.signatura_original;
            console.log('‚úÖ Signatura actualizada:', campo.signatura_original);
            setTimeout(() => {
                signaturaInput.dispatchEvent(new Event('change', { bubbles: true }));
            }, 100);
        } else {
            console.log('üîç DEBUG 852: No se actualiz√≥ signatura - condiciones:', {
                signaturaInput: !!signaturaInput,
                tieneValor: !!campo.signatura_original,
                vacio: !signaturaInput?.value?.trim()
            });
        }
        
        // Poblar estanter√≠a (852 $c)
        if (estanteriaInput && campo.estanteria && !estanteriaInput.value.trim()) {
            estanteriaInput.value = campo.estanteria;
            console.log('‚úÖ Estanter√≠a actualizada:', campo.estanteria);
            setTimeout(() => {
                estanteriaInput.dispatchEvent(new Event('change', { bubbles: true }));
            }, 100);
        } else {
            console.log('üîç DEBUG 852: No se actualiz√≥ estanter√≠a - condiciones:', {
                estanteriaInput: !!estanteriaInput,
                tieneValor: !!campo.estanteria,
                vacio: !estanteriaInput?.value?.trim()
            });
        }
    }

    poblarCampo856(campo) {
        console.log('üåê Poblar campo 856 (Acceso electr√≥nico) con:', campo);
        console.log('üîç DEBUG 856: Datos recibidos:', JSON.stringify(campo, null, 2));
        
        // Buscar el formset de 856
        const formset856 = document.querySelector('[data-formset-prefix*="disponibles_856"]');
        console.log('üîç DEBUG 856: Buscando formset con selector [data-formset-prefix*="disponibles_856"]');
        console.log('üîç DEBUG 856: Formset encontrado:', formset856);
        
        if (!formset856) {
            console.log('‚ùå No se encontr√≥ formset de 856');
            return;
        }
        
        console.log('‚úÖ Formset 856 encontrado:', formset856);
        
        // Buscar la primera fila del formset (o crear una si no existe)
        let primeraFila = formset856.querySelector('.formset-row:not(.empty-form)');
        console.log('üîç DEBUG 856: Primera fila encontrada:', primeraFila);
        
        if (!primeraFila) {
            console.log('üîÑ No hay filas en 856, agregando una...');
            const addBtn = formset856.querySelector('.add-row-btn, [data-formset-add]');
            console.log('üîç DEBUG 856: Bot√≥n agregar encontrado:', addBtn);
            
            if (addBtn) {
                addBtn.click();
                setTimeout(() => {
                    primeraFila = formset856.querySelector('.formset-row:not(.empty-form)');
                    console.log('üîç DEBUG 856: Despu√©s de timeout, fila encontrada:', primeraFila);
                    if (primeraFila) {
                        this.poblarCampos856Fila(primeraFila, campo);
                    }
                }, 300);
            }
        } else {
            this.poblarCampos856Fila(primeraFila, campo);
        }
    }
    
    poblarCampos856Fila(fila, campo) {
        console.log('üåê Poblando campos 856 en fila:', fila);
        console.log('üì¶ Datos recibidos:', JSON.stringify(campo, null, 2));
        
        // Buscar inputs con los nombres reales del formset
        const urlInput = fila.querySelector('input[name*="url_disponible_856"]');
        const textoInput = fila.querySelector('input[name*="texto_disponible_856"]');
        
        console.log('üîç DEBUG 856: Inputs encontrados:');
        console.log('  - urlInput:', urlInput);
        console.log('  - textoInput:', textoInput);
        
        // Poblar URL (856 $u)
        if (urlInput && campo.url_disponible_856 && !urlInput.value.trim()) {
            urlInput.value = campo.url_disponible_856;
            console.log('‚úÖ URL actualizada:', campo.url_disponible_856);
            setTimeout(() => {
                urlInput.dispatchEvent(new Event('change', { bubbles: true }));
            }, 100);
        } else {
            console.log('üîç DEBUG 856: No se actualiz√≥ URL - condiciones:', {
                urlInput: !!urlInput,
                tieneValor: !!campo.url_disponible_856,
                vacio: !urlInput?.value?.trim()
            });
        }
        
        // Poblar texto de enlace (856 $y)
        if (textoInput && campo.texto_disponible_856 && !textoInput.value.trim()) {
            textoInput.value = campo.texto_disponible_856;
            console.log('‚úÖ Texto de enlace actualizado:', campo.texto_disponible_856);
            setTimeout(() => {
                textoInput.dispatchEvent(new Event('change', { bubbles: true }));
            }, 100);
        } else {
            console.log('üîç DEBUG 856: No se actualiz√≥ texto - condiciones:', {
                textoInput: !!textoInput,
                tieneValor: !!campo.texto_disponible_856,
                vacio: !textoInput?.value?.trim()
            });
        }
    }

    agregarFilaFormset(formset) {
        // Buscar bot√≥n de agregar fila del formset
        const addBtn = formset.querySelector('.add-row-btn, [data-formset-add]');
        if (addBtn) {
            addBtn.click();
        }
    }

    getCSRFToken() {
        const cookie = document.cookie.split('; ').find(row => row.startsWith('csrftoken='));
        return cookie ? cookie.split('=')[1] : '';
    }

    mostrarMensaje(mensaje, tipo) {
        // Usar sistema de notificaciones existente o crear toast simple
        const toast = document.createElement('div');
        toast.className = `alert alert-${tipo === 'error' ? 'danger' : tipo} position-fixed top-0 end-0 m-3`;
        toast.style.zIndex = '9999';
        toast.textContent = mensaje;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 5000);
    }
}

// Inicializar cuando el DOM est√© listo
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => new Autocompletado773());
} else {
    new Autocompletado773();
}

})(); // Cierre del IIFE
</script>
