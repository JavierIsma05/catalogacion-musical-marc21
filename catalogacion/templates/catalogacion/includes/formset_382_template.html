{% comment %}
Template especializado para el campo 382 - Medio de Interpretación.
Permite repetir el campo completo y también el subcampo $a (medios).
El botón de agregar campo completo está en el header del campo (campo-add-btn)
{% endcomment %}
{% load catalogacion_tags %}

<div class="formset-container" data-formset-prefix="{{ formset.prefix }}">
    <div style="display:none;">
        {% for hidden in formset.management_form %}
            {{ hidden }}
        {% endfor %}
    </div>
    
    <div class="formset-forms">
        {% get_medios_interpretacion as medios_list %}
        {% for form in formset %}
        <div class="formset-row {% if form.instance.pk %}existing-form{% endif %} mb-3">
            {% for hidden in form.hidden_fields %}
                {{ hidden }}
            {% endfor %}
            {% if formset.can_delete %}
                <div class="d-none">
                    {{ form.DELETE }}
                </div>
            {% endif %}
            
            <button type="button" class="delete-row-btn" title="Eliminar registro 382">
                <i class="bi bi-x-lg"></i>
            </button>
            
            {% if form.non_field_errors %}
            <div class="alert alert-danger mb-3">
                {{ form.non_field_errors }}
            </div>
            {% endif %}
            
            <div class="campo-grid">
                {# Subcampo $b - Solista (No Repetible) #}
                <div class="col-full">
                    <label class="form-label" for="{{ form.solista.id_for_label }}">{{ form.solista.label }}</label>
                    {{ form.solista }}
                    {% if form.solista.errors %}
                        <div class="invalid-feedback d-block">{{ form.solista.errors }}</div>
                    {% endif %}
                </div>
                
                {# Subcampo $a - Medios (Repetible) con botón + a la izquierda #}
                <div class="col-full">
                    <label class="form-label small">382 $a - Medio de interpretación</label>
                    <div class="subcampo-repetible-container medios-container" data-medios-container="{{ forloop.counter0 }}" data-borrador-container="medio_interpretacion_382" data-borrador-parent="{{ forloop.counter0 }}">
                        {% if form.instance.pk %}
                            {# Cargar medios existentes #}
                            {% for medio in form.instance.medios.all %}
                            <div class="subcampo-row medio-form-row">
                                {% if forloop.first %}
                                <button type="button" class="subcampo-add-btn add-medio-btn" data-medio-index="{{ forloop.parentloop.counter0 }}" data-borrador-add="medio_interpretacion_382" data-borrador-parent="{{ forloop.parentloop.counter0 }}" title="Agregar Medio">
                                    <i class="bi bi-plus"></i>
                                </button>
                                {% else %}
                                <div class="subcampo-placeholder"></div>
                                {% endif %}
                                <select class="form-select medio-select" name="medio_interpretacion_382_{{ forloop.parentloop.counter0 }}_{{ medio.pk }}">
                                    <option value="">Seleccione un medio...</option>
                                    {% for value, label in medios_list %}
                                        <option value="{{ value }}" {% if medio.medio == value %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="subcampo-delete-btn delete-medio-btn" title="Eliminar" {% if forloop.first and forloop.last %}style="visibility: hidden;"{% endif %}>
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                            {% empty %}
                            <div class="subcampo-row medio-form-row">
                                <button type="button" class="subcampo-add-btn add-medio-btn" data-medio-index="{{ forloop.counter0 }}" data-borrador-add="medio_interpretacion_382" data-borrador-parent="{{ forloop.counter0 }}" title="Agregar Medio">
                                    <i class="bi bi-plus"></i>
                                </button>
                                <select class="form-select medio-select" name="medio_interpretacion_382_{{ forloop.counter0 }}_0">
                                    <option value="">Seleccione un medio...</option>
                                    {% for value, label in medios_list %}
                                        <option value="{{ value }}">{{ label }}</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="subcampo-delete-btn delete-medio-btn" title="Eliminar" style="visibility: hidden;">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                            {% endfor %}
                        {% else %}
                        <div class="subcampo-row medio-form-row">
                            <button type="button" class="subcampo-add-btn add-medio-btn" data-medio-index="{{ forloop.counter0 }}" data-borrador-add="medio_interpretacion_382" data-borrador-parent="{{ forloop.counter0 }}" title="Agregar Medio">
                                <i class="bi bi-plus"></i>
                            </button>
                            <select class="form-select medio-select" name="medio_interpretacion_382_{{ forloop.counter0 }}_0">
                                <option value="">Seleccione un medio...</option>
                                {% for value, label in medios_list %}
                                    <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" class="subcampo-delete-btn delete-medio-btn" title="Eliminar" style="visibility: hidden;">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        
        <div class="formset-row empty-form mb-3" style="display:none;">
            <div style="display:none;">
                {% for hidden in formset.empty_form.hidden_fields %}
                    {{ hidden }}
                {% endfor %}
            </div>
            <button type="button" class="delete-row-btn" title="Eliminar registro 382">
                <i class="bi bi-x-lg"></i>
            </button>
            <div class="campo-grid">
                {# Subcampo $b - Solista (No Repetible) #}
                <div class="col-full">
                    <label class="form-label" for="{{ formset.empty_form.solista.id_for_label }}">{{ formset.empty_form.solista.label }}</label>
                    {{ formset.empty_form.solista }}
                </div>
                
                <div class="col-full">
                    <label class="form-label small">382 $a - Medio de interpretación</label>
                    <div class="subcampo-repetible-container medios-container" data-medios-container="__prefix__" data-borrador-container="medio_interpretacion_382" data-borrador-parent="__prefix__">
                        <div class="subcampo-row medio-form-row">
                            <button type="button" class="subcampo-add-btn add-medio-btn" data-medio-index="__prefix__" data-borrador-add="medio_interpretacion_382" data-borrador-parent="__prefix__" title="Agregar Medio">
                                <i class="bi bi-plus"></i>
                            </button>
                            <select class="form-select medio-select" name="medio_interpretacion_382___prefix___0">
                                <option value="">Seleccione un medio...</option>
                                {% for value, label in medios_list %}
                                    <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" class="subcampo-delete-btn delete-medio-btn" title="Eliminar" style="visibility: hidden;">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{# Almacenar opciones de medios en un elemento oculto para JavaScript #}
<div id="medios-options-data" style="display:none;" data-opciones='{% get_medios_interpretacion_json %}'></div>

{# Template global para medios (fuera del formset loop) #}
<div class="subcampo-row medio-form-row medio-template-382 d-none">
    <div class="subcampo-placeholder"></div>
    <select class="form-select medio-select">
        <option value="">Seleccione un medio...</option>
        {% for value, label in medios_list %}
            <option value="{{ value }}">{{ label }}</option>
        {% endfor %}
    </select>
    <button type="button" class="subcampo-delete-btn delete-medio-btn" title="Eliminar">
        <i class="bi bi-x-lg"></i>
    </button>
</div>

<script>
/**
 * Script para subcampos repetibles del campo 382 (Medios de interpretación)
 * - Maneja subcampos repetibles ($a)
 * - Copia automáticamente el valor seleccionado en $a hacia $b (solista)
 *   * Actualiza si $b fue autocompletado
 *   * NO sobrescribe si el usuario lo editó manualmente
 * Usa selects nativos del navegador (sin Select2)
 */
(function() {

    function init382Subcampos() {
        const prefix = '{{ formset.prefix }}';
        const container = document.querySelector(`[data-formset-prefix="${prefix}"]`);
        if (!container || container.dataset.subcampos382Initialized) return;
        container.dataset.subcampos382Initialized = 'true';

        // Obtener las opciones de medios desde el elemento oculto
        const opcionesData = document.getElementById('medios-options-data');
        let opcionesMedio = [];
        if (opcionesData && opcionesData.dataset.opciones) {
            try {
                opcionesMedio = JSON.parse(opcionesData.dataset.opciones);
            } catch (e) {
                console.error('Error parsing medios options:', e);
            }
        }

        // Construir HTML de opciones
        let opcionesHTML = '<option value="">Seleccione un medio...</option>';
        opcionesMedio.forEach(function(item) {
            opcionesHTML += `<option value="${item.codigo}">${item.nombre}</option>`;
        });

        // Actualizar visibilidad de botones eliminar
        function updateDeleteButtonsVisibility(subcampoContainer) {
            const rows = subcampoContainer.querySelectorAll('.subcampo-row:not(.d-none)');
            rows.forEach((row) => {
                const deleteBtn = row.querySelector('.subcampo-delete-btn');
                if (deleteBtn) {
                    deleteBtn.style.visibility = row.querySelector('.subcampo-add-btn')
                        ? 'hidden'
                        : 'visible';
                }
            });
        }

        // Marcar como "manual" cuando el usuario edita solista
        container.addEventListener('input', function(e) {
            const solistaInput = e.target.closest('input[name$="solista"]');
            if (!solistaInput) return;

            // Si el usuario borra todo, permitimos volver a autocompletar
            if (!solistaInput.value.trim()) {
                solistaInput.dataset.userEdited = 'false';
                solistaInput.dataset.autoFilled = 'false';
                solistaInput.dataset.lastAuto = '';
                return;
            }

            // Si está escribiendo y el valor NO coincide con el último autollenado => manual
            const lastAuto = solistaInput.dataset.lastAuto || '';
            if (solistaInput.value !== lastAuto) {
                solistaInput.dataset.userEdited = 'true';
            }
        });

        // ============================
        // EVENTOS CLICK (+ / eliminar)
        // ============================
        container.addEventListener('click', function(e) {

            // Agregar medio
            const addMedioBtn = e.target.closest('.add-medio-btn');
            if (addMedioBtn) {
                const index = addMedioBtn.getAttribute('data-medio-index');
                const target = container.querySelector(`[data-medios-container="${index}"]`);
                if (target) {
                    const nuevo = document.createElement('div');
                    nuevo.className = 'subcampo-row medio-form-row';
                    nuevo.innerHTML = `
                        <div class="subcampo-placeholder"></div>
                        <select class="form-select medio-select"
                                name="medio_interpretacion_382_${index}_${Date.now()}">
                            ${opcionesHTML}
                        </select>
                        <button type="button"
                                class="subcampo-delete-btn delete-medio-btn"
                                title="Eliminar">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    `;
                    target.appendChild(nuevo);
                    updateDeleteButtonsVisibility(target);
                }
                return;
            }

            // Eliminar medio
            const deleteBtn = e.target.closest('.delete-medio-btn');
            if (deleteBtn) {
                const row = deleteBtn.closest('.medio-form-row');
                if (row && !row.querySelector('.subcampo-add-btn')) {
                    const subcampoContainer = row.closest('.subcampo-repetible-container');
                    row.remove();
                    updateDeleteButtonsVisibility(subcampoContainer);
                }
                return;
            }
        });

        // ==========================================
        // EVENTO CHANGE → copiar $a → $b (solista)
        // ==========================================
        container.addEventListener('change', function(e) {
            const medioSelect = e.target.closest('.medio-select');
            if (!medioSelect) return;

            const medioValue = medioSelect.value || '';

            // Fila 382 correspondiente
            const formRow = medioSelect.closest('.formset-row');
            if (!formRow) return;

            const solistaInput = formRow.querySelector('input[name$="solista"]');
            if (!solistaInput) return;

            const userEdited = (solistaInput.dataset.userEdited === 'true');
            const autoFilled = (solistaInput.dataset.autoFilled === 'true');

            // Regla:
            // - Si el usuario NO lo ha editado manualmente:
            //     * si estaba vacío => autollenar
            //     * si estaba autollenado => actualizar al nuevo valor
            // - Si el usuario SÍ lo editó => no tocar
            if (!userEdited) {
                if (medioValue) {
                    solistaInput.value = medioValue;
                    solistaInput.dataset.autoFilled = 'true';
                    solistaInput.dataset.lastAuto = medioValue;
                    solistaInput.dataset.userEdited = 'false';
                } else {
                    // Si el select vuelve a vacío y el campo era auto, lo limpiamos
                    if (autoFilled) {
                        solistaInput.value = '';
                        solistaInput.dataset.autoFilled = 'false';
                        solistaInput.dataset.lastAuto = '';
                        solistaInput.dataset.userEdited = 'false';
                    }
                }
            }
        });

        // Inicializar visibilidad de botones
        container
            .querySelectorAll('.subcampo-repetible-container')
            .forEach(updateDeleteButtonsVisibility);
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init382Subcampos);
    } else {
        setTimeout(init382Subcampos, 50);
    }

})();
</script>
