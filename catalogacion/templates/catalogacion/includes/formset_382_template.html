{% load catalogacion_tags %}
{% comment %}
Campo 382 - Medio de interpretación (R)
Formset anidado de dos niveles con Django FormSets
{% endcomment %}

<div class="formset-container" data-formset-prefix="{{ formset.prefix }}">
    <!-- Formulario de gestión del formset principal -->
    <div style="display:none;">
        {% for hidden in formset.management_form %}
            {{ hidden }}
        {% endfor %}
    </div>

    <div class="formset-forms">
        {% for form in formset %}
        <div class="formset-row mb-4 p-3 border rounded" data-form-index="{{ forloop.counter0 }}">
            <!-- Campos ocultos del formulario principal -->
            {% for hidden in form.hidden_fields %}
                {{ hidden }}
            {% endfor %}

            <!-- Campo DELETE (oculto) -->
            {% if formset.can_delete %}
                <div class="d-none">
                    {{ form.DELETE }}
                </div>
            {% endif %}

            <!-- Botón para eliminar todo el 382 -->
            <button type="button" class="btn btn-sm btn-danger delete-382-btn mb-2" title="Eliminar campo 382">
                ✖ Eliminar 382
            </button>

            <div class="campo-grid mt-3">
                <!-- Subcampo $b: Solista -->
                <div class="col-full mb-3">
                    <label class="form-label fw-bold">382 $b — Solista</label>
                    {{ form.solista }}
                    {% if form.solista.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.solista.errors.0 }}
                        </div>
                    {% endif %}
                </div>

                <!-- Subcampo $a: Medios de interpretación (anidado) -->
                <div class="col-full">
                    <label class="form-label fw-bold">382 $a — Medios de interpretación</label>
                    
                    <!-- Formset anidado para medios -->
                    <div class="nested-formset-container" data-parent-form="{{ forloop.counter0 }}" data-formset-prefix="medios_interpretacion382_set">
                        {% if medios_formsets %}
                            {% with medios_formset=medios_formsets|get_item:forloop.counter0 %}
                                <div style="display:none;">
                                    {% for hidden in medios_formset.management_form %}
                                        {{ hidden }}
                                    {% endfor %}
                                </div>

                                <!-- Filas de medios existentes -->
                                <div class="medios-rows-container">
                                    {% for medio_form in medios_formset %}
                                        <div class="subcampo-row mb-2 d-flex gap-2 align-items-center" data-medio-index="{{ forloop.counter0 }}">
                                            <!-- Campos ocultos -->
                                            {% for hidden in medio_form.hidden_fields %}
                                                {{ hidden }}
                                            {% endfor %}

                                            <!-- Select de medio -->
                                            <div class="flex-grow-1">
                                                {{ medio_form.medio }}
                                                {% if medio_form.medio.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ medio_form.medio.errors.0 }}
                                                    </div>
                                                {% endif %}
                                            </div>

                                            <!-- Botón agregar (solo en primera fila) -->
                                            {% if forloop.first %}
                                                <button type="button" class="btn btn-sm btn-success add-medio-btn" title="Agregar otro medio">
                                                    ➕
                                                </button>
                                            {% else %}
                                                <button type="button" class="btn btn-sm btn-success add-medio-btn d-none" title="Agregar otro medio">
                                                    ➕
                                                </button>
                                            {% endif %}

                                            <!-- Botón eliminar -->
                                            {% if forloop.first %}
                                                <button type="button" class="btn btn-sm btn-danger delete-medio-btn d-none" title="Eliminar medio">
                                                    ✖
                                                </button>
                                            {% else %}
                                                <button type="button" class="btn btn-sm btn-danger delete-medio-btn" title="Eliminar medio">
                                                    ✖
                                                </button>
                                            {% endif %}

                                            <!-- Checkbox DELETE (oculto) -->
                                            {% if medios_formset.can_delete %}
                                                <div class="d-none">
                                                    {{ medio_form.DELETE }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endwith %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
(function() {
    const MEDIOS_CONTAINER_CLASS = 'medios-rows-container';
    const SUBCAMPO_ROW_CLASS = 'subcampo-row';
    const NESTED_FORMSET_CLASS = 'nested-formset-container';

    // Crear plantilla HTML para nuevas filas de medios
    function createMedioTemplate(parentForm, medioIndex) {
        const container = document.querySelector(
            `.${NESTED_FORMSET_CLASS}[data-parent-form="${parentForm}"]`
        );
        
        if (!container) return '';

        const select = container.querySelector('select[name*="-medio"]');
        if (!select) return '';

        // Obtener el nombre del select existente para sacar el prefijo
        const existingName = select.getAttribute('name');
        const match = existingName.match(/^(.*?)-\d+-medio$/);
        const prefix = match ? match[1] : 'medios_interpretacion382_set';

        const selectName = `${prefix}-${medioIndex}-medio`;
        const deleteCheckboxName = `${prefix}-${medioIndex}-DELETE`;
        const idInputName = `${prefix}-${medioIndex}-id`;
        const parentInputName = `${prefix}-${medioIndex}-medio_interpretacion`;

        const selectOptions = select.innerHTML;

        return `
            <div class="${SUBCAMPO_ROW_CLASS} mb-2 d-flex gap-2 align-items-center" data-medio-index="${medioIndex}">
                <input type="hidden" name="${idInputName}">
                <input type="hidden" name="${parentInputName}">
                
                <div class="flex-grow-1">
                    <select name="${selectName}" class="form-select">
                        ${selectOptions}
                    </select>
                </div>

                <button type="button" class="btn btn-sm btn-success add-medio-btn" title="Agregar otro medio">
                    ➕
                </button>

                <button type="button" class="btn btn-sm btn-danger delete-medio-btn" title="Eliminar medio">
                    ✖
                </button>

<script>
/**
 * Script para subcampos repetibles del campo 382 (Medios de interpretación)
 * Usa selects nativos del navegador (sin Select2)
 */
(function() {
    function init382Subcampos() {
        const prefix = '{{ formset.prefix }}';
        const container = document.querySelector(`[data-formset-prefix="${prefix}"]`);
        if (!container || container.dataset.subcampos382Initialized) return;
        container.dataset.subcampos382Initialized = 'true';
        
        visibleRows.forEach((row, index) => {
            const addBtn = row.querySelector('.add-medio-btn');
            const delBtn = row.querySelector('.delete-medio-btn');

            if (index === 0) {
                addBtn?.classList.remove('d-none');
                delBtn?.classList.add('d-none');
            } else {
                addBtn?.classList.add('d-none');
                delBtn?.classList.remove('d-none');
            }
        });
    }

    // Agregar nuevo medio
    function addMedio(btn) {
        const row = btn.closest(`.${SUBCAMPO_ROW_CLASS}`);
        const container = row.closest(`.${MEDIOS_CONTAINER_CLASS}`);
        const parentForm = container.closest(`.${NESTED_FORMSET_CLASS}`).getAttribute('data-parent-form');
        
        // Función para actualizar visibilidad de botones de eliminar
        function updateDeleteButtonsVisibility(subcampoContainer) {
            const rows = subcampoContainer.querySelectorAll('.subcampo-row:not(.d-none)');
            rows.forEach((row) => {
                const deleteBtn = row.querySelector('.subcampo-delete-btn');
                if (deleteBtn) {
                    if (row.querySelector('.subcampo-add-btn')) {
                        deleteBtn.style.visibility = 'hidden';
                    } else {
                        deleteBtn.style.visibility = 'visible';
                    }
                }
            });
        }
        
        container.addEventListener('click', function(e) {
            // Agregar Medio
            const addMedioBtn = e.target.closest('.add-medio-btn');
            if (addMedioBtn) {
                const index = addMedioBtn.getAttribute('data-medio-index');
                const target = container.querySelector(`[data-medios-container="${index}"]`);
                if (target) {
                    const nuevo = document.createElement('div');
                    nuevo.className = 'subcampo-row medio-form-row';
                    nuevo.innerHTML = `
                        <div class="subcampo-placeholder"></div>
                        <select class="form-select medio-select" name="medio_interpretacion_382_${index}_${Date.now()}">
                            ${opcionesHTML}
                        </select>
                        <button type="button" class="subcampo-delete-btn delete-medio-btn" title="Eliminar">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    `;
                    target.appendChild(nuevo);
                    updateDeleteButtonsVisibility(target);
                }
                return;
            }
            
            // Eliminar Medio (solo si NO tiene el botón +)
            if (e.target.closest('.delete-medio-btn')) {
                const row = e.target.closest('.medio-form-row');
                if (row && !row.classList.contains('medio-template-382') && !row.querySelector('.subcampo-add-btn')) {
                    const subcampoContainer = row.closest('.subcampo-repetible-container');
                    row.remove();
                    updateDeleteButtonsVisibility(subcampoContainer);
                }
                return;
            }
        });
        
        // Inicializar visibilidad de todos los contenedores de subcampos
        container.querySelectorAll('.subcampo-repetible-container').forEach(updateDeleteButtonsVisibility);
    }
    
    // Ejecutar cuando el DOM esté listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init382Subcampos);
    } else {
        setTimeout(init382Subcampos, 50);
    }
})();
</script>
