{% load catalogacion_tags %}
{% comment %}
Campo 382 - Medio de interpretación (R)
Formset anidado de dos niveles con Django FormSets
{% endcomment %}

<div class="formset-container" data-formset-prefix="{{ formset.prefix }}">
    <!-- Formulario de gestión del formset principal -->
    <div style="display:none;">
        {% for hidden in formset.management_form %}
            {{ hidden }}
        {% endfor %}
    </div>

    <div class="formset-forms">
        {% for form in formset %}
        <div class="formset-row mb-4 p-3 border rounded" data-form-index="{{ forloop.counter0 }}">
            <!-- Campos ocultos del formulario principal -->
            {% for hidden in form.hidden_fields %}
                {{ hidden }}
            {% endfor %}

            <!-- Campo DELETE (oculto) -->
            {% if formset.can_delete %}
                <div class="d-none">
                    {{ form.DELETE }}
                </div>
            {% endif %}

            <!-- Botón para eliminar todo el 382 -->
            <button type="button" class="btn btn-sm btn-danger delete-382-btn mb-2" title="Eliminar campo 382">
                ✖ Eliminar 382
            </button>

            <div class="campo-grid mt-3">
                <!-- Subcampo $b: Solista -->
                <div class="col-full mb-3">
                    <label class="form-label fw-bold">382 $b — Solista</label>
                    {{ form.solista }}
                    {% if form.solista.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.solista.errors.0 }}
                        </div>
                    {% endif %}
                </div>

                <!-- Subcampo $a: Medios de interpretación (anidado) -->
                <div class="col-full">
                    <label class="form-label fw-bold">382 $a — Medios de interpretación</label>
                    
                    <!-- Formset anidado para medios -->
                    <div class="nested-formset-container" data-parent-form="{{ forloop.counter0 }}" data-formset-prefix="medios_interpretacion382_set">
                        {% if medios_formsets %}
                            {% with medios_formset=medios_formsets|get_item:forloop.counter0 %}
                                <div style="display:none;">
                                    {% for hidden in medios_formset.management_form %}
                                        {{ hidden }}
                                    {% endfor %}
                                </div>

                                <!-- Filas de medios existentes -->
                                <div class="medios-rows-container">
                                    {% for medio_form in medios_formset %}
                                        <div class="subcampo-row mb-2 d-flex gap-2 align-items-center" data-medio-index="{{ forloop.counter0 }}">
                                            <!-- Campos ocultos -->
                                            {% for hidden in medio_form.hidden_fields %}
                                                {{ hidden }}
                                            {% endfor %}

                                            <!-- Select de medio -->
                                            <div class="flex-grow-1">
                                                {{ medio_form.medio }}
                                                {% if medio_form.medio.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ medio_form.medio.errors.0 }}
                                                    </div>
                                                {% endif %}
                                            </div>

                                            <!-- Botón agregar (solo en primera fila) -->
                                            {% if forloop.first %}
                                                <button type="button" class="btn btn-sm btn-success add-medio-btn" title="Agregar otro medio">
                                                    ➕
                                                </button>
                                            {% else %}
                                                <button type="button" class="btn btn-sm btn-success add-medio-btn d-none" title="Agregar otro medio">
                                                    ➕
                                                </button>
                                            {% endif %}

                                            <!-- Botón eliminar -->
                                            {% if forloop.first %}
                                                <button type="button" class="btn btn-sm btn-danger delete-medio-btn d-none" title="Eliminar medio">
                                                    ✖
                                                </button>
                                            {% else %}
                                                <button type="button" class="btn btn-sm btn-danger delete-medio-btn" title="Eliminar medio">
                                                    ✖
                                                </button>
                                            {% endif %}

                                            <!-- Checkbox DELETE (oculto) -->
                                            {% if medios_formset.can_delete %}
                                                <div class="d-none">
                                                    {{ medio_form.DELETE }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endwith %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
(function() {
    const MEDIOS_CONTAINER_CLASS = 'medios-rows-container';
    const SUBCAMPO_ROW_CLASS = 'subcampo-row';
    const NESTED_FORMSET_CLASS = 'nested-formset-container';

    // Crear plantilla HTML para nuevas filas de medios
    function createMedioTemplate(parentForm, medioIndex) {
        const container = document.querySelector(
            `.${NESTED_FORMSET_CLASS}[data-parent-form="${parentForm}"]`
        );
        
        if (!container) return '';

        const select = container.querySelector('select[name*="-medio"]');
        if (!select) return '';

        // Obtener el nombre del select existente para sacar el prefijo
        const existingName = select.getAttribute('name');
        const match = existingName.match(/^(.*?)-\d+-medio$/);
        const prefix = match ? match[1] : 'medios_interpretacion382_set';

        const selectName = `${prefix}-${medioIndex}-medio`;
        const deleteCheckboxName = `${prefix}-${medioIndex}-DELETE`;
        const idInputName = `${prefix}-${medioIndex}-id`;
        const parentInputName = `${prefix}-${medioIndex}-medio_interpretacion`;

        const selectOptions = select.innerHTML;

        return `
            <div class="${SUBCAMPO_ROW_CLASS} mb-2 d-flex gap-2 align-items-center" data-medio-index="${medioIndex}">
                <input type="hidden" name="${idInputName}">
                <input type="hidden" name="${parentInputName}">
                
                <div class="flex-grow-1">
                    <select name="${selectName}" class="form-select">
                        ${selectOptions}
                    </select>
                </div>

                <button type="button" class="btn btn-sm btn-success add-medio-btn" title="Agregar otro medio">
                    ➕
                </button>

                <button type="button" class="btn btn-sm btn-danger delete-medio-btn" title="Eliminar medio">
                    ✖
                </button>

                <input type="hidden" name="${deleteCheckboxName}" class="delete-checkbox" value="off">
            </div>
        `;
    }

    // Actualizar visibilidad de botones
    function updateMedioButtons(container) {
        const rows = container.querySelectorAll(`.${SUBCAMPO_ROW_CLASS}`);
        const visibleRows = Array.from(rows).filter(r => r.style.display !== 'none');
        
        visibleRows.forEach((row, index) => {
            const addBtn = row.querySelector('.add-medio-btn');
            const delBtn = row.querySelector('.delete-medio-btn');

            if (index === 0) {
                addBtn?.classList.remove('d-none');
                delBtn?.classList.add('d-none');
            } else {
                addBtn?.classList.add('d-none');
                delBtn?.classList.remove('d-none');
            }
        });
    }

    // Agregar nuevo medio
    function addMedio(btn) {
        const row = btn.closest(`.${SUBCAMPO_ROW_CLASS}`);
        const container = row.closest(`.${MEDIOS_CONTAINER_CLASS}`);
        const parentForm = container.closest(`.${NESTED_FORMSET_CLASS}`).getAttribute('data-parent-form');
        
        const currentRows = container.querySelectorAll(`.${SUBCAMPO_ROW_CLASS}`);
        const newIndex = currentRows.length;

        const template = createMedioTemplate(parentForm, newIndex);
        container.insertAdjacentHTML('beforeend', template);
        updateMedioButtons(container);
    }

    // Eliminar medio
    function deleteMedio(btn) {
        const row = btn.closest(`.${SUBCAMPO_ROW_CLASS}`);
        const container = row.closest(`.${MEDIOS_CONTAINER_CLASS}`);
        
        // Marcar como eliminado
        const deleteCheckbox = row.querySelector('.delete-checkbox');
        if (deleteCheckbox) {
            deleteCheckbox.value = 'on';
            row.style.display = 'none';
        } else {
            row.remove();
        }
        
        updateMedioButtons(container);
    }

    // Eliminar 382 completo
    function delete382(btn) {
        const row = btn.closest('.formset-row');
        const deleteCheckbox = row.querySelector('[name*="DELETE"]');
        
        if (deleteCheckbox) {
            deleteCheckbox.checked = true;
            row.style.display = 'none';
        } else {
            row.remove();
        }
    }

    // Event listeners
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('add-medio-btn')) {
            e.preventDefault();
            addMedio(e.target);
        }

        if (e.target.classList.contains('delete-medio-btn')) {
            e.preventDefault();
            deleteMedio(e.target);
        }

        if (e.target.classList.contains('delete-382-btn')) {
            e.preventDefault();
            delete382(e.target);
        }
    });

    // Inicializar botones al cargar
    document.querySelectorAll(`.${MEDIOS_CONTAINER_CLASS}`).forEach(container => {
        updateMedioButtons(container);
    });
})();
</script>
