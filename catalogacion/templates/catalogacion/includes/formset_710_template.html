<div class="formset-container" data-formset-prefix="{{ formset.prefix }}">
    <div style="display:none;">
        {% for hidden in formset.management_form %}
        {{ hidden }}
        {% endfor %}
    </div>

    <div class="formset-forms">

        {% for form in formset %}
        <div class="formset-row {% if form.instance.pk %}existing-form{% endif %} mb-3 position-relative">

            {% if formset.can_delete %}
            <div class="d-none">{{ form.DELETE }}</div>
            {% endif %}

            <!-- Bot√≥n delete -->
            <button type="button" class="delete-row-btn btn btn-sm btn-outline-danger position-absolute"
                style="right: 8px; top: 8px;" title="Eliminar 710">
                <i class="bi bi-x-lg"></i>
            </button>

            <div class="campo-grid">

                <!-- AUTOCOMPLETE 710 $a -->
                <div class="col-full">
                    {{ form.entidad }} {# hidden FK #}
                    <label class="form-label" for="{{ form.entidad_texto.id_for_label }}">
                        710 $a ‚Äì Entidad relacionada
                    </label>

                    <div class="autocomplete-wrapper">
                        <input type="text" class="form-control entidad-autocomplete"
                            id="{{ form.entidad_texto.id_for_label }}" name="{{ form.entidad_texto.name }}"
                            value="{{ form.entidad_texto.value|default:'' }}" placeholder="Escriba para buscar o crear‚Ä¶"
                            autocomplete="off">

                        <div class="autocomplete-suggestions entidad710-suggestions"></div>

                        {{ form.entidad }} {# hidden ID #}


                        <div class="autocomplete-suggestions entidad710-suggestions"></div>
                    </div>

                    <div class="form-text">
                        Escriba para buscar una entidad existente o crear una nueva.
                    </div>
                </div>

                <!-- 710 $e - Funci√≥n institucional (Repetible) -->
                <div class="col-full">
                    <label class="form-label small">710 $e ‚Äì Funci√≥n institucional</label>
                    
                    <div class="funciones-710e-container" data-funciones-710e-index="{{ forloop.counter0 }}">
                        
                        {% if form.instance.pk %}
                            {% for funcion in form.instance.funciones_institucionales.all %}
                            <div class="funcion-710e-row {% if forloop.first %}primera-fila{% endif %} mb-2">
                                <div class="input-group">
                                    
                                    {% if forloop.first %}
                                    <button type="button"
                                            class="subcampo-add-btn add-funcion-710e-btn btn btn-outline-primary"
                                            title="Agregar funci√≥n">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                    {% else %}
                                    <div class="subcampo-placeholder" aria-hidden="true"></div>
                                    {% endif %}

                                    <select class="form-select"
                                            name="funcion_institucional_710_{{ forloop.parentloop.counter0 }}_{{ funcion.pk }}">
                                        <option value="">Seleccione una funci√≥n...</option>
                                        {% for value, label in form.funcion.field.choices %}
                                        <option value="{{ value }}" 
                                                {% if funcion.funcion == value %}selected{% endif %}>
                                            {{ label }}
                                        </option>
                                        {% endfor %}
                                    </select>

                                    <button type="button"
                                            class="subcampo-delete-btn delete-funcion-710e-btn btn btn-outline-danger"
                                            title="Eliminar"
                                            {% if forloop.first and forloop.last %}style="visibility:hidden;"{% endif %}>
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="funcion-710e-row primera-fila mb-2">
                                <div class="input-group">
                                    <button type="button"
                                            class="subcampo-add-btn add-funcion-710e-btn btn btn-outline-primary"
                                            title="Agregar funci√≥n">
                                        <i class="bi bi-plus"></i>
                                    </button>

                                    <select class="form-select"
                                            name="funcion_institucional_710_{{ forloop.counter0 }}_0">
                                        <option value="">Seleccione una funci√≥n...</option>
                                        {% for value, label in form.funcion.field.choices %}
                                        <option value="{{ value }}">{{ label }}</option>
                                        {% endfor %}
                                    </select>

                                    <button type="button"
                                            class="subcampo-delete-btn delete-funcion-710e-btn btn btn-outline-danger"
                                            title="Eliminar"
                                            style="visibility:hidden;">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                            </div>
                        {% endif %}
                        
                    </div>
                </div>

            </div>
        </div>
        {% endfor %}

        <!-- Empty Form -->
        <div class="formset-row empty-form mb-3 d-none position-relative">

            <button type="button" class="delete-row-btn btn btn-sm btn-outline-danger position-absolute"
                style="right: 8px; top: 8px;" title="Eliminar 710">
                <i class="bi bi-x-lg"></i>
            </button>

            <div class="campo-grid">

                <div class="col-full">
                    <input type="hidden" name="__prefix__-entidad">
                    <label class="form-label">710 $a ‚Äì Entidad relacionada</label>

                    <div class="autocomplete-wrapper">
                        <input type="text" class="form-control entidad-autocomplete" name="__prefix__-entidad_texto"
                            placeholder="Escriba para buscar o crear‚Ä¶" autocomplete="off">

                       
                        <div class="autocomplete-suggestions entidad710-suggestions"></div>
                    </div>
                </div>

                <div class="col-full">
                    <label class="form-label small">710 $e ‚Äì Funci√≥n institucional</label>
                    
                    <div class="funciones-710e-container" data-funciones-710e-index="__prefix__">
                        
                        <div class="funcion-710e-row primera-fila mb-2">
                            <div class="input-group">
                                <button type="button"
                                        class="subcampo-add-btn add-funcion-710e-btn btn btn-outline-primary"
                                        title="Agregar funci√≥n">
                                    <i class="bi bi-plus"></i>
                                </button>

                                <select class="form-select"
                                        name="funcion_institucional_710___prefix___0">
                                    <option value="">Seleccione una funci√≥n...</option>
                                    {% for value, label in formset.empty_form.fields.funcion.choices %}
                                    <option value="{{ value }}">{{ label }}</option>
                                    {% endfor %}
                                </select>

                                <button type="button"
                                        class="subcampo-delete-btn delete-funcion-710e-btn btn btn-outline-danger"
                                        title="Eliminar"
                                        style="visibility:hidden;">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        </div>
                        
                    </div>
                </div>

            </div>
        </div>

    </div>
</div>
<script>
    document.addEventListener("input", function (e) {
        const input = e.target.closest(".entidad-autocomplete");
        if (!input) return;

        const row = input.closest(".formset-row");
        const hiddenId = row.querySelector('input[type="hidden"]');
        const box = row.querySelector(".entidad710-suggestions");

        const query = input.value.trim();
        hiddenId.value = "";

        if (query.length < 2) {
            box.innerHTML = "";
            box.classList.remove("show");
            return;
        }

        fetch(`/catalogacion/api/autocompletar/entidad/?q=${encodeURIComponent(query)}`)
            .then(r => r.json())
            .then(data => {
                box.innerHTML = "";

                data.results.forEach(ent => {
                    const div = document.createElement("div");
                    div.className = "autocomplete-item";
                    div.innerHTML = ent.text;
                    div.addEventListener("click", () => {
                        input.value = ent.nombre_entidad || ent.text;
                        hiddenId.value = ent.id;
                        box.innerHTML = "";
                        box.classList.remove("show");
                    });
                    box.appendChild(div);
                });

                const nuevo = document.createElement("div");
                nuevo.className = "autocomplete-item new-item";
                nuevo.innerHTML = `<strong>+ Crear nuevo:</strong> "${query}"`;
                nuevo.addEventListener("click", () => {
                    input.value = query;
                    hiddenId.value = "";
                    box.innerHTML = "";
                    box.classList.remove("show");
                });
                box.appendChild(nuevo);

                box.classList.add("show");
            });
    });

    document.addEventListener("click", function (e) {
        document.querySelectorAll(".entidad710-suggestions.show")
            .forEach(box => {
                if (!box.contains(e.target)) box.classList.remove("show");
            });
    });

    // =====================================================
    // MANEJO DE FUNCIONES 710 $e REPETIBLES (MANTENIENDO L√ìGICA EXISTENTE)
    // =====================================================
    (function() {
        const container = document.querySelector('.formset-container[data-formset-prefix="{{ formset.prefix }}"]');
        if (!container) return;
        
        console.log('üöÄ Inicializando funciones 710 $e repetibles');
        
        function updateFuncionesLayout(container) {
            const visibleRows = Array.from(
                container.querySelectorAll('.funcion-710e-row:not(.empty-form)')
            ).filter(r => r.style.display !== 'none');

            // Asegurar que solo la primera visible tenga la clase
            visibleRows.forEach(r => r.classList.remove('primera-fila'));
            if (visibleRows[0]) visibleRows[0].classList.add('primera-fila');

            visibleRows.forEach((row, index) => {
                const isFirst = index === 0;
                const addBtn = row.querySelector('.add-funcion-710e-btn');
                const placeholder = row.querySelector('.subcampo-placeholder');
                const deleteBtn = row.querySelector('.delete-funcion-710e-btn');

                // Izquierda: primera => [+]; resto => placeholder
                if (isFirst) {
                    if (!addBtn) {
                        const newBtn = document.createElement('button');
                        newBtn.type = 'button';
                        newBtn.className = 'subcampo-add-btn add-funcion-710e-btn btn btn-outline-primary';
                        newBtn.title = 'Agregar funci√≥n';
                        newBtn.innerHTML = '<i class="bi bi-plus"></i>';
                        if (placeholder) {
                            placeholder.replaceWith(newBtn);
                        } else {
                            const inputGroup = row.querySelector('.input-group');
                            if (inputGroup) inputGroup.insertBefore(newBtn, inputGroup.firstChild);
                        }
                    }
                } else {
                    if (addBtn) {
                        const newPlaceholder = document.createElement('div');
                        newPlaceholder.className = 'subcampo-placeholder';
                        newPlaceholder.setAttribute('aria-hidden', 'true');
                        addBtn.replaceWith(newPlaceholder);
                    }
                }

                // Derecha: primera => oculto si es √∫nica; resto => visible
                if (deleteBtn) {
                    deleteBtn.style.visibility = (isFirst && visibleRows.length === 1) ? 'hidden' : 'visible';
                }
            });
        }
        
        // Event delegation para agregar/eliminar funciones
        container.addEventListener('click', function(e) {
            const addBtn = e.target.closest('.add-funcion-710e-btn');
            if (addBtn) {
                console.log('üî• Bot√≥n + funci√≥n 710e clickeado');
                const funcContainer = addBtn.closest('.funciones-710e-container');
                const rows = funcContainer.querySelectorAll('.funcion-710e-row:not(.empty-form)');
                const formsetIndex = funcContainer.dataset.funciones710eIndex;
                
                console.log('üîç Formset index:', formsetIndex, 'Filas actuales:', rows.length);
                
                // Clonar la primera fila
                const firstRow = rows[0];
                const clone = firstRow.cloneNode(true);
                
                // Limpiar el clon
                clone.classList.remove('primera-fila');
                const select = clone.querySelector('select');
                if (select) {
                    select.selectedIndex = 0;
                    // üî• CLAVE: Usar el formsetIndex correcto para el nombre
                    const newName = `funcion_institucional_710_${formsetIndex}_${rows.length}`;
                    console.log('üîç Nuevo select name:', newName);
                    select.name = newName;
                }
                
                // Agregar al contenedor
                funcContainer.appendChild(clone);
                updateFuncionesLayout(funcContainer);
                
                console.log('‚úÖ Funci√≥n 710e agregada. Total filas:', rows.length + 1);
                return;
            }
            
            const deleteBtn = e.target.closest('.delete-funcion-710e-btn');
            if (deleteBtn) {
                console.log('üóëÔ∏è Bot√≥n eliminar funci√≥n 710e clickeado');
                const row = deleteBtn.closest('.funcion-710e-row');
                const funcContainer = row.closest('.funciones-710e-container');
                
                row.remove();
                updateFuncionesLayout(funcContainer);
                
                console.log('‚úÖ Funci√≥n 710e eliminada');
                return;
            }
        });
        
        // Inicializar layout para todos los contenedores existentes
        document.querySelectorAll('.funciones-710e-container').forEach(updateFuncionesLayout);
        
    })();

    // =====================================================
    // MANEJO DEL FORMSET 710 COMPLETO
    // =====================================================
    (function() {
        const container = document.querySelector('.formset-container[data-formset-prefix="{{ formset.prefix }}"]');
        if (!container) {
            console.log('ÔøΩ No se encontr√≥ container para 710');
            return;
        }
        
        console.log('üöÄ Inicializando formset 710 completo');
        
        // Funci√≥n para reindexar todos los elementos del formset 710
        function reindex710() {
            const rows = container.querySelectorAll('.formset-row:not(.empty-form)');
            const managementForm = container.querySelector('input[name$="-TOTAL_FORMS"]');
            
            if (!managementForm) {
                console.log('üö´ No se encontr√≥ management form para 710');
                return;
            }
            
            console.log('üîç Reindexando 710. Filas encontradas:', rows.length);
            
            rows.forEach((row, index) => {
                console.log(`üîÑ Procesando fila ${index}:`, row);
                
                // Actualizar todos los atributos name, id y for
                row.querySelectorAll('[name], [id], label[for]').forEach(el => {
                    ['name', 'id', 'for'].forEach(attr => {
                        const val = el.getAttribute(attr);
                        if (!val) return;
                        
                        // Reemplazar __prefix__ o √≠ndices antiguos con el nuevo √≠ndice
                        const newVal = val
                            .replace(/__prefix__/g, index)
                            .replace(/-\d+-/g, `-${index}-`);
                        
                        if (newVal !== val) {
                            el.setAttribute(attr, newVal);
                            console.log(`üîç ${attr} actualizado: ${val} -> ${newVal}`);
                        }
                    });
                });
                
                // Actualizar data-funciones-710e-index
                const funcContainer = row.querySelector('.funciones-710e-container');
                if (funcContainer) {
                    funcContainer.dataset.funciones710eIndex = index;
                    console.log(`üîç √çndice de contenedor de funciones actualizado a: ${index}`);
                    
                    // Actualizar names de los selects de funciones
                    const selects = funcContainer.querySelectorAll('select');
                    selects.forEach((select, selectIndex) => {
                        const newName = `funcion_institucional_710_${index}_${selectIndex}`;
                        select.name = newName;
                        console.log(`üîç Select name actualizado: ${newName}`);
                    });
                }
            });
            
            // Actualizar TOTAL_FORMS
            managementForm.value = rows.length;
            console.log(`‚úÖ TOTAL_FORMS actualizado a: ${rows.length}`);
        }
        
        // Event delegation para eliminar filas del formset
        container.addEventListener('click', function(e) {
            const deleteBtn = e.target.closest('.delete-row-btn');
            if (deleteBtn) {
                console.log('üóëÔ∏è Bot√≥n eliminar fila 710 clickeado');
                const row = deleteBtn.closest('.formset-row');
                if (row) {
                    row.remove();
                    reindex710();
                    console.log('‚úÖ Fila 710 eliminada y reindexada');
                }
                return;
            }
        });
        
        // Cuando se agrega desde el gestor global (formset-manager.js)
        container.addEventListener('formset:added', function(e) {
            if (!e.detail || e.detail.prefix !== '{{ formset.prefix }}') {
                console.log('üö´ Evento formset:added no es para este prefix 710:', '{{ formset.prefix }}');
                return;
            }
            
            console.log('üî• formset:added recibido en 710', e.detail);
            
            // Timeout para que el DOM se estabilice
            setTimeout(() => {
                reindex710();
                
                // Inicializar layout de funciones 710e en el nuevo formulario
                const newForm = e.detail.newForm;
                if (newForm) {
                    const funcContainer = newForm.querySelector('.funciones-710e-container');
                    if (funcContainer) {
                        console.log('üîç Inicializando layout de funciones 710e en nuevo formulario');
                        updateFuncionesLayout(funcContainer);
                    }
                }
                
                console.log('‚úÖ Nuevo formulario 710 procesado completamente');
            }, 100);
        });
        
        // üî• CLONACI√ìN MANUAL SI NO HAY GESTOR GLOBAL
        // Buscar el bot√≥n + externo que tiene data-formset-target
        setTimeout(() => {
            const addBtn = document.querySelector(`[data-formset-target="{{ formset.prefix }}"]`);
            if (addBtn) {
                console.log('üîç Bot√≥n + externo encontrado para 710:', addBtn);
                
                addBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('ÔøΩ Bot√≥n + externo de 710 clickeado - iniciando clonaci√≥n manual');
                    
                    const container = document.querySelector('.formset-container[data-formset-prefix="{{ formset.prefix }}"]');
                    const emptyForm = container.querySelector('.empty-form');
                    
                    if (!emptyForm) {
                        console.log('üö´ No se encontr√≥ empty form para 710');
                        return;
                    }
                    
                    // Clonar el empty form
                    const newForm = emptyForm.cloneNode(true);
                    newForm.classList.remove('empty-form', 'd-none');
                    newForm.style.display = 'block';
                    newForm.classList.add('mb-3', 'position-relative');
                    
                    // Agregar bot√≥n de eliminar
                    const deleteBtn = document.createElement('button');
                    deleteBtn.type = 'button';
                    deleteBtn.className = 'delete-row-btn btn btn-sm btn-outline-danger position-absolute';
                    deleteBtn.style.cssText = 'right: 8px; top: 8px;';
                    deleteBtn.title = 'Eliminar 710';
                    deleteBtn.innerHTML = '<i class="bi bi-x-lg"></i>';
                    newForm.appendChild(deleteBtn);
                    
                    // Agregar al container
                    const formsContainer = container.querySelector('.formset-forms');
                    formsContainer.appendChild(newForm);
                    
                    console.log('‚úÖ Formulario 710 clonado manualmente');
                    
                    // Reindexar todo
                    reindex710();
                    
                    // Inicializar layout de funciones
                    const funcContainer = newForm.querySelector('.funciones-710e-container');
                    if (funcContainer) {
                        updateFuncionesLayout(funcContainer);
                    }
                    
                    console.log('‚úÖ Clonaci√≥n manual de 710 completada');
                });
            } else {
                console.log('üö´ No se encontr√≥ bot√≥n + externo para 710 con data-formset-target="{{ formset.prefix }}"');
            }
        }, 500);
        
        // Inicializar al cargar
        setTimeout(() => {
            reindex710();
            console.log('‚úÖ Formset 710 inicializado correctamente');
        }, 200);
        
    })();
</script>