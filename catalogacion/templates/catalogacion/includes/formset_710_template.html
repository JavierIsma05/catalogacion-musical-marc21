{% comment %}
Template 710 – Entidades Corporativas Relacionadas
Corregido: hidden fields, prefixes, autocomplete, reindex
{% endcomment %}

{% load catalogacion_tags %}

<div class="formset-container" data-formset-prefix="{{ formset.prefix }}">
    <div style="display:none;">
        {% for hidden in formset.management_form %}
        {{ hidden }}
        {% endfor %}
    </div>

    <div class="formset-forms">

        {% for form in formset %}
        <div class="formset-row {% if form.instance.pk %}existing-form{% endif %} mb-3 position-relative">

            {# ── Hidden fields: id, obra (NO entidad, se renderiza abajo) ── #}
            {% for hidden in form.hidden_fields %}
                {% if hidden.name != 'entidad' %}
                    {{ hidden }}
                {% endif %}
            {% endfor %}

            {% if formset.can_delete %}
            <div class="d-none">{{ form.DELETE }}</div>
            {% endif %}

            <button type="button" class="delete-row-btn" title="Eliminar 710">
                <i class="bi bi-x-lg"></i>
            </button>

            <div class="campo-grid">

                <!-- 710 $a – Entidad relacionada (AUTOCOMPLETE) -->
                <div class="col-full">
                    {{ form.entidad }}
                    <label class="form-label">710 $a – Entidad Relacionada</label>

                    <div class="autocomplete-wrapper">
                        <input type="text" class="form-control entidad-autocomplete"
                            id="{{ form.entidad_texto.id_for_label }}"
                            name="{{ form.entidad_texto.html_name }}"
                            value="{{ form.entidad_texto.value|default:'' }}"
                            placeholder="Escriba para buscar una entidad existente o crear una nueva."
                            autocomplete="off">
                        <div class="autocomplete-suggestions entidad710-suggestions"></div>
                    </div>
                </div>

                <!-- 710 $e – Función (REPETIBLE) -->
                <div class="col-full">
                    <label class="form-label small">$e Función</label>

                    <div class="funciones-710e-container" data-funciones-710e-index="{{ forloop.counter0 }}">
                        {% if form.instance.pk and form.instance.funciones_institucionales.exists %}
                            {% for fi in form.instance.funciones_institucionales.all %}
                            <div class="funcion-710e-row mb-2">
                                <div class="input-group">
                                    {% if forloop.first %}
                                    <button type="button"
                                            class="subcampo-add-btn add-funcion-710e-btn"
                                            title="Agregar función">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                    {% else %}
                                    <div class="subcampo-placeholder" aria-hidden="true"></div>
                                    {% endif %}

                                    <select class="form-select"
                                            name="funcion_institucional_710_{{ forloop.parentloop.counter0 }}_{{ forloop.counter0 }}">
                                        <option value="">---------</option>
                                        {% for val, lbl in form.funcion.field.choices %}
                                        {% if val %}
                                        <option value="{{ val }}"
                                                {% if fi.funcion == val %}selected{% endif %}>
                                            {{ lbl }}
                                        </option>
                                        {% endif %}
                                        {% endfor %}
                                    </select>

                                    <button type="button"
                                            class="subcampo-delete-btn delete-funcion-710e-btn"
                                            title="Eliminar"
                                            {% if forloop.first and forloop.last %}style="visibility:hidden;"{% endif %}>
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            {# Nueva entidad o sin funciones → select vacío #}
                            <div class="funcion-710e-row mb-2">
                                <div class="input-group">
                                    <button type="button"
                                            class="subcampo-add-btn add-funcion-710e-btn"
                                            title="Agregar función">
                                        <i class="bi bi-plus"></i>
                                    </button>

                                    <select class="form-select"
                                            name="funcion_institucional_710_{{ forloop.counter0 }}_0">
                                        <option value="">---------</option>
                                        {% for val, lbl in form.funcion.field.choices %}
                                        {% if val %}
                                        <option value="{{ val }}">{{ lbl }}</option>
                                        {% endif %}
                                        {% endfor %}
                                    </select>

                                    <button type="button"
                                            class="subcampo-delete-btn delete-funcion-710e-btn"
                                            title="Eliminar"
                                            style="visibility:hidden;">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>

            </div>
        </div>
        {% endfor %}

        <!-- ═══════ EMPTY FORM ═══════ -->
        <div class="formset-row empty-form mb-3" style="display:none;">
            <input type="hidden" name="{{ formset.prefix }}-__prefix__-id" value="">
            <input type="hidden" name="{{ formset.prefix }}-__prefix__-entidad" value=""
                   class="entidad710-hidden-id">

            <button type="button" class="delete-row-btn" title="Eliminar 710">
                <i class="bi bi-x-lg"></i>
            </button>

            <div class="campo-grid">

                <div class="col-full">
                    <label class="form-label">710 $a – Entidad Relacionada</label>
                    <div class="autocomplete-wrapper">
                        <input type="text" class="form-control entidad-autocomplete"
                            name="{{ formset.prefix }}-__prefix__-entidad_texto"
                            placeholder="Escriba para buscar una entidad existente o crear una nueva."
                            autocomplete="off">
                        <div class="autocomplete-suggestions entidad710-suggestions"></div>
                    </div>
                </div>

                <div class="col-full">
                    <label class="form-label small">$e Función</label>
                    <div class="funciones-710e-container" data-funciones-710e-index="__prefix__">
                        <div class="funcion-710e-row mb-2">
                            <div class="input-group">
                                <button type="button"
                                        class="subcampo-add-btn add-funcion-710e-btn"
                                        title="Agregar función">
                                    <i class="bi bi-plus"></i>
                                </button>

                                <select class="form-select"
                                        name="funcion_institucional_710___prefix___0">
                                    <option value="">---------</option>
                                    {% for val, lbl in formset.empty_form.funcion.field.choices %}
                                    {% if val %}
                                    <option value="{{ val }}">{{ lbl }}</option>
                                    {% endif %}
                                    {% endfor %}
                                </select>

                                <button type="button"
                                        class="subcampo-delete-btn delete-funcion-710e-btn"
                                        title="Eliminar"
                                        style="visibility:hidden;">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>
</div>

<script>
(function () {
    "use strict";

    const prefix = "{{ formset.prefix }}";
    const root = document.querySelector(`.formset-container[data-formset-prefix="${prefix}"]`);
    if (!root) return;

    /* ======================================================
       AUTOCOMPLETE 710 $a
       ====================================================== */
    function initEntidadAutocomplete(row) {
        const input = row.querySelector(".entidad-autocomplete");
        if (!input || input.dataset.acInit) return;
        input.dataset.acInit = "1";

        const hidden = row.querySelector('input[type="hidden"][name$="-entidad"]');
        const box = row.querySelector(".entidad710-suggestions");
        if (!hidden || !box) return;

        let timer = null;
        function hide() { box.innerHTML = ""; box.classList.remove("show"); }

        function search(q) {
            fetch(`/catalogacion/api/autocompletar/entidad/?q=${encodeURIComponent(q)}`)
                .then(r => r.json())
                .then(data => {
                    box.innerHTML = "";

                    data.results.forEach(ent => {
                        const div = document.createElement("div");
                        div.className = "autocomplete-item";
                        div.innerHTML = ent.text;
                        div.addEventListener("click", () => {
                            input.value = ent.nombre_entidad || ent.text;
                            hidden.value = ent.id;
                            hide();
                        });
                        box.appendChild(div);
                    });

                    const nuevo = document.createElement("div");
                    nuevo.className = "autocomplete-item new-item";
                    nuevo.innerHTML = `<strong>+ Crear nuevo:</strong> "${q}"`;
                    nuevo.addEventListener("click", () => {
                        input.value = q;
                        hidden.value = "";
                        hide();
                    });
                    box.appendChild(nuevo);
                    box.classList.add("show");
                });
        }

        input.addEventListener("input", () => {
            const q = input.value.trim();
            hidden.value = "";
            if (q.length < 2) return hide();
            clearTimeout(timer);
            timer = setTimeout(() => search(q), 300);
        });

        document.addEventListener("click", e => {
            if (!row.contains(e.target)) hide();
        });
    }

    /* ======================================================
       FUNCIONES 710 $e – Layout
       ====================================================== */
    function updateFuncionesLayout(container) {
        const rows = Array.from(
            container.querySelectorAll('.funcion-710e-row')
        ).filter(r => r.style.display !== 'none');

        rows.forEach((row, i) => {
            const isFirst = i === 0;
            const addBtn = row.querySelector('.add-funcion-710e-btn');
            const placeholder = row.querySelector('.subcampo-placeholder');
            const deleteBtn = row.querySelector('.delete-funcion-710e-btn');

            if (isFirst) {
                if (!addBtn && placeholder) {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'subcampo-add-btn add-funcion-710e-btn';
                    btn.title = 'Agregar función';
                    btn.innerHTML = '<i class="bi bi-plus"></i>';
                    placeholder.replaceWith(btn);
                }
            } else {
                if (addBtn) {
                    const ph = document.createElement('div');
                    ph.className = 'subcampo-placeholder';
                    ph.setAttribute('aria-hidden', 'true');
                    addBtn.replaceWith(ph);
                }
            }
            if (deleteBtn) {
                deleteBtn.style.visibility = (isFirst && rows.length === 1) ? 'hidden' : 'visible';
            }
        });
    }

    /* ======================================================
       CLICK: Agregar / Eliminar función $e
       ====================================================== */
    root.addEventListener('click', function (e) {
        const addBtn = e.target.closest('.add-funcion-710e-btn');
        if (addBtn) {
            const funcContainer = addBtn.closest('.funciones-710e-container');
            if (!funcContainer) return;
            const visibleRows = Array.from(funcContainer.querySelectorAll('.funcion-710e-row'))
                .filter(r => r.style.display !== 'none');
            const formsetIndex = funcContainer.dataset.funciones710eIndex;

            const first = visibleRows[0];
            if (!first) return;
            const clone = first.cloneNode(true);

            const select = clone.querySelector('select');
            if (select) {
                select.selectedIndex = 0;
                select.name = `funcion_institucional_710_${formsetIndex}_${visibleRows.length}`;
            }

            const addInClone = clone.querySelector('.add-funcion-710e-btn');
            if (addInClone) {
                const ph = document.createElement('div');
                ph.className = 'subcampo-placeholder';
                ph.setAttribute('aria-hidden', 'true');
                addInClone.replaceWith(ph);
            }

            funcContainer.appendChild(clone);
            updateFuncionesLayout(funcContainer);
            return;
        }

        const delBtn = e.target.closest('.delete-funcion-710e-btn');
        if (delBtn) {
            const row = delBtn.closest('.funcion-710e-row');
            const funcContainer = row ? row.closest('.funciones-710e-container') : null;
            if (row) row.remove();
            if (funcContainer) updateFuncionesLayout(funcContainer);
            return;
        }
    });

    /* ======================================================
       REINDEXAR FORMSET 710 (SEGURO, SIN REGEX GLOBAL)
       ====================================================== */
    function reindex710() {
        const rows = root.querySelectorAll(".formset-row:not(.empty-form)");
        const totalInput = root.querySelector(`[name="${prefix}-TOTAL_FORMS"]`);

        rows.forEach((row, index) => {
            row.querySelectorAll("[name], [id], label[for]").forEach(el => {
                ["name", "id", "for"].forEach(attr => {
                    const val = el.getAttribute(attr);
                    if (!val) return;

                    if (val.startsWith(prefix + "-") || val.startsWith("id_" + prefix + "-")) {
                        const idPfx = val.startsWith("id_") ? "id_" : "";
                        const rest = val.slice((idPfx + prefix + "-").length);
                        const newRest = rest.replace(/^\d+/, String(index));
                        el.setAttribute(attr, idPfx + prefix + "-" + newRest);
                    }
                    else if (val.includes("__prefix__")) {
                        el.setAttribute(attr, val.replace(/__prefix__/g, index));
                    }
                });
            });

            const funcContainer = row.querySelector('.funciones-710e-container');
            if (funcContainer) {
                funcContainer.dataset.funciones710eIndex = index;
                const selects = funcContainer.querySelectorAll('select');
                selects.forEach((sel, si) => {
                    sel.name = `funcion_institucional_710_${index}_${si}`;
                });
            }

            initEntidadAutocomplete(row);
        });

        if (totalInput) totalInput.value = rows.length;
    }

    /* ======================================================
       INICIALIZACIÓN
       ====================================================== */
    root.querySelectorAll('.formset-row:not(.empty-form)').forEach(initEntidadAutocomplete);
    root.querySelectorAll('.funciones-710e-container').forEach(updateFuncionesLayout);
    reindex710();

    const formsHost = root.querySelector('.formset-forms');
    if (formsHost) {
        let timer = null;
        const observer = new MutationObserver(() => {
            clearTimeout(timer);
            timer = setTimeout(() => {
                reindex710();
                root.querySelectorAll('.funciones-710e-container').forEach(updateFuncionesLayout);
            }, 50);
        });
        observer.observe(formsHost, { childList: true, subtree: false });
    }

})();
</script>
