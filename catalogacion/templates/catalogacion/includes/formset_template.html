{% comment %}
Template reutilizable para renderizar formsets con botón de agregar/eliminar
Uso: {% include 'catalogacion/includes/formset_template.html' with formset=personas_700 titulo="Campo 700 - Personas Relacionadas" %}
{% endcomment %}

<div class="formset-container" data-formset-prefix="{{ formset.prefix }}">
    {{ formset.management_form }}
    
    <button type="button" class="add-form-row mb-3" title="Agregar {{ titulo|default:'Campo' }}">
        <i class="bi bi-plus-circle"></i>
        Agregar {{ titulo|default:'Campo' }}
    </button>
    
    <div class="formset-forms">
        {% for form in formset %}
        <div class="formset-row {% if form.instance.pk %}existing-form{% else %}empty-form{% endif %}">
            {% if form.instance.pk %}
                <input type="hidden" name="{{ form.prefix }}-id" value="{{ form.instance.pk }}">
            {% endif %}
            
            {% if formset.can_delete %}
                <div class="d-none">
                    {{ form.DELETE }}
                </div>
            {% endif %}
            
            <button type="button" class="delete-row-btn" title="Eliminar">
                <i class="bi bi-x-lg"></i>
            </button>
            
            <div class="campo-grid">
                {% for field in form.visible_fields %}
                    {% if field.name != 'DELETE' %}
                    <div class="col-full">
                        <label class="form-label" for="{{ field.id_for_label }}">
                            {{ field.label }}{% if field.field.required %}<span class="text-danger">*</span>{% endif %}
                        </label>
                        {{ field }}
                        {% if field.errors %}
                            <div class="invalid-feedback d-block">{{ field.errors }}</div>
                        {% endif %}
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
// Script para manejar agregar/eliminar formularios
(function() {
    const prefix = '{{ formset.prefix }}';
    const container = document.querySelector(`[data-formset-prefix="${prefix}"]`);
    if (!container) return;
    
    const totalFormsInput = container.querySelector(`#id_${prefix}-TOTAL_FORMS`);
    const addButton = container.querySelector('.add-form-row');
    const formsContainer = container.querySelector('.formset-forms');
    
    if (!totalFormsInput || !addButton || !formsContainer) return;
    
    // Función para agregar nuevo formulario
    addButton.addEventListener('click', function() {
        const totalForms = parseInt(totalFormsInput.value);
        const emptyFormTemplate = formsContainer.querySelector('.empty-form');
        
        if (!emptyFormTemplate) {
            console.error('No se encontró template vacío para el formset');
            return;
        }
        
        const emptyForm = emptyFormTemplate.cloneNode(true);
        
        // Actualizar índices en el nuevo formulario
        emptyForm.innerHTML = emptyForm.innerHTML.replace(/__prefix__/g, totalForms);
        emptyForm.classList.remove('empty-form');
        
        // Agregar al contenedor
        formsContainer.appendChild(emptyForm);
        
        // Incrementar contador
        totalFormsInput.value = totalForms + 1;
        
        // Reactivar Select2 si existe
        if (typeof $ !== 'undefined' && typeof $.fn.select2 !== 'undefined') {
            emptyForm.querySelectorAll('.select2').forEach(select => {
                $(select).select2({
                    theme: 'bootstrap-5',
                    width: '100%'
                });
            });
        }
    });
    
    // Función para eliminar formulario
    container.addEventListener('click', function(e) {
        const deleteBtn = e.target.closest('.delete-row-btn');
        if (!deleteBtn) return;
        
        const row = deleteBtn.closest('.formset-row');
        const deleteCheckbox = row.querySelector('input[name*="DELETE"]');
        
        if (row.classList.contains('existing-form')) {
            // Formulario existente: marcar para eliminación
            if (deleteCheckbox.checked) {
                // Cancelar eliminación
                deleteCheckbox.checked = false;
                row.style.opacity = '1';
                deleteBtn.classList.remove('btn-warning');
                deleteBtn.innerHTML = '<i class="bi bi-x-lg"></i>';
                deleteBtn.title = 'Eliminar';
            } else {
                // Marcar para eliminación
                deleteCheckbox.checked = true;
                row.style.opacity = '0.5';
                deleteBtn.classList.add('btn-warning');
                deleteBtn.innerHTML = '<i class="bi bi-arrow-counterclockwise"></i>';
                deleteBtn.title = 'Cancelar eliminación';
            }
        } else {
            // Formulario nuevo: remover completamente
            row.remove();
            
            // Actualizar contador
            const totalForms = parseInt(totalFormsInput.value);
            totalFormsInput.value = totalForms - 1;
            
            // Reindexar formularios
            const allRows = formsContainer.querySelectorAll('.formset-row');
            allRows.forEach((formRow, index) => {
                if (!formRow.classList.contains('empty-form')) {
                    formRow.innerHTML = formRow.innerHTML.replace(
                        new RegExp(`${prefix}-(\\d+)-`, 'g'),
                        `${prefix}-${index}-`
                    );
                }
            });
        }
    });
})();
</script>
