{% comment %}
Template reutilizable para renderizar formsets con botón de agregar/eliminar
Uso: {% include 'catalogacion/includes/formset_template.html' with formset=personas_700 titulo="Campo 700 - Personas Relacionadas" %}
El botón de agregar ahora se maneja desde el header del campo (campo-add-btn)
{% endcomment %}

<div class="formset-container" data-formset-prefix="{{ formset.prefix }}">
    {{ formset.management_form }}
    
    <div class="formset-forms">
        {% for form in formset %}
        <div class="formset-row {% if form.instance.pk %}existing-form{% endif %}">
            {% if form.instance.pk %}
                <input type="hidden" name="{{ form.prefix }}-id" value="{{ form.instance.pk }}">
            {% endif %}
            
            {% if formset.can_delete %}
                <div class="d-none">
                    {{ form.DELETE }}
                </div>
            {% endif %}
            
            <button type="button" class="delete-row-btn" title="Eliminar">
                <i class="bi bi-x-lg"></i>
            </button>
            
            <div class="campo-grid">
                {% for field in form.visible_fields %}
                    {% if field.name != 'DELETE' %}
                    <div class="col-full">
                        <label class="form-label" for="{{ field.id_for_label }}">
                            {{ field.label }}{% if field.field.required %}<span class="text-danger">*</span>{% endif %}
                        </label>
                        {{ field }}
                        {% if field.errors %}
                            <div class="invalid-feedback d-block">{{ field.errors }}</div>
                        {% endif %}
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endfor %}
        
        {# Template vacío para clonar (siempre presente) #}
        <div class="formset-row empty-form">
            <button type="button" class="delete-row-btn" title="Eliminar">
                <i class="bi bi-x-lg"></i>
            </button>
            
            <div class="campo-grid">
                {% for field in formset.empty_form.visible_fields %}
                    {% if field.name != 'DELETE' %}
                    <div class="col-full">
                        <label class="form-label" for="{{ field.id_for_label }}">
                            {{ field.label }}{% if field.field.required %}<span class="text-danger">*</span>{% endif %}
                        </label>
                        {{ field }}
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- 
    Los formsets son manejados por formset-manager.js (cargado en crear_obra.html)
    No se necesita script adicional aquí
-->
