{% comment %}
Template para campo 490 - Mención de Serie
El campo 490 es repetible y contiene subcampos repetibles ($a título de serie y $v volumen)
{% endcomment %}

<div class="formset-container" data-formset-prefix="{{ formset.prefix }}">
    {# Renderizar management_form sin mensajes de error #}
    <div style="display: none;">
        {% for field in formset.management_form %}
            {{ field }}
        {% endfor %}
    </div>
    
    <button type="button" class="add-form-row mb-3" title="Agregar Mención de Serie">
        <i class="bi bi-plus-circle"></i>
    </button>
    
    <div class="formset-forms">
        {% for form in formset %}
        <div class="formset-row {% if form.instance.pk %}existing-form{% endif %} mb-3">
            {% if form.instance.pk %}
                <input type="hidden" name="{{ form.prefix }}-id" value="{{ form.instance.pk }}">
            {% endif %}
            
            {% if formset.can_delete %}
                <div class="d-none">
                    {{ form.DELETE }}
                </div>
            {% endif %}
            
            <button type="button" class="delete-row-btn" title="Eliminar">
                <i class="bi bi-x-lg"></i>
            </button>
            
            <div class="campo-grid">
                {# Botón para agregar títulos ($a) #}
                <div class="col-full">
                    <button type="button" class="btn btn-sm btn-outline-primary add-titulo-btn w-100" data-mencion-index="{{ forloop.counter0 }}" title="Agregar Título de Serie ($a)">
                        <i class="bi bi-plus-circle"></i>
                    </button>
                </div>
                
                {# Subcampo $a - Títulos de serie (Repetible) #}
                <div class="col-full titulos-container" data-titulos-container="{{ forloop.counter0 }}">
                    {% if form.instance.pk %}
                        {# Cargar títulos existentes #}
                        {% for titulo in form.instance.titulos_serie_490.all %}
                        <div class="titulo-form-row">
                            <div class="d-flex flex-column w-100 mb-2">
                                <label class="form-label small">490 $a - Título de serie</label>
                                <div class="d-flex gap-2 align-items-center">
                                    <input type="text" 
                                           class="form-control titulo-input" 
                                           name="titulo_mencion_490_{{ forloop.parentloop.counter0 }}_{{ titulo.pk }}"
                                           value="{{ titulo.titulo_serie }}"
                                           placeholder="Título de la serie" 
                                           style="flex: 1;">
                                    <button type="button" class="btn btn-sm btn-outline-danger delete-titulo-btn" title="Eliminar título">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
                
                {# Botón para agregar volúmenes ($v) #}
                <div class="col-full">
                    <button type="button" class="btn btn-sm btn-outline-primary add-volumen-btn w-100" data-mencion-index="{{ forloop.counter0 }}" title="Agregar Volumen ($v)">
                        <i class="bi bi-plus-circle"></i>
                    </button>
                </div>
                
                {# Subcampo $v - Volúmenes (Repetible) #}
                <div class="col-full volumenes-container" data-volumenes-container="{{ forloop.counter0 }}">
                    {% if form.instance.pk %}
                        {# Cargar volúmenes existentes #}
                        {% for volumen in form.instance.volumenes_serie_490.all %}
                        <div class="volumen-form-row">
                            <div class="d-flex flex-column w-100 mb-2">
                                <label class="form-label small">490 $v - Volumen</label>
                                <div class="d-flex gap-2 align-items-center">
                                    <input type="text" 
                                           class="form-control volumen-input" 
                                           name="volumen_mencion_490_{{ forloop.parentloop.counter0 }}_{{ volumen.pk }}"
                                           value="{{ volumen.volumen }}"
                                           placeholder="Número de volumen" 
                                           style="flex: 1;">
                                    <button type="button" class="btn btn-sm btn-outline-danger delete-volumen-btn" title="Eliminar volumen">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
        
        {# Template vacío para clonar menciones de serie #}
        <div class="formset-row empty-form mb-3">
            <button type="button" class="delete-row-btn" title="Eliminar">
                <i class="bi bi-x-lg"></i>
            </button>
            
            <div class="campo-grid">
                <div class="col-full">
                    <button type="button" class="btn btn-sm btn-outline-primary add-titulo-btn w-100" data-mencion-index="__prefix__" title="Agregar Título de Serie ($a)">
                        <i class="bi bi-plus-circle"></i>
                    </button>
                </div>
                
                <div class="col-full titulos-container" data-titulos-container="__prefix__">
                    {# Los títulos se agregarán aquí dinámicamente #}
                </div>
                
                <div class="col-full">
                    <button type="button" class="btn btn-sm btn-outline-primary add-volumen-btn w-100" data-mencion-index="__prefix__" title="Agregar Volumen ($v)">
                        <i class="bi bi-plus-circle"></i>
                    </button>
                </div>
                
                <div class="col-full volumenes-container" data-volumenes-container="__prefix__">
                    {# Los volúmenes se agregarán aquí dinámicamente #}
                </div>
            </div>
        </div>
    </div>
</div>

{# Templates globales para títulos y volúmenes (fuera del formset loop) #}
<div class="titulo-form-row titulo-template-490 d-none">
    <div class="d-flex flex-column w-100 mb-2">
        <label class="form-label small">490 $a - Título de serie</label>
        <div class="d-flex gap-2 align-items-center">
            <input type="text" class="form-control titulo-input" placeholder="Título de la serie" style="flex: 1;">
            <button type="button" class="btn btn-sm btn-outline-danger delete-titulo-btn" title="Eliminar título">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    </div>
</div>

<div class="volumen-form-row volumen-template-490 d-none">
    <div class="d-flex flex-column w-100 mb-2">
        <label class="form-label small">490 $v - Volumen</label>
        <div class="d-flex gap-2 align-items-center">
            <input type="text" class="form-control volumen-input" placeholder="Número de volumen" style="flex: 1;">
            <button type="button" class="btn btn-sm btn-outline-danger delete-volumen-btn" title="Eliminar volumen">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    </div>
</div>

<script>
// Script para manejar el campo 490 con títulos y volúmenes repetibles
(function() {
    const prefix = '{{ formset.prefix }}';
    const container = document.querySelector(`[data-formset-prefix="${prefix}"]`);
    if (!container) return;
    
    const totalFormsInput = container.querySelector(`#id_${prefix}-TOTAL_FORMS`);
    const addButton = container.querySelector('.add-form-row');
    const formsContainer = container.querySelector('.formset-forms');
    const tituloTemplate = document.querySelector('.titulo-template-490');
    const volumenTemplate = document.querySelector('.volumen-template-490');
    
    if (!totalFormsInput || !addButton || !formsContainer || !tituloTemplate || !volumenTemplate) return;
    
    // Agregar nueva mención de serie 490
    addButton.addEventListener('click', function() {
        const totalForms = parseInt(totalFormsInput.value);
        const emptyFormTemplate = formsContainer.querySelector('.empty-form');
        
        if (!emptyFormTemplate) return;
        
        const emptyForm = emptyFormTemplate.cloneNode(true);
        emptyForm.innerHTML = emptyForm.innerHTML.replace(/__prefix__/g, totalForms);
        emptyForm.classList.remove('empty-form');
        emptyForm.style.display = '';
        
        formsContainer.insertBefore(emptyForm, emptyFormTemplate);
        totalFormsInput.value = totalForms + 1;
    });
    
    // Eliminar mención de serie 490
    container.addEventListener('click', function(e) {
        const deleteBtn = e.target.closest('.delete-row-btn');
        if (!deleteBtn) return;
        
        const row = deleteBtn.closest('.formset-row');
        if (!row || row.classList.contains('empty-form')) return;
        
        const deleteCheckbox = row.querySelector('input[name*="DELETE"]');
        
        if (row.classList.contains('existing-form')) {
            if (deleteCheckbox && deleteCheckbox.checked) {
                deleteCheckbox.checked = false;
                row.style.opacity = '1';
                deleteBtn.classList.remove('btn-warning');
                deleteBtn.innerHTML = '<i class="bi bi-x-lg"></i>';
                deleteBtn.title = 'Eliminar';
            } else if (deleteCheckbox) {
                deleteCheckbox.checked = true;
                row.style.opacity = '0.5';
                deleteBtn.classList.add('btn-warning');
                deleteBtn.innerHTML = '<i class="bi bi-arrow-counterclockwise"></i>';
                deleteBtn.title = 'Cancelar eliminación';
            }
        } else {
            row.remove();
            totalFormsInput.value = parseInt(totalFormsInput.value) - 1;
        }
    });
    
    // Manejar títulos de serie (subcampo $a repetible)
    container.addEventListener('click', function(e) {
        // Agregar título
        const addTituloBtn = e.target.closest('.add-titulo-btn');
        if (addTituloBtn) {
            const mencionIndex = addTituloBtn.getAttribute('data-mencion-index');
            const titulosContainer = container.querySelector(`[data-titulos-container="${mencionIndex}"]`);
            
            if (!titulosContainer) return;
            
            const newTitulo = tituloTemplate.cloneNode(true);
            newTitulo.classList.remove('titulo-template-490', 'd-none');
            
            // Actualizar el name del input
            const input = newTitulo.querySelector('.titulo-input');
            if (input) {
                input.name = `titulo_mencion_490_${mencionIndex}_${Date.now()}`;
            }
            
            titulosContainer.appendChild(newTitulo);
        }
        
        // Eliminar título
        const deleteTituloBtn = e.target.closest('.delete-titulo-btn');
        if (deleteTituloBtn) {
            const tituloRow = deleteTituloBtn.closest('.titulo-form-row');
            if (!tituloRow.classList.contains('titulo-template-490')) {
                tituloRow.remove();
            }
        }
    });
    
    // Manejar volúmenes (subcampo $v repetible)
    container.addEventListener('click', function(e) {
        // Agregar volumen
        const addVolumenBtn = e.target.closest('.add-volumen-btn');
        if (addVolumenBtn) {
            const mencionIndex = addVolumenBtn.getAttribute('data-mencion-index');
            const volumenesContainer = container.querySelector(`[data-volumenes-container="${mencionIndex}"]`);
            
            if (!volumenesContainer) return;
            
            const newVolumen = volumenTemplate.cloneNode(true);
            newVolumen.classList.remove('volumen-template-490', 'd-none');
            
            // Actualizar el name del input
            const input = newVolumen.querySelector('.volumen-input');
            if (input) {
                input.name = `volumen_mencion_490_${mencionIndex}_${Date.now()}`;
            }
            
            volumenesContainer.appendChild(newVolumen);
        }
        
        // Eliminar volumen
        const deleteVolumenBtn = e.target.closest('.delete-volumen-btn');
        if (deleteVolumenBtn) {
            const volumenRow = deleteVolumenBtn.closest('.volumen-form-row');
            if (!volumenRow.classList.contains('volumen-template-490')) {
                volumenRow.remove();
            }
        }
    });
})();
</script>
