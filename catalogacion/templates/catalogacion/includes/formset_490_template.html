{% comment %}
Template para campo 490 - Mención de Serie
El campo 490 es repetible y contiene subcampos repetibles ($a título de serie y $v volumen)
El botón de agregar campo completo está en el header del campo (campo-add-btn)
{% endcomment %}

<div class="formset-container" data-formset-prefix="{{ formset.prefix }}">
    {# Renderizar management_form sin mensajes de error #}
    <div style="display: none;">
        {% for field in formset.management_form %}
            {{ field }}
        {% endfor %}
    </div>
    
    <div class="formset-forms">
        {% for form in formset %}
        <div class="formset-row {% if form.instance.pk %}existing-form{% endif %} mb-3">
            {% if form.instance.pk %}
                <input type="hidden" name="{{ form.prefix }}-id" value="{{ form.instance.pk }}">
            {% endif %}
            
            {% if formset.can_delete %}
                <div class="d-none">
                    {{ form.DELETE }}
                </div>
            {% endif %}
            
            <button type="button" class="delete-row-btn" title="Eliminar">
                <i class="bi bi-x-lg"></i>
            </button>
            
            <div class="campo-grid">
                {# Subcampo $a - Títulos de serie (Repetible) con botón + a la izquierda #}
                <div class="col-full">
                    <label class="form-label small">490 $a - Título de serie</label>
                    <div class="subcampo-repetible-container titulos-container" data-titulos-container="{{ forloop.counter0 }}" data-borrador-container="titulo_mencion_490" data-borrador-parent="{{ forloop.counter0 }}">
                        {% if form.instance.pk %}
                            {# Cargar títulos existentes #}
                            {% for titulo in form.instance.titulos_serie_490.all %}
                            <div class="subcampo-row titulo-form-row">
                                {% if forloop.first %}
                                <button type="button" class="subcampo-add-btn add-titulo-btn" data-mencion-index="{{ forloop.parentloop.counter0 }}" data-borrador-add="titulo_mencion_490" data-borrador-parent="{{ forloop.parentloop.counter0 }}" title="Agregar Título">
                                    <i class="bi bi-plus"></i>
                                </button>
                                {% else %}
                                <div class="subcampo-placeholder"></div>
                                {% endif %}
                                <input type="text" 
                                       class="form-control titulo-input" 
                                       name="titulo_mencion_490_{{ forloop.parentloop.counter0 }}_{{ titulo.pk }}"
                                       value="{{ titulo.titulo_serie }}"
                                       placeholder="Ej. Clásicos de la literatura pianistica venezolana">
                                <button type="button" class="subcampo-delete-btn delete-titulo-btn" title="Eliminar" {% if forloop.first and forloop.last %}style="visibility: hidden;"{% endif %}>
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                            {% empty %}
                            <div class="subcampo-row titulo-form-row">
                                <button type="button" class="subcampo-add-btn add-titulo-btn" data-mencion-index="{{ forloop.counter0 }}" data-borrador-add="titulo_mencion_490" data-borrador-parent="{{ forloop.counter0 }}" title="Agregar Título">
                                    <i class="bi bi-plus"></i>
                                </button>
                                <input type="text" class="form-control titulo-input" name="titulo_mencion_490_{{ forloop.counter0 }}_0" placeholder="Clásicos de la literatura pianística venezolana…">
                                <button type="button" class="subcampo-delete-btn delete-titulo-btn" title="Eliminar" style="visibility: hidden;">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                            {% endfor %}
                        {% else %}
                        <div class="subcampo-row titulo-form-row">
                            <button type="button" class="subcampo-add-btn add-titulo-btn" data-mencion-index="{{ forloop.counter0 }}" data-borrador-add="titulo_mencion_490" data-borrador-parent="{{ forloop.counter0 }}" title="Agregar Título">
                                <i class="bi bi-plus"></i>
                            </button>
                            <input type="text" class="form-control titulo-input" name="titulo_mencion_490_{{ forloop.counter0 }}_0" placeholder="Clásicos de la literatura pianística venezolana…">
                            <button type="button" class="subcampo-delete-btn delete-titulo-btn" title="Eliminar" style="visibility: hidden;">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                {# Subcampo $v - Volúmenes (Repetible) con botón + a la izquierda #}
                <div class="col-full">
                    <label class="form-label small">490 $v - Volumen</label>
                    <div class="subcampo-repetible-container volumenes-container" data-volumenes-container="{{ forloop.counter0 }}" data-borrador-container="volumen_mencion_490" data-borrador-parent="{{ forloop.counter0 }}">
                        {% if form.instance.pk %}
                            {# Cargar volúmenes existentes #}
                            {% for volumen in form.instance.volumenes_serie_490.all %}
                            <div class="subcampo-row volumen-form-row">
                                {% if forloop.first %}
                                <button type="button" class="subcampo-add-btn add-volumen-btn" data-mencion-index="{{ forloop.parentloop.counter0 }}" data-borrador-add="volumen_mencion_490" data-borrador-parent="{{ forloop.parentloop.counter0 }}" title="Agregar Volumen">
                                    <i class="bi bi-plus"></i>
                                </button>
                                {% else %}
                                <div class="subcampo-placeholder"></div>
                                {% endif %}
                                <input type="text" 
                                       class="form-control volumen-input" 
                                       name="volumen_mencion_490_{{ forloop.parentloop.counter0 }}_{{ volumen.pk }}"
                                       value="{{ volumen.volumen }}"
                                       placeholder="Ej:. Vol 8">
                                <button type="button" class="subcampo-delete-btn delete-volumen-btn" title="Eliminar" {% if forloop.first and forloop.last %}style="visibility: hidden;"{% endif %}>
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                            {% empty %}
                            <div class="subcampo-row volumen-form-row">
                                <button type="button" class="subcampo-add-btn add-volumen-btn" data-mencion-index="{{ forloop.counter0 }}" data-borrador-add="volumen_mencion_490" data-borrador-parent="{{ forloop.counter0 }}" title="Agregar Volumen">
                                    <i class="bi bi-plus"></i>
                                </button>
                                <input type="text" class="form-control volumen-input" name="volumen_mencion_490_{{ forloop.counter0 }}_0" placeholder="Vol. 8">
                                <button type="button" class="subcampo-delete-btn delete-volumen-btn" title="Eliminar" style="visibility: hidden;">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                            {% endfor %}
                        {% else %}
                        <div class="subcampo-row volumen-form-row">
                            <button type="button" class="subcampo-add-btn add-volumen-btn" data-mencion-index="{{ forloop.counter0 }}" data-borrador-add="volumen_mencion_490" data-borrador-parent="{{ forloop.counter0 }}" title="Agregar Volumen">
                                <i class="bi bi-plus"></i>
                            </button>
                            <input type="text" class="form-control volumen-input" name="volumen_mencion_490_{{ forloop.counter0 }}_0" placeholder="Vol. 8">
                            <button type="button" class="subcampo-delete-btn delete-volumen-btn" title="Eliminar" style="visibility: hidden;">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        
        {# Template vacío para clonar menciones de serie #}
        <div class="formset-row empty-form mb-3">
            <button type="button" class="delete-row-btn" title="Eliminar">
                <i class="bi bi-x-lg"></i>
            </button>
            
            <div class="campo-grid">
                <div class="col-full">
                    <label class="form-label small">490 $a - Título de serie</label>
                    <div class="subcampo-repetible-container titulos-container" data-titulos-container="__prefix__" data-borrador-container="titulo_mencion_490" data-borrador-parent="__prefix__">
                        <div class="subcampo-row titulo-form-row">
                            <button type="button" class="subcampo-add-btn add-titulo-btn" data-mencion-index="__prefix__" data-borrador-add="titulo_mencion_490" data-borrador-parent="__prefix__" title="Agregar Título">
                                <i class="bi bi-plus"></i>
                            </button>
                            <input type="text" class="form-control titulo-input" name="titulo_mencion_490___prefix___0" placeholder="Clásicos de la literatura pianística venezolana…">
                            <button type="button" class="subcampo-delete-btn delete-titulo-btn" title="Eliminar" style="visibility: hidden;">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="col-full">
                    <label class="form-label small">490 $v - Volumen</label>
                    <div class="subcampo-repetible-container volumenes-container" data-volumenes-container="__prefix__" data-borrador-container="volumen_mencion_490" data-borrador-parent="__prefix__">
                        <div class="subcampo-row volumen-form-row">
                            <button type="button" class="subcampo-add-btn add-volumen-btn" data-mencion-index="__prefix__" data-borrador-add="volumen_mencion_490" data-borrador-parent="__prefix__" title="Agregar Volumen">
                                <i class="bi bi-plus"></i>
                            </button>
                            <input type="text" class="form-control volumen-input" name="volumen_mencion_490___prefix___0" placeholder="Vol. 8">
                            <button type="button" class="subcampo-delete-btn delete-volumen-btn" title="Eliminar" style="visibility: hidden;">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{# Templates globales para títulos y volúmenes (fuera del formset loop) #}
<div class="subcampo-row titulo-form-row titulo-template-490 d-none">
    <div class="subcampo-placeholder"></div>
    <input type="text" class="form-control titulo-input" placeholder="Clásicos de la literatura pianística venezolana…">
    <button type="button" class="subcampo-delete-btn delete-titulo-btn" title="Eliminar">
        <i class="bi bi-x-lg"></i>
    </button>
</div>

<div class="subcampo-row volumen-form-row volumen-template-490 d-none">
    <div class="subcampo-placeholder"></div>
    <input type="text" class="form-control volumen-input" placeholder="Vol. 8">
    <button type="button" class="subcampo-delete-btn delete-volumen-btn" title="Eliminar">
        <i class="bi bi-x-lg"></i>
    </button>
</div>

<script>
/**
 * Script para subcampos repetibles del campo 490 (Títulos y Volúmenes de serie)
 * La gestión del formset principal está en formset-manager.js
 */
(function() {
    function init490Subcampos() {
        const prefix = '{{ formset.prefix }}';
        const container = document.querySelector(`[data-formset-prefix="${prefix}"]`);
        if (!container || container.dataset.subcampos490Initialized) return;
        container.dataset.subcampos490Initialized = 'true';
        
        const tituloTemplate = document.querySelector('.titulo-template-490');
        const volumenTemplate = document.querySelector('.volumen-template-490');
        
        if (!tituloTemplate || !volumenTemplate) return;
        
        // Función para actualizar visibilidad de botones de eliminar
        // La primera fila (con .subcampo-add-btn) NUNCA se puede eliminar
        function updateDeleteButtonsVisibility(subcampoContainer) {
            const rows = subcampoContainer.querySelectorAll('.subcampo-row:not(.d-none)');
            rows.forEach((row) => {
                const deleteBtn = row.querySelector('.subcampo-delete-btn');
                if (deleteBtn) {
                    // Si es la primera fila (tiene el botón +), ocultar siempre
                    if (row.querySelector('.subcampo-add-btn')) {
                        deleteBtn.style.visibility = 'hidden';
                    } else {
                        // Las demás filas siempre pueden eliminarse
                        deleteBtn.style.visibility = 'visible';
                    }
                }
            });
        }
        
        container.addEventListener('click', function(e) {
            // Agregar Título
            const addTituloBtn = e.target.closest('.add-titulo-btn');
            if (addTituloBtn) {
                const mencionIndex = addTituloBtn.getAttribute('data-mencion-index');
                const titulosContainer = container.querySelector(`[data-titulos-container="${mencionIndex}"]`);
                
                if (titulosContainer && tituloTemplate) {
                    const newTitulo = tituloTemplate.cloneNode(true);
                    newTitulo.classList.remove('titulo-template-490', 'd-none');
                    
                    const input = newTitulo.querySelector('.titulo-input');
                    if (input) {
                        input.name = `titulo_mencion_490_${mencionIndex}_${Date.now()}`;
                    }
                    
                    titulosContainer.appendChild(newTitulo);
                    updateDeleteButtonsVisibility(titulosContainer);
                }
                return;
            }
            
            // Eliminar Título (solo si NO tiene el botón +)
            const deleteTituloBtn = e.target.closest('.delete-titulo-btn');
            if (deleteTituloBtn) {
                const tituloRow = deleteTituloBtn.closest('.titulo-form-row');
                if (tituloRow && !tituloRow.classList.contains('titulo-template-490') && !tituloRow.querySelector('.subcampo-add-btn')) {
                    const subcampoContainer = tituloRow.closest('.subcampo-repetible-container');
                    tituloRow.remove();
                    updateDeleteButtonsVisibility(subcampoContainer);
                }
                return;
            }
            
            // Agregar Volumen
            const addVolumenBtn = e.target.closest('.add-volumen-btn');
            if (addVolumenBtn) {
                const mencionIndex = addVolumenBtn.getAttribute('data-mencion-index');
                const volumenesContainer = container.querySelector(`[data-volumenes-container="${mencionIndex}"]`);
                
                if (volumenesContainer && volumenTemplate) {
                    const newVolumen = volumenTemplate.cloneNode(true);
                    newVolumen.classList.remove('volumen-template-490', 'd-none');
                    
                    const input = newVolumen.querySelector('.volumen-input');
                    if (input) {
                        input.name = `volumen_mencion_490_${mencionIndex}_${Date.now()}`;
                    }
                    
                    volumenesContainer.appendChild(newVolumen);
                    updateDeleteButtonsVisibility(volumenesContainer);
                }
                return;
            }
            
            // Eliminar Volumen (solo si NO tiene el botón +)
            const deleteVolumenBtn = e.target.closest('.delete-volumen-btn');
            if (deleteVolumenBtn) {
                const volumenRow = deleteVolumenBtn.closest('.volumen-form-row');
                if (volumenRow && !volumenRow.classList.contains('volumen-template-490') && !volumenRow.querySelector('.subcampo-add-btn')) {
                    const subcampoContainer = volumenRow.closest('.subcampo-repetible-container');
                    volumenRow.remove();
                    updateDeleteButtonsVisibility(subcampoContainer);
                }
                return;
            }
        });
        
        // Inicializar visibilidad de todos los contenedores de subcampos
        container.querySelectorAll('.subcampo-repetible-container').forEach(updateDeleteButtonsVisibility);
    }
    
    // Ejecutar cuando el DOM esté listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init490Subcampos);
    } else {
        setTimeout(init490Subcampos, 0);
    }
})();
</script>
