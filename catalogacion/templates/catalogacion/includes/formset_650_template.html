{% comment %}
Template para campo 650 - Materia (Tema)
Estilo unificado con 852 y 856
Campo repetible + subcampo $x repetible
Autocomplete con el mismo look (list-group / list-group-item) como en tu versi√≥n
Bot√≥n de agregar subdivisi√≥n a la izquierda usando input-group para estabilidad
{% endcomment %}

<div class="formset-container" data-formset-prefix="{{ formset.prefix }}">

    <!-- Management form -->
    <div style="display:none;">
        {% for field in formset.management_form %}
            {{ field }}
        {% endfor %}
    </div>

    <div class="formset-forms">

        {% for form in formset %}
        <div class="formset-row {% if form.instance.pk %}existing-form{% endif %} mb-3">

            {% for hidden in form.hidden_fields %}
                {{ hidden }}
            {% endfor %}

            {% if formset.can_delete %}
            <div class="d-none">{{ form.DELETE }}</div>
            {% endif %}

            <!-- Eliminar fila 650 -->
            <button type="button" class="delete-row-btn" title="Eliminar materia">
                <i class="bi bi-x-lg"></i>
            </button>

            <div class="campo-grid">

                <!-- 650 $a ‚Äì AUTOCOMPLETE -->
                <div class="col-full">
                    <label class="form-label small">650 $a ‚Äì Materia</label>
                    <div class="autocomplete-wrapper position-relative">
                        <input
                            type="text"
                            class="form-control materia-input"
                            name="{{ form.prefix }}-materia_texto"
                            placeholder="Escriba materia‚Ä¶"
                            autocomplete="off"
                            value="{% if form.instance.pk and form.materia.value %}{{ form.instance.materia.termino }}{% else %}M√∫sica para piano{% endif %}"
                        >
                        <input
                            type="hidden"
                            name="{{ form.prefix }}-materia"
                            class="materia-id"
                            value="{% if form.instance.pk and form.materia.value %}{{ form.instance.materia.id }}{% endif %}"
                        >
                        <div class="materia-suggestions autocomplete-suggestions list-group"></div>
                    </div>
                    {% if form.materia.errors %}
                    <div class="invalid-feedback d-block">{{ form.materia.errors }}</div>
                    {% endif %}
                </div>

                <!-- 650 $x ‚Äì Subdivisiones -->
                <div class="col-full">
                    <label class="form-label small">650 $x ‚Äì Subdivisi√≥n de materia</label>
                    <div class="subcampo-repetible-container subdivisiones-container"
                         data-subdivisiones-container="{{ forloop.counter0 }}"
                         data-borrador-container="subdivision_materia_650"
                         data-borrador-parent="{{ forloop.counter0 }}">

                        {% if form.instance.pk %}
                            {% for subdivision in form.instance.subdivisiones.all %}
                            <div class="subcampo-row subdivision-form-row d-flex mb-2">
                                <div class="input-group">
                                    {% if forloop.first %}
                                    <button type="button"
                                            class="subcampo-add-btn add-subdivision-btn btn btn-outline-primary"
                                            data-materia-index="{{ forloop.parentloop.counter0 }}"
                                            data-borrador-add="subdivision_materia_650"
                                            data-borrador-parent="{{ forloop.parentloop.counter0 }}"
                                            title="Agregar subdivisi√≥n">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                    {% else %}
                                    <div class="subcampo-placeholder"></div>
                                    {% endif %}

                                    <input type="text"
                                           class="form-control subdivision-input"
                                           name="subdivision_materia_650_{{ forloop.parentloop.counter0 }}_{{ subdivision.pk }}"
                                           value="{{ subdivision.subdivision }}"
                                           placeholder="Subdivisi√≥n de materia">

                                    <button type="button"
                                            class="subcampo-delete-btn delete-subdivision-btn btn btn-outline-danger"
                                            title="Eliminar"
                                            {% if forloop.first and forloop.last %}style="visibility:hidden;"{% endif %}>
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="subcampo-row subdivision-form-row d-flex mb-2">
                                <div class="input-group">
                                    <button type="button"
                                            class="subcampo-add-btn add-subdivision-btn btn btn-outline-primary"
                                            data-materia-index="{{ forloop.counter0 }}"
                                            data-borrador-add="subdivision_materia_650"
                                            data-borrador-parent="{{ forloop.counter0 }}"
                                            title="Agregar subdivisi√≥n">
                                        <i class="bi bi-plus"></i>
                                    </button>

                                    <input type="text"
                                           class="form-control subdivision-input"
                                           name="subdivision_materia_650_{{ forloop.counter0 }}_0"
                                           placeholder="Subdivisi√≥n de materia">

                                    <button type="button"
                                            class="subcampo-delete-btn delete-subdivision-btn btn btn-outline-danger"
                                            title="Eliminar"
                                            style="visibility:hidden;">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                            </div>
                        {% endif %}

                    </div>
                </div>

                <!-- 650 $z ‚Äì Subdivisi√≥n cronol√≥gica -->
                <div class="col-full">
                    <label class="form-label small">650 $z ‚Äì Subdivisi√≥n cronol√≥gica</label>
                    <div class="subcampo-repetible-container subdivisiones-cronologicas-container"
                         data-subdivisiones-cronologicas-container="{{ forloop.counter0 }}"
                         data-borrador-container="subdivision_cronologica_650"
                         data-borrador-parent="{{ forloop.counter0 }}">

                        {% if form.instance.pk %}
                            {% for subdivision in form.instance.subdivisiones_cronologicas.all %}
                            <div class="subcampo-row subdivision-cronologica-form-row d-flex mb-2">
                                <div class="input-group">
                                    {% if forloop.first %}
                                    <button type="button"
                                            class="subcampo-add-btn add-subdivision-cronologica-btn btn btn-outline-primary"
                                            data-materia-index="{{ forloop.parentloop.counter0 }}"
                                            title="Agregar subdivisi√≥n cronol√≥gica">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                    {% else %}
                                    <div class="subcampo-placeholder"></div>
                                    {% endif %}

                                    <input type="text"
                                           class="form-control subdivision-cronologica-input"
                                           name="subdivision_cronologica_650_{{ forloop.parentloop.counter0 }}_{{ subdivision.pk }}"
                                           value="{{ subdivision.subdivision }}"
                                           placeholder="Ej: Siglo XIX, 1800-1900">

                                    <button type="button"
                                            class="subcampo-delete-btn delete-subdivision-cronologica-btn btn btn-outline-danger"
                                            title="Eliminar"
                                            {% if forloop.first and forloop.last %}style="visibility:hidden;"{% endif %}>
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                            </div>
                            {% empty %}
                            <div class="subcampo-row subdivision-cronologica-form-row d-flex mb-2">
                                <div class="input-group">
                                    <button type="button"
                                            class="subcampo-add-btn add-subdivision-cronologica-btn btn btn-outline-primary"
                                            data-materia-index="{{ forloop.counter0 }}"
                                            title="Agregar subdivisi√≥n cronol√≥gica">
                                        <i class="bi bi-plus"></i>
                                    </button>

                                    <input type="text"
                                           class="form-control subdivision-cronologica-input"
                                           name="subdivision_cronologica_650_{{ forloop.counter0 }}_0"
                                           placeholder="Ej: Siglo XIX, 1800-1900">

                                    <button type="button"
                                            class="subcampo-delete-btn delete-subdivision-cronologica-btn btn btn-outline-danger"
                                            title="Eliminar"
                                            style="visibility:hidden;">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="subcampo-row subdivision-cronologica-form-row d-flex mb-2">
                                <div class="input-group">
                                    <button type="button"
                                            class="subcampo-add-btn add-subdivision-cronologica-btn btn btn-outline-primary"
                                            data-materia-index="{{ forloop.counter0 }}"
                                            title="Agregar subdivisi√≥n cronol√≥gica">
                                        <i class="bi bi-plus"></i>
                                    </button>

                                    <input type="text"
                                           class="form-control subdivision-cronologica-input"
                                           name="subdivision_cronologica_650_{{ forloop.counter0 }}_0"
                                           placeholder="Ej: Siglo XIX, 1800-1900">

                                    <button type="button"
                                            class="subcampo-delete-btn delete-subdivision-cronologica-btn btn btn-outline-danger"
                                            title="Eliminar"
                                            style="visibility:hidden;">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                            </div>
                        {% endif %}

                    </div>
                </div>

            </div>
        </div>
        {% endfor %}

        <!-- EMPTY FORM -->
        <div class="formset-row empty-form mb-3" style="display:none;">
            <button type="button" class="delete-row-btn" title="Eliminar materia">
                <i class="bi bi-x-lg"></i>
            </button>
            <div class="campo-grid">

                <div class="col-full">
                    <label class="form-label small">650 $a ‚Äì Encabezamiento de materia</label>
                    <div class="autocomplete-wrapper position-relative">
                        <input
                            type="text"
                            class="form-control materia-input"
                            name="{{ formset.prefix }}-__prefix__-materia_texto"
                            placeholder="Escriba materia‚Ä¶"
                            autocomplete="off"
                            value="M√∫sica para piano"
                        >
                        <input
                            type="hidden"
                            class="materia-id"
                            name="{{ formset.prefix }}-__prefix__-materia"
                        >
                        <div class="materia-suggestions autocomplete-suggestions list-group"></div>
                    </div>
                </div>

                <div class="col-full">
                    <label class="form-label small">650 $x ‚Äì Subdivisi√≥n de materia</label>
                    <div class="subcampo-repetible-container subdivisiones-container"
                         data-subdivisiones-container="__prefix__"
                         data-borrador-container="subdivision_materia_650"
                         data-borrador-parent="__prefix__">

                        <div class="subcampo-row subdivision-form-row d-flex mb-2">
                            <div class="input-group">
                                <button type="button"
                                        class="subcampo-add-btn add-subdivision-btn btn btn-outline-primary"
                                        data-materia-index="__prefix__"
                                        data-borrador-add="subdivision_materia_650"
                                        data-borrador-parent="__prefix__"
                                        title="Agregar subdivisi√≥n">
                                    <i class="bi bi-plus"></i>
                                </button>

                                <input type="text"
                                       class="form-control subdivision-input"
                                       name="subdivision_materia_650___prefix___0"
                                       placeholder="Subdivisi√≥n de materia">

                                <button type="button"
                                        class="subcampo-delete-btn delete-subdivision-btn btn btn-outline-danger"
                                        title="Eliminar"
                                        style="visibility:hidden;">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="col-full">
                    <label class="form-label small">650 $z ‚Äì Subdivisi√≥n cronol√≥gica</label>
                    <div class="subcampo-repetible-container subdivisiones-cronologicas-container"
                         data-subdivisiones-cronologicas-container="__prefix__"
                         data-borrador-container="subdivision_cronologica_650"
                         data-borrador-parent="__prefix__">

                        <div class="subcampo-row subdivision-cronologica-form-row d-flex mb-2">
                            <div class="input-group">
                                <button type="button"
                                        class="subcampo-add-btn add-subdivision-cronologica-btn btn btn-outline-primary"
                                        data-materia-index="__prefix__"
                                        title="Agregar subdivisi√≥n cronol√≥gica">
                                    <i class="bi bi-plus"></i>
                                </button>

                                <input type="text"
                                       class="form-control subdivision-cronologica-input"
                                       name="subdivision_cronologica_650___prefix___0"
                                       placeholder="Ej: Siglo XIX, 1800-1900">

                                <button type="button"
                                        class="subcampo-delete-btn delete-subdivision-cronologica-btn btn btn-outline-danger"
                                        title="Eliminar"
                                        style="visibility:hidden;">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        </div>

                    </div>
                </div>

            </div>
        </div>

    </div>
</div>

<!-- ====================== JS ====================== -->
<script>
(function() {
    const PREFIX = "{{ formset.prefix }}";
    const container = document.querySelector(`[data-formset-prefix="${PREFIX}"]`);
    if (!container) return;

    function initMateriaAutocomplete(input) {
        if (!input) {
            console.log('üö´ Input es null o undefined');
            return;
        }
        
        // üî• CLAVE: Verificar el flag correctamente
        if (input.dataset.materiaInit === "1") {
            console.log('üö´ Input ya est√° inicializado, saltando:', input);
            return;
        }
        
        console.log('‚úÖ Inicializando autocomplete para input:', input);
        input.dataset.materiaInit = "1";

        const wrapper = input.closest(".autocomplete-wrapper");
        if (!wrapper) {
            console.log('üö´ No se encontr√≥ wrapper para input:', input);
            return;
        }
        
        const suggestionsBox = wrapper.querySelector(".materia-suggestions");
        const hiddenIdInput = wrapper.querySelector(".materia-id");
        
        if (!suggestionsBox) {
            console.log('üö´ No se encontr√≥ suggestionsBox para input:', input);
            return;
        }
        
        if (!hiddenIdInput) {
            console.log('üö´ No se encontr√≥ hiddenIdInput para input:', input);
            return;
        }
        
        console.log('‚úÖ Todos los elementos encontrados para input:', input);
        
        let debounceTimer = null, selectedIndex = -1;

        function hide() { suggestionsBox.classList.remove("show"); suggestionsBox.innerHTML = ""; selectedIndex=-1; }
        function marcar(items){ items.forEach((el,i)=>el.classList.toggle("selected", i===selectedIndex)); }
        function seleccionar(item){
            input.value = item.text;
            hiddenIdInput.value = item.id || "";
            hiddenIdInput.dataset.nuevo = item.nuevo ? "1":"0";
            hiddenIdInput.dispatchEvent(new Event("change"));
            hide();
        }
        function mostrar(results, query){
            suggestionsBox.innerHTML="";
            selectedIndex=-1;
            if(!results.length){
                const div = document.createElement("div");
                div.className="autocomplete-item autocomplete-item-new list-group-item";
                div.innerHTML = `<i class="bi bi-plus-circle me-2"></i> Crear: "${query}"`;
                div.onclick = ()=>seleccionar({id:"",text:query,nuevo:true});
                suggestionsBox.appendChild(div);
            } else {
                results.forEach(r=>{
                    const div=document.createElement("div");
                    div.className="autocomplete-item list-group-item";
                    div.innerHTML=`<strong>${r.text}</strong>`;
                    div.onclick=()=>seleccionar({id:r.id,text:r.text,nuevo:false});
                    suggestionsBox.appendChild(div);
                });
                const nuevo=document.createElement("div");
                nuevo.className="autocomplete-item autocomplete-item-new list-group-item";
                nuevo.innerHTML=`<i class="bi bi-plus-circle me-2"></i> Crear: "${query}"`;
                nuevo.onclick=()=>seleccionar({id:"",text:query,nuevo:true});
                suggestionsBox.appendChild(nuevo);
            }
            suggestionsBox.classList.add("show");
        }
        function buscar(q){ 
            console.log('Buscando materia con query:', q);
            fetch(`/catalogacion/api/autocompletar/materia/?q=${encodeURIComponent(q)}`)
                .then(r=>r.json()).then(d=>{
                    console.log('Respuesta recibida:', d);
                    mostrar(d.results||[],q);
                }).catch(err=>{
                    console.error('Error en b√∫squeda:', err);
                    hide();
                }); 
        }

        input.addEventListener("input", e=>{
            const q = input.value.trim();
            hiddenIdInput.value = ""; 
            hiddenIdInput.removeAttribute("data-nuevo");
            
            console.log('üîç Input event - query:', q, 'input:', input);
            
            if(q.length < 2){ 
                console.log('üö´ Query muy corto, ocultando sugerencias');
                hide(); 
                return; 
            }
            
            clearTimeout(debounceTimer); 
            debounceTimer = setTimeout(() => {
                console.log('üîç Iniciando b√∫squeda para:', q);
                buscar(q);
            }, 250);
        });

        input.addEventListener("keydown", e=>{
            const items = suggestionsBox.querySelectorAll(".autocomplete-item");
            if(!items.length) return;
            if(e.key==="ArrowDown"){ e.preventDefault(); selectedIndex=Math.min(selectedIndex+1,items.length-1); marcar(items); }
            if(e.key==="ArrowUp"){ e.preventDefault(); selectedIndex=Math.max(selectedIndex-1,0); marcar(items); }
            if(e.key==="Enter"){ e.preventDefault(); if(items[selectedIndex]) items[selectedIndex].click(); }
            if(e.key==="Escape") hide();
        });

        document.addEventListener("click", e=>{ if(!wrapper.contains(e.target)) hide(); });
    }

    function updateDeleteVisibility(cont){
        const rows=cont.querySelectorAll(".subdivision-form-row");
        rows.forEach((row, idx)=>{
            const btn=row.querySelector(".delete-subdivision-btn");
            if(btn) btn.style.visibility=(idx===0)?"hidden":"visible";
        });
    }

    function updateDeleteVisibilityCronologica(cont){
        const rows=cont.querySelectorAll(".subdivision-cronologica-form-row");
        rows.forEach((row, idx)=>{
            const btn=row.querySelector(".delete-subdivision-cronologica-btn");
            if(btn) btn.style.visibility=(idx===0)?"hidden":"visible";
        });
    }

    container.addEventListener("click", e=>{
        // Handler para $x - Subdivisi√≥n de materia
        const addBtn=e.target.closest(".add-subdivision-btn");
        if(addBtn){
            const cont=addBtn.closest(".subdivisiones-container");
            const index=cont.dataset.subdivisionesContainer;
            const newInput=document.createElement("div");
            newInput.className="subcampo-row subdivision-form-row d-flex mb-2";
            newInput.innerHTML=`
                <div class="input-group">
                    <button type="button" class="subcampo-add-btn add-subdivision-btn btn btn-outline-primary"
                        data-materia-index="${index}"
                        data-borrador-add="subdivision_materia_650"
                        data-borrador-parent="${index}"
                        title="Agregar subdivisi√≥n"><i class="bi bi-plus"></i></button>
                    <input type="text" class="form-control subdivision-input" name="subdivision_materia_650_${index}_${Date.now()}" placeholder="Subdivisi√≥n de materia">
                    <button type="button" class="subcampo-delete-btn delete-subdivision-btn btn btn-outline-danger" title="Eliminar"><i class="bi bi-x-lg"></i></button>
                </div>
            `;
            cont.appendChild(newInput);
            updateDeleteVisibility(cont);
            return;
        }

        // Handler para $z - Subdivisi√≥n cronol√≥gica
        const addBtnCrono=e.target.closest(".add-subdivision-cronologica-btn");
        if(addBtnCrono){
            const cont=addBtnCrono.closest(".subdivisiones-cronologicas-container");
            const index=cont.dataset.subdivisionesCronologicasContainer;
            const newInput=document.createElement("div");
            newInput.className="subcampo-row subdivision-cronologica-form-row d-flex mb-2";
            newInput.innerHTML=`
                <div class="input-group">
                    <button type="button" class="subcampo-add-btn add-subdivision-cronologica-btn btn btn-outline-primary"
                        data-materia-index="${index}"
                        title="Agregar subdivisi√≥n cronol√≥gica"><i class="bi bi-plus"></i></button>
                    <input type="text" class="form-control subdivision-cronologica-input" name="subdivision_cronologica_650_${index}_${Date.now()}" placeholder="Ej: Siglo XIX, 1800-1900">
                    <button type="button" class="subcampo-delete-btn delete-subdivision-cronologica-btn btn btn-outline-danger" title="Eliminar"><i class="bi bi-x-lg"></i></button>
                </div>
            `;
            cont.appendChild(newInput);
            updateDeleteVisibilityCronologica(cont);
            return;
        }

        const delBtn=e.target.closest(".delete-subdivision-btn");
        if(delBtn){
            const row=delBtn.closest(".subdivision-form-row");
            const cont=delBtn.closest(".subdivisiones-container");
            if(row) row.remove();
            updateDeleteVisibility(cont);
            return;
        }

        const delBtnCrono=e.target.closest(".delete-subdivision-cronologica-btn");
        if(delBtnCrono){
            const row=delBtnCrono.closest(".subdivision-cronologica-form-row");
            const cont=delBtnCrono.closest(".subdivisiones-cronologicas-container");
            if(row) row.remove();
            updateDeleteVisibilityCronologica(cont);
            return;
        }

        const delRowBtn=e.target.closest(".delete-row-btn");
        if(delRowBtn){
            const row=delRowBtn.closest(".formset-row");
            if(row) row.remove();
        }
    });

    container.addEventListener('formset:added', (ev) => {
        if (!ev || !ev.detail || ev.detail.prefix !== PREFIX) return;
        
        console.log('formset:added evento recibido en 650', ev.detail);
        
        // small timeout to let DOM settle
        setTimeout(() => {
            // üî• CLAVE: Buscar SOLO en el nuevo formulario agregado
            const newForm = ev.detail.newForm;
            if (!newForm) {
                console.log('üö´ No se encontr√≥ newForm en el evento');
                return;
            }
            
            console.log('üîç Nuevo formulario encontrado:', newForm);
            
            // Inicializar autocomplete SOLO en los inputs del nuevo formulario
            const newInputs = newForm.querySelectorAll(".materia-input");
            console.log('Inputs de materia encontrados en nuevo formulario:', newInputs.length);
            
            newInputs.forEach((input, index) => {
                console.log(`Inicializando input ${index} del nuevo formulario:`, input);
                // üî• CLAVE: Limpiar el flag para permitir reinicializaci√≥n
                delete input.dataset.materiaInit;
                initMateriaAutocomplete(input);
            });
            
            // Inicializar subdivisiones en las nuevas filas
            const subdivisionContainers = newForm.querySelectorAll(".subdivisiones-container");
            console.log('Contenedores de subdivisiones encontrados en nuevo formulario:', subdivisionContainers.length);
            subdivisionContainers.forEach(updateDeleteVisibility);
        }, 50);
    });

    // Inicializar autocomplete para inputs existentes
    container.querySelectorAll(".materia-input").forEach(initMateriaAutocomplete);

})();
</script>
