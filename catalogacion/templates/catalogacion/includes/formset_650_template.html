{% comment %}
Template para campo 650 - Materia (Tema)
El campo 650 es repetible y contiene subcampo repetible ($x subdivisi√≥n de materia)
{% endcomment %}

<div class="formset-container" data-formset-prefix="{{ formset.prefix }}">

    <!-- Management form -->
    <div style="display:none;">
        {% for field in formset.management_form %}
        {{ field }}
        {% endfor %}
    </div>

    

    <div class="formset-forms">

        {% for form in formset %}
        {% if form.instance.pk or forloop.counter0 == 0 %}

        <div class="formset-row {% if form.instance.pk %}existing-form{% endif %} mb-3">

            {% if form.instance.pk %}
            <input type="hidden" name="{{ form.prefix }}-id" value="{{ form.instance.pk }}">
            {% endif %}

            {% if formset.can_delete %}
            <div class="d-none">
                {{ form.DELETE }}
            </div>
            {% endif %}

            <button type="button" class="delete-row-btn">
                <i class="bi bi-x-lg"></i>
            </button>

            <div class="campo-grid">

                <!-- üíö CAMPO 650 $a ‚Äì AUTOCOMPLETE -->
                <div class="col-full">
                    <label class="form-label">650 $a ‚Äì Encabezamiento de materia</label>

                    <div class="autocomplete-wrapper position-relative">
                        <!-- campo visible -->
                        <input
                            type="text"
                            class="form-control materia-input"
                            name="{{ form.prefix }}-materia_texto"
                            placeholder="Escriba materia‚Ä¶"
                            autocomplete="off"
                            value="{% if form.instance.pk and form.materia.value %}{{ form.instance.materia.termino }}{% endif %}"
                        >

                        <!-- campo oculto para guardar ID -->
                        <input
                            type="hidden"
                            name="{{ form.prefix }}-materia"
                            class="materia-id"
                            value="{% if form.instance.pk and form.materia.value %}{{ form.instance.materia.id }}{% endif %}"
                        >

                        <div class="materia-suggestions autocomplete-suggestions list-group"></div>
                    </div>

                    {% if form.materia.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.materia.errors }}
                    </div>
                    {% endif %}
                </div>

                <!-- Bot√≥n subdivisi√≥n -->
                <div class="col-full mt-2">
                    <button
                        type="button"
                        class="btn btn-sm btn-outline-primary add-subdivision-btn w-100"
                        data-materia-index="{{ forloop.counter0 }}"
                    >
                        <i class="bi bi-plus-circle"></i> Agregar Subdivisi√≥n ($x)
                    </button>
                </div>

                <!-- Subdivisiones existentes -->
                <div
                    class="col-full subdivisiones-container"
                    data-subdivisiones-container="{{ forloop.counter0 }}"
                >

                    {% if form.instance.pk %}
                    {% for subdivision in form.instance.subdivisiones.all %}
                    <div class="subdivision-form-row">
                        <div class="d-flex flex-column w-100 mb-2">
                            <label class="form-label small">650 $x ‚Äì Subdivisi√≥n de materia</label>
                            <div class="d-flex gap-2 align-items-center">

                                <input
                                    type="text"
                                    class="form-control subdivision-input"
                                    name="subdivision_materia_650_{{ forloop.parentloop.counter0 }}_{{ subdivision.pk }}"
                                    value="{{ subdivision.subdivision }}"
                                    placeholder="Subdivisi√≥n de materia"
                                >

                                <button type="button" class="btn btn-sm btn-outline-danger delete-subdivision-btn">
                                    <i class="bi bi-trash"></i>
                                </button>

                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% endif %}
                </div>

            </div>
        </div>

        {% endif %}
        {% endfor %}

        <!-- TEMPLATE vac√≠o -->
        <div class="formset-row empty-form mb-3" style="display:none;">
            <button type="button" class="delete-row-btn">
                <i class="bi bi-x-lg"></i>
            </button>

            <div class="campo-grid">

                <!-- Autocomplete vac√≠o -->
                <div class="col-full">
                    <label class="form-label">650 $a ‚Äì Encabezamiento de materia</label>

                    <div class="autocomplete-wrapper position-relative">
                        <input
                            type="text"
                            class="form-control materia-input"
                            name="{{ formset.prefix }}-__prefix__-materia_texto"
                            placeholder="Escriba materia‚Ä¶"
                            autocomplete="off"
                        >

                        <input
                            type="hidden"
                            class="materia-id"
                            name="{{ formset.prefix }}-__prefix__-materia"
                        >

                        <div class="materia-suggestions autocomplete-suggestions list-group"></div>
                    </div>
                </div>

                <div class="col-full mt-2">
                    <button
                        type="button"
                        class="btn btn-sm btn-outline-primary add-subdivision-btn w-100"
                        data-materia-index="__prefix__"
                    >
                        <i class="bi bi-plus-circle"></i> Agregar Subdivisi√≥n ($x)
                    </button>
                </div>

                <div
                    class="col-full subdivisiones-container"
                    data-subdivisiones-container="__prefix__"
                >
                </div>
            </div>
        </div>

    </div>
</div>

<!-- TEMPLATE global subdivisi√≥n -->
<div class="subdivision-form-row subdivision-template-650 d-none">
    <div class="d-flex flex-column w-100 mb-2">
        <label class="form-label small">650 $x ‚Äì Subdivisi√≥n de materia</label>
        <div class="d-flex gap-2 align-items-center">
            <input type="text" class="form-control subdivision-input" placeholder="Subdivisi√≥n de materia">
            <button type="button" class="btn btn-sm btn-outline-danger delete-subdivision-btn">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    </div>
</div>

<!-- SCRIPT AUTOCOMPLETE MATERIAS (tipo compositor) -->
<script>
    (function () {

        function initMateriaAutocomplete(input) {
            // evita doble inicializaci√≥n al clonar filas
            if (input.dataset.materiaInit === "1") {
                return;
            }
            input.dataset.materiaInit = "1";

            const wrapper = input.closest(".autocomplete-wrapper");
            const suggestionsBox = wrapper.querySelector('.materia-suggestions');
            const hiddenIdInput = wrapper.querySelector('.materia-id');

            let debounceTimer = null;
            let selectedIndex = -1;

            function hide() {
                suggestionsBox.classList.remove("show");
                suggestionsBox.innerHTML = "";
                selectedIndex = -1;
            }

            function marcar(items) {
                items.forEach((el, i) => {
                    el.classList.toggle("selected", i === selectedIndex);
                });
            }

            function seleccionar(item) {
                // CAMBIO: item.text en vez de item.termino
                input.value = item.text;

                if (item.nuevo) {
                    // nuevo t√©rmino => sin ID, backend lo crea con materia_texto
                    hiddenIdInput.value = "";
                    hiddenIdInput.dataset.nuevo = "1";
                } else {
                    hiddenIdInput.value = item.id || "";
                    hiddenIdInput.dataset.nuevo = "0";
                }

                // notificar cambio al formset
                hiddenIdInput.dispatchEvent(new Event("change"));
                hide();
            }

            function mostrar(resultados, query) {
                suggestionsBox.innerHTML = "";
                selectedIndex = -1;

                if (!resultados || resultados.length === 0) {
                    suggestionsBox.innerHTML = `
                        <div class="autocomplete-item autocomplete-item-new list-group-item">
                            <i class="bi bi-plus-circle me-2"></i> Crear: "${query}"
                        </div>`;
                    const nuevoEl = suggestionsBox.querySelector(".autocomplete-item-new");
                    nuevoEl.addEventListener("click", function () {
                        seleccionar({ id: "", text: query, nuevo: true });
                    });
                } else {
                    resultados.forEach(r => {
                        const item = document.createElement("div");
                        item.className = "autocomplete-item list-group-item";
                        item.innerHTML = `<strong>${r.text}</strong>`;
                        item.addEventListener("click", () => seleccionar({ id: r.id, text: r.text, nuevo: false }));
                        suggestionsBox.appendChild(item);
                    });

                    const nuevo = document.createElement("div");
                    nuevo.className = "autocomplete-item autocomplete-item-new list-group-item";
                    nuevo.innerHTML = `<i class="bi bi-plus-circle me-2"></i> Crear: "${query}"`;
                    nuevo.addEventListener("click", () => seleccionar({ id: "", text: query, nuevo: true }));
                    suggestionsBox.appendChild(nuevo);
                }

                suggestionsBox.classList.add("show");
            }

            function buscar(query) {
                fetch(`/catalogacion/api/autocompletar/materia/?q=${encodeURIComponent(query)}`)
                    .then(r => r.json())
                    .then(data => {
                        // se espera formato {results: [{id, text}, ...]}
                        mostrar(data.results || [], query);
                    })
                    .catch(() => {
                        hide();
                    });
            }

            input.addEventListener("input", function () {
                const q = input.value.trim();

                // al escribir, limpiamos cualquier ID previo
                hiddenIdInput.value = "";
                hiddenIdInput.removeAttribute("data-nuevo");

                if (q.length < 2) {
                    hide();
                    return;
                }

                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => buscar(q), 250);
            });

            input.addEventListener("keydown", function (e) {
                const items = suggestionsBox.querySelectorAll(".autocomplete-item");
                if (!items.length) return;

                if (e.key === "ArrowDown") {
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                    marcar(items);
                }
                if (e.key === "ArrowUp") {
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, 0);
                    marcar(items);
                }
                if (e.key === "Enter") {
                    e.preventDefault();
                    if (items[selectedIndex]) items[selectedIndex].click();
                }
                if (e.key === "Escape") {
                    hide();
                }
            });

            // cerrar si se hace click fuera
            document.addEventListener("click", function (e) {
                if (!wrapper.contains(e.target)) {
                    hide();
                }
            });
        }

        // inicializar los existentes
        document.querySelectorAll('.materia-input').forEach(initMateriaAutocomplete);

        // cuando se agrega una nueva fila de formset, volver a inicializar
        document.addEventListener("click", function (e) {
            if (e.target.closest('.add-form-row')) {
                setTimeout(() => {
                    document.querySelectorAll('.materia-input').forEach(initMateriaAutocomplete);
                }, 100);
            }
        });

    })();
</script>

<!-- SCRIPT SUBDIVISIONES -->
<script>
(function () {
    const prefix = '{{ formset.prefix }}';
    const container = document.querySelector(`[data-formset-prefix="${prefix}"]`);
    if (!container) return;

    const totalFormsInput = container.querySelector(`#id_${prefix}-TOTAL_FORMS`);
    const formsContainer = container.querySelector('.formset-forms');
    const emptyForm = formsContainer.querySelector('.empty-form');
    const subdivisionTemplate = document.querySelector('.subdivision-template-650');

    // üîπ Agregar fila 650 (Materia)
    container.addEventListener("click", function(e) {

        // ‚ûï Agregar materia
        if (e.target.closest('.add-form-row')) {
            const total = parseInt(totalFormsInput.value);
            const newForm = emptyForm.cloneNode(true);
            newForm.innerHTML = newForm.innerHTML.replace(/__prefix__/g, total);
            newForm.classList.remove('empty-form');
            newForm.style.display = '';

            // Reinicializar autocomplete en la nueva fila
            setTimeout(() => {
                newForm.querySelectorAll('.materia-input').forEach(i => initMateriaAutocomplete(i));
            }, 50);

            formsContainer.insertBefore(newForm, emptyForm);
            totalFormsInput.value = total + 1;
<<<<<<< HEAD
        }
=======
        });

        container.addEventListener('click', function (e) {
            const del = e.target.closest('.delete-row-btn');
            if (del) {
                const row = del.closest('.formset-row');
                if (!row.classList.contains('empty-form')) {
                    const deleteInput = row.querySelector('input[name*="DELETE"]');
                    if (row.classList.contains('existing-form') && deleteInput) {
                        deleteInput.checked = !deleteInput.checked;
                        row.style.opacity = deleteInput.checked ? "0.4" : "1";
                    } else {
                        row.remove();
                        totalFormsInput.value = parseInt(totalFormsInput.value) - 1;
                    }
                }
            }
>>>>>>> 370977b4ccab212272c5d4f1b72cad023bb6a652

        // ‚ûï Agregar subdivisi√≥n ($x)
        if (e.target.closest('.add-subdivision-btn')) {
            const btn = e.target.closest('.add-subdivision-btn');
            const index = btn.dataset.materiaIndex;
            const cont = container.querySelector(`[data-subdivisiones-container="${index}"]`);

            const sub = subdivisionTemplate.cloneNode(true);
            sub.classList.remove('subdivision-template-650', 'd-none');
            sub.querySelector('.subdivision-input')
               .name = `subdivision_materia_650_${index}_${Date.now()}`;

            cont.appendChild(sub);
        }

        // ‚ùå Eliminar subdivisi√≥n
        if (e.target.closest('.delete-subdivision-btn')) {
            e.target.closest('.subdivision-form-row').remove();
        }

        // ‚ùå Eliminar fila completa
        if (e.target.closest('.delete-row-btn')) {
            const row = e.target.closest('.formset-row');
            if (!row.classList.contains('empty-form')) {
                row.remove();
                totalFormsInput.value = parseInt(totalFormsInput.value) - 1;
            }
<<<<<<< HEAD
        }
    });
})();
=======

            const delSub = e.target.closest('.delete-subdivision-btn');
            if (delSub) {
                delSub.closest('.subdivision-form-row').remove();
            }

        });

    })();
>>>>>>> 370977b4ccab212272c5d4f1b72cad023bb6a652
</script>
