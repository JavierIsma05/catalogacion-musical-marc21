{% comment %}
Template para campo 650 - Materia (Tema)
Estilo unificado con 852 y 856
Campo repetible + subcampo $x repetible
L√≥gica intacta
Autocomplete con el mismo look (list-group / list-group-item) como en tu versi√≥n
{% endcomment %}

<div class="formset-container" data-formset-prefix="{{ formset.prefix }}">

            <!-- Management form -->
            <div style="display:none;">
                {% for field in formset.management_form %}
                    {{ field }}
                {% endfor %}
            </div>

            <div class="formset-forms">

                {% for form in formset %}
                <div class="formset-row {% if form.instance.pk %}existing-form{% endif %} mb-3">

                    {% for hidden in form.hidden_fields %}
                        {{ hidden }}
                    {% endfor %}

                    {% if formset.can_delete %}
                    <div class="d-none">
                        {{ form.DELETE }}
                    </div>
                    {% endif %}

                    <!-- ‚ùå Eliminar fila 650 -->
                    <button type="button" class="delete-row-btn" title="Eliminar materia">
                        <i class="bi bi-x-lg"></i>
                    </button>

                    <div class="campo-grid">

                        <!-- üíö 650 $a ‚Äì AUTOCOMPLETE (MISMO MARKUP QUE TU PLANTILLA) -->
                        <div class="col-full">
                            <label class="form-label small">650 $a ‚Äì Materia</label>

                            <div class="autocomplete-wrapper position-relative">
                                <!-- campo visible -->
                                <input
                                    type="text"
                                    class="form-control materia-input"
                                    name="{{ form.prefix }}-materia_texto"
                                    placeholder="Escriba materia‚Ä¶"
                                    autocomplete="off"
                                    value="{% if form.instance.pk and form.materia.value %}{{ form.instance.materia.termino }}{% endif %}"
                                >

                                <!-- campo oculto para guardar ID -->
                                <input
                                    type="hidden"
                                    name="{{ form.prefix }}-materia"
                                    class="materia-id"
                                    value="{% if form.instance.pk and form.materia.value %}{{ form.instance.materia.id }}{% endif %}"
                                >

                                <!-- ‚úÖ conservar list-group para el look -->
                                <div class="materia-suggestions autocomplete-suggestions list-group"></div>
                            </div>

                            {% if form.materia.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.materia.errors }}
                            </div>
                            {% endif %}
                        </div>

                        <!-- ‚úÖ 650 $x ‚Äì Subdivisiones (estilo 852/856) -->
                        <div class="col-full">
                            <label class="form-label small">650 $x ‚Äì Subdivisi√≥n de materia</label>

                            <div class="subcampo-repetible-container subdivisiones-container"
                                data-subdivisiones-container="{{ forloop.counter0 }}">

                                {% if form.instance.pk %}
                                    {% for subdivision in form.instance.subdivisiones.all %}
                                    <div class="subcampo-row subdivision-form-row">

                                        {% if forloop.first %}
                                        <button type="button"
                                                class="subcampo-add-btn add-subdivision-btn"
                                                data-materia-index="{{ forloop.parentloop.counter0 }}"
                                                title="Agregar subdivisi√≥n">
                                            <i class="bi bi-plus"></i>
                                        </button>
                                        {% else %}
                                        <div class="subcampo-placeholder"></div>
                                        {% endif %}

                                        <input
                                            type="text"
                                            class="form-control subdivision-input"
                                            name="subdivision_materia_650_{{ forloop.parentloop.counter0 }}_{{ subdivision.pk }}"
                                            value="{{ subdivision.subdivision }}"
                                            placeholder="Subdivisi√≥n de materia"
                                        >

                                        <button type="button"
                                                class="subcampo-delete-btn delete-subdivision-btn"
                                                title="Eliminar"
                                                {% if forloop.first and forloop.last %}style="visibility:hidden;"{% endif %}>
                                            <i class="bi bi-x-lg"></i>
                                        </button>

                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="subcampo-row subdivision-form-row">
                                        <button type="button"
                                                class="subcampo-add-btn add-subdivision-btn"
                                                data-materia-index="{{ forloop.counter0 }}"
                                                title="Agregar subdivisi√≥n">
                                            <i class="bi bi-plus"></i>
                                        </button>

                                        <input type="text"
                                            class="form-control subdivision-input"
                                            name="subdivision_materia_650_{{ forloop.counter0 }}_0"
                                            placeholder="Subdivisi√≥n de materia">

                                        <button type="button"
                                                class="subcampo-delete-btn delete-subdivision-btn"
                                                title="Eliminar"
                                                style="visibility:hidden;">
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                    </div>
                                {% endif %}

                            </div>
                        </div>

                    </div>
                </div>
                {% endfor %}

                <!-- EMPTY FORM -->
                <div class="formset-row empty-form mb-3" style="display:none;">
                    <button type="button" class="delete-row-btn" title="Eliminar materia">
                        <i class="bi bi-x-lg"></i>
                    </button>

                    <div class="campo-grid">

                        <div class="col-full">
                            <label class="form-label small">650 $a ‚Äì Encabezamiento de materia</label>

                            <div class="autocomplete-wrapper position-relative">
                                <input
                                    type="text"
                                    class="form-control materia-input"
                                    name="{{ formset.prefix }}-__prefix__-materia_texto"
                                    placeholder="Escriba materia‚Ä¶"
                                    autocomplete="off"
                                >

                                <input
                                    type="hidden"
                                    class="materia-id"
                                    name="{{ formset.prefix }}-__prefix__-materia"
                                >

                                <!-- ‚úÖ conservar list-group para el look -->
                                <div class="materia-suggestions autocomplete-suggestions list-group"></div>
                            </div>
                        </div>

                        <div class="col-full">
                            <label class="form-label small">650 $x ‚Äì Subdivisi√≥n de materia</label>

                            <div class="subcampo-repetible-container subdivisiones-container"
                                data-subdivisiones-container="__prefix__">

                                <div class="subcampo-row subdivision-form-row">
                                    <button type="button"
                                            class="subcampo-add-btn add-subdivision-btn"
                                            data-materia-index="__prefix__"
                                            title="Agregar subdivisi√≥n">
                                        <i class="bi bi-plus"></i>
                                    </button>

                                    <input type="text"
                                        class="form-control subdivision-input"
                                        name="subdivision_materia_650___prefix___0"
                                        placeholder="Subdivisi√≥n de materia">

                                    <button type="button"
                                            class="subcampo-delete-btn delete-subdivision-btn"
                                            title="Eliminar"
                                            style="visibility:hidden;">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

            </div>
        </div>


<!-- ‚úÖ AUTOCOMPLETE: tu script original (sin tocarlo) -->
<script>
    (function () {

        function initMateriaAutocomplete(input) {
            if (input.dataset.materiaInit === "1") return;
            input.dataset.materiaInit = "1";

            const wrapper = input.closest(".autocomplete-wrapper");
            const suggestionsBox = wrapper.querySelector('.materia-suggestions');
            const hiddenIdInput = wrapper.querySelector('.materia-id');

            let debounceTimer = null;
            let selectedIndex = -1;

            function hide() {
                suggestionsBox.classList.remove("show");
                suggestionsBox.innerHTML = "";
                selectedIndex = -1;
            }

            function marcar(items) {
                items.forEach((el, i) => {
                    el.classList.toggle("selected", i === selectedIndex);
                });
            }

            function seleccionar(item) {
                input.value = item.text;

                if (item.nuevo) {
                    hiddenIdInput.value = "";
                    hiddenIdInput.dataset.nuevo = "1";
                } else {
                    hiddenIdInput.value = item.id || "";
                    hiddenIdInput.dataset.nuevo = "0";
                }

                hiddenIdInput.dispatchEvent(new Event("change"));
                hide();
            }

            function mostrar(resultados, query) {
                suggestionsBox.innerHTML = "";
                selectedIndex = -1;

                if (!resultados || resultados.length === 0) {
                    suggestionsBox.innerHTML = `
                        <div class="autocomplete-item autocomplete-item-new list-group-item">
                            <i class="bi bi-plus-circle me-2"></i> Crear: "${query}"
                        </div>`;
                    const nuevoEl = suggestionsBox.querySelector(".autocomplete-item-new");
                    nuevoEl.addEventListener("click", function () {
                        seleccionar({ id: "", text: query, nuevo: true });
                    });
                } else {
                    resultados.forEach(r => {
                        const item = document.createElement("div");
                        item.className = "autocomplete-item list-group-item";
                        item.innerHTML = `<strong>${r.text}</strong>`;
                        item.addEventListener("click", () => seleccionar({ id: r.id, text: r.text, nuevo: false }));
                        suggestionsBox.appendChild(item);
                    });

                    const nuevo = document.createElement("div");
                    nuevo.className = "autocomplete-item autocomplete-item-new list-group-item";
                    nuevo.innerHTML = `<i class="bi bi-plus-circle me-2"></i> Crear: "${query}"`;
                    nuevo.addEventListener("click", () => seleccionar({ id: "", text: query, nuevo: true }));
                    suggestionsBox.appendChild(nuevo);
                }

                suggestionsBox.classList.add("show");
            }

            function buscar(query) {
                fetch(`/catalogacion/api/autocompletar/materia/?q=${encodeURIComponent(query)}`)
                    .then(r => r.json())
                    .then(data => {
                        mostrar(data.results || [], query);
                    })
                    .catch(() => hide());
            }

            input.addEventListener("input", function () {
                const q = input.value.trim();

                hiddenIdInput.value = "";
                hiddenIdInput.removeAttribute("data-nuevo");

                if (q.length < 2) {
                    hide();
                    return;
                }

                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => buscar(q), 250);
            });

            input.addEventListener("keydown", function (e) {
                const items = suggestionsBox.querySelectorAll(".autocomplete-item");
                if (!items.length) return;

                if (e.key === "ArrowDown") {
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                    marcar(items);
                }
                if (e.key === "ArrowUp") {
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, 0);
                    marcar(items);
                }
                if (e.key === "Enter") {
                    e.preventDefault();
                    if (items[selectedIndex]) items[selectedIndex].click();
                }
                if (e.key === "Escape") hide();
            });

            document.addEventListener("click", function (e) {
                if (!wrapper.contains(e.target)) hide();
            });
        }

        // inicializar existentes
        document.querySelectorAll('.materia-input').forEach(initMateriaAutocomplete);

        // si tu bot√≥n global de agregar fila usa .campo-add-btn, reinicializamos luego de clonar
        document.addEventListener("click", function (e) {
            if (e.target.closest('.campo-add-btn')) {
                setTimeout(() => {
                    document.querySelectorAll('.materia-input').forEach(initMateriaAutocomplete);
                }, 80);
            }
        });

        // EXPO: para el script de subdivisiones (si lo necesitas)
        window.initMateriaAutocomplete = initMateriaAutocomplete;

    })();
</script>

<!-- ‚úÖ SUBDIVISIONES $x (estilo 852/856) -->
<script>
(function () {
    const prefix = "{{ formset.prefix }}";
    const root = document.querySelector(`[data-formset-prefix="${prefix}"]`);
    if (!root) return;

    function createSubdivisionRow(index) {
        const row = document.createElement("div");
        row.className = "subcampo-row subdivision-form-row mt-2";
        row.innerHTML = `
            <div class="subcampo-placeholder"></div>
            <input type="text"
                   class="form-control subdivision-input"
                   name="subdivision_materia_650_${index}_${Date.now()}"
                   placeholder="Subdivisi√≥n de materia">
            <button type="button"
                    class="subcampo-delete-btn delete-subdivision-btn"
                    title="Eliminar">
                <i class="bi bi-x-lg"></i>
            </button>
        `;
        return row;
    }

    function updateDeleteVisibility(container) {
        const rows = container.querySelectorAll(".subdivision-form-row");
        rows.forEach((row, idx) => {
            const del = row.querySelector(".delete-subdivision-btn");
            if (del) del.style.visibility = (idx === 0) ? "hidden" : "visible";
        });
    }

    root.addEventListener("click", function (e) {

        // ‚ûï Agregar subdivisi√≥n
        const addBtn = e.target.closest(".add-subdivision-btn");
        if (addBtn) {
            const index = addBtn.getAttribute("data-materia-index");
            const cont = root.querySelector(`[data-subdivisiones-container="${index}"]`);
            if (!cont) return;

            cont.appendChild(createSubdivisionRow(index));
            updateDeleteVisibility(cont);
            return;
        }

        // ‚ùå Eliminar subdivisi√≥n
        const delBtn = e.target.closest(".delete-subdivision-btn");
        if (delBtn) {
            const row = delBtn.closest(".subdivision-form-row");
            const cont = delBtn.closest(".subdivisiones-container");
            if (!row || !cont) return;

            row.remove();
            updateDeleteVisibility(cont);
            return;
        }
    });

    root.querySelectorAll(".subdivisiones-container").forEach(updateDeleteVisibility);
})();
</script>
