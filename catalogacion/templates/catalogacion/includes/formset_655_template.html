{% comment %}
FORMSET 655 — Género/Forma (NR) + subdivisiones $x (R)
Mismo diseño, colores y JS que el 650.
{% endcomment %}

<div class="formset-container" data-formset-prefix="{{ formset.prefix }}">

    <!-- Management form -->
    <div style="display:none;">
        {% for field in formset.management_form %}
        {{ field }}
        {% endfor %}
    </div>

    <!-- Botón agregar -->
    <button type="button" class="add-form-row mb-3">
        <i class="bi bi-plus-circle"></i> Agregar Género/Forma
    </button>

    <div class="formset-forms">

        {% for form in formset %}
        {% if form.instance.pk or forloop.counter0 == 0 %}

        <div class="formset-row {% if form.instance.pk %}existing-form{% endif %} mb-3">

            {% if form.instance.pk %}
            <input type="hidden" name="{{ form.prefix }}-id" value="{{ form.instance.pk }}">
            {% endif %}

            {% if formset.can_delete %}
            <div class="d-none">
                {{ form.DELETE }}
            </div>
            {% endif %}

            <!-- Botón eliminar fila -->
            <button type="button" class="delete-row-btn">
                <i class="bi bi-x-lg"></i>
            </button>

            <div class="campo-grid">

                <!-- 655 $a – AUTOCOMPLETE -->
                  <div class="col-full">
                      <label class="form-label">655 $a – Término Género/Forma</label>

                      <div class="autocomplete-wrapper">
                       <!-- visible -->
                       <input type="text" class="form-control genero-input"
                           name="{{ form.prefix }}-materia_texto"
                           placeholder="Escriba género/forma…"
                           autocomplete="off"
                           value="{% if form.instance.pk %}{{ form.materia.forma }}{% endif %}">

                       <!-- oculto -->
                       <input type="hidden"
                           name="{{ form.prefix }}-materia"
                           class="genero-id"
                           value="{% if form.instance.pk %}{{ form.materia.id }}{% endif %}">

                       <div class="genero-suggestions autocomplete-suggestions"></div>
                      </div>
                  </div>

                <!-- botón añadir subdivisión -->
                <div class="col-full mt-2">
                    <button type="button"
                            class="btn btn-sm btn-outline-primary add-subdivision-btn w-100"
                            data-genero-index="{{ forloop.counter0 }}">
                        <i class="bi bi-plus-circle"></i>
                        Agregar Subdivisión ($x)
                    </button>
                </div>

                <!-- subdivisiones existentes -->
                <div class="col-full subdivisiones-container"
                     data-subdivisiones-container="{{ forloop.counter0 }}">

                    {% if form.instance.pk %}
                    {% for subdivision in form.instance.subdivisiones.all %}
                    <div class="subdivision-form-row">
                        <div class="d-flex flex-column w-100 mb-2">
                            <label class="form-label small">655 $x – Subdivisión general</label>
                            <div class="d-flex gap-2 align-items-center">

                                <input type="text"
                                       class="form-control subdivision-input"
                                       name="subdivision_genero_655_{{ forloop.parentloop.counter0 }}_{{ subdivision.pk }}"
                                       value="{{ subdivision.subdivision }}"
                                       placeholder="Subdivisión general…">

                                <button type="button"
                                        class="btn btn-sm btn-outline-danger delete-subdivision-btn">
                                    <i class="bi bi-trash"></i>
                                </button>

                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% endif %}
                </div>

            </div>
        </div>

        {% endif %}
        {% endfor %}

        <!-- TEMPLATE vacío -->
        <div class="formset-row empty-form mb-3" style="display:none;">
            <button type="button" class="delete-row-btn">
                <i class="bi bi-x-lg"></i>
            </button>

            <div class="campo-grid">

                  <div class="col-full">
                      <label class="form-label">655 $a – Término Género/Forma</label>

                      <div class="autocomplete-wrapper">
                       <input type="text" class="form-control genero-input"
                           name="{{ formset.prefix }}-__prefix__-materia_texto"
                           placeholder="Género o forma…" autocomplete="off">

                       <input type="hidden"
                           class="genero-id"
                           name="{{ formset.prefix }}-__prefix__-materia">

                       <div class="genero-suggestions autocomplete-suggestions"></div>
                      </div>
                  </div>

                <div class="col-full mt-2">
                    <button type="button"
                            class="btn btn-sm btn-outline-primary add-subdivision-btn w-100"
                            data-genero-index="__prefix__">
                        <i class="bi bi-plus-circle"></i>
                        Agregar Subdivisión ($x)
                    </button>
                </div>

                <div class="col-full subdivisiones-container"
                     data-subdivisiones-container="__prefix__">
                </div>

            </div>
        </div>

    </div>
</div>

<!-- TEMPLATE subdivisión -->
<div class="subdivision-template-655 d-none">
    <div class="subdivision-form-row d-flex flex-column w-100 mb-2">
        <label class="form-label small">655 $x – Subdivisión general</label>
        <div class="d-flex gap-2 align-items-center">
            <input type="text" class="form-control subdivision-input" placeholder="Subdivisión general…">
            <button type="button" class="btn btn-sm btn-outline-danger delete-subdivision-btn">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    </div>
</div>

<!-- JS GENERO/AUTOCOMPLETE + SUBDIVISIONES -->
<script>
    (function () {

        /* === AUTOCOMPLETE 655 === */
        function initGeneroAutocomplete(input) {
            const box = input.parentElement.querySelector('.genero-suggestions');
            const hidden = input.parentElement.querySelector('.genero-id');

            let timer = null;
            let index = -1;

            input.addEventListener("input", function () {
                const q = input.value.trim();
                if (q.length < 2) return hide();

                clearTimeout(timer);
                timer = setTimeout(() => buscar(q), 250);
            });

            function buscar(q) {
                fetch(`/catalogacion/api/autocompletar/forma-musical/?q=${encodeURIComponent(q)}`)
                    .then(r => r.json())
                    .then(data => mostrar(data.results, q));
            }

            function mostrar(results, query) {
                box.innerHTML = "";
                index = -1;

                if (results.length === 0) {
                    box.innerHTML = `
                        <div class="autocomplete-item autocomplete-item-new">
                             <i class="bi bi-plus-circle me-2"></i> Crear: "${query}"
                        </div>`;
                } else {
                    results.forEach(r => {
                        const d = document.createElement("div");
                        d.className = "autocomplete-item";
                        d.innerHTML = `<strong>${r.text}</strong>`;
                        d.addEventListener("click", () => seleccionar(r));
                        box.appendChild(d);
                    });

                    const nuevo = document.createElement("div");
                    nuevo.className = "autocomplete-item autocomplete-item-new";
                    nuevo.innerHTML = `<i class="bi bi-plus-circle me-2"></i> Crear: "${query}"`;
                    nuevo.addEventListener("click", () => seleccionar({
                        id: "",
                        text: query,
                        nuevo: true
                    }));
                    box.appendChild(nuevo);
                }

                box.classList.add("show");
            }

            function seleccionar(item) {
                input.value = item.text;
                hidden.value = item.id || "";
                hide();
            }

            function hide() {
                box.classList.remove("show");
                box.innerHTML = "";
                index = -1;
            }
        }

        document.querySelectorAll('.genero-input').forEach(initGeneroAutocomplete);

        /* === REINICIALIZAR AUTOCOMPLETE AL AGREGAR === */
        document.addEventListener("click", function (e) {
            if (e.target.closest('.add-form-row')) {
                setTimeout(() => {
                    document.querySelectorAll('.genero-input').forEach(initGeneroAutocomplete);
                }, 120);
            }
        });

        /* === SUBDIVISIONES 655 === */
        const prefix = '{{ formset.prefix }}';
        const container = document.querySelector(`[data-formset-prefix="${prefix}"]`);
        const totalForms = container.querySelector(`#id_${prefix}-TOTAL_FORMS`);
        const addBtn = container.querySelector('.add-form-row');
        const formsCont = container.querySelector('.formset-forms');
        const subTpl = document.querySelector('.subdivision-template-655');

        addBtn.addEventListener('click', () => {
            const total = parseInt(totalForms.value);
            const empty = formsCont.querySelector('.empty-form');

            const newForm = empty.cloneNode(true);
            newForm.innerHTML = newForm.innerHTML.replace(/__prefix__/g, total);
            newForm.classList.remove('empty-form');
            newForm.style.display = "";

            newForm.querySelector('.add-subdivision-btn').dataset.generoIndex = total;
            newForm.querySelector('.subdivisiones-container').dataset.subdivisionesContainer = total;

            formsCont.insertBefore(newForm, empty);
            totalForms.value = total + 1;
        });

        container.addEventListener('click', function (e) {

            /* eliminar subdivisión */
            const delSub = e.target.closest('.delete-subdivision-btn');
            if (delSub) return delSub.closest('.subdivision-form-row').remove();

            /* eliminar fila */
            const del = e.target.closest('.delete-row-btn');
            if (del) {
                const row = del.closest('.formset-row');
                const deleteInput = row.querySelector('input[name*="DELETE"]');

                if (row.classList.contains('existing-form')) {
                    deleteInput.checked = !deleteInput.checked;
                    row.style.opacity = deleteInput.checked ? "0.4" : "1";
                } else {
                    row.remove();
                    totalForms.value = parseInt(totalForms.value) - 1;
                }

                return;
            }

            /* agregar subdivisión */
            const btn = e.target.closest('.add-subdivision-btn');
            if (btn) {
                const idx = btn.dataset.generoIndex;
                const cont = container.querySelector(`[data-subdivisiones-container="${idx}"]`);

                const sub = subTpl.cloneNode(true);
                sub.classList.remove('d-none', 'subdivision-template-655');

                sub.querySelector('.subdivision-input')
                    .name = `subdivision_genero_655_${idx}_${Date.now()}`;

                cont.appendChild(sub);
            }
        });

    })();
</script>
