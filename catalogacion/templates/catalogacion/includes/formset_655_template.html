{% comment %}
FORMSET 655 — Género/Forma + subdivisiones $x
Botón + a la izquierda (input-group) — ESTABLE
{% endcomment %}

<div class="formset-container" data-formset-prefix="{{ formset.prefix }}">

    <!-- Management form -->
    <div style="display:none;">
        {{ formset.management_form }}
    </div>

    <div class="formset-forms">

        {% for form in formset %}
        <div class="formset-row mb-3">

            {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}

            <button type="button" class="delete-row-btn" title="Eliminar 655">
                <i class="bi bi-x-lg"></i>
            </button>

            <div class="campo-grid">

                <!-- 655 $a -->
                <div class="col-full">
                    <label class="form-label small">655 $a – Género / Forma</label>
                    <div class="autocomplete-wrapper position-relative">
                        <input type="text"
                               class="form-control genero-input"
                               name="{{ form.prefix }}-materia_texto"
                               placeholder="Escriba género/forma…"
                               autocomplete="off"
                               value="{% if form.instance.pk and form.materia.value %}{{ form.instance.materia.forma }}{% endif %}">
                        <input type="hidden"
                               class="genero-id"
                               name="{{ form.prefix }}-materia"
                               value="{% if form.instance.pk and form.materia.value %}{{ form.instance.materia.id }}{% endif %}">
                        <div class="genero-suggestions autocomplete-suggestions list-group"></div>
                    </div>
                    {% if form.materia.errors %}
                    <div class="invalid-feedback d-block">{{ form.materia.errors }}</div>
                    {% endif %}
                </div>

                <!-- 655 $x -->
                <div class="col-full">
                    <label class="form-label small">655 $x – Subdivisión general</label>

                    <div class="subdivisiones-container" data-genero-index="{{ forloop.counter0 }}">

                        {% if form.instance.pk %}
                            {% for sub in form.instance.subdivisiones.all %}
                            <div class="subcampo-row subdivision-form-row mb-2">
                                <div class="input-group">

                                    {% if forloop.first %}
                                    <button type="button"
                                            class="subcampo-add-btn add-subdivision-btn btn btn-outline-primary">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                    {% else %}
                                    <button type="button"
                                            class="subcampo-add-btn add-subdivision-btn btn btn-outline-primary">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                    {% endif %}

                                    <input type="text"
                                           class="form-control subdivision-input"
                                           name="{{ form.prefix }}-subdivision_{{ forloop.counter0 }}"
                                           value="{{ sub.subdivision }}"
                                           placeholder="Subdivisión general">

                                    <button type="button"
                                            class="subcampo-delete-btn btn btn-outline-danger"
                                            {% if forloop.first %}style="visibility:hidden"{% endif %}>
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="subcampo-row subdivision-form-row mb-2">
                                <div class="input-group">

                                    <button type="button"
                                            class="subcampo-add-btn add-subdivision-btn btn btn-outline-primary">
                                        <i class="bi bi-plus"></i>
                                    </button>

                                    <input type="text"
                                           class="form-control subdivision-input"
                                           name="{{ form.prefix }}-subdivision_0"
                                           placeholder="Subdivisión general">

                                    <button type="button"
                                            class="subcampo-delete-btn btn btn-outline-danger"
                                            style="visibility:hidden">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                            </div>
                        {% endif %}

                    </div>
                </div>

            </div>
        </div>
        {% endfor %}

        <!-- EMPTY FORM -->
        <div class="formset-row empty-form" style="display:none;">
            <button type="button" class="delete-row-btn">
                <i class="bi bi-x-lg"></i>
            </button>

            <div class="campo-grid">

                <div class="col-full">
                    <label class="form-label small">655 $a – Género / Forma</label>
                    <div class="autocomplete-wrapper position-relative">
                        <input type="text"
                               class="form-control genero-input"
                               name="{{ formset.prefix }}-__prefix__-materia_texto">
                        <input type="hidden"
                               class="genero-id"
                               name="{{ formset.prefix }}-__prefix__-materia">
                        <div class="genero-suggestions autocomplete-suggestions list-group"></div>
                    </div>
                </div>

                <div class="col-full">
                    <label class="form-label small">655 $x – Subdivisión general</label>
                    <div class="subdivisiones-container" data-genero-index="__prefix__">

                        <div class="subcampo-row subdivision-form-row mb-2">
                            <div class="input-group">
                                <button type="button"
                                        class="subcampo-add-btn add-subdivision-btn btn btn-outline-primary">
                                    <i class="bi bi-plus"></i>
                                </button>

                                <input type="text"
                                       class="form-control subdivision-input"
                                       name="{{ formset.prefix }}-__prefix__-subdivision_0">

                                <button type="button"
                                        class="subcampo-delete-btn btn btn-outline-danger"
                                        style="visibility:hidden">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        </div>

                    </div>
                </div>

            </div>
        </div>

    </div>
</div>

<script>
(function(){
    const container=document.querySelector('[data-formset-prefix="{{ formset.prefix }}"]');
    if(!container) return;

    function initGeneroAutocomplete(input) {
        if (!input || input.dataset.generoInit === "1") return;
        input.dataset.generoInit = "1";

        const wrapper = input.closest(".autocomplete-wrapper");
        const suggestionsBox = wrapper.querySelector(".genero-suggestions");
        const hiddenIdInput = wrapper.querySelector(".genero-id");
        let debounceTimer = null, selectedIndex = -1;

        function hide() { 
            suggestionsBox.classList.remove("show"); 
            suggestionsBox.innerHTML = ""; 
            selectedIndex = -1; 
        }

        function marcar(items){ 
            items.forEach((el,i)=>el.classList.toggle("selected", i===selectedIndex)); 
        }

        function seleccionar(item){
            input.value = item.text;
            hiddenIdInput.value = item.id || "";
            hiddenIdInput.dataset.nuevo = item.nuevo ? "1":"0";
            hiddenIdInput.dispatchEvent(new Event("change"));
            hide();
        }

        function mostrar(results, query){
            suggestionsBox.innerHTML="";
            selectedIndex=-1;
            if(!results.length){
                const div = document.createElement("div");
                div.className="autocomplete-item autocomplete-item-new list-group-item";
                div.innerHTML = `<i class="bi bi-plus-circle me-2"></i> Crear: "${query}"`;
                div.onclick = ()=>seleccionar({id:"",text:query,nuevo:true});
                suggestionsBox.appendChild(div);
            } else {
                results.forEach(r=>{
                    const div=document.createElement("div");
                    div.className="autocomplete-item list-group-item";
                    div.innerHTML=`<strong>${r.text}</strong>`;
                    div.onclick=()=>seleccionar({id:r.id,text:r.text,nuevo:false});
                    suggestionsBox.appendChild(div);
                });
                const nuevo=document.createElement("div");
                nuevo.className="autocomplete-item autocomplete-item-new list-group-item";
                nuevo.innerHTML=`<i class="bi bi-plus-circle me-2"></i> Crear: "${query}"`;
                nuevo.onclick=()=>seleccionar({id:"",text:query,nuevo:true});
                suggestionsBox.appendChild(nuevo);
            }
            suggestionsBox.classList.add("show");
        }

        function buscar(q){ 
            fetch(`/catalogacion/api/autocompletar/genero/?q=${encodeURIComponent(q)}`)
                .then(r=>r.json()).then(d=>mostrar(d.results||[],q)).catch(()=>hide()); 
        }

        input.addEventListener("input", e=>{
            const q=input.value.trim();
            hiddenIdInput.value=""; 
            hiddenIdInput.removeAttribute("data-nuevo");
            if(q.length<2){ hide(); return; }
            clearTimeout(debounceTimer); 
            debounceTimer=setTimeout(()=>buscar(q),250);
        });

        input.addEventListener("keydown", e=>{
            const items = suggestionsBox.querySelectorAll(".autocomplete-item");
            if(!items.length) return;
            if(e.key==="ArrowDown"){ 
                e.preventDefault(); 
                selectedIndex=Math.min(selectedIndex+1,items.length-1); 
                marcar(items); 
            }
            if(e.key==="ArrowUp"){ 
                e.preventDefault(); 
                selectedIndex=Math.max(selectedIndex-1,0); 
                marcar(items); 
            }
            if(e.key==="Enter"){ 
                e.preventDefault(); 
                if(items[selectedIndex]) items[selectedIndex].click(); 
            }
            if(e.key==="Escape") hide();
        });

        document.addEventListener("click", e=>{ 
            if(!wrapper.contains(e.target)) hide(); 
        });
    }

    function updateDeleteButtons(cont){
        cont.querySelectorAll(".subdivision-form-row").forEach((row,i)=>{
            const del=row.querySelector(".subcampo-delete-btn");
            if(del) del.style.visibility = i===0 ? "hidden" : "visible";
        });
    }

    container.addEventListener("click", function(e){
        const addBtn=e.target.closest(".add-subdivision-btn");
        if(addBtn){
            console.log("Botón + clickeado en 655");
            const cont=addBtn.closest(".subdivisiones-container");
            const rows=cont.querySelectorAll(".subdivision-form-row");
            console.log("Filas encontradas:", rows.length);
            const clone=rows[0].cloneNode(true);
            console.log("Clon creado");

            clone.querySelector(".subdivision-input").value="";
            clone.querySelector(".subdivision-input").name =
                clone.querySelector(".subdivision-input").name.replace(/_\d+$/, `_${rows.length}`);

            clone.querySelector(".add-subdivision-btn")?.remove();
            clone.querySelector(".genero-input")?.removeAttribute("data-genero-init");
            initGeneroAutocomplete(clone.querySelector(".genero-input"));
            cont.appendChild(clone);
            updateDeleteButtons(cont);
            console.log("Clon agregado al contenedor");
            return;
        }

        const delBtn=e.target.closest(".subcampo-delete-btn");
        if(delBtn){
            const row=delBtn.closest(".subdivision-form-row");
            const cont=delBtn.closest(".subdivisiones-container");
            row.remove();
            updateDeleteButtons(cont);
        }
    });

    // Cuando se agrega desde el gestor global (formset-manager.js), reindexar e inicializar
    container.addEventListener('formset:added', (ev) => {
        if (!ev || !ev.detail || ev.detail.prefix !== PREFIX) return;
        
        // small timeout to let DOM settle
        setTimeout(() => {
            // Inicializar autocomplete en los nuevos inputs
            container.querySelectorAll(".genero-input").forEach(initGeneroAutocomplete);
            
            // Inicializar subdivisiones en las nuevas filas
            container.querySelectorAll(".subdivisiones-container").forEach(updateDeleteButtons);
        }, 50);
    });

    // Inicializar autocomplete para inputs existentes
    container.querySelectorAll(".genero-input").forEach(initGeneroAutocomplete);

})();
</script>
