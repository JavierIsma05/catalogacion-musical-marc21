{% comment %}
FORMSET 655 — Género/Forma + subdivisiones $x
Botón + a la izquierda (input-group) — ESTABLE
{% endcomment %}

<div class="formset-container" data-formset-prefix="{{ formset.prefix }}">

    <!-- Management form -->
    <div style="display:none;">
        {{ formset.management_form }}
    </div>

    <div class="formset-forms">

        {% for form in formset %}
        <div class="formset-row mb-3">

            {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}

            <button type="button" class="delete-row-btn" title="Eliminar 655">
                <i class="bi bi-x-lg"></i>
            </button>

            <div class="campo-grid">

                <!-- 655 $a -->
                <div class="col-full">
                    <label class="form-label small">655 $a – Género / Forma</label>
                    <div class="autocomplete-wrapper position-relative">
                        <input type="text"
                               class="form-control genero-input"
                               name="{{ form.prefix }}-materia_texto"
                               autocomplete="off"
                               value="{{ form.instance.materia.forma|default:'' }}">
                        <input type="hidden"
                               class="genero-id"
                               name="{{ form.prefix }}-materia"
                               value="{{ form.instance.materia.id|default:'' }}">
                        <div class="genero-suggestions list-group autocomplete-suggestions"></div>
                    </div>
                </div>

                <!-- 655 $x -->
                <div class="col-full">
                    <label class="form-label small">655 $x – Subdivisión general</label>

                    <div class="subdivisiones-container" data-genero-index="{{ forloop.counter0 }}">

                        {% if form.instance.pk %}
                            {% for sub in form.instance.subdivisiones.all %}
                            <div class="subcampo-row subdivision-form-row mb-2">
                                <div class="input-group">

                                    {% if forloop.first %}
                                    <button type="button"
                                            class="subcampo-add-btn add-subdivision-btn btn btn-outline-primary">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                    {% else %}
                                    <span class="input-group-text bg-transparent border-0"></span>
                                    {% endif %}

                                    <input type="text"
                                           class="form-control subdivision-input"
                                           name="{{ form.prefix }}-subdivision_{{ forloop.counter0 }}"
                                           value="{{ sub.subdivision }}"
                                           placeholder="Subdivisión general">

                                    <button type="button"
                                            class="subcampo-delete-btn btn btn-outline-danger"
                                            {% if forloop.first %}style="visibility:hidden"{% endif %}>
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="subcampo-row subdivision-form-row mb-2">
                                <div class="input-group">

                                    <button type="button"
                                            class="subcampo-add-btn add-subdivision-btn btn btn-outline-primary">
                                        <i class="bi bi-plus"></i>
                                    </button>

                                    <input type="text"
                                           class="form-control subdivision-input"
                                           name="{{ form.prefix }}-subdivision_0"
                                           placeholder="Subdivisión general">

                                    <button type="button"
                                            class="subcampo-delete-btn btn btn-outline-danger"
                                            style="visibility:hidden">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                            </div>
                        {% endif %}

                    </div>
                </div>

            </div>
        </div>
        {% endfor %}

        <!-- EMPTY FORM -->
        <div class="formset-row empty-form" style="display:none;">
            <button type="button" class="delete-row-btn">
                <i class="bi bi-x-lg"></i>
            </button>

            <div class="campo-grid">

                <div class="col-full">
                    <label class="form-label small">655 $a – Género / Forma</label>
                    <div class="autocomplete-wrapper position-relative">
                        <input type="text"
                               class="form-control genero-input"
                               name="{{ formset.prefix }}-__prefix__-materia_texto">
                        <input type="hidden"
                               class="genero-id"
                               name="{{ formset.prefix }}-__prefix__-materia">
                        <div class="genero-suggestions list-group autocomplete-suggestions"></div>
                    </div>
                </div>

                <div class="col-full">
                    <label class="form-label small">655 $x – Subdivisión general</label>
                    <div class="subdivisiones-container" data-genero-index="__prefix__">

                        <div class="subcampo-row subdivision-form-row mb-2">
                            <div class="input-group">
                                <button type="button"
                                        class="subcampo-add-btn add-subdivision-btn btn btn-outline-primary">
                                    <i class="bi bi-plus"></i>
                                </button>

                                <input type="text"
                                       class="form-control subdivision-input"
                                       name="{{ formset.prefix }}-__prefix__-subdivision_0">

                                <button type="button"
                                        class="subcampo-delete-btn btn btn-outline-danger"
                                        style="visibility:hidden">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        </div>

                    </div>
                </div>

            </div>
        </div>

    </div>
</div>

<script>
(function(){
    const container=document.querySelector('[data-formset-prefix="{{ formset.prefix }}"]');
    if(!container) return;

    function updateDeleteButtons(cont){
        cont.querySelectorAll(".subdivision-form-row").forEach((row,i)=>{
            const del=row.querySelector(".subcampo-delete-btn");
            if(del) del.style.visibility = i===0 ? "hidden" : "visible";
        });
    }

    container.addEventListener("click", e=>{
        const addBtn=e.target.closest(".add-subdivision-btn");
        if(addBtn){
            const cont=addBtn.closest(".subdivisiones-container");
            const rows=cont.querySelectorAll(".subdivision-form-row");
            const clone=rows[0].cloneNode(true);

            clone.querySelector(".subdivision-input").value="";
            clone.querySelector(".subdivision-input").name =
                clone.querySelector(".subdivision-input").name.replace(/_\d+$/, `_${rows.length}`);

            clone.querySelector(".add-subdivision-btn")?.remove();
            cont.appendChild(clone);
            updateDeleteButtons(cont);
        }

        const delBtn=e.target.closest(".subcampo-delete-btn");
        if(delBtn){
            const row=delBtn.closest(".subdivision-form-row");
            const cont=delBtn.closest(".subdivisiones-container");
            row.remove();
            updateDeleteButtons(cont);
        }
    });
})();
</script>
