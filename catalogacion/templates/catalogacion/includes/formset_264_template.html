{% comment %}
Template especializado para el campo 264.
Permite repetir el campo completo y también cada uno de sus subcampos ($a, $b, $c).
El botón de agregar campo completo está en el header del campo (campo-add-btn)
{% endcomment %}

<div class="formset-container" data-formset-prefix="{{ formset.prefix }}">
    <div style="display:none;">
        {% for hidden in formset.management_form %}
            {{ hidden }}
        {% endfor %}
    </div>
    
    <div class="formset-forms">
        {% for form in formset %}
        <div class="formset-row {% if form.instance.pk %}existing-form{% endif %} mb-3">
            {% for hidden in form.hidden_fields %}
                {{ hidden }}
            {% endfor %}
            {% if formset.can_delete %}
                <div class="d-none">
                    {{ form.DELETE }}
                </div>
            {% endif %}
            
            <button type="button" class="delete-row-btn" title="Eliminar registro 264">
                <i class="bi bi-x-lg"></i>
            </button>
            
            {% if form.non_field_errors %}
            <div class="alert alert-danger mb-3">
                {{ form.non_field_errors }}
            </div>
            {% endif %}
            
            <div class="campo-grid">
                <div class="col-full">
                    <label class="form-label" for="{{ form.funcion.id_for_label }}">{{ form.funcion.label }}</label>
                    {{ form.funcion }}
                    {% if form.funcion.errors %}
                        <div class="invalid-feedback d-block">{{ form.funcion.errors }}</div>
                    {% endif %}
                </div>
                
                {# Subcampo $a - Lugares (Repetible) con botón + a la izquierda #}
                <div class="col-full">
                    <label class="form-label small">264 $a - Lugar</label>
                    <div class="subcampo-repetible-container lugares-container" data-lugares-container="{{ forloop.counter0 }}" data-borrador-container="lugar_produccion_264" data-borrador-parent="{{ forloop.counter0 }}">
                        {% if form.instance.pk %}
                            {# Cargar lugares existentes #}
                            {% for lugar in form.instance.lugares.all %}
                            <div class="subcampo-row lugar-form-row">
                                {% if forloop.first %}
                                <button type="button" class="subcampo-add-btn add-lugar-btn" data-produccion-index="{{ forloop.parentloop.counter0 }}" data-borrador-add="lugar_produccion_264" data-borrador-parent="{{ forloop.parentloop.counter0 }}" title="Agregar Lugar">
                                    <i class="bi bi-plus"></i>
                                </button>
                                {% else %}
                                <div class="subcampo-placeholder"></div>
                                {% endif %}
                                <input type="text" class="form-control lugar-input" name="lugar_produccion_264_{{ forloop.parentloop.counter0 }}_{{ lugar.pk }}" value="{{ lugar.lugar }}" placeholder="Ciudad">
                                <button type="button" class="subcampo-delete-btn delete-lugar-btn" title="Eliminar" {% if forloop.first and forloop.last %}style="visibility: hidden;"{% endif %}>
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                            {% empty %}
                            <div class="subcampo-row lugar-form-row">
                                <button type="button" class="subcampo-add-btn add-lugar-btn" data-produccion-index="{{ forloop.counter0 }}" data-borrador-add="lugar_produccion_264" data-borrador-parent="{{ forloop.counter0 }}" title="Agregar Lugar">
                                    <i class="bi bi-plus"></i>
                                </button>
                                <input type="text" class="form-control lugar-input" name="lugar_produccion_264_{{ forloop.counter0 }}_0" placeholder="Ciudad">
                                <button type="button" class="subcampo-delete-btn delete-lugar-btn" title="Eliminar" style="visibility: hidden;">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                            {% endfor %}
                        {% else %}
                        <div class="subcampo-row lugar-form-row">
                            <button type="button" class="subcampo-add-btn add-lugar-btn" data-produccion-index="{{ forloop.counter0 }}" data-borrador-add="lugar_produccion_264" data-borrador-parent="{{ forloop.counter0 }}" title="Agregar Lugar">
                                <i class="bi bi-plus"></i>
                            </button>
                            <input type="text" class="form-control lugar-input" name="lugar_produccion_264_{{ forloop.counter0 }}_0" placeholder="Ciudad">
                            <button type="button" class="subcampo-delete-btn delete-lugar-btn" title="Eliminar" style="visibility: hidden;">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                {# Subcampo $b - Entidades (Repetible) con botón + a la izquierda #}
                <div class="col-full">
                    <label class="form-label small">264 $b - Nombre
                    </label>
                    <div class="subcampo-repetible-container entidades-container" data-entidades-container="{{ forloop.counter0 }}" data-borrador-container="entidad_produccion_264" data-borrador-parent="{{ forloop.counter0 }}">
                        {% if form.instance.pk %}
                            {# Cargar entidades existentes #}
                            {% for entidad in form.instance.entidades.all %}
                            <div class="subcampo-row entidad-form-row">
                                {% if forloop.first %}
                                <button type="button" class="subcampo-add-btn add-entidad-btn" data-produccion-index="{{ forloop.parentloop.counter0 }}" data-borrador-add="entidad_produccion_264" data-borrador-parent="{{ forloop.parentloop.counter0 }}" title="Agregar Entidad">
                                    <i class="bi bi-plus"></i>
                                </button>
                                {% else %}
                                <div class="subcampo-placeholder"></div>
                                {% endif %}
                                <input type="text" class="form-control entidad-input" name="entidad_produccion_264_{{ forloop.parentloop.counter0 }}_{{ entidad.pk }}" value="{{ entidad.nombre }}" placeholder="Nombre del editor o productor">
                                <button type="button" class="subcampo-delete-btn delete-entidad-btn" title="Eliminar" {% if forloop.first and forloop.last %}style="visibility: hidden;"{% endif %}>
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                            {% empty %}
                            <div class="subcampo-row entidad-form-row">
                                <button type="button" class="subcampo-add-btn add-entidad-btn" data-produccion-index="{{ forloop.counter0 }}" data-borrador-add="entidad_produccion_264" data-borrador-parent="{{ forloop.counter0 }}" title="Agregar Entidad">
                                    <i class="bi bi-plus"></i>
                                </button>
                                <input type="text" class="form-control entidad-input" name="entidad_produccion_264_{{ forloop.counter0 }}_0" placeholder="Nombre del editor o productor">
                                <button type="button" class="subcampo-delete-btn delete-entidad-btn" title="Eliminar" style="visibility: hidden;">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                            {% endfor %}
                        {% else %}
                        <div class="subcampo-row entidad-form-row">
                            <button type="button" class="subcampo-add-btn add-entidad-btn" data-produccion-index="{{ forloop.counter0 }}" data-borrador-add="entidad_produccion_264" data-borrador-parent="{{ forloop.counter0 }}" title="Agregar Entidad">
                                <i class="bi bi-plus"></i>
                            </button>
                            <input type="text" class="form-control entidad-input" name="entidad_produccion_264_{{ forloop.counter0 }}_0" placeholder="Nombre del editor o productor">
                            <button type="button" class="subcampo-delete-btn delete-entidad-btn" title="Eliminar" style="visibility: hidden;">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                {# Subcampo $c - Fechas (Repetible) con botón + a la izquierda #}
                <div class="col-full">
                    <label class="form-label small">264 $c - Fecha</label>
                    <div class="subcampo-repetible-container fechas-container" data-fechas-container="{{ forloop.counter0 }}" data-borrador-container="fecha_produccion_264" data-borrador-parent="{{ forloop.counter0 }}">
                        {% if form.instance.pk %}
                            {# Cargar fechas existentes #}
                            {% for fecha in form.instance.fechas.all %}
                            <div class="subcampo-row fecha-form-row">
                                {% if forloop.first %}
                                <button type="button" class="subcampo-add-btn add-fecha-btn" data-produccion-index="{{ forloop.parentloop.counter0 }}" data-borrador-add="fecha_produccion_264" data-borrador-parent="{{ forloop.parentloop.counter0 }}" title="Agregar Fecha">
                                    <i class="bi bi-plus"></i>
                                </button>
                                {% else %}
                                <div class="subcampo-placeholder"></div>
                                {% endif %}
                                <input type="text" class="form-control fecha-input" name="fecha_produccion_264_{{ forloop.parentloop.counter0 }}_{{ fecha.pk }}" value="{{ fecha.fecha }}" placeholder="2024, [2024], ©2024">
                                <button type="button" class="subcampo-delete-btn delete-fecha-btn" title="Eliminar" {% if forloop.first and forloop.last %}style="visibility: hidden;"{% endif %}>
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                            {% empty %}
                            <div class="subcampo-row fecha-form-row">
                                <button type="button" class="subcampo-add-btn add-fecha-btn" data-produccion-index="{{ forloop.counter0 }}" data-borrador-add="fecha_produccion_264" data-borrador-parent="{{ forloop.counter0 }}" title="Agregar Fecha">
                                    <i class="bi bi-plus"></i>
                                </button>
                                <input type="text" class="form-control fecha-input" name="fecha_produccion_264_{{ forloop.counter0 }}_0" placeholder="2024, [2024], ©2024">
                                <button type="button" class="subcampo-delete-btn delete-fecha-btn" title="Eliminar" style="visibility: hidden;">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                            {% endfor %}
                        {% else %}
                        <div class="subcampo-row fecha-form-row">
                            <button type="button" class="subcampo-add-btn add-fecha-btn" data-produccion-index="{{ forloop.counter0 }}" data-borrador-add="fecha_produccion_264" data-borrador-parent="{{ forloop.counter0 }}" title="Agregar Fecha">
                                <i class="bi bi-plus"></i>
                            </button>
                            <input type="text" class="form-control fecha-input" name="fecha_produccion_264_{{ forloop.counter0 }}_0" placeholder="2024, [2024], ©2024">
                            <button type="button" class="subcampo-delete-btn delete-fecha-btn" title="Eliminar" style="visibility: hidden;">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        
        <div class="formset-row empty-form mb-3" style="display:none;">
            <div style="display:none;">
                {% for hidden in formset.empty_form.hidden_fields %}
                    {{ hidden }}
                {% endfor %}
            </div>
            <button type="button" class="delete-row-btn" title="Eliminar registro 264">
                <i class="bi bi-x-lg"></i>
            </button>
            <div class="campo-grid">
                <div class="col-full">
                    <label class="form-label" for="{{ formset.empty_form.funcion.id_for_label }}">{{ formset.empty_form.funcion.label }}</label>
                    {{ formset.empty_form.funcion }}
                </div>
                
                <div class="col-full">
                    <label class="form-label small">264 $a - Lugar</label>
                    <div class="subcampo-repetible-container lugares-container" data-lugares-container="__prefix__" data-borrador-container="lugar_produccion_264" data-borrador-parent="__prefix__">
                        <div class="subcampo-row lugar-form-row">
                            <button type="button" class="subcampo-add-btn add-lugar-btn" data-produccion-index="__prefix__" data-borrador-add="lugar_produccion_264" data-borrador-parent="__prefix__" title="Agregar Lugar">
                                <i class="bi bi-plus"></i>
                            </button>
                            <input type="text" class="form-control lugar-input" name="lugar_produccion_264___prefix___0" placeholder="Ciudad">
                            <button type="button" class="subcampo-delete-btn delete-lugar-btn" title="Eliminar" style="visibility: hidden;">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="col-full">
                    <label class="form-label small">264 $b - Nombre de entidad</label>
                    <div class="subcampo-repetible-container entidades-container" data-entidades-container="__prefix__" data-borrador-container="entidad_produccion_264" data-borrador-parent="__prefix__">
                        <div class="subcampo-row entidad-form-row">
                            <button type="button" class="subcampo-add-btn add-entidad-btn" data-produccion-index="__prefix__" data-borrador-add="entidad_produccion_264" data-borrador-parent="__prefix__" title="Agregar Entidad">
                                <i class="bi bi-plus"></i>
                            </button>
                            <input type="text" class="form-control entidad-input" name="entidad_produccion_264___prefix___0" placeholder="Nombre del editor o productor">
                            <button type="button" class="subcampo-delete-btn delete-entidad-btn" title="Eliminar" style="visibility: hidden;">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="col-full">
                    <label class="form-label small">264 $c - Fecha</label>
                    <div class="subcampo-repetible-container fechas-container" data-fechas-container="__prefix__" data-borrador-container="fecha_produccion_264" data-borrador-parent="__prefix__">
                        <div class="subcampo-row fecha-form-row">
                            <button type="button" class="subcampo-add-btn add-fecha-btn" data-produccion-index="__prefix__" data-borrador-add="fecha_produccion_264" data-borrador-parent="__prefix__" title="Agregar Fecha">
                                <i class="bi bi-plus"></i>
                            </button>
                            <input type="text" class="form-control fecha-input" name="fecha_produccion_264___prefix___0" placeholder="2024, [2024], ©2024">
                            <button type="button" class="subcampo-delete-btn delete-fecha-btn" title="Eliminar" style="visibility: hidden;">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{# Templates globales para lugares, entidades y fechas (fuera del formset loop) #}
<div class="subcampo-row lugar-form-row lugar-template-264 d-none">
    <div class="subcampo-placeholder"></div>
    <input type="text" class="form-control lugar-input" placeholder="Ciudad">
    <button type="button" class="subcampo-delete-btn delete-lugar-btn" title="Eliminar">
        <i class="bi bi-x-lg"></i>
    </button>
</div>

<div class="subcampo-row entidad-form-row entidad-template-264 d-none">
    <div class="subcampo-placeholder"></div>
    <input type="text" class="form-control entidad-input" placeholder="Nombre del editor o productor">
    <button type="button" class="subcampo-delete-btn delete-entidad-btn" title="Eliminar">
        <i class="bi bi-x-lg"></i>
    </button>
</div>

<div class="subcampo-row fecha-form-row fecha-template-264 d-none">
    <div class="subcampo-placeholder"></div>
    <input type="text" class="form-control fecha-input" placeholder="2024, [2024], ©2024">
    <button type="button" class="subcampo-delete-btn delete-fecha-btn" title="Eliminar">
        <i class="bi bi-x-lg"></i>
    </button>
</div>

<script>
/**
 * Script para subcampos repetibles del campo 264 (Lugares, Entidades, Fechas)
 * La gestión del formset principal está en formset-manager.js
 */
(function() {
    function init264Subcampos() {
        const prefix = '{{ formset.prefix }}';
        const container = document.querySelector(`[data-formset-prefix="${prefix}"]`);
        if (!container || container.dataset.subcampos264Initialized) return;
        container.dataset.subcampos264Initialized = 'true';

        // =====================================================================
        // KILL SWITCH: Forzar que el select "funcion" del 264 sea SIEMPRE nativo
        // =====================================================================
        function forceNativeSelect(select) {
            if (!select) return;
            
            // Destruir Select2 si existe
            if (typeof $ !== 'undefined' && $.fn && $.fn.select2) {
                try {
                    if ($(select).data('select2')) {
                        $(select).select2('destroy');
                    }
                } catch (e) {}
            }
            
            // Limpiar clases y atributos de Select2
            select.classList.remove('select2-hidden-accessible', 'select2');
            select.removeAttribute('data-select2-id');
            select.removeAttribute('tabindex');
            select.removeAttribute('aria-hidden');
            select.style.display = '';
            
            // Eliminar contenedores Select2 adyacentes
            const parent = select.parentElement;
            if (parent) {
                parent.querySelectorAll('.select2-container, .select2').forEach(el => {
                    if (el !== select) el.remove();
                });
            }
        }

        // Limpiar todos los selects de función actuales
        function cleanAllFuncionSelects() {
            container.querySelectorAll('select[name$="-funcion"]').forEach(forceNativeSelect);
        }

        // Ejecutar limpieza inicial
        cleanAllFuncionSelects();

        // MutationObserver: detectar cuando se agregan nuevas filas y limpiar Select2
        const observer = new MutationObserver((mutations) => {
            let needsClean = false;
            for (const mutation of mutations) {
                if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                    for (const node of mutation.addedNodes) {
                        if (node.nodeType === 1) { // Element node
                            // Si es una fila del formset o contiene un select de función
                            if (node.classList?.contains('formset-row') ||
                                node.querySelector?.('select[name$="-funcion"]') ||
                                node.classList?.contains('select2-container') ||
                                node.classList?.contains('select2')) {
                                needsClean = true;
                                break;
                            }
                        }
                    }
                }
                if (needsClean) break;
            }
            if (needsClean) {
                // Pequeño delay para que Select2 termine de inicializarse y luego destruirlo
                setTimeout(cleanAllFuncionSelects, 10);
                setTimeout(cleanAllFuncionSelects, 50);
                setTimeout(cleanAllFuncionSelects, 150);
            }
        });

        observer.observe(container, { childList: true, subtree: true });
        
        const lugarTemplate = document.querySelector('.lugar-template-264');
        const entidadTemplate = document.querySelector('.entidad-template-264');
        const fechaTemplate = document.querySelector('.fecha-template-264');
        
        if (!lugarTemplate || !entidadTemplate || !fechaTemplate) return;
        
        // Función para actualizar visibilidad de botones de eliminar
        // La primera fila (con .subcampo-add-btn) NUNCA se puede eliminar
        function updateDeleteButtonsVisibility(subcampoContainer) {
            const rows = subcampoContainer.querySelectorAll('.subcampo-row:not(.d-none)');
            rows.forEach((row) => {
                const deleteBtn = row.querySelector('.subcampo-delete-btn');
                if (deleteBtn) {
                    // Si es la primera fila (tiene el botón +), ocultar siempre
                    if (row.querySelector('.subcampo-add-btn')) {
                        deleteBtn.style.visibility = 'hidden';
                    } else {
                        // Las demás filas siempre pueden eliminarse
                        deleteBtn.style.visibility = 'visible';
                    }
                }
            });
        }
        
        container.addEventListener('click', function(e) {
            // Agregar Lugar
            const addLugarBtn = e.target.closest('.add-lugar-btn');
            if (addLugarBtn) {
                const index = addLugarBtn.getAttribute('data-produccion-index');
                const target = container.querySelector(`[data-lugares-container="${index}"]`);
                if (target && lugarTemplate) {
                    const nuevo = lugarTemplate.cloneNode(true);
                    nuevo.classList.remove('lugar-template-264', 'd-none');
                    const input = nuevo.querySelector('.lugar-input');
                    if (input) {
                        input.name = `lugar_produccion_264_${index}_${Date.now()}`;
                    }
                    target.appendChild(nuevo);
                    updateDeleteButtonsVisibility(target);
                }
                return;
            }
            
            // Agregar Entidad
            const addEntidadBtn = e.target.closest('.add-entidad-btn');
            if (addEntidadBtn) {
                const index = addEntidadBtn.getAttribute('data-produccion-index');
                const target = container.querySelector(`[data-entidades-container="${index}"]`);
                if (target && entidadTemplate) {
                    const nuevo = entidadTemplate.cloneNode(true);
                    nuevo.classList.remove('entidad-template-264', 'd-none');
                    const input = nuevo.querySelector('.entidad-input');
                    if (input) {
                        input.name = `entidad_produccion_264_${index}_${Date.now()}`;
                    }
                    target.appendChild(nuevo);
                    updateDeleteButtonsVisibility(target);
                }
                return;
            }
            
            // Agregar Fecha
            const addFechaBtn = e.target.closest('.add-fecha-btn');
            if (addFechaBtn) {
                const index = addFechaBtn.getAttribute('data-produccion-index');
                const target = container.querySelector(`[data-fechas-container="${index}"]`);
                if (target && fechaTemplate) {
                    const nuevo = fechaTemplate.cloneNode(true);
                    nuevo.classList.remove('fecha-template-264', 'd-none');
                    const input = nuevo.querySelector('.fecha-input');
                    if (input) {
                        input.name = `fecha_produccion_264_${index}_${Date.now()}`;
                    }
                    target.appendChild(nuevo);
                    updateDeleteButtonsVisibility(target);
                }
                return;
            }
            
            // Eliminar Lugar (solo si NO tiene el botón +)
            if (e.target.closest('.delete-lugar-btn')) {
                const row = e.target.closest('.lugar-form-row');
                if (row && !row.classList.contains('lugar-template-264') && !row.querySelector('.subcampo-add-btn')) {
                    const subcampoContainer = row.closest('.subcampo-repetible-container');
                    row.remove();
                    updateDeleteButtonsVisibility(subcampoContainer);
                }
                return;
            }
            
            // Eliminar Entidad (solo si NO tiene el botón +)
            if (e.target.closest('.delete-entidad-btn')) {
                const row = e.target.closest('.entidad-form-row');
                if (row && !row.classList.contains('entidad-template-264') && !row.querySelector('.subcampo-add-btn')) {
                    const subcampoContainer = row.closest('.subcampo-repetible-container');
                    row.remove();
                    updateDeleteButtonsVisibility(subcampoContainer);
                }
                return;
            }
            
            // Eliminar Fecha (solo si NO tiene el botón +)
            if (e.target.closest('.delete-fecha-btn')) {
                const row = e.target.closest('.fecha-form-row');
                if (row && !row.classList.contains('fecha-template-264') && !row.querySelector('.subcampo-add-btn')) {
                    const subcampoContainer = row.closest('.subcampo-repetible-container');
                    row.remove();
                    updateDeleteButtonsVisibility(subcampoContainer);
                }
                return;
            }
        });
        
        // Inicializar visibilidad de todos los contenedores de subcampos
        container.querySelectorAll('.subcampo-repetible-container').forEach(updateDeleteButtonsVisibility);
    }
    
    // Ejecutar cuando el DOM esté listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init264Subcampos);
    } else {
        setTimeout(init264Subcampos, 0);
    }
})();
</script>
