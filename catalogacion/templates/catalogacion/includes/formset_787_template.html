{% comment %}
FORMSET 787 â€“ Otras Relaciones (R)
PatrÃ³n unificado con 773 / 774
{% endcomment %}

<div class="formset-container"
     data-formset-prefix="{{ formset.prefix }}">

    <!-- Management -->
    <div class="d-none">
        {% for hidden in formset.management_form %}
            {{ hidden }}
        {% endfor %}
    </div>

    <div class="formset-forms">

        {% for form in formset %}
        <div class="formset-row {% if form.instance.pk %}existing-form{% endif %} mb-3">

            {% for hidden in form.hidden_fields %}
                {{ hidden }}
            {% endfor %}

            {% if formset.can_delete %}
                <div class="d-none">{{ form.DELETE }}</div>
            {% endif %}

            <button type="button"
                    class="delete-row-btn"
                    title="Eliminar relaciÃ³n">
                <i class="bi bi-x-lg"></i>
            </button>

            <div class="card mt-3">
                

                <div class="card-body">

                    <!-- indicadores -->
                    <div class="d-none">
                        {{ form.primer_indicador }}
                        {{ form.segundo_indicador }}
                    </div>

                    <!-- ================= 787 $a ================= 
                    <div class="mb-3">
                        <label class="form-label small">
                            787 $a â€“ Compositor
                        </label>
                        
                        {{ form.encabezamiento_principal_texto }}
                        
                        {{ form.encabezamiento_principal }} {# hidden FK #}
                        
                        <small class="form-text text-muted">
                            Texto libre (sin bÃºsqueda).
                        </small>
                    </div>
                    
                -->
                <!-- ================= 787 $t ================= 
                <div class="mb-3">
                    <label class="form-label small">
                        787 $t â€“ TÃ­tulo
                        </label>

                        {{ form.titulo }}
                        
                        <small class="form-text text-muted">
                            Texto libre (sin bÃºsqueda).
                        </small>
                    </div>
                    
                    -->
                    <!-- ================= 787 $a ================= -->
                    <div class="mb-3">
                        <label class="form-label small">787 $a â€“ Compositor</label>

                        <div class="autocomplete-wrapper" data-autocomplete="persona">
                            {{ form.encabezamiento_principal_texto }}
                            {{ form.encabezamiento_principal }}
                            <div class="autocomplete-suggestions"></div>
                        </div>

                        <small class="form-text text-muted">
                            Texto libre (sin bÃºsqueda).
                        </small>
                    </div>

                    <!-- ================= 787 $t ================= -->
                    <div class="mb-3">
                        <label class="form-label small">787 $t â€“ TÃ­tulo</label>

                        <div class="autocomplete-wrapper" data-autocomplete="titulo">
                            {{ form.titulo }}
                            <div class="autocomplete-suggestions"></div>
                        </div>

                        <small class="form-text text-muted">
                            Texto libre (sin bÃºsqueda).
                        </small>
                    </div>
                    <!-- ================= 787 $w ================= -->
                    <div class="mt-4">
                        <label class="form-label small fw-semibold">
                            787 $w â€“ NÃºmero de obra relacionada
                        </label>

                        <div class="input-group">
                            <!-- Visible -->
                            <input type="text"
                                class="form-control campo-787-w"
                                placeholder="Seleccione una obra"
                                readonly
                                style="background-color: #f8f9fa; color: #6c757d; cursor: not-allowed;">

                            

                            <!-- FK real -->
                            <input type="hidden"
                                class="obra-relacionada-id-input"
                                name="w_787_{{ enlace.pk }}">
                        </div>
                    </div>

                    
                    </div>


                </div>
            </div>
        </div>
        {% endfor %}

        <!-- ============ EMPTY FORM ============ -->
        <div class="formset-row empty-form d-none">

            {% for hidden in formset.empty_form.hidden_fields %}
                {{ hidden }}
            {% endfor %}

            <button type="button" class="delete-row-btn">
                <i class="bi bi-x-lg"></i>
            </button>

            <div class="card mt-3">
                <div class="card-body">

                    <div class="d-none">
                        {{ formset.empty_form.primer_indicador }}
                        {{ formset.empty_form.segundo_indicador }}
                    </div>

                    <div class="mb-3">
                        <label class="form-label small">787 $a â€“ Compositor</label>
                        <div class="autocomplete-wrapper"
                             data-autocomplete="persona">
                            {{ formset.empty_form.encabezamiento_principal_texto }}
                            <div class="autocomplete-suggestions"></div>
                        </div>
                        {{ formset.empty_form.encabezamiento_principal }}
                        <small class="form-text text-muted">Texto libre (sin bÃºsqueda).</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small">787 $t â€“ TÃ­tulo</label>
                        {{ formset.empty_form.titulo }}
                        <small class="form-text text-muted">Texto libre (sin bÃºsqueda).</small>
                    </div>

                    <div class="mt-3">
                        <label class="form-label small">787 $w â€“ NÃºmero de obra relacionada</label>
                        <input type="text"
                               class="form-control"
                               placeholder="Ej: 001234567">
                    </div>

                </div>
            </div>
        </div>

    </div>
</div>
<script>
(function () {

    /* =====================================================
       AUTOCOMPLETE GENÃ‰RICO (persona / tÃ­tulo)
       ===================================================== */
    function initAutocomplete(wrapper) {

        // ðŸ”¥ CLAVE: permitir reinicializar
        wrapper.removeAttribute("data-autocomplete-init");

        if (!wrapper || wrapper.dataset.autocompleteInit === "1") return;
        wrapper.dataset.autocompleteInit = "1";

        const type  = wrapper.dataset.autocomplete;
        const input = wrapper.querySelector("input");
        const box   = wrapper.querySelector(".autocomplete-suggestions");

        if (!type || !input || !box) return;

        let endpoint = null;

        if (type === "persona") {
            endpoint = "/catalogacion/api/autocompletar/persona/";
        }
        if (type === "titulo") {
            endpoint = "/catalogacion/api/autocompletar/titulo/";
        }
        if (!endpoint) return;

        let timer = null;

        function hide() {
            box.classList.remove("show");
            box.innerHTML = "";
        }

        input.addEventListener("input", () => {
            const q = input.value.trim();
            if (q.length < 2) {
                hide();
                return;
            }

            clearTimeout(timer);
            timer = setTimeout(() => {
                fetch(`${endpoint}?q=${encodeURIComponent(q)}`)
                    .then(r => r.json())
                    .then(data => {
                        box.innerHTML = "";
                        const results = data.results || [];

                        if (!results.length) {
                            box.innerHTML = `
                                <div class="autocomplete-item autocomplete-item-new">
                                    <i class="bi bi-plus-circle me-2"></i>
                                    Crear: "${q}"
                                </div>`;
                        } else {
                            results.forEach(item => {
                                const div = document.createElement("div");
                                div.className = "autocomplete-item";
                                div.textContent = item.text;
                                div.onclick = () => {
                                    input.value = item.text;
                                    hide();
                                };
                                box.appendChild(div);
                            });

                            const crear = document.createElement("div");
                            crear.className = "autocomplete-item autocomplete-item-new";
                            crear.innerHTML = `<i class="bi bi-plus-circle me-2"></i> Crear: "${q}"`;
                            crear.onclick = () => {
                                input.value = q;
                                hide();
                            };
                            box.appendChild(crear);
                        }

                        box.classList.add("show");
                    });
            }, 300);
        });

        document.addEventListener("click", e => {
            if (!wrapper.contains(e.target)) hide();
        });
    }

    /* =====================================================
       HOOK: reinicializar autocomplete al agregar fila
       (evita duplicar filas por handlers globales)
       ===================================================== */
    const THIS_FORMSET_PREFIX = "{{ formset.prefix|escapejs }}";

    // Si existe el gestor central (FormsetManager), Ã©l es el Ãºnico que agrega filas.
    // AquÃ­ solo reinicializamos autocompletes cuando se agrega una nueva fila.
    document.addEventListener("formset:added", function (ev) {
        const detail = ev && ev.detail ? ev.detail : null;
        if (!detail || detail.prefix !== THIS_FORMSET_PREFIX) return;

        const root = detail.newForm;
        if (!root || !root.querySelectorAll) return;

        root
            .querySelectorAll(".autocomplete-wrapper[data-autocomplete]")
            .forEach((w) => {
                w.removeAttribute("data-autocomplete-init");
                initAutocomplete(w);
            });
    });

    /* =====================================================
       INIT INICIAL
       ===================================================== */
    document
        .querySelectorAll(".autocomplete-wrapper[data-autocomplete]")
        .forEach(initAutocomplete);

})();
</script>
