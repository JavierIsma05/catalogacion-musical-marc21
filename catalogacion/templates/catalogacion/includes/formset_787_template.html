{% comment %}
FORMSET 787 â€“ Otras Relaciones (R)
PatrÃ³n unificado con 773 / 774
{% endcomment %}

<div class="formset-container"
     data-formset-prefix="{{ formset.prefix }}">

    <!-- Management -->
    <div class="d-none">
        {% for hidden in formset.management_form %}
            {{ hidden }}
        {% endfor %}
    </div>

    <div class="formset-forms">

        {% for form in formset %}
        <div class="formset-row {% if form.instance.pk %}existing-form{% endif %} mb-3">

            {% for hidden in form.hidden_fields %}
                {{ hidden }}
            {% endfor %}

            {% if formset.can_delete %}
                <div class="d-none">{{ form.DELETE }}</div>
            {% endif %}

            <!-- âŒ eliminar -->
            <button type="button"
                    class="delete-row-btn"
                    title="Eliminar relaciÃ³n">
                <i class="bi bi-x-lg"></i>
            </button>

            <div class="card mt-3">
                

                <div class="card-body">

                    <!-- indicadores -->
                    <div class="d-none">
                        {{ form.primer_indicador }}
                        {{ form.segundo_indicador }}
                    </div>

                    <!-- ================= 787 $a ================= -->
                    <div class="mb-3">
                        <label class="form-label small">
                            787 $a â€“ Compositor
                        </label>

                        <div class="autocomplete-wrapper"
                             data-autocomplete="persona">
                            {{ form.encabezamiento_principal_texto }}
                            <div class="autocomplete-suggestions"></div>
                        </div>

                        {{ form.encabezamiento_principal }} {# hidden FK #}

                        <small class="form-text text-muted">
                            Busque una persona o escriba para crearla.
                        </small>
                    </div>

                    <!-- ================= 787 $t ================= -->
                    <div class="mb-3">
                        <label class="form-label small">
                            787 $t â€“ TÃ­tulo
                        </label>

                        <div class="autocomplete-wrapper"
                             data-autocomplete="titulo">
                            {{ form.titulo }}
                            <div class="autocomplete-suggestions"></div>
                        </div>
                    </div>

                    <!-- ================= 787 $w ================= -->
                    <div class="mt-4">
                        <label class="form-label small fw-semibold">
                            787 $w â€“ NÃºmero de obra relacionada
                        </label>

                        <div class="input-group">
                            <!-- Visible: muestra el 001 -->
                            <input type="text"
                                class="form-control numero-w-input"
                                placeholder="Seleccione una obra"
                                readonly>

                            <!-- BotÃ³n lupa -->
                            <button type="button"
                                    class="btn btn-outline-secondary btn-buscar-obra"
                                    data-enlace-id="{{ enlace.pk }}"
                                    data-campo="787"
                                    title="Buscar obra">
                                <i class="bi bi-search"></i>
                            </button>

                            <!-- ðŸ”¥ FK real hacia ObraGeneral -->
                            <input type="hidden"
                                class="obra-relacionada-id-input"
                                name="w_787_{{ enlace.pk }}">
                        </div>
                    </div>


                </div>
            </div>
        </div>
        {% endfor %}

        <!-- ============ EMPTY FORM ============ -->
        <div class="formset-row empty-form d-none">

            {% for hidden in formset.empty_form.hidden_fields %}
                {{ hidden }}
            {% endfor %}

            <button type="button" class="delete-row-btn">
                <i class="bi bi-x-lg"></i>
            </button>

            <div class="card mt-3">
                <div class="card-body">

                    <div class="d-none">
                        {{ formset.empty_form.primer_indicador }}
                        {{ formset.empty_form.segundo_indicador }}
                    </div>

                    <div class="mb-3">
                        <label class="form-label small">787 $a â€“ Compositor</label>
                        <div class="autocomplete-wrapper"
                             data-autocomplete="persona">
                            {{ formset.empty_form.encabezamiento_principal_texto }}
                            <div class="autocomplete-suggestions"></div>
                        </div>
                        {{ formset.empty_form.encabezamiento_principal }}
                    </div>

                    <div class="mb-3">
                        <label class="form-label small">787 $t â€“ TÃ­tulo</label>
                        <div class="autocomplete-wrapper"
                             data-autocomplete="titulo">
                            {{ formset.empty_form.titulo }}
                            <div class="autocomplete-suggestions"></div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <label class="form-label small">787 $w â€“ NÃºmero de obra relacionada</label>
                        <input type="text"
                               class="form-control"
                               placeholder="Ej: 001234567">
                    </div>

                </div>
            </div>
        </div>

    </div>
</div>
<script>
(function () {

    /* =====================================================
       AUTOCOMPLETE GENÃ‰RICO (persona / tÃ­tulo)
       ===================================================== */
    function initAutocomplete(wrapper) {

        // ðŸ”¥ CLAVE: permitir reinicializar
        wrapper.removeAttribute("data-autocomplete-init");

        if (!wrapper || wrapper.dataset.autocompleteInit === "1") return;
        wrapper.dataset.autocompleteInit = "1";

        const type  = wrapper.dataset.autocomplete;
        const input = wrapper.querySelector("input");
        const box   = wrapper.querySelector(".autocomplete-suggestions");

        if (!type || !input || !box) return;

        let endpoint = null;

        if (type === "persona") {
            endpoint = "/catalogacion/api/autocompletar/persona/";
        }
        if (type === "titulo") {
            endpoint = "/catalogacion/api/autocompletar/titulo-uniforme/";
        }
        if (!endpoint) return;

        let timer = null;

        function hide() {
            box.classList.remove("show");
            box.innerHTML = "";
        }

        input.addEventListener("input", () => {
            const q = input.value.trim();
            if (q.length < 2) {
                hide();
                return;
            }

            clearTimeout(timer);
            timer = setTimeout(() => {
                fetch(`${endpoint}?q=${encodeURIComponent(q)}`)
                    .then(r => r.json())
                    .then(data => {
                        box.innerHTML = "";
                        const results = data.results || [];

                        if (!results.length) {
                            box.innerHTML = `
                                <div class="autocomplete-item autocomplete-item-new">
                                    <i class="bi bi-plus-circle me-2"></i>
                                    Crear: "${q}"
                                </div>`;
                        } else {
                            results.forEach(item => {
                                const div = document.createElement("div");
                                div.className = "autocomplete-item";
                                div.textContent = item.text;
                                div.onclick = () => {
                                    input.value = item.text;
                                    hide();
                                };
                                box.appendChild(div);
                            });

                            const crear = document.createElement("div");
                            crear.className = "autocomplete-item autocomplete-item-new";
                            crear.innerHTML = `<i class="bi bi-plus-circle me-2"></i> Crear: "${q}"`;
                            crear.onclick = () => {
                                input.value = q;
                                hide();
                            };
                            box.appendChild(crear);
                        }

                        box.classList.add("show");
                    });
            }, 300);
        });

        document.addEventListener("click", e => {
            if (!wrapper.contains(e.target)) hide();
        });
    }

    /* =====================================================
       BOTÃ“N GLOBAL + (formsets)
       ===================================================== */
    document.addEventListener("click", function (e) {

        const btn = e.target.closest(".campo-add-btn");
        if (!btn) return;

        const prefix = btn.dataset.formsetTarget;
        if (!prefix) return;

        const container = document.querySelector(
            `.formset-container[data-formset-prefix="${prefix}"]`
        );
        if (!container) return;

        const forms = container.querySelector(".formset-forms");
        const empty = container.querySelector(".empty-form");
        const totalInput = container.querySelector(
            `input[name="${prefix}-TOTAL_FORMS"]`
        );

        if (!forms || !empty || !totalInput) return;

        const index = parseInt(totalInput.value, 10);

        const clone = empty.cloneNode(true);
        clone.classList.remove("empty-form", "d-none");
        clone.innerHTML = clone.innerHTML.replace(/__prefix__/g, index);

        forms.appendChild(clone);
        totalInput.value = index + 1;

        // ðŸ”¥ REINICIALIZAR AUTOCOMPLETE EN CLON
        clone
            .querySelectorAll(".autocomplete-wrapper[data-autocomplete]")
            .forEach(w => {
                w.removeAttribute("data-autocomplete-init");
                initAutocomplete(w);
            });
    });

    /* =====================================================
       INIT INICIAL
       ===================================================== */
    document
        .querySelectorAll(".autocomplete-wrapper[data-autocomplete]")
        .forEach(initAutocomplete);

})();
</script>
