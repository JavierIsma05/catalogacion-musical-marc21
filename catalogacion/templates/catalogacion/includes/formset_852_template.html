{% comment %}
Template 852 – Ubicación Física
Estilo unificado con 856
Autocomplete estable en $a (incluye clonados)
{% endcomment %}

<div class="formset-container" data-formset-prefix="{{ formset.prefix }}">
    <div style="display:none;">
        {% for field in formset.management_form %}
            {{ field }}
        {% endfor %}
    </div>

    <div class="formset-forms">

        {% for form in formset %}
        <div class="formset-row {% if form.instance.pk %}existing-form{% endif %} mb-3">

            {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
            {% if formset.can_delete %}<div class="d-none">{{ form.DELETE }}</div>{% endif %}

            <button type="button" class="delete-row-btn" title="Eliminar ubicación">
                <i class="bi bi-x-lg"></i>
            </button>

            <div class="campo-grid">

                <!-- 852 $a -->
                <div class="col-half">
                    <label class="form-label small">852 $a – Institución / Persona</label>
                    <div class="autocomplete-wrapper" data-autocomplete="persona">
                        {{ form.codigo_o_nombre }}
                        {{ form.autoridad_model }}
                        {{ form.autoridad_id }}
                        <div class="autocomplete-suggestions autoridad852-suggestions list-group"></div>
                    </div>
                </div>

                <!-- 852 $h -->
                <div class="col-half">
                    <label class="form-label small">852 $h – Signatura original</label>
                    {{ form.signatura_original }}
                </div>

                <!-- 852 $c -->
                <div class="col-full">
                    <label class="form-label small">852 $c – Estantería</label>

                    <div class="subcampo-repetible-container estanterias-container"
                         data-estanterias-container="{{ forloop.counter0 }}">

                        {% if form.instance.pk %}
                            {% for est in form.instance.estanterias.all %}
                            <div class="subcampo-row estanteria-form-row">
                                {% if forloop.first %}
                                <button type="button"
                                        class="subcampo-add-btn add-estanteria-btn"
                                        data-ubicacion-index="{{ forloop.parentloop.counter0 }}">
                                    <i class="bi bi-plus"></i>
                                </button>
                                {% else %}
                                <div class="subcampo-placeholder"></div>
                                {% endif %}

                                <input type="text"
                                       class="form-control estanteria-input"
                                       name="estanteria_ubicacion_852_{{ forloop.parentloop.counter0 }}_{{ est.pk }}"
                                       value="{{ est.estanteria }}">

                                <button type="button"
                                        class="subcampo-delete-btn delete-estanteria-btn"
                                        {% if forloop.first and forloop.last %}style="visibility:hidden"{% endif %}>
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="subcampo-row estanteria-form-row">
                                <button type="button"
                                        class="subcampo-add-btn add-estanteria-btn"
                                        data-ubicacion-index="{{ forloop.counter0 }}">
                                    <i class="bi bi-plus"></i>
                                </button>

                                <input type="text"
                                       class="form-control estanteria-input"
                                       name="estanteria_ubicacion_852_{{ forloop.counter0 }}_0">

                                <button type="button"
                                        class="subcampo-delete-btn delete-estanteria-btn"
                                        style="visibility:hidden">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        {% endif %}
                    </div>
                </div>

            </div>
        </div>
        {% endfor %}

        <!-- EMPTY FORM -->
        <div class="formset-row empty-form mb-3" style="display:none;">
            <button type="button" class="delete-row-btn"><i class="bi bi-x-lg"></i></button>

            <div class="campo-grid">
                <div class="col-half">
                    <label class="form-label small">852 $a – Institución / Persona</label>
                    <div class="autocomplete-wrapper" data-autocomplete="persona">
                        {{ formset.empty_form.codigo_o_nombre }}
                        {{ formset.empty_form.autoridad_model }}
                        {{ formset.empty_form.autoridad_id }}
                        <div class="autocomplete-suggestions autoridad852-suggestions list-group"></div>
                    </div>
                </div>

                <div class="col-half">
                    <label class="form-label small">852 $h – Signatura original</label>
                    {{ formset.empty_form.signatura_original }}
                </div>

                <div class="col-full">
                    <label class="form-label small">852 $c – Estantería</label>
                    <div class="subcampo-repetible-container estanterias-container"
                         data-estanterias-container="__prefix__">

                        <div class="subcampo-row estanteria-form-row">
                            <button type="button"
                                    class="subcampo-add-btn add-estanteria-btn"
                                    data-ubicacion-index="__prefix__">
                                <i class="bi bi-plus"></i>
                            </button>

                            <input type="text"
                                   class="form-control estanteria-input"
                                   name="estanteria_ubicacion_852___prefix___0">

                            <button type="button"
                                    class="subcampo-delete-btn delete-estanteria-btn"
                                    style="visibility:hidden">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
(function () {
    const root = document.querySelector('[data-formset-prefix="{{ formset.prefix }}"]');
    if (!root) return;

    const formsContainer = root.querySelector(".formset-forms");
    const emptyForm = root.querySelector(".formset-row.empty-form");

    function updateDeleteVisibility(container) {
        container.querySelectorAll(".estanteria-form-row").forEach((row, i) => {
            const btn = row.querySelector(".delete-estanteria-btn");
            if (btn) btn.style.visibility = i === 0 ? "hidden" : "visible";
        });
    }

    function createEstanteriaRow(index) {
        const row = document.createElement("div");
        row.className = "subcampo-row estanteria-form-row";
        row.innerHTML = `
            <div class="subcampo-placeholder"></div>
            <input type="text" class="form-control estanteria-input"
                   name="estanteria_ubicacion_852_${index}_${Date.now()}">
            <button type="button" class="subcampo-delete-btn delete-estanteria-btn">
                <i class="bi bi-x-lg"></i>
            </button>`;
        return row;
    }

    // Delegación de eventos para autocomplete - funciona en todos los inputs existentes y futuros
    root.addEventListener("input", e => {
        const wrapper = e.target.closest(".autocomplete-wrapper[data-autocomplete='persona']");
        if (!wrapper) return;

        const input = wrapper.querySelector("input");
        const box = wrapper.querySelector(".autoridad852-suggestions");
        if (!input || !box) return;

        const q = input.value.trim();
        if (!q) { 
            box.classList.remove("show"); 
            box.innerHTML = ""; 
            return; 
        }

        console.log('Formset 852: Buscando autoridad con query:', q);
        fetch(`/catalogacion/api/autocompletar/autoridad/?q=${encodeURIComponent(q)}`)
            .then(r => r.json())
            .then(d => {
                console.log('Formset 852: Respuesta recibida:', d);
                box.innerHTML = (d.results || []).map(i =>
                    `<div class="list-group-item suggestion-item"
                         data-id="${i.id}" data-model="${i.model}">
                        <strong>${i.text}</strong>
                     </div>`).join("");
                box.classList.add("show");
            })
            .catch(err => {
                console.error('Formset 852: Error en búsqueda:', err);
                box.classList.remove("show");
            });
    });

    // Delegación de eventos para click en sugerencias
    root.addEventListener("click", e => {
        const item = e.target.closest(".suggestion-item");
        if (!item) return;

        const box = item.closest(".autoridad852-suggestions");
        if (!box) return;

        const wrapper = box.closest(".autocomplete-wrapper");
        if (!wrapper) return;

        const input = wrapper.querySelector("input");
        if (!input) return;

        input.value = item.textContent.trim();
        const row = input.closest(".formset-row");
        if (row) {
            const modelInput = row.querySelector('input[name$="-autoridad_model"]');
            const idInput = row.querySelector('input[name$="-autoridad_id"]');
            if (modelInput) modelInput.value = item.dataset.model;
            if (idInput) idInput.value = item.dataset.id;
        }
        box.classList.remove("show");
    });

    // Delegación de eventos para blur (ocultar sugerencias)
    root.addEventListener("blur", e => {
        const wrapper = e.target.closest(".autocomplete-wrapper[data-autocomplete='persona']");
        if (!wrapper) return;

        const box = wrapper.querySelector(".autoridad852-suggestions");
        if (box) {
            setTimeout(() => box.classList.remove("show"), 200);
        }
    }, true); // Usar capture phase

    // Eventos de estanterías (mantener lógica existente)
    root.addEventListener("click", e => {
        const add = e.target.closest(".add-estanteria-btn");
        if (add) {
            const c = root.querySelector(`[data-estanterias-container="${add.dataset.ubicacionIndex}"]`);
            c.appendChild(createEstanteriaRow(add.dataset.ubicacionIndex));
            updateDeleteVisibility(c);
        }

        const del = e.target.closest(".delete-estanteria-btn");
        if (del) {
            const c = del.closest(".estanterias-container");
            del.closest(".estanteria-form-row").remove();
            updateDeleteVisibility(c);
        }

        // delete-row-btn es manejado por formset-manager.js
        // NO duplicar aquí para evitar desincronizar TOTAL_FORMS
    });

    // Inicialización de estanterías existentes
    root.querySelectorAll(".estanterias-container").forEach(updateDeleteVisibility);

    // Función global para agregar ubicaciones (mantener compatibilidad)
    window.addUbicacion852 = () => {
        const f = emptyForm.cloneNode(true);
        f.classList.remove("empty-form");
        f.style.display = "block";
        formsContainer.appendChild(f);
    };
})();
</script>
