{% comment %}
Template 852 – Ubicación Física
Estilo unificado con 856 (botones + / X, grid, subcampos)
Lógica intacta
{% endcomment %}

<div class="formset-container" data-formset-prefix="{{ formset.prefix }}">
    <div style="display:none;">
        {% for field in formset.management_form %}
            {{ field }}
        {% endfor %}
    </div>

    <div class="formset-forms">

        {% for form in formset %}
        <div class="formset-row {% if form.instance.pk %}existing-form{% endif %} mb-3">

            {% for hidden in form.hidden_fields %}
                {{ hidden }}
            {% endfor %}

            {% if formset.can_delete %}
            <div class="d-none">
                {{ form.DELETE }}
            </div>
            {% endif %}

            <!-- Botón eliminar ubicación 852 -->
            <button type="button" class="delete-row-btn" title="Eliminar ubicación">
                <i class="bi bi-x-lg"></i>
            </button>

            <div class="campo-grid">

                <!-- 852 $a -->
                <div class="col-half">
                    <label class="form-label small">852 $a – Institución / Persona</label>

                    <div class="autocomplete-wrapper">
                        {{ form.codigo_o_nombre }}
                        <div class="autocomplete-suggestions autoridad852-suggestions"></div>
                    </div>

                    <small class="form-text text-muted">
                        Código o nombre (si no está en Autoridades)
                    </small>
                </div>

                <!-- 852 $h -->
                <div class="col-half">
                    <label class="form-label small">852 $h – Signatura original</label>
                    {{ form.signatura_original }}
                </div>

                <!-- 852 $c – Estanterías -->
                <div class="col-full">
                    <label class="form-label small">852 $c – Estantería</label>

                    <div class="subcampo-repetible-container estanterias-container"
                        data-estanterias-container="{{ forloop.counter0 }}" data-borrador-container="estanteria_ubicacion_852" data-borrador-parent="{{ forloop.counter0 }}">

                        {% if form.instance.pk %}
                            {% for estanteria in form.instance.estanterias.all %}
                            <div class="subcampo-row estanteria-form-row">

                                {% if forloop.first %}
                                <button type="button"
                                        class="subcampo-add-btn add-estanteria-btn"
                                        data-ubicacion-index="{{ forloop.parentloop.counter0 }}"
                                        data-borrador-add="estanteria_ubicacion_852"
                                        data-borrador-parent="{{ forloop.parentloop.counter0 }}"
                                        title="Agregar estantería">
                                    <i class="bi bi-plus"></i>
                                </button>
                                {% else %}
                                <div class="subcampo-placeholder"></div>
                                {% endif %}

                                <input type="text"
                                       class="form-control estanteria-input"
                                       name="estanteria_ubicacion_852_{{ forloop.parentloop.counter0 }}_{{ estanteria.pk }}"
                                       value="{{ estanteria.estanteria }}"
                                       placeholder="Ej: Sala A, Estante 3">

                                <button type="button"
                                        class="subcampo-delete-btn delete-estanteria-btn"
                                        title="Eliminar"
                                        {% if forloop.first and forloop.last %}style="visibility:hidden;"{% endif %}>
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="subcampo-row estanteria-form-row">
                                <button type="button"
                                        class="subcampo-add-btn add-estanteria-btn"
                                        data-ubicacion-index="{{ forloop.counter0 }}"
                                        data-borrador-add="estanteria_ubicacion_852"
                                        data-borrador-parent="{{ forloop.counter0 }}"
                                        title="Agregar estantería">
                                    <i class="bi bi-plus"></i>
                                </button>

                                <input type="text"
                                       class="form-control estanteria-input"
                                       name="estanteria_ubicacion_852_{{ forloop.counter0 }}_0"
                                       placeholder="Ej: Sala A, Estante 3">

                                <button type="button"
                                        class="subcampo-delete-btn delete-estanteria-btn"
                                        title="Eliminar"
                                        style="visibility:hidden;">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        {% endif %}
                    </div>
                </div>

            </div>
        </div>
        {% endfor %}

        <!-- Empty form -->
        <div class="formset-row empty-form mb-3" style="display:none;">
            <button type="button" class="delete-row-btn" title="Eliminar ubicación">
                <i class="bi bi-x-lg"></i>
            </button>

            <div class="campo-grid">

                <div class="col-half">
                    <label class="form-label small">852 $a – Institución / Persona</label>
                    {{ formset.empty_form.codigo_o_nombre }}
                </div>

                <div class="col-half">
                    <label class="form-label small">852 $h – Signatura original</label>
                    {{ formset.empty_form.signatura_original }}
                </div>

                <div class="col-full">
                    <label class="form-label small">852 $c – Estantería</label>

                    <div class="subcampo-repetible-container estanterias-container"
                        data-estanterias-container="__prefix__" data-borrador-container="estanteria_ubicacion_852" data-borrador-parent="__prefix__">

                        <div class="subcampo-row estanteria-form-row">
                            <button type="button"
                                    class="subcampo-add-btn add-estanteria-btn"
                                    data-ubicacion-index="__prefix__"
                                    data-borrador-add="estanteria_ubicacion_852"
                                    data-borrador-parent="__prefix__"
                                    title="Agregar estantería">
                                <i class="bi bi-plus"></i>
                            </button>

                            <input type="text"
                                   class="form-control estanteria-input"
                                   name="estanteria_ubicacion_852___prefix___0"
                                   placeholder="Ej: Sala A, Estante 3">

                            <button type="button"
                                    class="subcampo-delete-btn delete-estanteria-btn"
                                    title="Eliminar"
                                    style="visibility:hidden;">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>
</div>


<script>
/**
 * 852 $c – Estanterías repetibles (estilo 856)
 * - + solo en la primera fila
 * - X oculto en la primera fila
 * - filas nuevas: placeholder + input + X
 */
(function () {
    const prefix = "{{ formset.prefix }}";
    const root = document.querySelector(`[data-formset-prefix="${prefix}"]`);
    if (!root) return;

    // Crear fila nueva (sin +, con placeholder)
    function createEstanteriaRow(index) {
        const row = document.createElement("div");
        row.className = "subcampo-row estanteria-form-row mt-2";
        row.innerHTML = `
            <div class="subcampo-placeholder"></div>
            <input type="text"
                   class="form-control estanteria-input"
                   name="estanteria_ubicacion_852_${index}_${Date.now()}"
                   placeholder="Ej: Sala A, Estante 3">
            <button type="button"
                    class="subcampo-delete-btn delete-estanteria-btn"
                    title="Eliminar">
                <i class="bi bi-x-lg"></i>
            </button>
        `;
        return row;
    }

    // Oculta X en la primera fila siempre
    function updateDeleteVisibility(container) {
        const rows = container.querySelectorAll(".estanteria-form-row");
        rows.forEach((row, idx) => {
            const del = row.querySelector(".delete-estanteria-btn");
            if (!del) return;
            del.style.visibility = (idx === 0) ? "hidden" : "visible";
        });
    }

    // Delegación de eventos (funciona también para forms agregados dinámicamente)
    root.addEventListener("click", function (e) {

        // Agregar estantería
        const addBtn = e.target.closest(".add-estanteria-btn");
        if (addBtn) {
            const index = addBtn.getAttribute("data-ubicacion-index");
            const target = root.querySelector(`[data-estanterias-container="${index}"]`);
            if (!target) return;

            target.appendChild(createEstanteriaRow(index));
            updateDeleteVisibility(target);
            return;
        }

        // Eliminar estantería
        const delBtn = e.target.closest(".delete-estanteria-btn");
        if (delBtn) {
            const row = delBtn.closest(".estanteria-form-row");
            const target = delBtn.closest(".estanterias-container");
            if (!row || !target) return;

            row.remove();
            updateDeleteVisibility(target);
            return;
        }
    });

    // Inicializar visibilidad de X en contenedores ya cargados
    root.querySelectorAll(".estanterias-container").forEach(updateDeleteVisibility);

})();
</script>
