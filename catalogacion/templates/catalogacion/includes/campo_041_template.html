{% comment %}
Template personalizado para campo 041 - Código de Lengua
Incluye indicadores y visualización del subcampo $a (idiomas)
El subcampo $a usa las opciones de CODIGOS_LENGUAJE del modelo
{% endcomment %}
{% load catalogacion_tags %}

{# Cargar las opciones de idiomas una sola vez al inicio #}
{% get_codigos_lenguaje as codigos_idioma %}

<div class="formset-container" data-formset-prefix="{{ formset.prefix }}">
    {{ formset.management_form }}
    
    <div class="formset-forms">
        {% for form in formset %}
        <div class="formset-row {% if form.instance.pk %}existing-form{% endif %}">
            {% if form.instance.pk %}
                <input type="hidden" name="{{ form.prefix }}-id" value="{{ form.instance.pk }}">
            {% endif %}
            
            {% if formset.can_delete %}
                <div class="d-none">
                    {{ form.DELETE }}
                </div>
            {% endif %}
            
            <button type="button" class="delete-row-btn" title="Eliminar">
                <i class="bi bi-x-lg"></i>
            </button>
            
            <div class="campo-grid">
                {# Indicadores del campo 041 #}
                <div class="col-half">
                    <label class="form-label" for="{{ form.indicacion_traduccion.id_for_label }}">
                        {{ form.indicacion_traduccion.label }}
                    </label>
                    {{ form.indicacion_traduccion }}
                    {% if form.indicacion_traduccion.errors %}
                        <div class="invalid-feedback d-block">{{ form.indicacion_traduccion.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="col-half">
                    <label class="form-label" for="{{ form.fuente_codigo.id_for_label }}">
                        {{ form.fuente_codigo.label }}
                    </label>
                    {{ form.fuente_codigo }}
                    {% if form.fuente_codigo.errors %}
                        <div class="invalid-feedback d-block">{{ form.fuente_codigo.errors }}</div>
                    {% endif %}
                </div>
                
                {# Subcampo $a - Idiomas (Repetible) con botón + a la izquierda #}
                <div class="col-full">
                    <label class="form-label small">041 $a - Código de idioma</label>
                        <div class="subcampo-repetible-container idiomas-041-container" data-idiomas-container="{{ forloop.counter0 }}" data-borrador-container="idioma_lengua" data-borrador-parent="{{ forloop.counter0 }}">
                        {# Fila inicial #}
                        <div class="subcampo-row idioma-form-row">
                            <button type="button" class="subcampo-add-btn add-idioma-btn" data-lengua-index="{{ forloop.counter0 }}" data-borrador-add="idioma_lengua" data-borrador-parent="{{ forloop.counter0 }}" title="Agregar Idioma">
                                <i class="bi bi-plus"></i>
                            </button>
                            <select class="form-select idioma-select-041" name="idioma_lengua_{{ forloop.counter0 }}_0">
                                <option value="">Seleccione un idioma...</option>
                                {% for codigo, nombre in codigos_idioma %}
                                <option value="{{ codigo }}">{{ nombre }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" class="subcampo-delete-btn delete-idioma-btn" title="Eliminar" style="visibility: hidden;">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        
        {# Template vacío para clonar códigos de lengua #}
        <div class="formset-row empty-form">
            <button type="button" class="delete-row-btn" title="Eliminar">
                <i class="bi bi-x-lg"></i>
            </button>
            
            <div class="campo-grid">
                <div class="col-half">
                    <label class="form-label">
                        {{ formset.empty_form.indicacion_traduccion.label }}
                    </label>
                    {{ formset.empty_form.indicacion_traduccion }}
                </div>
                
                <div class="col-half">
                    <label class="form-label">
                        {{ formset.empty_form.fuente_codigo.label }}
                    </label>
                    {{ formset.empty_form.fuente_codigo }}
                </div>
                
                <div class="col-full">
                    <label class="form-label small">041 $a - Código de idioma</label>
                    <div class="subcampo-repetible-container idiomas-041-container" data-idiomas-container="__prefix__" data-borrador-container="idioma_lengua" data-borrador-parent="__prefix__">
                        <div class="subcampo-row idioma-form-row">
                            <button type="button" class="subcampo-add-btn add-idioma-btn" data-lengua-index="__prefix__" data-borrador-add="idioma_lengua" data-borrador-parent="__prefix__" title="Agregar Idioma">
                                <i class="bi bi-plus"></i>
                            </button>
                            <select class="form-select idioma-select-041" name="idioma_lengua___prefix___0">
                                <option value="">Seleccione un idioma...</option>
                                {% for codigo, nombre in codigos_idioma %}
                                <option value="{{ codigo }}">{{ nombre }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" class="subcampo-delete-btn delete-idioma-btn" title="Eliminar" style="visibility: hidden;">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{# Template global para nuevos idiomas (fuera del formset) #}
<div class="subcampo-row idioma-form-row idioma-template-041 d-none">
    <div class="subcampo-placeholder"></div>
    <select class="form-select idioma-select-041" name="">
        <option value="">Seleccione un idioma...</option>
        {% for codigo, nombre in codigos_idioma %}
        <option value="{{ codigo }}">{{ nombre }}</option>
        {% endfor %}
    </select>
    <button type="button" class="subcampo-delete-btn delete-idioma-btn" title="Eliminar">
        <i class="bi bi-x-lg"></i>
    </button>
</div>

<script>
/**
 * Script para subcampos repetibles del campo 041 $a (Idiomas)
 * Usa selects nativos del navegador (sin Select2)
 */
(function() {
    function init041Subcampos() {
        const prefix = '{{ formset.prefix }}';
        const container = document.querySelector(`[data-formset-prefix="${prefix}"]`);
        if (!container || container.dataset.subcampos041Initialized) return;
        container.dataset.subcampos041Initialized = 'true';
        
        const idiomaTemplate = document.querySelector('.idioma-template-041');
        if (!idiomaTemplate) return;
        
        // Función para actualizar visibilidad de botones de eliminar
        function updateDeleteButtonsVisibility(subcampoContainer) {
            const rows = subcampoContainer.querySelectorAll('.subcampo-row:not(.d-none):not(.idioma-template-041)');
            rows.forEach((row) => {
                const deleteBtn = row.querySelector('.subcampo-delete-btn');
                if (deleteBtn) {
                    if (row.querySelector('.subcampo-add-btn')) {
                        deleteBtn.style.visibility = 'hidden';
                    } else {
                        deleteBtn.style.visibility = 'visible';
                    }
                }
            });
        }
        
        container.addEventListener('click', function(e) {
            // Agregar Idioma
            const addIdiomaBtn = e.target.closest('.add-idioma-btn');
            if (addIdiomaBtn) {
                const index = addIdiomaBtn.getAttribute('data-lengua-index');
                const target = container.querySelector(`[data-idiomas-container="${index}"]`);
                if (target && idiomaTemplate) {
                    const nuevo = idiomaTemplate.cloneNode(true);
                    nuevo.classList.remove('idioma-template-041', 'd-none');
                    const select = nuevo.querySelector('.idioma-select-041');
                    if (select) {
                        select.name = `idioma_lengua_${index}_${Date.now()}`;
                    }
                    target.appendChild(nuevo);
                    updateDeleteButtonsVisibility(target);
                }
                return;
            }
            
            // Eliminar Idioma (solo si NO tiene el botón +)
            const deleteIdiomaBtn = e.target.closest('.delete-idioma-btn');
            if (deleteIdiomaBtn) {
                const row = deleteIdiomaBtn.closest('.idioma-form-row');
                if (row && !row.classList.contains('idioma-template-041') && !row.querySelector('.subcampo-add-btn')) {
                    const subcampoContainer = row.closest('.subcampo-repetible-container');
                    row.remove();
                    updateDeleteButtonsVisibility(subcampoContainer);
                }
                return;
            }
        });
        
        // Inicializar visibilidad de botones
        container.querySelectorAll('.idiomas-041-container').forEach(updateDeleteButtonsVisibility);
        
        // Observar cuando se agregan nuevos formularios 041 (clonados del empty-form)
        const formsContainer = container.querySelector('.formset-forms');
        if (formsContainer) {
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === Node.ELEMENT_NODE && node.classList.contains('formset-row') && !node.classList.contains('empty-form')) {
                            setTimeout(function() {
                                node.querySelectorAll('.idiomas-041-container').forEach(updateDeleteButtonsVisibility);
                            }, 50);
                        }
                    });
                });
            });
            
            observer.observe(formsContainer, { childList: true });
        }
    }
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init041Subcampos);
    } else {
        setTimeout(init041Subcampos, 50);
    }
})();
</script>
