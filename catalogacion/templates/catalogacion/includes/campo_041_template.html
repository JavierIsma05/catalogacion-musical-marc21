{% comment %}
Template personalizado para campo 041 - Código de Lengua
Incluye indicadores y visualización del subcampo $a (idiomas)
Los idiomas se gestionan mediante un formset separado después de guardar
El botón de agregar campo completo está en el header del campo (campo-add-btn)
{% endcomment %}
{% load catalogacion_tags %}

{# Cargar las opciones de idiomas una sola vez al inicio #}
{% get_codigos_lenguaje as codigos_idioma %}

<div class="formset-container" data-formset-prefix="{{ formset.prefix }}">
    {{ formset.management_form }}
    
    <div class="formset-forms">
        {% for form in formset %}
        <div class="formset-row {% if form.instance.pk %}existing-form{% endif %}">
            {% if form.instance.pk %}
                <input type="hidden" name="{{ form.prefix }}-id" value="{{ form.instance.pk }}">
            {% endif %}
            
            {% if formset.can_delete %}
                <div class="d-none">
                    {{ form.DELETE }}
                </div>
            {% endif %}
            
            <button type="button" class="delete-row-btn" title="Eliminar">
                <i class="bi bi-x-lg"></i>
            </button>
            
            <div class="campo-grid">
                {# Indicadores del campo 041 #}
                <div class="col-half">
                    <label class="form-label" for="{{ form.indicacion_traduccion.id_for_label }}">
                        {{ form.indicacion_traduccion.label }}
                    </label>
                    {{ form.indicacion_traduccion }}
                    {% if form.indicacion_traduccion.errors %}
                        <div class="invalid-feedback d-block">{{ form.indicacion_traduccion.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="col-half">
                    <label class="form-label" for="{{ form.fuente_codigo.id_for_label }}">
                        {{ form.fuente_codigo.label }}
                    </label>
                    {{ form.fuente_codigo }}
                    {% if form.fuente_codigo.errors %}
                        <div class="invalid-feedback d-block">{{ form.fuente_codigo.errors }}</div>
                    {% endif %}
                </div>
                
                {# Subcampo $a - Idiomas (Repetible) con botón + a la izquierda #}
                <div class="col-full">
                    <label class="form-label small">041 $a - Código de idioma</label>
                    <div class="subcampo-repetible-container" data-idiomas-container="{{ forloop.counter0 }}">
                        {# Fila inicial vacía para que siempre exista al menos una #}
                        <div class="subcampo-row">
                            <button type="button" class="subcampo-add-btn add-idioma-btn" data-lengua-index="{{ forloop.counter0 }}" title="Agregar Idioma">
                                <i class="bi bi-plus"></i>
                            </button>
                            <select class="form-select idioma-select" name="idioma_lengua_{{ forloop.counter0 }}_0">
                                <option value="">Seleccione un idioma...</option>
                                {% for codigo, nombre in codigos_idioma %}
                                <option value="{{ codigo }}">{{ nombre }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" class="subcampo-delete-btn delete-idioma-btn" title="Eliminar" style="visibility: hidden;">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        
        {# Template vacío para clonar códigos de lengua #}
        <div class="formset-row empty-form">
            <button type="button" class="delete-row-btn" title="Eliminar">
                <i class="bi bi-x-lg"></i>
            </button>
            
            <div class="campo-grid">
                <div class="col-half">
                    <label class="form-label">
                        {{ formset.empty_form.indicacion_traduccion.label }}
                    </label>
                    {{ formset.empty_form.indicacion_traduccion }}
                </div>
                
                <div class="col-half">
                    <label class="form-label">
                        {{ formset.empty_form.fuente_codigo.label }}
                    </label>
                    {{ formset.empty_form.fuente_codigo }}
                </div>
                
                <div class="col-full">
                    <label class="form-label small">041 $a - Código de idioma</label>
                    <div class="subcampo-repetible-container" data-idiomas-container="__prefix__">
                        <div class="subcampo-row">
                            <button type="button" class="subcampo-add-btn add-idioma-btn" data-lengua-index="__prefix__" title="Agregar Idioma">
                                <i class="bi bi-plus"></i>
                            </button>
                            <select class="form-select idioma-select" name="idioma_lengua___prefix___0">
                                <option value="">Seleccione un idioma...</option>
                                {% for codigo, nombre in codigos_idioma %}
                                <option value="{{ codigo }}">{{ nombre }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" class="subcampo-delete-btn delete-idioma-btn" title="Eliminar" style="visibility: hidden;">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{# Almacenar opciones de idioma en un elemento oculto para JavaScript #}
<div id="idiomas-options-data" style="display:none;" data-opciones='{% get_codigos_lenguaje_json %}'></div>

<script>
// Script para manejar subcampos de idiomas del campo 041
// El formset principal es manejado por formset-manager.js
(function() {
    const prefix = '{{ formset.prefix }}';
    
    // Obtener las opciones de idiomas desde el elemento oculto
    function getOpcionesIdioma() {
        const opcionesData = document.getElementById('idiomas-options-data');
        let opcionesIdioma = [];
        if (opcionesData && opcionesData.dataset.opciones) {
            try {
                opcionesIdioma = JSON.parse(opcionesData.dataset.opciones);
            } catch(e) {
                console.error('Error parsing idiomas options:', e);
            }
        }
        return opcionesIdioma;
    }
    
    // Construir HTML de opciones
    function buildOpcionesHTML() {
        let html = '<option value="">Seleccione un idioma...</option>';
        getOpcionesIdioma().forEach(function(item) {
            html += `<option value="${item.codigo}">${item.nombre}</option>`;
        });
        return html;
    }
    
    // Función para inicializar Select2 en un elemento
    function initSelect2(selectElement) {
        if (typeof $ !== 'undefined' && $.fn && typeof $.fn.select2 === 'function') {
            // Destruir Select2 existente si lo hay (para evitar duplicados)
            if ($(selectElement).hasClass('select2-hidden-accessible')) {
                $(selectElement).select2('destroy');
            }
            // Inicializar Select2
            $(selectElement).select2({
                theme: 'bootstrap-5',
                width: '100%',
                placeholder: 'Seleccione un idioma...',
                allowClear: false
            });
        }
    }
    
    // Función para actualizar visibilidad de botones de eliminar en subcampos
    function updateDeleteButtonsVisibility(idiomasContainer) {
        const rows = idiomasContainer.querySelectorAll('.subcampo-row');
        rows.forEach((row) => {
            const deleteBtn = row.querySelector('.subcampo-delete-btn');
            const hasAddButton = row.querySelector('.subcampo-add-btn');
            if (deleteBtn) {
                // La primera fila (con botón +) NUNCA se puede eliminar
                // Las demás filas siempre se pueden eliminar
                deleteBtn.style.visibility = hasAddButton ? 'hidden' : 'visible';
            }
        });
    }
    
    // Inicializar todos los selects de idioma en un contenedor específico
    function initSelectsInContainer(container) {
        container.querySelectorAll('.idioma-select').forEach(function(select) {
            // Solo inicializar si no está dentro de empty-form
            if (!select.closest('.empty-form')) {
                initSelect2(select);
            }
        });
        
        // Inicializar visibilidad de botones
        container.querySelectorAll('.subcampo-repetible-container').forEach(updateDeleteButtonsVisibility);
    }
    
    function initSubcamposIdiomas() {
        const container = document.querySelector(`[data-formset-prefix="${prefix}"]`);
        if (!container) return;
        
        const opcionesHTML = buildOpcionesHTML();
        
        // Manejar idiomas (subcampo $a repetible) - delegación de eventos
        container.addEventListener('click', function(e) {
            // Agregar idioma
            const addIdiomaBtn = e.target.closest('.add-idioma-btn');
            if (addIdiomaBtn) {
                const lenguaIndex = addIdiomaBtn.getAttribute('data-lengua-index');
                const idiomasContainer = container.querySelector(`[data-idiomas-container="${lenguaIndex}"]`);
                
                if (!idiomasContainer) return;
                
                const newIndex = Date.now(); // Usar timestamp para evitar duplicados
                
                // Crear nueva fila desde cero
                const newRow = document.createElement('div');
                newRow.className = 'subcampo-row';
                newRow.innerHTML = `
                    <div class="subcampo-placeholder"></div>
                    <select class="form-select idioma-select" name="idioma_lengua_${lenguaIndex}_${newIndex}">
                        ${opcionesHTML}
                    </select>
                    <button type="button" class="subcampo-delete-btn delete-idioma-btn" title="Eliminar">
                        <i class="bi bi-x-lg"></i>
                    </button>
                `;
                
                idiomasContainer.appendChild(newRow);
                updateDeleteButtonsVisibility(idiomasContainer);
                
                // Inicializar Select2 en el nuevo select después de agregarlo al DOM
                const select = newRow.querySelector('.idioma-select');
                setTimeout(function() {
                    initSelect2(select);
                }, 10);
            }
            
            // Eliminar idioma (solo filas sin botón +)
            const deleteIdiomaBtn = e.target.closest('.delete-idioma-btn');
            if (deleteIdiomaBtn) {
                const row = deleteIdiomaBtn.closest('.subcampo-row');
                // NO eliminar si tiene el botón de agregar
                if (row.querySelector('.subcampo-add-btn')) return;
                
                const idiomasContainer = row.closest('.subcampo-repetible-container');
                
                // Destruir Select2 antes de eliminar
                const select = row.querySelector('.idioma-select');
                if (select && typeof $ !== 'undefined' && $(select).hasClass('select2-hidden-accessible')) {
                    $(select).select2('destroy');
                }
                
                row.remove();
                updateDeleteButtonsVisibility(idiomasContainer);
            }
        });
        
        // Inicializar Select2 en todos los selects existentes (excluyendo empty-form)
        // Esperar a que Select2 esté listo
        setTimeout(function() {
            initSelectsInContainer(container);
        }, 200);
        
        // Observar cuando se agregan nuevos formularios (clonados del empty-form)
        const formsContainer = container.querySelector('.formset-forms');
        if (formsContainer) {
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === Node.ELEMENT_NODE && node.classList.contains('formset-row') && !node.classList.contains('empty-form')) {
                            // Nuevo formulario agregado, inicializar sus selects
                            setTimeout(function() {
                                initSelectsInContainer(node);
                            }, 100);
                        }
                    });
                });
            });
            
            observer.observe(formsContainer, { childList: true });
        }
    }
    
    // Ejecutar cuando el DOM esté listo Y Select2 esté cargado
    function waitForSelect2AndInit() {
        if (typeof $ !== 'undefined' && $.fn && typeof $.fn.select2 === 'function') {
            initSubcamposIdiomas();
        } else {
            // Esperar un poco más y reintentar
            setTimeout(waitForSelect2AndInit, 100);
        }
    }
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(waitForSelect2AndInit, 100);
        });
    } else {
        setTimeout(waitForSelect2AndInit, 100);
    }
})();
</script>
