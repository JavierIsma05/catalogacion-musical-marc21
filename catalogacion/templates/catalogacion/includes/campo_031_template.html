{% comment %}
Template personalizado para campo 031 - √çncipit musical + canvas
Se usa con el formset "incipits_musicales"
{% endcomment %}


{% load static %}

<style>
@font-face {
  font-family: 'Maestro';
  src: url("{% static 'catalogacion/fonts/Maestro.ttf' %}") format('truetype');
  font-weight: normal;
  font-style: normal;
}

/* Mantener la fuente para glifos musicales */
.btn-music span {
  font-family: 'Maestro','Bravura','Music', serif;
}

/* ---- NUEVO: normalizar tama√±o de los botones del toolbar ---- */

.btn-music {
  font-size: 14px;
  min-width: 20px;
  padding: 0px 10px;
  text-align: left
}

.btn-music-gliphos {
  font-size: 23px;   /* glifos musicales*/
  max-height: 40px;
}

/* fuerza Maestro en los botones del toolbar */
.btn-music span {
  font-family: 'Maestro','Bravura','Music', serif;
}


</style>


<div class="formset-container formset-incipit" data-formset-prefix="{{ formset.prefix }}">
    {{ formset.management_form }}

    <button type="button" class="add-form-row mb-3" title="Agregar √çncipit">
        <i class="bi bi-plus-circle"></i>
        Agregar √çncipit
    </button>

    <div class="formset-forms">
        {% for form in formset %}
        <div class="formset-row {% if form.instance.pk %}existing-form{% endif %}">
            {% if form.instance.pk %}
                <input type="hidden" name="{{ form.prefix }}-id" value="{{ form.instance.pk }}">
            {% endif %}

            {% if formset.can_delete %}
                <div class="d-none">
                    {{ form.DELETE }}
                </div>
            {% endif %}

            <button type="button" class="delete-row-btn" title="Eliminar">
                <i class="bi bi-x-lg"></i>
            </button>

            {# Fila 1: n√∫meros a, b, c #}
            <div class="campo-grid">
                <div class="col-third">
                    <label class="form-label" for="{{ form.numero_obra.id_for_label }}">
                        {{ form.numero_obra.label }}
                    </label>
                    {{ form.numero_obra }}
                    {% if form.numero_obra.errors %}
                        <div class="invalid-feedback d-block">{{ form.numero_obra.errors }}</div>
                    {% endif %}
                </div>

                <div class="col-third">
                    <label class="form-label" for="{{ form.numero_movimiento.id_for_label }}">
                        {{ form.numero_movimiento.label }}
                    </label>
                    {{ form.numero_movimiento }}
                    {% if form.numero_movimiento.errors %}
                        <div class="invalid-feedback d-block">{{ form.numero_movimiento.errors }}</div>
                    {% endif %}
                </div>

                <div class="col-third">
                    <label class="form-label" for="{{ form.numero_pasaje.id_for_label }}">
                        {{ form.numero_pasaje.label }}
                    </label>
                    {{ form.numero_pasaje }}
                    {% if form.numero_pasaje.errors %}
                        <div class="invalid-feedback d-block">{{ form.numero_pasaje.errors }}</div>
                    {% endif %}
                </div>
            </div>

            {# Fila 2: t√≠tulo, personaje, voz/instrumento #}
            <div class="campo-grid mt-3">
                <div class="col-third">
                    <label class="form-label" for="{{ form.titulo_encabezamiento.id_for_label }}">
                        {{ form.titulo_encabezamiento.label }}
                    </label>
                    {{ form.titulo_encabezamiento }}
                    {% if form.titulo_encabezamiento.errors %}
                        <div class="invalid-feedback d-block">{{ form.titulo_encabezamiento.errors }}</div>
                    {% endif %}
                </div>

                <div class="col-third">
                    <label class="form-label" for="{{ form.personaje.id_for_label }}">
                        {{ form.personaje.label }}
                    </label>
                    {{ form.personaje }}
                    {% if form.personaje.errors %}
                        <div class="invalid-feedback d-block">{{ form.personaje.errors }}</div>
                    {% endif %}
                </div>

                <div class="col-third">
                    <label class="form-label" for="{{ form.voz_instrumento.id_for_label }}">
                        {{ form.voz_instrumento.label }}
                    </label>
                    {{ form.voz_instrumento }}
                    {% if form.voz_instrumento.errors %}
                        <div class="invalid-feedback d-block">{{ form.voz_instrumento.errors }}</div>
                    {% endif %}
                </div>
            </div>

            {# Fila 3: clave, armadura, tiempo (ahora como select) #}
            <div class="campo-grid mt-3">
                <div class="col-third">
                    <label class="form-label" for="{{ form.clave.id_for_label }}">Clave</label>
                    {{ form.clave }}
                </div>

                <div class="col-third">
                    <label class="form-label" for="{{ form.armadura.id_for_label }}">Armadura</label>
                    {{ form.armadura }}
                </div>

                <div class="col-third">
                    <label class="form-label" for="{{ form.tiempo.id_for_label }}">Tiempo</label>
                    {{ form.tiempo }}
                </div>

            </div>
            {# CABECERA ‚Üí BOT√ìN APLICAR #}
            <div class="row align-items-center mb-3">
            <div class="col-md-6">
                <label class="subcampo-label mb-1">$p Notaci√≥n Musical (opcional)</label>
                <small class="text-muted d-block">
                Usa la cabecera (clave, armadura, tiempo) y el canvas para generar el c√≥digo PAE.
                </small>
            </div>
            <div class="col-md-6 text-md-end mt-2 mt-md-0">
                <button type="button"
                        id="parse-inc-p0"
                        class="btn btn-outline-secondary btn-sm">
                Aplicar cabecera al canvas
                </button>
            </div>

            {# EDITOR DE √çNCIPIT: TOOLBAR + CANVAS #}
            <div class="">
            <label class="subcampo-label d-block mb-2">Editor de √≠ncipit</label>

            <div class="border rounded p-3 bg-light">
                <div class="d-flex align-items-center" style="box-sizing: content-box;">

                {# TOOLBAR IZQUIERDA COMPACTA #}
                <div id="incipit-toolbar-031"
                    class="d-flex flex-column gap-2 flex-shrink-0 btn-music"
                    style="max-width:310px;">

                    {# CLAVE #}
                    <div>
                    <div class="text-muted small">Clave</div>
                    <div class="btn-group btn-group-sm" role="group"  aria-label="Claves">
                        <button type="button" class="btn btn-outline-primary btn-music" style=""
                                title="Clave de Sol" onclick="ClefPressed('1')">
                        <span class="btn-music-gliphos">ùÑû</span>
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-music" style="margin: 0px 6px; padding-top: 7px;"
                                title="Clave de Do" onclick="ClefPressed('2')">
                        <span class="btn-music-gliphos">ùÑ°</span>
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-music" style="padding-top: 7px"
                                title="Clave de Fa" onclick="ClefPressed('3')">
                        <span class="btn-music-gliphos">ùÑ¢</span>
                        </button>
                    </div>
                    </div>

                    {# COMP√ÅS + BARRAS #}
                    <div>
                    <div class="text-muted" >Comp√°s</div>


                    <div class="btn-group-sm"  role="group" aria-label="Compases">
                        <button type="button" class="btn btn-outline-primary btn-music"
                                onclick="TimePressed('t')">4/4</button>
                        <button type="button" class="btn btn-outline-primary btn-music"
                                onclick="TimePressed('w')">3/4</button>
                        <button type="button" class="btn btn-outline-primary btn-music"
                                onclick="TimePressed('v')">2/4</button>
                    </div>





                    <div class="btn-group-sm"  style="padding: 5px 0px;" role="group" aria-label="Compases">
                        <button type="button" class="btn btn-outline-primary btn-music"
                                onclick="TimePressed('u')">2/2</button>
                        <button type="button" class="btn btn-outline-primary btn-music"
                                onclick="TimePressed('|')">3/2</button>
                        <button type="button" class="btn btn-outline-primary btn-music"
                                    onclick="TimePressed('x')">3/8</button>

                    </div>

                    <div class="btn-group-sm" role="group" aria-label="Compases">

                        <button type="button" class="btn btn-outline-primary btn-music"
                                    onclick="TimePressed('y')">6/8</button>
                        <button type="button" class="btn btn-outline-primary btn-music"
                                    onclick="TimePressed('z')">9/8</button>
                        <button type="button" class="btn btn-outline-primary btn-music" style="font-size: 14px;max-width: 43px; padding: 0px 7px;"
                                    onclick="TimePressed('{')">12/8</button>

                    </div>

                    {# ALTURA + BORRAR #}
                    <div>
                    <div class="text-muted" style="margin-left:11px;">Altura</div>
                    <div class="btn-group btn-group-sm flex-wrap" role="group">
                        <button type="button" class="btn btn-outline-secondary btn-music"
                                style="margin:1px;" title="Subir altura"
                                onclick="CanvasIncipit.toneUpDown(CanvasIncipit, -1)">‚ñ≤</button>
                        <button type="button" class="btn btn-outline-secondary btn-music"
                                style="margin:1px;" title="Bajar altura"
                                onclick="CanvasIncipit.toneUpDown(CanvasIncipit, 1)">‚ñº</button>
                    </div>


                    {# FIGURAS #}
                    <div>
                    <div class="text-muted small mb-1">Figuras</div>
                    <div class="btn-group btn-group-sm flex-wrap" role="group" aria-label="Figuras">
                        <button type="button" class="btn btn-outline-primary btn-music" style="margin:1px;"
                                title="Redonda" onclick="NotePressed('d')">
                        <span style="font-size:24px;">ùÖù</span>
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-music" style="margin:1px 3px;"
                                title="Blanca" onclick="NotePressed('e')">
                        <span style="font-size:24px;">ùÖû</span>
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-music" style="margin:1px"
                                title="Negra" onclick="NotePressed('f')">
                        <span style="font-size:24px;">ùÖü</span>
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-music" style="margin:1px 3px;"
                                title="Corchea" onclick="NotePressed('g')">
                        <span style="font-size:24px;">ùÖ†</span>
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-music" style="margin:1px;"
                                title="Semicorchea" onclick="NotePressed('h')">
                        <span style="font-size:24px;">ùÖ°</span>
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-music" style="margin:1px 3px;"
                                title="Fusa" onclick="NotePressed('i')">
                        <span style="font-size:24px;">ùÖ¢</span>
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-music" style="margin:1px;"
                                title="Puntillo" onclick="dotPressed()">
                        ¬∑
                        </button>
                    </div>
                    </div>

                    {# ALTERACIONES #}
                    <div>
                    <div class="text-muted small mb-1">Alteraciones</div>
                    <div class="btn-group btn-group-sm" style="display:flex;" role="group" aria-label="Alteraciones">
                        <button type="button" class="btn-outline-primary btn-music btn-music-gliphos"
                                style="border-radius: 10% 0 0 10%;" title="Doble sostenido"
                                onclick="alterationPressed('l')">ùÑ™</button>
                        <button type="button" class="btn-outline-primary btn-music btn-music-gliphos"
                                style="margin: 0px 5px;" title="Sostenido"
                                onclick="alterationPressed('p')">‚ôØ</button>
                        <button type="button" class="btn-outline-primary btn-music btn-music-gliphos"
                                style="" title="Becuadro"
                                onclick="alterationPressed('o')">‚ôÆ</button>
                        <button type="button" class="btn-outline-primary btn-music btn-music-gliphos"
                                style="margin: 0px 5px;" title="Bemol"
                                onclick="alterationPressed('m')">‚ô≠</button>
                        <button type="button" class="btn-outline-primary btn-music btn-music-gliphos"
                                style="border-radius: 0 10% 10% 0%;" title="Doble bemol"
                                onclick="alterationPressed('n')">ùÑ´</button>
                    </div>
                    </div>


                    <div class="text-muted ">Barras</div>
                    <div class="btn-group-sm flex-wrap text-align-center" role="group" aria-label="Barras">
                        <button type="button" class="btn btn-outline-primary btn-music"
                                title="Barra simple" onclick="BarPressed(';')">|</button>
                        <button type="button" class="btn btn-outline-primary btn-music"
                                title="Doble barra" onclick="BarPressed('<')">||</button>
                        <button type="button" class="btn btn-outline-primary btn-music"
                                title="Inicio repetici√≥n" onclick="BarPressed('>')">|:</button>
                        <button type="button" class="btn btn-outline-primary btn-music"
                                title="Fin repetici√≥n" onclick="BarPressed('?')">:||</button>
                        <button type="button" class="btn btn-outline-primary btn-music"
                                title="Repetici√≥n doble" onclick="BarPressed('@')">:||:</button>
                    </div>
                    </div>



                    <div class="btn-group btn-group-sm flex-wrap mt-1" role="group">
                        <button type="button" class="btn btn-outline-danger"
                                style="margin:1px; font-size: small;"
                                title="Borrar nota" onclick="deleteNote(false)">
                        üóë Borrar √∫ltima nota
                        </button>
                        <button type="button" class="btn btn-outline-danger"
                                style="margin:1px; font-size: small;"
                                title="Borrar todo" onclick="deleteNote(true)">
                        üóë Borrar todo
                        </button>
                    </div>
                    </div>
                </div>

                {# CANVAS TIPO PENTAGRAMA REAL #}
                <div class="flex-grow-1">
                    <div class="position-relative d-inline-block w-100">
                    <canvas id="incipit_canvas_0"
                            width="750"
                            height="270"
                            style="display:block; "></canvas>
                    </div>
                </div>

                </div>
            </div>
            <small class="text-muted d-block mt-2">
                El contenido del canvas se sincronizar√° con el campo de notaci√≥n musical (PAE).
            </small>
            </div>


            {# Notaci√≥n musical PAE (031 $p) #}
            <div class="campo-grid mt-3">
                <div class="col-full">
                    <label class="form-label" for="{{ form.notacion_musical.id_for_label }}">
                        Notaci√≥n musical (PAE)
                    </label>
                    {{ form.notacion_musical }}
                </div>
            </div>
            </div>

        </div>
        {% endfor %}

        {# Template vac√≠o para clonar (mismo layout, usando empty_form) #}
        <div class="formset-row empty-form" style="display:none;">
            <button type="button" class="delete-row-btn" title="Eliminar">
                <i class="bi bi-x-lg"></i>
            </button>

            <div class="campo-grid">
                <div class="col-third">
                    <label class="form-label">
                        {{ formset.empty_form.numero_obra.label }}
                    </label>
                    {{ formset.empty_form.numero_obra }}
                </div>
                <div class="col-third">
                    <label class="form-label">
                        {{ formset.empty_form.numero_movimiento.label }}
                    </label>
                    {{ formset.empty_form.numero_movimiento }}
                </div>
                <div class="col-third">
                    <label class="form-label">
                        {{ formset.empty_form.numero_pasaje.label }}
                    </label>
                    {{ formset.empty_form.numero_pasaje }}
                </div>
            </div>

            <div class="campo-grid mt-3">
                <div class="col-third">
                    <label class="form-label">
                        {{ formset.empty_form.titulo_encabezamiento.label }}
                    </label>
                    {{ formset.empty_form.titulo_encabezamiento }}
                </div>
                <div class="col-third">
                    <label class="form-label">
                        {{ formset.empty_form.personaje.label }}
                    </label>
                    {{ formset.empty_form.personaje }}
                </div>
                <div class="col-third">
                    <label class="form-label">
                        {{ formset.empty_form.voz_instrumento.label }}
                    </label>
                    {{ formset.empty_form.voz_instrumento }}
                </div>
            </div>

            <div class="campo-grid mt-3">
                <div class="col-third">
                    <label class="form-label">
                        {{ formset.empty_form.clave.label }}
                    </label>
                    {{ formset.empty_form.clave }}
                </div>
                <div class="col-third">
                    <label class="form-label">
                        {{ formset.empty_form.armadura.label }}
                    </label>
                    {{ formset.empty_form.armadura }}
                </div>
                <div class="col-third">
                    <label class="form-label">
                        {{ formset.empty_form.tiempo.label }}
                    </label>
                    {{ formset.empty_form.tiempo }}
                </div>
            </div>

            <div class="campo-grid mt-3">
                <div class="col-full">
                    <label class="form-label">
                        {{ formset.empty_form.notacion_musical.label }}
                    </label>
                    {{ formset.empty_form.notacion_musical }}
                </div>
            </div>

            <div class="campo-grid mt-3">
                <div class="col-full">
                    <label class="form-label">
                        {{ formset.empty_form.nota_general.label }}
                    </label>
                    {{ formset.empty_form.nota_general }}
                </div>
            </div>

            <div class="campo-grid mt-3">
                <div class="col-half">
                    <label class="form-label">
                        {{ formset.empty_form.tonalidad_modo.label }}
                    </label>
                    {{ formset.empty_form.tonalidad_modo }}
                </div>
                <div class="col-half">
                    <label class="form-label">
                        {{ formset.empty_form.nota_validez_codificada.label }}
                    </label>
                    {{ formset.empty_form.nota_validez_codificada }}
                </div>
            </div>

            <div class="campo-grid mt-3">
                <div class="col-full">
                    <label class="form-label">
                        Editor de √≠ncipit
                    </label>
                    <canvas
                        id="incipit_canvas_{{ formset.empty_form.prefix }}"
                        class="incipit-canvas"
                        width="800"
                        height="240">
                    </canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Script para manejar agregar/eliminar formularios (similar al gen√©rico)
(function() {
    const prefix = '{{ formset.prefix }}';
    const container = document.querySelector(`[data-formset-prefix="${prefix}"]`);
    if (!container) return;

    const totalFormsInput = container.querySelector(`#id_${prefix}-TOTAL_FORMS`);
    const addButton = container.querySelector('.add-form-row');
    const formsContainer = container.querySelector('.formset-forms');

    if (!totalFormsInput || !addButton || !formsContainer) return;

    // Agregar nuevo √≠ncipit
    addButton.addEventListener('click', function() {
        const totalForms = parseInt(totalFormsInput.value);
        const emptyFormTemplate = formsContainer.querySelector('.empty-form');

        if (!emptyFormTemplate) {
            console.error('No se encontr√≥ template vac√≠o para el formset 031');
            return;
        }

        const emptyForm = emptyFormTemplate.cloneNode(true);

        emptyForm.innerHTML = emptyForm.innerHTML.replace(/__prefix__/g, totalForms);
        emptyForm.classList.remove('empty-form');
        emptyForm.style.display = '';

        formsContainer.insertBefore(emptyForm, emptyFormTemplate);

        totalFormsInput.value = totalForms + 1;
    });

    // Eliminar √≠ncipit
    formsContainer.addEventListener('click', function(e) {
        const deleteBtn = e.target.closest('.delete-row-btn');
        if (!deleteBtn) return;

        const row = deleteBtn.closest('.formset-row');
        if (!row || row.classList.contains('empty-form')) return;

        const deleteInput = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
        if (deleteInput) {
            deleteInput.checked = true;
            row.style.display = 'none';
        } else {
            row.remove();
            totalFormsInput.value = parseInt(totalFormsInput.value) - 1;
        }
    });
})();
</script>
