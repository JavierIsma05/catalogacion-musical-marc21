{% comment %}
Template personalizado para campo 031 - √çncipit musical + canvas
Se usa con el formset "incipits_musicales"
El bot√≥n de agregar campo completo est√° en el header del campo (campo-add-btn)
{% endcomment %}


{% load static %}

<style>
@font-face {
  font-family: 'Maestro';
  src: url("{% static 'catalogacion/fonts/Maestro.ttf' %}") format('truetype');
  font-weight: normal;
  font-style: normal;
}


/* ============================================
   Botones del incipit (toolbar + cabecera)
   ============================================ */
.btn-incipit {
  background: var(--gray-50);
  color: black;
  border: 1px solid var(--gray-800);
  padding: .5rem .9rem;
  font-weight: 400;
  transition: filter .15s ease, transform .02s ease;
}


.btn-incipit:hover {
  filter: brightness(0.92);

  background-color: var(--gray-800);
  color: rgb(255, 255, 255);
}


/* Accesibilidad: SOLO cuando se navega con teclado mostramos un ring sutil */
.btn-incipit:focus-visible {
  outline: 2px solid var(--gray-400);
  outline-offset: 2px;
}

/* Estado activo corto (click) */
.btn-incipit:active {
  transform: translateY(1px);
}

/* Mantener la fuente para glifos musicales */
.btn-music span {
  font-family: 'Maestro','Bravura','Music', serif;
}

/* ----normalizar tama√±o de los botones del toolbar ---- */

.btn-music {
  font-size: 15px;
  padding: 0px 11px;
  text-align: center;
  justify-content: center;
}

.btn-music-gliphos {
  font-size: 23px;   /* glifos musicales*/
  max-height: 40px;
  padding-top: 3px;
}

/* fuerza Maestro en los botones del toolbar */
.btn-music span {
  font-family: 'Maestro','Bravura','Music', serif;
}

/* 031: forzar grid real de 2 columnas */
.formset-incipit .campo-grid{
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 0.75rem;
  margin-bottom: 0;
  align-items: start;
}

/* Campos que deben ocupar toda la fila */
.formset-incipit .campo-grid .col-full{
  grid-column: 1 / -1;
}

/* wrappers */
.formset-incipit .campo-grid > .col-half,
.formset-incipit .campo-grid > .col-third{
  grid-column: span 1;
  min-width: 0;
}
.formset-row {
    position: relative;
    background: var(--gray-50);
    border: 1px solid var(--border-color);
    border-left: 2px solid var(--gray-400);
    border-radius: 3px;
    padding: 0.75rem;
    margin-bottom: 0.75rem;
    transition: var(--transition);
}

.formset-row:hover {
    background: white;
    border-color: var(--gray-300);
    border-left-color: var(--accent);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

/* el editor ocupa 100% del padre */
#incipit-toolbar-top-031 { width: 100%; }
#incipit-toolbar-bottom-031 { justify-content: center; }

/* el canvas no se pasa de 600, pero se centra */
#incipit_canvas_0 { width: 100%; max-width: 700px; height: auto; display:block; }
</style>


<div class="formset-container formset-incipit" data-formset-prefix="{{ formset.prefix }}">
    {{ formset.management_form }}

    <div class="formset-forms">
        {% for form in formset %}
        <div class="formset-row {% if form.instance.pk %}existing-form{% endif %}">
            {% if form.instance.pk %}
                <input type="hidden" name="{{ form.prefix }}-id" value="{{ form.instance.pk }}">
            {% endif %}


            {# Fila 1: n√∫meros a, b, c #}
            <div class="campo-grid">
                <div class="col-half">
                    <label class="form-label" for="{{ form.numero_obra.id_for_label }}">
                        {{ form.numero_obra.label }}
                    </label>
                    {{ form.numero_obra }}
                    {% if form.numero_obra.errors %}
                        <div class="invalid-feedback d-block">{{ form.numero_obra.errors }}</div>
                    {% endif %}
                </div>

                <div class="col-half">
                    <label class="form-label" for="{{ form.numero_movimiento.id_for_label }}">
                        {{ form.numero_movimiento.label }}
                    </label>
                    {{ form.numero_movimiento }}
                    {% if form.numero_movimiento.errors %}
                        <div class="invalid-feedback d-block">{{ form.numero_movimiento.errors }}</div>
                    {% endif %}
                </div>

                <div class="col-half">
                    <label class="form-label" for="{{ form.numero_pasaje.id_for_label }}">
                        {{ form.numero_pasaje.label }}
                    </label>
                    {{ form.numero_pasaje }}
                    {% if form.numero_pasaje.errors %}
                        <div class="invalid-feedback d-block">{{ form.numero_pasaje.errors }}</div>
                    {% endif %}
                </div>
            </div>

            {# Fila 2: t√≠tulo, personaje, voz/instrumento #}
            <div class="campo-grid mt-3">
                <div class="col-third">
                    <label class="form-label" for="{{ form.titulo_encabezamiento.id_for_label }}">
                        {{ form.titulo_encabezamiento.label }}
                    </label>
                    {{ form.titulo_encabezamiento }}
                    {% if form.titulo_encabezamiento.errors %}
                        <div class="invalid-feedback d-block">{{ form.titulo_encabezamiento.errors }}</div>
                    {% endif %}
                </div>

                <div class="col-third">
                    <label class="form-label" for="{{ form.personaje.id_for_label }}">
                        {{ form.personaje.label }}
                    </label>
                    {{ form.personaje }}
                    {% if form.personaje.errors %}
                        <div class="invalid-feedback d-block">{{ form.personaje.errors }}</div>
                    {% endif %}
                </div>

                <div class="col-third">
                    <label class="form-label" for="{{ form.voz_instrumento.id_for_label }}">
                        {{ form.voz_instrumento.label }}
                    </label>
                    {{ form.voz_instrumento }}
                    {% if form.voz_instrumento.errors %}
                        <div class="invalid-feedback d-block">{{ form.voz_instrumento.errors }}</div>
                    {% endif %}
                </div>
            </div>

            {# Fila 3: clave, armadura, tiempo (ahora como select) #}
            <div class="campo-grid mt-3">
                <div class="col-third">
                    <label class="form-label" for="{{ form.clave.id_for_label }}">Clave</label>
                    {{ form.clave }}
                </div>

                <div class="col-third">
                    <label class="form-label" for="{{ form.armadura.id_for_label }}">Armadura</label>
                    {{ form.armadura }}
                </div>

                <div class="col-third">
                    <label class="form-label" for="{{ form.tiempo.id_for_label }}">Tiempo</label>
                    {{ form.tiempo }}
                </div>

            </div>
            {# CABECERA ‚Üí BOT√ìN APLICAR #}
            <div class="row align-items-center mb-3">
            <div class="col-md-6">

                <small class="text-muted d-block">
                Usa la cabecera (clave, armadura, tiempo) y el pentagrama para generar el c√≥digo PAE.
                </small>
            </div>
            <div class="col-md-6 text-md-end mt-2 mt-md-0">
                <button type="button"
                        id="parse-inc-p0"
                        style="margin-top: 5px;"
                        class="btn btn-incipit btn-sm">
                Aplicar cabecera
                </button>
            </div>

            {# EDITOR DE √çNCIPIT: TOOLBAR + CANVAS #}
            <div>
            <label class="subcampo-label d-block m-2">Editor de √≠ncipit</label>

            <div class="border rounded p-3 bg-light">

                {# WRAPPER: columna (toolbar arriba, canvas, toolbar abajo) #}
                <div class="d-flex flex-column w-100">

            {# TOOLBAR TOP #}
            <div id="incipit-toolbar-top-031"
                class="d-flex flex-wrap gap-3 w-100 btn-music align-items-start">

            {# CLAVE #}
            <div class="incipit-group">
                <div class="incipit-group-title">Clave</div>
                <div class="btn-group btn-group-sm" role="group" aria-label="Claves">
                <button type="button" class="btn btn-incipit btn-music"
                        title="Clave de Sol" onclick="ClefPressed('1')" >
                    <span class="btn-music-gliphos">ùÑû</span>
                </button>
                <button type="button" class="btn btn-incipit btn-music"
                        title="Clave de Do" onclick="ClefPressed('2')">
                    <span class="btn-music-gliphos">ùÑ°</span>
                </button>
                <button type="button" class="btn btn-incipit btn-music"
                        title="Clave de Fa" onclick="ClefPressed('3')">
                    <span class="btn-music-gliphos">ùÑ¢</span>
                </button>
                </div>
            </div>

            {# COMP√ÅS #}
            <div class="incipit-group">
                <div class="incipit-group-title">Comp√°s</div>

                <div class="btn-group btn-group-sm mb-1" role="group">
                <button type="button" class="btn btn-incipit btn-music" onclick="TimePressed('t')">4/4</button>
                <button type="button" class="btn btn-incipit btn-music" onclick="TimePressed('w')">3/4</button>
                <button type="button" class="btn btn-incipit btn-music" onclick="TimePressed('v')">2/4</button>
                </div>

                <div class="btn-group btn-group-sm mb-1" role="group">
                <button type="button" class="btn btn-incipit btn-music" onclick="TimePressed('u')">2/2</button>
                <button type="button" class="btn btn-incipit btn-music" onclick="TimePressed('|')">3/2</button>
                <button type="button" class="btn btn-incipit btn-music" onclick="TimePressed('x')">3/8</button>
                <button type="button" class="btn btn-incipit btn-music" onclick="TimePressed('y')">6/8</button>
                <button type="button" class="btn btn-incipit btn-music" onclick="TimePressed('z')">9/8</button>
                <button type="button" class="btn btn-incipit btn-music"
                        style="font-size:14px;max-width:43px;"
                        onclick="TimePressed('{')">12/8</button>
                </div>

            </div>

            {# ALTERACIONES #}
            <div class="incipit-group">
                <div class="incipit-group-title">Alteraciones</div>
                <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-incipit btn-music btn-music-gliphos"
                        title="Doble sostenido" onclick="alterationPressed('l')">ùÑ™</button>
                <button type="button" class="btn btn-incipit btn-music btn-music-gliphos"
                        title="Sostenido" onclick="alterationPressed('p')">‚ôØ</button>
                <button type="button" class="btn btn-incipit btn-music btn-music-gliphos"
                        title="Becuadro" onclick="alterationPressed('o')">‚ôÆ</button>
                <button type="button" class="btn btn-incipit btn-music btn-music-gliphos"
                        title="Bemol" onclick="alterationPressed('m')">‚ô≠</button>
                <button type="button" class="btn btn-incipit btn-music btn-music-gliphos"
                        title="Doble bemol" onclick="alterationPressed('n')">ùÑ´</button>
                </div>
            </div>

            {# FIGURAS (AL FINAL) #}
            <div class="incipit-group">
                <div class="incipit-group-title">Figuras</div>
                <div class="btn-group btn-group-sm flex-wrap" role="group">
                <button type="button" class="btn btn-incipit btn-music"
                        title="Redonda" onclick="NotePressed('d')" style="font-size: 26px;">ùÖù</button>
                <button type="button" class="btn btn-incipit btn-music"
                        title="Blanca" onclick="NotePressed('e')" style="font-size: 26px;">ùÖû</button>
                <button type="button" class="btn btn-incipit btn-music"
                        title="Negra" onclick="NotePressed('f')" style="font-size: 26px;">ùÖü</button>
                <button type="button" class="btn btn-incipit btn-music"
                        title="Corchea" onclick="NotePressed('g')" style="font-size: 26px;">ùÖ†</button>
                <button type="button" class="btn btn-incipit btn-music"
                        title="Semicorchea" onclick="NotePressed('h')" style="font-size: 26px;" >ùÖ°</button>
                <button type="button" class="btn btn-incipit btn-music"
                        title="Fusa" onclick="NotePressed('i')" style="font-size: 26px;">ùÖ¢</button>
                <button type="button" class="btn btn-incipit btn-music"
                        title="Puntillo" onclick="dotPressed()" style="font-size: 26px;">¬∑</button>
                </div>

            </div>
            <div class="incipit-group">
            <div class="incipit-group-title">Silencios</div>

            <div class="btn-group btn-group-sm flex-wrap" role="group" aria-label="Silencios">
            <button type="button" class="btn btn-incipit btn-music-gliphos" data-note="$"  title="Silencio de redonda">
            <span style="font-family: Maestro; font-size:24px;">$</span>
            </button>

            <button type="button" class="btn btn-incipit btn-music-gliphos" data-note="%"    title="Silencio de blanca">
            <span style="font-family: Maestro; font-size:24px;">%</span>
            </button>

            <button type="button" class="btn btn-incipit btn-music-gliphos" data-note="&quot;" title="Silencio de longa">
            <span style="font-family: Maestro; font-size:24px;">"</span>
            </button>

            <button type="button" class="btn btn-incipit btn-music-gliphos" data-note="#" title="Silencio de breve">
            <span style="font-family: Maestro; font-size:24px;">#</span>
            </button>

            <button type="button" class="btn btn-incipit btn-music-gliphos" data-note="&amp;"  title="Silencio de negra">
            <span style="font-family: Maestro; font-size:24px;">&amp;</span>
            </button>

            <button type="button" class="btn btn-incipit btn-music-gliphos" data-note="'" title="Silencio de corchea">
            <span style="font-family: Maestro; font-size:24px;">'</span>
            </button>

            <button type="button" class="btn btn-incipit btn-music-gliphos" data-note="("  title="Silencio de semicorchea">
            <span style="font-family: Maestro; font-size:24px;">(</span>
            </button>

            <button type="button" class="btn btn-incipit btn-music-gliphos" data-note=")" title="Silencio de fusa">
            <span style="font-family: Maestro; font-size:24px;">)</span>
            </button>

            <button type="button" class="btn btn-incipit btn-music-gliphos" data-note="*" title="Silencio de semifusa">
            <span style="font-family: Maestro; font-size:24px;">*</span>
            </button>
            </div>
            </div>

            {# ALTURA #}
                <div class="incipit-group">
                <div class="incipit-group-title" style="margin-left:11px;">Altura</div>
                <div class="btn-group btn-group-sm flex-wrap" role="group">
                    <button type="button" class="btn btn-incipit btn-music" style="margin:1px;" title="Subir altura"
                            onclick="CanvasIncipit.toneUpDown(CanvasIncipit, -1)">‚ñ≤</button>
                    <button type="button" class="btn btn-incipit btn-music" style="margin:1px;" title="Bajar altura"
                            onclick="CanvasIncipit.toneUpDown(CanvasIncipit, 1)">‚ñº</button>
                </div>
                </div>

                {# BARRA #}
                <div class="incipit-group">
                <div class="incipit-group-title">Barras</div>
                <div class="btn-group-sm flex-wrap text-align-center" role="group" aria-label="Barras">
                        <button type="button" class="btn btn-incipit btn-music" style="border-radius: 10% 0 0 10%;"
                            title="Barra simple" data-note=";">|</button>
                        <button type="button" class="btn btn-incipit btn-music"
                            title="Doble barra" data-note="<">||</button>
                        <button type="button" class="btn btn-incipit btn-music"
                            title="Inicio repetici√≥n" data-note=">">|:</button>
                        <button type="button" class="btn btn-incipit btn-music"
                            title="Fin repetici√≥n" data-note="?">:||</button>
                        <button type="button" class="btn btn-incipit btn-music" style="border-radius: 0 10% 10% 0%;"
                            title="Repetici√≥n doble" data-note="@">:||:</button>
                </div>
                </div>


            {# TOOLBAR BOTTOM (solo acciones) #}
                <div id="incipit-toolbar-bottom-031" class="d-flex flex-wrap gap-2">
                        <div class="btn-group btn-group-sm flex-wrap mt-1" role="group">
                        <button type="button" class="btn btn-outline-danger"
                                style="margin:1px; font-size: small;"
                                title="Borrar nota" onclick="deleteNote(false)">
                            üóë Borrar √∫ltima nota
                        </button>
                        <button type="button" class="btn btn-outline-danger"
                                style="margin:1px; font-size: small;"
                                title="Borrar todo" onclick="deleteNote(true)">
                            üóë Borrar todo
                        </button>
                        </div>
                    </div>


                </div>



                {# CANVAS WRAPPER #}
                <div class="w-100 d-flex justify-content-center my-2">
                    <div class="position-relative d-inline-block" style="max-width:700px;">
                    <canvas id="incipit_canvas_0" width="700" height="250" style="display:block;"></canvas>
                    </div>

                </div>




                </div>
            </div>
            </div>

            <small class="text-muted d-block mt-2">
                El contenido del canvas se sincronizar√° con el campo de notaci√≥n musical (PAE).
            </small>
            </div>


            {# Notaci√≥n musical PAE (031 $p) #}
            <div class="campo-grid mt-3">
                <div class="col-full">
                    <label class="form-label" for="{{ form.notacion_musical.id_for_label }}">
                        Notaci√≥n musical (PAE)
                    </label>
                    {{ form.notacion_musical }}
                </div>
            </div>
            </div>

        </div>
        {% endfor %}

        {# Template vac√≠o para clonar (mismo layout, usando empty_form) #}
        <div class="formset-row empty-form" style="display:none;">
            <button type="button" class="delete-row-btn" title="Eliminar">
                <i class="bi bi-x-lg"></i>
            </button>

            <div class="campo-grid">
                <div class="col-third">
                    <label class="form-label">
                        {{ formset.empty_form.numero_obra.label }}
                    </label>
                    {{ formset.empty_form.numero_obra }}
                </div>
                <div class="col-third">
                    <label class="form-label">
                        {{ formset.empty_form.numero_movimiento.label }}
                    </label>
                    {{ formset.empty_form.numero_movimiento }}
                </div>
                <div class="col-third">
                    <label class="form-label">
                        {{ formset.empty_form.numero_pasaje.label }}
                    </label>
                    {{ formset.empty_form.numero_pasaje }}
                </div>
            </div>

            <div class="campo-grid mt-3">
                <div class="col-third">
                    <label class="form-label">
                        {{ formset.empty_form.titulo_encabezamiento.label }}
                    </label>
                    {{ formset.empty_form.titulo_encabezamiento }}
                </div>
                <div class="col-third">
                    <label class="form-label">
                        {{ formset.empty_form.personaje.label }}
                    </label>
                    {{ formset.empty_form.personaje }}
                </div>
                <div class="col-third">
                    <label class="form-label">
                        {{ formset.empty_form.voz_instrumento.label }}
                    </label>
                    {{ formset.empty_form.voz_instrumento }}
                </div>
            </div>

            <div class="campo-grid mt-3">
                <div class="col-third">
                    <label class="form-label">
                        {{ formset.empty_form.clave.label }}
                    </label>
                    {{ formset.empty_form.clave }}
                </div>
                <div class="col-third">
                    <label class="form-label">
                        {{ formset.empty_form.armadura.label }}
                    </label>
                    {{ formset.empty_form.armadura }}
                </div>
                <div class="col-third">
                    <label class="form-label">
                        {{ formset.empty_form.tiempo.label }}
                    </label>
                    {{ formset.empty_form.tiempo }}
                </div>
            </div>

            <div class="campo-grid mt-3">
                <div class="col-full">
                    <label class="form-label">
                        {{ formset.empty_form.notacion_musical.label }}
                    </label>
                    {{ formset.empty_form.notacion_musical }}
                </div>
            </div>

            <!-- <div class="campo-grid mt-3">
                <div class="col-full">
                    <label class="form-label">
                        {{ formset.empty_form.nota_general.label }}
                    </label>
                    {{ formset.empty_form.nota_general }}
                </div>
            </div>

            <div class="campo-grid mt-3">
                <div class="col-half">
                    <label class="form-label">
                        {{ formset.empty_form.tonalidad_modo.label }}
                    </label>
                    {{ formset.empty_form.tonalidad_modo }}
                </div>
                <div class="col-half">
                    <label class="form-label">
                        {{ formset.empty_form.nota_validez_codificada.label }}
                    </label>
                    {{ formset.empty_form.nota_validez_codificada }}
                </div>
            </div> -->

            <div class="campo-grid mt-3">
                <div class="col-full">
                    <label class="form-label">
                        Editor de √≠ncipit
                    </label>
                    <canvas
                        id="incipit_canvas_{{ formset.empty_form.prefix }}"
                        class="incipit-canvas"
                        width="800"
                        height="320">
                    </canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
/**
 * Script para el campo 031 - Incipit Musical
 * Este campo NO tiene subcampos repetibles, solo es un formset est√°ndar.
 * La gesti√≥n del formset est√° en formset-manager.js
 */
console.log('[031] Este formset es manejado por formset-manager.js');

// Enlaza botones que usan data-note (evita problemas de escapado con ap√≥strofes)
document.querySelectorAll('[data-note]').forEach(function(btn) {
    btn.addEventListener('click', function (e) {
        e.preventDefault();
        var note = btn.getAttribute('data-note');
        if (typeof NotePressed === 'function') NotePressed(note);

        // Si es un silencio, insertarlo inmediatamente en el pentagrama
        try {
            if (window.CanvasIncipit && CanvasIncipit.incipit) {
                var noteObj = CanvasIncipit.incipit.getNoteByValue
                    ? CanvasIncipit.incipit.getNoteByValue(note)
                    : null;

                if (noteObj && noteObj.isRest) {
                    var cursor = { x: CanvasIncipit.gCanvasElement.width - 1, y: 0 };
                    if (typeof CanvasIncipit.addNote === 'function') CanvasIncipit.addNote(CanvasIncipit, cursor);
                    return;
                }
            }

            // Si es una barra, llamar al manejador de barras
            var barSymbols = [';', '<', '>', '?', '@'];
            if (barSymbols.indexOf(note) !== -1) {
                if (typeof BarPressed === 'function') BarPressed(note);
            }
        } catch (err) {
            console.warn('Error processing data-note click:', err);
        }
    });
});
</script>
