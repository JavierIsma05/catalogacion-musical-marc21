{% comment %}
FORMSET 774 – Obra en esta colección (R)
Estilo compatible con 856 / 700
{% endcomment %}

<div class="formset-container"
     data-formset-prefix="{{ formset.prefix }}">

    <!-- Management form -->
    <div class="d-none">
        {% for hidden in formset.management_form %}
            {{ hidden }}
        {% endfor %}
    </div>

    <div class="formset-forms">

        {% for form in formset %}
        <div class="formset-row {% if form.instance.pk %}existing-form{% endif %} mb-3">

            {% for hidden in form.hidden_fields %}
                {{ hidden }}
            {% endfor %}

            {% if formset.can_delete %}
                <div class="d-none">{{ form.DELETE }}</div>
            {% endif %}

            <button type="button" class="delete-row-btn">
                <i class="bi bi-x-lg"></i>
            </button>

            <div class="card mt-3">
                <div class="card-body">

                    <!-- Indicadores -->
                    <div class="d-none">
                        {{ form.primer_indicador }}
                        {{ form.segundo_indicador }}
                    </div>

                    <!-- 774 $a -->
                    <div class="mb-3">
                        <label class="form-label small">
                            774 $a – Compositor
                        </label>

                        <div class="autocomplete-wrapper" data-autocomplete="persona">
                            {{ form.encabezamiento_principal_texto }}
                            {{ form.encabezamiento_principal }}
                            <div class="autocomplete-suggestions"></div>
                        </div>
                    </div>

                    <!-- 774 $t -->
                    <div class="mb-3">
                        <label class="form-label small">
                            774 $t – Título
                        </label>

                        <div class="autocomplete-wrapper" data-autocomplete="titulo">
                            {{ form.titulo_texto }}
                            <div class="autocomplete-suggestions"></div>
                        </div>
                    </div>

                    <!-- 774 $w -->
                    <div class="mb-3">
                        <label class="form-label small">
                            774 $w – Número de esta obra en la colección 
                        </label>
                        <input type="text"
                               class="form-control campo-774-w"
                               name="numero_control_774_{{ forloop.counter0 }}"
                               placeholder="Seleccione una obra"
                               readonly
                               style="background-color: #f8f9fa; color: #6c757d; cursor: not-allowed;">
                    </div>

                </div>
            </div>
        </div>
        {% endfor %}

        <!-- EMPTY FORM -->
        <div class="formset-row empty-form d-none">

            {% for hidden in formset.empty_form.hidden_fields %}
                {{ hidden }}
            {% endfor %}

            <button type="button" class="delete-row-btn">
                <i class="bi bi-x-lg"></i>
            </button>

            <div class="card mt-3">
                <div class="card-body">

                    <div class="d-none">
                        {{ formset.empty_form.primer_indicador }}
                        {{ formset.empty_form.segundo_indicador }}
                    </div>

                    <div class="mb-3">
                        <label class="form-label small">774 $a – Compositor</label>
                        <div class="autocomplete-wrapper" data-autocomplete="persona">
                            {{ formset.empty_form.encabezamiento_principal_texto }}
                            {{ formset.empty_form.encabezamiento_principal }}
                            <div class="autocomplete-suggestions"></div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small">774 $t – Título</label>
                        <div class="autocomplete-wrapper" data-autocomplete="titulo">
                            {{ formset.empty_form.titulo_texto }}
                            <div class="autocomplete-suggestions"></div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <label class="form-label small fw-semibold">
                            774 $w – Número de esta obra en la colección
                        </label>
                        <input type="text"
                               class="form-control campo-774-w"
                               name="numero_control_774___prefix__"
                               placeholder="Seleccione una obra"
                               readonly
                               style="background-color: #f8f9fa; color: #6c757d; cursor: not-allowed;">
                    </div>

                </div>
            </div>
        </div>

    </div>
</div>

<script>
(function () {
    "use strict";

    const PREFIX = "{{ formset.prefix|escapejs }}";
    const container = document.querySelector(
        '[data-formset-prefix="' + PREFIX + '"]'
    );
    if (!container) return;

    const formsContainer = container.querySelector(".formset-forms");
    const emptyForm = formsContainer
        ? formsContainer.querySelector(".empty-form")
        : null;

    /* =====================================================
       AUTOCOMPLETE GENÉRICO (persona / título)
       ===================================================== */
    function initAutocomplete(wrapper) {
        if (!wrapper || wrapper.dataset.autocompleteInit === "1") return;
        wrapper.dataset.autocompleteInit = "1";

        const type = wrapper.dataset.autocomplete;
        const input = wrapper.querySelector("input");
        const box = wrapper.querySelector(".autocomplete-suggestions");

        if (!type || !input || !box) return;

        let endpoint = null;
        if (type === "persona")
            endpoint = "/catalogacion/api/autocompletar/persona/";
        if (type === "titulo")
            endpoint = "/catalogacion/api/autocompletar/titulo/";
        if (!endpoint) return;

        let timer = null;

        function hide() {
            box.classList.remove("show");
            box.innerHTML = "";
        }

        input.addEventListener("input", () => {
            const q = input.value.trim();
            if (q.length < 2) { hide(); return; }

            clearTimeout(timer);
            timer = setTimeout(() => {
                fetch(endpoint + "?q=" + encodeURIComponent(q))
                    .then(r => r.json())
                    .then(data => {
                        box.innerHTML = "";
                        const results = data.results || [];

                        results.forEach(item => {
                            const div = document.createElement("div");
                            div.className = "autocomplete-item";
                            div.textContent = item.text;
                            div.onclick = () => { input.value = item.text; hide(); };
                            box.appendChild(div);
                        });

                        const crear = document.createElement("div");
                        crear.className = "autocomplete-item autocomplete-item-new";
                        crear.innerHTML = '<i class="bi bi-plus-circle me-2"></i> Crear: "' +
                            escapeHtml(q) + '"';
                        crear.onclick = () => { input.value = q; hide(); };
                        box.appendChild(crear);

                        box.classList.add("show");
                    });
            }, 300);
        });

        document.addEventListener("click", e => {
            if (!wrapper.contains(e.target)) hide();
        });
    }

    function escapeHtml(text) {
        const d = document.createElement("div");
        d.textContent = text || "";
        return d.innerHTML;
    }

    /* =====================================================
       AGREGAR NUEVO FORMULARIO 774
       Manejo directo del botón "+" (no depende de FormsetManager)
       ===================================================== */
    function addForm774() {
        if (!formsContainer || !emptyForm) return;

        const totalFormsInput = container.querySelector(
            '[name="' + PREFIX + '-TOTAL_FORMS"]'
        );
        if (!totalFormsInput) return;

        const totalForms = parseInt(totalFormsInput.value, 10) || 0;

        // Clonar el template vacío
        const newForm = emptyForm.cloneNode(true);

        // Reemplazar __prefix__ con el nuevo índice
        newForm.innerHTML = newForm.innerHTML.replace(/__prefix__/g, totalForms);

        // Hacer visible: quitar clases de ocultación
        newForm.classList.remove("empty-form", "d-none");
        newForm.style.display = "";
        newForm.classList.add("mb-3");

        // Insertar antes del template vacío
        formsContainer.insertBefore(newForm, emptyForm);

        // Incrementar TOTAL_FORMS
        totalFormsInput.value = totalForms + 1;

        // Inicializar autocompletes en el nuevo formulario
        newForm.querySelectorAll(".autocomplete-wrapper[data-autocomplete]")
            .forEach(w => {
                w.removeAttribute("data-autocomplete-init");
                initAutocomplete(w);
            });
    }

    // Conectar al botón "+" global (está fuera del container, en relaciones.html).
    // Usa setTimeout(0) para ejecutarse DESPUÉS de que FormsetManager haya
    // clonado/reemplazado los botones en su propio DOMContentLoaded handler.
    document.addEventListener("DOMContentLoaded", function () {
        setTimeout(function () {
            const addBtn = document.querySelector(
                '[data-formset-target="' + PREFIX + '"]'
            );
            if (!addBtn) return;

            // Reemplazar el botón (elimina handlers de FormsetManager)
            // y agregar nuestro propio handler directo.
            const freshBtn = addBtn.cloneNode(true);
            addBtn.parentNode.replaceChild(freshBtn, addBtn);
            freshBtn.addEventListener("click", function (e) {
                e.preventDefault();
                addForm774();
            });
        }, 0);
    });

    /* =====================================================
       INIT INICIAL: autocompletes en formularios existentes
       ===================================================== */
    container
        .querySelectorAll(".autocomplete-wrapper[data-autocomplete]")
        .forEach(initAutocomplete);

    /* =====================================================
       BLOQUEAR ESCRITURA EN CAMPO 774 $w (readonly refuerzo)
       ===================================================== */
    document.addEventListener("keydown", function (e) {
        if (e.target.classList.contains("campo-774-w")) {
            e.preventDefault();
        }
    });

    document.addEventListener("paste", function (e) {
        if (e.target.classList.contains("campo-774-w")) {
            e.preventDefault();
        }
    });

})();
</script>