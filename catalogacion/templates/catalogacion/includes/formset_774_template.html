{% comment %}
FORMSET 774 â€“ Obra en esta colecciÃ³n (R)
Estilo compatible con 856 / 700
{% endcomment %}

<div class="formset-container"
     data-formset-prefix="{{ formset.prefix }}">

    <!-- Management form -->
    <div class="d-none">
        {% for hidden in formset.management_form %}
            {{ hidden }}
        {% endfor %}
    </div>

    <div class="formset-forms">

        {% for form in formset %}
        <div class="formset-row {% if form.instance.pk %}existing-form{% endif %} mb-3">

            {% for hidden in form.hidden_fields %}
                {{ hidden }}
            {% endfor %}

            {% if formset.can_delete %}
                <div class="d-none">{{ form.DELETE }}</div>
            {% endif %}

            <button type="button" class="delete-row-btn">
                <i class="bi bi-x-lg"></i>
            </button>

            <div class="card mt-3">
                <div class="card-body">

                    <!-- Indicadores -->
                    <div class="d-none">
                        {{ form.primer_indicador }}
                        {{ form.segundo_indicador }}
                    </div>

                    <!-- 774 $a -->
                    <div class="mb-3">
                        <label class="form-label small">
                            774 $a â€“ Compositor
                        </label>

                        <div class="autocomplete-wrapper" data-autocomplete="persona">
                            {{ form.encabezamiento_principal_texto }}
                            {{ form.encabezamiento_principal }}
                            <div class="autocomplete-suggestions"></div>
                        </div>
                    </div>

                    <!-- 774 $t -->
                    <div class="mb-3">
                        <label class="form-label small">
                            774 $t â€“ TÃ­tulo
                        </label>

                        <div class="autocomplete-wrapper" data-autocomplete="titulo">
                            {{ form.titulo_texto }}
                            <div class="autocomplete-suggestions"></div>
                        </div>
                    </div>

                    <!-- 774 $w -->
                    <div class="mb-3">
                        <label class="form-label small">
                            774 $w â€“ NÃºmero de esta obra en la colecciÃ³n 
                        </label>
                        <input type="text"
                               class="form-control campo-774-w"
                               name="numero_control_774_{{ forloop.counter0 }}"
                               placeholder="Seleccione una obra"
                               readonly
                               style="background-color: #f8f9fa; color: #6c757d; cursor: not-allowed;">
                    </div>

                </div>
            </div>
        </div>
        {% endfor %}

        <!-- EMPTY FORM -->
        <div class="formset-row empty-form d-none">

            {% for hidden in formset.empty_form.hidden_fields %}
                {{ hidden }}
            {% endfor %}

            <button type="button" class="delete-row-btn">
                <i class="bi bi-x-lg"></i>
            </button>

            <div class="card mt-3">
                <div class="card-body">

                    <div class="d-none">
                        {{ formset.empty_form.primer_indicador }}
                        {{ formset.empty_form.segundo_indicador }}
                    </div>

                    <div class="mb-3">
                        <label class="form-label small">774 $a â€“ Compositor</label>
                        <div class="autocomplete-wrapper" data-autocomplete="persona">
                            {{ formset.empty_form.encabezamiento_principal_texto }}
                            {{ formset.empty_form.encabezamiento_principal }}
                            <div class="autocomplete-suggestions"></div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small">774 $t â€“ TÃ­tulo</label>
                        <div class="autocomplete-wrapper" data-autocomplete="titulo">
                            {{ formset.empty_form.titulo_texto }}
                            <div class="autocomplete-suggestions"></div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <label class="form-label small fw-semibold">
                            774 $w â€“ NÃºmero de esta obra en la colecciÃ³n
                        </label>
                        <input type="text"
                               class="form-control campo-774-w"
                               name="numero_control_774___prefix__"
                               placeholder="Seleccione una obra"
                               readonly
                               style="background-color: #f8f9fa; color: #6c757d; cursor: not-allowed;">
                    </div>

                </div>
            </div>
        </div>

    </div>
</div>

<script>
(function () {

    /* =====================================================
       AUTOCOMPLETE GENÃ‰RICO (persona / tÃ­tulo)
       ===================================================== */
    function initAutocomplete(wrapper) {

        // ðŸ”¥ CLAVE: permitir reinicializar
        wrapper.removeAttribute("data-autocomplete-init");

        if (!wrapper || wrapper.dataset.autocompleteInit === "1") return;
        wrapper.dataset.autocompleteInit = "1";

        const type  = wrapper.dataset.autocomplete;
        const input = wrapper.querySelector("input");
        const box   = wrapper.querySelector(".autocomplete-suggestions");

        if (!type || !input || !box) return;

        let endpoint = null;

        if (type === "persona") {
            endpoint = "/catalogacion/api/autocompletar/persona/";
        }
        if (type === "titulo") {
            endpoint = "/catalogacion/api/autocompletar/titulo/";
        }
        if (!endpoint) return;

        let timer = null;

        function hide() {
            box.classList.remove("show");
            box.innerHTML = "";
        }

        input.addEventListener("input", () => {
            const q = input.value.trim();
            if (q.length < 2) {
                hide();
                return;
            }

            clearTimeout(timer);
            timer = setTimeout(() => {
                fetch(`${endpoint}?q=${encodeURIComponent(q)}`)
                    .then(r => r.json())
                    .then(data => {
                        box.innerHTML = "";
                        const results = data.results || [];

                        if (!results.length) {
                            box.innerHTML = `
                                <div class="autocomplete-item autocomplete-item-new">
                                    <i class="bi bi-plus-circle me-2"></i>
                                    Crear: "${q}"
                                </div>`;
                        } else {
                            results.forEach(item => {
                                const div = document.createElement("div");
                                div.className = "autocomplete-item";
                                div.textContent = item.text;
                                div.onclick = () => {
                                    input.value = item.text;
                                    hide();
                                };
                                box.appendChild(div);
                            });

                            const crear = document.createElement("div");
                            crear.className = "autocomplete-item autocomplete-item-new";
                            crear.innerHTML = `<i class="bi bi-plus-circle me-2"></i> Crear: "${q}"`;
                            crear.onclick = () => {
                                input.value = q;
                                hide();
                            };
                            box.appendChild(crear);
                        }

                        box.classList.add("show");
                    });
            }, 300);
        });

        document.addEventListener("click", e => {
            if (!wrapper.contains(e.target)) hide();
        });
    }

    /* =====================================================
       HOOK: reinicializar autocomplete al agregar fila
       (evita duplicar filas por handlers globales)
       ===================================================== */
    const THIS_FORMSET_PREFIX = "{{ formset.prefix|escapejs }}";

    console.log('ðŸ” 774 Formset prefix:', THIS_FORMSET_PREFIX);

    // Si existe el gestor central (FormsetManager), Ã©l es el Ãºnico que agrega filas.
    // AquÃ­ solo reinicializamos autocompletes cuando se agrega una nueva fila.
    document.addEventListener("formset:added", function (ev) {
        console.log('ðŸ”¥ formset:added event fired:', ev.detail);
        
        const detail = ev && ev.detail ? ev.detail : null;
        if (!detail || detail.prefix !== THIS_FORMSET_PREFIX) {
            console.log('ðŸš« Event not for this formset:', detail?.prefix, 'expected:', THIS_FORMSET_PREFIX);
            return;
        }

        console.log('âœ… Processing formset:added for 774');
        const root = detail.newForm;
        if (!root || !root.querySelectorAll) {
            console.log('ðŸš« No root or no querySelectorAll');
            return;
        }

        console.log('ðŸ” New form element:', root);
        
        const wrappers = root.querySelectorAll(".autocomplete-wrapper[data-autocomplete]");
        console.log('ðŸ” Found autocomplete wrappers:', wrappers.length);

        wrappers.forEach((w, index) => {
            console.log(`ðŸ”„ Processing wrapper ${index}:`, w.dataset.autocomplete);
            w.removeAttribute("data-autocomplete-init");
            initAutocomplete(w);
        });

        // ðŸ”¥ TambiÃ©n inicializar el bloqueo del campo $w en el nuevo formulario
        const wInputs = root.querySelectorAll('.campo-774-w');
        console.log('ðŸ” Found 774 $w inputs:', wInputs.length);
        wInputs.forEach((input, index) => {
            console.log(`ðŸ”’ Configuring 774 $w input ${index}:`, input);
        });
    });

    /* =====================================================
       INICIALIZAR AL CARGAR PÃGINA
       ===================================================== */
    console.log('ðŸš€ 774 Formset script loaded');
    
    // Verificar que el botÃ³n + existe
    setTimeout(() => {
        const addBtn = document.querySelector('[data-formset-target="{{ formset.prefix|escapejs }}"]');
        console.log('ðŸ” Add button found:', addBtn);
        
        if (addBtn) {
            console.log('âœ… Add button exists, adding click listener for debugging');
            addBtn.addEventListener('click', function() {
                console.log('ðŸ”¥ Add button clicked!');
                
                // ðŸ”¥ CLONACIÃ“N MANUAL DIRECTA
                setTimeout(() => {
                    console.log('ðŸ”§ Starting manual formset cloning...');
                    
                    const container = document.querySelector('.formset-forms');
                    const emptyForm = document.querySelector('.empty-form');
                    
                    if (!container || !emptyForm) {
                        console.log('ðŸš« Container or empty form not found');
                        return;
                    }
                    
                    // Clonar el empty form
                    const newForm = emptyForm.cloneNode(true);
                    newForm.classList.remove('empty-form');
                    newForm.classList.remove('d-none');
                    newForm.style.display = 'block';
                    newForm.classList.add('mb-3');
                    
                    // Reemplazar __prefix__ con el Ã­ndice actual
                    const totalForms = container.querySelectorAll('.formset-row:not(.empty-form)').length;
                    const newHtml = newForm.innerHTML.replace(/__prefix__/g, totalForms);
                    newForm.innerHTML = newHtml;
                    
                    // Agregar al container
                    container.appendChild(newForm);
                    
                    console.log('âœ… Form cloned manually:', newForm);
                    
                    // ðŸ”¥ Inicializar autocompletes en el nuevo formulario
                    const wrappers = newForm.querySelectorAll(".autocomplete-wrapper[data-autocomplete]");
                    console.log('ðŸ” Found autocomplete wrappers in cloned form:', wrappers.length);
                    
                    wrappers.forEach((w, index) => {
                        console.log(`ðŸ”„ Processing wrapper ${index}:`, w.dataset.autocomplete);
                        w.removeAttribute("data-autocomplete-init");
                        initAutocomplete(w);
                    });
                    
                    // ðŸ”¥ Actualizar management form
                    const totalFormsInput = document.querySelector('input[name$="-TOTAL_FORMS"]');
                    if (totalFormsInput) {
                        totalFormsInput.value = totalForms + 1;
                        console.log('âœ… Updated TOTAL_FORMS to:', totalForms + 1);
                    }
                    
                }, 100);
            });
        } else {
            console.log('ðŸš« Add button NOT found!');
        }
    }, 1000);

    /* =====================================================
       INIT INICIAL
       ===================================================== */
    document
        .querySelectorAll(".autocomplete-wrapper[data-autocomplete]")
        .forEach(initAutocomplete);

    /* =====================================================
       BLOQUEAR ESCRITURA EN CAMPO 774 $w
       ===================================================== */
    document.addEventListener('keydown', function(e) {
        if (e.target.classList.contains('campo-774-w')) {
            e.preventDefault();
            return false;
        }
    });

    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('campo-774-w')) {
            e.preventDefault();
            e.target.value = e.target.defaultValue || '';
            return false;
        }
    });

    document.addEventListener('paste', function(e) {
        if (e.target.classList.contains('campo-774-w')) {
            e.preventDefault();
            return false;
        }
    });

})();
</script>