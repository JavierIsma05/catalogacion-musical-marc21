{% comment %}
Template 700 â€“ Nombres Relacionados
Estilo unificado con 852 / 856 / 650 / 655
Solo HTML (JS va despuÃ©s)
Orden vertical limpio
{% endcomment %}

{% load catalogacion_tags %}
{% get_funciones_persona as funciones_opciones %}

<div class="formset-container" data-formset-prefix="{{ formset.prefix }}">

    <!-- Management form -->
    <div style="display:none;">
        {% for hidden in formset.management_form %}
        {{ hidden }}
        {% endfor %}
    </div>

    <div class="formset-forms">

        {% for form in formset %}
        <div class="formset-row {% if form.instance.pk %}existing-form{% endif %} mb-3">

            {% for hidden in form.hidden_fields %}
            {{ hidden }}
            {% endfor %}

            {% if formset.can_delete %}
            <div class="d-none">
                {{ form.DELETE }}
            </div>
            {% endif %}

            <!-- âŒ eliminar fila 700 -->
            <button type="button" class="delete-row-btn" title="Eliminar nombre relacionado">
                <i class="bi bi-x-lg"></i>
            </button>

            <div class="campo-grid">

                <!-- 700 $a â€“ Nombre de persona -->
                <div class="col-full">
                    {{ form.persona }}
                    <label class="form-label small">700 $a â€“ Apellidos / nombres</label>
                    <div class="autocomplete-wrapper">
                        {{ form.persona_texto }}
                        <div class="autocomplete-suggestions persona700-suggestions"></div>
                    </div>
                </div>
                <!-- 700 $d â€“ Coordenadas biogrÃ¡ficas -->
                <div class="col-full">
                    <label class="form-label small">700 $d â€“ Coordenadas biogrÃ¡ficas</label>
                    {{ form.persona_coordenadas }}
                </div>

                <!-- 700 $c â€“ TÃ©rmino asociado -->
                <div class="col-full">
                    <label class="form-label small">700 $c â€“ TÃ©rmino asociado</label>
                    <div class="subcampo-repetible-container terminos-container"
                        data-terminos-container="{{ forloop.counter0 }}" data-borrador-container="termino_asociado_700" data-borrador-parent="{{ forloop.counter0 }}">

                        {% if form.instance.pk %}
                        {% for termino in form.instance.terminos_asociados.all %}
                        <div class="subcampo-row termino-form-row">
                            {% if forloop.first %}
                            <button type="button" class="subcampo-add-btn add-termino-btn"
                                data-nombre-index="{{ forloop.parentloop.counter0 }}" data-borrador-add="termino_asociado_700" data-borrador-parent="{{ forloop.parentloop.counter0 }}">
                                <i class="bi bi-plus"></i>
                            </button>
                            {% else %}
                            <div class="subcampo-placeholder"></div>
                            {% endif %}

                            <input type="text" class="form-control termino-input"
                                name="termino_asociado_700_{{ forloop.parentloop.counter0 }}_{{ termino.pk }}"
                                value="{{ termino.termino }}" placeholder="Dr., Lic., etc.">

                            <button type="button" class="subcampo-delete-btn delete-termino-btn" {% if forloop.first and forloop.last %}style="visibility:hidden;" {% endif %}>
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="subcampo-row termino-form-row">
                            <button type="button" class="subcampo-add-btn add-termino-btn"
                                data-nombre-index="{{ forloop.counter0 }}" data-borrador-add="termino_asociado_700" data-borrador-parent="{{ forloop.counter0 }}">
                                <i class="bi bi-plus"></i>
                            </button>
                            <input type="text" class="form-control termino-input"
                                name="termino_asociado_700_{{ forloop.counter0 }}_0" placeholder="Dr., Lic., etc.">
                            <button type="button" class="subcampo-delete-btn delete-termino-btn"
                                style="visibility:hidden;">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>

                

                <!-- 700 $e â€“ FunciÃ³n (REPETIBLE, INLINE FORMSET) -->
                <div class="col-full">
                    <label class="form-label small">700 $e â€“ FunciÃ³n</label>

                    <div class="subcampo-repetible-container funciones-container" data-borrador-container="funcion_700" data-borrador-parent="{{ forloop.counter0 }}">

                        {{ form.funcion700_formset.management_form }}

                        {% for fform in form.funcion700_formset %}
                        <div class="subcampo-row funcion-form-row">

                            {% if forloop.first %}
                            <button type="button"
                                    class="subcampo-add-btn add-funcion-btn"
                                    data-nombre-index="{{ forloop.parentloop.counter0 }}" data-borrador-add="funcion_700" data-borrador-parent="{{ forloop.parentloop.counter0 }}">
                                <i class="bi bi-plus"></i>
                            </button>
                            {% else %}
                            <div class="subcampo-placeholder" aria-hidden="true"></div>
                            {% endif %}

                            {{ fform.funcion }}

                            {% if form.funcion700_formset.can_delete %}
                                <div class="d-none">
                                    {{ fform.DELETE }}
                                </div>
                                <button type="button"
                                        class="subcampo-delete-btn delete-funcion-btn"
                                        {% if forloop.first %}style="visibility:hidden"{% endif %}>
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            {% endif %}
                        </div>
                        {% endfor %}

                    </div>
                </div>


                <!-- 700 $i â€“ RelaciÃ³n (oculto) -->
                <div class="col-full" style="display:none;">
                    <label class="form-label small">700 $i â€“ RelaciÃ³n</label>
                    {{ form.relacion }}
                </div>

                <!-- 700 $j â€“ AutorÃ­a -->
                <div class="col-full">
                    <label class="form-label small">700 $j â€“ AutorÃ­a</label>
                    {{ form.autoria }}
                </div>

                <!-- 700 $t â€“ TÃ­tulo de la obra -->
                <div class="col-full">
                    <label class="form-label small">700 $t â€“ TÃ­tulo de la obra</label>
                    <div class="autocomplete-wrapper">
                        {{ form.titulo_obra }}
                        <div class="autocomplete-suggestions titulo700-suggestions"></div>
                    </div>
                </div>

            </div>

        </div>
        {% endfor %}

        <!-- EMPTY FORM -->
        <div class="formset-row empty-form mb-3" style="display:none;">
            <button type="button" class="delete-row-btn" title="Eliminar nombre relacionado">
                <i class="bi bi-x-lg"></i>
            </button>

            <div class="campo-grid">

                <div class="col-full">
                    {{ formset.empty_form.persona }}
                    <label class="form-label small">700 $a â€“ Nombre de persona</label>
                    <div class="autocomplete-wrapper">
                        {{ formset.empty_form.persona_texto }}
                        <div class="autocomplete-suggestions persona700-suggestions"></div>
                    </div>
                </div>

                <div class="col-full">
                    <label class="form-label small">700 $d â€“ Coordenadas biogrÃ¡ficas</label>
                    {{ formset.empty_form.persona_coordenadas }}
                </div>

                <!-- 700 $c -->
                <div class="col-full">
                    <label class="form-label small">700 $c â€“ TÃ©rmino asociado</label>
                    <div class="subcampo-repetible-container terminos-container" data-terminos-container="__prefix__" data-borrador-container="termino_asociado_700" data-borrador-parent="__prefix__">
                        <div class="subcampo-row termino-form-row">
                            <button type="button" class="subcampo-add-btn add-termino-btn"
                                data-nombre-index="__prefix__" data-borrador-add="termino_asociado_700" data-borrador-parent="__prefix__">
                                <i class="bi bi-plus"></i>
                            </button>
                            <input type="text" class="form-control termino-input"
                                name="termino_asociado_700___prefix___0" placeholder="Dr., Lic., etc.">
                            <button type="button" class="subcampo-delete-btn delete-termino-btn"
                                style="visibility:hidden;">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 700 $e â€“ FunciÃ³n (INLINE FORMSET) -->
                <div class="col-full">
                    <label class="form-label small">700 $e â€“ FunciÃ³n</label>
                    <div class="subcampo-repetible-container funciones-container" data-funciones-container="__prefix__" data-borrador-container="funcion_700" data-borrador-parent="__prefix__">

                        {% if funcion700_empty_formset %}
                            {{ funcion700_empty_formset.management_form }}

                            {% for fform in funcion700_empty_formset %}
                            <div class="subcampo-row funcion-form-row">
                                {% if forloop.first %}
                                <button type="button" class="subcampo-add-btn add-funcion-btn"
                                    data-nombre-index="__prefix__" data-borrador-add="funcion_700" data-borrador-parent="__prefix__">
                                    <i class="bi bi-plus"></i>
                                </button>
                                {% else %}
                                <div class="subcampo-placeholder" aria-hidden="true"></div>
                                {% endif %}

                                {{ fform.funcion }}

                                {% if funcion700_empty_formset.can_delete %}
                                    {{ fform.DELETE }}
                                    <button type="button" class="subcampo-delete-btn delete-funcion-btn"
                                        {% if forloop.first %}style="visibility:hidden"{% endif %}>
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                {% endif %}
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="subcampo-row funcion-form-row">
                                <button type="button" class="subcampo-add-btn add-funcion-btn"
                                    data-nombre-index="__prefix__" data-borrador-add="funcion_700" data-borrador-parent="__prefix__">
                                    <i class="bi bi-plus"></i>
                                </button>
                                <select class="form-select funcion-select" name="funcion700-__prefix__-0-funcion">
                                    <option value="">---------</option>
                                </select>
                                <button type="button" class="subcampo-delete-btn delete-funcion-btn" style="visibility:hidden;">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        {% endif %}

                    </div>
                </div>

                <!-- 700 $i â€“ RelaciÃ³n (oculto) -->
                <div class="col-full" style="display:none;">
                    <label class="form-label small">700 $i â€“ RelaciÃ³n</label>
                    {{ formset.empty_form.relacion }}
                </div>

                <div class="col-full">
                    <label class="form-label small">700 $j â€“ AutorÃ­a</label>
                    {{ formset.empty_form.autoria }}
                </div>

                <div class="col-full">
                    <label class="form-label small">700 $t â€“ TÃ­tulo de la obra</label>
                    <div class="autocomplete-wrapper">
                        {{ formset.empty_form.titulo_obra }}
                        <div class="autocomplete-suggestions titulo700-suggestions"></div>
                    </div>
                </div>

            </div>
        </div>

    </div>
</div>


<script>
(function () {

    const prefix = "{{ formset.prefix }}";
    const root = document.querySelector(`[data-formset-prefix="${prefix}"]`);
    if (!root) return;

    /* ======================================================
       AUTOCOMPLETE PERSONA 700 $a (SIN CAMBIOS)
       ====================================================== */
    function initPersonaAutocomplete(row) {
        if (row.dataset.persona700Init === "1") return;
        row.dataset.persona700Init = "1";

        const input = row.querySelector('input[name$="persona_texto"]');
        const hidden = row.querySelector('input[name$="persona"]');
        const coord = row.querySelector('input[name$="persona_coordenadas"]');
        const box = row.querySelector('.persona700-suggestions');

        if (!input || !hidden || !box) return;

        let timer = null;

        function hide() {
            box.classList.remove("show");
            box.innerHTML = "";
        }

        function selectPersona(p) {
            input.value = p.text;
            hidden.value = p.id || "";
            if (coord) coord.value = p.coordenadas || "";
            hide();
        }

        function render(list, query) {
            box.innerHTML = "";

            list.forEach(p => {
                const d = document.createElement("div");
                d.className = "autocomplete-item";
                d.innerHTML = `<strong>${p.apellidos_nombres}</strong>`;
                d.onclick = () => selectPersona({
                    text: p.apellidos_nombres,
                    id: p.id,
                    coordenadas: p.coordenadas_biograficas || ""
                });
                box.appendChild(d);
            });

            const nuevo = document.createElement("div");
            nuevo.className = "autocomplete-item autocomplete-item-new";
            nuevo.innerHTML = `<i class="bi bi-plus-circle me-2"></i> Crear: "${query}"`;
            nuevo.onclick = () => selectPersona({ text: query, id: "" });
            box.appendChild(nuevo);

            box.classList.add("show");
        }

        function search(q) {
            fetch(`/catalogacion/api/autocompletar/persona/?q=${encodeURIComponent(q)}`)
                .then(r => r.json())
                .then(data => render(data.results || [], q))
                .catch(() => hide());
        }

        input.addEventListener("input", () => {
            const q = input.value.trim();
            hidden.value = "";
            if (q.length < 2) return hide();
            clearTimeout(timer);
            timer = setTimeout(() => search(q), 300);
        });

        document.addEventListener("click", e => {
            if (!row.contains(e.target)) hide();
        });
    }

    /* ======================================================
       REINDEXAR FORMSET 700 (SIN CAMBIOS)
       ====================================================== */
    function reindex700() {
        const rows = root.querySelectorAll(".formset-row:not(.empty-form)");
        const totalInput = root.querySelector(`[name="${prefix}-TOTAL_FORMS"]`);

        rows.forEach((row, index) => {
            row.querySelectorAll("[name], [id], label[for]").forEach(el => {
                ["name", "id", "for"].forEach(attr => {
                    const val = el.getAttribute(attr);
                    if (!val) return;
                    el.setAttribute(
                        attr,
                        val.replace(/-\d+-/g, `-${index}-`)
                           .replace(/__prefix__/g, index)
                    );
                });
            });

            // âœ… Reindexar nombres custom de 700$c (no son formset Django)
            row.querySelectorAll('input[name^="termino_asociado_700_"]').forEach(input => {
                const name = input.getAttribute('name');
                if (!name) return;
                // termino_asociado_700_{idx}_...
                input.setAttribute('name', name.replace(/^termino_asociado_700_\d+_/, `termino_asociado_700_${index}_`));
            });

            row.querySelectorAll("[data-nombre-index]").forEach(btn =>
                btn.dataset.nombreIndex = index
            );

            // âœ… Reindexar contenedores y relaciones de borrador
            row.querySelectorAll("[data-borrador-parent]").forEach(el => {
                el.dataset.borradorParent = index;
            });

            row.querySelectorAll(".terminos-container").forEach(cont => {
                cont.dataset.terminosContainer = index;
                cont.dataset.borradorParent = index;
            });

            row.querySelectorAll(".funciones-container").forEach(cont => {
                cont.dataset.funcionesContainer = index;
                cont.dataset.borradorParent = index;
            });

            initPersonaAutocomplete(row);
            normalize700Row(row);
        });

        if (totalInput) totalInput.value = rows.length;
    }

    /* ======================================================
       EVENTOS
       ====================================================== */

    function forceNativeSelect(select) {
        if (!select) return;

        // Si Select2 ya estÃ¡ aplicado, destruirlo
        if (window.$ && $.fn && typeof $.fn.select2 === 'function') {
            try {
                if ($(select).data('select2')) {
                    $(select).select2('destroy');
                }
            } catch (e) {
                // ignore
            }
        }

        // Limpiar clases/attrs tÃ­picos de Select2
        select.classList.remove('select2-hidden-accessible');
        select.classList.remove('select2');
        select.removeAttribute('data-select2-id');
        select.removeAttribute('tabindex');

        // El contenedor de Select2 suele estar como siguiente hermano
        let sib = select.nextElementSibling;
        while (sib && sib.classList && (sib.classList.contains('select2') || sib.classList.contains('select2-container'))) {
            const toRemove = sib;
            sib = sib.nextElementSibling;
            toRemove.remove();
        }

        const wrapper = select.parentElement;
        if (wrapper) {
            wrapper.querySelectorAll('.select2-container').forEach(el => el.remove());
        }
    }

    function normalize700Row(row) {
        if (!row) return;
        // 700 $j â€“ AutorÃ­a debe ser select nativo
        row.querySelectorAll('select[name$="-autoria"]').forEach(forceNativeSelect);
        // 700 $e â€“ FunciÃ³n (inline formset) debe ser select nativo
        row.querySelectorAll('.funciones-container select').forEach(forceNativeSelect);
    }

    function updateFuncionesLayout(funcionesContainer) {
        if (!funcionesContainer) return;

        // En duplicaciones/clonados puede venir vacÃ­o: recalcular desde la fila 700
        let parentIndex = funcionesContainer.dataset.borradorParent;
        if (parentIndex === undefined || parentIndex === null || parentIndex === '') {
            const formRow = funcionesContainer.closest('.formset-row');
            if (formRow) {
                const rows = Array.from(root.querySelectorAll('.formset-row:not(.empty-form)'));
                const idx = rows.indexOf(formRow);
                if (idx >= 0) parentIndex = String(idx);
            }
        }
        const visibleRows = Array.from(funcionesContainer.querySelectorAll('.funcion-form-row'))
            .filter(r => r.style.display !== 'none');

        if (!visibleRows.length) return;

        visibleRows.forEach((row, idx) => {
            const isFirst = idx === 0;
            const addBtn = row.querySelector('.add-funcion-btn');
            const placeholder = row.querySelector('.subcampo-placeholder');
            const delBtn = row.querySelector('.delete-funcion-btn');

            // Izquierda: solo primera fila con [+], resto placeholder (como 382)
            if (isFirst) {
                if (!addBtn) {
                    const newBtn = document.createElement('button');
                    newBtn.type = 'button';
                    newBtn.className = 'subcampo-add-btn add-funcion-btn';
                    if (parentIndex !== undefined) newBtn.dataset.nombreIndex = parentIndex;
                    newBtn.dataset.borradorAdd = 'funcion_700';
                    if (parentIndex !== undefined) newBtn.dataset.borradorParent = parentIndex;
                    newBtn.innerHTML = '<i class="bi bi-plus"></i>';
                    if (placeholder) {
                        placeholder.replaceWith(newBtn);
                    } else {
                        row.insertBefore(newBtn, row.firstChild);
                    }
                }
            } else {
                if (addBtn) {
                    const newPh = document.createElement('div');
                    newPh.className = 'subcampo-placeholder';
                    newPh.setAttribute('aria-hidden', 'true');
                    addBtn.replaceWith(newPh);
                } else if (!placeholder) {
                    const newPh = document.createElement('div');
                    newPh.className = 'subcampo-placeholder';
                    newPh.setAttribute('aria-hidden', 'true');
                    row.insertBefore(newPh, row.firstChild);
                }
            }

            // Derecha: primera fila sin [X], resto con [X]
            if (delBtn) {
                delBtn.style.visibility = isFirst ? 'hidden' : 'visible';
            }
        });
    }

    root.addEventListener("click", e => {

        /* ==========================================
           âž• 700 $c â€“ tÃ©rmino asociado (SIN CAMBIOS)
           ========================================== */
        const addTermino = e.target.closest(".add-termino-btn");
        if (addTermino) {
            const index = addTermino.dataset.nombreIndex;
            const cont = root.querySelector(`[data-terminos-container="${index}"]`);
            if (!cont) return;

            const row = document.createElement("div");
            row.className = "subcampo-row mt-2";
            row.innerHTML = `
                <div class="subcampo-placeholder"></div>
                <input type="text" class="form-control termino-input"
                       name="termino_asociado_700_${index}_${Date.now()}"
                       placeholder="Dr., Lic., etc.">
                <button type="button" class="subcampo-delete-btn delete-termino-btn">
                    <i class="bi bi-x-lg"></i>
                </button>`;
            cont.appendChild(row);
            return;
        }

        /* ==========================================
           âž• 700 $e â€“ FUNCIÃ“N (INLINE FORMSET CORRECTO)
           ========================================== */
        const addFuncion = e.target.closest('.add-funcion-btn');
        if (addFuncion) {
            const container = addFuncion.closest('.funciones-container');
            if (!container) return;

            const template = root.querySelector('.funcion-template-700');

            // Prefix del inline formset y nuevo Ã­ndice
            const management = container.querySelector('input[name$="-TOTAL_FORMS"]');
            if (!management || !management.name) return;
            const inlinePrefix = management.name.replace(/-TOTAL_FORMS$/, "");
            const newIndex = parseInt(management.value, 10) || 0;

            const rows = Array.from(container.querySelectorAll(".funcion-form-row"))
                .filter(r => r.style.display !== 'none');
            if (!rows.length) return;

            // Construir clon: preferir template, sino clonar la Ãºltima fila
            const last = rows[rows.length - 1];
            let clone;
            if (template) {
                clone = template.cloneNode(true);
            } else {
                clone = last.cloneNode(true);
            }
            clone.style.display = '';

            // Limpiar artefactos de Select2 si existieran por clonaciÃ³n
            clone.querySelectorAll('.select2-container').forEach(el => el.remove());
            clone.querySelectorAll('select').forEach(select => {
                select.classList.remove('select2-hidden-accessible');
                select.classList.remove('select2');
                select.removeAttribute('data-select2-id');
                select.removeAttribute('tabindex');
                const next = select.nextElementSibling;
                if (next && next.classList && next.classList.contains('select2')) next.remove();
            });

            // Reindexar name/id/for del inline formset (funcion700-...-X-...)
            let oldIndex = null;
            const anyField = clone.querySelector(`[name^="${inlinePrefix}-"]`) || clone.querySelector(`[id^="id_${inlinePrefix}-"]`);
            const anyName = anyField?.getAttribute('name') || anyField?.getAttribute('id') || '';
            const m = anyName.match(new RegExp(`^id_?${inlinePrefix}-([0-9]+)-`));
            if (m && m[1] != null) oldIndex = m[1];

            // Fallback: tomar del Ãºltimo select real
            if (oldIndex == null) {
                const lastSelect = last.querySelector('select');
                const nm = lastSelect?.getAttribute('name') || '';
                const m2 = nm.match(new RegExp(`^${inlinePrefix}-([0-9]+)-`));
                if (m2 && m2[1] != null) oldIndex = m2[1];
            }
            if (oldIndex == null) oldIndex = String(Math.max(0, rows.length - 1));

            clone.querySelectorAll('[name], [id], label[for]').forEach(el => {
                ['name', 'id', 'for'].forEach(attr => {
                    const val = el.getAttribute(attr);
                    if (!val) return;
                    el.setAttribute(
                        attr,
                        val.replace(new RegExp(`${inlinePrefix}-${oldIndex}-`, 'g'), `${inlinePrefix}-${newIndex}-`)
                    );
                });
            });

            // Ajustar select y nombre final
            const baseName = management.name.replace(/-TOTAL_FORMS$/, '');
            const select = clone.querySelector('.funcion-select') || clone.querySelector('select');
            if (select) {
                select.name = `${baseName}-${newIndex}-funcion`;
                select.selectedIndex = 0;
            }

            const delBtn = clone.querySelector('.delete-funcion-btn');
            if (delBtn) delBtn.style.visibility = 'visible';

            // asegurar layout tipo 382: el clon NO debe traer [+]
            const addInClone = clone.querySelector('.add-funcion-btn');
            if (addInClone) {
                const ph = document.createElement('div');
                ph.className = 'subcampo-placeholder';
                ph.setAttribute('aria-hidden', 'true');
                addInClone.replaceWith(ph);
            } else if (!clone.querySelector('.subcampo-placeholder')) {
                const ph = document.createElement('div');
                ph.className = 'subcampo-placeholder';
                ph.setAttribute('aria-hidden', 'true');
                clone.insertBefore(ph, clone.firstChild);
            }

            container.appendChild(clone);

            // ðŸ”¥ actualizar TOTAL_FORMS del inline formset
            management.value = newIndex + 1;

            // 700$e debe ser nativo: forzar limpieza anti-Select2
            clone.querySelectorAll('select').forEach(forceNativeSelect);

            updateFuncionesLayout(container);
            return;
        }

        /* ==========================================
           âŒ eliminar subcampo $c o $e
           ========================================== */
        const delBtn = e.target.closest(".delete-termino-btn, .delete-funcion-btn");
        if (delBtn) {
            const row = delBtn.closest(".subcampo-row, .funcion-form-row");
            if (!row) return;

            const delInput = row.querySelector('input[type="checkbox"]');
            if (delInput) {
                delInput.checked = true;
                row.style.display = "none";
            } else {
                row.remove();
            }

            const funcionesContainer = delBtn.closest('.funciones-container');
            if (funcionesContainer) {
                updateFuncionesLayout(funcionesContainer);
            }
        }
    });

    // Cuando se agrega desde el gestor global (formset-manager.js), reindexar e inicializar
    root.addEventListener('formset:added', (ev) => {
        if (!ev || !ev.detail || ev.detail.prefix !== prefix) return;
        // small timeout to let DOM settle
        setTimeout(() => {
            reindex700();
            root.querySelectorAll('.formset-row:not(.empty-form)').forEach(row => initPersonaAutocomplete(row));
        }, 20);
    });

    /* ======================================================
       INIT
       ====================================================== */
    root.querySelectorAll(".formset-row:not(.empty-form)")
        .forEach(row => initPersonaAutocomplete(row));

    // Forzar selects nativos en filas existentes (evita Select2 indeseado en $e/$j)
    root.querySelectorAll('.formset-row:not(.empty-form)').forEach(normalize700Row);

    // Normalizar layout de 700 $e al cargar
    root.querySelectorAll('.funciones-container').forEach(updateFuncionesLayout);

    reindex700();

    // Reindexar automÃ¡ticamente si se agregan/eliminan filas 700 (duplicaciÃ³n/clonado)
    const formsHost = root.querySelector('.formset-forms');
    if (formsHost) {
        let reindexTimer = null;
        const observer = new MutationObserver(() => {
            clearTimeout(reindexTimer);
            reindexTimer = setTimeout(() => {
                reindex700();
                root.querySelectorAll('.funciones-container').forEach(updateFuncionesLayout);
                root.querySelectorAll('.formset-row:not(.empty-form)').forEach(normalize700Row);
            }, 0);
        });

        observer.observe(formsHost, { childList: true, subtree: true });
    }

})();
</script>
