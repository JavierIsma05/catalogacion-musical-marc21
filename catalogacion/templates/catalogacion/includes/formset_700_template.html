{% comment %}
Template 700 â€“ Nombres Relacionados
Estilo unificado con 852 / 856 / 650 / 655
Solo HTML (JS va despuÃ©s)
Orden vertical limpio
{% endcomment %}

<div class="formset-container" data-formset-prefix="{{ formset.prefix }}">

    <!-- Management form -->
    <div style="display:none;">
        {% for hidden in formset.management_form %}
        {{ hidden }}
        {% endfor %}
    </div>

    <div class="formset-forms">

        {% for form in formset %}
        <div class="formset-row {% if form.instance.pk %}existing-form{% endif %} mb-3">

            {% for hidden in form.hidden_fields %}
            {{ hidden }}
            {% endfor %}

            {% if formset.can_delete %}
            <div class="d-none">
                {{ form.DELETE }}
            </div>
            {% endif %}

            <!-- âŒ eliminar fila 700 -->
            <button type="button" class="delete-row-btn" title="Eliminar nombre relacionado">
                <i class="bi bi-x-lg"></i>
            </button>

            <div class="campo-grid">

                <!-- 700 $a â€“ Nombre de persona -->
                <div class="col-full">
                    {{ form.persona }}
                    <label class="form-label small">700 $a â€“ Nombre de persona</label>
                    <div class="autocomplete-wrapper">
                        {{ form.persona_texto }}
                        <div class="autocomplete-suggestions persona700-suggestions"></div>
                    </div>
                    <small class="form-text text-muted">
                        Escriba para buscar personas existentes o crear una nueva.
                    </small>
                </div>
                <!-- 700 $d â€“ Coordenadas biogrÃ¡ficas -->
                <div class="col-full">
                    <label class="form-label small">700 $d â€“ Coordenadas biogrÃ¡ficas</label>
                    {{ form.persona_coordenadas }}
                </div>

                <!-- 700 $c â€“ TÃ©rmino asociado -->
                <div class="col-full">
                    <label class="form-label small">700 $c â€“ TÃ©rmino asociado</label>
                    <div class="subcampo-repetible-container terminos-container"
                        data-terminos-container="{{ forloop.counter0 }}">

                        {% if form.instance.pk %}
                        {% for termino in form.instance.terminos_asociados.all %}
                        <div class="subcampo-row termino-form-row">
                            {% if forloop.first %}
                            <button type="button" class="subcampo-add-btn add-termino-btn"
                                data-nombre-index="{{ forloop.parentloop.counter0 }}">
                                <i class="bi bi-plus"></i>
                            </button>
                            {% else %}
                            <div class="subcampo-placeholder"></div>
                            {% endif %}

                            <input type="text" class="form-control termino-input"
                                name="termino_asociado_700_{{ forloop.parentloop.counter0 }}_{{ termino.pk }}"
                                value="{{ termino.termino }}" placeholder="Dr., Lic., etc.">

                            <button type="button" class="subcampo-delete-btn delete-termino-btn" {% if forloop.first and forloop.last %}style="visibility:hidden;" {% endif %}>
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="subcampo-row termino-form-row">
                            <button type="button" class="subcampo-add-btn add-termino-btn"
                                data-nombre-index="{{ forloop.counter0 }}">
                                <i class="bi bi-plus"></i>
                            </button>
                            <input type="text" class="form-control termino-input"
                                name="termino_asociado_700_{{ forloop.counter0 }}_0" placeholder="Dr., Lic., etc.">
                            <button type="button" class="subcampo-delete-btn delete-termino-btn"
                                style="visibility:hidden;">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>

                

                <!-- 700 $e â€“ FunciÃ³n (NO repetible visualmente) -->
                <div class="col-full">
                    <label class="form-label small">700 $e â€“ FunciÃ³n</label>
                    <select class="form-select funcion-select" name="funcion_700_{{ forloop.counter0 }}_0">
                        {% for value, label in form.autoria.field.choices %}
                            <option value="{{ value }}" {% if form.instance.pk and form.instance.funciones.first.funcion == value %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- 700 $i â€“ RelaciÃ³n -->
                <div class="col-full">
                    <label class="form-label small">700 $i â€“ RelaciÃ³n</label>
                    {{ form.relacion }}
                </div>

                <!-- 700 $j â€“ AutorÃ­a -->
                <div class="col-full">
                    <label class="form-label small">700 $j â€“ AutorÃ­a</label>
                    {{ form.autoria }}
                </div>

                <!-- 700 $t â€“ TÃ­tulo de la obra -->
                <div class="col-full">
                    <label class="form-label small">700 $t â€“ TÃ­tulo de la obra</label>
                    <div class="autocomplete-wrapper">
                        {{ form.titulo_obra }}
                        <div class="autocomplete-suggestions titulo700-suggestions"></div>
                    </div>
                </div>

            </div>

        </div>
        {% endfor %}

        <!-- EMPTY FORM -->
        <div class="formset-row empty-form mb-3" style="display:none;">
            <button type="button" class="delete-row-btn" title="Eliminar nombre relacionado">
                <i class="bi bi-x-lg"></i>
            </button>

            <div class="campo-grid">

                <div class="col-full">
                    {{ formset.empty_form.persona }}
                    <label class="form-label small">700 $a â€“ Nombre de persona</label>
                    <div class="autocomplete-wrapper">
                        {{ formset.empty_form.persona_texto }}
                        <div class="autocomplete-suggestions persona700-suggestions"></div>
                    </div>
                </div>

                <div class="col-full">
                    <label class="form-label small">700 $d â€“ Coordenadas biogrÃ¡ficas</label>
                    {{ formset.empty_form.persona_coordenadas }}
                </div>

                <div class="col-full">
                    <label class="form-label small">700 $t â€“ TÃ­tulo de la obra</label>
                    <div class="autocomplete-wrapper">
                        {{ formset.empty_form.titulo_obra }}
                        <div class="autocomplete-suggestions titulo700-suggestions"></div>
                    </div>
                </div>

                <div class="col-full">
                    <label class="form-label small">700 $i â€“ RelaciÃ³n</label>
                    {{ formset.empty_form.relacion }}
                </div>

                <div class="col-full">
                    <label class="form-label small">700 $j â€“ AutorÃ­a</label>
                    {{ formset.empty_form.autoria }}
                </div>

                <!-- $c -->
                <div class="col-full">
                    <label class="form-label small">700 $c â€“ TÃ©rmino asociado</label>
                    <div class="subcampo-repetible-container terminos-container" data-terminos-container="__prefix__">
                        <div class="subcampo-row termino-form-row">
                            <button type="button" class="subcampo-add-btn add-termino-btn"
                                data-nombre-index="__prefix__">
                                <i class="bi bi-plus"></i>
                            </button>
                            <input type="text" class="form-control termino-input"
                                name="termino_asociado_700___prefix___0" placeholder="Dr., Lic., etc.">
                            <button type="button" class="subcampo-delete-btn delete-termino-btn"
                                style="visibility:hidden;">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- $e -->
                <div class="col-full">
                    <label class="form-label small">700 $e â€“ FunciÃ³n</label>
                    <div class="subcampo-repetible-container funciones-container" data-funciones-container="__prefix__">
                        <div class="subcampo-row funcion-form-row">
                            <button type="button" class="subcampo-add-btn add-funcion-btn"
                                data-nombre-index="__prefix__">
                                <i class="bi bi-plus"></i>
                            </button>
                            <select class="form-select funcion-select" name="funcion_700___prefix___0">
                                {% for value, label in formset.empty_form.fields.autoria.choices %}
                                <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" class="subcampo-delete-btn delete-funcion-btn"
                                style="visibility:hidden;">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>
</div>


<script>
    (function () {

        const prefix = "{{ formset.prefix }}";
        const root = document.querySelector(`[data-formset-prefix="${prefix}"]`);
        if (!root) return;

        const terminoTemplate = document.querySelector('.termino-template-700');
        const funcionTemplate = document.querySelector('.funcion-template-700');

        /* ======================================================
           AUTOCOMPLETE PERSONA 700 $a
           ====================================================== */
        function initPersonaAutocomplete(row) {
            if (row.dataset.persona700Init === "1") return;
            row.dataset.persona700Init = "1";

            const input = row.querySelector('input[name$="persona_texto"]');
            const hidden = row.querySelector('input[name$="persona"]');
            const coord = row.querySelector('input[name$="persona_coordenadas"]');
            const box = row.querySelector('.persona700-suggestions');

            if (!input || !hidden || !box) return;

            let timer = null;
            let selectedIndex = -1;

            function hide() {
                box.classList.remove("show");
                box.innerHTML = "";
                selectedIndex = -1;
            }

            function selectPersona(p) {
                input.value = p.text;
                hidden.value = p.id || "";
                if (coord) coord.value = p.coordenadas || "";
                hide();
            }

            function render(list, query) {
                box.innerHTML = "";
                selectedIndex = -1;

                if (!list.length) {
                    const nuevo = document.createElement("div");
                    nuevo.className = "autocomplete-item autocomplete-item-new";
                    nuevo.innerHTML = `<i class="bi bi-plus-circle me-2"></i> Crear: "${query}"`;
                    nuevo.onclick = () => selectPersona({ text: query, id: "", coordenadas: "" });
                    box.appendChild(nuevo);
                } else {
                    list.forEach(p => {
                        const d = document.createElement("div");
                        d.className = "autocomplete-item";
                        d.innerHTML = `<strong>${p.apellidos_nombres}</strong>`;
                        d.onclick = () => selectPersona({
                            text: p.apellidos_nombres,
                            id: p.id,
                            coordenadas: p.coordenadas_biograficas || ""
                        });
                        box.appendChild(d);
                    });

                    const nuevo = document.createElement("div");
                    nuevo.className = "autocomplete-item autocomplete-item-new";
                    nuevo.innerHTML = `<i class="bi bi-plus-circle me-2"></i> Crear: "${query}"`;
                    nuevo.onclick = () => selectPersona({ text: query, id: "", coordenadas: "" });
                    box.appendChild(nuevo);
                }

                box.classList.add("show");
            }

            function search(q) {
                fetch(`/catalogacion/api/autocompletar/persona/?q=${encodeURIComponent(q)}`)
                    .then(r => r.json())
                    .then(data => render(data.results || [], q))
                    .catch(() => hide());
            }

            input.addEventListener("input", () => {
                const q = input.value.trim();
                hidden.value = "";
                if (q.length < 2) return hide();
                clearTimeout(timer);
                timer = setTimeout(() => search(q), 300);
            });

            document.addEventListener("click", e => {
                if (!row.contains(e.target)) hide();
            });
        }

        /* ======================================================
           REINDEXAR FORMSET 700
           ====================================================== */
        function reindex700() {
            const rows = root.querySelectorAll(".formset-row:not(.empty-form)");
            const totalInput = root.querySelector(`[name="${prefix}-TOTAL_FORMS"]`);

            rows.forEach((row, index) => {
                row.querySelectorAll("[name], [id], label[for]").forEach(el => {
                    ["name", "id", "for"].forEach(attr => {
                        const val = el.getAttribute(attr);
                        if (!val) return;

                        el.setAttribute(
                            attr,
                            val.replace(/-\d+-/, `-${index}-`)
                                .replace(/__prefix__/, index)
                        );
                    });
                });

                row.querySelectorAll("[data-nombre-index]").forEach(btn =>
                    btn.dataset.nombreIndex = index
                );

                row.querySelector("[data-terminos-container]")
                    ?.setAttribute("data-terminos-container", index);
                row.querySelector("[data-funciones-container]")
                    ?.setAttribute("data-funciones-container", index);

                initPersonaAutocomplete(row);
            });

            if (totalInput) totalInput.value = rows.length;
        }

        /* ======================================================
           AGREGAR FILA 700 (FUNCIÃ“N ÃšNICA)
           ====================================================== */
        function add700Row() {
            const empty = root.querySelector(".empty-form");
            const forms = root.querySelector(".formset-forms");
            const totalInput = root.querySelector(`[name="${prefix}-TOTAL_FORMS"]`);

            if (!empty || !forms || !totalInput) return;

            const index = parseInt(totalInput.value, 10) || 0;

            const clone = empty.cloneNode(true);
            clone.innerHTML = clone.innerHTML.replace(/__prefix__/g, index);
            clone.classList.remove("empty-form");
            clone.style.display = "";

            forms.appendChild(clone);
            totalInput.value = index + 1;

            initPersonaAutocomplete(clone);
            reindex700();
        }

        /* ======================================================
           SUBCAMPOS $c y $e
           ====================================================== */
        function createSubRow(type, index) {
            const row = document.createElement("div");
            row.className = "subcampo-row mt-2";

            if (type === "termino") {
                row.innerHTML = `
                <div class="subcampo-placeholder"></div>
                <input type="text" class="form-control termino-input"
                       name="termino_asociado_700_${index}_${Date.now()}"
                       placeholder="Dr., Lic., etc.">
                <button type="button" class="subcampo-delete-btn delete-termino-btn">
                    <i class="bi bi-x-lg"></i>
                </button>`;
            }

            if (type === "funcion") {
                row.innerHTML = `
                <div class="subcampo-placeholder"></div>
                <select class="form-select funcion-select"
                        name="funcion_700_${index}_${Date.now()}">
                    ${funcionTemplate.querySelector("select").innerHTML}
                </select>
                <button type="button" class="subcampo-delete-btn delete-funcion-btn">
                    <i class="bi bi-x-lg"></i>
                </button>`;
            }

            return row;
        }

        /* ======================================================
           EVENTOS
           ====================================================== */
        root.addEventListener("click", e => {

            // âž• fila 700 (botÃ³n header)
            if (e.target.closest(`.campo-add-btn[data-formset-target="${prefix}"]`)) {
                add700Row();
                return;
            }

            // âŒ eliminar fila 700
            const delRow = e.target.closest(".delete-row-btn");
            if (delRow) {
                const row = delRow.closest(".formset-row");
                if (!row || row.classList.contains("empty-form")) return;

                const delInput = row.querySelector('[name$="-DELETE"]');

                // ðŸ”’ fila existente â†’ marcar DELETE y ocultar
                if (delInput && row.classList.contains("existing-form")) {
                    delInput.checked = !delInput.checked;
                    row.style.display = delInput.checked ? "none" : "";
                    return;
                }

                // ðŸ†• fila nueva â†’ eliminar del DOM
                row.remove();
                reindex700();

                // ðŸ”’ asegurar que siempre quede una fila
                if (!root.querySelector(".formset-row:not(.empty-form)")) {
                    add700Row();
                }
                return;
            }


            // âž• tÃ©rmino $c
            const addTermino = e.target.closest(".add-termino-btn");
            if (addTermino) {
                const index = addTermino.dataset.nombreIndex;
                const cont = root.querySelector(`[data-terminos-container="${index}"]`);
                if (cont) cont.appendChild(createSubRow("termino", index));
                return;
            }

            // âž• funciÃ³n $e
            const addFuncion = e.target.closest(".add-funcion-btn");
            if (addFuncion) {
                const index = addFuncion.dataset.nombreIndex;
                const cont = root.querySelector(`[data-funciones-container="${index}"]`);
                if (cont) cont.appendChild(createSubRow("funcion", index));
                return;
            }

            // âŒ eliminar subcampo
            if (e.target.closest(".delete-termino-btn") ||
                e.target.closest(".delete-funcion-btn")) {
                e.target.closest(".subcampo-row")?.remove();
            }
        });

        /* ======================================================
           INIT
           ====================================================== */
        root.querySelectorAll(".formset-row:not(.empty-form)")
            .forEach(row => initPersonaAutocomplete(row));

        reindex700();

    })();
</script>