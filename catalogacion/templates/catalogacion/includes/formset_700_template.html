{% comment %}
Template 700 – Nombres Relacionados
Estilo unificado con 852 / 856 / 650 / 655
Solo HTML (JS va después)
Orden vertical limpio
{% endcomment %}

{% load catalogacion_tags %}
{% get_funciones_persona as funciones_opciones %}

<div class="formset-container" data-formset-prefix="{{ formset.prefix }}">

    <!-- Management form -->
    <div style="display:none;">
        {% for hidden in formset.management_form %}
        {{ hidden }}
        {% endfor %}
    </div>

    <div class="formset-forms">

        {% for form in formset %}
        <div class="formset-row {% if form.instance.pk %}existing-form{% endif %} mb-3">

            {% for hidden in form.hidden_fields %}
            {{ hidden }}
            {% endfor %}

            {% if formset.can_delete %}
            <div class="d-none">
                {{ form.DELETE }}
            </div>
            {% endif %}

            <!-- ❌ eliminar fila 700 -->
            <button type="button" class="delete-row-btn" title="Eliminar nombre relacionado">
                <i class="bi bi-x-lg"></i>
            </button>

            <div class="campo-grid">

                <!-- 700 $a – Nombre de persona -->
                <div class="col-full">
                    {{ form.persona }}
                    <label class="form-label small">700 $a – Nombre de persona</label>
                    <div class="autocomplete-wrapper">
                        {{ form.persona_texto }}
                        <div class="autocomplete-suggestions persona700-suggestions"></div>
                    </div>
                    <small class="form-text text-muted">
                        Escriba para buscar personas existentes o crear una nueva.
                    </small>
                </div>
                <!-- 700 $d – Coordenadas biográficas -->
                <div class="col-full">
                    <label class="form-label small">700 $d – Coordenadas biográficas</label>
                    {{ form.persona_coordenadas }}
                </div>

                <!-- 700 $c – Término asociado -->
                <div class="col-full">
                    <label class="form-label small">700 $c – Término asociado</label>
                    <div class="subcampo-repetible-container terminos-container"
                        data-terminos-container="{{ forloop.counter0 }}">

                        {% if form.instance.pk %}
                        {% for termino in form.instance.terminos_asociados.all %}
                        <div class="subcampo-row termino-form-row">
                            {% if forloop.first %}
                            <button type="button" class="subcampo-add-btn add-termino-btn"
                                data-nombre-index="{{ forloop.parentloop.counter0 }}">
                                <i class="bi bi-plus"></i>
                            </button>
                            {% else %}
                            <div class="subcampo-placeholder"></div>
                            {% endif %}

                            <input type="text" class="form-control termino-input"
                                name="termino_asociado_700_{{ forloop.parentloop.counter0 }}_{{ termino.pk }}"
                                value="{{ termino.termino }}" placeholder="Dr., Lic., etc.">

                            <button type="button" class="subcampo-delete-btn delete-termino-btn" {% if forloop.first and forloop.last %}style="visibility:hidden;" {% endif %}>
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="subcampo-row termino-form-row">
                            <button type="button" class="subcampo-add-btn add-termino-btn"
                                data-nombre-index="{{ forloop.counter0 }}">
                                <i class="bi bi-plus"></i>
                            </button>
                            <input type="text" class="form-control termino-input"
                                name="termino_asociado_700_{{ forloop.counter0 }}_0" placeholder="Dr., Lic., etc.">
                            <button type="button" class="subcampo-delete-btn delete-termino-btn"
                                style="visibility:hidden;">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>

                

                <!-- 700 $e – Función (REPETIBLE, INLINE FORMSET) -->
                <div class="col-full">
                    <label class="form-label small">700 $e – Función</label>

                    <div class="subcampo-repetible-container funciones-container">

                        {{ form.funcion700_formset.management_form }}

                        {% for fform in form.funcion700_formset %}
                        <div class="subcampo-row funcion-form-row">

                            {% if forloop.first %}
                            <button type="button"
                                    class="subcampo-add-btn add-funcion-btn"
                                    data-nombre-index="{{ forloop.parentloop.counter0 }}">
                                <i class="bi bi-plus"></i>
                            </button>
                            {% else %}
                            <div class="subcampo-placeholder"></div>
                            {% endif %}

                            {{ fform.funcion }}

                            {% if form.funcion700_formset.can_delete %}
                                <div class="d-none">
                                    {{ fform.DELETE }}
                                </div>
                                <button type="button"
                                        class="subcampo-delete-btn delete-funcion-btn"
                                        {% if forloop.first and forloop.last %}style="visibility:hidden"{% endif %}>
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            {% endif %}
                        </div>
                        {% endfor %}

                    </div>
                </div>


                <!-- 700 $i – Relación -->
                <div class="col-full">
                    <label class="form-label small">700 $i – Relación</label>
                    {{ form.relacion }}
                </div>

                <!-- 700 $j – Autoría -->
                <div class="col-full">
                    <label class="form-label small">700 $j – Autoría</label>
                    {{ form.autoria }}
                </div>

                <!-- 700 $t – Título de la obra -->
                <div class="col-full">
                    <label class="form-label small">700 $t – Título de la obra</label>
                    <div class="autocomplete-wrapper">
                        {{ form.titulo_obra }}
                        <div class="autocomplete-suggestions titulo700-suggestions"></div>
                    </div>
                </div>

            </div>

        </div>
        {% endfor %}

        <!-- EMPTY FORM -->
        <div class="formset-row empty-form mb-3" style="display:none;">
            <button type="button" class="delete-row-btn" title="Eliminar nombre relacionado">
                <i class="bi bi-x-lg"></i>
            </button>

            <div class="campo-grid">

                <div class="col-full">
                    {{ formset.empty_form.persona }}
                    <label class="form-label small">700 $a – Nombre de persona</label>
                    <div class="autocomplete-wrapper">
                        {{ formset.empty_form.persona_texto }}
                        <div class="autocomplete-suggestions persona700-suggestions"></div>
                    </div>
                </div>

                <div class="col-full">
                    <label class="form-label small">700 $d – Coordenadas biográficas</label>
                    {{ formset.empty_form.persona_coordenadas }}
                </div>

                

                <!-- $c -->
                <div class="col-full">
                    <label class="form-label small">700 $c – Término asociado</label>
                    <div class="subcampo-repetible-container terminos-container" data-terminos-container="__prefix__">
                        <div class="subcampo-row termino-form-row">
                            <button type="button" class="subcampo-add-btn add-termino-btn"
                                data-nombre-index="__prefix__">
                                <i class="bi bi-plus"></i>
                            </button>
                            <input type="text" class="form-control termino-input"
                                name="termino_asociado_700___prefix___0" placeholder="Dr., Lic., etc.">
                            <button type="button" class="subcampo-delete-btn delete-termino-btn"
                                style="visibility:hidden;">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Plantilla oculta para una nueva fila de $e (no tiene el botón +) -->
                <div class="subcampo-row funcion-form-row funcion-template-700 d-none">
                    <div class="subcampo-placeholder"></div>
                    <select class="form-select funcion-select" name="">
                        <option value="">Seleccione una función...</option>
                        {% for codigo, nombre in funciones_opciones %}
                        <option value="{{ codigo }}">{{ nombre }}</option>
                        {% endfor %}
                    </select>
                    <button type="button" class="subcampo-delete-btn delete-funcion-btn" style="visibility: visible;">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>

                <!-- $e -->
                <div class="col-full">
                    <label class="form-label small">700 $e – Función</label>

                    <div class="subcampo-repetible-container funciones-container" data-funciones-container="__prefix__">

                        {% if formset.empty_form.funcion700_formset %}
                            {{ formset.empty_form.funcion700_formset.management_form }}

                            {% for fform in formset.empty_form.funcion700_formset %}
                                <div class="subcampo-row funcion-form-row">
                                    {% if forloop.first %}
                                        <button type="button" class="subcampo-add-btn add-funcion-btn" data-nombre-index="__prefix__">
                                            <i class="bi bi-plus"></i>
                                        </button>
                                    {% else %}
                                        <div class="subcampo-placeholder"></div>
                                    {% endif %}

                                    {{ fform.funcion }}

                                    {% if formset.empty_form.funcion700_formset.can_delete %}
                                        <div class="d-none">{{ fform.DELETE }}</div>
                                        <button type="button" class="subcampo-delete-btn delete-funcion-btn" style="visibility:hidden;">
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                    {% endif %}
                                </div>
                            {% empty %}
                                <div class="subcampo-row funcion-form-row">
                                    <button type="button" class="subcampo-add-btn add-funcion-btn" data-nombre-index="__prefix__">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                    {{ formset.empty_form.funcion700_formset.empty_form.funcion }}
                                    <button type="button" class="subcampo-delete-btn delete-funcion-btn" style="visibility:hidden;">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="subcampo-row funcion-form-row">
                                <button type="button" class="subcampo-add-btn add-funcion-btn" data-nombre-index="__prefix__">
                                    <i class="bi bi-plus"></i>
                                </button>
                                <select class="form-select funcion-select" name="funcion_700___prefix___0">
                                    <option value="">Seleccione una función...</option>
                                    {% for codigo, nombre in funciones_opciones %}
                                    <option value="{{ codigo }}">{{ nombre }}</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="subcampo-delete-btn delete-funcion-btn" style="visibility:hidden;">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        {% endif %}

                    </div>
                </div>

                <div class="col-full">
                    <label class="form-label small">700 $i – Relación</label>
                    {{ formset.empty_form.relacion }}
                </div>

                <div class="col-full">
                    <label class="form-label small">700 $j – Autoría</label>
                    {{ formset.empty_form.autoria }}
                </div>

                <div class="col-full">
                    <label class="form-label small">700 $t – Título de la obra</label>
                    <div class="autocomplete-wrapper">
                        {{ formset.empty_form.titulo_obra }}
                        <div class="autocomplete-suggestions titulo700-suggestions"></div>
                    </div>
                </div>

            </div>
        </div>

    </div>
</div>


<script>
(function () {

    const prefix = "{{ formset.prefix }}";
    const root = document.querySelector(`[data-formset-prefix="${prefix}"]`);
    if (!root) return;

    /* ======================================================
       AUTOCOMPLETE PERSONA 700 $a (SIN CAMBIOS)
       ====================================================== */
    function initPersonaAutocomplete(row) {
        if (row.dataset.persona700Init === "1") return;
        row.dataset.persona700Init = "1";

        const input = row.querySelector('input[name$="persona_texto"]');
        const hidden = row.querySelector('input[name$="persona"]');
        const coord = row.querySelector('input[name$="persona_coordenadas"]');
        const box = row.querySelector('.persona700-suggestions');

        if (!input || !hidden || !box) return;

        let timer = null;

        function hide() {
            box.classList.remove("show");
            box.innerHTML = "";
        }

        function selectPersona(p) {
            input.value = p.text;
            hidden.value = p.id || "";
            if (coord) coord.value = p.coordenadas || "";
            hide();
        }

        function render(list, query) {
            box.innerHTML = "";

            list.forEach(p => {
                const d = document.createElement("div");
                d.className = "autocomplete-item";
                d.innerHTML = `<strong>${p.apellidos_nombres}</strong>`;
                d.onclick = () => selectPersona({
                    text: p.apellidos_nombres,
                    id: p.id,
                    coordenadas: p.coordenadas_biograficas || ""
                });
                box.appendChild(d);
            });

            const nuevo = document.createElement("div");
            nuevo.className = "autocomplete-item autocomplete-item-new";
            nuevo.innerHTML = `<i class="bi bi-plus-circle me-2"></i> Crear: "${query}"`;
            nuevo.onclick = () => selectPersona({ text: query, id: "" });
            box.appendChild(nuevo);

            box.classList.add("show");
        }

        function search(q) {
            fetch(`/catalogacion/api/autocompletar/persona/?q=${encodeURIComponent(q)}`)
                .then(r => r.json())
                .then(data => render(data.results || [], q))
                .catch(() => hide());
        }

        input.addEventListener("input", () => {
            const q = input.value.trim();
            hidden.value = "";
            if (q.length < 2) return hide();
            clearTimeout(timer);
            timer = setTimeout(() => search(q), 300);
        });

        document.addEventListener("click", e => {
            if (!row.contains(e.target)) hide();
        });
    }

    /* ======================================================
       REINDEXAR FORMSET 700 (SIN CAMBIOS)
       ====================================================== */
    function reindex700() {
        const rows = root.querySelectorAll(".formset-row:not(.empty-form)");
        const totalInput = root.querySelector(`[name="${prefix}-TOTAL_FORMS"]`);

        rows.forEach((row, index) => {
            row.querySelectorAll("[name], [id], label[for]").forEach(el => {
                ["name", "id", "for"].forEach(attr => {
                    const val = el.getAttribute(attr);
                    if (!val) return;
                    el.setAttribute(
                        attr,
                        val.replace(/-\d+-/, `-${index}-`)
                           .replace(/__prefix__/g, index)
                    );
                });
            });

            row.querySelectorAll("[data-nombre-index]").forEach(btn =>
                btn.dataset.nombreIndex = index
            );

            initPersonaAutocomplete(row);
        });

        if (totalInput) totalInput.value = rows.length;
    }

    /* ======================================================
       EVENTOS
       ====================================================== */
    root.addEventListener("click", e => {

        /* ==========================================
           ➕ 700 $c – término asociado (SIN CAMBIOS)
           ========================================== */
        const addTermino = e.target.closest(".add-termino-btn");
        if (addTermino) {
            const index = addTermino.dataset.nombreIndex;
            const cont = root.querySelector(`[data-terminos-container="${index}"]`);
            if (!cont) return;

            const row = document.createElement("div");
            row.className = "subcampo-row mt-2";
            row.innerHTML = `
                <div class="subcampo-placeholder"></div>
                <input type="text" class="form-control termino-input"
                       name="termino_asociado_700_${index}_${Date.now()}"
                       placeholder="Dr., Lic., etc.">
                <button type="button" class="subcampo-delete-btn delete-termino-btn">
                    <i class="bi bi-x-lg"></i>
                </button>`;
            cont.appendChild(row);
            return;
        }

        /* ==========================================
           ➕ 700 $e – FUNCIÓN (INLINE FORMSET CORRECTO)
           ========================================== */
        const addFuncion = e.target.closest('.add-funcion-btn');
        if (addFuncion) {
            const container = addFuncion.closest('.funciones-container');
            const template = root.querySelector('.funcion-template-700');
            if (!container || !template) return;

            // management form del inline formset (ej: name="funcion700-...-TOTAL_FORMS")
            const management = container.querySelector('input[name$="-TOTAL_FORMS"]');
            if (!management) return;

            const baseName = management.name.replace(/-TOTAL_FORMS$/, '');
            const newIndex = parseInt(management.value, 10) || 0;

            const nuevo = template.cloneNode(true);
            nuevo.classList.remove('d-none', 'funcion-template-700');

            const select = nuevo.querySelector('.funcion-select');
            if (select) {
                select.name = `${baseName}-${newIndex}-funcion`;
                select.selectedIndex = 0;
            }

            const delBtn = nuevo.querySelector('.delete-funcion-btn');
            if (delBtn) delBtn.style.visibility = 'visible';

            container.appendChild(nuevo);

            // Re-inicializar Select2 en el nuevo select si aplica
            if (typeof $ !== 'undefined' && $.fn && typeof $.fn.select2 === 'function') {
                const sel = nuevo.querySelector('select');
                if (sel && !$(sel).hasClass('select2-hidden-accessible')) {
                    $(sel).select2({ theme: 'bootstrap-5', width: '100%' });
                }
            }

            // incrementar TOTAL_FORMS
            management.value = newIndex + 1;
            return;
        }

        /* ==========================================
           ❌ eliminar subcampo $c o $e
           ========================================== */
        const delBtn = e.target.closest(".delete-termino-btn, .delete-funcion-btn");
        if (delBtn) {
            const row = delBtn.closest(".subcampo-row, .funcion-form-row");
            if (!row) return;

            const delInput = row.querySelector('input[type="checkbox"]');
            if (delInput) {
                delInput.checked = true;
                row.style.display = "none";
            } else {
                row.remove();
            }
        }
    });

    // Cuando se agrega desde el gestor global (formset-manager.js), reindexar e inicializar
    root.addEventListener('formset:added', (ev) => {
        if (!ev || !ev.detail || ev.detail.prefix !== prefix) return;
        // small timeout to let DOM settle
        setTimeout(() => {
            reindex700();
            root.querySelectorAll('.formset-row:not(.empty-form)').forEach(row => initPersonaAutocomplete(row));
        }, 20);
    });

    /* ======================================================
       INIT
       ====================================================== */
    root.querySelectorAll(".formset-row:not(.empty-form)")
        .forEach(row => initPersonaAutocomplete(row));

    reindex700();

})();
</script>
