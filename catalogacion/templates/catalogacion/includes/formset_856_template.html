{% comment %}
Template para campo 856 - Recursos Disponibles
El campo 856 es repetible y contiene subcampos repetibles ($u URL y $y texto enlace)
{% endcomment %}

<div class="formset-container" data-formset-prefix="{{ formset.prefix }}">
    {# Renderizar management_form sin mensajes de error #}
    <div style="display: none;">
        {% for field in formset.management_form %}
            {{ field }}
        {% endfor %}
    </div>
    
    
    
    <div class="formset-forms">
        {% for form in formset %}
        <div class="formset-row {% if form.instance.pk %}existing-form{% endif %} mb-3">
            {% if form.instance.pk %}
                <input type="hidden" name="{{ form.prefix }}-id" value="{{ form.instance.pk }}">
            {% endif %}
            
            {% if formset.can_delete %}
                <div class="d-none">
                    {{ form.DELETE }}
                </div>
            {% endif %}
            
            <button type="button" class="delete-row-btn" title="Eliminar">
                <i class="bi bi-x-lg"></i>
            </button>
            
            <div class="campo-grid">
                {# BotÃ³n para agregar URLs ($u) #}
                <div class="col-full">
                    <button type="button" class="btn btn-sm btn-outline-primary add-url-btn w-100" data-disponible-index="{{ forloop.counter0 }}">
                        <i class="bi bi-plus-circle"></i>
                        Agregar URL ($u)
                    </button>
                </div>
                
                {# Subcampo $u - URLs (Repetible) #}
                <div class="col-full urls-container" data-urls-container="{{ forloop.counter0 }}">
                    {% if form.instance.pk %}
                        {# Cargar URLs existentes #}
                        {% for url in form.instance.urls_856.all %}
                        <div class="url-form-row">
                            <div class="d-flex flex-column w-100 mb-2">
                                <label class="form-label small">856 $u - URL</label>
                                <div class="d-flex gap-2 align-items-center">
                                    <input type="url" 
                                           class="form-control url-input" 
                                           name="url_disponible_856_{{ forloop.parentloop.counter0 }}_{{ url.pk }}"
                                           value="{{ url.url }}"
                                           placeholder="https://ejemplo.com/recurso" 
                                           style="flex: 1;">
                                    <button type="button" class="btn btn-sm btn-outline-danger delete-url-btn" title="Eliminar URL">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
                
                {# BotÃ³n para agregar textos de enlace ($y) #}
                <div class="col-full">
                    <button type="button" class="btn btn-sm btn-outline-primary add-texto-btn w-100" data-disponible-index="{{ forloop.counter0 }}">
                        <i class="bi bi-plus-circle"></i>
                        Agregar Texto de Enlace ($y)
                    </button>
                </div>
                
                {# Subcampo $y - Textos de enlace (Repetible) #}
                <div class="col-full textos-container" data-textos-container="{{ forloop.counter0 }}">
                    {% if form.instance.pk %}
                        {# Cargar textos existentes #}
                        {% for texto in form.instance.textos_enlace_856.all %}
                        <div class="texto-form-row">
                            <div class="d-flex flex-column w-100 mb-2">
                                <label class="form-label small">856 $y - Texto del enlace</label>
                                <div class="d-flex gap-2 align-items-center">
                                    <input type="text" 
                                           class="form-control texto-input" 
                                           name="texto_disponible_856_{{ forloop.parentloop.counter0 }}_{{ texto.pk }}"
                                           value="{{ texto.texto_enlace }}"
                                           placeholder="Texto descriptivo del enlace" 
                                           style="flex: 1;">
                                    <button type="button" class="btn btn-sm btn-outline-danger delete-texto-btn" title="Eliminar texto">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
        
        {# Template vacÃ­o para clonar recursos disponibles #}
        <div class="formset-row empty-form mb-3">
            <button type="button" class="delete-row-btn" title="Eliminar">
                <i class="bi bi-x-lg"></i>
            </button>
            
            <div class="campo-grid">
                <div class="col-full">
                    <button type="button" class="btn btn-sm btn-outline-primary add-url-btn w-100" data-disponible-index="__prefix__">
                                <i class="bi bi-plus-circle"></i>
                                Agregar URL ($u)
                            </button>
                    </button>
                </div>
                
                <div class="col-full urls-container" data-urls-container="__prefix__">
                    {# Las URLs se agregarÃ¡n aquÃ­ dinÃ¡micamente #}
                </div>
                
                <div class="col-full">
                    <button type="button" class="btn btn-sm btn-outline-primary add-texto-btn w-100" data-disponible-index="__prefix__">
                        <i class="bi bi-plus-circle"></i>
                        Agregar Texto de Enlace ($y)
                    </button>
                </div>
                
                <div class="col-full textos-container" data-textos-container="__prefix__">
                    {# Los textos se agregarÃ¡n aquÃ­ dinÃ¡micamente #}
                </div>
            </div>
        </div>
    </div>
</div>

{# Templates globales para URLs y textos (fuera del formset loop) #}
<div class="url-form-row url-template-856 d-none">
    <div class="d-flex flex-column w-100 mb-2">
        <label class="form-label small">856 $u - URL</label>
        <div class="d-flex gap-2 align-items-center">
            <input type="url" class="form-control url-input" placeholder="https://ejemplo.com/recurso" style="flex: 1;">
            <button type="button" class="btn btn-sm btn-outline-danger delete-url-btn" title="Eliminar URL">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    </div>
</div>

<div class="texto-form-row texto-template-856 d-none">
    <div class="d-flex flex-column w-100 mb-2">
        <label class="form-label small">856 $y - Texto del enlace</label>
        <div class="d-flex gap-2 align-items-center">
            <input type="text" class="form-control texto-input" placeholder="Texto descriptivo del enlace" style="flex: 1;">
            <button type="button" class="btn btn-sm btn-outline-danger delete-texto-btn" title="Eliminar texto">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    </div>
</div>

<script>
(function() {
    const container = document.querySelector(`[data-formset-prefix="{{ formset.prefix }}"]`);
    if (!container) return;

    const totalFormsInput = container.querySelector(`#id_{{ formset.prefix }}-TOTAL_FORMS`);
    const addButton = container.querySelector(`[data-formset-target="{{ formset.prefix }}"]`);
    const formsContainer = container.querySelector('.formset-forms');

    if (!totalFormsInput || !addButton || !formsContainer) return;

    const urlTemplate = document.querySelector('.url-template-856');
    const textoTemplate = document.querySelector('.texto-template-856');

    // âž• Agregar Recurso ElectrÃ³nico (nuevo 856)
    addButton.addEventListener('click', () => {
        const total = parseInt(totalFormsInput.value);
        const template = formsContainer.querySelector('.empty-form');

        if (!template) return;

        const newForm = template.cloneNode(true);
        newForm.innerHTML = newForm.innerHTML.replace(/__prefix__/g, total);
        newForm.classList.remove('empty-form');
        newForm.style.display = '';

        formsContainer.insertBefore(newForm, template);
        totalFormsInput.value = total + 1;
    });

    // ðŸ—‘ Manejo de eliminaciones
    container.addEventListener('click', function(e) {
        const deleteBtn = e.target.closest('.delete-row-btn');
        if (deleteBtn) {
            const row = deleteBtn.closest('.formset-row');
            if (!row || row.classList.contains('empty-form')) return;

            const deleteInput = row.querySelector('[name$="-DELETE"]');
            if (deleteInput) {
                deleteInput.checked = !deleteInput.checked;
                row.style.opacity = deleteInput.checked ? "0.5" : "1";
            } else {
                row.remove();
                totalFormsInput.value = Math.max(0, parseInt(totalFormsInput.value) - 1);
            }
            return;
        }

        // âž• Agregar URL $u
        if (e.target.closest('.add-url-btn')) {
            const index = e.target.closest('.add-url-btn').dataset.disponibleIndex;
            const target = container.querySelector(`[data-urls-container="${index}"]`);

            if (target && urlTemplate) {
                const clone = urlTemplate.cloneNode(true);
                clone.classList.remove('url-template-856', 'd-none');

                const input = clone.querySelector('.url-input');
                if (input) input.name = `url_856_${index}_${Date.now()}`;

                target.appendChild(clone);
            }
            return;
        }

        // ðŸ—‘ Eliminar URL
        if (e.target.closest('.delete-url-btn')) {
            const urlRow = e.target.closest('.url-form-row');
            if (!urlRow.classList.contains('url-template-856')) urlRow.remove();
            return;
        }

        // âž• Agregar Texto enlace $y
        if (e.target.closest('.add-texto-btn')) {
            const index = e.target.closest('.add-texto-btn').dataset.disponibleIndex;
            const target = container.querySelector(`[data-textos-container="${index}"]`);

            if (target && textoTemplate) {
                const clone = textoTemplate.cloneNode(true);
                clone.classList.remove('texto-template-856', 'd-none');

                const input = clone.querySelector('.texto-input');
                if (input) input.name = `texto_856_${index}_${Date.now()}`;

                target.appendChild(clone);
            }
            return;
        }

        // ðŸ—‘ Eliminar Texto
        if (e.target.closest('.delete-texto-btn')) {
            const textoRow = e.target.closest('.texto-form-row');
            if (!textoRow.classList.contains('texto-template-856')) textoRow.remove();
        }
    });
})();
</script>
