{% comment %}
Template para campo 856 - Recursos Electrónicos
Subcampos repetibles:
 - 856 $u → URL
 - 856 $y → Texto del enlace

Estilo similar al 264: botón + a la izquierda, eliminar a la derecha.
{% endcomment %}

<div class="formset-container" data-formset-prefix="{{ formset.prefix }}">
    <div style="display:none;">
        {% for hidden in formset.management_form %}
            {{ hidden }}
        {% endfor %}
    </div>

    <div class="formset-forms">
        {% for form in formset %}
        <div class="formset-row {% if form.instance.pk %}existing-form{% endif %} mb-3">

            {% for hidden in form.hidden_fields %}
                {{ hidden }}
            {% endfor %}

            {% if formset.can_delete %}
            <div class="d-none">
                {{ form.DELETE }}
            </div>
            {% endif %}

            <!-- Botón eliminar bloque 856 -->
            <button type="button" class="delete-row-btn" title="Eliminar recurso 856">
                <i class="bi bi-x-lg"></i>
            </button>

            <div class="campo-grid">
                {# 856 $u – URLs (repetible) #}
                <div class="col-full">
                    <label class="form-label small">856 $u – URL</label>
                    <div class="subcampo-repetible-container urls-container"
                         data-urls-container="{{ forloop.counter0 }}">

                        {% if form.instance.pk %}
                            {% for url in form.instance.urls_856.all %}
                            <div class="subcampo-row url-form-row">
                                {% if forloop.first %}
                                <button type="button"
                                        class="subcampo-add-btn add-url-btn"
                                        data-recurso-index="{{ forloop.parentloop.counter0 }}"
                                        title="Agregar URL">
                                    <i class="bi bi-plus"></i>
                                </button>
                                {% else %}
                                <div class="subcampo-placeholder"></div>
                                {% endif %}

                                <input type="url"
                                       class="form-control url-input"
                                       name="url_disponible_856_{{ forloop.parentloop.counter0 }}_{{ url.pk }}"
                                       value="{{ url.url }}"
                                       placeholder="https://ejemplo.com/recurso">

                                <button type="button"
                                        class="subcampo-delete-btn delete-url-btn"
                                        title="Eliminar"
                                        {% if forloop.first and forloop.last %}style="visibility:hidden;"{% endif %}>
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                            {% empty %}
                            <div class="subcampo-row url-form-row">
                                <button type="button"
                                        class="subcampo-add-btn add-url-btn"
                                        data-recurso-index="{{ forloop.parentloop.counter0 }}"
                                        title="Agregar URL">
                                    <i class="bi bi-plus"></i>
                                </button>
                                <input type="url"
                                       class="form-control url-input"
                                       name="url_disponible_856_{{ forloop.parentloop.counter0 }}_0"
                                       placeholder="https://ejemplo.com/recurso">
                                <button type="button"
                                        class="subcampo-delete-btn delete-url-btn"
                                        title="Eliminar"
                                        style="visibility:hidden;">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="subcampo-row url-form-row">
                                <button type="button"
                                        class="subcampo-add-btn add-url-btn"
                                        data-recurso-index="{{ forloop.counter0 }}"
                                        title="Agregar URL">
                                    <i class="bi bi-plus"></i>
                                </button>
                                <input type="url"
                                       class="form-control url-input"
                                       name="url_disponible_856_{{ forloop.counter0 }}_0"
                                       placeholder="https://ejemplo.com/recurso">
                                <button type="button"
                                        class="subcampo-delete-btn delete-url-btn"
                                        title="Eliminar"
                                        style="visibility:hidden;">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        {% endif %}
                    </div>
                </div>

                {# 856 $y – Textos de enlace (repetible) #}
                <div class="col-full">
                    <label class="form-label small">856 $y – Texto del enlace</label>
                    <div class="subcampo-repetible-container textos-container"
                         data-textos-container="{{ forloop.counter0 }}">

                        {% if form.instance.pk %}
                            {% for texto in form.instance.textos_enlace_856.all %}
                            <div class="subcampo-row texto-form-row">
                                {% if forloop.first %}
                                <button type="button"
                                        class="subcampo-add-btn add-texto-btn"
                                        data-recurso-index="{{ forloop.parentloop.counter0 }}"
                                        title="Agregar texto de enlace">
                                    <i class="bi bi-plus"></i>
                                </button>
                                {% else %}
                                <div class="subcampo-placeholder"></div>
                                {% endif %}

                                <input type="text"
                                       class="form-control texto-input"
                                       name="texto_disponible_856_{{ forloop.parentloop.counter0 }}_{{ texto.pk }}"
                                       value="{{ texto.texto_enlace }}"
                                       placeholder="Texto descriptivo del enlace">

                                <button type="button"
                                        class="subcampo-delete-btn delete-texto-btn"
                                        title="Eliminar"
                                        {% if forloop.first and forloop.last %}style="visibility:hidden;"{% endif %}>
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                            {% empty %}
                            <div class="subcampo-row texto-form-row">
                                <button type="button"
                                        class="subcampo-add-btn add-texto-btn"
                                        data-recurso-index="{{ forloop.parentloop.counter0 }}"
                                        title="Agregar texto de enlace">
                                    <i class="bi bi-plus"></i>
                                </button>
                                <input type="text"
                                       class="form-control texto-input"
                                       name="texto_disponible_856_{{ forloop.parentloop.counter0 }}_0"
                                       placeholder="Texto descriptivo del enlace">
                                <button type="button"
                                        class="subcampo-delete-btn delete-texto-btn"
                                        title="Eliminar"
                                        style="visibility:hidden;">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="subcampo-row texto-form-row">
                                <button type="button"
                                        class="subcampo-add-btn add-texto-btn"
                                        data-recurso-index="{{ forloop.counter0 }}"
                                        title="Agregar texto de enlace">
                                    <i class="bi bi-plus"></i>
                                </button>
                                <input type="text"
                                       class="form-control texto-input"
                                       name="texto_disponible_856_{{ forloop.counter0 }}_0"
                                       placeholder="Texto descriptivo del enlace">
                                <button type="button"
                                        class="subcampo-delete-btn delete-texto-btn"
                                        title="Eliminar"
                                        style="visibility:hidden;">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        {% endif %}
                    </div>
                </div>

            </div>
        </div>
        {% endfor %}

        {# Form vacío para clonar (nuevo 856) #}
        <div class="formset-row empty-form mb-3" style="display:none;">
            <button type="button" class="delete-row-btn" title="Eliminar recurso 856">
                <i class="bi bi-x-lg"></i>
            </button>

            <div class="campo-grid">
                <div class="col-full">
                    <label class="form-label small">856 $u – URL</label>
                    <div class="subcampo-repetible-container urls-container"
                         data-urls-container="__prefix__">
                        <div class="subcampo-row url-form-row">
                            <button type="button"
                                    class="subcampo-add-btn add-url-btn"
                                    data-recurso-index="__prefix__"
                                    title="Agregar URL">
                                <i class="bi bi-plus"></i>
                            </button>
                            <input type="url"
                                   class="form-control url-input"
                                   name="url_disponible_856___prefix___0"
                                   placeholder="https://ejemplo.com/recurso">
                            <button type="button"
                                    class="subcampo-delete-btn delete-url-btn"
                                    title="Eliminar"
                                    style="visibility:hidden;">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="col-full">
                    <label class="form-label small">856 $y – Texto del enlace</label>
                    <div class="subcampo-repetible-container textos-container"
                         data-textos-container="__prefix__">
                        <div class="subcampo-row texto-form-row">
                            <button type="button"
                                    class="subcampo-add-btn add-texto-btn"
                                    data-recurso-index="__prefix__"
                                    title="Agregar texto de enlace">
                                <i class="bi bi-plus"></i>
                            </button>
                            <input type="text"
                                   class="form-control texto-input"
                                   name="texto_disponible_856___prefix___0"
                                   placeholder="Texto descriptivo del enlace">
                            <button type="button"
                                    class="subcampo-delete-btn delete-texto-btn"
                                    title="Eliminar"
                                    style="visibility:hidden;">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
<script>
    /**
 * Script gestión subcampos:
 * - 856 $u URLs
 * - 856 $y Textos enlace
 */

(function () {

    function init856() {
        const containers = document.querySelectorAll('[data-formset-prefix="disponibles_856"]');
        if (!containers.length) return;

        containers.forEach(container => {

            if (container.dataset.initialized === "true") return;
            container.dataset.initialized = "true";

            container.addEventListener("click", function (e) {

                // --- Agregar URL ---
                const addUrlBtn = e.target.closest(".add-url-btn");
                if (addUrlBtn) {
                    const index = addUrlBtn.getAttribute("data-recurso-index");
                    const target = container.querySelector(`[data-urls-container="${index}"]`);
                    if (!target) return;

                    const newRow = createURLRow(index);
                    target.appendChild(newRow);
                    updateDeleteVisibility(target);
                    return;
                }

                // --- Eliminar URL ---
                if (e.target.closest(".delete-url-btn")) {
                    const row = e.target.closest(".url-form-row");
                    const parent = row.closest(".urls-container");
                    row.remove();
                    updateDeleteVisibility(parent);
                    return;
                }


                // --- Agregar Texto de Enlace ---
                const addTextoBtn = e.target.closest(".add-texto-btn");
                if (addTextoBtn) {
                    const index = addTextoBtn.getAttribute("data-recurso-index");
                    const target = container.querySelector(`[data-textos-container="${index}"]`);
                    if (!target) return;

                    const newRow = createTextoRow(index);
                    target.appendChild(newRow);
                    updateDeleteVisibility(target);
                    return;
                }

                // --- Eliminar Texto de Enlace ---
                if (e.target.closest(".delete-texto-btn")) {
                    const row = e.target.closest(".texto-form-row");
                    const parent = row.closest(".textos-container");
                    row.remove();
                    updateDeleteVisibility(parent);
                    return;
                }

            });

            // Inicializa botones de eliminar en filas ya cargadas
            container.querySelectorAll('.urls-container').forEach(updateDeleteVisibility);
            container.querySelectorAll('.textos-container').forEach(updateDeleteVisibility);

        });
    }


    // Crear nueva fila de URL
    function createURLRow(index) {
        const row = document.createElement("div");
        row.className = "subcampo-row url-form-row mt-2";

        row.innerHTML = `
            <div class="subcampo-placeholder"></div>
            <input type="url" class="form-control url-input"
                   name="url_disponible_856_${index}_${Date.now()}"
                   placeholder="https://ejemplo.com/recurso">
            <button type="button" class="subcampo-delete-btn delete-url-btn" title="Eliminar">
                <i class="bi bi-x-lg"></i>
            </button>
        `;

        return row;
    }

    // Crear nueva fila de Texto Enlace
    function createTextoRow(index) {
        const row = document.createElement("div");
        row.className = "subcampo-row texto-form-row mt-2";

        row.innerHTML = `
            <div class="subcampo-placeholder"></div>
            <input type="text" class="form-control texto-input"
                   name="texto_disponible_856_${index}_${Date.now()}"
                   placeholder="Texto descriptivo del enlace">
            <button type="button" class="subcampo-delete-btn delete-texto-btn" title="Eliminar">
                <i class="bi bi-x-lg"></i>
            </button>
        `;

        return row;
    }


    // Ocultar X en primera fila siempre
    function updateDeleteVisibility(container) {
        const rows = container.querySelectorAll(".subcampo-row");

        rows.forEach((row, idx) => {
            const deleteBtn = row.querySelector(".subcampo-delete-btn");
            const addBtn = row.querySelector(".subcampo-add-btn");
            if (!deleteBtn) return;

            if (idx === 0) {
                deleteBtn.style.visibility = "hidden"; // primera fila
                if (!addBtn) placePlusButton(row, container);
            } else {
                deleteBtn.style.visibility = "visible";
            }
        });
    }

    // Si por alguna razón desaparece el botón +, lo reponemos
    function placePlusButton(row, container) {
        const isURL = container.classList.contains("urls-container");
        const index = container.dataset.urlsContainer || container.dataset.textosContainer;

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "subcampo-add-btn " + (isURL ? "add-url-btn" : "add-texto-btn");
        btn.setAttribute("data-recurso-index", index);
        btn.innerHTML = `<i class="bi bi-plus"></i>`;
        btn.title = isURL ? "Agregar URL" : "Agregar texto de enlace";

        row.insertBefore(btn, row.firstElementChild);
    }

    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", init856);
    } else {
        setTimeout(init856, 0);
    }

})();

</script>