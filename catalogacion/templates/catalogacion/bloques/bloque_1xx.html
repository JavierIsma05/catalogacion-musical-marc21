{# Bloque 1XX - Punto de acceso principal #}
<section id="bloque-1xx" class="bloque-section">
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-person"></i>
                Bloque 1XX - Punto de Acceso Principal
            </h5>
        </div>
        <div class="card-body">
            
            {# Campo 100 - Compositor #}
            {% if '100' in campos_visibles %}
            <div class="campo-marc">
                <div class="campo-titulo">
                    <span class="badge-marc">100</span>
                    <h6>Compositor</h6>
                    <span class="campo-help-btn" data-field-code="100" tabindex="0" title="Ayuda">
                        <i class="bi bi-question-circle"></i>
                    </span>
                </div>
                
                <div class="campo-grid">
                    {# Campo oculto para el ID del compositor #}
                    <input type="hidden" name="compositor" id="id_compositor" value="{{ form.compositor.value|default:'' }}">
                    
                    <div class="col-full">
                        <label class="form-label" for="id_compositor_texto">{{ form.compositor_texto.label }}</label>
                        <div class="autocomplete-wrapper">
                            {{ form.compositor_texto }}
                            <div id="compositor-suggestions" class="autocomplete-suggestions"></div>
                        </div>
                        <div class="form-text">Escriba para buscar compositores existentes o ingrese un nombre nuevo</div>
                        {% if form.compositor_texto.errors %}
                            <div class="invalid-feedback d-block">{{ form.compositor_texto.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="col-full">
                        <label class="form-label" for="id_compositor_coordenadas">{{ form.compositor_coordenadas.label }}</label>
                        {{ form.compositor_coordenadas }}
                        <div class="form-text">Fechas de vida (Ej: 1900-1980)</div>
                        {% if form.compositor_coordenadas.errors %}
                            <div class="invalid-feedback d-block">{{ form.compositor_coordenadas.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="col-full">
                        <label class="form-label" for="{{ form.termino_asociado.id_for_label }}">{{ form.termino_asociado.label }}</label>
                        {{ form.termino_asociado }}
                        {% if form.termino_asociado.errors %}
                            <div class="invalid-feedback">{{ form.termino_asociado.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="col-full">
                        <label class="form-label" for="{{ form.autoria.id_for_label }}">{{ form.autoria.label }}</label>
                        {{ form.autoria }}
                        {% if form.autoria.errors %}
                            <div class="invalid-feedback">{{ form.autoria.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                
                {# Subcampo repetible: 100 $e - Funciones #}
                {% if 'funciones_compositor' in formsets_visibles %}
                <div class="mt-3">
                    <div class="d-flex align-items-center mb-2">
                        <label class="form-label small mb-0">100 $e - Funcion</label>
                    </div>
                    {% include 'catalogacion/includes/formset_100e_template.html' with formset=funciones_compositor %}
                </div>
                {% endif %}
            </div>
            {% endif %}
            
            {# Campo 130 - Título uniforme (punto de acceso principal) #}
            {% if '130' in campos_visibles %}
            <div class="campo-marc">
                <div class="campo-titulo">
                    <span class="badge-marc">130</span>
                    <h6>Título Uniforme Principal</h6>
                    <span class="campo-help-btn" data-field-code="130" tabindex="0" title="Ayuda">
                        <i class="bi bi-question-circle"></i>
                    </span>
                </div>
                
                <div class="campo-grid">
                    {# Campo oculto para el ID del título uniforme - SOLO si 130 es visible #}
                    <input type="hidden" name="titulo_uniforme" id="id_titulo_uniforme" value="{{ form.titulo_uniforme.value|default:'' }}">
                    
                    <div class="col-full">
                        <label class="form-label" for="id_titulo_uniforme_texto">{{ form.titulo_uniforme_texto.label }}</label>
                        <div class="autocomplete-wrapper">
                            {{ form.titulo_uniforme_texto }}
                            <div id="titulo-uniforme-suggestions" class="autocomplete-suggestions"></div>
                        </div>
                        <div class="form-text">Escriba para buscar títulos existentes o ingrese uno nuevo</div>
                        {% if form.titulo_uniforme_texto.errors %}
                            <div class="invalid-feedback d-block">{{ form.titulo_uniforme_texto.errors }}</div>
                        {% endif %}
                    </div>
                    
                    {# Campo oculto para el ID de la forma musical 130 - SOLO si 130 es visible #}
                    <input type="hidden" name="forma_130" id="id_forma_130" value="{{ form.forma_130.value|default:'' }}">
                    
                    <div class="col-half">
                        <label class="form-label">{{ form.forma_130_texto.label }}</label>
                        {# Campo oculto para submit — lo maneja el selector JS #}
                        <input type="hidden" id="id_forma_130_texto" name="forma_130_texto"
                               value="{{ form.forma_130_texto.value|default:'' }}">
                        {# Selector de opciones fijas 130 $k #}
                        <div class="forma-selector" id="forma-130-selector"
                             data-texto-id="id_forma_130_texto" data-fk-id="id_forma_130"
                             data-api="/catalogacion/api/autocompletar/forma-musical/">
                            <button type="button" class="forma-opcion" data-valor="adaptación">adaptación</button>
                            <button type="button" class="forma-opcion" data-valor="boceto">boceto</button>
                            <button type="button" class="forma-opcion" data-valor="fragmento">fragmento</button>
                            <button type="button" class="forma-opcion" data-valor="selección">selección</button>
                            <button type="button" class="forma-opcion" data-valor="tema con variaciones">tema con variaciones</button>
                            <button type="button" class="forma-opcion forma-opcion-otros" data-valor="__otros__">+ otros</button>
                        </div>
                        <div class="forma-otros-wrap d-none mt-1">
                            <input type="text" class="form-control form-control-sm forma-otros-input"
                                   placeholder="Especifique la forma musical...">
                            <small class="text-muted">Se creará como nueva autoridad si no existe</small>
                        </div>
                        {% if form.forma_130_texto.errors %}
                            <div class="invalid-feedback d-block">{{ form.forma_130_texto.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="col-half">
                        <label class="form-label" for="{{ form.medio_interpretacion_130.id_for_label }}">{{ form.medio_interpretacion_130.label }}</label>
                        {{ form.medio_interpretacion_130 }}
                    </div>
                    
                    <div class="col-third">
                        <label class="form-label" for="{{ form.tonalidad_130.id_for_label }}">{{ form.tonalidad_130.label }}</label>
                        {{ form.tonalidad_130 }}
                    </div>
                    
                    <div class="col-third">
                        <label class="form-label" for="{{ form.numero_parte_130.id_for_label }}">{{ form.numero_parte_130.label }}</label>
                        {{ form.numero_parte_130 }}
                    </div>
                    
                    <div class="col-third">
                        <label class="form-label" for="{{ form.nombre_parte_130.id_for_label }}">{{ form.nombre_parte_130.label }}</label>
                        {{ form.nombre_parte_130 }}
                    </div>
                    
                    <div class="col-full">
                        <label class="form-label" for="{{ form.arreglo_130.id_for_label }}">{{ form.arreglo_130.label }}</label>
                        {{ form.arreglo_130 }}
                    </div>
                </div>
            </div>
            {% endif %}
            
            {# Campo 240 - Título uniforme subordinado #}
            {% if '240' in campos_visibles %}
            <div class="campo-marc">
                <div class="campo-titulo">
                    <span class="badge-marc">240</span>
                    <h6>Título Uniforme (subordinado al 100)</h6>
                    <span class="campo-help-btn" data-field-code="240" tabindex="0" title="Ayuda">
                        <i class="bi bi-question-circle"></i>
                    </span>
                </div>
                
                <div class="campo-grid">
                    {# Campo oculto para el ID del título 240 #}
                    <input type="hidden" name="titulo_240" id="id_titulo_240" value="{{ form.titulo_240.value|default:'' }}">
                    
                    <div class="col-full">
                        <label class="form-label" for="id_titulo_240_texto">{{ form.titulo_240_texto.label }}</label>
                        <div class="autocomplete-wrapper">
                            {{ form.titulo_240_texto }}
                            <div id="titulo-240-suggestions" class="autocomplete-suggestions"></div>
                        </div>
                        <div class="form-text">Escriba para buscar títulos existentes o ingrese uno nuevo</div>
                        {% if form.titulo_240_texto.errors %}
                            <div class="invalid-feedback d-block">{{ form.titulo_240_texto.errors }}</div>
                        {% endif %}
                    </div>
                    
                    {# Campo oculto para el ID de la forma musical 240 #}
                    <input type="hidden" name="forma_240" id="id_forma_240" value="{{ form.forma_240.value|default:'' }}">
                    
                    <div class="col-half">
                        <label class="form-label">{{ form.forma_240_texto.label }}</label>
                        {# Campo oculto para submit — lo maneja el selector JS #}
                        <input type="hidden" id="id_forma_240_texto" name="forma_240_texto"
                               value="{{ form.forma_240_texto.value|default:'' }}">
                        {# Selector de opciones fijas 240 $k #}
                        <div class="forma-selector" id="forma-240-selector"
                             data-texto-id="id_forma_240_texto" data-fk-id="id_forma_240"
                             data-api="/catalogacion/api/autocompletar/forma-musical/">
                            <button type="button" class="forma-opcion" data-valor="adaptación" >adaptación</button>
                            <button type="button" class="forma-opcion" data-valor="boceto">boceto</button>
                            <button type="button" class="forma-opcion" data-valor="fragmento">fragmento</button>
                            <button type="button" class="forma-opcion" data-valor="selección">selección</button>
                            <button type="button" class="forma-opcion" data-valor="tema con variaciones">tema con variaciones</button>
                            <button type="button" class="forma-opcion forma-opcion-otros" data-valor="__otros__">+ otros</button>
                        </div>
                        <div class="forma-otros-wrap d-none mt-1">
                            <input type="text" class="form-control form-control-sm forma-otros-input"
                                   placeholder="Especifique la forma musical...">
                            <small class="text-muted">Se creará como nueva autoridad si no existe</small>
                        </div>
                        {% if form.forma_240_texto.errors %}
                            <div class="invalid-feedback d-block">{{ form.forma_240_texto.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="col-half">
                        <label class="form-label" for="{{ form.medio_interpretacion_240.id_for_label }}">{{ form.medio_interpretacion_240.label }}</label>
                        {{ form.medio_interpretacion_240 }}
                    </div>
                    
                    <div class="col-third">
                        <label class="form-label" for="{{ form.tonalidad_240.id_for_label }}">{{ form.tonalidad_240.label }}</label>
                        {{ form.tonalidad_240 }}
                    </div>
                    
                    <div class="col-third">
                        <label class="form-label" for="{{ form.numero_parte_240.id_for_label }}">{{ form.numero_parte_240.label }}</label>
                        {{ form.numero_parte_240 }}
                    </div>
                    
                    <div class="col-third">
                        <label class="form-label" for="{{ form.nombre_parte_240.id_for_label }}">{{ form.nombre_parte_240.label }}</label>
                        {{ form.nombre_parte_240 }}
                    </div>
                    
                    <div class="col-full">
                        <label class="form-label" for="{{ form.arreglo_240.id_for_label }}">{{ form.arreglo_240.label }}</label>
                        {{ form.arreglo_240 }}
                    </div>
                </div>
            </div>
            {% endif %}
            
        </div>
    </div>
</section>

<style>
/* Selector de opciones fijas para 130/240 $k */
.forma-selector {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
}
.forma-opcion {
    font-size: 0.78rem;
    padding: 3px 11px;
    border: 1px solid #ced4da;
    border-radius: 14px;
    background: #f8f9fa;
    color: #495057;
    cursor: pointer;
    transition: background 0.15s, border-color 0.15s;
    line-height: 1.5;
}
.forma-opcion:hover {
    background: #e2e6ea;
    border-color: #adb5bd;
}
.forma-opcion.active {
    background: #0d6efd;
    border-color: #0d6efd;
    color: #fff;
}
.forma-opcion-otros {
    border-style: dashed;
    color: #6c757d;
}
.forma-opcion-otros.active {
    background: #6c757d;
    border-color: #6c757d;
    color: #fff;
    border-style: solid;
}
</style>

<script>
/* Selector de opciones fijas para 130/240 $k */
(function () {
    var FORMAS_ESTANDAR = ['adaptación', 'boceto', 'fragmento', 'selección', 'tema con variaciones'];

    document.querySelectorAll('.forma-selector').forEach(function (selector) {
        var textoId    = selector.dataset.textoId;
        var fkId       = selector.dataset.fkId;
        var apiUrl     = selector.dataset.api;
        var textoInput = document.getElementById(textoId);
        var fkInput    = document.getElementById(fkId);
        var otrosWrap  = selector.nextElementSibling;
        var otrosInput = otrosWrap ? otrosWrap.querySelector('.forma-otros-input') : null;

        /* Clic en cualquier botón de opción */
        selector.querySelectorAll('.forma-opcion').forEach(function (btn) {
            btn.addEventListener('click', function () {
                var valor = btn.dataset.valor;
                selector.querySelectorAll('.forma-opcion').forEach(function (b) { b.classList.remove('active'); });
                btn.classList.add('active');

                if (valor === '__otros__') {
                    if (otrosWrap) otrosWrap.classList.remove('d-none');
                    if (otrosInput) otrosInput.focus();
                    setValor('');
                } else {
                    if (otrosWrap) otrosWrap.classList.add('d-none');
                    if (otrosInput) otrosInput.value = '';
                    setValor(valor);
                }
            });
        });

        /* Escritura en input "otros" */
        if (otrosInput) {
            otrosInput.addEventListener('input', function () {
                setValor(otrosInput.value.trim());
            });
        }

        /* Preselección al cargar (edición de obra existente) */
        var textoActual = textoInput ? textoInput.value.trim() : '';
        if (textoActual) {
            aplicarPreseleccion(textoActual);
        } else if (fkInput && fkInput.value) {
            fetch(apiUrl + '?id=' + fkInput.value)
                .then(function (r) { return r.json(); })
                .then(function (data) {
                    var item = data && data.results && data.results[0];
                    if (item) aplicarPreseleccion(item.forma);
                })
                .catch(function () {});
        }

        function setValor(texto) {
            if (textoInput) {
                textoInput.value = texto;
                textoInput.dispatchEvent(new Event('input',  { bubbles: true }));
                textoInput.dispatchEvent(new Event('change', { bubbles: true }));
            }
            if (fkInput) fkInput.value = '';
            if (window.RequiredFieldsTracker) window.RequiredFieldsTracker.updateProgress();
        }

        function aplicarPreseleccion(texto) {
            var normalizado = texto.toLowerCase().trim();
            var esEstandar  = FORMAS_ESTANDAR.indexOf(normalizado) !== -1;
            selector.querySelectorAll('.forma-opcion').forEach(function (btn) {
                var val = btn.dataset.valor;
                if (val === normalizado) {
                    btn.classList.add('active');
                } else if (!esEstandar && val === '__otros__') {
                    btn.classList.add('active');
                    if (otrosWrap) otrosWrap.classList.remove('d-none');
                    if (otrosInput) otrosInput.value = texto;
                }
            });
        }
    });
})();
</script>
