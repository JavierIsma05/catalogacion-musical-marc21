{% extends 'catalogacion/base_catalogacion.html' %}
{% load static %}
{% load catalogacion_tags %}

{# üÜï UI V2 - Secciones tem√°ticas (Personas, Producci√≥n, Musical, etc.) #}

{% block title %}Crear {{ tipo_obra_titulo }} - MARC21{% endblock %}
{% block page_title %}Crear {{ tipo_obra_titulo }}{% endblock %}

{% block catalogacion_css %}
<link rel="stylesheet" href="{% static 'catalogacion/css/crear-obra.css' %}">
{% endblock %}

{% block catalogacion_content %}
<div class="form-with-progress-sidebar" data-tipo-obra="{{ tipo_obra }}">
    <!-- SIDEBAR DE PROGRESO -->
    <aside class="progress-sidebar">
        <div class="progress-sidebar-sticky">
            <div class="progress-panel">
                <div class="progress-panel-header">
                    <h6>Progreso del Formulario</h6>
                    <p class="text-muted">Campos obligatorios completados</p>
                </div>

                <!-- Indicador circular (opcional, sigue comentado) -->

                <div class="progress-circle-container">
                    <div class="progress-circle">
                        <svg width="80" height="80">
                            <circle class="bg-circle" cx="40" cy="40" r="36"></circle>
                            <circle class="progress-circle-bar" cx="40" cy="40" r="36" id="progress-circle"
                                stroke-dasharray="226.19" stroke-dashoffset="226.19"></circle>
                        </svg>
                        <div class="progress-text" id="progress-percent">0%</div>
                    </div>
                </div>


                <!-- Estad√≠sticas -->
                <div class="progress-stats">
                    <div class="progress-stat-row">
                        <span class="progress-stat-label">Completados</span>
                        <span class="progress-stat-value complete" id="campos-completados">0</span>
                    </div>
                    <div class="progress-stat-row">
                        <span class="progress-stat-label">Pendientes</span>
                        <span class="progress-stat-value incomplete" id="campos-pendientes">0</span>
                    </div>
                    <div class="progress-stat-row">
                        <span class="progress-stat-label">Total</span>
                        <span class="progress-stat-value" id="campos-totales">0</span>
                    </div>
                </div>

                <!-- Lista de campos obligatorios -->
                <ul class="required-fields-list" id="required-fields-list">
                    <!-- Se llena din√°micamente con JavaScript -->
                </ul>
            </div>
        </div>
    </aside>

    <!-- CONTENIDO PRINCIPAL DEL FORMULARIO -->
    <div class="form-content-area">
        <form method="post" id="obra-form" novalidate>
            {% csrf_token %}

            <!-- Campos ocultos -->
            <input type="hidden" name="tipo_registro" value="{{ form.tipo_registro.value|default:'' }}"
                id="id_tipo_registro">
            <input type="hidden" name="nivel_bibliografico" value="{{ form.nivel_bibliografico.value|default:'' }}"
                id="id_nivel_bibliografico">

            <!-- Header del formulario -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-file-earmark-plus"></i>
                        Crear {{ tipo_obra_titulo }}
                    </h5>
                    <small class="text-muted">{{ tipo_obra_descripcion }}</small>
                </div>
            </div>

            <!-- Barra de progreso superior -->
            <div class="progress-indicator">
                <div class="progress-bar-custom">
                    {# Paso 1 de 8 ‚âà 12.5% #}
                    <div class="progress-bar-fill" id="progress-bar" style="width: 12.5%"></div>
                </div>
                <small class="text-muted mt-2 d-block">
                    Paso <span id="current-step">1</span> de 8
                </small>
            </div>

            <!-- ==================== NAVEGACI√ìN DE PESTA√ëAS (NUEVA UI) ==================== -->
            <div class="tabs-navigation">
                <button type="button" class="tab-button active" data-tab="tab-personas" data-tab-index="0">
                    <i class="bi bi-person-vcard"></i> Nombres y t√≠tulos
                </button>
                <button type="button" class="tab-button" data-tab="tab-produccion" data-tab-index="1">
                    <i class="bi bi-building-gear"></i> Producci√≥n/edici√≥n
                </button>
                <button type="button" class="tab-button" data-tab="tab-datos-musicales" data-tab-index="2">
                    <i class="bi bi-music-note-beamed"></i> Datos musicales
                </button>
                <button type="button" class="tab-button" data-tab="tab-materias" data-tab-index="3">
                    <i class="bi bi-tags"></i> Materias/serie
                </button>
                <button type="button" class="tab-button" data-tab="tab-notas" data-tab-index="4">
                    <i class="bi bi-journal-text"></i> Notas
                </button>
                <button type="button" class="tab-button" data-tab="tab-relaciones" data-tab-index="5">
                    <i class="bi bi-diagram-3"></i> Relaciones
                </button>
                <button type="button" class="tab-button" data-tab="tab-existencias" data-tab-index="6">
                    <i class="bi bi-sticky-fill"></i> Existencias
                </button>
                <button type="button" class="tab-button" data-tab="tab-admin" data-tab-index="7">
                    <i class="bi bi-exclamation-circle"></i> Admin
                </button>

            </div>


            <div class="tabs-content">

                <!-- 1Ô∏è‚É£ NOMBRES Y T√çTULOS -->
                <div id="tab-personas" class="tab-content active">
                    {% include 'catalogacion/secciones/personas_titulos.html' %}
                    <div class="tab-navigation-buttons">
                        <div></div>
                        <button type="button" class="btn btn-primary" onclick="nextTab()">
                            Siguiente <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- 2Ô∏è‚É£ PRODUCCI√ìN / EDICI√ìN -->
                <div id="tab-produccion" class="tab-content">
                    {% include 'catalogacion/secciones/produccion_edicion.html' %}
                    <div class="tab-navigation-buttons">
                        <button type="button" class="btn btn-outline-secondary" onclick="prevTab()">
                            <i class="bi bi-arrow-left"></i> Anterior
                        </button>
                        <button type="button" class="btn btn-primary" onclick="nextTab()">
                            Siguiente <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- 3Ô∏è‚É£ DATOS MUSICALES -->
                <div id="tab-datos-musicales" class="tab-content">
                    {% include 'catalogacion/secciones/datos_musicales.html' %}
                    <div class="tab-navigation-buttons">
                        <button type="button" class="btn btn-outline-secondary" onclick="prevTab()">
                            <i class="bi bi-arrow-left"></i> Anterior
                        </button>
                        <button type="button" class="btn btn-primary" onclick="nextTab()">
                            Siguiente <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- 4Ô∏è‚É£ MATERIAS / SERIE -->
                <div id="tab-materias" class="tab-content">
                    {% include 'catalogacion/secciones/materias_serie.html' %}
                    <div class="tab-navigation-buttons">
                        <button type="button" class="btn btn-outline-secondary" onclick="prevTab()">
                            <i class="bi bi-arrow-left"></i> Anterior
                        </button>
                        <button type="button" class="btn btn-primary" onclick="nextTab()">
                            Siguiente <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- 5Ô∏è‚É£ NOTAS -->
                <div id="tab-notas" class="tab-content">
                    {% include 'catalogacion/secciones/notas.html' %}
                    <div class="tab-navigation-buttons">
                        <button type="button" class="btn btn-outline-secondary" onclick="prevTab()">
                            <i class="bi bi-arrow-left"></i> Anterior
                        </button>
                        <button type="button" class="btn btn-primary" onclick="nextTab()">
                            Siguiente <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- 6Ô∏è‚É£ RELACIONES (√∫ltima pesta√±a) -->
                <div id="tab-relaciones" class="tab-content">
                    {% include 'catalogacion/secciones/relaciones.html' %}
                    <div class="tab-navigation-buttons">
                        <button type="button" class="btn btn-outline-secondary" onclick="prevTab()">
                            <i class="bi bi-arrow-left"></i> Anterior
                        </button>
                        <button type="button" class="btn btn-primary" onclick="nextTab()">
                            Siguiente <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </div>
                <div id="tab-existencias" class="tab-content">
                    {% include 'catalogacion/secciones/existencias.html' %}
                    <div class="tab-navigation-buttons">
                        <button type="button" class="btn btn-outline-secondary" onclick="prevTab()">
                            <i class="bi bi-arrow-left"></i> Anterior
                        </button>
                        <button type="button" class="btn btn-primary" onclick="nextTab()">
                            Siguiente <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </div>
                <div id="tab-admin" class="tab-content">
                    {% include 'catalogacion/secciones/administracion.html' %}
                    <div class="tab-navigation-buttons">
                        <button type="button" class="btn btn-outline-secondary" onclick="prevTab()">
                            <i class="bi bi-arrow-left"></i> Anterior
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle-fill"></i> Registrar Obra
                        </button>
                    </div>
                </div>
            </div> <!-- /tabs-content -->
        </form>
    </div>
</div>

<!-- ================= MODAL BUSCAR OBRA ($w 773/774/787) ================= -->
<div class="modal fade" id="modalBuscarObra" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-search"></i> Buscar obra registrada
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <input type="text" id="buscarObraInput" class="form-control mb-3"
                    placeholder="Buscar por n√∫mero de control (001)">

                <ul class="list-group" id="buscarObraResultados"></ul>
            </div>

        </div>
    </div>
</div>

{% endblock catalogacion_content %}

{% block catalogacion_js %}
<script>
    // Pasar tipo de obra al JavaScript
    window.TIPO_OBRA_ACTUAL = '{{ tipo_obra }}';

    // ==================== SISTEMA DE PESTA√ëAS (NUEVA UI) ====================
    // Orden de secciones:
    // 0: Personas y t√≠tulos
    // 1: Producci√≥n / edici√≥n
    // 2: Datos musicales
    // 3: Materias / serie
    // 4: Notas
    // 5: Relaciones
    // 6: Existencias
    // 7: Administrativa
    const tabs = [
        'tab-personas',
        'tab-produccion',
        'tab-datos-musicales',
        'tab-materias',
        'tab-notas',
        'tab-relaciones',
        'tab-existencias',
        'tab-admin'
    ];
    let currentTabIndex = 0;

    // ============================================================================
    // SISTEMA DE BORRADORES DESHABILITADO TEMPORALMENTE
    // ============================================================================
    // const BORRADOR_A_RECUPERAR = {{ borrador_id_recuperar|default:'null' }};
    const BORRADOR_A_RECUPERAR = null; // Borradores deshabilitados
</script>

<script src="{% static 'catalogacion/js/autocomplete-core.js' %}"></script>
<script src="{% static 'catalogacion/js/compositor-autocomplete.js' %}"></script>
<script src="{% static 'catalogacion/js/titulos-formas-autocomplete.js' %}"></script>
<script src="{% static 'catalogacion/js/required-fields-tracker.js' %}"></script>
<!-- BORRADOR SYSTEM DESHABILITADO
<script src="{% static 'catalogacion/js/borrador-system.js' %}"></script>
-->
<script src="{% static 'catalogacion/js/incipitManager.js' %}"></script>
<script src="{% static 'catalogacion/js/incipit-031-adapter.js' %}"></script>
<script src="{% static 'catalogacion/js/autoridades-titulos-autocomplete.js' %}"></script>
<script src="{% static 'catalogacion/js/enlaces-formsets.js' %}"></script>
<script src="{% static 'catalogacion/js/field_help.js' %}"></script>
<script src="{% static 'catalogacion/js/formset-manager.js' %}"></script>
<script src="{% static 'catalogacion/js/form-validator.js' %}"></script>
<!-- <script src="{% static 'catalogacion/js/subcampo-validators.js' %}"></script> -->

{# Incluir modal de ayuda global para campos MARC21 #}
{% include 'catalogacion/includes/help_modal.html' %}

<script>
    // ==================== FUNCIONES DE NAVEGACI√ìN ENTRE PESTA√ëAS ====================
    function switchTab(index) {
        if (index < 0 || index >= tabs.length) return;

        // Ocultar todas las pesta√±as
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });

        // Desactivar todos los botones
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });

        const tabId = tabs[index];
        const tabElement = document.getElementById(tabId);
        const btnElement = document.querySelector(`[data-tab="${tabId}"]`);

        if (!tabElement || !btnElement) {
            console.error('‚ùå No se encontr√≥ la pesta√±a o el bot√≥n para √≠ndice', index, tabId);
            return;
        }

        // Activar pesta√±a y bot√≥n actual
        tabElement.classList.add('active');
        btnElement.classList.add('active');

        currentTabIndex = index;

        // Actualizar barra de progreso
        const progress = ((index + 1) / tabs.length) * 100;
        const progressBar = document.getElementById('progress-bar');
        const currentStepSpan = document.getElementById('current-step');

        if (progressBar) {
            progressBar.style.width = progress + '%';
        }
        if (currentStepSpan) {
            currentStepSpan.textContent = index + 1;
        }

        // Scroll al inicio
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function nextTab() {
        switchTab(currentTabIndex + 1);
    }

    function prevTab() {
        switchTab(currentTabIndex - 1);
    }

    // ==================== INICIALIZACI√ìN DOM ====================
    document.addEventListener('DOMContentLoaded', function () {
        console.log('‚úÖ DOM cargado, inicializando formulario (UI V2)...');

        // Asegurarse de que iniciamos en la primera pesta√±a
        switchTab(0);

        // Activar Select2 en campos de autoridades
        if (typeof $.fn.select2 !== 'undefined') {
            $('.select2').select2({
                theme: 'bootstrap-5',
                width: '100%',
                placeholder: function () {
                    return $(this).data('placeholder');
                },
                allowClear: true
            });
        }

        // Click en botones de pesta√±as
        document.querySelectorAll('.tab-button').forEach((button, index) => {
            button.addEventListener('click', () => {
                switchTab(index);
            });
        });

        // ==================== VALIDACI√ìN Y ENV√çO AJAX ====================
        const form = document.getElementById('obra-form');

        if (!form) {
            console.error('‚ùå ERROR: No se encontr√≥ el formulario #obra-form');
            return;
        }

        console.log('‚úÖ Formulario encontrado, agregando listener de submit...');

        form.addEventListener('submit', function (e) {
            // Prevenir el comportamiento por defecto SIEMPRE
            e.preventDefault();
            e.stopPropagation();

            console.log('\n\n');
            console.log('üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•');
            console.log('üöÄ EVENTO SUBMIT CAPTURADO (UI V2)');
            console.log('üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•');

            // LOG: mostrar datos antes de validar
            console.log('\n=== DATOS DEL FORMULARIO ===');
            const formData = new FormData(form);
            const entries = Array.from(formData.entries());
            console.log('üìä Total de campos:', entries.length);
            console.log('\nüìã Lista completa de datos (solo no vac√≠os):');
            entries.forEach(([key, value]) => {
                if (value && value !== '') {
                    console.log(`  ‚úÖ ${key}: "${value}"`);
                }
            });

            // Verificar validaci√≥n HTML5
            const isValid = form.checkValidity();
            console.log('\nüîç Validaci√≥n HTML5:', isValid ? '‚úÖ V√ÅLIDO' : '‚ùå INV√ÅLIDO');

            if (!isValid) {
                console.log('\n‚ùå‚ùå‚ùå FORMULARIO BLOQUEADO - Validaci√≥n HTML5 fall√≥ ‚ùå‚ùå‚ùå');

                // Encontrar TODOS los campos inv√°lidos
                const invalidFields = form.querySelectorAll(':invalid');
                console.log(`\n‚ö†Ô∏è Se encontraron ${invalidFields.length} campos inv√°lidos:`);

                invalidFields.forEach((field, index) => {
                    console.log(`\n  ${index + 1}. Campo INV√ÅLIDO:`);
                    console.log(`     üìù Name: ${field.name || 'sin nombre'}`);
                    console.log(`     üÜî ID: ${field.id || 'sin id'}`);
                    console.log(`     üìå Tipo: ${field.type}`);
                    console.log(`     üíæ Valor: "${field.value}"`);
                    console.log(`     ‚ö° Required: ${field.required}`);
                    console.log(`     üí¨ Mensaje: ${field.validationMessage}`);
                });

                // Navegar al primer campo inv√°lido
                const firstInvalid = invalidFields[0];
                if (firstInvalid) {
                    tabs.forEach((tabId, index) => {
                        const tabContent = document.getElementById(tabId);
                        if (tabContent && tabContent.contains(firstInvalid)) {
                            console.log(`\nüìç Navegando a pesta√±a ${index}: ${tabId}`);
                            switchTab(index);
                            setTimeout(() => {
                                firstInvalid.focus();
                                firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }, 300);
                        }
                    });
                }

                alert('‚ö†Ô∏è Por favor complete todos los campos obligatorios antes de enviar.');
                console.log('üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•\n\n');
                return;
            }

            // Si llegamos aqu√≠, el formulario es v√°lido seg√∫n HTML5
            console.log('\n‚úÖ‚úÖ‚úÖ FORMULARIO V√ÅLIDO - Enviando al servidor v√≠a AJAX ‚úÖ‚úÖ‚úÖ');

            // Enviar por AJAX para no recargar la p√°gina
            console.log('\nüåê Enviando petici√≥n AJAX...');
            console.log('   URL:', form.action);
            console.log('   M√©todo: POST');

            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
                .then(response => {
                    console.log('\nüì° RESPUESTA RECIBIDA DEL SERVIDOR');
                    console.log('   Status:', response.status);
                    console.log('   Status Text:', response.statusText);
                    console.log('   OK:', response.ok);
                    console.log('   URL final:', response.url);
                    console.log('   Redirected:', response.redirected);

                    // Si hubo redirecci√≥n, la obra se cre√≥ exitosamente
                    if (response.redirected) {
                        console.log('\nüéâüéâüéâ ¬°OBRA CREADA EXITOSAMENTE! üéâüéâüéâ');
                        console.log('   Redirigiendo a:', response.url);

                        alert('‚úÖ ¬°Obra creada exitosamente!\n\nSer√°s redirigido a la p√°gina de detalle.');
                        window.location.href = response.url;
                        return;
                    }

                    return response.text();
                })
                .then(html => {
                    if (!html) return;

                    console.log('\nüìÑ HTML RECIBIDO (primeros 500 caracteres):');
                    console.log(html.substring(0, 500));

                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const alerts = doc.querySelectorAll('.alert, .error, .invalid-feedback');

                    if (alerts.length > 0) {
                        console.log('\n‚ö†Ô∏è MENSAJES/ERRORES ENCONTRADOS EN LA RESPUESTA:');
                        alerts.forEach((alert, i) => {
                            console.log(`  ${i + 1}. ${alert.textContent.trim()}`);
                        });
                    }

                    const successMessage = doc.querySelector('.alert-success');
                    if (successMessage) {
                        console.log('\nüéâ ¬°√âXITO! Obra creada correctamente');
                        console.log('   Mensaje:', successMessage.textContent.trim());
                    } else {
                        console.log('\n‚ùå La respuesta no contiene mensaje de √©xito');
                        console.log('   Probablemente hay errores de validaci√≥n en el backend');
                        alert('‚ùå Error al guardar. Revisa la consola para m√°s detalles.');
                    }
                })
                .catch(error => {
                    console.error('\nüî¥ ERROR EN LA PETICI√ìN AJAX:');
                    console.error(error);
                    alert('‚ùå Error de conexi√≥n: ' + error.message);
                })
                .finally(() => {
                    console.log('\nüî•üî•üî• FIN DEL SUBMIT (UI V2) üî•üî•üî•\n\n');
                });

            form.classList.add('was-validated');
        }, { capture: true });

        console.log('‚úÖ Listener de submit agregado correctamente');

        // Atajos de teclado
        document.addEventListener('keydown', function (e) {
            // Alt + Flecha Derecha = Siguiente
            if (e.altKey && e.key === 'ArrowRight') {
                e.preventDefault();
                nextTab();
            }
            // Alt + Flecha Izquierda = Anterior
            if (e.altKey && e.key === 'ArrowLeft') {
                e.preventDefault();
                prevTab();
            }
        });
    });
</script>
<script>
    (function () {

        let targetTextInput = null;
        let targetHiddenInput = null;

        // Abrir modal al hacer click en üîç
        document.addEventListener("click", function (e) {
            const btn = e.target.closest(".btn-buscar-obra");
            if (!btn) return;

            const group = btn.closest(".input-group");
            if (!group) return;

            targetTextInput = group.querySelector(".numero-w-input");
            targetHiddenInput = group.querySelector(".obra-relacionada-id-input");

            const modal = new bootstrap.Modal(
                document.getElementById("modalBuscarObra")
            );
            modal.show();
        });

        // Buscar obras
        const inputBuscar = document.getElementById("buscarObraInput");
        const resultados = document.getElementById("buscarObraResultados");

        if (!inputBuscar || !resultados) return;

        inputBuscar.addEventListener("input", function () {
            const q = this.value.trim();

            if (q.length < 2) {
                resultados.innerHTML = "";
                return;
            }

            fetch(`/catalogacion/api/buscar-obras/?q=${encodeURIComponent(q)}`)
                .then(r => r.json())
                .then(data => {
                    resultados.innerHTML = "";

                    if (!data.results.length) {
                        resultados.innerHTML = `
                        <li class="list-group-item text-muted">
                            Sin resultados
                        </li>`;
                        return;
                    }

                    data.results.forEach(o => {
                        const li = document.createElement("li");
                        li.className = "list-group-item list-group-item-action";
                        li.innerHTML = `
                        <div>
                            <strong>${o.num_control}</strong>
                            ${o.titulo ? `‚Äî ${o.titulo}` : ""}
                        </div>
                        ${o.compositor ? `
                            <small class="text-muted">
                                ${o.compositor}
                            </small>
                        ` : ""}
                    `;


                        li.addEventListener("click", () => {
                            if (targetTextInput) {
                                targetTextInput.value = o.num_control;
                            }
                            if (targetHiddenInput) {
                                targetHiddenInput.value = o.id;
                            }

                            bootstrap.Modal
                                .getInstance(document.getElementById("modalBuscarObra"))
                                .hide();
                        });

                        resultados.appendChild(li);
                    });
                });
        });

    })();
</script>

{% endblock catalogacion_js %}