{% extends 'catalogacion/base_catalogacion.html' %}
{% load static %}
{% load catalogacion_tags %}

{# üÜï UI V2 - Secciones tem√°ticas (Personas, Producci√≥n, Musical, etc.) #}

{% block title %}Crear {{ tipo_obra_titulo }} - MARC21{% endblock %}
{% block page_title %}Crear {{ tipo_obra_titulo }}{% endblock %}

{% block catalogacion_css %}
<link rel="stylesheet" href="{% static 'catalogacion/css/crear-obra.css' %}">
{% endblock %}

{% block catalogacion_content %}
<div class="form-with-progress-sidebar" data-tipo-obra="{{ tipo_obra }}">
    <!-- SIDEBAR DE PROGRESO -->
    <aside class="progress-sidebar">
        <div class="progress-sidebar-sticky">
            <div class="progress-panel">
                <div class="progress-panel-header">
                    <h6>Progreso del Formulario</h6>
                    <p class="text-muted">Campos obligatorios completados</p>
                </div>

                <!-- Indicador circular (opcional, sigue comentado) -->

                <div class="progress-circle-container">
                    <div class="progress-circle">
                        <svg width="80" height="80">
                            <circle class="bg-circle" cx="40" cy="40" r="36"></circle>
                            <circle class="progress-circle-bar" cx="40" cy="40" r="36" id="progress-circle"
                                stroke-dasharray="226.19" stroke-dashoffset="226.19"></circle>
                        </svg>
                        <div class="progress-text" id="progress-percent">0%</div>
                    </div>
                </div>


                <!-- Estad√≠sticas 
                <div class="progress-stats">
                    <div class="progress-stat-row">
                        <span class="progress-stat-label">Completados</span>
                        <span class="progress-stat-value complete" id="campos-completados">0</span>
                    </div>
                    <div class="progress-stat-row">
                        <span class="progress-stat-label">Pendientes</span>
                        <span class="progress-stat-value incomplete" id="campos-pendientes">0</span>
                    </div>
                    <div class="progress-stat-row">
                        <span class="progress-stat-label">Total</span>
                        <span class="progress-stat-value" id="campos-totales">0</span>
                    </div>
                </div>-->

                <!-- Lista de campos obligatorios -->
                <ul class="required-fields-list" id="required-fields-list">
                    <!-- Se llena din√°micamente con JavaScript -->
                </ul>

                <!-- Indicador de autoguardado -->
                <div class="autosave-indicator" id="autosave-indicator">
                    <i class="bi bi-cloud-check"></i>
                    <span id="autosave-status">Guardado autom√°tico activo</span>
                </div>

                <!-- Botones de acci√≥n -->
                <div class="sidebar-actions">
                    <!-- <button type="button" class="sidebar-btn sidebar-btn-preview" id="btn-vista-previa">
                        <i class="bi bi-eye"></i>
                        <span>Vista Previa</span>
                    </button> -->
                    <button type="button" class="sidebar-btn sidebar-btn-publish" id="btn-publicar-obra">
                        <i class="bi bi-check-circle-fill"></i>
                        <span>Publicar Obra</span>
                    </button>
                </div>
            </div>
        </div>
    </aside>

    <!-- CONTENIDO PRINCIPAL DEL FORMULARIO -->
    <div class="form-content-area">
        <form method="post" id="obra-form" novalidate>
            {% csrf_token %}

            <!-- Campos ocultos -->
            <input type="hidden" name="tipo_registro" value="{{ form.tipo_registro.value|default:'' }}"
                id="id_tipo_registro">
            <input type="hidden" name="nivel_bibliografico" value="{{ form.nivel_bibliografico.value|default:'' }}"
                id="id_nivel_bibliografico">

            <!-- Header del formulario -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-file-earmark-plus"></i>
                        Crear {{ tipo_obra_titulo }}
                    </h5>
                    <small class="text-muted">{{ tipo_obra_descripcion }}</small>
                </div>
            </div>

            <!-- Barra de progreso superior -->
            <div class="progress-indicator">
                <div class="progress-bar-custom">
                    {# Paso 1 de 8 ‚âà 12.5% #}
                    <div class="progress-bar-fill" id="progress-bar" style="width: 12.5%"></div>
                </div>
                <small class="text-muted mt-2 d-block">
                    Paso <span id="current-step">1</span> de 8
                </small>
            </div>

            <!-- ==================== NAVEGACI√ìN DE PESTA√ëAS (NUEVA UI) ==================== -->
            <div class="tabs-navigation">
                <button type="button" class="tab-button active" data-tab="tab-personas" data-tab-index="0">
                    <i class="bi bi-person-vcard"></i> Nombres y t√≠tulos
                </button>
                <button type="button" class="tab-button" data-tab="tab-produccion" data-tab-index="1">
                    <i class="bi bi-building-gear"></i> Producci√≥n/edici√≥n
                </button>
                <button type="button" class="tab-button" data-tab="tab-datos-musicales" data-tab-index="2">
                    <i class="bi bi-music-note-beamed"></i> Datos musicales
                </button>
                <button type="button" class="tab-button" data-tab="tab-materias" data-tab-index="3">
                    <i class="bi bi-tags"></i> Materias/serie
                </button>
                <button type="button" class="tab-button" data-tab="tab-notas" data-tab-index="4">
                    <i class="bi bi-journal-text"></i> Notas
                </button>
                <button type="button" class="tab-button" data-tab="tab-relaciones" data-tab-index="5">
                    <i class="bi bi-diagram-3"></i> Relaciones
                </button>
                <button type="button" class="tab-button" data-tab="tab-existencias" data-tab-index="6">
                    <i class="bi bi-sticky-fill"></i> Existencias
                </button>
                <button type="button" class="tab-button" data-tab="tab-admin" data-tab-index="7">
                    <i class="bi bi-exclamation-circle"></i> Admin
                </button>

            </div>


            <div class="tabs-content">

                <!-- 1Ô∏è‚É£ NOMBRES Y T√çTULOS -->
                <div id="tab-personas" class="tab-content active">
                    {% include 'catalogacion/secciones/personas_titulos.html' %}
                    <div class="tab-navigation-buttons">
                        <div></div>
                        <button type="button" class="btn btn-primary" onclick="nextTab()">
                            Siguiente <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- 2Ô∏è‚É£ PRODUCCI√ìN / EDICI√ìN -->
                <div id="tab-produccion" class="tab-content">
                    {% include 'catalogacion/secciones/produccion_edicion.html' %}
                    <div class="tab-navigation-buttons">
                        <button type="button" class="btn btn-outline-secondary" onclick="prevTab()">
                            <i class="bi bi-arrow-left"></i> Anterior
                        </button>
                        <button type="button" class="btn btn-primary" onclick="nextTab()">
                            Siguiente <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- 3Ô∏è‚É£ DATOS MUSICALES -->
                <div id="tab-datos-musicales" class="tab-content">
                    {% include 'catalogacion/secciones/datos_musicales.html' %}
                    <div class="tab-navigation-buttons">
                        <button type="button" class="btn btn-outline-secondary" onclick="prevTab()">
                            <i class="bi bi-arrow-left"></i> Anterior
                        </button>
                        <button type="button" class="btn btn-primary" onclick="nextTab()">
                            Siguiente <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- 4Ô∏è‚É£ MATERIAS / SERIE -->
                <div id="tab-materias" class="tab-content">
                    {% include 'catalogacion/secciones/materias_serie.html' %}
                    <div class="tab-navigation-buttons">
                        <button type="button" class="btn btn-outline-secondary" onclick="prevTab()">
                            <i class="bi bi-arrow-left"></i> Anterior
                        </button>
                        <button type="button" class="btn btn-primary" onclick="nextTab()">
                            Siguiente <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- 5Ô∏è‚É£ NOTAS -->
                <div id="tab-notas" class="tab-content">
                    {% include 'catalogacion/secciones/notas.html' %}
                    <div class="tab-navigation-buttons">
                        <button type="button" class="btn btn-outline-secondary" onclick="prevTab()">
                            <i class="bi bi-arrow-left"></i> Anterior
                        </button>
                        <button type="button" class="btn btn-primary" onclick="nextTab()">
                            Siguiente <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- 6Ô∏è‚É£ RELACIONES (√∫ltima pesta√±a) -->
                <div id="tab-relaciones" class="tab-content">
                    {% include 'catalogacion/secciones/relaciones.html' %}
                    <div class="tab-navigation-buttons">
                        <button type="button" class="btn btn-outline-secondary" onclick="prevTab()">
                            <i class="bi bi-arrow-left"></i> Anterior
                        </button>
                        <button type="button" class="btn btn-primary" onclick="nextTab()">
                            Siguiente <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </div>
                <div id="tab-existencias" class="tab-content">
                    {% include 'catalogacion/secciones/existencias.html' %}
                    <div class="tab-navigation-buttons">
                        <button type="button" class="btn btn-outline-secondary" onclick="prevTab()">
                            <i class="bi bi-arrow-left"></i> Anterior
                        </button>
                        <button type="button" class="btn btn-primary" onclick="nextTab()">
                            Siguiente <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </div>
                <div id="tab-admin" class="tab-content">
                    {% include 'catalogacion/secciones/administracion.html' %}
                    <div class="tab-navigation-buttons">
                        <button type="button" class="btn btn-outline-secondary" onclick="prevTab()">
                            <i class="bi bi-arrow-left"></i> Anterior
                        </button>
                        <button type="button" class="btn btn-primary" onclick="confirmarPublicacion()">
                            <i class="bi bi-check-circle-fill"></i> Registrar Obra
                        </button>
                    </div>
                </div>
            </div> <!-- /tabs-content -->
        </form>
    </div>
</div>

<!-- ================= MODAL CONFIRMAR PUBLICACI√ìN ================= -->
<div class="modal fade" id="modalConfirmarPublicacion" tabindex="-1" aria-labelledby="modalConfirmarPublicacionLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalConfirmarPublicacionLabel">
                    <i class="bi bi-check-circle text-success"></i> Confirmar registro
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <p class="mb-2">¬øEst√°s seguro de que deseas registrar esta obra en el cat√°logo?</p>
                <p class="text-muted small mb-0">Una vez registrada, podr√°s editarla desde la secci√≥n "Editar Obras".</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    Cancelar
                </button>
                <button type="button" class="btn btn-success" id="btnConfirmarRegistro">
                    <i class="bi bi-check-circle-fill"></i> S√≠, registrar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ================= MODAL BUSCAR OBRA ($w 773/774/787) ================= -->
<div class="modal fade" id="modalBuscarObra" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title" id="modalBuscarObraTitle">
                    <i class="bi bi-search"></i> Buscar obra registrada
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <!-- Fase 1: B√∫squeda -->
                <div id="buscarObraPhase1">
                    <input type="text" id="buscarObraInput" class="form-control mb-3"
                        placeholder="Buscar por N¬∞ control, t√≠tulo, compositor o signatura">
                    <ul class="list-group" id="buscarObraResultados"></ul>
                </div>

                <!-- Fase 2: Selecci√≥n de obra 774 -->
                <div id="buscarObraPhase2" class="d-none">
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-collection"></i>
                        <strong>Colecci√≥n:</strong>
                        <span id="coleccionSeleccionadaInfo"></span>
                    </div>
                    <p class="mb-2">Seleccione la obra que desea catalogar:</p>
                    <ul class="list-group" id="obras774Lista"></ul>
                    <div class="mt-3">
                        <button type="button" class="btn btn-outline-secondary" id="btnVolverBusqueda">
                            <i class="bi bi-arrow-left"></i> Volver
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

{% endblock catalogacion_content %}

{% block catalogacion_js %}
<script>
    // Pasar tipo de obra al JavaScript
    window.TIPO_OBRA_ACTUAL = '{{ tipo_obra }}';

    // ==================== MODAL DE CONFIRMACI√ìN PARA PUBLICAR ====================
    // Variable global para controlar si estamos publicando
    window.permitirSalida = false;

    function confirmarPublicacion() {
        const modalEl = document.getElementById('modalConfirmarPublicacion');
        if (modalEl) {
            const modal = new bootstrap.Modal(modalEl);
            modal.show();
        } else {
            console.error('Modal de confirmaci√≥n no encontrado');
        }
    }

    // Manejar confirmaci√≥n del modal
    document.addEventListener('DOMContentLoaded', function() {
        const btnConfirmar = document.getElementById('btnConfirmarRegistro');
        if (btnConfirmar) {
            btnConfirmar.addEventListener('click', function() {
                // Marcar que permitimos la salida
                window.permitirSalida = true;
                
                // Notificar al sistema de borradores
                if (window.BorradorSystem && typeof window.BorradorSystem.permitirPublicacion === 'function') {
                    window.BorradorSystem.permitirPublicacion();
                }
                
                // Cerrar modal
                const modalEl = document.getElementById('modalConfirmarPublicacion');
                const modal = bootstrap.Modal.getInstance(modalEl);
                if (modal) modal.hide();
                
                // Peque√±o delay y luego enviar formulario
                setTimeout(function() {
                    document.getElementById('obra-form').submit();
                }, 100);
            });
        }
    });

    // ==================== SISTEMA DE PESTA√ëAS (NUEVA UI) ====================
    // Orden de secciones:
    // 0: Personas y t√≠tulos
    // 1: Producci√≥n / edici√≥n
    // 2: Datos musicales
    // 3: Materias / serie
    // 4: Notas
    // 5: Relaciones
    // 6: Existencias
    // 7: Administrativa
    const tabs = [
        'tab-personas',
        'tab-produccion',
        'tab-datos-musicales',
        'tab-materias',
        'tab-notas',
        'tab-relaciones',
        'tab-existencias',
        'tab-admin'
    ];
    let currentTabIndex = 0;

// ============================================================================
// SISTEMA DE BORRADORES
// ============================================================================
const BORRADOR_A_RECUPERAR = {{ borrador_id_recuperar|default:'null' }};
</script>

<script src="{% static 'catalogacion/js/autocomplete-core.js' %}"></script>
<script src="{% static 'catalogacion/js/compositor-autocomplete.js' %}"></script>
<script src="{% static 'catalogacion/js/titulos-formas-autocomplete.js' %}"></script>
<script src="{% static 'catalogacion/js/required-fields-tracker.js' %}"></script>
<script src="{% static 'catalogacion/js/borrador-system.js' %}"></script>
<script src="{% static 'catalogacion/js/incipitManager.js' %}"></script>
<script src="{% static 'catalogacion/js/incipit-031-adapter.js' %}"></script>
<script src="{% static 'catalogacion/js/autoridades-titulos-autocomplete.js' %}"></script>
<script src="{% static 'catalogacion/js/enlaces-formsets.js' %}"></script>
<script src="{% static 'catalogacion/js/field_help.js' %}"></script>
<script src="{% static 'catalogacion/js/formset-manager.js' %}"></script>
<script src="{% static 'catalogacion/js/form-validator.js' %}"></script>
<!-- <script src="{% static 'catalogacion/js/subcampo-validators.js' %}"></script> -->

{# Incluir modal de ayuda global para campos MARC21 #}
{% include 'catalogacion/includes/help_modal.html' %}

<script>
    // ==================== FUNCIONES DE NAVEGACI√ìN ENTRE PESTA√ëAS ====================
    function switchTab(index) {
        if (index < 0 || index >= tabs.length) return;

        // Ocultar todas las pesta√±as
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });

        // Desactivar todos los botones
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });

        const tabId = tabs[index];
        const tabElement = document.getElementById(tabId);
        const btnElement = document.querySelector(`[data-tab="${tabId}"]`);

        if (!tabElement || !btnElement) {
            console.error('‚ùå No se encontr√≥ la pesta√±a o el bot√≥n para √≠ndice', index, tabId);
            return;
        }

        // Activar pesta√±a y bot√≥n actual
        tabElement.classList.add('active');
        btnElement.classList.add('active');

        currentTabIndex = index;

        // Actualizar barra de progreso
        const progress = ((index + 1) / tabs.length) * 100;
        const progressBar = document.getElementById('progress-bar');
        const currentStepSpan = document.getElementById('current-step');

        if (progressBar) {
            progressBar.style.width = progress + '%';
        }
        if (currentStepSpan) {
            currentStepSpan.textContent = index + 1;
        }

        // Scroll al inicio
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function nextTab() {
        switchTab(currentTabIndex + 1);
    }

    function prevTab() {
        switchTab(currentTabIndex - 1);
    }

    // ==================== INICIALIZACI√ìN DOM ====================
    document.addEventListener('DOMContentLoaded', function () {
        console.log('[FORM] DOM cargado, inicializando formulario...');

        // Asegurarse de que iniciamos en la primera pesta√±a
        switchTab(0);

        // Activar Select2 en campos de autoridades
        if (typeof $.fn.select2 !== 'undefined') {
            $('.select2').select2({
                theme: 'bootstrap-5',
                width: '100%',
                placeholder: function () {
                    return $(this).data('placeholder');
                },
                allowClear: true
            });
        }

    // Asegurarse de que iniciamos en la primera pesta√±a
    switchTab(0);

    // Activar Select2 en campos de autoridades
    if (typeof $.fn.select2 !== 'undefined') {
        $('.select2').not('.no-select2').not('[data-no-select2="1"]').select2({
            theme: 'bootstrap-5',
            width: '100%',
            placeholder: function() {
                return $(this).data('placeholder');
            },
            allowClear: true
        });

        // Asegurar que los selects nativos (no-select2) nunca queden con Select2
        $('select.no-select2, select[data-no-select2="1"]').each(function () {
            try {
                if ($(this).data('select2')) {
                    $(this).select2('destroy');
                }
            } catch (e) {
                // ignore
            }
            $(this)
                .removeClass('select2-hidden-accessible')
                .removeClass('select2')
                .removeAttr('data-select2-id')
                .removeAttr('tabindex')
                .removeAttr('aria-hidden');

            const next = this.nextElementSibling;
            if (next && next.classList && next.classList.contains('select2')) {
                next.remove();
            }
        });
    }

        // ==================== VALIDACI√ìN Y ENV√çO DEL FORMULARIO ====================
        const form = document.getElementById('obra-form');

        if (!form) {
            console.error('[FORM] ERROR: No se encontr√≥ el formulario #obra-form');
            return;
        }

        console.log('[FORM] Formulario encontrado, agregando listener de submit...');

        form.addEventListener('submit', function (e) {
            console.log('[SUBMIT] Evento submit capturado');

            const formData = new FormData(form);
            const entries = Array.from(formData.entries());
            const filledEntries = entries.filter(([key, value]) => value && value !== '');
            
            console.log('[SUBMIT] Total campos:', entries.length, '| Campos con datos:', filledEntries.length);

            // Verificar validaci√≥n HTML5
            const isValid = form.checkValidity();
            console.log('[SUBMIT] Validaci√≥n HTML5:', isValid ? 'OK' : 'FALLIDA');

            if (!isValid) {
                e.preventDefault();
                e.stopPropagation();
                
                const invalidFields = form.querySelectorAll(':invalid');
                console.log('[SUBMIT] Campos inv√°lidos encontrados:', invalidFields.length);

                invalidFields.forEach((field, index) => {
                    console.log(`  [${index + 1}] ${field.name || field.id || 'sin-nombre'} | Tipo: ${field.type} | Mensaje: ${field.validationMessage}`);
                });

                // Navegar al primer campo inv√°lido
                const firstInvalid = invalidFields[0];
                if (firstInvalid) {
                    tabs.forEach((tabId, index) => {
                        const tabContent = document.getElementById(tabId);
                        if (tabContent && tabContent.contains(firstInvalid)) {
                            console.log('[SUBMIT] Navegando a pesta√±a:', tabId);
                            switchTab(index);
                            setTimeout(() => {
                                firstInvalid.focus();
                                firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }, 300);
                        }
                    });
                }

                alert('Por favor complete todos los campos obligatorios antes de enviar.');
                form.classList.add('was-validated');
                return false;
            }

            // Formulario v√°lido - permitir env√≠o tradicional
            console.log('[SUBMIT] Formulario v√°lido, enviando al servidor...');
            form.classList.add('was-validated');
            
            // NO llamamos preventDefault() aqu√≠ - dejamos que el formulario se env√≠e normalmente
            return true;
        }, { capture: true });

        console.log('[FORM] Listener de submit agregado');

        // ==================== BOTONES DE SIDEBAR ====================
        const btnVistaPrevia = document.getElementById('btn-vista-previa');
        const btnPublicarObra = document.getElementById('btn-publicar-obra');
        const autosaveIndicator = document.getElementById('autosave-indicator');
        const autosaveStatus = document.getElementById('autosave-status');

        // Funci√≥n para actualizar el indicador de autoguardado
        function updateAutosaveIndicator(status, message) {
            if (!autosaveIndicator || !autosaveStatus) return;
            
            autosaveIndicator.classList.remove('saving', 'saved', 'error');
            
            if (status === 'saving') {
                autosaveIndicator.classList.add('saving');
                autosaveIndicator.querySelector('i').className = 'bi bi-arrow-repeat spin';
                autosaveStatus.textContent = message || 'Guardando...';
            } else if (status === 'saved') {
                autosaveIndicator.classList.add('saved');
                autosaveIndicator.querySelector('i').className = 'bi bi-cloud-check-fill';
                autosaveStatus.textContent = message || 'Guardado';
                
                // Volver al estado normal despu√©s de 3 segundos
                setTimeout(() => {
                    autosaveIndicator.classList.remove('saved');
                    autosaveIndicator.querySelector('i').className = 'bi bi-cloud-check';
                    autosaveStatus.textContent = 'Guardado autom√°tico activo';
                }, 3000);
            } else if (status === 'error') {
                autosaveIndicator.classList.add('error');
                autosaveIndicator.querySelector('i').className = 'bi bi-exclamation-triangle';
                autosaveStatus.textContent = message || 'Error al guardar';
            }
        }

        // Exponer la funci√≥n para que DraftManager la use
        window.updateAutosaveIndicator = updateAutosaveIndicator;

        // Vista Previa del Borrador
        if (btnVistaPrevia) {
            btnVistaPrevia.addEventListener('click', async function() {
                // Primero guardar el borrador actual
                if (window.BorradorSystem) {
                    updateAutosaveIndicator('saving', 'Guardando para vista previa...');
                    try {
                        const resultado = await window.BorradorSystem.guardar();
                        
                        if (resultado && resultado.success) {
                            updateAutosaveIndicator('saved', 'Guardado');
                            
                            // Obtener el ID del borrador (del resultado o del estado)
                            const borradorId = resultado.borradorId || window.BorradorSystem.getBorradorId();
                            if (borradorId) {
                                // Abrir vista previa en nueva pesta√±a
                                window.open(`/catalogacion/borradores/${borradorId}/preview/`, '_blank');
                            } else {
                                updateAutosaveIndicator('error', 'ID no disponible');
                                alert('No se pudo obtener el ID del borrador. Intente nuevamente.');
                            }
                        } else {
                            const errorMsg = resultado?.error || 'Error desconocido';
                            updateAutosaveIndicator('error', 'Error al guardar');
                            alert(`No se pudo guardar el borrador: ${errorMsg}`);
                        }
                    } catch (error) {
                        console.error('[SIDEBAR] Error al guardar para vista previa:', error);
                        updateAutosaveIndicator('error', 'Error al guardar');
                        alert('Error al guardar el borrador. Verifique la consola para m√°s detalles.');
                    }
                } else {
                    alert('Sistema de borradores no disponible.');
                }
            });
        }

        // Publicar Obra (mostrar modal de confirmaci√≥n)
        if (btnPublicarObra) {
            btnPublicarObra.addEventListener('click', function() {
                confirmarPublicacion();
            });
        }

        // Atajos de teclado
        document.addEventListener('keydown', function (e) {
            // Alt + Flecha Derecha = Siguiente
            if (e.altKey && e.key === 'ArrowRight') {
                e.preventDefault();
                nextTab();
            }
            // Alt + Flecha Izquierda = Anterior
            if (e.altKey && e.key === 'ArrowLeft') {
                e.preventDefault();
                prevTab();
            }
        });

        // Event listeners para botones de tab
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const tabIndex = parseInt(this.getAttribute('data-tab-index'), 10);
                if (!isNaN(tabIndex)) {
                    switchTab(tabIndex);
                }
            });
        });

        console.log('[FORM] Inicializaci√≥n completada');
    });
</script>
<script>
    (function () {
        // ===== ESTADO DEL MODAL =====
        let targetTextInput = null;
        let targetHiddenInput = null;
        let targetContainer = null;
        let coleccionSeleccionada = null;

        // ===== ELEMENTOS DEL DOM =====
        const modalEl = document.getElementById("modalBuscarObra");
        const phase1 = document.getElementById("buscarObraPhase1");
        const phase2 = document.getElementById("buscarObraPhase2");
        const inputBuscar = document.getElementById("buscarObraInput");
        const resultados = document.getElementById("buscarObraResultados");
        const obras774Lista = document.getElementById("obras774Lista");
        const coleccionInfo = document.getElementById("coleccionSeleccionadaInfo");
        const btnVolver = document.getElementById("btnVolverBusqueda");
        const modalTitle = document.getElementById("modalBuscarObraTitle");

        if (!inputBuscar || !resultados) return;

        // ===== FUNCIONES DE FASE =====
        function showPhase1() {
            phase1.classList.remove("d-none");
            phase2.classList.add("d-none");
            modalTitle.innerHTML = '<i class="bi bi-search"></i> Buscar obra registrada';
            inputBuscar.value = "";
            resultados.innerHTML = "";
            coleccionSeleccionada = null;
        }

        function showPhase2(coleccion, obras774) {
            phase1.classList.add("d-none");
            phase2.classList.remove("d-none");
            modalTitle.innerHTML = '<i class="bi bi-collection"></i> Seleccionar obra de la colecci√≥n';
            coleccionInfo.textContent = `${coleccion.num_control} ‚Äî ${coleccion.titulo || 'Sin t√≠tulo'}`;
            coleccionSeleccionada = coleccion;

            // Renderizar lista de obras 774
            obras774Lista.innerHTML = "";
            obras774.forEach(obra => {
                const li = document.createElement("li");
                li.className = "list-group-item list-group-item-action";
                li.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>${obra.titulo_texto || 'Sin t√≠tulo'}</strong>
                            ${obra.compositor_texto ? `<br><small class="text-muted">${obra.compositor_texto}</small>` : ''}
                        </div>
                        <i class="bi bi-chevron-right text-muted"></i>
                    </div>
                `;
                li.addEventListener("click", () => selectObra774(coleccion, obra));
                obras774Lista.appendChild(li);
            });
        }

        // ===== SELECCI√ìN DE OBRA 774 =====
        async function selectObra774(coleccion, obra774) {
            // 1. Rellenar campo 773 $w (n√∫mero de control de la colecci√≥n padre)
            if (targetTextInput) {
                targetTextInput.value = coleccion.num_control;
            }
            if (targetHiddenInput) {
                targetHiddenInput.value = coleccion.id;
            }

            // 2. Rellenar campo 100 (compositor) desde la obra 774
            const compositorTexto = document.getElementById("id_compositor_texto");
            const compositorId = document.getElementById("id_compositor");
            if (compositorTexto && obra774.compositor_texto) {
                compositorTexto.value = obra774.compositor_texto;
            }
            if (compositorId && obra774.compositor_id) {
                compositorId.value = obra774.compositor_id;
            }

            // 3. Rellenar campo 245 (t√≠tulo principal) desde la obra 774
            const tituloPrincipal = document.getElementById("id_titulo_principal");
            if (tituloPrincipal && obra774.titulo_texto) {
                tituloPrincipal.value = obra774.titulo_texto;
            }

            // 4. Llamar API de autocompletado773 para heredar campos 264, 382, 852, 856
            try {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
                const response = await fetch('/catalogacion/api/obras/autocomplete/773/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ obra_id: coleccion.id })
                });
                const data = await response.json();

                if (data.success && data.campos_heredables) {
                    poblarCamposHeredables(data.campos_heredables);
                }
            } catch (error) {
                console.error('Error al obtener campos heredables:', error);
            }

            // 5. Cerrar modal
            bootstrap.Modal.getInstance(modalEl).hide();

            // 6. Notificar al usuario
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'success',
                    title: 'Datos copiados',
                    text: `Se copiaron los datos de "${obra774.titulo_texto || 'la obra'}" y su colecci√≥n padre.`,
                    timer: 3000,
                    showConfirmButton: false
                });
            }
        }

        // ===== POBLAR CAMPOS HEREDABLES =====
        function poblarCamposHeredables(campos) {
            // 264 - Producci√≥n/Publicaci√≥n
            if (campos['264']) {
                const c264 = campos['264'];
                const lugarInput = document.querySelector('input[name="lugar_produccion"]');
                const entidadInput = document.querySelector('input[name="entidad_produccion"]');
                const fechaInput = document.querySelector('input[name="fecha_produccion"]');

                if (lugarInput && c264.lugares?.length) {
                    lugarInput.value = c264.lugares[0].lugar || '';
                }
                if (entidadInput && c264.entidades?.length) {
                    entidadInput.value = c264.entidades[0].entidad || '';
                }
                if (fechaInput && c264.fechas?.length) {
                    fechaInput.value = c264.fechas[0].fecha || '';
                }
            }

            // 382 - Medio de interpretaci√≥n
            if (campos['382']?.medios?.length) {
                const medioInput = document.querySelector('input[name="medio_interpretacion"]');
                if (medioInput) {
                    medioInput.value = campos['382'].medios.map(m => m.medio).join(', ');
                }
            }

            // 852 - Localizaci√≥n
            if (campos['852']) {
                const c852 = campos['852'];
                const codigoInput = document.querySelector('input[name="codigo_o_nombre"]');
                const signaturaInput = document.querySelector('input[name="signatura_original"]');

                if (codigoInput && c852.codigo_o_nombre) {
                    codigoInput.value = c852.codigo_o_nombre;
                }
                if (signaturaInput && c852.signatura_original) {
                    signaturaInput.value = c852.signatura_original;
                }
            }

            // 856 - Acceso electr√≥nico (primer URL disponible)
            if (campos['856']?.urls?.length) {
                const urlInput = document.querySelector('input[name="url_856"]');
                if (urlInput) {
                    urlInput.value = campos['856'].urls[0].url || '';
                }
            }
        }

        // ===== CARGAR OBRAS 774 =====
        async function load774Entries(obraId, obraData) {
            try {
                const response = await fetch(`/catalogacion/api/obras/774-entries/?obra_id=${obraId}`);
                const data = await response.json();

                if (!data.success) {
                    // No es colecci√≥n o error
                    return { isCollection: false, error: data.error };
                }

                if (!data.obras_774 || data.obras_774.length === 0) {
                    return { isCollection: true, hasEntries: false };
                }

                return {
                    isCollection: true,
                    hasEntries: true,
                    coleccion: data.coleccion,
                    obras: data.obras_774
                };
            } catch (error) {
                console.error('Error cargando obras 774:', error);
                return { isCollection: false, error: 'Error de conexi√≥n' };
            }
        }

        // ===== ABRIR MODAL =====
        document.addEventListener("click", function (e) {
            const btn = e.target.closest(".btn-buscar-obra");
            if (!btn) return;

            const group = btn.closest(".input-group");
            if (!group) return;

            targetTextInput = group.querySelector(".numero-w-input");
            targetHiddenInput = group.querySelector(".obra-relacionada-id-input");
            targetContainer = btn.closest('.formset-row') || btn.closest('.card') || group;

            showPhase1();
            new bootstrap.Modal(modalEl).show();
        });

        // ===== B√öSQUEDA DE OBRAS =====
        let searchTimer = null;
        inputBuscar.addEventListener("input", function () {
            const q = this.value.trim();

            if (q.length < 2) {
                resultados.innerHTML = "";
                return;
            }

            clearTimeout(searchTimer);
            searchTimer = setTimeout(async () => {
                try {
                    const response = await fetch(`/catalogacion/api/obras/buscar/?q=${encodeURIComponent(q)}`);
                    const data = await response.json();

                    resultados.innerHTML = "";

                    if (!data.results.length) {
                        resultados.innerHTML = `
                            <li class="list-group-item text-muted">
                                Sin resultados
                            </li>`;
                        return;
                    }

                    data.results.forEach(o => {
                        const li = document.createElement("li");
                        li.className = "list-group-item list-group-item-action";

                        // Mostrar badge si es colecci√≥n
                        const isColeccion = o.nivel_bibliografico === 'c';
                        const badge = isColeccion
                            ? '<span class="badge bg-info ms-2">Colecci√≥n</span>'
                            : '';

                        li.innerHTML = `
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>${o.num_control}</strong>${badge}
                                    ${o.titulo ? `<br><span class="text-dark">${o.titulo}</span>` : ''}
                                    ${o.compositor ? `<br><small class="text-muted">${o.compositor}</small>` : ''}
                                    ${o.signatura ? `<br><small class="text-muted"><i class="bi bi-geo-alt"></i> ${o.signatura}</small>` : ''}
                                </div>
                                <i class="bi bi-chevron-right text-muted"></i>
                            </div>
                        `;

                        li.addEventListener("click", async () => {
                            // Verificar si es colecci√≥n y tiene obras 774
                            if (isColeccion) {
                                const result = await load774Entries(o.id, o);

                                if (result.isCollection && result.hasEntries) {
                                    // Mostrar fase 2 con selector de obras
                                    showPhase2(result.coleccion, result.obras);
                                } else if (result.isCollection && !result.hasEntries) {
                                    // Colecci√≥n sin obras registradas
                                    if (typeof Swal !== 'undefined') {
                                        Swal.fire({
                                            icon: 'warning',
                                            title: 'Colecci√≥n sin obras',
                                            text: 'Esta colecci√≥n no tiene obras registradas en el campo 774. Agregue las obras primero.',
                                            confirmButtonText: 'Entendido'
                                        });
                                    } else {
                                        alert('Esta colecci√≥n no tiene obras registradas en el campo 774.');
                                    }
                                } else {
                                    // No es colecci√≥n o error - comportamiento normal
                                    selectObraNormal(o);
                                }
                            } else {
                                // No es colecci√≥n - comportamiento normal
                                selectObraNormal(o);
                            }
                        });

                        resultados.appendChild(li);
                    });
                } catch (error) {
                    console.error('Error en b√∫squeda:', error);
                }
            }, 300);
        });

        // ===== SELECCI√ìN NORMAL (NO COLECCI√ìN) =====
        function selectObraNormal(o) {
            if (targetTextInput) {
                targetTextInput.value = o.num_control;
            }
            if (targetHiddenInput) {
                targetHiddenInput.value = o.id;
            }

            // Rellenar $a y $t si hay contenedor
            if (targetContainer) {
                const personaWrapper = targetContainer.querySelector('.autocomplete-wrapper[data-autocomplete="persona"]');
                if (personaWrapper) {
                    const inp = personaWrapper.querySelector('input');
                    if (inp) inp.value = o.compositor || '';
                }

                const tituloWrapper = targetContainer.querySelector('.autocomplete-wrapper[data-autocomplete="titulo"]');
                if (tituloWrapper) {
                    const inp = tituloWrapper.querySelector('input');
                    if (inp) inp.value = o.titulo || '';
                }

                const hiddenPersona = targetContainer.querySelector('input[name$="encabezamiento_principal"]');
                if (hiddenPersona) hiddenPersona.value = o.compositor_id || '';

                const hiddenTitulo = targetContainer.querySelector('input[name$="titulo"]');
                if (hiddenTitulo) hiddenTitulo.value = o.titulo_id || '';
            }

            bootstrap.Modal.getInstance(modalEl).hide();
        }

        // ===== BOT√ìN VOLVER =====
        if (btnVolver) {
            btnVolver.addEventListener("click", showPhase1);
        }

        // ===== RESET AL CERRAR MODAL =====
        modalEl.addEventListener("hidden.bs.modal", showPhase1);

    })();
</script>

{% endblock catalogacion_js %}