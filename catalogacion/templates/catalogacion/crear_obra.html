{% extends 'catalogacion/base_catalogacion.html' %}
{% load static %}
{% load catalogacion_tags %}

{# üÜï UI V2 - Secciones tem√°ticas (Personas, Producci√≥n, Musical, etc.) #}

{% block title %}Crear {{ tipo_obra_titulo }} - MARC21{% endblock %}
{% block page_title %}Crear {{ tipo_obra_titulo }}{% endblock %}

{% block catalogacion_css %}
<link rel="stylesheet" href="{% static 'catalogacion/css/crear-obra.css' %}">
{% endblock %}

{% block catalogacion_content %}
<div class="form-with-progress-sidebar" data-tipo-obra="{{ tipo_obra }}">
    <!-- SIDEBAR DE PROGRESO -->
    <aside class="progress-sidebar">
        <div class="progress-sidebar-sticky">
            <div class="progress-panel">
                <div class="progress-panel-header">
                    <h6>Progreso del Formulario</h6>
                    <p class="text-muted">Campos obligatorios completados</p>
                </div>

                <!-- Indicador circular (opcional, sigue comentado) -->

                <div class="progress-circle-container">
                    <div class="progress-circle">
                        <svg width="80" height="80">
                            <circle class="bg-circle" cx="40" cy="40" r="36"></circle>
                            <circle class="progress-circle-bar" cx="40" cy="40" r="36" id="progress-circle"
                                stroke-dasharray="226.19" stroke-dashoffset="226.19"></circle>
                        </svg>
                        <div class="progress-text" id="progress-percent">0%</div>
                    </div>
                </div>


                <!-- Estad√≠sticas
                <div class="progress-stats">
                    <div class="progress-stat-row">
                        <span class="progress-stat-label">Completados</span>
                        <span class="progress-stat-value complete" id="campos-completados">0</span>
                    </div>
                    <div class="progress-stat-row">
                        <span class="progress-stat-label">Pendientes</span>
                        <span class="progress-stat-value incomplete" id="campos-pendientes">0</span>
                    </div>
                    <div class="progress-stat-row">
                        <span class="progress-stat-label">Total</span>
                        <span class="progress-stat-value" id="campos-totales">0</span>
                    </div>
                </div>-->

                <!-- Lista de campos obligatorios -->
                <ul class="required-fields-list" id="required-fields-list">
                    <!-- Se llena din√°micamente con JavaScript -->
                </ul>

                <!-- Indicador de autoguardado -->
                <div class="autosave-indicator" id="autosave-indicator">
                    <i class="bi bi-cloud-check"></i>
                    <span id="autosave-status">Guardado autom√°tico activo</span>
                </div>

                <!-- Estado de publicaci√≥n (solo en edici√≥n) -->
                {% if object and object.pk %}
                <div class="publication-status mb-3 text-center">
                    {% if object.publicada %}
                        <span class="badge bg-success">
                            <i class="bi bi-globe"></i> Publicada
                        </span>
                    {% else %}
                        <span class="badge bg-secondary">
                            <i class="bi bi-eye-slash"></i> Sin publicar
                        </span>
                    {% endif %}
                </div>
                {% endif %}

                <!-- Botones de acci√≥n -->
                <div class="sidebar-actions">
                    {% if object and object.pk %}
                        {# Modo edici√≥n #}
                        <button type="button" class="sidebar-btn sidebar-btn-secondary" id="btn-registrar-obra">
                            <i class="bi bi-floppy"></i>
                            <span>Guardar cambios</span>
                        </button>
                        {% if object.publicada %}
                            <button type="button" class="sidebar-btn sidebar-btn-warning" id="btn-despublicar-obra">
                                <i class="bi bi-eye-slash"></i>
                                <span>Despublicar</span>
                            </button>
                        {% else %}
                            <button type="button" class="sidebar-btn sidebar-btn-publish" id="btn-publicar-obra">
                                <i class="bi bi-globe"></i>
                                <span>Publicar Obra</span>
                            </button>
                        {% endif %}
                    {% else %}
                        {# Modo creaci√≥n #}
                        <button type="button" class="sidebar-btn sidebar-btn-secondary" id="btn-registrar-obra">
                            <i class="bi bi-floppy"></i>
                            <span>Registrar Obra</span>
                        </button>
                        <button type="button" class="sidebar-btn sidebar-btn-publish" id="btn-publicar-obra">
                            <i class="bi bi-globe"></i>
                            <span>Publicar Obra</span>
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </aside>

    <!-- CONTENIDO PRINCIPAL DEL FORMULARIO -->
    <div class="form-content-area">
        <form method="post" id="obra-form" novalidate>
            {% csrf_token %}

            <!-- Campos ocultos -->
            <input type="hidden" name="tipo_registro" value="{{ form.tipo_registro.value|default:'' }}"
                id="id_tipo_registro">
            <input type="hidden" name="nivel_bibliografico" value="{{ form.nivel_bibliografico.value|default:'' }}"
                id="id_nivel_bibliografico">
            <input type="hidden" name="accion" id="id_accion" value="registrar">

            <!-- Header del formulario -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-file-earmark-plus"></i>
                        Crear {{ tipo_obra_titulo }}
                    </h5>
                    <small class="text-muted">{{ tipo_obra_descripcion }}</small>
                </div>
            </div>

            <!-- Barra de progreso superior -->
            <div class="progress-indicator">
                <div class="progress-bar-custom">
                    {# Paso 1 de 8 ‚âà 12.5% #}
                    <div class="progress-bar-fill" id="progress-bar" style="width: 12.5%"></div>
                </div>
                <small class="text-muted mt-2 d-block">
                    Paso <span id="current-step">1</span> de 8
                </small>
            </div>

            <!-- ==================== NAVEGACI√ìN DE PESTA√ëAS (NUEVA UI) ==================== -->
            <div class="tabs-navigation">
                {% if tipo_obra == 'coleccion_manuscrita' or tipo_obra == 'coleccion_impresa' %}
                {# Colecciones: Nombres y t√≠tulos primero, Relaciones al final #}
                <button type="button" class="tab-button active" data-tab="tab-personas" data-tab-index="0">
                    <i class="bi bi-person-vcard"></i> Nombres y t√≠tulos
                </button>
                <button type="button" class="tab-button" data-tab="tab-produccion" data-tab-index="1">
                    <i class="bi bi-building-gear"></i> Producci√≥n/edici√≥n
                </button>
                <button type="button" class="tab-button" data-tab="tab-datos-musicales" data-tab-index="2">
                    <i class="bi bi-music-note-beamed"></i> Datos musicales
                </button>
                <button type="button" class="tab-button" data-tab="tab-materias" data-tab-index="3">
                    <i class="bi bi-tags"></i> Materias/serie
                </button>
                <button type="button" class="tab-button" data-tab="tab-notas" data-tab-index="4">
                    <i class="bi bi-journal-text"></i> Notas
                </button>
                <button type="button" class="tab-button" data-tab="tab-relaciones" data-tab-index="5">
                    <i class="bi bi-diagram-3"></i> Relaciones
                </button>
                <button type="button" class="tab-button" data-tab="tab-existencias" data-tab-index="6">
                    <i class="bi bi-sticky-fill"></i> Existencias
                </button>
                <button type="button" class="tab-button" data-tab="tab-admin" data-tab-index="7">
                    <i class="bi bi-exclamation-circle"></i> Admin
                </button>
                {% else %}
                {# Obras individuales: Relaciones primero #}
                <button type="button" class="tab-button active" data-tab="tab-relaciones" data-tab-index="0">
                    <i class="bi bi-diagram-3"></i> Relaciones
                </button>
                <button type="button" class="tab-button" data-tab="tab-personas" data-tab-index="1">
                    <i class="bi bi-person-vcard"></i> Nombres y t√≠tulos
                </button>
                <button type="button" class="tab-button" data-tab="tab-produccion" data-tab-index="2">
                    <i class="bi bi-building-gear"></i> Producci√≥n/edici√≥n
                </button>
                <button type="button" class="tab-button" data-tab="tab-datos-musicales" data-tab-index="3">
                    <i class="bi bi-music-note-beamed"></i> Datos musicales
                </button>
                <button type="button" class="tab-button" data-tab="tab-materias" data-tab-index="4">
                    <i class="bi bi-tags"></i> Materias/serie
                </button>
                <button type="button" class="tab-button" data-tab="tab-notas" data-tab-index="5">
                    <i class="bi bi-journal-text"></i> Notas
                </button>
                <button type="button" class="tab-button" data-tab="tab-existencias" data-tab-index="6">
                    <i class="bi bi-sticky-fill"></i> Existencias
                </button>
                <button type="button" class="tab-button" data-tab="tab-admin" data-tab-index="7">
                    <i class="bi bi-exclamation-circle"></i> Admin
                </button>
                {% endif %}
            </div>


            <div class="tabs-content">

                <!-- 1Ô∏è‚É£ RELACIONES (activo para obras; √≠ndice 5 para colecciones) -->
                <div id="tab-relaciones" class="tab-content{% if tipo_obra != 'coleccion_manuscrita' and tipo_obra != 'coleccion_impresa' %} active{% endif %}">
                    {% include 'catalogacion/secciones/relaciones.html' %}
                    <div class="tab-navigation-buttons">
                        {% if tipo_obra == 'coleccion_manuscrita' or tipo_obra == 'coleccion_impresa' %}
                        <button type="button" class="btn btn-outline-secondary" onclick="prevTab()">
                            <i class="bi bi-arrow-left"></i> Anterior
                        </button>
                        {% else %}
                        <div></div>
                        {% endif %}
                        <button type="button" class="btn btn-primary" onclick="nextTab()">
                            Siguiente <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- 2Ô∏è‚É£ NOMBRES Y T√çTULOS (activo para colecciones; √≠ndice 1 para obras) -->
                <div id="tab-personas" class="tab-content{% if tipo_obra == 'coleccion_manuscrita' or tipo_obra == 'coleccion_impresa' %} active{% endif %}">
                    {% include 'catalogacion/secciones/personas_titulos.html' %}
                    <div class="tab-navigation-buttons">
                        {% if tipo_obra == 'coleccion_manuscrita' or tipo_obra == 'coleccion_impresa' %}
                        <div></div>
                        {% else %}
                        <button type="button" class="btn btn-outline-secondary" onclick="prevTab()">
                            <i class="bi bi-arrow-left"></i> Anterior
                        </button>
                        {% endif %}
                        <button type="button" class="btn btn-primary" onclick="nextTab()">
                            Siguiente <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- 3Ô∏è‚É£ PRODUCCI√ìN / EDICI√ìN -->
                <div id="tab-produccion" class="tab-content">
                    {% include 'catalogacion/secciones/produccion_edicion.html' %}
                    <div class="tab-navigation-buttons">
                        <button type="button" class="btn btn-outline-secondary" onclick="prevTab()">
                            <i class="bi bi-arrow-left"></i> Anterior
                        </button>
                        <button type="button" class="btn btn-primary" onclick="nextTab()">
                            Siguiente <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- 4Ô∏è‚É£ DATOS MUSICALES -->
                <div id="tab-datos-musicales" class="tab-content">
                    {% include 'catalogacion/secciones/datos_musicales.html' %}
                    <div class="tab-navigation-buttons">
                        <button type="button" class="btn btn-outline-secondary" onclick="prevTab()">
                            <i class="bi bi-arrow-left"></i> Anterior
                        </button>
                        <button type="button" class="btn btn-primary" onclick="nextTab()">
                            Siguiente <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- 5Ô∏è‚É£ MATERIAS / SERIE -->
                <div id="tab-materias" class="tab-content">
                    {% include 'catalogacion/secciones/materias_serie.html' %}
                    <div class="tab-navigation-buttons">
                        <button type="button" class="btn btn-outline-secondary" onclick="prevTab()">
                            <i class="bi bi-arrow-left"></i> Anterior
                        </button>
                        <button type="button" class="btn btn-primary" onclick="nextTab()">
                            Siguiente <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- 6Ô∏è‚É£ NOTAS -->
                <div id="tab-notas" class="tab-content">
                    {% include 'catalogacion/secciones/notas.html' %}
                    <div class="tab-navigation-buttons">
                        <button type="button" class="btn btn-outline-secondary" onclick="prevTab()">
                            <i class="bi bi-arrow-left"></i> Anterior
                        </button>
                        <button type="button" class="btn btn-primary" onclick="nextTab()">
                            Siguiente <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </div>
                <div id="tab-existencias" class="tab-content">
                    {% include 'catalogacion/secciones/existencias.html' %}
                    <div class="tab-navigation-buttons">
                        <button type="button" class="btn btn-outline-secondary" onclick="prevTab()">
                            <i class="bi bi-arrow-left"></i> Anterior
                        </button>
                        <button type="button" class="btn btn-primary" onclick="nextTab()">
                            Siguiente <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </div>
                <div id="tab-admin" class="tab-content">
                    {% include 'catalogacion/secciones/administracion.html' %}
                    <div class="tab-navigation-buttons">
                        <button type="button" class="btn btn-outline-secondary" onclick="prevTab()">
                            <i class="bi bi-arrow-left"></i> Anterior
                        </button>
                        {% if object and object.pk %}
                            {# Modo edici√≥n #}
                            <button type="button" class="btn btn-secondary me-2" onclick="confirmarRegistro()">
                                <i class="bi bi-floppy"></i> Guardar cambios
                            </button>
                            {% if object.publicada %}
                                <button type="button" class="btn btn-warning" onclick="confirmarDespublicacion()">
                                    <i class="bi bi-eye-slash"></i> Despublicar
                                </button>
                            {% else %}
                                <button type="button" class="btn btn-success" onclick="confirmarPublicacion()">
                                    <i class="bi bi-globe"></i> Publicar Obra
                                </button>
                            {% endif %}
                        {% else %}
                            {# Modo creaci√≥n #}
                            <button type="button" class="btn btn-secondary me-2" onclick="confirmarRegistro()">
                                <i class="bi bi-floppy"></i> Registrar Obra
                            </button>
                            <button type="button" class="btn btn-success" onclick="confirmarPublicacion()">
                                <i class="bi bi-globe"></i> Publicar Obra
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div> <!-- /tabs-content -->
        </form>

<!-- ================= MODAL CONFIRMAR REGISTRO ================= -->
<div class="modal fade" id="modalConfirmarRegistro" tabindex="-1" aria-labelledby="modalConfirmarRegistroLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalConfirmarRegistroLabel">
                    <i class="bi bi-floppy text-secondary"></i> Confirmar registro
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <p class="mb-2">¬øEst√°s seguro de que deseas <strong>registrar</strong> esta obra?</p>
                <p class="text-muted small mb-0">La obra quedar√° guardada pero <strong>no ser√° visible</strong> en el cat√°logo p√∫blico hasta que la publiques.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    Cancelar
                </button>
                <button type="button" class="btn btn-secondary" id="btnConfirmarSoloRegistro">
                    <i class="bi bi-floppy"></i> S√≠, registrar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ================= MODAL CONFIRMAR PUBLICACI√ìN ================= -->
<div class="modal fade" id="modalConfirmarPublicacion" tabindex="-1" aria-labelledby="modalConfirmarPublicacionLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalConfirmarPublicacionLabel">
                    <i class="bi bi-globe text-success"></i> Confirmar publicaci√≥n
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <p class="mb-2">¬øEst√°s seguro de que deseas <strong>publicar</strong> esta obra?</p>
                <p class="text-muted small mb-0">La obra ser√° visible inmediatamente en el <strong>cat√°logo p√∫blico</strong>.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    Cancelar
                </button>
                <button type="button" class="btn btn-success" id="btnConfirmarRegistro">
                    <i class="bi bi-globe"></i> S√≠, publicar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ================= MODAL CONFIRMAR DESPUBLICACI√ìN ================= -->
<div class="modal fade" id="modalConfirmarDespublicacion" tabindex="-1" aria-labelledby="modalConfirmarDespublicacionLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalConfirmarDespublicacionLabel">
                    <i class="bi bi-eye-slash text-warning"></i> Confirmar despublicaci√≥n
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <p class="mb-2">¬øEst√°s seguro de que deseas <strong>retirar</strong> esta obra del cat√°logo p√∫blico?</p>
                <p class="text-muted small mb-0">La obra dejar√° de ser visible para el p√∫blico pero se mantendr√°n todos los datos.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    Cancelar
                </button>
                <button type="button" class="btn btn-warning" id="btnConfirmarDespublicar">
                    <i class="bi bi-eye-slash"></i> S√≠, despublicar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ================= MODAL BUSCAR OBRA ($w 773/774/787) ================= -->
<div class="modal fade" id="modalBuscarObra" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title" id="modalBuscarObraTitle">
                    <i class="bi bi-search"></i> Buscar obra registrada
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <!-- Fase 1: B√∫squeda -->
                <div id="buscarObraPhase1">
                    <input type="text" id="buscarObraInput" class="form-control mb-3"
                        placeholder="Buscar por N¬∞ control, t√≠tulo, compositor o signatura">
                    <ul class="list-group" id="buscarObraResultados"></ul>
                </div>

                <!-- Fase 2: Selecci√≥n de obra 774 -->
                <div id="buscarObraPhase2" class="d-none">
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-collection"></i>
                        <strong>Colecci√≥n:</strong>
                        <span id="coleccionSeleccionadaInfo"></span>
                    </div>
                    <p class="mb-2">Seleccione la obra que desea catalogar:</p>
                    <ul class="list-group" id="obras774Lista"></ul>
                    <div class="mt-3">
                        <button type="button" class="btn btn-outline-secondary" id="btnVolverBusqueda">
                            <i class="bi bi-arrow-left"></i> Volver
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

{% endblock catalogacion_content %}

{% block catalogacion_js %}
<script>
  // Pasar tipo de obra al JavaScript
  window.TIPO_OBRA_ACTUAL = '{{ tipo_obra }}';

  // ==================== MODALES CONFIRMACI√ìN ====================
  window.permitirSalida = false;

  function confirmarRegistro() {
    const modalEl = document.getElementById('modalConfirmarRegistro');
    if (!modalEl) return console.error('Modal de confirmaci√≥n de registro no encontrado');
    new bootstrap.Modal(modalEl).show();
  }

  function confirmarPublicacion() {
    const modalEl = document.getElementById('modalConfirmarPublicacion');
    if (!modalEl) return console.error('Modal de confirmaci√≥n de publicaci√≥n no encontrado');
    new bootstrap.Modal(modalEl).show();
  }

  function confirmarDespublicacion() {
    const modalEl = document.getElementById('modalConfirmarDespublicacion');
    if (!modalEl) return console.error('Modal de confirmaci√≥n de despublicaci√≥n no encontrado');
    new bootstrap.Modal(modalEl).show();
  }

  function enviarFormulario(accion) {
    window.permitirSalida = true;
    const accionInput = document.getElementById('id_accion');
    if (accionInput) accionInput.value = accion;

    if (window.BorradorSystem && typeof window.BorradorSystem.permitirPublicacion === 'function') {
      window.BorradorSystem.permitirPublicacion();
    }

    setTimeout(() => {
      const form = document.getElementById('obra-form');
      if (form) form.submit();
    }, 100);
  }

  // ==================== SISTEMA DE PESTA√ëAS (NUEVA UI) ====================
  const tabs = {% if tipo_obra == 'coleccion_manuscrita' or tipo_obra == 'coleccion_impresa' %}[
    'tab-personas',
    'tab-produccion',
    'tab-datos-musicales',
    'tab-materias',
    'tab-notas',
    'tab-relaciones',
    'tab-existencias',
    'tab-admin'
  ]{% else %}[
    'tab-relaciones',
    'tab-personas',
    'tab-produccion',
    'tab-datos-musicales',
    'tab-materias',
    'tab-notas',
    'tab-existencias',
    'tab-admin'
  ]{% endif %};

  let currentTabIndex = 0;

  function switchTab(index) {
    if (index < 0 || index >= tabs.length) return;

    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));

    const tabId = tabs[index];
    const tabElement = document.getElementById(tabId);
    const btnElement = document.querySelector(`[data-tab="${tabId}"]`);

    if (!tabElement || !btnElement) {
      console.error('‚ùå No se encontr√≥ la pesta√±a o el bot√≥n', { index, tabId, tabElement, btnElement });
      return;
    }

    tabElement.classList.add('active');
    btnElement.classList.add('active');

    currentTabIndex = index;

    const progress = ((index + 1) / tabs.length) * 100;
    const progressBar = document.getElementById('progress-bar');
    const currentStepSpan = document.getElementById('current-step');
    if (progressBar) progressBar.style.width = progress + '%';
    if (currentStepSpan) currentStepSpan.textContent = String(index + 1);

    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function nextTab() { switchTab(currentTabIndex + 1); }
  function prevTab() { switchTab(currentTabIndex - 1); }

  // Exponer para otros scripts (required-fields-tracker)
  function switchTabById(tabId) {
    const idx = tabs.indexOf(tabId);
    if (idx === -1) return;
    switchTab(idx);
  }
  window.switchTab = switchTab;
  window.switchTabById = switchTabById;
  window.nextTab = nextTab;
  window.prevTab = prevTab;

  // ==================== BORRADORES ====================
  const BORRADOR_A_RECUPERAR = "{{ borrador_id_recuperar|default:'null' }}";
  window.borradorId = BORRADOR_A_RECUPERAR !== "null" ? parseInt(BORRADOR_A_RECUPERAR, 10) : null;
</script>

<script src="{% static 'catalogacion/js/autocomplete-core.js' %}"></script>
<script src="{% static 'catalogacion/js/compositor-autocomplete.js' %}"></script>
<script src="{% static 'catalogacion/js/titulos-formas-autocomplete.js' %}"></script>
<script src="{% static 'catalogacion/js/borrador-system.js' %}"></script>
<script src="{% static 'catalogacion/js/incipitManager.js' %}"></script>
<script src="{% static 'catalogacion/js/incipit-031-adapter.js' %}"></script>
<script src="{% static 'catalogacion/js/autoridades-titulos-autocomplete.js' %}"></script>
<script src="{% static 'catalogacion/js/enlaces-formsets.js' %}"></script>
<script src="{% static 'catalogacion/js/field_help.js' %}"></script>
<script src="{% static 'catalogacion/js/formset-manager.js' %}"></script>
<script src="{% static 'catalogacion/js/form-validator.js' %}"></script>
<!-- <script src="{% static 'catalogacion/js/subcampo-validators.js' %}"></script> -->

{# Incluir modal de ayuda global para campos MARC21 #}
{% include 'catalogacion/includes/help_modal.html' %}

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // ====== Tabs: arrancar SIEMPRE bien
    switchTab(0);

    // ====== Select2 (una sola vez)
    if (typeof $ !== 'undefined' && typeof $.fn.select2 !== 'undefined') {
      $('.select2')
        .not('.no-select2')
        .not('[data-no-select2="1"]')
        .select2({
          theme: 'bootstrap-5',
          width: '100%',
          placeholder: function () { return $(this).data('placeholder'); },
          allowClear: true
        });

      // Asegurar destrucci√≥n en selects nativos
      $('select.no-select2, select[data-no-select2="1"]').each(function () {
        try { if ($(this).data('select2')) $(this).select2('destroy'); } catch (e) {}
        $(this)
          .removeClass('select2-hidden-accessible select2')
          .removeAttr('data-select2-id tabindex aria-hidden');
        const next = this.nextElementSibling;
        if (next && next.classList && next.classList.contains('select2')) next.remove();
      });
    }

    // ====== Confirmaciones modales (botones)
    const btnSoloRegistro = document.getElementById('btnConfirmarSoloRegistro');
    if (btnSoloRegistro) {
      btnSoloRegistro.addEventListener('click', function () {
        const modalEl = document.getElementById('modalConfirmarRegistro');
        const modal = bootstrap.Modal.getInstance(modalEl);
        if (modal) modal.hide();
        enviarFormulario('registrar');
      });
    }

    const btnPublicar = document.getElementById('btnConfirmarRegistro');
    if (btnPublicar) {
      btnPublicar.addEventListener('click', function () {
        const modalEl = document.getElementById('modalConfirmarPublicacion');
        const modal = bootstrap.Modal.getInstance(modalEl);
        if (modal) modal.hide();
        enviarFormulario('publicar');
      });
    }

    const btnDespublicar = document.getElementById('btnConfirmarDespublicar');
    if (btnDespublicar) {
      btnDespublicar.addEventListener('click', function () {
        const modalEl = document.getElementById('modalConfirmarDespublicacion');
        const modal = bootstrap.Modal.getInstance(modalEl);
        if (modal) modal.hide();
        enviarFormulario('despublicar');
      });
    }

    // Sidebar actions
    const btnSidebarRegistrar = document.getElementById('btn-registrar-obra');
    if (btnSidebarRegistrar) btnSidebarRegistrar.addEventListener('click', confirmarRegistro);

    const btnSidebarPublicar = document.getElementById('btn-publicar-obra');
    if (btnSidebarPublicar) btnSidebarPublicar.addEventListener('click', confirmarPublicacion);

    const btnSidebarDespublicar = document.getElementById('btn-despublicar-obra');
    if (btnSidebarDespublicar) btnSidebarDespublicar.addEventListener('click', confirmarDespublicacion);

    // ====== Click en botones de pesta√±as (NO duplicar)
    document.querySelectorAll('.tab-button').forEach(btn => {
      btn.addEventListener('click', function (e) {
        e.preventDefault();
        const tabIndex = parseInt(this.getAttribute('data-tab-index'), 10);
        if (!isNaN(tabIndex)) switchTab(tabIndex);
      });
    });

    // ====== Atajos de teclado (una sola vez)
    document.addEventListener('keydown', function (e) {
      if (e.altKey && e.key === 'ArrowRight') { e.preventDefault(); nextTab(); }
      if (e.altKey && e.key === 'ArrowLeft') { e.preventDefault(); prevTab(); }
    });

    // ====== Validaci√≥n HTML5 submit
    const form = document.getElementById('obra-form');
    if (form) {
      form.addEventListener('submit', function (e) {
        const isValid = form.checkValidity();
        if (!isValid) {
          e.preventDefault();
          e.stopPropagation();

          const invalidFields = form.querySelectorAll(':invalid');
          const firstInvalid = invalidFields[0];

          if (firstInvalid) {
            tabs.forEach((tabId, index) => {
              const tabContent = document.getElementById(tabId);
              if (tabContent && tabContent.contains(firstInvalid)) {
                switchTab(index);
                setTimeout(() => {
                  firstInvalid.focus();
                  firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 250);
              }
            });
          }

          alert('Por favor complete todos los campos obligatorios antes de enviar.');
          form.classList.add('was-validated');
          return false;
        }

        form.classList.add('was-validated');
        return true;
      }, { capture: true });
    }

    // ====== Autosave indicator (expuesto)
    const autosaveIndicator = document.getElementById('autosave-indicator');
    const autosaveStatus = document.getElementById('autosave-status');

    window.updateAutosaveIndicator = function (status, message) {
      if (!autosaveIndicator || !autosaveStatus) return;

      autosaveIndicator.classList.remove('saving', 'saved', 'error');

      if (status === 'saving') {
        autosaveIndicator.classList.add('saving');
        autosaveIndicator.querySelector('i').className = 'bi bi-arrow-repeat spin';
        autosaveStatus.textContent = message || 'Guardando...';
      } else if (status === 'saved') {
        autosaveIndicator.classList.add('saved');
        autosaveIndicator.querySelector('i').className = 'bi bi-cloud-check-fill';
        autosaveStatus.textContent = message || 'Guardado';

        setTimeout(() => {
          autosaveIndicator.classList.remove('saved');
          autosaveIndicator.querySelector('i').className = 'bi bi-cloud-check';
          autosaveStatus.textContent = 'Guardado autom√°tico activo';
        }, 3000);
      } else if (status === 'error') {
        autosaveIndicator.classList.add('error');
        autosaveIndicator.querySelector('i').className = 'bi bi-exclamation-triangle';
        autosaveStatus.textContent = message || 'Error al guardar';
      }
    };
  });
</script>

<script>
  // ================= MODAL BUSCAR OBRA ($w 773/774/787) =================
  (function () {
    let targetTextInput = null;
    let targetHiddenInput = null;
    let targetContainer = null;

    const modalEl = document.getElementById("modalBuscarObra");
    const phase1 = document.getElementById("buscarObraPhase1");
    const phase2 = document.getElementById("buscarObraPhase2");
    const inputBuscar = document.getElementById("buscarObraInput");
    const resultados = document.getElementById("buscarObraResultados");
    const obras774Lista = document.getElementById("obras774Lista");
    const coleccionInfo = document.getElementById("coleccionSeleccionadaInfo");
    const btnVolver = document.getElementById("btnVolverBusqueda");
    const modalTitle = document.getElementById("modalBuscarObraTitle");

    if (!modalEl || !inputBuscar || !resultados) return;

    function showPhase1() {
      phase1.classList.remove("d-none");
      phase2.classList.add("d-none");
      modalTitle.innerHTML = '<i class="bi bi-search"></i> Buscar obra registrada';
      inputBuscar.value = "";
      resultados.innerHTML = "";
    }

    function showPhase2(coleccion, obras774) {
      phase1.classList.add("d-none");
      phase2.classList.remove("d-none");
      modalTitle.innerHTML = '<i class="bi bi-collection"></i> Seleccionar obra de la colecci√≥n';
      coleccionInfo.textContent = `${coleccion.num_control} ‚Äî ${coleccion.titulo || 'Sin t√≠tulo'}`;

      obras774Lista.innerHTML = "";
      obras774.forEach(obra => {
        const li = document.createElement("li");
        li.className = "list-group-item list-group-item-action";
        li.innerHTML = `
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <strong>${obra.titulo_texto || 'Sin t√≠tulo'}</strong>
              ${obra.compositor_texto ? `<br><small class="text-muted">${obra.compositor_texto}</small>` : ''}
            </div>
            <i class="bi bi-chevron-right text-muted"></i>
          </div>
        `;
        li.addEventListener("click", () => selectObra774(coleccion, obra));
        obras774Lista.appendChild(li);
      });
    }

    async function load774Entries(obraId) {
      try {
        const response = await fetch(`/catalogacion/api/obras/774-entries/?obra_id=${obraId}`);
        return await response.json();
      } catch (e) {
        return { success: false, error: 'Error de conexi√≥n' };
      }
    }

    async function selectObra774(coleccion, obra774) {
      if (targetTextInput) targetTextInput.value = coleccion.num_control;
      if (targetHiddenInput) targetHiddenInput.value = coleccion.id;

      // 100/245 desde obra 774
      const compositorTexto = document.getElementById("id_compositor_texto");
      const compositorId = document.getElementById("id_compositor");
      if (compositorTexto && obra774.compositor_texto) compositorTexto.value = obra774.compositor_texto;
      if (compositorId && obra774.compositor_id) compositorId.value = obra774.compositor_id;

      const tituloPrincipal = document.getElementById("id_titulo_principal");
      if (tituloPrincipal && obra774.titulo_texto) tituloPrincipal.value = obra774.titulo_texto;

      bootstrap.Modal.getInstance(modalEl).hide();
    }

    function selectObraNormal(o) {
      if (targetTextInput) targetTextInput.value = o.num_control;
      if (targetHiddenInput) targetHiddenInput.value = o.id;
      bootstrap.Modal.getInstance(modalEl).hide();
    }

    document.addEventListener("click", function (e) {
      const btn = e.target.closest(".btn-buscar-obra");
      if (!btn) return;

      const group = btn.closest(".input-group");
      if (!group) return;

      targetTextInput = group.querySelector(".numero-w-input");
      targetHiddenInput = group.querySelector(".obra-relacionada-id-input");
      targetContainer = btn.closest('.formset-row') || btn.closest('.card') || group;

      showPhase1();
      new bootstrap.Modal(modalEl).show();
    });

    let searchTimer = null;
    inputBuscar.addEventListener("input", function () {
      const q = this.value.trim();
      if (q.length < 2) { resultados.innerHTML = ""; return; }

      clearTimeout(searchTimer);
      searchTimer = setTimeout(async () => {
        try {
          const response = await fetch(`/catalogacion/api/obras/buscar/?q=${encodeURIComponent(q)}`);
          const data = await response.json();

          resultados.innerHTML = "";
          if (!data.results?.length) {
            resultados.innerHTML = `<li class="list-group-item text-muted">Sin resultados</li>`;
            return;
          }

          data.results.forEach(o => {
            if (o.nivel_bibliografico !== 'c') return; // solo colecciones

            const li = document.createElement("li");
            li.className = "list-group-item list-group-item-action";
            li.innerHTML = `
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <strong>${o.num_control}</strong>
                  ${o.titulo ? `<br><span class="text-dark">${o.titulo}</span>` : ''}
                  ${o.compositor ? `<br><small class="text-muted">${o.compositor}</small>` : ''}
                  ${o.signatura ? `<br><small class="text-muted"><i class="bi bi-geo-alt"></i> ${o.signatura}</small>` : ''}
                </div>
                <i class="bi bi-chevron-right text-muted"></i>
              </div>
            `;

            li.addEventListener("click", async () => {
              const r = await load774Entries(o.id);
              if (r.success && r.obras_774?.length) {
                showPhase2(r.coleccion, r.obras_774);
              } else if (r.success && (!r.obras_774 || r.obras_774.length === 0)) {
                alert('Esta colecci√≥n no tiene obras registradas en el campo 774.');
              } else {
                selectObraNormal(o);
              }
            });

            resultados.appendChild(li);
          });
        } catch (err) {
          console.error('Error en b√∫squeda:', err);
        }
      }, 300);
    });

    if (btnVolver) btnVolver.addEventListener("click", showPhase1);
    modalEl.addEventListener("hidden.bs.modal", showPhase1);
  })();
</script>

{# ‚úÖ IMPORTANTE: cargar tracker DESPU√âS de definir switchTabById #}
<script src="{% static 'catalogacion/js/required-fields-tracker.js' %}"></script>

{% endblock catalogacion_js %}